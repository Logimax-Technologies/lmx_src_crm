var path =  url_params();



var ctrl_page = path.route.split('/');



var categoryDetails  =[];



var karigarOrderDetails=[];



var metalDetails    =[];



var purityDetails   =[];



var stones 			=[];



var stone_types 	=[];



var modalStoneDetail=[];



var uom_details 	= [];



var po_itemdetails 	= [];



var hm_itemdetails 	= [];



var karigar_wastage_details 	= [];



var karigar_stone_details = [];



var karigar_charges_details = [];



var net_banking_details 	= [];



var sales_details 	= [];



var weight_range_details = [];



var img_resource=[];



var total_files=[];



var available_metal_stock=[];



var available_po_metal_stock=[];



var karigar_pending_order_details=[];



var karigar_pending_po_details = [];



var karigar_details = [];



var category_lists = [];



var is_metal_issue = 0;



var returnitemlist = [];



var purchasereturnitemlist = [];



var returntaggeditemlist = [];



var nontagreturnitemlist = [];



var insertedcatdetails = [];



var tax_details = [];



var non_tag_category = [];



var return_item_type = 1;



var activeGRNS = [];



var grncatdetails = [];



var ratefix_po_detail = [];



var approval_ratefix_po_detail = [];



var opening_approval_ratefix_detail = [];



var bank_details=[];



var modalStoneDetail=[];



var modalOthermetal=[];



var product_list=[];



var quality_code=[];



var approval_ratefix_details=[];



var section_details=[];



var pre_img_files=[];



var pre_img_resource=[];



var nontag_list = [];



var cus_order_details = [];

var supplier_sales_details = [];



var available_metal_opening_stock = [];



curRow_stn = '';



const format = (num, decimals) => num.toLocaleString('en-US', {



   minimumFractionDigits: 3,



   maximumFractionDigits: 3,



});



$(document).ready(function() {





    if(ctrl_page[1]=='grnentry')



	{



		   Webcam.set({



			width: 290,



			height: 190,



			image_format: 'jpg',



			jpeg_quality: 90



		});



        Webcam.attach( '#my_camera' );



		Webcam.on('error', function(err) {



			console.log('Error accessing webcam:', err);



		});







                $(document).on('keydown', function(e) {

                    if (e.ctrlKey && e.which === 73) {

                        take_snapshot('pre_images');

                    }

                });







	}





     $(document).on('keypress',"input[type='number']",function (event){



         if ((event.which != 46 || $(this).val().indexOf('.') != -1) &&



    	  ((event.which < 48 || event.which > 57) &&



    		(event.which != 0 && event.which != 8))) {



    	  event.preventDefault();



    	}



     });







     $(document).on('keydown',"input[type='number']",function (event){



         if(event.which == 40 || event.which == 38 || event.which == 37 || event.which == 39 )



         {



             event.preventDefault();



         }



     });







    $('#sbe-dt-btn').daterangepicker(



    {



	    ranges: {



	        'Today': [moment(), moment()],



	        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



	        'Last 7 Days': [moment().subtract(6, 'days'), moment()],



	        'Last 30 Days': [moment().subtract(29, 'days'), moment()],



	        'This Month': [moment().startOf('month'), moment().endOf('month')],



	        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



	      },



	      startDate: moment().subtract(29, 'days'),



	      endDate: moment()



	    },



		function (start, end) {



			$('#sbe_date1').text(start.format('YYYY-MM-DD'));



			$('#sbe_date2').text(end.format('YYYY-MM-DD'));



		    get_purchase_entry(start.format('YYYY-MM-DD'),end.format('YYYY-MM-DD'));



		}



	);







	$('#grn-dt-btn').daterangepicker(



    {



	    ranges: {



	        'Today': [moment(), moment()],



	        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



	        'Last 7 Days': [moment().subtract(6, 'days'), moment()],



	        'Last 30 Days': [moment().subtract(29, 'days'), moment()],



	        'This Month': [moment().startOf('month'), moment().endOf('month')],



	        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



	      },



	      startDate: moment().subtract(29, 'days'),



	      endDate: moment()



	    },



		function (start, end) {



			$('#grn_date1').text(start.format('YYYY-MM-DD'));



			$('#grn_date2').text(end.format('YYYY-MM-DD'));



		    get_grn_entry_list(start.format('YYYY-MM-DD'),end.format('YYYY-MM-DD'));



		}



	);











    $('#sp-dt-btn').daterangepicker(



    {



	    ranges: {



	        'Today': [moment(), moment()],



	        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



	        'Last 7 Days': [moment().subtract(6, 'days'), moment()],



	        'Last 30 Days': [moment().subtract(29, 'days'), moment()],



	        'This Month': [moment().startOf('month'), moment().endOf('month')],



	        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



	      },



	      startDate: moment().subtract(29, 'days'),



	      endDate: moment()



	    },



		function (start, end) {



			$('#sp_date1').text(start.format('YYYY-MM-DD'));



			$('#sp_date2').text(end.format('YYYY-MM-DD'));



		    get_purchase_order_payment_list(start.format('YYYY-MM-DD'),end.format('YYYY-MM-DD'));



		}



	);







	 var path =  url_params();



	 switch(ctrl_page[1])



	 {



        case'metal_issue_receipt':



        switch(ctrl_page[2])



        {

           case 'list':



           //set_credit_debit_table();



           break;



         case 'add':



         getMetalIssueRefNo();



         $('#receipt_date').datepicker({ dateFormat: 'dd-mm-yyyy'});



         get_stones();



         get_stone_types();



         get_ActiveUOM();



         getActive_quality_code();



         $(document).on('click', '.create_stone_item_details', function (e) {



            if(validateStoneCusItemDetailRow()){



                   create_new_stone_row();



               }else{



                   alert("Please fill required stone fields");



               }



        });



         break;



        }



         break;





        case'credit_debit_entry':



        switch(ctrl_page[2])



        {

           case 'list':



           set_credit_debit_table();



           break;



         case 'add':



         get_ActiveKaigar();



         break;



         case 'edit':



         get_ActiveKaigar();



         credit_edit_data();



         break;



        }



         break;

	     case 'purchase':



	         switch(ctrl_page[2])



        	 {



        	     case 'add':



        	         get_ActiveKaigar();



        	         get_ActiveCategory();



        	         get_CategoryProducts();







                    get_stones();



                    get_stone_types();



                    get_ActiveUOM();







        	          $("#select_product").select2({



                            placeholder: "Select Product",



                            allowClear: true



                        });



                        $("#select_design").select2({



                            placeholder: "Select Design",



                            allowClear: true



                        });



                        $("#select_sub_design").select2({



                            placeholder: "Select Sub Design",



                            allowClear: true



                        });







                        $("#select_weight_range").select2({



                            placeholder: "Select Weight Range",



                            allowClear: true



                        });



                        $("#select_size").select2({



                            placeholder: "Select Size",



                            allowClear: true



                        });















                        $('.smith_due_dt').datepicker({ dateFormat: 'yyyy-mm-dd'});







        	     break;



        	     case 'purchase_add':



        	         get_ActiveGRNS();



        	         get_ActiveKaigar();



        	         get_ActiveMetals();



        	         get_ActivePurity();



        	         get_ActiveCategories();



        	         get_stones();



        	         get_stone_types();



        	         get_ActiveUOM();



        	         get_taxgroup_items();



        	         get_charges();



        	         get_active_products();



        	         getActive_quality_code();







        	         	$('#despatch_through').select2({



                    	    placeholder: "Dispatch Through",



                    	    allowClear: true



                    	});



                    	$("#select_metal").select2({



                            placeholder: "Select Purity",



                            allowClear: true



                        });



                        $("#select_category").select2({



                            placeholder: "Select Purity",



                            allowClear: true



                        });



                        $("#select_product").select2({



                            placeholder: "Select Product",



                            allowClear: true



                        });



                        $("#select_design").select2({



                            placeholder: "Select Design",



                            allowClear: true



                        });



                        $("#select_sub_design").select2({



                            placeholder: "Select Sub Design",



                            allowClear: true



                        });



                        $("#select_purity").select2({



                            placeholder: "Select Purity",



                            allowClear: true



                        });







                        $("#select_po_no").select2({



                    	 	placeholder: "Select PO No",



                    	 	allowClear: true



                     	});













                         $(document).keyup(function(e) {



                             if(e.keyCode == 9) {    // TAB KEY



                                if($('#other_metal_charges').is(':focus')){



                                    open_other_metal_modal();



                                }



                                else  if($('#tot_lwt').is(':focus'))

                                {

                                    var stone_type = $('#select_product option:selected').attr('data-stone_type');



                                    if(stone_type==0)

                                    {

                                        openStoneModal();

                                    }





                                }



                            }



                        });







                        $('.add_stone_details').on('click',function(){

                            var stone_type = $('#select_product option:selected').attr('data-stone_type');

                            if(stone_type==0)

                            {

                                openStoneModal();

                            }



                        });







                        $(document).on('click', '.create_stone_item_details', function (e) {



                             if(validateStoneCusItemDetailRow()){



                        			create_new_stone_row();



                        		}else{



                        			alert("Please fill required stone fields");



                        		}



                         });







                         calculate_purchase_order_item_total();







                         $('#tab_items').on('click',function(){



                             if($('#select_grn').val()=='' || $('#select_grn').val()==null)



                             {



                                 $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select GRN No."});



                             }



                         });







        	     break;



        	     case 'pur_order':



        	                var date = new Date();



                            var firstDay  = new Date(date.getFullYear(), date.getMonth(),date.getDate() - 29, 1);



                            var from_date=(firstDay.getDate()+"-"+(firstDay.getMonth() + 1)+"-"+firstDay.getFullYear());



                            var to_date=(date.getDate()+"-"+(date.getMonth() + 1)+"-"+date.getFullYear());



                            $('#rpt_from_date').html(from_date);



                            $('#rpt_to_date').html(to_date);



                            $('#rpt_date_picker').html(from_date + ' - ' + to_date);



                            get_pur_order_Details();



                            $('#rpt_date_picker').daterangepicker(



                            {



                            ranges: {



                            'Today': [moment(), moment()],



                            'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                            'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                            'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                            'This Month': [moment().startOf('month'), moment().endOf('month')],



                            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                            },



                            startDate: moment().subtract(29, 'days'),



                            endDate: moment()



                            },



                            function (start, end) {



                            $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



                            $('#rpt_date_picker').html(start.format('D/M/YYYY') + ' - ' + end.format('D/M/YYYY'));



                            $('#rpt_from_date').text(start.format('DD-MM-YYYY'));



                            $('#rpt_to_date').text(end.format('DD-MM-YYYY'));



                            }



                            );



        	         get_purchase_order_list();



                     $("#select_order").select2(



                		{



                			placeholder:"Select Order",



                			closeOnSelect: true



                		});



        	     break;



        	     case 'order_status':



        	            get_ActiveCategories();



        	           $("#select_pur_ord_no").select2(



                		{



                			placeholder:"Select PO NO",



                			closeOnSelect: true



                		});







                		$("#report_type").select2(



                		{



                			placeholder:"Select Type",



                			closeOnSelect: true



                		});







                		$("#select_category").select2({



                            placeholder: "Select Category",



                            allowClear: true



                        });







                        $("#select_product").select2({



                            placeholder: "Select Product",



                            allowClear: true



                        });







                        $("#select_design").select2({



                            placeholder: "Select Design",



                            allowClear: true



                        });



                        $("#select_sub_design").select2({



                            placeholder: "Select Sub Design",



                            allowClear: true



                        });







                        $("#select_order_for").select2(



                        {



                            placeholder:"Select Order For",



                            closeOnSelect: true



                        });











        	            if(ctrl_page[2]=='order_status')



        	            {



        	                get_ActiveKaigar();







        	                var date = new Date();



                            var firstDay  = new Date(date.getFullYear(), date.getMonth(),date.getDate() - 29, 1);



                            var from_date=(firstDay.getDate()+"-"+(firstDay.getMonth() + 1)+"-"+firstDay.getFullYear());



                            var to_date=(date.getDate()+"-"+(date.getMonth() + 1)+"-"+date.getFullYear());



                            $('#rpt_from_date').html(from_date);



                            $('#rpt_to_date').html(to_date);



                            $('#rpt_date_picker').html(from_date + ' - ' + to_date);



                            get_pur_order_Details();



                            $('#rpt_date_picker').daterangepicker(



                            {



                            ranges: {



                            'Today': [moment(), moment()],



                            'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                            'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                            'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                            'This Month': [moment().startOf('month'), moment().endOf('month')],



                            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                            },



                            startDate: moment().subtract(29, 'days'),



                            endDate: moment()



                            },



                            function (start, end) {



                            $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



                            $('#rpt_date_picker').html(start.format('D/M/YYYY') + ' - ' + end.format('D/M/YYYY'));



                            $('#rpt_from_date').text(start.format('DD-MM-YYYY'));



                            $('#rpt_to_date').text(end.format('DD-MM-YYYY'));



                            }



                            );







        	            }



        	     break;







        	     case 'order_delivery':



        	         get_ActiveKaigar();



        	         get_CategoryProducts();



        	     break;







        	     case 'list':



        	         var date = new Date();



                        var firstDay  = new Date(date.getFullYear(), date.getMonth(),date.getDate() - 6, 1);



                        var from_date =  firstDay.getFullYear()+'-'+(firstDay.getMonth()+1)+'-'+firstDay.getDate();



                        var to_date=(date.getDate()+"-"+(date.getMonth() + 1)+"-"+date.getFullYear());



                        $('#sbe_date1').empty();



                        $('#sbe_date2').empty();



			 			get_purchase_entry(from_date,to_date);







        	     break;







        	     case 'qc_status':



        	         get_qc_status_details();



        	     break;



        	 }



	     break;



	    //  case 'credit_debit_entry':

        //     set_credit_debit_table();

        //     get_ActiveKaigar();

        //  break;







	     case 'grnentry':



	         switch(ctrl_page[2])



	         {



	             case 'add':



	                 get_cat_details();



        	         get_ActiveKaigar();



        	         get_stones();



        	         get_stone_types();



        	         get_ActiveUOM();



        	         get_charges();



        	         get_taxgroup_items();



        	         get_ActiveMetals();



        	         get_ActivePurity();



        	         get_ActiveCategories();



        	         get_country();



                     getActive_quality_code();



        	         var date = new Date();



                     var today = new Date(date.getFullYear(), date.getMonth(), date.getDate());



                     $('.referencedate').datepicker({ format: 'dd-mm-yyyy',endDate:today });



        	     break;



        	     case 'edit':







	                 get_cat_details();



        	         get_ActiveKaigar();



        	         get_stones();



        	         get_stone_types();



        	         get_ActiveUOM();



        	         get_charges();



        	         get_taxgroup_items();



        	         get_ActiveMetals();



        	         get_ActivePurity();



        	         get_ActiveCategories();



                     getActive_quality_code();



                     get_pur_edit_img();



        	         setTimeout(function(){calculate_grnItem_details()},1000);



        	     break;



        	     case 'list':



        	         var date = new Date();



                        var firstDay  = new Date(date.getFullYear(), date.getMonth(),date.getDate() - 6, 1);



                        var from_date =  firstDay.getFullYear()+'-'+(firstDay.getMonth()+1)+'-'+firstDay.getDate();



                        var to_date=(date.getDate()+"-"+(date.getMonth() + 1)+"-"+date.getFullYear());



                        $('#grn_date1').empty();



                        $('#grn_date2').empty();



			 			get_grn_entry_list(from_date,to_date);



	             break;



	         }



	     break;







	     case 'rate_fixing':



	         switch(ctrl_page[2])



	         {



	             case 'add':







        	         get_ActiveKaigar();



        	        $("#select_po_ref_no").select2(



            		{



            			placeholder:"Select PO NO",



            			closeOnSelect: true



            		});



                    $('#pur_fin_year_select').select2({});



        	     break;







        	     case 'approval_rate_fixing_add':



        	        get_ActiveKaigar();



        	        $("#select_po_ref_no").select2(



            		{



            			placeholder:"Select PO NO",



            			closeOnSelect: true



            		});



        	     break;







                 case 'edit':







        	         get_ActiveKaigar();



        	        $("#select_po_ref_no").select2(



            		{



            			placeholder:"Select PO NO",



            			closeOnSelect: true



            		});



        	     break;



        	     case 'list':



        	                var date = new Date();



                            var firstDay  = new Date(date.getFullYear(), date.getMonth(),date.getDate() - 6, 1);



                            var from_date =  firstDay.getFullYear()+'-'+(firstDay.getMonth()+1)+'-'+firstDay.getDate();



                            var to_date=(date.getDate()+"-"+(date.getMonth() + 1)+"-"+date.getFullYear());



                            $('#rf_date1').html(from_date);



                            $('#rf_date2').html(to_date);



                            get_rate_fix_entry_list();



                            $('#rf-dt-btn').daterangepicker(



                            {



                        	    ranges: {



                        	        'Today': [moment(), moment()],



                        	        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                        	        'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                        	        'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                        	        'This Month': [moment().startOf('month'), moment().endOf('month')],



                        	        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                        	      },



                        	      startDate: moment().subtract(6, 'days'),



                        	      endDate: moment()



                        	    },



                        		function (start, end) {



                        			$('#rf_date1').text(start.format('YYYY-MM-DD'));



                        			$('#rf_date2').text(end.format('YYYY-MM-DD'));



                        		    get_rate_fix_entry_list(start.format('YYYY-MM-DD'),end.format('YYYY-MM-DD'));



                        		}



                        	);











	             break;







	             case 'approval_rate_fixing':



        	                var date = new Date();



                            var firstDay  = new Date(date.getFullYear(), date.getMonth(),date.getDate() - 6, 1);



                            var from_date =  firstDay.getFullYear()+'-'+(firstDay.getMonth()+1)+'-'+firstDay.getDate();



                            var to_date=(date.getDate()+"-"+(date.getMonth() + 1)+"-"+date.getFullYear());



                            $('#rf_date1').html(from_date);



                            $('#rf_date2').html(to_date);



                            get_approval_rate_fix_entry_list();



                            $('#rf-dt-btn').daterangepicker(



                            {



                        	    ranges: {



                        	        'Today': [moment(), moment()],



                        	        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                        	        'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                        	        'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                        	        'This Month': [moment().startOf('month'), moment().endOf('month')],



                        	        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                        	      },



                        	      startDate: moment().subtract(6, 'days'),



                        	      endDate: moment()



                        	    },



                        		function (start, end) {



                        			$('#rf_date1').text(start.format('YYYY-MM-DD'));



                        			$('#rf_date2').text(end.format('YYYY-MM-DD'));



                        		    get_approval_rate_fix_entry_list(start.format('YYYY-MM-DD'),end.format('YYYY-MM-DD'));



                        		}



                        	);



	             break;







	         }



	     break;







	     case 'approvalstock':



	         switch(ctrl_page[2])



	         {



	             case 'list':



        	         get_approval_purchase_entry();



        	     break;



	         }



	     break;







	     case 'approvalstock_tag':



	         switch(ctrl_page[2])



	         {



	             case 'list':



        	            $('#order_status').select2({



                    	 	placeholder: "Select Order Status",



                    	 	allowClear: true



                     	});







                     	get_order_status();



				 		//get_approval_stock_tag_list();



        	     break;



	         }



	     break;







	     case 'qc_issue_receipt':



	         switch(ctrl_page[2])



        	 {



        	     case 'add':



        	         get_qc_issue_purchase_orders();



        	         get_ActiveEmployee();



        	         get_stones();



        	         get_stone_types();



        	         get_ActiveUOM();



                     getActive_quality_code();



                     $('#pur_fin_year_select').select2({});



        	     break;



                 case 'qc_issue_edit':



                    get_qc_issue_purchase_orders();



                    get_ActiveEmployee();



                    setTimeout(function()



                    {



                        get_qcissuedDetails()



                    },1000);







                    get_stones();



                    get_stone_types();



                    get_ActiveUOM();



                    getActive_quality_code();



                 break;











                 case 'qc_receipt_edit':



                    get_qc_receipt_purchase_orders();



                    setTimeout(function()



                    {



                        get_qcReceiptDetails()



                    },1000);



                    get_ActiveUOM();



                 break;



        	     case 'list':



        	        var date = new Date();



                    var firstDay  = new Date(date.getFullYear(), date.getMonth(),date.getDate() - 6, 1);



                    var from_date=(firstDay.getDate()+"-"+(firstDay.getMonth() + 1)+"-"+firstDay.getFullYear());



                    var to_date=(date.getDate()+"-"+(date.getMonth() + 1)+"-"+date.getFullYear());



                    $('#rpt_from_date').html(from_date);



                    $('#rpt_to_date').html(to_date);



                    $('#rpt_date_picker').html(from_date + ' - ' + to_date);



                    get_qc_issue_details();



                    qc_cancel_reason();



                    $("#deleteReasonSelect").select2({



                        placeholder: "Select Reason",



                        allowClear: true



                    });



                    $('#rpt_date_picker').daterangepicker(



                    {



                    ranges: {



                    'Today': [moment(), moment()],



                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                    'This Month': [moment().startOf('month'), moment().endOf('month')],



                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                    },



                    startDate: moment().subtract(6, 'days'),



                    endDate: moment()



                    },



                    function (start, end) {



                    $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



                    $('#rpt_date_picker').html(start.format('D/M/YYYY') + ' - ' + end.format('D/M/YYYY'));



                    $('#rpt_from_date').text(start.format('DD-MM-YYYY'));



                    $('#rpt_to_date').text(end.format('DD-MM-YYYY'));



                    }



                    );







        	     break;



        	     case 'qc_entry':



        	         get_ActiveUOM();



        	         get_qc_receipt_purchase_orders();



        	     break;



        	 }



	     break;







	     case 'lot_generate':



	         switch(ctrl_page[2])



        	 {







        	     case 'add':



        	         get_qc_receipt_po();



        	         get_ActiveEmployee();







        	         get_Activesections();



        	         get_stones();



                     get_stone_types();



                     get_ActiveUOM();



                     $('#pur_fin_year_select').select2({});



        	     break;







        	     case 'list':



        	        var date = new Date();



                    var firstDay  = new Date(date.getFullYear(), date.getMonth(),date.getDate() - 6, 1);



                    var from_date=(firstDay.getDate()+"-"+(firstDay.getMonth() + 1)+"-"+firstDay.getFullYear());



                    var to_date=(date.getDate()+"-"+(date.getMonth() + 1)+"-"+date.getFullYear());



                    $('#rpt_from_date').html(from_date);



                    $('#rpt_to_date').html(to_date);



                    $('#rpt_date_picker').html(from_date + ' - ' + to_date);



                    get_qc_issue_details();



                    $('#rpt_date_picker').daterangepicker(



                    {



                    ranges: {



                    'Today': [moment(), moment()],



                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                    'This Month': [moment().startOf('month'), moment().endOf('month')],



                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                    },



                    startDate: moment().subtract(6, 'days'),



                    endDate: moment()



                    },



                    function (start, end) {



                    $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



                    $('#rpt_date_picker').html(start.format('D/M/YYYY') + ' - ' + end.format('D/M/YYYY'));



                    $('#rpt_from_date').text(start.format('DD-MM-YYYY'));



                    $('#rpt_to_date').text(end.format('DD-MM-YYYY'));



                    }



                    );







        	     break;



        	     case 'qc_entry':



        	         get_qc_receipt_purchase_orders();



        	     break;



        	 }



	     break;



         case 'nontag_lot_generate':



            switch(ctrl_page[2])



            {



                case 'add':



                    get_NontagLotItemDetails();



                    get_ActiveKaigar();



                break;



            }



         break;



         case 'nontag_receipt':



            switch(ctrl_page[2])



            {



                case 'list':



                    var date = new Date();



                    var firstDay = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 29, 1);



                    var from_date = (firstDay.getDate() + "-" + (firstDay.getMonth() + 1) + "-" + firstDay.getFullYear());



                    var to_date = (date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear());







                    $('#rpt_payments1').html(from_date);



                    $('#rpt_payments2').html(to_date);



                    get_nontag_receiptedList();



                    $('#rpt_payment_date').daterangepicker(



                        {



                            ranges: {



                                'Today': [moment(), moment()],



                                'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                                'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                                'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                                'This Month': [moment().startOf('month'), moment().endOf('month')],



                                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                            },



                            startDate: moment().subtract(29, 'days'),



                            endDate: moment()



                        },



                        function (start, end) {



                            $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



                            $('#rpt_payments1').text(start.format('YYYY-MM-DD'));



                            $('#rpt_payments2').text(end.format('YYYY-MM-DD'));



                        }



                    );



                break;



                case 'add':



                    get_NontagLots();



                    $('#select_lot').select2({



                        placeholder: "Select lot No",



                        allowClear: true



                    });



                    $('#product_sel').select2({



                        placeholder: "Select Product",



                        allowClear: true



                    });



                    $('#design_sel').select2({



                        placeholder: "Select Design",



                        allowClear: true



                    });



                    $('#sub_design_sel').select2({



                        placeholder: "Select Sub Design",



                        allowClear: true



                    });



                    $('#select_branch').select2({



                        placeholder: "Select branch",



                        allowClear: true



                    });



                    $('#select_section').select2({



                        placeholder: "Select Section",



                        allowClear: true



                    });



                break;



            }



        break;



	     case 'halmarking_issue_receipt':



	         switch(ctrl_page[2])



        	 {



        	     case 'add':



        	         get_pending_halmarking_items();



        	         get_ActiveKaigar();



                     get_stones();



                     get_stone_types();



                     get_ActiveUOM();



        	     break;



        	     case 'list':



        	         get_halmarking_issue_details();



        	     break;



        	     case 'hm_receipt':



        	          get_halmarking_issue_orders();



                      get_stones();



                      get_stone_types();

 

                      get_ActiveUOM();



        	     break;



        	 }



	     break;



	     case 'purchase_payment':







	         $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {



              var target = $(e.target).attr("href") // activated tab



              if(target == '#tot_summary'){



                  $(".received_amount").focus();



              }



            });







	         switch(ctrl_page[2])



        	 {







        	     case 'list':



        	         get_purchase_order_payment_list();



        	     break;



        	     case 'add':



        	          get_ActiveKaigar();



        	     break;



        	 }



	     break;



	     case 'supplier_po_payment':







	         $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {



              var target = $(e.target).attr("href") // activated tab



              if(target == '#tot_summary'){



                  $(".received_amount").focus();



              }



            });







	         switch(ctrl_page[2])



        	 {







        	     case 'list':



        	          var date = new Date();



                        var firstDay  = new Date(date.getFullYear(), date.getMonth(),date.getDate() - 6, 1);



                        var from_date =  firstDay.getFullYear()+'-'+(firstDay.getMonth()+1)+'-'+firstDay.getDate();



                        var to_date=(date.getDate()+"-"+(date.getMonth() + 1)+"-"+date.getFullYear());



                        $('#rf_date1').empty();



                        $('#rf_date2').empty();



			 			get_purchase_order_payment_list(from_date,to_date);



        	     break;



        	     case 'add':



        	          get_ActiveKaigar();



        	          get_bank_details();



        	     break;



        	     case 'edit':



                          get_bank_details();



                          setTimeout(function(){get_supplier_popay_edit(ctrl_page[3])},1000);



                 break;



        	 }



	     break;



	     case 'karigarmetalissue':



	         switch(ctrl_page[2])



        	 {







        	     case 'list':



        	         get_karigar_metal_issue_list();



        	     break;



        	     case 'add':



        	          get_ActiveMetals();



        	          get_ActiveKaigar();



        	          get_ActiveCategories();



        	          get_Activesections();



        	          get_available_metal_stock_details();



                      get_ActiveUOM();



                      get_ActivePurity();



                      src_get_branchname();



                      get_stones();



                      get_stone_types();

             

                      get_ActiveUOM();

             

                      getActive_quality_code();





        	          $('#select_product').select2({



                	    placeholder: "Product",



                	    allowClear: true



                	  });



                	   $('#select_design').select2({



                	    placeholder: "Design",



                	    allowClear: true



                	  });



                	   $('#select_sub_design').select2({



                	    placeholder: "Sub Design",



                	    allowClear: true



                	  });



                	  $('#select_purity').select2({



                	    placeholder: "Purity",



                	    allowClear: true



                	  });



                      $('#select_supplier_po_no').select2({



                        placeholder: "Select Supplier PO NO",



                	    allowClear: true



                      });



                      $('#pur_fin_year_select').select2({});



                      get_karigar_SupplierEntrys();



                      setTimeout(function(){Create_New_Karigar_Metal_Issue()},1000);



                      setTimeout(function(){



                        if($('#branch').val()!=''){



                            // $(".branch_change").css("display","block");



                            // $('#metal_issue_type_normal').attr('checked', true);



                            // $('.issue_against_nontag').attr('checked', true);



                            $("#select_branch").trigger("change")



                        }



                      },1000);



        	     break;



        	 }



	     break;



	      case 'purchasereturn':



			switch(ctrl_page[2])



			{



				case 'list':







                    get_ActiveKaigar();



					get_po_ref_nos();



                    var date = new Date();



                    var firstDay = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 0, 1);



                    var from_date = (firstDay.getDate() + "-" + (firstDay.getMonth() + 1) + "-" + firstDay.getFullYear());



                    var to_date = (date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear());







                    $('#rpt_payments1').html(from_date);



                    $('#rpt_payments2').html(to_date);



                    get_returned_po_details();



                    $('#rpt_payment_date').daterangepicker(



                        {



                            ranges: {



                                'Today': [moment(), moment()],



                                'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                                'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                                'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                                'This Month': [moment().startOf('month'), moment().endOf('month')],



                                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                            },



                            startDate: moment().subtract(0, 'days'),



                            endDate: moment()



                        },



                        function (start, end) {



                            $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



                            $('#rpt_payments1').text(start.format('YYYY-MM-DD'));



                            $('#rpt_payments2').text(end.format('YYYY-MM-DD'));



                        }



                    );



				break;



				case 'add':



					get_ActiveKaigar();



					get_ActiveCategories();



					get_ActivePurity();



					get_return_item_po_ref_nos();



					get_stones();



        	        get_stone_types();



        	        get_ActiveUOM();



        	        get_charges();



        	        get_taxgroup_items();



        	        get_non_tag_category();



        	        get_available_metal_stock_details();



        	        get_active_products();



                    getActive_quality_code();



                    get_Activesections();



        	        $(document).on('keypress',"input[type='number']",function (event){



        	             if ((event.which != 46 || $(this).val().indexOf('.') != -1) &&



                    	  ((event.which < 48 || event.which > 57) &&



                    		(event.which != 0 && event.which != 8))) {



                    	  event.preventDefault();



                    	}



        	         });

        	         $('#select_design').select2({



                	    placeholder: "Design",



                	    allowClear: true



                	  });



                	   $('#select_sub_design').select2({



                	    placeholder: "Sub Design",



                	    allowClear: true



                	  });



                      $('#purret_to_karigar').select2({

                        placeholder: "Issue To Karigar",

                        allowClear: true

                      });



                      $('#pur_fin_year_select').select2({});



				break;



			}



		    break;











		    case 'order_description':



	         if($('#order_des').length > 0)



             {



             	CKEDITOR.replace('order_des');



             }



             get_order_description();



	     break;







	     case 'supplier_rate_cut':



            switch (ctrl_page[2]) {



                case 'list':



                    var date = new Date();



                    var firstDay = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 0, 1);



                    var from_date = (firstDay.getDate() + "-" + (firstDay.getMonth() + 1) + "-" + firstDay.getFullYear());



                    var to_date = (date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear());







                    $('#rpt_payments1').html(from_date);



                    $('#rpt_payments2').html(to_date);



                    get_supplier_ratecut_details();



                    $('#rpt_payment_date').daterangepicker(



                        {



                            ranges: {



                                'Today': [moment(), moment()],



                                'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                                'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                                'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                                'This Month': [moment().startOf('month'), moment().endOf('month')],



                                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                            },



                            startDate: moment().subtract(0, 'days'),



                            endDate: moment()



                        },



                        function (start, end) {



                            $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



                            $('#rpt_payments1').text(start.format('YYYY-MM-DD'));



                            $('#rpt_payments2').text(end.format('YYYY-MM-DD'));



                        }



                    );







                    break;



                case 'add':



                    get_returned_po_details();



                    get_ActiveKaigar();



                     get_bank_details();



                    //get_ActiveCategories();



                    get_ActiveCategories();



        	        get_CategoryProducts();



                    get_ActiveMetals();



                    src_get_branchname();



                    $('#select_category').select2({



                        placeholder: "Select Category",



                        allowClear: true



                    });



                    $("#select_po_ref_no").select2(



                    {



                        placeholder:"Select PO NO",



                        closeOnSelect: true



                    });



                    $('#pur_fin_year_select').select2({});



                    break;



            }



            break;



            case 'smith_cmpy_op_bal':



                switch(ctrl_page[2])



			    {



                    case 'list':



                        var date = new Date();



                        var firstDay = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 29, 1);



                        var from_date = (firstDay.getDate() + "-" + (firstDay.getMonth() + 1) + "-" + firstDay.getFullYear());



                        var to_date = (date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear());







                        $('#rpt_payments1').html(from_date);



                        $('#rpt_payments2').html(to_date);



                        get_smith_cmpy_op_bal_details();



                        $('#rpt_payment_date').daterangepicker(



                            {



                                ranges: {



                                    'Today': [moment(), moment()],



                                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                                    'This Month': [moment().startOf('month'), moment().endOf('month')],



                                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                                },



                                startDate: moment().subtract(29, 'days'),



                                endDate: moment()



                            },



                            function (start, end) {



                                $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



                                $('#rpt_payments1').text(start.format('YYYY-MM-DD'));



                                $('#rpt_payments2').text(end.format('YYYY-MM-DD'));



                            }



                        );



                    break;



                    case 'add':



                        get_ActiveMetals();



                        get_ActiveKaigar();



                        get_oldmetalcategory();



                        $('#select_category').select2({



                            placeholder: "Select Category",



                            allowClear: true



                        });



                        $('#select_product').select2({



                            placeholder: "Select Product",



                            allowClear: true



                        });



                        $('#select_purity').select2({



                            placeholder: "Select Purity",



                            allowClear: true



                        });



                    break;



                }



            break;







            case 'retagging_report':

				var date = new Date();

				var firstDay = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 0, 1);

				var from_date = (firstDay.getDate() + "-" + (firstDay.getMonth() + 1) + "-" + firstDay.getFullYear());

				var to_date = (date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear());

				$('#rpt_from_date').html(from_date);

				$('#rpt_to_date').html(to_date);

				$('#rpt_date_picker').daterangepicker(

					{

						ranges: {

							'Today': [moment(), moment()],

							'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],

							'Last 7 Days': [moment().subtract(6, 'days'), moment()],

							'Last 30 Days': [moment().subtract(29, 'days'), moment()],

							'This Month': [moment().startOf('month'), moment().endOf('month')],

							'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]

						},

						startDate: moment().subtract(0, 'days'),

						endDate: moment()

					},

					function (start, end) {

						$('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));

						$('#rpt_date_picker').html(start.format('D/M/YYYY') + ' - ' + end.format('D/M/YYYY'));

						$('#rpt_from_date').text(start.format('DD-MM-YYYY'));

						$('#rpt_to_date').text(end.format('DD-MM-YYYY'));

					}

				);

				get_ActiveMetals();

				get_ActiveCategories();

		    	$('#select_category').select2({

                    placeholder: "Select Category",

                    allowClear: true

                });



                $('#receipt_type').select2({

                    placeholder:"Select Receipt Type",

                    allowClear:true

                });



				break;







	        case 'headoffice_valut_report':



	        get_ActiveKaigar();



            get_ActiveMetals();



            get_po_ref_nos();



            var date = new Date();



            var firstDay = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 0, 1);



            var from_date = (firstDay.getDate() + "-" + (firstDay.getMonth() + 1) + "-" + firstDay.getFullYear());



            var to_date = (date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear());







            $('#rpt_payments1').html(from_date);



            $('#rpt_payments2').html(to_date);



            get_headoffice_valut_report();



            $('#rpt_payment_date').daterangepicker(



                {



                    ranges: {



                        'Today': [moment(), moment()],



                        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                        'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                        'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                        'This Month': [moment().startOf('month'), moment().endOf('month')],



                        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                    },



                    startDate: moment().subtract(0, 'days'),



                    endDate: moment()



                },



                function (start, end) {



                    $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



                    $('#rpt_payments1').text(start.format('YYYY-MM-DD'));



                    $('#rpt_payments2').text(end.format('YYYY-MM-DD'));



                }



            );



            $('#select_category').select2({



                placeholder: "Select Category",



                allowClear: true



            });



            break;



            case 'weight_gain_loss':



                get_ActiveKaigar();







                var date = new Date();



                var firstDay = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 0, 1);



                var from_date = (firstDay.getDate() + "-" + (firstDay.getMonth() + 1) + "-" + firstDay.getFullYear());



                var to_date = (date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear());







                $('#rpt_payments1').html(from_date);



                $('#rpt_payments2').html(to_date);



                get_weight_gain_loss_report();



                $('#rpt_payment_date').daterangepicker(



                    {



                        ranges: {



                            'Today': [moment(), moment()],



                            'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



                            'Last 7 Days': [moment().subtract(6, 'days'), moment()],



                            'Last 30 Days': [moment().subtract(29, 'days'), moment()],



                            'This Month': [moment().startOf('month'), moment().endOf('month')],



                            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



                        },



                        startDate: moment().subtract(0, 'days'),



                        endDate: moment()



                    },



                    function (start, end) {



                        $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



                        $('#rpt_payments1').text(start.format('YYYY-MM-DD'));



                        $('#rpt_payments2').text(end.format('YYYY-MM-DD'));



                    }



                );



                break;







                case 'approval_unfixing_report':



                    get_ActiveKaigar();



        			//get_category();



        			get_unfixing_details();



                break;







                case 'approval_rate_fixed':



        			var date = new Date();



        			var firstDay = new Date(date.getFullYear(), date.getMonth(), date.getDate() - 0, 1);



        			var from_date = (firstDay.getDate() + "-" + (firstDay.getMonth() + 1) + "-" + firstDay.getFullYear());



        			var to_date = (date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear());



        			$('#rpt_from_date').html(from_date);



        			$('#rpt_to_date').html(to_date);



        			$('#rpt_date_picker').daterangepicker(



        				{



        					ranges: {



        						'Today': [moment(), moment()],



        						'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],



        						'Last 7 Days': [moment().subtract(6, 'days'), moment()],



        						'Last 30 Days': [moment().subtract(29, 'days'), moment()],



        						'This Month': [moment().startOf('month'), moment().endOf('month')],



        						'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]



        					},



        					startDate: moment().subtract(0, 'days'),



        					endDate: moment()



        				},



        				function (start, end) {



        					$('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));



        					$('#rpt_date_picker').html(start.format('D/M/YYYY') + ' - ' + end.format('D/M/YYYY'));



        					$('#rpt_from_date').text(start.format('DD-MM-YYYY'));



        					$('#rpt_to_date').text(end.format('DD-MM-YYYY'));



        				}



        			);



        			get_rate_fixed_details();



        			get_ActiveKaigar();



        	    break;















	 }



});



    function report_print(branch_name,report_name,from_date,to_date,optional)



    {



        if(branch_name==''){



        branch_name = "ALL"



        }



        var data = "<span>"+report_name+" - "+branch_name+"</span></br>"



        +"<span>"+(optional!='' ? optional: '' )+"</span>"



        +(from_date!='' && to_date != '' ? "<span>FROM&nbsp;:&nbsp;"+from_date+" &nbsp;&nbsp;TO&nbsp;&nbsp; "+to_date+ "</span></br> " : '')



        + $('.hidden-xs').html()+" &nbsp; - &nbsp;"+ "</span>"+"<span style='font-size:11pt;'>"+getDisplayDateTime()  +"</span></br>";



        return data;



    }



    function date_format(dt_range)



    {



    	var date = dt_range.split('/');



    	return date[2] + '-' + date[1] + '-' + date[0];



    }



    function formatMoney(number) {



      return number.toLocaleString('en-IN', { style: 'currency', currency: 'USD' });



    }



   function getDisplayDateTime()



   {



        var today = new Date();



        var dispdate = today.getDate()+'-'+(today.getMonth()+1)+'-'+today.getFullYear();



        var disptime = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();



        return dispdate + " " + disptime;



    }



    function get_karigar_wise_wastage()



    {



        $.ajax({



    	type: 'POST',



    	url: base_url+'index.php/admin_ret_catalog/get_karigar_wise_wastage',



    	dataType:'json',



    	data:{'id_karigar':$('#select_karigar').val()},



    	success:function(data){



    	        karigar_wastage_details=data;



    		}



    	});



    }



    function get_karigar_wise_stones()



    {



        $.ajax({



            type: 'GET',



            url: base_url+'index.php/admin_ret_catalog/get_karigar_wise_stones',



            dataType:'json',



            success:function(data){



                    karigar_stone_details=data;



                }



            });



    }



    function get_karigar_wise_charges()



    {



        $.ajax({



            type: 'GET',



            url: base_url+'index.php/admin_ret_catalog/get_karigar_wise_charges',



            dataType:'json',



            success:function(data){



                    karigar_charges_details=data;



                }



            });



    }







    $('#select_all').click(function(event) {



    	  $("tbody tr td input[type='checkbox']").prop('checked', $(this).prop('checked'));



          event.stopPropagation();



    });



$(document).on('change', '.return_item_cat_id', function(event) {



    var row     = $(this).parent().closest('tr');



    var catId   = $(row).find('.return_item_cat_id').val();



    var karId   = $(row).find('.return_item_kar_id').val();







    if($(this).prop('checked')){



        $('#item_detail > tbody tr').each(function(bidx, brow){



		    curRow = $(this);



			if(curRow.find('.po_kar_id').val() == karId && curRow.find('.po_cat_id').val() == catId)



			{



				 curRow.find('input[type="checkbox"]').prop('checked', true);



			}



	   });



    }else{



        $('#item_detail > tbody tr').each(function(bidx, brow){



		    curRow = $(this);



			if(curRow.find('.po_kar_id').val() == karId && curRow.find('.po_cat_id').val() == catId)



			{



				curRow.find('input[type="checkbox"]').prop('checked', false);



			}



	   });



    }



    get_purchase_return_total();



    event.stopPropagation();



});



function get_ActiveCategory()



{



    $.ajax({



	type: 'GET',



	url: base_url+'index.php/admin_ret_catalog/category/active_category',



	dataType:'json',



	success:function(data){



	        categoryDetails=data;



		}



	});



}



function get_ActiveKaigar()

{



	$.ajax({



	type: 'GET',



	url: base_url+'index.php/admin_ret_catalog/karigar/active_list',



	dataType:'json',



	success:function(data){



        // karigar_details=[];



        karigar_details = data;



	    var id=$('#select_karigar').val();



	    var id_karigar= $('#id_karigar').val();



        var trans_karigar_id = $('#purret_to_karigar').val();



	    console.log('id:'+id);



        console.log(karigar_details);



        if(ctrl_page[1]=='purchasereturn')

        {

                $('#select_karigar').append(

                    $("<option></option>")

                    .attr("value",0)

                    .text('All')

                );

        }



		$.each(karigar_details, function (key, item) {



		    $("#select_karigar,#karigar_select,#purret_to_karigar").append(



		    $("<option></option>")



		    .attr("value", item.id_karigar)



		    .attr("data-karigartpe", item.karigartpe)



            .attr("data-karigarfor",item.karigar_for)



		    .text(item.karigar+' - '+ item.code)



		    );



		});



		$("#select_karigar,#karigar_select").select2(

		{



			placeholder:"Select Karigar",



			closeOnSelect: true



		});







		if($("#select_karigar").length)



		{



		    $("#select_karigar").select2("val",(id!='' && id>0? id:(id_karigar!='' && id_karigar!=undefined ? id_karigar :'')));



		}



        if($("#karigar_select").length)



        {



            $("#karigar_select").select2("val",(id!='' && id>0? id:(id_karigar!='' && id_karigar!=undefined ? id_karigar :'')));



        }



        if($('#purret_to_karigar').length)

        {

            $("#purret_to_karigar").select2("val",(id!='' && id>0? id:(trans_karigar_id!='' && trans_karigar_id!=undefined ? trans_karigar_id :'')));

        }



		    $(".overlay").css("display", "none");



		}



	});



}



$("input[name='order[order_for]']:radio").on('change',function(){



    $('#item_detail tbody').empty();



    $('.stock_order').css("display","none");



    $('.customer_order').css("display","none");



    $('.stock_and_cus_ord').css("display","block");



    $('.stock_repair').css("display","none");



    $('.tag_code').css("display","none");



    if(this.value==1)



    {



        $('#select_order_no').prop('disabled',true);



        $('.stock_order').css("display","block");



        $('.customer_order').css("display","none");



        $('.purchase_detailed').css("display","none");



        $('.item_detailed').css("display","block");



        $('.customer_order').css("display","none");



        $('#add_order_item').css("display","block");



        $('#order_item_cancel').css("display","block");



        $('.remark').css("display","block");



    }



    else if(this.value==2)



    {



        get_ProductDesign();



        get_customer_order_pending_details();



        $('#select_order_no').prop('disabled',false);



        $('.stock_order').css("display","none");



        $('.customer_order').css("display","block");



        $('.purchase_detailed').css("display","block");



        $('.item_detailed').css("display","none");



        $('.stock_and_cus_ord').css("display","none");



        $('#add_order_item').css("display","none");



        $('#order_item_cancel').css("display","none");



        $('.remark').css("display","none");



        $('#purchase_details tbody').empty();



    }



    else if(this.value==3)



    {



        $('.stock_and_cus_ord').css("display","none");



        $('.stock_repair').css("display","block");



        $('#select_order_no').prop('disabled',false);



        $('.purchase_detailed').css("display","block");



        $('.item_detailed').css("display","none");



        $('#add_order_item').css("display","none");



        $('#order_item_cancel').css("display","none");



        $('.remark').css("display","none");



        $('.tag_code').css("display","block");



        $('#purchase_details tbody').empty();



        get_stock_repair_order_details();



    }



});



function get_customer_order_pending_details()



{



    $("#select_order_no option").remove();



    $(".overlay").css("display", "block");



    $.ajax({



	type: 'GET',



	url: base_url+'index.php/admin_ret_purchase/get_customer_order_pending_details',



	dataType:'json',



	success:function(data){



	    cus_order_details=data;



        console.log(data);



	    var id=$('#select_order_no').val();



		$.each(data, function (key, item) {



		    $("#select_order_no").append(



		    $("<option></option>")



		    .attr("value", item.id_customerorder)



		    .text(item.order_no)



		    );



		});



		$("#select_order_no").select2(



		{



			placeholder:"Select Order No",



			 allowClear: true



		});







		if($("#select_order_no").length)



		{



		    $("#select_order_no").select2("val",(id!='' && id>0?id:''));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



$('#branch_select').on('change',function(){



    if(this.value!='')



    {



        if(ctrl_page[1]=='nontag_receipt')



        {



            $('#id_branch').val(this.value);



            get_Activesections();



        }



        else



        {



            get_stock_repair_order_details();



        }



    }



});



function get_stock_repair_order_details()



{



    $("#select_order_no option").remove();



    $(".overlay").css("display", "block");



    $.ajax({



	type: 'POST',



	url: base_url+'index.php/admin_ret_purchase/get_stock_repair_order_details',



	data:{'id_branch':$('#branch_select').val()},



	dataType:'json',



	success:function(data){



	    cus_order_details=data;



	    var id=$('#select_order_no').val();



		$.each(data, function (key, item) {



		    $("#select_order_no").append(



		    $("<option></option>")



		    .attr("value", item.id_customerorder)



		    .text(item.order_no)



		    );



		});



		$("#select_order_no").select2(



		{



			placeholder:"Select Order No",



			 allowClear: true



		});







		if($("#select_order_no").length)



		{



		    $("#select_order_no").select2("val",(id!='' && id>0?id:''));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



/*$('#select_order_no').on('change',function(){







    var order_for = $("input[name='order[order_for]']:checked").val();



    let id_order=this.value;



    if(this.value!='')



    {



        $('#item_detail tbody').empty();







        $("#select_product option").remove();



        $.each(cus_order_details,function(key,items){



            if(items.id_customerorder==id_order)



            {



                $.each(items.item_details,function(key,val){



                        $('#select_product').append(



                        $("<option></option>")



                        .attr("value", val.id_product)



                        .text(val.product_name)



                        .attr("data-purmode", val.purchase_mode)



                        .attr("data-tax_type", val.tax_type)



                        );



                });







                $("#select_product").select2({



                    placeholder: "Select Product",



                    allowClear: true



                });







                $("#select_product").select2("val","");



            }



        });



    }







    if(ctrl_page[1]=='purchase' && ctrl_page[2]=='add' && this.value!='')



    {



        let order_search=true;



        if(order_for==3)



        {



            if($('#branch_select').val()=='' || $('#branch_select').val()==null)



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Branch"});



                order_search=false;



                 $("#select_order_no").select2("val","");



            }



        }



        if(order_search)



        {



            var trHtml='';



            $.each(cus_order_details,function(key,val){



                if(val.id_customerorder==id_order)



                {



                    $.each(val.order_details,function(k,items){



                            trHtml+='<tr>'



                            +'<td><input type="hidden" name="order_details[id_orderdetails][]" value="'+items.id_orderdetails+'"><input type="hidden" value="" name="order_details[order_images][]" /><input type="hidden" class="id_customer_order"  name="order_details[id_customer_order][]" value="'+$('#select_order_no').val()+'"><input type="hidden" class="id_product"  name="order_details[product][]" value="'+items.id_product+'">'+items.product_name+'</td>'



                            +'<td><input type="hidden" class="design"  name="order_details[design][]" value="'+items.design_no+'">'+items.design_name+'</td>'



                            +'<td><input type="hidden" class="sub_design"  name="order_details[sub_design][]" value="'+items.id_sub_design+'">'+items.sub_design_name+'</td>'



                            +'<td><input type="hidden" class="size"  name="order_details[size][]" value="'+items.id_size+'">'+items.size+'</td>'



                            +'<td><input type="hidden" class="weight_range"  name="order_details[weight_range][]" value="" ></td>'



                            +'<td><input type="hidden" class="approx_wt"  name="order_details[order_wt][]" value="'+items.weight+'" >'+items.weight+'</td>'



                            +'<td><input type="number" class="form-control piece"  name="order_details[piece][]" value="'+items.totalitems+'" readonly></td>'



                            +'<td><input type="hidden" class="description"  name="order_details[description][]" value="" ><input type="hidden" class="due_date"  name="order_details[due_date][]" value="'+$('.smith_due_dt').val()+'" >'+$(".smith_due_dt").val()+'</td>'



                             +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_purchase_order_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



                            +'</tr>';



                    });



                }



            });







            if($('#item_detail > tbody  > tr').length>0)



            {



                $('#item_detail > tbody > tr:first').before(trHtml);



            }else{



                $('#item_detail tbody').append(trHtml);



            }



            calculate_order_item_details();



            reset_purchase_order_form();



        }







    }







});*/



$('#select_order_no').on('change',function(){



    var order_for = $("input[name='order[order_for]']:checked").val();



    let id_order=this.value;



    if(this.value!='')



    {



        $('#purchase_details tbody').empty();



        $("#select_product option").remove();



        $.each(cus_order_details,function(key,items){



            if(items.id_customerorder==id_order)



            {



                console.log(items);



                $.each(items.item_details,function(key,val){



                        $('#select_product').append(



                        $("<option></option>")



                        .attr("value", val.id_product)



                        .text(val.product_name)



                        .attr("data-purmode", val.purchase_mode)



                        .attr("data-tax_type", val.tax_type)



                        );



                });







                $("#select_product").select2({



                    placeholder: "Select Product",



                    allowClear: true



                });







                $("#select_product").select2("val","");



            }



        });



    }







    if(ctrl_page[1]=='purchase' && ctrl_page[2]=='add' && this.value!='')



    {



        let order_search=true;



        if(order_for==3)



        {



            if($('#branch_select').val()=='' || $('#branch_select').val()==null)



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Branch"});



                order_search=false;



                 $("#select_order_no").select2("val","");



            }



        }



        if(order_search)



        {



            var trHtml='';



            $.each(cus_order_details,function(key,val){



                if(val.id_customerorder==id_order)



                {



                    $.each(val.order_details,function(k,items){

                        console.log('order_details',items);



                       if(items.image_details.length > 0 )



                       {

                            var purchase_img_resource = [];



                            $.each(items.image_details,function(k,det){



                                img_src = base_url + 'assets/img/orders/' + det.image;



                                purchase_img_resource.push({"src":det['img_src'],'name':det['image']});



                            });



                       }



                       else{



                        img_src=base_url+'assets/img/no_image.png';



                       }



                       if(items.stone_details!="")



                        {



                            var stone_details = [];



                            $.each(items.stone_details,function(k,sitem)



                            {



                                stone_details.push({ "show_in_lwt" : sitem.is_apply_in_lwt, "stone_id" : sitem.stone_id, "stones_type" : sitem.stone_type, "stone_pcs" : sitem.pieces, "stone_wt" : sitem.wt, "stone_price" : sitem.amount, "stone_rate" : sitem.rate_per_gram, "stone_uom_id" : sitem.uom_id, "stone_cal_type" : sitem.stone_cal_type,"stone_price":sitem.price});



                            })



                        }



                            var id = $('#purchase_details > tbody  > tr').length;



                            trHtml='<tr class="'+id+'">'



                            +'<td><img src='+img_src+' width="50" height="55" id="purchase_order_images"><br><a  class="btn btn-secondary order_img"  id="edit" data-toggle="modal" data-id='+items.id_orderdetails+'><i class="fa fa-eye" ></i></a></td>'



                            +'<td class ="tag_code" >'+items.tag_code+'</td>'



                            +'<td><input type="hidden" name="order_details[id_orderdetails][]" value="'+items.id_orderdetails+'"><input type="hidden" class="order_images" value=\''+(items.image_details.length > 0 ? JSON.stringify(purchase_img_resource) :'')+'\'" name="order_details[order_images][]" /><input type="hidden" class="id_customer_order"  name="order_details[id_customer_order][]" value="'+$('#select_order_no').val()+'"><input type="hidden" class="id_product"  name="order_details[product][]" value="'+items.id_product+'">'+items.product_name+'</td>'



                            +'<td><input type="hidden" class="design"  name="order_details[design][]" value="'+items.design_no+'">'+items.design_name+'</td>'



                            +'<td><input type="hidden" class="sub_design"  name="order_details[sub_design][]" value="'+items.id_sub_design+'">'+items.sub_design_name+'</td>'



                            +'<td><input type="hidden" class="size"  name="order_details[size][]" value="'+items.id_size+'">'+items.size+'</td>'



                            +'<td><input type="number" class="form-control piece"  name="order_details[piece][]" value="'+items.totalitems+'" readonly></td>'



                            +'<td><input type="hidden" class="approx_wt"  name="order_details[order_wt][]" value="'+items.weight+'" >'+items.weight+'</td>'



                            // +'<td><div class="form-group"><div class="input-group"><input class="form-control less_wt" onclick="show_purchase_stone_details($(this).closest(\'tr\'));" type="number" name="order_details[less_wt][]"  step="any" value="'+items.less_wt+'" readonly="" style="width:80px;"><span class="input-group-addon input-sm add_tag_lwt" onclick="show_purchase_stone_details($(this).closest(\'tr\'));">+</span><input type="hidden" class="stone_details" value='+JSON.stringify(stone_details)+'></div></div></td>'



                            +'<td><input type="hidden" class="less_wt"  name="order_details[less_wt][]" value="'+items.less_wt+'">'+items.less_wt+'</td>'



                            +'<td><input type="hidden" class="net_wt"  name="order_details[net_wt][]" value="'+items.net_wt+'">'+items.net_wt+'</td>'



                            +'<td><input type="hidden" class="stn_amt"  name="order_details[stn_amt][]" value="'+items.stn_amt+'">'+items.stn_amt+'</td>'



                            +'<td><input type="hidden" class="wast_percent"  name="order_details[wast_percent][]" value="'+items.wast_percent+'">'+items.wast_percent+'</td>'



                            +'<td><input type="hidden" class="mc_value"  name="order_details[mc_value][]" value="'+items.mc_value+'">'+items.mc_value+'</td>'



                            + '<td><a href="#" onClick="update_order_description($(this).closest(\'tr\'));" class="btn btn-default btn-sm"><i class="fa fa-plus"></i></a><input type="hidden" class="order_des" name="order_details[description][]" value="' +items.description + '"></td>'



                            + '<td><input type="hidden" class="due_date"  name="order_details[due_date][]" value="'+$('.smith_due_dt').val()+'" >'+$(".smith_due_dt").val()+'</td>'



                            +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_purchase_order_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



                            +'</tr>';





                            if($('#purchase_details > tbody  > tr').length>0)



                            {



                                $('#purchase_details > tbody > tr:first').before(trHtml);





                            }else{



                                $('#purchase_details tbody').append(trHtml);



                            }







                    });



                }



            });







            calculate_purchase_order_item_details();



            reset_purchase_order_form();



        }



    }



});



$(document).on('click', "#order_list a.order_img", function(e) {



    e.preventDefault();



    id=$(this).data('id');



    // alert(id);



    $("#edit-id").val(id);



    view_dup_tag_history_imgs(id);



});



/*$(document).on('click', "#purchase_details a.order_img", function(e) {



    e.preventDefault();



    id=$(this).data('id');



    // alert(id);



    $("#edit-id").val(id);



    view_dup_tag_history_imgs(id);



});*/



function view_dup_tag_history_imgs(order_id_img1)



{



	 update_tag_img_id1 = order_id_img1;



	 data = [];



     var tag_codeimage1 =  base_url+'assets/img/orders';



	 $('#imageModal_bulk_edit').modal('show');



     $(".overlay").css('display',"none");



	 $.ajax({



        data: ( {'order_id':order_id_img1}),



			  url:base_url+ "index.php/admin_ret_order/get_img_by_order_id?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



			  dataType:"JSON",



			  type:"POST",



			  success:function(data){



				  retrive_img = data;



				  for (i = 0; i < data.length; i++)



				  {



					img_src = data[i].image;



					var preview = $('#order_images_preview');



					var img = tag_codeimage1 + '/' + img_src;



					if (img_src) {



                    div = document.createElement("div");



                    div.setAttribute('class', 'col-md-3 images');



                    div.setAttribute('id', 'order_img_edit_' + [i]);







					$('.images').css('margin-right','25px');



                    key = [i];



                    param = img_src;







                    div.innerHTML += "<div class='form-group'><div class='image-input image-input-outline' id='kt_image_'><div class='image-input-wrapper'><img class='thumbnail' src='" + img + "'" + "style='width: 300px;height: 250px;'/><a href="+img+" download="+img_src+"><i class='fa fa-download btn btn-success'>Download</i></div></div></a>";



                    preview.append(div);







                }



            }







			  },



			  error:function(error)



				{



					$("div.overlay").css("display", "none");



				}



		  });



}



function calculate_purchase_order_item_details()



{



    var total_pcs=0;



    var total_wt=0;



    var trHtml='';



    $('#purchase_details > tbody  > tr').each(function(index, tr) {



        total_pcs+=parseFloat($(this).find('.piece').val());



        total_wt+=parseFloat($(this).find('.approx_wt').val());



    });



    $('.tot_pcs').html(total_pcs);



        $('.tot_wt').html(parseFloat(total_wt).toFixed(3));



    $('.order_pcs').val(total_pcs);



    $('.order_wt').val(parseFloat(total_wt).toFixed(3));



}



$(document).on('change','.piece',function(){



    curRow =   $(this).closest('tr');



    var actual_pcs = curRow.find('.cus_ord_pcs').val();



    var piece = curRow.find('.piece').val();



    if(parseFloat(actual_pcs) < parseFloat(piece))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>You Have entered More Than the Available Pcs.."});



        curRow.find('.piece').val(actual_pcs);



    }



});



function remove_purchase_order_row(curRow)



{

    var order_for = $("input[name='order[order_for]']:checked").val();



    curRow.remove();



    if(ctrl_page[2] == 'add' && ctrl_page[1] == 'purchase' && order_for == 3  ){

        calculate_purchase_order_item_details();

    }else{

        calculate_order_item_details();

    }



   



}



$("#add_order_item").on('click',function(){



    var order_for = $("input[name='order[order_for]']:checked").val();







	if($('#select_karigar').val() == null || $('#select_karigar').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Karigar"});



	}



	else if($('#select_product').val() == null || $('#select_product').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Product"});



	}



	else if($('#select_design').val() == null || $('#select_design').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Design"});



	}



	else if($('#select_sub_design').val() == null || $('#select_sub_design').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Sub Design"});



	}



	else if(($('#select_weight_range').val() == null || $('#select_weight_range').val() == '') && (order_for==1))



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Weight Range"});



	}



	else if(($('#order_weight').val() == 0 || $('#order_weight').val() == '') && (order_for==2))



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter Weight"});



	}



	else if($('#tot_pcs').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Pcs"});



	}



	else if($('.smith_due_dt').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Due Date"});



	}



	else if(order_for==2 && ($('#select_order_no').val() == null || $('#select_order_no').val() == ''))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Customer Order No"});



    }



	else



	{



	    set_purchase_order_preview();



	}



});



function set_purchase_order_preview()



    {



    var trHtml='';



    var approx_wt=0;



    var order_for = $("input[name='order[order_for]']:checked").val();



    if(order_for==1)



    {



        $.each(weight_range_details,function(key,items){



            if(items.id_weight==$('#select_weight_range').val())



            {



                approx_wt=parseFloat(items.value*$("#tot_pcs").val());



            }



        });



    }



    else



    {



        approx_wt=$('#order_weight').val();



    }











       var img_final = [];



       var image_order = $('#order_iamges').val();



        if (image_order!=""){



         var decoded_image_order = JSON.parse(image_order);



       console.log(decoded_image_order);



       img_final = (decoded_image_order);



       console.log(img_final);



       var img_src ="";



       var img_source =[];



        $.each(img_final, function (index, item) {



        img_source.push({'index': index,'src': item.src,'is_default': item.is_default});







        console.log(img_source);







        // var img_source_json =



       var images = item.src;



        if (images != '' && images != null) {



            img_src = images;



        } else {



            img_src = base_url + 'assets/img/no_image.png';



        }



       });



       }



       else {



        img_src = base_url + 'assets/img/no_image.png';



       }







      //Changed line



          var id = $('#item_detail > tbody tr').length;







               trHtml+='<tr id="'+id+'" class="'+id+'" >'



                + '<td><img src="' + img_src + '" width="50" height="55" ><br><a class="btn btn-secondary order_img" data-id="" onclick="update_image_upload($(this).closest(\'tr\'));"><i class="fa fa-eye"></i></a></td>'



                +'<td><input type="hidden" value='+JSON.stringify(img_source)+' class="order_images" name="order_details[order_images][]" /><input type="hidden" class="id_customer_order"  name="order_details[id_customer_order][]" value="'+$('#select_order_no').val()+'"><input type="hidden" class="id_product"  name="order_details[product][]" value="'+$('#select_product').val()+'">'+$("#select_product option:selected").text()+'</td>'



                +'<td><input type="hidden" class="design"  name="order_details[design][]" value="'+$('#select_design').val()+'">'+$("#select_design option:selected").text()+'</td>'



                +'<td><input type="hidden" class="sub_design"  name="order_details[sub_design][]" value="'+$('#select_sub_design').val()+'">'+$("#select_sub_design option:selected").text()+'</td>'



                +'<td><input type="hidden" class="size"  name="order_details[size][]" value="'+$('#select_size').val()+'">'+$("#select_size option:selected").text()+'</td>'



                +'<td><input type="hidden" class="weight_range"  name="order_details[weight_range][]" value="'+$('#select_weight_range').val()+'" >'+$("#select_weight_range option:selected").text()+'</td>'



                +'<td style="text-align:right;"><input type="hidden" class="approx_wt" name="order_details[order_wt][]" value="'+approx_wt+'">'+parseFloat(approx_wt).toFixed(2)+'</td>'



                +'<td style="text-align:right;"><input type="hidden" class="piece"  name="order_details[piece][]" value="'+$('#tot_pcs').val()+'" >'+$("#tot_pcs").val()+'</td>'



                + '<td><a href="#" onClick="update_order_description($(this).closest(\'tr\'));" class="btn btn-default btn-sm"><i class="fa fa-plus"></i></a><input type="hidden" class="order_des" name="order_details[description][]" value="' + $("#remark").val() + '"></td>'



                +'<td><input type="hidden" class="due_date"  name="order_details[due_date][]" value="'+$('.smith_due_dt').val()+'" >'+$(".smith_due_dt").val()+'</td>'



                +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



            +'</tr>';







    if($('#item_detail > tbody  > tr').length>0)



    {



        $('#item_detail > tbody > tr:first').before(trHtml);



    }else{



        $('#item_detail tbody').append(trHtml);



    }



    calculate_order_item_details();



    reset_purchase_order_form();



}



$(document).on('click',".add_order_desc", function(){



	var curRow=$("#i_increment").val(); // For customer order



	var content=$("#order_des #description").val();



	$('.'+curRow).find('.order_des').val(content);



	$('#order_des').modal('toggle');



});



function update_order_description(curRow, id) {



    $('#i_increment').val(curRow.closest('tr').attr('class'));



    $('#order_des #description').val(curRow.closest('tr').find('.order_des').val());



    $('#order_des').modal('show');



}



$('#imageModal  #update_img').on('click', function(){



	$('#imageModal').modal('toggle');



	var curRow=$("#active_row").val();



	$('.'+curRow).find('.order_img').val(JSON.stringify(pre_img_resource));



});



function update_image_upload(curRow, id)



{



    if (curRow != undefined) {



        $('#imageModal_bulk_edit').modal('show');



        console.log(curRow);



        $('#custom_active_id').val(curRow.closest('tr').attr('id'));



        console.log("TABLE ID: ", curRow.closest('table').attr('id'));



        $('#item_detail').val(curRow.closest('table').attr('id'));



    }



    var catRow = $('#custom_active_id').val();



    console.log(catRow);



    var imageSrc = JSON.parse($('#' + catRow).find('.order_images').val());



    console.log(imageSrc);



    var img_src = "";



    $.each(imageSrc, function (index, item) {



        var images = item.src;



        console.log(images);



        if (images != '' && images != null) {



            img_src = images;



        } else {



            img_src = base_url + 'assets/img/no_image.png';



        }



        var img = img_src;



        if (img_src) {



            console.log(img_src);



            div = document.createElement("div");



            div.setAttribute('class', 'col-md-3 images');



            div.setAttribute('id', 'order_img_edit_' + index);



            $('.images').css('margin-right', '25px');



            key = index;



            param = img_src;



            // Use onclick to call showImageModal with the image source



            div.innerHTML += "<div class='form-group'><div class='image-input image-input-outline' id='kt_image_'><div class='image-input-wrapper'><img class='thumbnail' src='" + img + "' style='width: 300px; height: 250px;' onclick=\"showImageModal('" + img_src + "')\" /><a href=" + img + " download=" + img_src + "><i class='fa fa-download btn btn-success'>Download</i></div></div></a>";



            $('#order_images_preview').append(div);



        }



    });



}



$("#imageModal_bulk_edit").on("hidden.bs.modal", function () {



    $('#ordered_images').empty();



    $('#order_images_preview').empty();



});



function calculate_order_item_details()



{



    var total_pcs=0;



    var total_wt=0;



    var trHtml='';



    $('#item_detail > tbody  > tr').each(function(index, tr) {



        total_pcs+=parseFloat($(this).find('.piece').val());



        total_wt+=parseFloat($(this).find('.approx_wt').val());



    });



    $('.tot_pcs').html(total_pcs);



    $('.tot_wt').html(parseFloat(total_wt).toFixed(3));



    $('.order_pcs').val(total_pcs);



    $('.order_wt').val(parseFloat(total_wt).toFixed(3));



}



$('.smith_due_dt').on('change',function(){



        var order_date=dateToTimeStamp($('.smith_due_dt').val());



        var current_date =Date.now();



        if(current_date>order_date)



        {



            $('.smith_due_dt').val('');



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please Select Valid Date..'});



        }



});



function dateToTimeStamp(date)



{



    new_date=date.split("/");



    new_date = new_date[1]+"/"+new_date[0]+"/"+new_date[2];



    time_stamp=new Date(new_date).getTime();



    return time_stamp;



}



function reset_purchase_order_form()



{



    $('#select_size').select2("val","");



    $('#select_weight_range').select2("val","");



    $('#tot_pcs').val('');



    $('#remark').val('');



}



function create_new_empty_pur_order_row()



{



    var category='<option value="">Select Category</option>';



    $.each(categoryDetails, function (mkey, mitem) {



		category += "<option value='"+mitem.id_ret_category+"'>"+mitem.name+"</option>";



	});







    var trHtml='';



    trHtml+='<tr>'



                +'<td><select class="form-control select_category" name="order_details[category][]" value="">'+category+'</td>'



                +'<td><select class="form-control select_product" name="order_details[product][]"></td>'



                +'<td><select class="form-control select_design" name="order_details[design][]"></td>'



                +'<td><select class="form-control select_sub_design" name="order_details[sub_design][]"></td>'



                +'<td><select class="form-control select_size" name="order_details[size][]"></td>'



                +'<td><select class="form-control select_weight_range" name="order_details[weight_range][]"></td>'



                +'<td><input type="number" class="form-control piece" name="order_details[piece][]"></td>'



                +'<td><input class="form-control datemask date smith_due_dt" name="order_details[due_date][]" data-date-format="dd-mm-yyyy" type="text"/></td>'



                +'<td><a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



            '</tr>';







    $('#item_detail tbody').append(trHtml);



    $('#item_detail > tbody').find('.select_category').select2();



    $('#item_detail > tbody').find('.select_product').select2();



    $('#item_detail > tbody').find('.select_design').select2();



    $('#item_detail > tbody').find('.select_sub_design').select2();



    $('#item_detail > tbody').find('.select_size').select2();



    $('#item_detail > tbody').find('.select_weight_range').select2();







	$('#item_detail > tbody').find('.select_category').select2({



	    placeholder: "Category",



	    allowClear: true



	});







	$('#item_detail > tbody').find('.select_product').select2({



	    placeholder: "Product",



	    allowClear: true



	});







	$('#item_detail > tbody').find('.select_design').select2({



	    placeholder: "Design",



	    allowClear: true



	});







	$('#item_detail > tbody').find('.select_sub_design').select2({



	    placeholder: "Sub Design",



	    allowClear: true



	});







	$('#item_detail > tbody').find('.select_size').select2({



	    placeholder: "Sub Design",



	    allowClear: true



	});







	$('#item_detail > tbody').find('.select_weight_range').select2({



	    placeholder: "Select Weight Range",



	    allowClear: true



	});











	$('.smith_due_dt').datepicker({ dateFormat: 'yyyy-mm-dd'});







}



$(document).on('change',".select_category",function(){







    var row = $(this).closest('tr');



    row.find('.select_product option').remove();



    row.find('.select_product').select2("val","");



    if(this.value!='')



    {



        get_ActiveProduct(this.value,row);



    }else{



         get_ActiveProduct(this.value,row);



    }



});



function get_ActiveProduct(id_ret_category,curRow)



{







    $(".overlay").css("display", "block");



    my_Date = new Date();



	$.ajax({



	type: 'POST',



	data:{'id_ret_category':id_ret_category},



	url: base_url+"index.php/admin_ret_catalog/get_ActiveProducts/?nocache=" + my_Date.getUTCSeconds(),



	dataType:'json',



	success:function(data){



	        	$.each(data, function (key, item) {



        		   curRow.find('.select_product').append(



        		    $("<option></option>")



        		    .attr("value", item.pro_id)



        		    .text(item.product_name)



        		    .attr("data-purmode", item.purchase_mode)



        		    .attr("data-tax_type", item.tax_type)



        		    );



        		});



	         $(".overlay").css("display", "none");



		}



	});



}



$(document).on('change',".select_product",function(){







    var row = $(this).closest('tr');



    row.find('.select_size option').remove();



    row.find('.select_design option').remove();



    row.find('.select_weight_range option').remove();



    row.find('.select_design').select2("val","");



    row.find('.select_size').select2("val","");



    row.find('.select_weight_range').select2("val","");



    if(this.value!='')



    {



        get_ActiveDesigns(this.value,row);



        get_ActiveSize(this.value,row);



        get_ActiveWeightRange(this.value,row);



    }



    var pur_type = $('#select_product option:selected').attr('data-purmode');



    if(pur_type == 1){



        $('#item_cost').prop('readonly',false);



    }else{



        $('#item_cost').prop('readonly',true);



    }



});



function get_ActiveWeightRange()



{



    $(".overlay").css("display", "block");



    $('#select_weight_range option').remove();



    my_Date = new Date();



	$.ajax({



	type: 'POST',



	data:{'id_product':$('#select_product').val()},



	url: base_url+"index.php/admin_ret_purchase/get_ActiveWeightRange/?nocache=" + my_Date.getUTCSeconds(),



	dataType:'json',



	success:function(data){







	            weight_range_details=data;







	        	$.each(data, function (key, item) {



        		   $('#select_weight_range').append(



        		    $("<option></option>")



        		    .attr("value", item.id_weight)



		            .text(item.name)



        		    );



        		});







        		$("#select_weight_range").select2(



        		{



        			placeholder:"Select Weight Range",



        			allowClear: true



        		});







        		if($("#select_weight_range").length)



        		{



        		    $("#select_weight_range").select2("val",'');



        		}











	         $(".overlay").css("display", "none");



		}



	});



}



function get_ActiveSize()



{



    $(".overlay").css("display", "block");



    $('#select_size option').remove();



    my_Date = new Date();



	$.ajax({



	type: 'POST',



	data:{'id_product':$('#select_product').val()},



	url: base_url+"index.php/admin_ret_tagging/get_ActiveSize/?nocache=" + my_Date.getUTCSeconds(),



	dataType:'json',



	success:function(data){



	        	$.each(data, function (key, item) {



        		   $('#select_size').append(



        		    $("<option></option>")



        		    .attr("value", item.id_size)



		            .text(item.value+'-'+item.name)



        		    );



        		});



	         $(".overlay").css("display", "none");



		}



	});



}



function get_ActiveDesigns(id_product,curRow)



{



    $(".overlay").css("display", "block");



    my_Date = new Date();



	$.ajax({



	type: 'POST',



	data:{'id_product':id_product},



	url: base_url+"index.php/admin_ret_catalog/get_active_design_products/?nocache=" + my_Date.getUTCSeconds(),



	dataType:'json',



	success:function(data){



	        	$.each(data, function (key, item) {



        		   curRow.find('.select_design').append(



        		    $("<option></option>")



        		    .attr("value", item.design_no)



        		    .text(item.design_name)



        		    );



        		});



	         $(".overlay").css("display", "none");



		}



	});



}



$(document).on('change',".select_design",function(){







    var row = $(this).closest('tr');



    row.find('.select_sub_design option').remove();



    row.find('.select_sub_design').select2("val","");



    if(this.value!='')



    {



        get_ActiveSubDesigns(this.value,row);



    }



});



function get_ActiveSubDesigns(id_product,curRow)



{



    $(".overlay").css("display", "block");



    my_Date = new Date();



	$.ajax({



	type: 'POST',



	data:{'id_product':id_product},



	url: base_url+"index.php/admin_ret_catalog/get_ActiveSubDesigns/?nocache=" + my_Date.getUTCSeconds(),



	dataType:'json',



	success:function(data){



	        	$.each(data, function (key, item) {



        		   curRow.find('.select_sub_design').append(



        		    $("<option></option>")



        		    .attr("value", item.id_sub_design)



        		    .text(item.sub_design_name)



        		    );



        		});



	         $(".overlay").css("display", "none");



		}



	});



}



function validateOrderDetailRow()



{



    var validate = true;



	$('#item_detail > tbody  > tr').each(function(index, tr) {



		if($(this).find('.select_product').val() == "" || $(this).find('.select_design').val() == "" || $(this).find('.select_sub_design').val() == "" || $(this).find('.select_size').val() == ""  || $(this).find('.select_weight_range').val() == "" || $(this).find('.piece').val() == "" ){



			validate = false;



		}



	});



	return validate;



}



$("#create_order").on('click',function(e) {



	e.preventDefault();



	create_customer_order();



});



function create_customer_order()



{



    var order_for = $("input[name='order[order_for]']:checked").val();



    if($('#select_karigar').val() == null || $('#select_karigar').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Karigar"});



	}



	else if($('.smith_due_dt').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Due Date"});



	}



	else if((order_for==2 || order_for==3) && ($('#select_order_no').val() == null || $('#select_order_no').val() == ''))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Order No"});



    }



    else if(($('#item_detail > tbody  > tr').length==0) && (order_for==1))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'No Record Found..'});



    }



    else if(($('#purchase_details > tbody  > tr').length==0)&& (order_for==2))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'No Record Found..'});



    }



    else



    {



        $("div.overlay").css("display", "block");



    		$('#create_stock_order').prop('disabled',true);



    		var form_data=$('#order_submit').serialize();



    			var url=base_url+ "index.php/admin_ret_purchase/purchase/save?nocache=" + my_Date.getUTCSeconds();



    		    $.ajax({



    		        url:url,



    		        data: form_data,



    		        type:"POST",



    		        dataType:"JSON",



    		        success:function(data){



    		            if(data.status)



    		            {



    		                location.href=base_url+'index.php/admin_ret_purchase/purchase/pur_order';



    		                $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.msg});



    		                $("div.overlay").css("display", "none");



    		            }else



    		            {



    		                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.msg});



    		                $("div.overlay").css("display", "none");



    		            }







    		        },



    		        error:function(error)



    		        {



    		            $("div.overlay").css("display", "none");



    		        }



    		    });



    		$('#create_stock_order').prop('disabled',false);



    }



}



$('#pur_ord_search').on('click',function(){



    get_purchase_order_list();



});



function get_purchase_order_list()



{



    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



			 url:base_url+ "index.php/admin_ret_purchase/purchase/purchase_order?nocache=" + my_Date.getUTCSeconds(),



			 dataType:"JSON",



			 type:"POST",



			 data:{'from_date':$('#rpt_from_date').html(),'to_date':$('#rpt_to_date').html(),'order_for':$('#select_order').val()},



			 success:function(data){



			 	var list=data.list;



				var oTable = $('#order_list').DataTable();



				oTable.clear().draw();



				if (list!= null && list.length > 0)



				{



					oTable = $('#order_list').dataTable({



                    "bDestroy": true,



                    "bInfo": true,



                    "bFilter": true,



                    "bSort": true,



                    "order": [[ 0, "desc" ]],



                    "dom": 'lBfrtip',



                    "buttons" : ['excel','print'],



                    "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



                    "aaData": list,



                    "aoColumns": [



                    { "mDataProp": function ( row, type, val, meta ){



                        if(row.order_status<=3)



                        {



                            return '<input type="checkbox" class="id_customerorder" name="id_customerorder[]" value="'+row.id_customerorder+'"/><input type="hidden" class="cus_ord_ref" name="cus_ord_ref[]" value="'+row.cus_ord_ref+'"/>'+row.id_customerorder;



                        }else{



                            return row.id_customerorder;



                        }



        			},



        			},



                    { "mDataProp": "pur_no" },



                    { "mDataProp": "order_date" },



                    { "mDataProp": function ( row, type, val, meta ){



                        return '<span class="badge bg-'+row.color+'">'+row.order_status_msg+'</span>';



        			},



        			},



                    { "mDataProp": "karigar_name" },



                    { "mDataProp": "mobile" },



                    { "mDataProp": "order_for" },



                    { "mDataProp": "order_pcs" },



                    { "mDataProp": function ( row, type, val, meta ) {



                    return parseFloat(row.order_approx_wt).toFixed(3);



                    }



                    },







                    { "mDataProp": function ( row, type, val, meta ) {



                    return parseFloat(row.delivered_qty);



                    }



                    },







                    { "mDataProp": function ( row, type, val, meta ) {



                    return parseFloat(row.delivered_wt).toFixed(3);



                    }



                    },







                    { "mDataProp": "order_no" },



                    { "mDataProp": "cus_order_branch" },











                    { "mDataProp": function ( row, type, val, meta ) {



                    id= row.id_customerorder;



                    print_url=base_url+'index.php/admin_ret_purchase/get_karigar_acknowladgement/'+id;



                    action_content='<a href="#" onclick="send_karigar_sms('+id+','+row.mobile+')"  class="btn btn-success" data-toggle="tooltip" title="Send WhatsApp / Email"><i class="fa fa-whatsapp" aria-hidden="true"></i><a href="'+print_url+'" target="_blank" class="btn btn-info btn-print" data-toggle="tooltip" title="Vendor acknowledgement "><i class="fa fa-print" ></i></a>';



                    return action_content;



                    }



                    },







                    ]



                    });







				}



				$("div.overlay").css("display", "none");



			  },



			  error:function(error)



			  {



				 $("div.overlay").css("display", "none");



			  }



	      });



}



function send_karigar_sms(id_customer_order,mobile)



{



    if(mobile!='')



    {



         my_Date = new Date();



            $("div.overlay").css("display", "block");



            $.ajax({



                url:base_url+ "index.php/admin_ret_purchase/send_karigar_sms?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



                data:  {'mobile':mobile,'id_customer_order':id_customer_order},



                type:"POST",



                async:false,



                dataType:'json',



                success:function(data){



                        if(data.status)



                        {



                            $('#order_delviery').prop('disabled',false);



                            $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                            $("div.overlay").css("display", "none");



                            window.location.reload();



                        }else



                        {



                            $('#order_delviery').prop('disabled',false);



                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                        }







                },



                error:function(error)



                {



                $("div.overlay").css("display", "none");



                }



            });



    }



    else



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Mobile Number Not Found"});



    }



}



//PUrchase Entry



/*$('#select_po_no').on('change',function(){



   if(this.value!='')



   {



        var id_customerorder=this.value;



        $.each(karigar_pending_order_details,function(key,items){



            if(items.id_customerorder==id_customerorder)



            {



                if(items.ref_order_type==3) // Customer Repair



                {



                    $('#is_cus_repair_order').val(1);



                    $('#select_design').prop('disabled',true);



                    $('#select_sub_design').prop('disabled',true);



                    $('.cus_repair').css('display','block');



                    $('.oranmentspo').css('display','none');



                    $('#tot_wastage_perc').prop('readonly',false);



                }



                else



                {



                    $('#select_design').prop('disabled',false);



                    $('#select_sub_design').prop('disabled',false);



                    $('#is_cus_repair_order').val(0);



                    $('.cus_repair').css('display','none');



                    $('.oranmentspo').css('display','block');



                    $('#tot_wastage_perc').prop('readonly',true);



                }



            }



        });



   }



});*/



$('#select_po_no').on('change',function(){



   is_metal_issue=0;



   $('#is_stock_repair_order').val(0);



   $(".repair_col").css("display","none");



   if(this.value!='')



   {



        var id_customerorder = this.value;



        var ordered_categories = [];



        var selectable_categories = [];



        var order_details = [];



        var selected_order_details = [];



       



        $.each(karigar_pending_order_details, function(key,items){



            if(items.id_customerorder == id_customerorder)



            {



                if(items.ref_order_type == 3) // Customer Repair



                {



                    is_metal_issue=1;



                    $('#is_cus_repair_order').val(1);



                    $('#select_design').prop('disabled',true);



                    $('#select_sub_design').prop('disabled',true);



                    $('.cus_repair').css('display','block');



                    $('.oranmentspo').css('display','none');



                    //$('#tot_wastage_perc').prop('readonly',false);



                } else if(items.ref_order_type == 4 ) // Stock Repair



                {



                    $(".repair_col").removeAttr('style');



                    $('#select_design').prop('disabled',false);



                    $('#select_sub_design').prop('disabled',false);



                    $('#is_cus_repair_order').val(0);



                    $('.cus_repair').css('display','none');



                    $('.oranmentspo').css('display','block');



                    item_details = items.item_details;



                    create_repair_order_details(item_details);



                    $('#is_stock_repair_order').val(1);



                    //$('#tot_wastage_perc').prop('readonly',false);



                }



                else



                {



                    $('#select_design').prop('disabled',false);



                    $('#select_sub_design').prop('disabled',false);



                    $('#is_cus_repair_order').val(0);



                    $('.cus_repair').css('display','none');



                    $('.oranmentspo').css('display','block');



                    //$('#tot_wastage_perc').prop('readonly',true);



                }



                var totalitems = 0;



                var weight = 0;



                var receivedpcs = 0;



                var receivedwt = 0;



                $.each(items.order_details, function(okey, oitems){



                    totalitems+=parseFloat(oitems.totalitems);



                    weight+=parseFloat(oitems.weight);



                    receivedpcs+=parseFloat(oitems.receivedpcs);



                    receivedwt+=parseFloat(oitems.receivedwt);



                    ordered_categories.push({'catid' : oitems.cat_id});



                });



                selected_order_details = items;



                order_details = items.order_details;











                $("#orderedpcs").html(parseFloat(totalitems).toFixed(0));



                $("#orderedwt").html(parseFloat(weight).toFixed(3));



                $("#receivedpcs").html(parseFloat(receivedpcs).toFixed(0));



                $("#receivedwt").html(parseFloat(receivedwt).toFixed(3));



            }



        });







        /*var uniqueSites = ordered_categories.filter(function(item, i, ordered_categories) {



            return i == ordered_categories.indexOf(item);







        });*/







        const key = 'catid';



        const orderarrayUniqueByKey = [...new Map(ordered_categories.map(item =>



          [item[key], item])).values()];







        //ordered_categories.map(item => item.catId).filter((value, index, self) => self.indexOf(value) === index)







        //Update respected order category into category list to avoid loading all the category



        //$("#select_category").empty();







        $('#select_category option').remove();



         $.each(orderarrayUniqueByKey, function(okey, oval){



            $.each(category_lists, function(ckey, cval){



                if(oval.catid == cval.id_ret_category){



                    selectable_categories.push({"catId" : oval.catid, "catName" : cval.name,"cat_type" : cval.cat_type});



                }



            });



         });











        $.each(selectable_categories, function (key, item) {



            $('#select_category').append(



            $("<option></option>")



            .attr("value", item.catId)



            .attr("data-cattype", item.cat_type)



            .text(item.catName)



            );



    	});







    	$('#select_category').select2({



    	    placeholder: "Select Category",



    	    allowClear: true



    	});











    	if($('#select_category').length)



        {



            $('#select_category').select2("val", '');



        }











    $('#cus_orderdetailsModal').modal('show');



    $('#order_items_details tbody').empty();



    var trHtml='';



    $.each(order_details,function(key,i){



        trHtml+='<tr>'



                    +'<td>'+i.catname+'</td>'



                    +'<td>'+i.product_name+'</td>'



                    +'<td>'+i.design_name+'</td>'



                    +'<td>'+i.sub_design_name+'</td>'



                    +'<td>'+i.totalitems+'</td>'



                    +'<td>'+i.weight_description+'</td>'



                    +'<td>'+i.receivedpcs+'</td>'



                    +'<td>'+i.receivedwt+'</td>'



                +'</tr>';



    });



    $('#order_items_details tbody').append(trHtml);



   }



});



function get_karigar_pending_orders()



{



    $("div.overlay").css("display", "block");



    $('#select_po_no option').remove();



    $.ajax({



	type: 'POST',



	data:{'id_karigar':$('#select_karigar').val(),'po_id':$('#po_id').val()},



	url: base_url+'index.php/admin_ret_purchase/get_karigar_pending_order_details',



	dataType:'json',



	success:function(data){



	    karigar_pending_order_details=data;



	    var id=$('#select_po_no').val();



		$.each(data, function (key, item) {



		    $("#select_po_no").append(



		    $("<option></option>")



		    .attr("value", item.id_customerorder)



		    .text(item.pur_no+(item.order_no !='' ?(' - '+item.order_no):''))



		    );



		});



		$("#select_po_no").select2(



		{



			placeholder:"Select PO NO",



			closeOnSelect: true



		});







		if($("#select_po_no").length)



		{



		    $("#select_po_no").select2("val",(id!='' && id>0?id:''));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



function get_karigar_SupplierEntrys()



{



    $("div.overlay").css("display", "block");



    $('#select_supplier_po_no option').remove();



    $.ajax({



    type: 'POST',



    url: base_url+'index.php/admin_ret_purchase/get_po_balance',



    data:{'id_metal':$('#select_metal').val()},



    dataType:'json',



    success:function(data){



        karigar_pending_order_details=data;



        var id=$('#select_supplier_po_no').val();



        $.each(data, function (key, item) {



            $("#select_supplier_po_no").append(



            $("<option></option>")



            .attr("value", item.po_id)



            .text(item.po_ref_no)



            );



        });



        $("#select_supplier_po_no").select2(



        {



            placeholder:"Select Supplier PO NO",



            closeOnSelect: true



        });







        if($("#select_supplier_po_no").length)



        {



            $("#select_supplier_po_no").select2("val",(id!='' && id>0?id:''));



        }



            $(".overlay").css("display", "none");



        }



    });



}



$("input[name='billing[bill_type]']:radio").on('change',function(){



    $('.balance_amount').val(0);



    $('.receive_amount').val(0);



    if(ctrl_page[1]=='supplier_po_payment')



    {



        get_supplier_pay_details();



    }



});



function get_supplier_pay_details(sId)



{



    if($('#select_karigar').val() != ""){



        $("div.overlay").css("display", "block");



        $('.balance_amount').val(0);



        $('.receive_amount').val(0);



        var bill_type = $("input[name='billing[bill_type]']:checked").val(); //1-Bill , 2-Receipt



        if(ctrl_page[1]=='karigarmetalissue')



        {



            bill_type = 2;



        }



        else if(ctrl_page[1]=='supplier_rate_cut')



        {



            bill_type = 3;



        }



        $.ajax({



            type: 'POST',



            data:{ 'id_karigar': $('#select_karigar').val(),'bill_type':bill_type,'id_metal' : isNaN($('#select_metal').val()) ? 0 : $('#select_metal').val() },



            url: base_url+'index.php/admin_ret_purchase/supplier_po_payment/get_supplier_pay_details',



            dataType:'json',



            success:function(data){



                if(ctrl_page[1] == 'karigarmetalissue' && ctrl_page[2] == 'add'){



                    var amtblc = money_format_india(parseFloat(Math.abs(data.balance_amount)).toFixed(2));



                    var amtblctype = data.balance_amount < 0 ?  "Cr" : "Dr";







                    var wtblc = money_format_india(parseFloat(Math.abs(data.balance_purewt)).toFixed(3));



                    var wtblctype = data.balance_purewt < 0 ?  "Cr" : "Dr";



                    $('.availableamtbalance').html( amtblc + " " + amtblctype);







                    $('.availablepurebalance').html( wtblc + " " + wtblctype);



                    $(".overlay").css("display", "none");



                }else if(ctrl_page[1] == 'supplier_rate_cut' && ctrl_page[2] == 'add'){



                    var src_type = $("input[name='supplier_rate_cut[rate_cut_type]']:checked").val();



                    $('#wt_balance').val('');



                    if(src_type==2)



                    {



                        $('#wt_balance').val(parseFloat(Math.abs(data.balance_purewt)).toFixed(3));



                    }







                    if(data.balance_purewt < 0){



                        //$('#wt_balance_type').val(1);



                        //$('.weight_bln_type').html("(Cr)");



                    }else{



                        $('#wt_balance_type').val(2);



                        $('.weight_bln_type').html("(Dr)");



                    }



                    $('#amt_balance').val(parseFloat(Math.abs(data.balance_amount)).toFixed(2));



                    $('.amt_bln_type').html(data.balance_amount < 0 ? "(Cr)" : "(Dr)");







                    $(".overlay").css("display", "none");



                }else{



                    if (data.balance_amount < 0)



                    {



                        $('.balance_amount').val(Math.abs(data.balance_amount));



                        $('.receive_amount').val(Math.abs(data.balance_amount));



                       // $('#bal_purewt').val(data.balance_purewt);



                    }else{

                        $(".balance_amount").prop('readonly', false);

                    }



                    var amtBlnType = data.balance_amount < 0 ? "(Cr)" : "(Dr)";



                    var pureBlnType = data.balance_purewt < 0 ? "(Cr)" : "(Dr)";



                    var closing_value = "Outstanding Amt(Rs) : " + Math.abs(parseFloat(data.balance_amount).toFixed(2)) + amtBlnType + "\t\t Outstanding Pure Wt(Grms): " + Math.abs(parseFloat(data.balance_purewt).toFixed(3)) + pureBlnType;



                    $('.supplierblc').html(closing_value);







                    /*else



                    {



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Not Found"});



                    }*/



                    $(".overlay").css("display", "none");



                    calculatePaymentCost();



                }



            }



        });



    }



}



$('.receive_amount,.cash_amount').on('keyup',function(){



    if(ctrl_page[1]=='supplier_rate_cut')



    {



        calculate_supplier_rate_cut_payment_cost();



    }



    else



    {



        var bill_type = $("input[name='billing[bill_type]']:checked").val();



        if(bill_type ==1)



        {



            var balance_amount = ($('.balance_amount').val()!='' ? $('.balance_amount').val():0);



            var receive_amount = ($('.receive_amount').val()!='' ? $('.receive_amount').val():0);



            if(parseFloat(balance_amount) < parseFloat(receive_amount))



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Received Amount is Grater Than The Out Standing Amount.."});



                $('.receive_amount').val(0);



            }



        }



        calculatePaymentCost();



    }







});



function get_payhistory_by_supid(sId){







    $("div.overlay").css("display", "block");







    $.ajax({



    	type: 'POST',



    	data:{'id_karigar':$('#select_karigar').val()},



    	url: base_url+'index.php/admin_ret_purchase/supplier_po_payment/paymenthistory',



    	dataType:'json',



    	success:function(data){



    	    console.log(data);







    	var oTable = $('#pay_history').DataTable();



			 oTable.clear().draw();



			 if (data!= null && data.payhistory.length > 0)



			 {



				oTable = $('#pay_history').dataTable({



						"bDestroy": true,



						"bInfo": true,



						"bFilter": true,



						"bSort": true,



						"order": [[ 0, "asc" ]],



						"aLengthMenu": [



                            [25, 50, 100, 200, -1],



                            [25, 50, 100, 200, "All"]



                        ],



                        "iDisplayLength": -1,



						"dom": 'lBfrtip',



						"aaData"  : data.payhistory,



						"aoColumns": [	{ "mDataProp":function ( row, type, val, meta ){



											return '<span class="">'+row.billtype+'</span>';



										}},



										{ "mDataProp":function ( row, type, val, meta ){



											return '<span class="">'+row.pay_refno+'</span>';



										}},



										{ "mDataProp":function ( row, type, val, meta ){



											return '<span class="">'+row.pay_date+'</span>';



										}},



										{ "mDataProp":function ( row, type, val, meta ){



											return '<span class="">'+row.po_ref_no+'</span>';



										}},



										{ "mDataProp":function ( row, type, val, meta ){



											return '<span class="">'+row.tot_cash_pay+'</span>';



										}}



									]



					});



				}



    		$(".overlay").css("display", "none");



    	}



    });



}



    $('.selectAllPO').click(function(event) {



		$("#po_pay_details tbody tr td input[type='checkbox']").prop('checked', $(this).prop('checked'));



		event.stopPropagation();



		calculateSelectedPosCost();



	});







    $(document).on('change', '.po_item_pay', function() {







        calculateSelectedPosCost();







    });











    function calculateSelectedPosCost(){



        var pototalcost     = 0;



        var popaidcost      = 0;



        var popayablecost   = 0;



        $('#po_pay_details tbody').find('tr').each(function () {



            var row = $(this);



            if (row.find('input[type="checkbox"]').is(':checked')) {



                pototalcost     += parseFloat(row.find('.item_cost').html());



                popaidcost      += parseFloat(row.find('.paidamt').html());



                popayablecost   += parseFloat(row.find('.balanceamt').html());



                row.find('.curpayable').val(parseFloat(row.find('.balanceamt').html()));



            }



        });







        $('.payable_amt').html(parseFloat(pototalcost).toFixed(2));



        $('.paid_amt').html(parseFloat(popaidcost).toFixed(2));



        $('.balance_amt').html(parseFloat(parseFloat(pototalcost) - parseFloat(popaidcost)).toFixed(2));



        $('.received_amount').val(parseFloat(popayablecost).toFixed(2));



        calculate_received_amount();







    }



$("input[name='order[purchase_type]']:radio").on('change',function(){



    $('#item_detail > tbody').empty();



    $('#select_category').select2("val","");



    $('#select_po_no').select2("val","");



    $('#approval_stock_yes').prop('disabled',false);



    $('#approval_stock_no').prop('disabled',false);



    if(this.value==2)



    {



        $('#select_po_no').prop('disabled',true);



        $('#select_purity').prop('disabled',true);



    }else if(this.value==1)



    {



        if($('#select_karigar').val()!='' && $('#select_karigar').val()!=null)



        {



            get_karigar_pending_orders();



        }







        $('#select_po_no').prop('disabled',false);



        $('#approval_stock_yes').prop('disabled',true);



        $('#approval_stock_no').prop('disabled',true);



        $('#approval_stock_no').prop('checked',true);



        $('#select_purity').prop('disabled',false);



    }







   var po_type = $("input[type='radio'][name='order[po_type]']:checked").val();







    if(po_type==1)



    {



        $('.oranments').css('display','block');



        $('.bullion_purchase').css('display','none');



        $('.stone_purchase').css('display','none');



        $('.oranments-bullion').css('display','block');



    }



    else if(po_type ==2)



    {



        $('.bullion_purchase').css('display','block');



        $('.oranments').css('display','none');



        $('.stone_purchase').css('display','none');



        $('.aganist_order').prop('disabled',true);



        $('.oranments-bullion').css('display','block');



    }else if(po_type == 3){ // For stone purchase



        $('.stone_purchase').css('display','block');



        $('.bullion_purchase').css('display','none');



        $('.oranments-bullion').css('display','none');



        $('.oranments').css('display','none');



        $('.aganist_order').prop('disabled',true);



        $('#select_purity').select2("val","");



        $('#select_purity').prop('disabled',true);







        var uom_list = "<option value=''> - UOM - </option>";



        $.each(uom_details, function (pkey, pitem) {



    		uom_list += "<option value='"+pitem.uom_id+"'>"+pitem.uom_name+"</option>";



    	});



    	//$('.stone_uom_id').append(uom_list);



    	$('.stone_uom_id')



            .find('option')



            .remove()



            .end()



            .append(uom_list);







    }



    get_ActiveCategories();















});



$('.stone_uom_id').on('change',function(){



    if(this.value != ''){



        $(".call_type_label").html("(" + $('.stone_uom_id :selected').text() + ")");



    }



});







$("input[name='cal_type']:radio").on('change', function(){



    if(this.value==1){



        $(".call_type_label").html("(" + $('.stone_uom_id :selected').text() + ")" );



    }else{



        $(".call_type_label").html("(" + "Per Pc" + ")");



    }



});



/*$("input[name='order[po_type]']:radio").on('change',function(){



    $('#item_detail > tbody').empty();



    $('.oranments').css('display','none');



    $('.bullion_purchase').css('display','none');



    $('#select_po_no').select2("val","");



    $('.aganist_order').prop('disabled',false);



    if(this.value==1)



    {



        $('.oranments').css('display','block');



        $('.bullion_purchase').css('display','none');



        $('.stone_purchase').css('display','none');



        $('.oranments-bullion').css('display','block');



    }



    else if(this.value==2)



    {



        $('.bullion_purchase').css('display','block');



        $('.oranments').css('display','none');



        $('.stone_purchase').css('display','none');



        $('.aganist_order').prop('disabled',true);



        $('.oranments-bullion').css('display','block');



    }else if(this.value == 3){ // For stone purchase



        $('.stone_purchase').css('display','block');



        $('.bullion_purchase').css('display','none');



        $('.oranments-bullion').css('display','none');



        $('.oranments').css('display','none');



        $('.aganist_order').prop('disabled',true);



        $('#select_purity').select2("val","");



        $('#select_purity').prop('disabled',true);







        var uom_list = "<option value=''> - UOM - </option>";



        $.each(uom_details, function (pkey, pitem) {



    		uom_list += "<option value='"+pitem.uom_id+"'>"+pitem.uom_name+"</option>";



    	});



    	//$('.stone_uom_id').append(uom_list);



    	$('.stone_uom_id')



            .find('option')



            .remove()



            .end()



            .append(uom_list);







    }



    get_ActiveCategories();



});*/



$("input[name='order[po_type]']:radio").on('change',function()



{



    if(ctrl_page[1]=='purchase' && ctrl_page[2]=='purchase_add')



    {



        $('#select_purity').prop('disabled',false);

        if(this.value==3)

        {

            $('#select_purity').prop('disabled',true);

        }



        $('#select_grn').trigger('change');



    }







});



$("#add_pur_entry_item").on('click',function(){



	if($('#select_karigar').val() == null || $('#select_karigar').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Karigar"});



	}



	else



	{       if(validatePurOrderDetailRow())



        	{



        	    create_new_empty_pur_order_entry_row();



        	}



        	else{



        	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Fill The Required Fields.."});



            }







	}



});



function get_KarigarOrders()



{



    $.ajax({



	type: 'GET',



	url: base_url+'index.php/admin_ret_purchase/get_KarigarOrders',



	dataType:'json',



	success:function(data){



	        karigarOrderDetails=data;



		}



	});



}



function validatePurOrderDetailRow()



{



    var validate = true;



	$('#item_detail > tbody  > tr').each(function(index, tr) {



		if($(this).find('.select_product').val() == "" || $(this).find('.select_design').val() == "" || $(this).find('.select_sub_design').val() == ""  || $(this).find('.piece').val() == "" || $(this).find('.weight').val() == "" ){



			validate = false;



		}



	});



	return validate;



}



function create_new_empty_pur_order_entry_row()



{



   var trHtml='';



    trHtml+='<tr>'



                +'<td></td>'



                +'<td><select class="form-control select_product" name="order_details[product][]"></td>'



                +'<td><select class="form-control select_design" name="order_details[design][]"></td>'



                +'<td><select class="form-control select_sub_design" name="order_details[sub_design][]"></td>'



                +'<td><select class="form-control select_weight_range" name="order_details[weight][]"></td>'



                +'<td><input type="number" class="form-control piece" name="order_details[piece][]"></td>'



                +'<td><a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



            '</tr>';







    $('#item_detail tbody').append(trHtml);



    $('#item_detail > tbody').find('.select_category').select2();



    $('#item_detail > tbody').find('.select_product').select2();



    $('#item_detail > tbody').find('.select_design').select2();



    $('#item_detail > tbody').find('.select_sub_design').select2();







	$('#item_detail > tbody').find('.select_category').select2({



	    placeholder: "Category",



	    allowClear: true



	});







	$('#item_detail > tbody').find('.select_product').select2({



	    placeholder: "Product",



	    allowClear: true



	});







	$('#item_detail > tbody').find('.select_design').select2({



	    placeholder: "Design",



	    allowClear: true



	});







	$('#item_detail > tbody').find('.select_sub_design').select2({



	    placeholder: "Sub Design",



	    allowClear: true



	});







}



/*function set_KarigarPendingOrders()



{







    $.ajax({



	type: 'POST',



	url: base_url+'index.php/admin_ret_purchase/get_KarigarOrders',



	dataType:'json',



	data:{'id_karigar':$('#select_karigar').val()},



	success:function(data){



	         if(data.length>0)



               {



                   var trHtml='';



                   $.each(data,function(key,items){



                       trHtml+='<tr>'



                            +'<td>'+items.pur_no+'<input type="hidden" class="id_orderdetails" value="'+items.id_orderdetails+'"></td>'



                            +'<td>'+items.product_name+'</td>'



                            +'<td>'+items.design_name+'</td>'



                            +'<td>'+items.sub_design_name+'</td>'



                            +'<td><input type="number" class="form-control piece" name="order_details[piece][]"></td>'



                            +'<td><input type="number" class="form-control weight" name="order_details[weight][]"></td>'



                            +'<td><a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



                        '</tr>';



                   });



               }



             $('#item_detail tbody').append(trHtml);



		}



	});











}*/



//PUrchase Entry



//Purchase Order Status



$('#ordet_status_search').on('click',function(){



    get_pur_order_Details();



});



function get_pur_order_Details()



{



    var company_name    = $('#company_name').val();



    var from_date = $('#rpt_from_date').html();



    var to_date = $('#rpt_to_date').html();



    var branch_name = '';



    var report_name = "PUCHASE ORDER REPORT";



    var karigar = ($('#select_karigar').val()!='' && $('#select_karigar').val()!=null ? $('#select_karigar option:selected').text()+' - ' :'');



    var category = ($('#select_category').val()!='' && $('#select_category').val()!=null ? $('#select_category option:selected').text() +' - ' :'');



    var product = ($('#select_product').val()!='' && $('#select_product').val()!=null ? $('#select_product option:selected').text()+' - '  :'');



    var design = ($('#select_design').val()!='' && $('#select_design').val()!=null ? $('#select_design option:selected').text() +' - ' :'');



    var sub_design = ($('#select_sub_design').val()!='' && $('#select_sub_design').val()!=null ? $('#select_sub_design option:selected').text() +' - ' :'');



    var order_for = ($('#select_order_for').val()!='' && $('#select_order_for').val()!=null ? $('#select_order_for option:selected').text() +' - ' :'');



    var optional = karigar  + category  + product + design + sub_design + order_for ;



    var title="<div style='text-align: center;'><b><span style='font-size:15pt;'>"+company_name+"</span></b><b><span style='font-size:12pt;'></span></b></br>"



    +"<span>"+report_print(branch_name,report_name,from_date,to_date,optional)+"</span>";



    $("div.overlay").css("display","block");



	my_Date = new Date();



	$.ajax({



	 url:base_url+ "index.php/admin_ret_purchase/get_pur_order_Details?nocache=" + my_Date.getUTCSeconds(),



	 dataType:"JSON",



	 data:{'from_date':$('#rpt_from_date').html(),'to_date':$('#rpt_to_date').html(),'id_karigar':$('#select_karigar').val(),'date_group_by':$('#date_group_by').val(),'report_type':$('#report_type').val(),'id_product':$('#select_product').val(),'id_design':$('#select_design').val(),'id_sub_design':$('#select_sub_design').val(),'order_for':$('#select_order_for').val()},



	 type:"POST",



	 success:function(data){



	 	var list=data;



		var oTable = $('#order_details_list').DataTable();



		oTable.clear().draw();



		if (list!= null && list.length > 0)



		{



			oTable = $('#order_details_list').dataTable({



            "bDestroy": true,



            "bInfo": true,



            "bFilter": true,



            "bSort": true,



            "order": [[ 0, "desc" ]],



            "dom": 'lBfrtip',



            "columnDefs": [



                {







                    targets: [10],



                    className: 'dt-body-right'



                },



            ],



             "buttons": [



			 {



			   extend: 'print',



			   footer: true,



			   title: '',



			   messageTop: title,



			   	customize: function ( win ) {



				$(win.document.body).find( 'table' )



				.addClass( 'compact' )



				.css( 'font-size', '10px' );



				},



			 },











			 {



				extend:'excel',



				footer: true,



			    title: 'Purchase Order Report',



			  }



			 ],



            "aaData": list,



            "aoColumns": [



            { "mDataProp": function ( row, type, val, meta ){



			    var url = base_url+'index.php/admin_ret_purchase/get_karigar_acknowladgement/'+row.id_customerorder;



				return '<a href='+url+' target="_blank">'+row.pur_no+'</a>';



			},



			},















			{ "mDataProp": function ( row, type, val, meta ){



			    var url = base_url+'index.php/admin_ret_order/customer_order_acknowladgement/'+row.cusOrdid;



				return '<a href='+url+' target="_blank">'+row.cus_ord_ref+'</a>';



			},



			},



            { "mDataProp": "karigar_name" },



            { "mDataProp": "orderdate" },



            { "mDataProp": "due_date" },



            { "mDataProp": function ( row, type, val, meta ){



                return '<span class="badge bg-'+row.color+'">'+row.order_status+'</span>';



			},



			},



            { "mDataProp": "product_name" },



            { "mDataProp": "design_name" },



            { "mDataProp": "sub_design_name" },



            { "mDataProp": "orderpcs" },



            { "mDataProp": "weight" },



            { "mDataProp": "description" },



            { "mDataProp": "weight_description" },







            ],



           /* "footerCallback": function( row, data, start, end, display )



			{



				if(data.length>0){



					var api = this.api(), data;



					for( var i=0; i<=data.length-1;i++){



						var intVal = function ( i ) {



							return typeof i === 'string' ?



							i.replace(/[\$,]/g, '')*1 :



							typeof i === 'number' ?



							i : 0;



						};







						$(api.column(0).footer() ).html('Total');



						orderpcs = api



						.column(9)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(9).footer()).html(parseFloat(orderpcs));







						deliveredpcs = api



						.column(10)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(10).footer()).html(parseFloat(deliveredpcs));







						deliveredweight = api



						.column(11)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(11).footer()).html(parseFloat(deliveredweight));







				}



				}else{



					 var api = this.api(), data;



					 $(api.column(8).footer()).html('');



					 $(api.column(9).footer()).html('');



					 $(api.column(10).footer()).html('');



				}



			} */



            });







		}



		$("div.overlay").css("display", "none");



	  },



	  error:function(error)



	  {



		 $("div.overlay").css("display", "none");



	  }



  });



}



//Purchase Order Status



//Order cancel or close



$('#order_close').on('click',function(){



    $('#order_close').prop('disabled',true);



    var req_data=[];



     if($("input[name='id_customerorder[]']:checked").val())



     {



        var selected = [];



        var approve=false;



        $("#order_list tbody tr").each(function(index, value)



        {



            if($(value).find("input[name='id_customerorder[]']:checked").is(":checked"))



            {



                transData = {



                'id_customerorder'   : $(value).find(".id_customerorder").val(),



                }



                selected.push(transData);



            }



        });



        req_data = selected;



        update_order_close(req_data);



     }else



     {



         $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select The Any One Items."});



         $('#order_delviery').prop('disabled',false);



     }



});



function update_order_close(req_data)



{



    my_Date = new Date();



    $("div.overlay").css("display", "block");



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/update_order_close?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data:  {'req_data':req_data},



        type:"POST",



        async:false,



        dataType:'json',



        success:function(data){



                if(data.status)



                {



                    $('#order_close').prop('disabled',false);



                    $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                    $("div.overlay").css("display", "none");



                    window.location.reload();



                }else



                {



                    $('#order_close').prop('disabled',false);



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                }







        },



        error:function(error)



        {



        $("div.overlay").css("display", "none");



        }



    });



}



$('#order_cancel').on('click',function(){



    $('#order_close').prop('disabled',true);



    var req_data=[];



     if($("input[name='id_customerorder[]']:checked").val())



     {



        var selected = [];



        var approve=false;



        $("#order_list tbody tr").each(function(index, value)



        {



            if($(value).find("input[name='id_customerorder[]']:checked").is(":checked"))



            {



                transData = {



                'id_customerorder'   : $(value).find(".id_customerorder").val(),



                'cus_ord_ref'        : $(value).find(".cus_ord_ref").val(),





                }



                selected.push(transData);



            }



        });



        req_data = selected;



        update_order_cancel(req_data);



     }else



     {



         $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select The Any One Items."});



         $('#order_delviery').prop('disabled',false);



     }



});



function update_order_cancel(req_data)



{



    my_Date = new Date();



    $("div.overlay").css("display", "block");



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/update_order_cancel?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data:  {'req_data':req_data},



        type:"POST",



        async:false,



        dataType:'json',



        success:function(data){



                if(data.status)



                {



                    $('#order_cancel').prop('disabled',false);



                    $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                    $("div.overlay").css("display", "none");



                    window.location.reload();



                }else



                {



                    $('#order_cancel').prop('disabled',false);



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                }







        },



        error:function(error)



        {



        $("div.overlay").css("display", "none");



        }



    });



}



//Order cancel or close



//Purchase Order Delivery



$('#search_pur_order').on('click',function(){



    if($('#select_karigar').val() == null || $('#select_karigar').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Karigar"});



	}



	else if($('#select_pur_ord_no').val() == null || $('#select_pur_ord_no').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select PO REF No"});



	}



	else



	{



	    get_karigar_pending_order_details();



	}



});



function get_karigar_pending_order_details()



{



    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



	 url:base_url+ "index.php/admin_ret_purchase/get_karigar_pending_order_details?nocache=" + my_Date.getUTCSeconds(),



	 dataType:"JSON",



	 data:{'id_customerorder':$('#select_pur_ord_no').val()},



	 type:"POST",



	 success:function(data){



	 	if(data.length>0)



	 	{



	 	    set_order_item_details(data);



	 	}



	 	else



	 	{



	 	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found.."});



	 	}



		$("div.overlay").css("display", "none");



	  },



	  error:function(error)



	  {



		 $("div.overlay").css("display", "none");



	  }



  });



}



function set_order_item_details(data)



{



    $('#item_detail tbody').empty();



    var trHtml='';



    $.each(data,function(key,items){



        trHtml+='<tr>'



                +'<td><input type="checkbox" class="id_orderdetails" name="id_orderdetails[]" value="'+items.id_orderdetails+'"/>'+items.pur_no+'</td>'



                +'<td>'+items.product_name+'</td>'



                +'<td>'+items.design_name+'</td>'



                +'<td>'+items.sub_design_name+'</td>'



                +'<td>'+items.size+'</td>'



                +'<td>'+items.weight_range+'</td>'



                +'<td><input type="hidden" class="form-control tot_delivered_pcs" value="'+items.delivered_pcs+'"><input type="hidden" class="form-control order_pcs" value="'+items.tot_items+'"><input type="hidden" class="form-control id_joborder" value="'+items.id_joborder+'">'+items.tot_items+'</td>'



                +'<td>'+items.delivered_pcs+'</td>'



                +'<td><input type="number" class="form-control delivered_pcs"></td>'



                +'<td><input type="number" class="form-control delivered_wt"></td>'



                +'</tr>';



    });



    if($('#item_detail > tbody  > tr').length>0)



    {



        $('#item_detail > tbody > tr:first').before(trHtml);



    }else{



        $('#item_detail tbody').append(trHtml);



    }



}



$('#order_delviery').on('click',function(){



    $('#order_delviery').prop('disabled',true);



    var req_data=[];



     if($("input[name='id_orderdetails[]']:checked").val())



     {



        var selected = [];



        var approve=false;



        $("#item_detail tbody tr").each(function(index, value)



        {



            if($(value).find("input[name='id_orderdetails[]']:checked").is(":checked"))



            {



                transData = {



                'id_orderdetails'   : $(value).find(".id_orderdetails").val(),



                'tot_delivered_pcs' : $(value).find(".tot_delivered_pcs").val(),



                'delivered_pcs'     : $(value).find(".delivered_pcs").val(),



                'delivered_wt'      : $(value).find(".delivered_wt").val(),



                'order_pcs'         : $(value).find(".order_pcs").val(),



                'id_joborder'       : $(value).find(".id_joborder").val(),



                }



                selected.push(transData);



            }



        });



        req_data = selected;



        update_order_delivery(req_data);



     }else



     {



         $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select The Any One Items."});



         $('#order_delviery').prop('disabled',false);



     }



});



function update_order_delivery(req_data)



{



    my_Date = new Date();



    $("div.overlay").css("display", "block");



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/update_order_delivery?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data:  {'req_data':req_data},



        type:"POST",



        async:false,



        dataType:'json',



        success:function(data){



                if(data.status)



                {



                    $('#order_delviery').prop('disabled',false);



                    $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                    $("div.overlay").css("display", "none");



                    window.location.reload();



                }else



                {



                    $('#order_delviery').prop('disabled',false);



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                }







        },



        error:function(error)



        {



        $("div.overlay").css("display", "none");



        }



    });



}



//Purchase Order Delivery



//Purchase Entry



$('#po_id_approve').on('click', function () {



	if ($("input[name='id_po[]']:checked").val()) {



		$('#po_id_approve').prop('disabled', true);



		var selected = [];



		$("#pur_entry_list tbody tr").each(function (index, value) {



			if ($(value).find("input[name='id_po[]']:checked").is(":checked")) {



				transData = {



					'id_po': $(value).find(".po_id").val(),



				}



                // alert(transData);



				selected.push(transData);



			}



		})



		req_data = selected;



		update_po_approval(req_data);



	}



	else {



		$.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>" + 'Please Select Any one..' });



		$('#po_id_approve').prop('disabled', false);



	}



});



function update_po_approval(req_data){



$.ajax({



    type: 'POST',



    data: {'req_data': req_data},



    url: base_url + "index.php/admin_ret_purchase/update_po_approval",



    dataType: 'JSON',



    success: function(data){



        if (data.status) {



			$.toaster({ priority: 'success', title: 'Warning!', message: '' + "</br>" + data.message });



		} else {



			$.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>" + data.message });



		}



		location.reload();



		$("div.overlay").css("display", "none");



	},



	error: function (error) {



		console.log(error);



		$("div.overlay").css("display", "none");



	}



    });



}







function get_purchase_entry(from_date,to_date)



{



    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



	 url:base_url+ "index.php/admin_ret_purchase/purchase/purchase_entry?nocache=" + my_Date.getUTCSeconds(),



	 dataType:"JSON",



	 type:"POST",



	 data:{'from_date':from_date,'to_date':to_date},



	 success:function(data){



	 	var access=data.access;



	 	var list=data.list;



        var profile = data.profile;



        var currentDate = new Date();



        var formattedCurrentDate =

        currentDate.getDate().toString().padStart(2, '0') + '-' +

        (currentDate.getMonth() + 1).toString().padStart(2, '0') + '-' +

        currentDate.getFullYear();





		var oTable = $('#pur_entry_list').DataTable();



		oTable.clear().draw();



		if (list!= null && list.length > 0)



		{



			oTable = $('#pur_entry_list').dataTable({



            "bDestroy": true,



            "bInfo": true,



            "bFilter": true,



            "bSort": true,



            "ordering": false,



            "dom": 'lBfrtip',



            "buttons" : ['excel','print'],



            "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



            "aaData": list,



            "aoColumns": [



            {



                "mDataProp": function (row, type, val, meta) {



                    if(row.is_approved=="Approved")



					{



                        chekbox =  row.po_id;



                    }



					else



					{



                       if(row.bill_status==1)



					    {



					        chekbox = '<input type="checkbox" class="po_id" name="id_po[]" value="'+ row.po_id +'" />' +'&nbsp;'+ row.po_id;



					    }else{



					        chekbox =  row.po_id;



					    }



                    }



                    return chekbox;



                }



            },



            { "mDataProp": "grn_ref_no" },



            { "mDataProp": "po_date" },



            { "mDataProp": "po_ref_no" },



            { "mDataProp": "karigar" },



            { "mDataProp": "category_name" },



            { "mDataProp": "purity" },



            { "mDataProp": "gross_wt" },



            { "mDataProp": "tot_lwt" },



            { "mDataProp": "tot_nwt" },



            { "mDataProp": "tot_purchase_amt" },



            { "mDataProp": "tot_purchase_wt" },



            { "mDataProp": "grs_wt" },



            { "mDataProp": function ( row, type, val, meta ) {



                action_content= parseFloat(parseFloat(row.grs_wt) - parseFloat(row.tot_purchase_wt)).toFixed(3);



                 return action_content;



                }



            },



            { "mDataProp": "emp_name"},



            //{ "mDataProp": "is_approved" },



            { "mDataProp" : function (row,type,val,meta) {

 

                if(row.bill_status == 2){

                    return 'Cancelled';

                } else {

                    return row.is_approved;

                }

            }



            },



            { "mDataProp": function ( row, type, val, meta ) {



					 id= row.po_id;



					 let print_url= '';



					 edit_url=(access.edit=='1' ? base_url+'index.php/admin_ret_purchase/purchase/purchase_add/'+id : '#' );



					 delete_url=(access.delete=='1' ? '#' : '#' );



					 delete_confirm= (access.delete=='1' ?'#confirm-delete':'');



					  //if(row.purchase_type == 1) {



                        print_url= '<a href="'+base_url+'index.php/admin_ret_purchase/purchase/job_receipt/'+id+'" target="_blank" class="btn btn-info btn-print" data-toggle="tooltip" title="" data-original-title="Customer Copy"><i class="fa fa-print"></i></a>';



                     //}



					 action_content=(row.approved_status==0 && row.bill_status==1 && access.edit=='1' ? '<a href="'+edit_url+'" class="btn btn-primary btn-edit"><i class="fa fa-edit" ></i></a>' :'')+print_url+((row.po_date == formattedCurrentDate || profile.previous_bill_cancel == 1) && row.approved_status==0 && row.bill_status == 1 && access.delete == '1' ? '<button class="btn btn-warning" onclick="po_cancel('+id+')"><i class="fa fa-close" ></i></button>' :'');



					return action_content;



				}



			}



        ],



        "footerCallback": function( row, data, start, end, display )

		{

            if(data.length>0){

                var api = this.api(), data;

                for( var i=0; i<=data.length-1;i++){

                    var intVal = function ( i ) {

                        return typeof i === 'string' ?

                        i.replace(/[\$,]/g, '')*1 :

                        typeof i === 'number' ?

                        i : 0;

                    };



                    $(api.column(0).footer() ).html('Total');



                    gwt = api

                    .column(7)

                    .data()

                    .reduce( function (a, b) {

                        return intVal(a) + intVal(b);

                    }, 0 );

                    $(api.column(7).footer()).html(money_format_india(parseFloat(gwt).toFixed(3)));



                    lwt = api

                    .column(8)

                    .data()

                    .reduce( function (a, b) {

                        return intVal(a) + intVal(b);

                    }, 0 );

                    $(api.column(8).footer()).html(money_format_india(parseFloat(lwt).toFixed(3)));



                    nwt = api

                    .column(9)

                    .data()

                    .reduce( function (a, b) {

                        return intVal(a) + intVal(b);

                    }, 0 );

                    $(api.column(9).footer()).html(money_format_india(parseFloat(nwt).toFixed(3)));



                    pur_amt = api

                    .column(10)

                    .data()

                    .reduce( function (a, b) {

                        return intVal(a) + intVal(b);

                    }, 0 );

                    $(api.column(10).footer()).html(money_format_india(parseFloat(pur_amt).toFixed(2)));



                    pur_wt = api

                    .column(11)

                    .data()

                    .reduce( function (a, b) {

                        return intVal(a) + intVal(b);

                    }, 0 );

                    $(api.column(11).footer()).html(money_format_india(parseFloat(pur_wt).toFixed(3)));



                    grn_wt = api

                    .column(12)

                    .data()

                    .reduce( function (a, b) {

                        return intVal(a) + intVal(b);

                    }, 0 );

                    $(api.column(12).footer()).html(money_format_india(parseFloat(grn_wt).toFixed(3)));



                    diff_wt = api

                    .column(13)

                    .data()

                    .reduce( function (a, b) {

                        return intVal(a) + intVal(b);

                    }, 0 );

                    $(api.column(13).footer()).html(money_format_india(parseFloat(diff_wt).toFixed(3)));







            }



            }else{



                    var api = this.api(), data;



                    $(api.column(13).footer()).html('');



                    $(api.column(11).footer()).html('');



                    $(api.column(12).footer()).html('');



                    $(api.column(6).footer()).html('');



                    $(api.column(7).footer()).html('');



                    $(api.column(8).footer()).html('');



                    $(api.column(9).footer()).html('');



                    $(api.column(10).footer()).html('');



            }

        }



        });







		}



		$("div.overlay").css("display", "none");



	  },



	  error:function(error)



	  {



		 $("div.overlay").css("display", "none");



	  }



  });



}



function po_cancel(po_id)



{



	$('#po_id').val(po_id);



	$('#confirm-delete').modal('show');



}



$('#po_cancel_remark').on('keypress',function(){



	if(this.value.length>6)



	{



		$('#cancel_po').prop('disabled',false);



	}else{



		$('#cancel_po').prop('disabled',true);



	}



});



$('#cancel_po').on('click',function(){



    $('#cancel_po').prop('disabled',true);



	my_Date = new Date();



	$.ajax({



		type: 'POST',



		url:base_url+ "index.php/admin_ret_purchase/purchase/cancel_po_entry?nocache=" + my_Date.getUTCSeconds(),



		dataType:'json',



		data:{'cancel_reason':$('#po_cancel_remark').val(),'po_id':$('#po_id').val()},



		success:function(data){



		    window.location.reload();



		}



	});



});



function get_approval_purchase_entry()



{







    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



	 url:base_url+ "index.php/admin_ret_purchase/approvalstock/ajax_purchase_list?nocache=" + my_Date.getUTCSeconds(),



	 dataType:"JSON",



	 type:"POST",



	 success:function(data){



	 	var access=data.access;



	 	var list=data.list;



		var oTable = $('#approval_entry_list').DataTable();



		oTable.clear().draw();



		if (list!= null && list.length > 0)



		{



			oTable = $('#approval_entry_list').dataTable({



            "bDestroy": true,



            "bInfo": true,



            "bFilter": true,



            "bSort": true,



            "order": [[ 0, "desc" ]],



            "dom": 'lBfrtip',



            "buttons" : ['excel','print'],



            "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



            "aaData": list,



            "aoColumns": [



                { "mDataProp": "po_id" },



                { "mDataProp": "po_type" },



                { "mDataProp": "po_date" },



                { "mDataProp": "po_ref_no" },



                { "mDataProp": "karigar" },



                { "mDataProp": "category_name" },



                { "mDataProp": "purity" },



                { "mDataProp": "gross_wt" },



                { "mDataProp": "tot_lwt" },



                { "mDataProp": "tot_nwt" },



                { "mDataProp": "total_payable_amt" },



                { "mDataProp": "total_payable_wt" },



                { "mDataProp": function ( row, type, val, meta ) {



    					 id = row.po_id



    					 delete_url = (access.delete=='1' ? base_url+'index.php/admin_ret_estimation/estimation/delete/'+id : '#' );



    					 delete_confirm = (access.delete=='1' ?'#confirm-delete':'');



    					 action_content ='<a href="#" class="btn btn-danger btn-del" data-href='+delete_url+' data-toggle="modal" data-target="#confirm-delete" ><i class="fa fa-trash"></i></a>';



    					 return action_content;



    				}







    			}



        ]



            });







		}



		$("div.overlay").css("display", "none");



	  },



	  error:function(error)



	  {



		 $("div.overlay").css("display", "none");



	  }



  });



}



function get_ActiveMetals()



{



    $("div.overlay").css("display", "block");



    $.ajax({



	type: 'GET',



	url: base_url+'index.php/admin_ret_catalog/active_metals',



	dataType:'json',



	success:function(data){



	        metalDetails=data;



	        var id=$('#select_metal').val();



	        $.each(data, function (key, item) {



                $('#select_metal').append(



                $("<option></option>")



                .attr("value", item.id_metal)



                .text(item.metal)



                );



        	});







        	$('#select_metal').select2({



        	    placeholder: "Metal",



        	    allowClear: true



        	});



	        if($('#select_metal').length)



	        {



	            $('#select_metal').select2("val",(id!='' ? id:''));



	        }







	    	$("div.overlay").css("display", "none");



		}



	});



}



$('#select_purity').on('change', function(){



    var selectedpurity = $( "#select_purity option:selected" ).text();



    if(selectedpurity != ""){



        $("#purity").val(selectedpurity);



    }

});



$('#select_metal').on('change',function(){







    if(ctrl_page[1] !='karigarmetalissue' && ctrl_page[1] !='supplier_rate_cut' && ctrl_page[1] !='headoffice_valut_report' && ctrl_page[1]!='smith_cmpy_op_bal' && ctrl_page[1]!='retagging_report')



    {



        $('#select_category option').remove();



        $('#select_purity option').remove();



        $('#select_product option').remove();



        $('#select_design option').remove();



        $('#select_sub_design option').remove();







        $('#select_category').select2("val",'');



        $('#select_purity').select2("val",'');



        $('#select_product').select2("val",'');



        $('#select_design').select2("val",'');



        $('#select_sub_design').select2("val",'');



    }



    else if(ctrl_page[1]=='karigarmetalissue')



    {



        $('#select_category option').remove();



        $('#select_product option').remove();



        set_available_stock_details();



        if(this.value!='')



        {



            get_karigar_SupplierEntrys();



        }







        $('#metal_details > tbody > tr').empty();



    }



    else if(ctrl_page[1]=='smith_cmpy_op_bal' )



        {



            if($("input[type='radio'][name='smth_cmpy_stk[bal_type]']:checked").val()==2){



                get_oldmetalcategory();



            }





        }



    if(ctrl_page[1] == 'supplier_rate_cut' && $("#select_karigar").val() != "")



    {



        get_supplier_pay_details($("#select_karigar").val());



    }







   if(this.value !='' && ctrl_page[1] !='supplier_rate_cut' )



   {



       get_ActiveCategories();



   }



});



function get_active_products()



{



    $.ajax({



	type: 'GET',



	url: base_url+'index.php/admin_ret_catalog/get_ActiveProducts',



	dataType:'json',



	success:function(data){



	    product_list = data;







		}



	});



}



function get_ActiveCategories()



{



    $("div.overlay").css("display", "block");



    $('#select_category option').remove();



    var id_cat_type = ($("input[type='radio'][name='smth_cmpy_stk[bal_type]']:checked").val()!='' ? $("input[type='radio'][name='smth_cmpy_stk[bal_type]']:checked").val() : '');



    $.ajax({



	type: 'POST',



	//data:{'id_metal':$('#select_metal').val(), 'id_cat_type' : $("input[type='radio'][name='order[po_type]']:checked").val()},



	data:{'id_metal':$('#select_metal').val(), 'id_cat_type' : id_cat_type},



	url: base_url+'index.php/admin_ret_catalog/get_MetalCategory',



	dataType:'json',



	success:function(data){



	    category_lists = data;



	    var id=$('#select_category').val();



	    var id_category=$('#id_category').val();



	            if(ctrl_page[1]=='karigarmetalissue')



	            {



	                $.each(data, function (key, item) {



	                    if(item.cat_type==2 || item.cat_type==3 || item.cat_type==4)



	                    {



                            $('#select_category').append(



                            $("<option></option>")



                            .attr("value", item.id_ret_category)



                            .attr("data-cattype", item.cat_type)



                            .text(item.name)



                            );



	                    }



                	});



	            }



	            else



	            {



	                $.each(data, function (key, item) {



                        $('#select_category').append(



                        $("<option></option>")



                        .attr("value", item.id_ret_category)



                        .attr("data-cattype", item.cat_type)



                        .text(item.name)



                        );



                	});



	            }











        	$('#select_category').select2({



        	    placeholder: "Category",



        	    allowClear: true



        	});







        	console.log(id);







	        if($('#select_category').length)



	        {



	            $('#select_category').select2("val",(id_category!='' ? id_category:''));



	        }



	        $("div.overlay").css("display", "none");



		}



	});



}



$('#select_category').on('change',function(){







    if(ctrl_page[2]=='purchase_add')



    {



        $('#select_purity option').remove();



        $('#select_product option').remove();



        $('#select_design option').remove();



        $('#select_sub_design option').remove();







        $('#select_purity').select2("val",'');



        $('#select_product').select2("val",'');



        $('#select_design').select2("val",'');



        $('#select_sub_design').select2("val",'');







       if(this.value!='')



       {



           var purchase_type = $("input[name='order[purchase_type]']:checked").val();



           if(purchase_type==1)



           {



               if($('#select_po_no').val()=='' || $('#select_po_no').val()==null)



               {



                   $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select PO No"});



               }



               else



               {



                   //get_OrderProducts();



                   get_CategoryProducts();



                   get_cat_purity();



               }



           }



           else



           {



               get_CategoryProducts();



               get_cat_purity();



           }







       }



    }



    else if(ctrl_page[1]=='karigarmetalissue')



    {



        $('#select_product option').remove();



         if(this.value!='')



         {



             get_cat_purity();



             get_CategoryProducts();



         }







    }



    else if(ctrl_page[2]=='order_status')



    {



        $('#select_product option').remove();



         if(this.value!='')



         {



             get_CategoryProducts();



         }



    }



    else if(ctrl_page[1]=='supplier_rate_cut' && ctrl_page[2]=='add')



    {



        $('#select_product option').remove();



         if(this.value!='')



         {



             get_CategoryProducts();



         }



    }



    else if(ctrl_page[1]=='smith_cmpy_op_bal' && ctrl_page[2]=='add')



    {



        $('#select_product option').remove();



        if(this.value!='')



        {



            get_CategoryProducts();



            get_cat_purity();



        }



    }



});



function get_charges() {



	my_Date = new Date();



	$.ajax({



		url: base_url+'index.php/admin_ret_catalog/charges/getActiveChargesList/?nocache=' + my_Date.getUTCSeconds(),



		dataType: "json",



		method: "GET",



		success: function ( data ) {



			charges_details = data;



			console.log("charges_details", charges_details);



			charges_list = charges_details;



		}



	 });



}



function get_CategoryProducts()



{



    $('#select_product option').remove();



    $(".overlay").css("display", "block");



    my_Date = new Date();



	$.ajax({



	type: 'POST',



	data:{'id_ret_category':$('#select_category').val()},



	url: base_url+"index.php/admin_ret_catalog/get_ActiveProducts/?nocache=" + my_Date.getUTCSeconds(),



	dataType:'json',



	success:function(data){



	        	    if(ctrl_page[2]=='purchase_add')



                    {



                            var id=$('#pro_id').val();



                    }



                    else



                    {



                           var id=$('#select_product').val();







                    }



        	        $.each(data, function (key, item) {



                        $('#select_product').append(



                        $("<option></option>")



                        .attr("value", item.pro_id)



                        .text(item.product_name)



                         .attr("data-purmode", item.purchase_mode)



                         .attr("data-tax_type", item.tax_type)



                         .attr("data-stone_type", item.stone_type)



                         .attr("data-calculation_based_on", item.calculation_based_on)





                        );



                	});







                	$('#select_product').select2({



                	    placeholder: "Product",



                	    allowClear: true



                	});



        	        if($('#select_product').length)



        	        {



        	            $('#select_product').select2("val",(id!='' ? id:''));



        	        }



        	        $("div.overlay").css("display", "none");



		}



	});



}



function get_OrderProducts()



{



    $('#select_product option').remove();



    $(".overlay").css("display", "block");



    my_Date = new Date();



	$.ajax({



	type: 'POST',



	data:{'id_customerorder':$('#select_po_no').val(),'id_ret_category':$('#select_category').val()},



	url: base_url+"index.php/admin_ret_purchase/get_OrderProducts/?nocache=" + my_Date.getUTCSeconds(),



	dataType:'json',



	success:function(data){



	        	    var id=$('#select_product').val();



        	        $.each(data, function (key, item) {



                        $('#select_product').append(



                        $("<option></option>")



                        .attr("value", item.pro_id)



                        .text(item.product_name)



                        .attr("data-purmode", item.purchase_mode)



                        .attr("data-tax_type", item.tax_type)



                        );



                	});







                	$('#select_product').select2({



                	    placeholder: "Product",



                	    allowClear: true



                	});



        	        if($('#select_product').length)



        	        {



        	            $('#select_product').select2("val",(id!='' ? id:''));



        	        }



        	        $("div.overlay").css("display", "none");



		}



	});



}



function get_OrderProductsDesign()



{



    $('#select_design option').remove();



	$(".overlay").css('display','block');



	$.ajax({



		type: 'POST',



		url: base_url+'index.php/admin_ret_purchase/get_OrderProductsDesign',



		dataType:'json',



		data:{'id_product':$('#select_product').val(),'id_customerorder':$('#select_po_no').val()},



		success:function(data){



            var id =  $('#select_design').val();







            $.each(data, function (key, item) {



                $('#select_design').append(



                $("<option></option>")



                .attr("value", item.design_no)



                .text(item.design_name)



                );



            });







            $("#select_design").select2({



                placeholder: "Design",



                allowClear: true



            });







            $("#select_design").select2("val",(id!='' && id>0?id:''));



            $(".overlay").css("display", "none");



		}



	});



}



$('#select_product').on('change',function(){



    if(this.value!='' && ctrl_page[1]=='purchase')



    {



        $('#select_design option').remove();



        $('#select_sub_design option').remove();



        $('#select_design').select2("val",'');



        $('#select_sub_design').select2("val",'');











             if(ctrl_page[1]=='purchase' && ctrl_page[2]=='add')



               {



                   get_ActiveSize();



                   get_ActiveWeightRange();



                   get_ProductDesign();







               }



               else if(ctrl_page[1]=='purchase' && ctrl_page[2]=='purchase_add')



               {



                   if($('#supplier_bill_entry_calc').val()==1){



                        $('#tot_wastage_perc').val(0);



                        $('#purchase_touch').val(0);



                        $('#mc_value').val(0);



                       set_karigar_wise_wastage();



                   }











                   var purchase_type = $("input[name='order[purchase_type]']:checked").val();



                   if(purchase_type==1)



                   {



                       //get_OrderProductsDesign();



                       get_ProductDesign();



                       if($('#is_cus_repair_order').val() == 1 ){ //If order for repair need to store actual repair wt into hidden order_gwt field



                            $.each(karigar_pending_order_details,function(key,items){



                                if(items.id_customerorder == $("#select_po_no").val()) //Check the condition whether pending order array match with selected order id



                                {



                                    $.each(items.order_details,function(ikey,ival){



                                        if(ival.id_product == $("#select_product").val()){ // If selected product match with created product of order



                                             $("#order_gwt").val(ival.weight);



                                        }



                                    });



                                }



                            });



                       }



                   }



                   else



                   {



                       get_ProductDesign();



                   }







                   if($('#select_product option:selected').attr('data-purmode') == 1){



                       //$("#item_cost").prop('readonly', false);



                       $("#item_cost").prop('disabled', false);



                       $("#tot_gwt").val(0);



                   }else{



                       //$("#item_cost").prop('readonly', true);



                       $("#item_cost").prop('disabled', true);



                   }





                   if($('#select_product option:selected').attr('data-stone_type') == 2)

                   {

                        $("#select_quality").prop('disabled', false);

                   }

                   else

                   {

                        $("#select_quality").prop('disabled', true);

                   }



               }



               else if(ctrl_page[2]=='order_status' && this.value!='')



               {



                    $('#select_design option').remove();



                    $('#select_sub_design option').remove();



                    $('#select_design').select2("val",'');



                    $('#select_sub_design').select2("val",'');



                    get_ProductDesign();



               }



    }



    else if(ctrl_page[1]=='karigarmetalissue' && this.value!='')



    {



        set_availabe_purity();



        $('#select_design option').remove();



        $('#select_sub_design option').remove();



        $('#select_design').select2("val",'');



        $('#select_sub_design').select2("val",'');



        get_ProductDesign();



    }



   else if(ctrl_page[1]=='purchasereturn' && this.value!='')



   {



        $('#select_design option').remove();



        $('#select_sub_design option').remove();



        $('#select_design').select2("val",'');



        $('#select_sub_design').select2("val",'');



        get_ProductDesign();



   }







});



$('#select_section').on('change',function()

{

    if(ctrl_page[1]=='purchasereturn' && this.value!='')

    {

        set_availabe_purity();

    }

})



$('#select_purity').on('change',function()



{







    if(ctrl_page[1]=='purchase' && ctrl_page[2]=='purchase_add')



    {



        if($('#supplier_bill_entry_calc').val()==1){



            $('#tot_wastage_perc').val(0);



            $('#purchase_touch').val(0);



            $('#mc_value').val(0);



            set_karigar_wise_wastage();



        }



    }



})



function set_karigar_wise_wastage()



{



    $('#add_po_order_items').prop("disabled",false);



    if($('#select_karigar').val()!='' && $('#select_karigar').val()!=null && $('#select_product').val()!='' && $('#select_product').val()!=null && $('#select_design').val()!='' && $('#select_design').val()!=null && $('#select_sub_design').val()!='' && $('#select_sub_design').val()!=null)



    {



        var check_yet_toapprove_status = false;



        var check_hold_status = false;



        $.each(karigar_wastage_details.yet_approved_details,function(k,items)



        {



            if((items.id_karikar==$('#select_karigar').val())  && ($('#select_category').val()==items.id_category) && ($('#select_purity').val()==items.id_purity) && ($('#select_product').val()==items.id_product) && ($('#select_sub_design').val()==items.id_sub_design) && ($('#select_design').val()==items.id_design) )



            {



                check_yet_toapprove_status = true;



            }



        });



        $.each(karigar_wastage_details.hold_details,function(k,items)



        {



            if((items.id_karikar==$('#select_karigar').val()) && (($('#select_category').val()==items.id_category) || items.id_category==0) && ($('#select_purity').val()==items.id_purity) && (($('#select_product').val()==items.id_product) || (items.id_product==0)) && (($('#select_sub_design').val()==items.id_sub_design) || (items.id_sub_design==0)) && (($('#select_design').val()==items.id_design) || (items.id_design==0)) )



            {



                check_yet_toapprove_status = true;



                check_hold_status = true;



            }



        });



        if(!check_yet_toapprove_status)



        {



            var approved_items = false;



            $.each(karigar_wastage_details.approved_details,function(key,items)



            {

                var stone_type = $('#select_product option:selected').attr('data-stone_type');



                if((items.id_karikar==$('#select_karigar').val()) && (($('#select_category').val()==items.id_category) || items.id_category==0) && (stone_type==0 ? ($('#select_purity').val()==items.id_purity): $('#select_purity').val('')) && (($('#select_product').val()==items.id_product) || (items.id_product==0)) && (($('#select_sub_design').val()==items.id_sub_design) || (items.id_sub_design==0)) && (($('#select_design').val()==items.id_design) || (items.id_design==0)) )



                {



                    item_charge_details = [];



                    $('#tot_wastage_perc').val(items.wastage_per);



                    $('#purchase_touch').val(items.pur_touch);



                    $('#mc_value').val(items.mc_value);



                    $('#mc_type').val(items.mc_type);



                    $('#calculation_based_on').val(items.calc_type);



                    $('#tot_wastage_wgt').val(items.wastage_wt);



                    $('#wastage_type').val(items.wastage_type);



                    $('#karigar_calc_type').val(items.karigar_calc_type);



                    /*$('#select_purity').select2("val",items.id_purity);



                    $('#id_purity').val(items.id_purity);*/

                    //$('#select_quality').select2("val",items.quality_id);



                    if(items.charges_details.length > 0)



                    {



                        var other_charges_amount = 0;



                        $.each(items.charges_details,function(k,val){



                            other_charges_amount+=parseFloat(val.charge_value);



                            item_charge_details.push({



        						'charge_value'       : val.charge_value,



        						'charge_id'          : val.charge_id,



        						'calc_type'          : val.calc_type,



        						'name_charge'        : '',



        						'char_with_tax'      : 0,



        						'charge_tax'         : 0,



        						'charge_tax_value'   : 0,



        						'total_charge_value' : 0,



        					 });



                        });



                        $('#other_charges_amount').val(parseFloat(other_charges_amount).toFixed(2));



                        $('#other_charges_details').val(JSON.stringify(item_charge_details));



                    }



                    if(stone_type==2) //  for diamond product

                    {

                        var stone_pcs  = (isNaN($('#tot_pcs').val()) || $('#tot_pcs').val() == '')  ? 0 : parseInt($('#tot_pcs').val());

                        var stone_wt  = (isNaN($('#tot_gwt').val()) || $('#tot_gwt').val() == '')  ? 0 : parseFloat($('#tot_gwt').val());

                        var stone_centwt = parseFloat(((stone_wt)/(stone_pcs))*100).toFixed(3);

                        if($('#select_quality').val()== items.quality_id)

                        {

                            if(stone_centwt >= parseFloat(items.from_wt) && stone_centwt <= parseFloat(items.to_wt))

                            {

                                $('#rate_per_gram').val(items.rate_per_gram);

                                $('#rate_calc_type').val(items.stone_cal_type);

                                $('#pur_uom').val(items.uom_id);



                            }

                        }

                        else

                        {

                            $('#rate_per_gram').val(0);

                        }





                    }

                    else if(stone_type==1)

                    {

                        $('#rate_per_gram').val(items.rate_per_gram);

                        $('#rate_calc_type').val(items.stone_cal_type);

                        $('#pur_uom').val(items.uom_id);

                    }



                    approved_items = true;



                }



            });



            if(!approved_items)



            {



                $('#add_po_order_items').prop("disabled",true);



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Add The Supplier Item Details.."});



            }



        }



        else if(check_hold_status)



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>This item is Holded for Approval...Please Contact Your Admin"});



        }



        else



        {



            $('#add_po_order_items').prop("disabled",true);



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>This item is Waiting for Admin Approval..Please Contact Your Admin"});



        }



        calculate_purchase_item_cost();



    }



}



function get_ProductDesign()



{



    $('#select_design option').remove();



	$(".overlay").css('display','block');



	$.ajax({



		type: 'POST',



		url: base_url+'index.php/admin_ret_catalog/get_active_design_products',



		dataType:'json',



		data:{'id_product':($('#select_product').val()!='' && $('#select_product').val()!=undefined ? $('#select_product').val(): $('#product_sel').val() )},



		success:function(data){



            if(ctrl_page[2]=='purchase_add')



            {



            	var id =  $('#design_id').val();



            }



            else



            {



            var id =  $('#select_design,#design_sel').val();



            }







            $.each(data, function (key, item) {



                $('#select_design,#design_sel').append(



                $("<option></option>")



                .attr("value", item.design_no)



                .text(item.design_name)



                );



            });







            $("#select_design,#design_sel").select2({



                placeholder: "Design",



                allowClear: true



            });







            $("#select_design,#design_sel").select2("val",(id!='' && id>0?id:''));



            $(".overlay").css("display", "none");



		}



	});



}



$('#select_design').on('change',function(){







    $('#select_sub_design option').remove();







    $('#select_sub_design').select2("val",'');







   if(this.value!='')



   {



       if(ctrl_page[1]=='purchase' && ctrl_page[2]=='purchase_add')



       {



           if($('#supplier_bill_entry_calc').val()==1){





                $('#tot_wastage_perc').val(0);



                $('#purchase_touch').val(0);



                $('#mc_value').val(0);



               set_karigar_wise_wastage();



           }



           var purchase_type = $("input[name='order[purchase_type]']:checked").val();



           if(purchase_type==1)



           {



               //get_OrderSubDesigns();



               get_ActiveSubDesigns();



           }



           else



           {



               get_ActiveSubDesigns();



           }







       }



       else if(ctrl_page[1]=='purchase' && ctrl_page[2]=='add')



       {



           get_ActiveSubDesigns();



       }



       else if(ctrl_page[1]=='karigarmetalissue' && ctrl_page[2]=='add')



       {



           get_ActiveSubDesigns();



           set_availabe_purity();



       }



       else if(ctrl_page[1]=='purchasereturn' && ctrl_page[2]=='add')



       {



           get_ActiveSubDesigns();



       }



       else if(ctrl_page[2]=='order_status')



       {



           get_ActiveSubDesigns();



       }



   }



});



$('#select_sub_design').on('change',function()



{





    if(this.value!='')



    {



           if(ctrl_page[1]=='purchase' && ctrl_page[2]=='purchase_add')



           {



               if($('#supplier_bill_entry_calc').val()==1){



                    $('#tot_wastage_perc').val(0);



                    $('#purchase_touch').val(0);



                    $('#mc_value').val(0);





                   set_karigar_wise_wastage();



               }



           }else if(ctrl_page[1]=='karigarmetalissue' && ctrl_page[2]=='add')



           {



               set_availabe_purity();



           }



           else if(ctrl_page[1]=='purchasereturn' && ctrl_page[2]=='add')



           {



               set_availabe_purity();



           }



    }



});



function get_OrderSubDesigns()



{



    $('#select_sub_design option').remove();



	$(".overlay").css('display','block');



	$.ajax({



		type: 'POST',



		url: base_url+'index.php/admin_ret_purchase/get_OrderSubDesigns',



		dataType:'json',



		data:{'id_product':$('#select_product').val(),'design_no':$('#select_design').val(),'id_customerorder':$('#select_po_no').val()},



		success:function(data){



            var id =  $('#select_sub_design').val();







            $.each(data, function (key, item) {



                $('#select_sub_design').append(



                $("<option></option>")



                .attr("value", item.id_sub_design)



                .text(item.sub_design_name)



                );



            });







            $("#select_sub_design").select2({



                placeholder: "Sub Design",



                allowClear: true



            });







            $("#select_sub_design").select2("val",(id!='' && id>0?id:''));



            $(".overlay").css("display", "none");



		}



	});



}



function get_ActiveSubDesigns()



{



    $('#select_sub_design option').remove();



	$(".overlay").css('display','block');



	$.ajax({



		type: 'POST',



		url: base_url+'index.php/admin_ret_catalog/get_ActiveSubDesigns',



		dataType:'json',



		data:{'id_product':($('#select_product').val()!='' && $('#select_product').val()!=undefined ? $('#select_product').val() : $('#product_sel').val() ),'design_no':($('#select_design').val()!='' && $('#select_design').val()!=undefined ? $('#select_design').val(): $('#design_sel').val())},



		success:function(data){



            if(ctrl_page[2]=='purchase_add')



            {



            	var id =  $('#sub_design_id').val();



            }



            else



            {



            	var id =  $('#select_sub_design,#sub_design_sel').val();



            }







            $.each(data, function (key, item) {



                $('#select_sub_design,#sub_design_sel').append(



                $("<option></option>")



                .attr("value", item.id_sub_design)



                .text(item.sub_design_name)



                );



            });







            $("#select_sub_design,#sub_design_sel").select2({



                placeholder: "Sub Design",



                allowClear: true



            });







            $("#select_sub_design,#sub_design_sel").select2("val",(id!='' && id>0?id:''));



            $(".overlay").css("display", "none");



		}



	});



}



function get_cat_purity()



{



    $('#select_purity option').remove();



	$(".overlay").css('display','block');



	$.ajax({



		type: 'POST',



		url: base_url+'index.php/admin_ret_catalog/category/cat_purity',



		dataType:'json',



		data:{'id_category':$('#select_category').val()},



		success:function(data){



            var id_purity =  $('#id_purity').val();







            $.each(data, function (key, item) {



                $('#select_purity').append(



                $("<option></option>")



                .attr("value", item.id_purity)



                .text(item.purity)



                );



            });







            $("#select_purity").select2({



                placeholder: "Purity",



                allowClear: true



            });







            if($("#select_purity").length)



            {



                $("#select_purity").select2("val",(id_purity!='' && id_purity>0?id_purity:''));



            }







            $(".overlay").css("display", "none");



		}



	});



}



$("#purchase_order_no").on("keyup",function(e){



	var orderno = $("#purchase_order_no").val();



	if(orderno != "") {



		get_purchase_orderno(orderno);



    }



});



$('#tot_gwt,#tot_wastage_perc,#rate_per_gram,#tot_pcs,#tot_wastage_perc,#mc_value,#purchase_touch').on('keyup',function(){



    var stone_type = $('#select_product option:selected').attr('data-stone_type');

    if(stone_type==2) // for diamond product

    {

        set_karigar_wise_wastage();

    }



    var tot_gwt=(isNaN($('#tot_gwt').val()) || $('#tot_gwt').val()=='' ? 0:$('#tot_gwt').val());



    var tot_lwt=(isNaN($('#tot_lwt').val()) || $('#tot_lwt').val()=='' ? 0:$('#tot_lwt').val());



    var other_metal_wt = (isNaN($('#other_metal_wt').val()) || $('#other_metal_wt').val()=='' ? 0:$('#other_metal_wt').val());



    $('#tot_nwt').val(parseFloat(tot_gwt-tot_lwt).toFixed(3));







    var tot_netwt = parseFloat(tot_gwt-(tot_lwt + other_metal_wt)).toFixed(3);



    //var purity = parseFloat($("#select_purity option:selected").text());



    var purity = (isNaN($('#purchase_touch').val()) || $('#purchase_touch').val()=='' ? 0:$('#purchase_touch').val());



    var wastage = (isNaN($('#tot_wastage_perc').val()) || $('#tot_wastage_perc').val()=='' ? 0:$('#tot_wastage_perc').val());







    var purewt = parseFloat((parseFloat(tot_netwt) * (parseFloat(purity) + parseFloat(wastage))) / 100).toFixed(3);







    $('#tot_purewt').val(format(purewt).replace(/,/g, ''));







    calculate_purchase_item_cost();



});



$('#ratecaltype,#mc_type,#karigar_calc_type').on('change',function(){



    calculate_purchase_item_cost();



});



$('#select_quality').on('change',function()

{

    if($('#supplier_bill_entry_calc').val()==1){



        set_karigar_wise_wastage();



    }

})



$('.is_rate_fixed').on('change',function(){



    if($('.is_rate_fixed:checked').val()==1)



    {



        //$('#rate_per_gram').prop('readonly',false);



    }else{



        //$('#rate_per_gram').prop('readonly',true);



    }



});



$("#add_po_order_items").on('click',function(e){



    //var pur_order_type = $("input[type='radio'][name='order[po_type]']:checked").val();







    var pur_order_type = $('#select_category option:selected').attr('data-cattype');







    console.log('pur_order_type:'+pur_order_type);







    var purchase_type = $("input[name='order[purchase_type]']:checked").val();







    if($('#select_grn').val()=='' || $('#select_grn').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select GRN No.."});



    }



    else if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Karigar"});



    }



    else if($('#select_category').val()=='' || $('#select_category').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Category"});



    }



    else if($('#select_purity').val()=='' || $('#select_purity').val()==null && $('#select_product option:selected').attr('data-stone_type') == 0)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Purity"});



    }



    else if($('#select_product').val()=='' || $('#select_product').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Product"});



    }



    /*else if(($('#select_design').val()=='' || $('#select_design').val()==null))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Design"});



    }



    else if(($('#select_sub_design').val()=='' || $('#select_sub_design').val()==null))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Sub Design"});



    }*/



    else if($('#tot_pcs').val()=='' || $('#tot_pcs').val()==0)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter The Pcs"});



    }



    else if($('#tot_gwt').val()=='' || $('#tot_gwt').val()==0 && $('#select_product option:selected').attr('data-purmode') == 2 && $('#select_product option:selected').attr('data-calculation_based_on') != 3)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter The Weight"});



    }



   else if($('#purchase_touch').val()=='' || $('#purchase_touch').val()==0 && $('#select_product option:selected').attr('data-purmode') == 2 && $('#select_product option:selected').attr('data-stone_type') == 0)

    {

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter The Purchase Touch"});

    }

    else if($('#rate_per_gram').val()=='' && $('#select_product option:selected').attr('data-purmode') == 2 && $('#select_product option:selected').attr('data-stone_type') == 0)

    {

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter The Purchase Rate"});

    }

    else if($('#karigar_calc_type').val()=='' || $('#karigar_calc_type').val()==null)

    {

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select The Purchase Type"});

    }



    else



    {



        set_po_order_item_preview('');



    }







});



function set_po_order_item_preview(issued_data=[])



{



    console.log('issued_data',issued_data);







        var is_halmerked = $("input[type='radio'][name='is_halmerked']:checked").val();



        var is_rate_fixed = $("input[type='radio'][name='is_rate_fixed']:checked").val();



        //var pur_order_type = $("input[type='radio'][name='order[po_type]']:checked").val();







        var pur_order_type = $('#select_category option:selected').attr('data-cattype');







        var purmode = $('#select_product option:selected').attr('data-purmode');







        var is_cus_repair_order=$('#is_cus_repair_order').val();



        var cus_repair_amt = 0;







        var po_item_id = $('#po_id').val()!='' ? $('#po_item_id').val() : '';







        if(is_cus_repair_order == 1){



            cus_repair_amt = $("#cus_repair_amt").val();



        }







        var tot_pcs=0;



        var tot_gwt=0;



        var tot_lwt=0;



        var tot_nwt=0;



        var cal_type = 1;



        var gwt_uom = $('#pur_uom').val();







        tot_pcs = $("#tot_pcs").val();



        tot_gwt = $("#tot_gwt").val();



        tot_lwt = $("#tot_lwt").val();



        tot_nwt = $("#tot_nwt").val();











        var stn_details = $('#stone_details').val();



        var dia_weight = 0;



        if(stn_details!='')



        {



            stone_details = JSON.parse(stn_details);



            $.each(stone_details,function(key,val){



                $.each(uom_details,function(key,item){



                    if(val.stones_type==1) // For Diamond Stone



                    {



                        if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                        {



                            dia_weight+=parseFloat(parseFloat(val.stone_wt)/parseFloat(item.divided_by_value));



                        }



                    }



                });



            });



        }



        var trHtml = '';



        if(issued_data.length>0)



        {



            var pure_wt = 0;



            var rowExists = false;



            $.each(issued_data,function(key,item)



            {



                $('#item_detail > tbody tr').each(function(bidx, brow)



                {



                    curRow = $(this);



                    if(curRow.find('.issue_met_id').val()==item.issue_met_id)



                    {



                        rowExists=true;



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                    }



                });







                pure_wt = parseFloat((parseFloat(item.weight) * (parseFloat(item.purity))) / 100).toFixed(3);



                if(!rowExists)



                {



                    trHtml='<tr>'



                        +'<td><input type="hidden" class="po_item_id" name="order_item[po_item_id][]" value='+po_item_id+'><input type="hidden" class="id_category" name="order_item[id_category][]" value="'+item.cat_id+'"><input type="hidden" class="id_order_no" name="order_item[po_order_no][]" value=""><input type="hidden" class="pure_wt_calc_type" name="order_item[pure_wt_calc_type][]" value=""><input type="hidden" class="issue_met_id" name="order_item[issue_met_id][]" value="'+item.issue_met_id+'"><input type="hidden" class="cat_name" value="'+item.cat_name+'">'+item.cat_name+'</td>'







                        +'<td><input type="hidden" class="id_product" name="order_item[id_product][]" value="'+item.id_product+'">'+item.product_name+'<input type="hidden" class="product_name" value='+item.product_name+'><input type="hidden" name="order_item[po_purchase_mode][]" value='+item.pur_mode+'></td>'







                        +'<td><input type="hidden" class="id_design" name="order_item[id_design][]" value="'+item.id_design+'">'+item.design_name+'<input type="hidden" class="design_name" value="'+item.design_name+'"></td>'







                        +'<td><input type="hidden" class="id_sub_design" name="order_item[id_sub_design][]" value="'+item.id_sub_design+'">'+item.sub_design_name+'<input type="hidden" class="sub_design_name" value="'+item.sub_design_name+'"></td>'







                        +'<td><input type="hidden" class="id_purity" name="order_item[id_purity][]" value="'+item.id_purity+'">'+item.purity+'<input type="hidden" class="purity" value="'+item.purity+'"></td>'







                        +'<td style="text-align:right;"><input type="hidden" class="tot_pcs" name="order_item[tot_pcs][]" value="'+item.pcs+'">'+item.pcs+'<input type="hidden" class="act_tot_pcs" value="'+item.act_iss_pcs+'"><input type="hidden" class="act_tot_wt" value="'+item.act_iss_wt+'"></td>'







                        +'<td style="text-align:right;"><input type="hidden" class="tot_gwt" name="order_item[tot_gwt][]" value="'+item.weight+'"><input type="hidden" class="cal_type" name="order_item[cal_type][]" value="'+cal_type+'"><input type="hidden" class="gwt_uom" name="order_item[gwt_uom][]" value="'+item.uom_id+'"><span style="text-align:right;">'+money_format_india(item.weight)+'</span></td>'







                        +'<td style="text-align:right;"><input type="hidden" class="tot_lwt" name="order_item[tot_lwt][]" value="0"><span style="text-align:right;">'+money_format_india(0.00)+'</span></td>'







                        +'<td style="text-align:right;"><input type="hidden" class="tot_nwt" name="order_item[tot_nwt][]" value="'+item.weight+'"><span style="text-align:right;">'+money_format_india(item.weight)+'</span></td>'







                        +'<td style="text-align:right;"><input type="hidden" class="total_diawt" value="'+parseFloat(dia_weight).toFixed(3)+'"><span style="text-align:right;">'+money_format_india(parseFloat(dia_weight).toFixed(3))+'</span></td>'







                        +'<td style="text-align:right;"><input type="hidden" class="tot_purewt" name="order_item[tot_purewt][]" value="'+pure_wt+'"><span style="text-align:right;">'+money_format_india(pure_wt)+'</span></td>'







                        +'<td style="text-align:right;">0</td>'







                        +'<td style="text-align:right;"><input type="hidden" class="purchase_touch" name="order_item[purchase_touch][]" value=""><input type="hidden" name="order_item[calculation_based_on][]" value=""><input type="hidden" class="tot_wastage_perc" name="order_item[tot_wastage_perc][]" value=""><span style="text-align:right;"></span></td>'







                        +'<td style="text-align:right;"><input type="hidden" class="mc_value" name="order_item[mc_value][]" value=""><input type="hidden" class="mc_type" name="order_item[mc_type][]" value=""></span></td>'







                        +'<td style="text-align:right;"><input type="hidden" class="cus_repair_amt" name="order_item[cus_repair_amt][]" value=""><input type="hidden" class="stone_price" name="order_item[stone_price][]" value=""><input type="hidden" class="stone_details" name="order_item[stone_details][]" value=""></td>'







                        +'<td style="text-align:right;">'+money_format_india($('#other_metal_amount').val())+'<input type="hidden" class="other_metal_amt" value='+$('#other_metal_amount').val()+'><input type="hidden" class="other_metal_details" name="order_item[other_metal_details][]" value='+$('#other_metal_details').val()+'></td>'







                        +'<td style="text-align:right;">'+money_format_india($('#other_charges_amount').val())+'<input type="hidden" class="other_charges_amount" value='+$('#other_charges_amount').val()+'><input type="hidden" class="other_chrg_details" name="order_item[other_chrg_details][]" value='+$('#other_charges_details').val()+'></td>'







                        +'<td style="text-align:right;"><input type="hidden" class="item_remarks" name="order_item[item_remarks][]" value="'+$("#item_remarks").val()+'"><input type="hidden" class="total_payable_amt" name="order_item[total_payable_amt]" value="0"><input type="hidden" class="cgst_cost" name="order_item[cgst_cost][]" value="0.00"><input type="hidden" class="sgst_cost" name="order_item[sgst_cost][]" value="0"><input type="hidden" class="igst_cost" name="order_item[igst_cost][]" value="0.00"><input type="hidden" class="tax_group" name="order_item[tax_group][]" value=""><input type="hidden" class="tax_percentage" name="order_item[tax_percentage][]" value=""><input type="hidden" class="total_tax_rate" name="order_item[total_tax_rate][]" value=""><input type="hidden" class="tax_type" name="order_item[tax_type][]" value=""><input type="hidden" class="ratecaltype" name="order_item[ratecaltype][]" value="'+purmode+'"><input type="hidden" class="rate_per_gram" name="order_item[rate_per_gram][]" value="0"><input type="hidden" name="order_item[item_cost][]" value="0"><input type="hidden" name="order_item[is_halmerked][]" value="'+is_halmerked+'"><input type="hidden" name="order_item[is_rate_fixed][]" value="'+is_rate_fixed+'">'+money_format_india(0.00)+'</td>'







                        +'<td><input type="hidden" class="remark" name="order_item[remark][]" value="'+$('#remark').val()+'"><span><a href="#" onclick="remove_po_entry_row($(this).closest(\'tr\'));" class="btn-del label label-danger" style="padding:5px;" data-toggle="tooltip" title="Delete!"><i class="fa fa-trash"></i></a></span><span><a href="#" onclick="edit_po_entry_row_metal_issue($(this).closest(\'tr\'));" class="btn-del label label-success" style="padding:5px;" data-toggle="tooltip" title="Edit!"><i class="fa fa-edit"></i></a></span></td>'







                    '</tr>';



                $('#item_detail tbody').append(trHtml);



                }



            });



        }



        else



        {



            trHtml='<tr>'



                +'<td><input type="hidden" class="po_item_id" name="order_item[po_item_id][]" value='+po_item_id+'><input type="hidden" class="id_category" name="order_item[id_category][]" value="'+$('#select_category').val()+'"><input type="hidden" class="id_order_no" name="order_item[po_order_no][]" value="'+$('#select_po_no').val()+'"><input type="hidden" class="pure_wt_calc_type" name="order_item[pure_wt_calc_type][]" value="'+$('#karigar_calc_type').val()+'">'+$("#select_category option:selected").text()+'</td>'



                +'<td><input type="hidden" class="id_product" name="order_item[id_product][]" value="'+$('#select_product').val()+'">'+$("#select_product option:selected").text()+'<input type="hidden" name="order_item[po_purchase_mode][]" value='+purmode+'><input type="hidden" class="quality_id" name="order_item[quality_id][]" value='+$('#select_quality').val()+'></td>'



                +'<td><input type="hidden" class="id_design" name="order_item[id_design][]" value="'+$('#select_design').val()+'">'+$("#select_design option:selected").text()+'</td>'



                +'<td><input type="hidden" class="id_sub_design" name="order_item[id_sub_design][]" value="'+$('#select_sub_design').val()+'">'+$("#select_sub_design option:selected").text()+'</td>'



                +'<td><input type="hidden" class="id_purity" name="order_item[id_purity][]" value="'+$('#select_purity').val()+'">'+$("#select_purity option:selected").text()+'</td>'



                +'<td style="text-align:right;"><input type="hidden" class="tot_pcs" name="order_item[tot_pcs][]" value="'+tot_pcs+'">'+tot_pcs+'</td>'



                +'<td style="text-align:right;"><input type="hidden" class="tot_gwt" name="order_item[tot_gwt][]" value="'+tot_gwt+'"><input type="hidden" class="cal_type" name="order_item[cal_type][]" value="'+cal_type+'"><input type="hidden" class="gwt_uom" name="order_item[gwt_uom][]" value="'+gwt_uom+'"><span style="text-align:right;">'+money_format_india(tot_gwt)+'</span></td>'



                +'<td style="text-align:right;"><input type="hidden" class="tot_lwt" name="order_item[tot_lwt][]" value="'+tot_lwt+'"><span style="text-align:right;">'+money_format_india(tot_lwt)+'</span></td>'



                +'<td style="text-align:right;"><input type="hidden" class="tot_nwt" name="order_item[tot_nwt][]" value="'+tot_nwt+'"><span style="text-align:right;">'+money_format_india(tot_nwt)+'</span></td>'



                +'<td style="text-align:right;"><input type="hidden" class="total_diawt" value="'+parseFloat(dia_weight).toFixed(3)+'"><span style="text-align:right;">'+money_format_india(parseFloat(dia_weight).toFixed(3))+'</span></td>'



                +'<td style="text-align:right;"><input type="hidden" class="tot_purewt" name="order_item[tot_purewt][]" value="'+$('#tot_purewt').val()+'"><span style="text-align:right;">'+money_format_india($('#tot_purewt').val())+'</span></td>'



                +'<td style="text-align:right;">'+$('#tot_wastage_perc').val()+'</td>'



                +'<td style="text-align:right;"><input type="hidden" class="purchase_touch" name="order_item[purchase_touch][]" value="'+$('#purchase_touch').val()+'"><input type="hidden" name="order_item[calculation_based_on][]" value="'+$('#calculation_based_on').val()+'"><input type="hidden" class="tot_wastage_perc" name="order_item[tot_wastage_perc][]" value="'+$('#tot_wastage_perc').val()+'"><span style="text-align:right;">'+$("#tot_wastage_perc").val()+'</span></td>'



                +'<td style="text-align:right;"><input type="hidden" class="mc_value" name="order_item[mc_value][]" value="'+$('#mc_value').val()+'"><input type="hidden" class="mc_type" name="order_item[mc_type][]" value="'+$('#mc_type').val()+'">'+$("#mc_value").val()+'-'+$("#mc_type option:selected").text()+'</span></td>'



                +'<td style="text-align:right;"><input type="hidden" class="cus_repair_amt" name="order_item[cus_repair_amt][]" value="'+$('#cus_repair_amt').val()+'"><input type="hidden" class="stone_price" name="order_item[stone_price][]" value="'+$('#stone_price').val()+'">'+$('#stone_price').val()+'<input type="hidden" class="stone_details" name="order_item[stone_details][]" value=\''+$('#stone_details').val()+'\'></td>'



                +'<td style="text-align:right;">'+money_format_india($('#other_metal_amount').val())+'<input type="hidden" class="other_metal_amt" value='+$('#other_metal_amount').val()+'><input type="hidden" class="other_metal_details" name="order_item[other_metal_details][]" value='+$('#other_metal_details').val()+'></td>'



                +'<td style="text-align:right;">'+money_format_india($('#other_charges_amount').val())+'<input type="hidden" class="other_charges_amount" value='+$('#other_charges_amount').val()+'><input type="hidden" class="other_chrg_details" name="order_item[other_chrg_details][]" value='+$('#other_charges_details').val()+'></td>'



                +'<td style="text-align:right;"><input type="hidden" class="item_remarks" name="order_item[item_remarks][]" value="'+$("#item_remarks").val()+'"><input type="hidden" class="total_payable_amt" name="order_item[total_payable_amt]" value="'+$("#item_cost").val()+'"><input type="hidden" class="cgst_cost" name="order_item[cgst_cost][]" value="'+$('#item_cgst_cost').val()+'"><input type="hidden" class="sgst_cost" name="order_item[sgst_cost][]" value="'+$('#item_sgst_cost').val()+'"><input type="hidden" class="igst_cost" name="order_item[igst_cost][]" value="'+$('#item_igst_cost').val()+'"><input type="hidden" class="tax_group" name="order_item[tax_group][]" value="'+$('#tax_group_id').val()+'"><input type="hidden" class="tax_percentage" name="order_item[tax_percentage][]" value="'+$('#item_tax_percentage').val()+'"><input type="hidden" class="total_tax_rate" name="order_item[total_tax_rate][]" value="'+$('#item_total_tax').val()+'"><input type="hidden" class="tax_type" name="order_item[tax_type][]" value="'+$('#tax_type').val()+'"><input type="hidden" class="ratecaltype" name="order_item[ratecaltype][]" value="'+purmode+'"><input type="hidden" class="rate_per_gram" name="order_item[rate_per_gram][]" value="'+$('#rate_per_gram').val()+'"><input type="hidden" class="rate_calc_type" name="order_item[rate_calc_type][]" value='+$('#rate_calc_type').val()+'><input type="hidden" name="order_item[item_cost][]" value="'+$('#item_cost').val()+'"><input type="hidden" name="order_item[is_halmerked][]" value="'+is_halmerked+'"><input type="hidden" name="order_item[is_rate_fixed][]" value="'+is_rate_fixed+'">'+money_format_india($("#item_cost").val())+'</td>'



                +'<td><input type="hidden" class="remark" name="order_item[remark][]" value="'+$('#remark').val()+'"><span><a href="#" onclick="remove_po_entry_row($(this).closest(\'tr\'));" class="btn-del label label-danger" style="padding:5px;" data-toggle="tooltip" title="Delete!"><i class="fa fa-trash"></i></a></span><span><a href="#" onclick="edit_po_entry_row($(this).closest(\'tr\'));" class="btn-del label label-success" style="padding:5px;" data-toggle="tooltip" title="Edit!"><i class="fa fa-edit"></i></a></span></td>'



            '</tr>';



            if($('#item_detail > tbody  > tr').length>0)



            {



                $('#item_detail > tbody > tr:first').before(trHtml);



            }else{



                $('#item_detail tbody').append(trHtml);



            }



            reset_order_entry_form();



        }



        $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>Item Added Successfully."});



    //calculate_total_total_purchase_order_items();



    calculate_purchase_order_item_total();



    calculate_purchase_item_details();



}



    function calculate_purchase_item_details()



    {



        var total_grn_pcs=0;



        var total_grn_gwt=0;



        var total_grn_lwt=0;



        var total_grn_nwt=0;



        var total_grn_diawt=0;



        var total_grn_rate=0;



        var total_grn_amount=0;



        var trHtml='';







        $('#grn_item_details_preview > tbody >tr').each(function(index, tr) {



            total_grn_pcs+=parseFloat($(this).find('.grn_pcs').html());



            total_grn_gwt+=parseFloat($(this).find('.grn_gwt').html());



            total_grn_rate+=parseFloat($(this).find('.grn_rate').html());



            total_grn_amount+=parseFloat($(this).find('.grn_amt').html());



            total_grn_lwt+=parseFloat($(this).find('.grn_lwt').html());



            total_grn_nwt+=parseFloat($(this).find('.grn_nwt').html());



            total_grn_diawt+=parseFloat($(this).find('.grn_diawt').html());



        });







        $('.total_gt_pcs').html(total_grn_pcs);



        $('.total_gt_gwt').html(parseFloat(total_grn_gwt).toFixed(3));



        $('.total_gt_lwt').html(parseFloat(total_grn_lwt).toFixed(3));



        $('.total_gt_nwt').html(parseFloat(total_grn_nwt).toFixed(3));



        $('.total_gt_diawt').html(parseFloat(total_grn_diawt).toFixed(3));



        $('.total_gt_rate').html(parseFloat(total_grn_rate).toFixed(2));



        $('.total_gt_amount').html(parseFloat(total_grn_amount).toFixed(2));







        var total_pcs = $('.total_gt_pcs').html()- parseFloat($('.total_pcs').html());



        var total_gwt = $('.total_gt_gwt').html()-parseFloat($('.total_gwt').html());



        var total_lwt = $('.total_gt_lwt').html()-parseFloat($('.total_lwt').html());



        var total_nwt = $('.total_gt_nwt').html()- parseFloat($('.total_nwt').html());



        var total_gdiawt =  $('.total_gt_diawt').html()- parseFloat($('.tot_diawt').html());



        // alert(total_gdiawt);



        // var dia = $('.total_diawt').val();



        // alert(dia);



         $('.total_gb_pcs').html(total_pcs);



         $('.total_gb_gwt').html(parseFloat(total_gwt).toFixed(3));



         $('.total_gb_lwt').html(parseFloat(total_lwt).toFixed(3));



         $('.total_gb_nwt').html(parseFloat(total_nwt).toFixed(3));



         $('.total_gb_diawt').html(parseFloat(total_gdiawt).toFixed(3));







    }



function calculate_inclusiveGST(taxcallrate, taxgroup){



	var totaltax = 0;



	var tax_percentage = 0;



	var return_details = [];



	$.each(tax_details, function(idx, taxitem){



		if(taxitem.tgi_tgrpcode == taxgroup){



		    tax_percentage = taxitem.tax_percentage;



		//	Remove GST = 490*100/(100+3) = 475.7281553398058



        //	GST 3% = 490 - 475.7281553398058 = 14.2718446601942



			amt_without_gst = (parseFloat(taxcallrate)*100)/(100+parseFloat(taxitem.tax_percentage));



			totaltax += parseFloat(taxcallrate)	- parseFloat(amt_without_gst);



		}



	});



	return_details['totaltax'] = parseFloat(totaltax).toFixed(2);



	return_details['tax_percentage'] = tax_percentage;



	return return_details;



}



function remove_po_entry_row(curRow)



{



    let po_item_id = curRow.find('.po_item_id').val();

    if(po_item_id){

        if (confirm('Are you sure you want to delete this item..?') == true) {

            $("div.overlay").css("display", "block");

            $.ajax({

				type: 'POST',

				url: base_url+'index.php/admin_ret_purchase/delete_supplier_entry_item',

				data:{po_item_id},

				dataType:'json',

				success:function(data){

    					if(data.status == true)

    					{

							$.toaster({ priority : 'success', title : 'Success!', message : ''+"</br> Item Deleted SuccessFully..."});

                            curRow.remove();

                            calculate_purchase_order_item_total();

    					    $("div.overlay").css("display", "none");

    					}

    					else

    					{

							$.toaster({ priority : 'warning', title : 'Success!', message : ''+"</br> Unable to Deleted Item"});

    					    $("div.overlay").css("display", "none");

    					}

    		        },

    		        error:function(error)

    		        {

    		            $("div.overlay").css("display", "none");

    		        }

    		    });

                

        }



    }else{

        curRow.remove();

    }



    calculate_purchase_order_item_total();





}



function edit_po_entry_row(curRow)



{



    $('#select_category').select2("val", curRow.find('.id_category').val());



    $('#id_purity').val(curRow.find('.id_purity').val());



    $('#pro_id').val(curRow.find('.id_product').val());



    $('#purchase_mode').val(curRow.find('.ratecaltype').val());



    $('#design_id').val(curRow.find('.id_design').val());



    $('#sub_design_id').val(curRow.find('.id_sub_design').val());



    $('#tot_pcs').val(curRow.find('.tot_pcs').val());







    $('#tot_gwt').val(curRow.find('.tot_gwt').val());



    $('#tot_lwt').val(curRow.find('.tot_lwt').val());



    $('#tot_nwt').val(curRow.find('.tot_nwt').val());



    $('#tot_purewt').val(curRow.find('.tot_purewt').val());







    $('#stone_details').val(curRow.find('.stone_details').val());







    $('#mc_type').val(curRow.find('.mc_type').val());







    $('#mc_value').val(curRow.find('.mc_value').val());



    $('#other_metal_amount').val(curRow.find('.other_metal_amt').val());



    $('#other_metal_details').val(curRow.find('.other_metal_details').val());







    $('#rate_per_gram').val(curRow.find('.rate_per_gram').val());



    $('#total_payable_amt').val(curRow.find('.item_cost').val());



    $('#po_item_id').val(curRow.find('.po_item_id').val());



    $('#stone_price').val(curRow.find('.stone_price').val());



    $('#other_charges_amount').val(curRow.find('.other_charges_amount').val());



    $('#other_charges_details').val(curRow.find('.other_chrg_details').val());



    $('#tot_wastage_perc').val(curRow.find('.tot_wastage_perc').val());





    $('#item_remarks').val(curRow.find('.item_remarks').val());



    modalStoneDetail = ($('#stone_details').val()!='' ? JSON.parse($('#stone_details').val()) : '');



    modalOthermetal = ($('#other_metal_details').val()!='' ? JSON.parse($('#other_metal_details').val()) : '');



    curRow.remove();







    calculate_purchase_order_item_total();



    setTimeout(function(){calculate_purchase_item_cost()},3000);





}



function calculate_purchase_order_item_total()



{



    var total_pcs=0;



    var total_wt=0;



    var total_lwt=0;



    var total_nwt=0;



    var other_metal_amt=0;



    var total_payable_amt=0;



    var tot_purewt=0;



    var total_item_cost=0;



    var total_cgst_cost=0;



    var total_sgst_cost=0;



    var total_igst_cost=0;



    var total_diawt=0;



    var tot_stone_price=0;



    var other_charges_amount=0;



     $('#item_detail > tbody tr').each(function(idx, idx){



         row = $(this);



        total_pcs+=parseFloat((row.find('.tot_pcs').val()!='' ? row.find('.tot_pcs').val():0));



        total_wt+=parseFloat((row.find('.tot_gwt').val()!='' ? row.find('.tot_gwt').val():0));



        total_lwt+=parseFloat((row.find('.tot_lwt').val()!='' ? row.find('.tot_lwt').val():0));



        total_nwt+=parseFloat((row.find('.tot_nwt').val()!='' ? row.find('.tot_nwt').val():0));



        total_payable_amt+=parseFloat(row.find('.total_payable_amt').val()-row.find('.total_tax_rate').val());



        total_item_cost+=parseFloat(row.find('.total_payable_amt').val());



        other_metal_amt+=parseFloat((row.find('.other_metal_amt').val()!='' ? row.find('.other_metal_amt').val():0));



        tot_stone_price+=parseFloat((row.find('.stone_price').val()!='' ? row.find('.stone_price').val():0));



        tot_purewt+=parseFloat(row.find('.tot_purewt').val());



        total_cgst_cost+=parseFloat(row.find('.cgst_cost').val());



        total_sgst_cost+=parseFloat(row.find('.sgst_cost').val());



        total_igst_cost+=parseFloat(row.find('.igst_cost').val());



        total_diawt+=(row.find('.total_diawt').val()!='' ? parseFloat(row.find('.total_diawt').val()):0);



        other_charges_amount+=(row.find('.other_charges_amount').val()!='' ?parseFloat(row.find('.other_charges_amount').val()) :0);



    });







    var tcsval = 0;



    var tdsval = 0;



    var other_charges_tdsval = 0;



    var tcspercent =(isNaN($('#po_tcs_percent').val()) || $('#po_tcs_percent').val()=='' ? 0:$('#po_tcs_percent').val());



    // var tdspercent =(isNaN($('#po_tds_percent').val()) || $('#po_tds_percent').val()=='' ? 0:$('#po_tds_percent').val());



     var other_charges_taxable_amount =(isNaN($('#other_charges_taxable_amount').val()) || $('#other_charges_taxable_amount').val()=='' ? 0:$('#other_charges_taxable_amount').val());



    var charges_tds_percent =(isNaN($('#charges_tds_percent').val()) || $('#charges_tds_percent').val()=='' ? 0:$('#charges_tds_percent').val());





    var tds_purchase_limit =  $('#tds_purchase_limit').val();



    var item_cost =  $('#opening_balance').val();



    var item_amount = $('.total_payable_amt').val();



    var tds_percent = $('#bal_tds_percent').val();



    console.log(tds_percent);



    var total_balance_amount = parseFloat(parseFloat(item_cost)+parseFloat(item_amount)).toFixed(2);





    if(ctrl_page[2]=='purchase_add' && ctrl_page[3]!='')

    {

        var tdspercent =(isNaN($('#po_tds_percent').val()) || $('#po_tds_percent').val()=='' ? 0:$('#po_tds_percent').val());

        

        tdsval = parseFloat(parseFloat(total_payable_amt) * (tdspercent / 100)).toFixed(2);

    }

    else

    {

        if(tds_purchase_limit >= total_balance_amount)

        {

    

            $('#po_tds_percent').val(tds_percent);

    

                tdsval = parseFloat(parseFloat(total_payable_amt) * (tds_percent / 100)).toFixed(2);

    

        }

        else

            {

            $('#po_tds_percent').val(0);

    

            tdsval = 0;

    

            }

    }

    // if(tdspercent > 0){



    //     tdsval = parseFloat(parseFloat(total_payable_amt) * (tdspercent / 100)).toFixed(2);



    // }



    console.log('total_payable_amt:'+total_payable_amt);



    console.log('tdsval:'+tdsval);







    $("#item_tds_tax_value").val(tdsval);







    if(tcspercent > 0){



        tcsval = parseFloat(parseFloat(total_item_cost) * (tcspercent / 100)).toFixed(2);



    }



    $("#item_tcs_tax_value").val(tcsval);







    if(charges_tds_percent > 0)



    {



        other_charges_tdsval = parseFloat(parseFloat(other_charges_taxable_amount) * (charges_tds_percent / 100)).toFixed(2);



    }



    $("#other_charges_tds_tax_value").val(other_charges_tdsval);



    $('.total_pcs').html(total_pcs);



    $('.total_gwt').html(money_format_india(parseFloat(total_wt).toFixed(3)));



    $('.total_lwt').html(money_format_india(parseFloat(total_lwt).toFixed(3)));



    $('.total_nwt').html(money_format_india(parseFloat(total_nwt).toFixed(3)));



    $('.tot_diawt').html(money_format_india(parseFloat(total_diawt).toFixed(3)));



    $('.total_pure_wt').html(money_format_india(parseFloat(tot_purewt).toFixed(3)));



    $('.total_amt').html(money_format_india(parseFloat(total_item_cost).toFixed(2)));



    $('.other_metal_amt').html(money_format_india(parseFloat(other_metal_amt).toFixed(2)));



    $('.tot_paybale_purewt').html(money_format_india(parseFloat(tot_purewt).toFixed(3)));



    $('.tot_stone_price').html(money_format_india(parseFloat(tot_stone_price).toFixed(2)));



    $('.other_chrg_amt').html(money_format_india(parseFloat(other_charges_amount).toFixed(2)));



    $('.tot_purchase_wt').val((parseFloat(tot_purewt).toFixed(3)));



    $('.total_summary_taxable_amt').val((parseFloat(total_payable_amt).toFixed(2)));



    $('.total_summary_cgst_amount').val((parseFloat(total_cgst_cost).toFixed(2)));



    $('.total_summary_sgst_amount').val((parseFloat(total_sgst_cost).toFixed(2)));



    $('.total_summary_igst_amount').val((parseFloat(total_igst_cost).toFixed(2)));







    $('#received_pcs').val(total_pcs);



    $('#received_wt').val(parseFloat(total_wt).toFixed(3));







    calculate_FinalCost();







}



$(document).on('keyup','.tot_discount',function(){



    calculate_FinalCost();



});



$(document).on('keyup', '.tcs_percent, .tds_percent,.charges_tds_percent', function (){



    if(ctrl_page[1]=='grnentry')



    {



        calculate_grn_final_cost();



    }



    if(ctrl_page[1]=='purchasereturn')



    {



        calculate_purchase_return_item_cost();



    }



    else



    {



        calculate_FinalCost();



    }







});



function calculate_FinalCost()



{



    /*var total_cost          =0;



    var total_payable_amt   =(isNaN($('.total_summary_payable_amt').val()) || $('.total_summary_payable_amt').val()=='' ? 0:$('.total_summary_payable_amt').val());



    var other_charges_amount=(isNaN($('#other_charges_amount').val()) || $('#other_charges_amount').val()=='' ? 0:$('#other_charges_amount').val());







    var tot_discount        = (isNaN($('#tot_discount').val()) || $('#tot_discount').val()=='' ? 0:$('#tot_discount').val());



    var total_cost          = parseFloat(parseFloat(total_payable_amt)+parseFloat(other_charges_amount)-parseFloat(tot_discount)).toFixed(2);



    var tcsval = 0;



    var tdsval = 0;



    var tcspercent =(isNaN($('#tcs_percent').val()) || $('#tcs_percent').val()=='' ? 0:$('#tcs_percent').val());



    var tdspercent =(isNaN($('#tds_percent').val()) || $('#tds_percent').val()=='' ? 0:$('#tds_percent').val());



    if(tcspercent > 0){



        tcsval = parseFloat(parseFloat(total_cost) * (tcspercent / 100)).toFixed(2);



    }



    $("#tcs_tax_value").val(tcsval);







    if(tdspercent > 0){



        tdsval = parseFloat(parseFloat(total_cost) * (tdspercent / 100)).toFixed(2);



    }



    $("#tds_tax_value").val(tdsval);











    $('.total_cost').val(parseFloat(parseFloat(total_cost) + parseFloat(tcsval) - parseFloat(tdsval)).toFixed(0));*/















    var total_summary_taxable_amt       = (isNaN($('.total_summary_taxable_amt').val()) || $('.total_summary_taxable_amt').val()=='' ? 0:$('.total_summary_taxable_amt').val());



    var tds_tax_value                   = (isNaN($('.item_tds_tax_value').val()) || $('.item_tds_tax_value').val()=='' ? 0:$('.item_tds_tax_value').val());



    var total_summary_cgst_amount       = (isNaN($('.total_summary_cgst_amount').val()) || $('.total_summary_cgst_amount').val()=='' ? 0:$('.total_summary_cgst_amount').val());



    var total_summary_sgst_amount       = (isNaN($('.total_summary_sgst_amount').val()) || $('.total_summary_sgst_amount').val()=='' ? 0:$('.total_summary_sgst_amount').val());



    var total_summary_igst_amount       = (isNaN($('.total_summary_igst_amount').val()) || $('.total_summary_igst_amount').val()=='' ? 0:$('.total_summary_igst_amount').val());



    var tcs_tax_value                   = (isNaN($('.item_tcs_tax_value').val()) || $('.item_tcs_tax_value').val()=='' ? 0:$('.item_tcs_tax_value').val());



    var other_charges_tds_tax_value     = (isNaN($('.other_charges_tds_tax_value').val()) || $('.other_charges_tds_tax_value').val()=='' ? 0:$('.other_charges_tds_tax_value').val());



    var other_charges_taxable_amount    = (isNaN($('#other_charges_taxable_amount').val()) || $('#other_charges_taxable_amount').val()=='' ? 0:$('#other_charges_taxable_amount').val());



    var other_charges_tax               = (isNaN($('#other_charges_tax').val()) || $('#other_charges_tax').val()=='' ? 0:$('#other_charges_tax').val());



    var grn_discount                    = (isNaN($('.grn_discount').val()) || $('.grn_discount').val()=='' ? 0:$('.grn_discount').val());



    var final_cost = parseFloat(parseFloat(total_summary_taxable_amt)-parseFloat(tds_tax_value)+parseFloat(total_summary_cgst_amount)+parseFloat(total_summary_sgst_amount)+parseFloat(total_summary_igst_amount)+parseFloat(tcs_tax_value)+parseFloat(other_charges_taxable_amount)-parseFloat(other_charges_tds_tax_value)+parseFloat(other_charges_tax)-parseFloat(grn_discount)).toFixed(2)



    console.log('final_cost:'+final_cost);



    round_of_val               = final_cost;



    tot_cost 			        = parseFloat(Math.round(final_cost));







	 round_of_amt               = parseFloat(tot_cost-round_of_val).toFixed(2);



	 console.log(round_of_amt);



	 $('.grn_round_off').val(round_of_amt<0.50 ? round_of_amt : round_of_amt);



     $('.total_cost').val(parseFloat(tot_cost).toFixed(2));







}



function reset_order_entry_form()



{



    $('#select_category').select2("val","");



    $('#select_product').select2("val","");



    $('#select_design').select2("val","");



    $('#select_sub_design').select2("val","");



    $('#select_sub_design').select2("val","");



    $('#tot_pcs').val('');



    $('#tot_gwt').val('');



    $('#tot_lwt').val('');



    $('#tot_nwt').val('');



    $('#tot_wastage_perc').val('');



    $('#mc_value').val('');



    $('#rate_per_gram').val(0);



    $('#tot_purewt').val(0);



    $('#item_cost').val(0);



    $('#purchase_touch').val();



    $('#stone_details').val('');



    $('#other_charges_details').val('');



    $('#item_remarks').val('');



    $('#stone_price').val(0);



    $('#calculation_based_on').val(0);



    $('#po_item_id').val('');



    $('#other_metal_details').val('');



    $('#other_metal_amount').val(0);



    $('#other_metal_wt').val(0);



    $('#other_metal_wast_wt').val(0);



    $('#other_metal_mc_amount').val(0);



    $('#other_charges_amount').val(0);



    $('#item_total_taxable').val(0);



    $('#item_total_tax').val(0);



    $('#item_cgst_cost').val(0);



    $('#item_sgst_cost').val(0);



    $('#item_igst_cost').val(0);



    $('#item_tax_percentage').val(0);



    $('#tax_type').val("");



    $('#tax_group_id').val("");



    $('#tot_wastage_wgt').val('');



    $('#wastage_type').val('');







   /*$('#other_charges_details').val('');



    $('#other_charges_amount').val(0);*/







    modalStoneDetail=[];



    metal_details=[];



    modalOthermetal=[];



}



$('#rate_calc_type').on('change',function()

{

    if(this.value!='')

    {

        calculate_purchase_item_cost();

    }

})



function calculate_purchase_item_cost()



{



    var item_cost=0;



    var rate_per_gram           = (isNaN($('#rate_per_gram').val()) || $('#rate_per_gram').val()=='' ? 0:$('#rate_per_gram').val());



    var tot_pcs                 = (isNaN($('#tot_pcs').val()) || $('#tot_pcs').val()=='' ? 0:$('#tot_pcs').val());



    var tot_gwt                 = (isNaN($('#tot_gwt').val()) || $('#tot_gwt').val()=='' ? 0:$('#tot_gwt').val());



    var tot_lwt                 = (isNaN($('#tot_lwt').val()) || $('#tot_lwt').val()=='' ? 0:$('#tot_lwt').val());



    var wastage_per             = (isNaN($('#tot_wastage_perc').val()) || $('#tot_wastage_perc').val()=='' ? 0:$('#tot_wastage_perc').val());



    var mc_value                = (isNaN($('#mc_value').val()) || $('#mc_value').val()=='' ? 0:$('#mc_value').val());



    var other_metal_amount      = (isNaN($('#other_metal_amount').val()) || $('#other_metal_amount').val()=='' ? 0:$('#other_metal_amount').val());



    var other_metal_wt          = (isNaN($('#other_metal_wt').val()) || $('#other_metal_wt').val()=='' ? 0:$('#other_metal_wt').val());



    var other_metal_wast_wt     = (isNaN($('#other_metal_wast_wt').val()) || $('#other_metal_wast_wt').val()=='' ? 0:$('#other_metal_wast_wt').val());



    var other_metal_mc_amount   = (isNaN($('#other_metal_mc_amount').val()) || $('#other_metal_mc_amount').val()=='' ? 0:$('#other_metal_mc_amount').val());



    var stone_price             = (isNaN($('#stone_price').val()) || $('#stone_price').val()=='' ? 0:$('#stone_price').val());



    var calculation_based_on    = (isNaN($('#calculation_based_on').val()) || $('#calculation_based_on').val()=='' ? 0:$('#calculation_based_on').val());



    var order_div_gwt           = 0;







    var karigar_type            = $('#select_karigar option:selected').attr('data-karigartpe');







    //var ratecaltype             = ($('#purchase_mode').val()!='' ? $('#purchase_mode').val():$('#select_product option:selected').attr('data-purmode')); //2-Flexible,1-Fixed







    var tax_type                = ''; //1-Inclusive,2-Exclusive







    var purchase_type           = $("input[name='order[purchase_type]']:checked").val();







    var karigar_calc_type       = $('#karigar_calc_type').val();





     var stone_type = $('#select_product option:selected').attr('data-stone_type'); //0-Ornaments,1-stone,2-Diamond



    var ratecaltype = $('#rate_calc_type').val(); // 1-> Gram , 2-> Pcs







    var grn_type                ='';



    var wastage_wt  = (isNaN($('#tot_wastage_wgt').val()) || $('#tot_wastage_wgt').val()=='' ? 0:$('#tot_wastage_wgt').val());



    var wastage_type = ($('#wastage_type').val()!='' ? $('#wastage_type').val():1);



    if(stone_price > 0){



        //stone_price = parseFloat(parseFloat(stone_price) * ((100 + 3) / 100)).toFixed(2);



    }















    var other_charges_amount = 0;











    var other_charges_details = [];



    if($('#other_charges_details').val()!='')



    {



        other_charges_details = JSON.parse($('#other_charges_details').val());



        console.log(other_charges_details);



        $.each(other_charges_details,function(k,val){



        var char_tax = 0;



        var charge_tax_value = 0;



        var item_charges_amount = 0;



            $.each(charges_details, function (ckey, citem) {



			    if(parseInt(val.charge_id) == parseInt(citem.id_charge)){



			        char_tax= parseFloat(citem.charge_tax);



			        }



			    });



            if(val.calc_type==1)



            {



                item_charges_amount=parseFloat(val.charge_value);



            }else if(val.calc_type==2)



            {



                item_charges_amount=(parseFloat(val.charge_value)*tot_pcs);



            }



            if(char_tax > 0){



                charge_tax_value  = (parseFloat(item_charges_amount)*parseFloat(char_tax)/100).toFixed(2);



            }



           item_charges_amount = parseFloat(parseFloat(item_charges_amount)+parseFloat(charge_tax_value)).toFixed(2);



           other_charges_amount+=parseFloat(item_charges_amount);



           other_charges_details[k].total_charge_value = parseFloat(item_charges_amount).toFixed(2);



           other_charges_details[k].tax_percentage = parseFloat(char_tax).toFixed(2);



           other_charges_details[k].charge_tax_value = parseFloat(charge_tax_value).toFixed(2);



           other_charges_details[k].charge_value = parseFloat(val.charge_value).toFixed(2);



           other_charges_details[k].calc_type = val.calc_type;



           other_charges_details[k].charge_id = val.charge_id;



        });



        $('#other_charges_details').val(JSON.stringify(other_charges_details));



        $('#other_charges_amount').val(parseFloat(other_charges_amount).toFixed(2));



    }



    var net_wt                  = parseFloat(tot_gwt)-parseFloat(other_metal_wt)-parseFloat(tot_lwt); //Removing Other Metal Weight and Stone Weight







    $('#tot_nwt').val(parseFloat(net_wt).toFixed(3));







    if($('#is_cus_repair_order').val() == 1){



       if(tot_gwt > 0){



           var tot_ord_issue_wt = (isNaN($('#order_gwt').val()) || $('#order_gwt').val()=='' ? 0:$('#order_gwt').val());



           order_div_gwt = parseFloat(net_wt) - parseFloat(tot_ord_issue_wt);



       }



   }











    var purity = (isNaN($('#purchase_touch').val()) || $('#purchase_touch').val()=='' ? 0:$('#purchase_touch').val());



    var wastage = (isNaN($('#tot_wastage_perc').val()) || $('#tot_wastage_perc').val()=='' ? 0:$('#tot_wastage_perc').val());



    var mc_type                 = $('#mc_type').val();



    /*



    0 - MC & V.A on Gross Weight



    1 - MC & V.A on Net Weight



    2 - MC On Gross & V.A on Net Weight



    */



    if(calculation_based_on==0)



    {



        var total_mc_value          = (mc_type==1 ? parseFloat(parseFloat(mc_value)*parseFloat(tot_gwt)).toFixed(2) :parseFloat(parseFloat(mc_value)*parseFloat(tot_pcs)).toFixed(2));



        if(wastage_type==1)  // 1 -> wast_percentage  ,  2 -> wast_wgt



        {



            var wast_wt = parseFloat((tot_gwt*$('#tot_wastage_perc').val())/100).toFixed(3);



            $('#tot_wastage_wgt').val(wast_wt);



        }



        else



        {



            var wast_per = parseFloat(parseFloat(wastage_wt*100)/parseFloat(tot_gwt)).toFixed(2);



            $('#tot_wastage_perc').val(wast_per);



        }



    }



    else if(calculation_based_on==1)



    {







        var total_mc_value          = (mc_type==1 ? parseFloat(parseFloat(mc_value)*parseFloat(net_wt)).toFixed(2) :parseFloat(parseFloat(mc_value)*parseFloat(tot_pcs)).toFixed(2));



        if(wastage_type==1)  // 1 -> wast_percentage  ,  2 -> wast_wgt



        {



            var wast_wt  = parseFloat((net_wt*$('#tot_wastage_perc').val())/100).toFixed(3);



            $('#tot_wastage_wgt').val(wast_wt);



        }



        else



        {



            var wast_per = parseFloat(parseFloat(wastage_wt*100)/parseFloat(net_wt)).toFixed(2);



            $('#tot_wastage_perc').val(wast_per);



        }



    }



    else if(calculation_based_on==2)



    {



        var total_mc_value          = (mc_type==1 ? parseFloat(parseFloat(mc_value)*parseFloat(tot_gwt)).toFixed(2) :parseFloat(parseFloat(mc_value)*parseFloat(tot_pcs)).toFixed(2));







        if(wastage_type==1)  // 1 -> wast_percentage  ,  2 -> wast_wgt



        {



            var wast_wt  = parseFloat((net_wt*$('#tot_wastage_perc').val())/100).toFixed(3);



            $('#tot_wastage_wgt').val(wast_wt);



        }



        else



        {



            var wast_per = parseFloat(parseFloat(wastage_wt*100)/parseFloat(net_wt)).toFixed(2);



            $('#tot_wastage_perc').val(wast_per);



        }



    }



    if(wastage_per > 100)



    {



        wastage = 0;



        $('#tot_wastage_perc').val(0);



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Wastage Percentage Should Not Exceed More Than 100"});



    }







    $('.tot_mc_val').html(total_mc_value);















    var total_weight            = parseFloat(wast_wt)+parseFloat(net_wt);







    //$('#is_cus_repair_order').val(1);











    //var mctax                   = purchase_type == 2 ? 3 : $('#is_cus_repair_order').val() == 1 ? 18 : 5;











   /* var mctax                   = purchase_type == 2 ? 3 : $('#is_cus_repair_order').val() == 1 ? 18 : (is_metal_issue==1 ? 5 : 3);







    if(purchase_type == 2){







        var item_cost                   = parseFloat(((parseFloat(pure_wt))*parseFloat(rate_per_gram))+parseFloat(mc_type == 1 ? ((mc_value*tot_gwt) * ((100 + mctax) / 100)) : ((mc_value*tot_pcs) * ((100 + mctax) / 100)))+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(stone_price)).toFixed(2);



    }else{



        if($('#is_cus_repair_order').val() == 1){



            wast_wt                 = parseFloat((order_div_gwt * $('#tot_wastage_perc').val()) / 100).toFixed(3);



            if(karigar_type == 1){



                var item_cost  = parseFloat(((parseFloat(pure_wt))*parseFloat(rate_per_gram))+parseFloat(mc_type == 1 ? ((mc_value) * ((100 + mctax) / 100)) : ((mc_value*tot_pcs) * ((100 + mctax) / 100)))+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(stone_price) + ((wast_wt * rate_per_gram)* ((100 + mctax) / 100))).toFixed(2);



            }else{



               var item_cost  = parseFloat(((parseFloat(pure_wt))*parseFloat(rate_per_gram))+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(stone_price)).toFixed(2);



            }







        }else{



            if(karigar_type == 1){



                var item_cost  = parseFloat(((parseFloat(pure_wt))*parseFloat(rate_per_gram))+parseFloat(mc_type == 1 ? ((mc_value*tot_gwt) * ((100 + mctax) / 100)) : ((mc_value*tot_pcs) * ((100 + mctax) / 100)))+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(stone_price) + ((wast_wt * rate_per_gram)* ((100 + mctax) / 100))).toFixed(2);



            }else{



               var item_cost  = parseFloat(((parseFloat(pure_wt))*parseFloat(rate_per_gram))+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(stone_price)).toFixed(2);



            }



        }



    }







    if($("input[type='radio'][name='order[po_type]']:checked").val() == 3){ // For stone purchase



        var tot_pcs = (isNaN($('#tot_pcs').val()) || $('#tot_pcs').val()=='' ? 0:$('#tot_pcs').val());



        var stone_wt = (isNaN($('.stone_wt').val()) || $('.stone_wt').val()=='' ? 0:$('.stone_wt').val());



        var stone_uom = (isNaN($('.stone_uom_id').val()) || $('.stone_uom_id').val()=='' ? 0:$('.stone_uom_id').val());



        var stone_cal_type = $("input[type='radio'][name='cal_type']:checked").val();







        if(stone_cal_type == 1){



            var item_cost  = parseFloat((((parseFloat(stone_wt))*parseFloat(rate_per_gram)) * ((100 + 0.25) / 100))).toFixed(2);



        }else{



            var item_cost  = parseFloat((((parseFloat(tot_pcs))*parseFloat(rate_per_gram)) * ((100 + 0.25) / 100))).toFixed(2);



        }







    }else if($("input[type='radio'][name='order[po_type]']:checked").val() == 2){ // For bullion purchase



        var item_cost  = parseFloat((((parseFloat(tot_gwt))*parseFloat(rate_per_gram)) )).toFixed(2);



    }*/







    $.each(activeGRNS,function(g,val){



        if(val.grn_id==$('#select_grn').val())



        {



            grn_type=val.grn_type;



        }



    });







        if(karigar_calc_type==1)



        {



            var purewt = format(parseFloat((parseFloat(net_wt) * (parseFloat(purity) + parseFloat(wastage))) / 100)).replace(/,/g, '');



        }else if(karigar_calc_type==2) //Net weight * touch



        {



            var purewt = parseFloat((parseFloat(net_wt) * (parseFloat(purity)/100)));



        }



        else if(karigar_calc_type==3) // ((net wt * 3%)*92%)



        {



            var touch_weight       = parseFloat((parseFloat(net_wt)*parseFloat(purity)/100)).toFixed(3);



            var wastage_touch      = parseFloat(parseFloat(touch_weight)*(parseFloat(wastage_per))/100);



            var purewt             = parseFloat(parseFloat(touch_weight)+parseFloat(wastage_touch)).toFixed(3);



        }







    if(grn_type==1) //1-Supplier Bill



    {



        if(stone_type==0) // for ornaments Product

        {

            if(ratecaltype==1) // Rate Calc By Grm(Wt)

            {

                item_cost   = parseFloat((parseFloat(purewt)*parseFloat(rate_per_gram))+parseFloat(total_mc_value)+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(stone_price)).toFixed(2);

            }else

            {

                item_cost   = parseFloat((parseFloat(tot_pcs)*parseFloat(rate_per_gram))+parseFloat(total_mc_value)+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(stone_price)).toFixed(2);

            }

        }

        else // for stone and Diamond Product

        {

            if(ratecaltype==1) // Rate Calc By Grm(Wt)

            {

                item_cost   = parseFloat((parseFloat(tot_gwt)*parseFloat(rate_per_gram))).toFixed(2);

            }

            else

            {

                item_cost   = parseFloat((parseFloat(tot_pcs)*parseFloat(rate_per_gram))).toFixed(2);

            }

        }









        var tax_group = '';



        var total_tax_rate = 0;



        var igst_cost = 0;



        var sgst_cost = 0;



        var cgst_cost = 0;



        $.each(product_list,function(key,val){



            if(val.pro_id == $('#select_product').val())



            {



                tax_group = val.tax_group_id;



                tax_type = val.tax_type;



            }



        });

        console.log('tax_group',tax_group);

        if(tax_group!='')



        {



            var supplier_country = '';



            var supplier_state = '';



            var cmp_country = $('#cmp_country').val();



            var cmp_state = $('#cmp_state').val();



            var supplier_country = $('#supplier_country').val();



            var supplier_state = $('#supplier_state').val();







            if(tax_type==1) // Inclusive of Tax



            {



                tax_details = calculate_inclusiveGST(item_cost,tax_group);



                console.log(tax_details);



                var total_tax_rate = tax_details['totaltax'];



                var tax_percentage = tax_details['tax_percentage'];



                if(cmp_country=='' || cmp_state=='')



        		{



        		    cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



        		    sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



        		}



        		else



        		{



        		    if(total_tax_rate > 0)



        		    {



        		        if(cmp_country==supplier_country)



            		    {



            		        if(cmp_state==supplier_state)



            		        {



            		            sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		            cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		        }else



            		        {



            		            igst_cost = total_tax_rate;



            		        }



            		    }else



            		    {



            		        sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		        cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		    }



        		    }



        		}



            }else



            {



                var tax_details     = calculate_base_value_tax(item_cost, tax_group);



                var total_tax_rate  = tax_details['totaltax'];



                var tax_percentage  = tax_details['tax_percentage'];



                item_cost           = parseFloat(parseFloat(item_cost)+parseFloat(total_tax_rate)).toFixed(2);



                if(cmp_country=='' || cmp_state=='')



        		{



        		    cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



        		    sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



        		}



        		else



        		{



        		    if(total_tax_rate > 0)



        		    {



        		        if(cmp_country==supplier_country)



            		    {



            		        if(cmp_state==supplier_state)



            		        {



            		            sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		            cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		        }else



            		        {



            		            igst_cost = total_tax_rate;



            		        }



            		    }else



            		    {



            		        sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		        cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		    }



        		    }



        		}



            }



            $('#item_cgst_cost').val(parseFloat(cgst_cost).toFixed(2));



            $('#item_sgst_cost').val(parseFloat(sgst_cost).toFixed(2));



            $('#item_igst_cost').val(parseFloat(igst_cost).toFixed(2));



            $('#item_total_tax').val(parseFloat(total_tax_rate).toFixed(2));



            $('#item_tax_percentage').val(parseFloat(tax_percentage).toFixed(2));



            $('#tax_type').val(tax_type);



            $('#tax_group_id').val(tax_group);



        }











    }



    else if(grn_type==2) //2-Job Work receipt



    {



        /*



        1.For Job Work Receipt No GST.



        1.For B2B Karigar  - Need to calculate GST For MC and Stone Value.



        */



        var is_suspense_stock = $("input[name='order[is_suspense_stock]']:checked").val();



        var mc_and_stone_charges = parseFloat(total_mc_value)+parseFloat(stone_price);  //Need to Calculate GST For MC and Stone..



        if(karigar_type == 1 && mc_and_stone_charges!='' && mc_and_stone_charges>0 && is_suspense_stock==0 )



        {



            $.each(product_list,function(key,val){



                if(val.pro_id == $('#select_product').val())



                {



                    tax_group = val.job_work_receipt_tgrp_id;



                    tax_type = val.purchase_tax_type;



                }



            });



            if(tax_group!='')



            {



                var supplier_country = '';



                var supplier_state = '';



                var cmp_country = $('#cmp_country').val();



                var cmp_state = $('#cmp_state').val();



                var supplier_country = $('#supplier_country').val();



                var supplier_state = $('#supplier_state').val();



                if(tax_type==1) // Inclusive of Tax



                {



                    tax_details = calculate_inclusiveGST(mc_and_stone_charges,tax_group);



                    console.log(tax_details);



                    var total_tax_rate = tax_details['totaltax'];



                    var tax_percentage = tax_details['tax_percentage'];



                    if(cmp_country=='' || cmp_state=='')



            		{



            		    cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		    sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		}



            		else



            		{



            		    if(total_tax_rate > 0)



            		    {



            		        if(cmp_country==supplier_country)



                		    {



                		        if(cmp_state==supplier_state)



                		        {



                		            sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		            cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		        }else



                		        {



                		            igst_cost = total_tax_rate;



                		        }



                		    }else



                		    {



                		        sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		        cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		    }



            		    }



            		}



                }else



                {



                    var tax_details     = calculate_base_value_tax(mc_and_stone_charges, tax_group);



                    var total_tax_rate  = tax_details['totaltax'];



                    var tax_percentage  = tax_details['tax_percentage'];



                    mc_and_stone_charges           = parseFloat(parseFloat(mc_and_stone_charges)+parseFloat(total_tax_rate)).toFixed(2);



                    if(cmp_country=='' || cmp_state=='')



            		{



            		    cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		    sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		}



            		else



            		{



            		    if(total_tax_rate > 0)



            		    {



            		        if(cmp_country==supplier_country)



                		    {



                		        if(cmp_state==supplier_state)



                		        {



                		            sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		            cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		        }else



                		        {



                		            igst_cost = total_tax_rate;



                		        }



                		    }else



                		    {



                		        sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		        cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		    }



            		    }



            		}



                }



                $('#item_cgst_cost').val(parseFloat(cgst_cost).toFixed(2));



                $('#item_sgst_cost').val(parseFloat(sgst_cost).toFixed(2));



                $('#item_igst_cost').val(parseFloat(igst_cost).toFixed(2));



                $('#item_total_tax').val(isNaN(parseFloat(total_tax_rate).toFixed(2)) ? 0 : parseFloat(total_tax_rate).toFixed(2));



                $('#item_tax_percentage').val(parseFloat(tax_percentage).toFixed(2));



                $('#tax_type').val(tax_type);



                $('#tax_group_id').val(tax_group);



            }



        }



        var total_wt = parseFloat(parseFloat(parseFloat(net_wt)*parseFloat(wastage)/100)).toFixed(3);



        if(stone_type==0) // for ornaments product

        {

            if(ratecaltype==1) // Rate Calc By Grm(Wt)

            {

                item_cost   = parseFloat((parseFloat(parseFloat(purewt)+parseFloat(total_wt))*parseFloat(rate_per_gram))+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(mc_and_stone_charges)).toFixed(2);

            }else

            {

                item_cost   = parseFloat((parseFloat(parseFloat(tot_pcs)+parseFloat(total_wt))*parseFloat(rate_per_gram))).toFixed(2);

            }

        }

        else

        {

            if(ratecaltype==1) // Rate Calc By Grm(Wt)

            {

                item_cost   = parseFloat((parseFloat(tot_gwt)*parseFloat(rate_per_gram))).toFixed(2);

            }

            else

            {

                item_cost   = parseFloat((parseFloat(tot_pcs)*parseFloat(rate_per_gram))).toFixed(2);

            }



        }







    }



    $('.tax_type').html('');



    $('.tax_type').html((tax_type!='' ? (tax_type==1 ? ' - Inclusive' :' - Exclusive') :''));



    $('#tot_purewt').val(parseFloat(purewt).toFixed(3));



    $('#item_total_taxable').val(isNaN(parseFloat(item_cost - total_tax_rate).toFixed(2)) ? 0 : parseFloat(item_cost - total_tax_rate).toFixed(2));



    $('#item_cost').val((isNaN(item_cost) ? 0 : item_cost));



}



function validateBillEntryForm()



{



    var row_validate=true;



   /* if($('#select_category').val()=='' || $('#select_category').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Category."});



        row_validate=false;



    }



    else if($("input[type='radio'][name='order[po_type]']:checked").val() != 3 && ($('#select_purity').val()=='' || $('#select_purity').val()==null))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Purity."});



        row_validate=false;



    }



    else



    { */



        if($('#item_detail > tbody tr').length>0)



        {



            $('#item_detail > tbody tr').each(function(bidx, brow){



                curRow = $(this);



                // || curRow.find('.id_design').val()=='' || curRow.find('.id_sub_design').val()==''



                if(curRow.find('.tot_pcs').val()=='' || curRow.find('.tot_purewt').val()=='' || curRow.find('.id_product').val()=='')



                {



                    row_validate=false;



                }



           });



        }



        else



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Fill The Required Fields."});



            row_validate=false;



        }







    /* } */







    return row_validate;



}



$('#submit_pur_entry').on('click',function(){







    if(validateBillEntryForm())



    {



        $('#submit_pur_entry').prop('disabled',true);



        $("div.overlay").css("display", "block");



        var form_data=$('#purhcase_entry_form').serialize();



    	$('#pay_submit').prop('disabled',true);



    	if($('#po_id').val()!='')



    	{



    	    var url=base_url+ "index.php/admin_ret_purchase/purchase/po_entry_update?nocache=" + my_Date.getUTCSeconds();



    	}else



    	{



    	    var url=base_url+ "index.php/admin_ret_purchase/purchase/po_entry_save?nocache=" + my_Date.getUTCSeconds();



    	}



    	my_Date = new Date();



        $.ajax({



            url:url,



            data: form_data,



            type:"POST",



            dataType:"JSON",



            success:function(data){



    			if(data.status)



    			{



    			    $("div.overlay").css("display", "none");



    			}



                window.open( base_url+'index.php/admin_ret_purchase/purchase/job_receipt/'+data.Insid,'_blank');



    			window.location.href= base_url+'index.php/admin_ret_purchase/purchase/list';



            },



            error:function(error)



            {



                $("div.overlay").css("display", "none");



            }



        });



    }











});



$('#po_item_search').on('click',function(){



    $('#item_detail tbody').empty();



    if($('#select_po_ref_no').val()=='')



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Ref No."});



    }else



    {



        get_purchase_issue_entry_items();



    }



});



function get_purchase_issue_entry_items()



{



    $("div.overlay").css("display", "block");



     	my_Date = new Date();



        $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/get_purchase_issue_entry_items?nocache=" + my_Date.getUTCSeconds(),



        data:{'qc_ref_no':$('#select_ref_no').val()},



        dataType:"JSON",



        type:"POST",



        success:function(data){



			if(data.length>0)



			{











			    $.each(data,function(key,items){



			     var rowExists=false;



			     var trHtml='';



			         $('#item_detail > tbody tr').each(function(bidx, brow){



                    curRow = $(this);



                        if(curRow.find('.po_item_id').val()==items.po_item_id)



    					{



    					    rowExists=true;



    					    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



    					}



                   });



                   if(!rowExists)



                   {



                       let stone_details=(items.stone_details);



                       var stone_wt = 0;



                       var id = parseFloat($('#item_detail > tbody tr').length+1);



			           trHtml='<tr id="'+id+'" class="'+items.id_qc_issue_details+'">'



			              +'<td><input type="hidden" class="id_qc_issue_details"  name="order_items[id_qc_issue_details][]" value="'+items.id_qc_issue_details+'"/><input type="hidden" name="order_items[no_of_pcs][]" class="no_of_pcs" value="'+items.issue_pcs+'"><input type="hidden" name="order_items[gross_wt][]" class="gross_wt" value="'+items.issue_gwt+'"><input type="hidden" name="order_items[net_wt][]" class="net_wt" value="'+items.issue_nwt+'"><input type="hidden" name="order_items[less_wt][]" class="less_wt" value="'+items.issue_lwt+'">'+items.po_item_id+'</td>'



			              +'<td>'+items.product_name+'</td>'



			              +'<td>'+items.design_name+'</td>'



			              +'<td>'+items.sub_design_name+'</td>'



			              +'<td>'+items.issue_pcs+'</td>'



			              +'<td>'+items.issue_gwt+'</td>'



			              +'<td>'+items.issue_lwt+'</td>'



			              +'<td>'+items.issue_nwt+'</td>'



			              +'<td><input type="number" name="order_items[failed_pcs][]" class="form-control failed_pcs" value="0" style="width: 100px;"></td>'



			              +'<td><input type="number" name="order_items[failed_gwt][]" class="form-control failed_gwt" value="0" style="width: 100px;"></td>'



			              +'<td><div class="form-group" style="width: 100px;"><div class="input-group "><input class="form-control custom-inp failed_lwt" name="order_items[failed_lwt][]" value="" onClick="create_new_empty_qc_receipt_stone_item($(this).closest(\'tr\'));"  type="number" name="item[less_wt][]" step="any" readonly /><span class="input-group-addon input-sm add_tag_lwt" onClick="create_new_empty_qc_receipt_stone_item($(this).closest(\'tr\'));">+</span></div><input type="hidden" name="order_items[stone_details][]" class="stone_details" value=\''+JSON.stringify(stone_details)+'\' ><input type="hidden" class="qc_issue_less_wt" value=""></div></td>'



			              +'<td><input type="number" name="order_items[failed_nwt][]" class="form-control failed_nwt" value="0" style="width: 100px;" readonly></td>'



			              +'<td><input type="number" name="order_items[qc_acc_pcs][]" class="form-control qc_acc_pcs" value="'+items.issue_pcs+'" readonly style="width: 100px;" ></td>'



			              +'<td><input type="number" name="order_items[qc_acc_gwt][]" class="form-control qc_acc_gwt" value="'+items.issue_gwt+'" readonly style="width: 100px;" ></td>'



			              +'<td><input type="number" name="order_items[qc_acc_lwt][]" class="form-control qc_acc_lwt" value="'+items.issue_lwt+'" readonly style="width: 100px;" ></td>'



			              +'<td><input type="number" name="order_items[qc_acc_nwt][]" class="form-control qc_acc_nwt" value="'+items.issue_nwt+'" readonly style="width: 100px;" ></td>'



			              +'</tr>';



			              $('#item_detail tbody').append(trHtml);



                   }







			    });



			    $



			}else



			{



			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found."});



			}



			$("div.overlay").css("display", "none");



        },



        error:function(error)



        {



            $("div.overlay").css("display", "none");



        }



    });



}



function create_new_empty_qc_receipt_stone_item(curRow,id)



{







    $('#qc_issue_stone_details tbody').empty();



	if(curRow!=undefined)



	{



		$('#custom_active_id').val(curRow.closest('tr').attr('id'));



	}



	var row = "";



		var catRow=$('#custom_active_id').val();







		console.log(catRow);



		var row_st_details=$('#'+catRow).find('.stone_details').val();



		if(row_st_details !='' && row_st_details != '[]' && curRow != undefined)



		{



			var stone_details   = JSON.parse(row_st_details);



			console.log(stone_details);



			$.each(stone_details, function (pkey, pitem) {



	 		var accepted_pcs  = parseFloat(parseFloat(pitem['stone_pcs'])-parseFloat(pitem['po_stone_rejected_pcs'])).toFixed(3);



	 		var accepted_wt  = parseFloat(parseFloat(pitem['stone_wt']-pitem['po_stone_rejected_wt'])).toFixed(3);



				row += '<tr>'



                	+'<td><input type="hidden" class="ret_qc_issue_stn_id" value="'+pitem.ret_qc_issue_stn_id+'"><input type="hidden" class="po_stone_uom" value="'+pitem.po_stone_uom+'">'+pitem.ret_qc_issue_stn_id+'</td>'



                	+'<td><input type="hidden" class="stone_name" value="'+pitem.stone_name+'">'+pitem.stone_name+'</td>'



					+'<td><input type="number" class="po_stone_pcs form-control" name="est_stones_item[stone_pcs][]"  value="'+pitem['stone_pcs']+'" style="width: 100px;" readonly/></td>'



					+'<td><input class="stone_wt form-control po_stone_wt" type="number" name="est_stones_item[stone_wt][]" value="'+pitem['stone_wt']+'" style="width:100px;" readonly /></td>'



					+'<td><input type="number" class="po_stone_rejected_pcs form-control" name="est_stones_item[stone_pcs][]"  value="'+pitem['po_stone_rejected_pcs']+'" style="width: 100px;" /></td>'



					+'<td><input class="po_stone_rejected_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="'+pitem['po_stone_rejected_wt']+'" style="width:100px;"  /></td>'



					+'<td><input type="number" class="po_stone_accepted_pcs form-control" name="est_stones_item[stone_pcs][]"  value="'+accepted_pcs+'" style="width: 100px;" /></td>'



					+'<td><input class="po_stone_accepted_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="'+accepted_wt+'" style="width:100px;"  /></td>'



					+'</tr>';



			});







		}



	$('#cus_stoneModal .modal-body').find('#qc_issue_stone_details tbody').append(row);



	$('#cus_stoneModal').modal('show');







}



$(document).on('keyup','.po_stone_rejected_pcs',function(e){



    var row = $(this).closest('tr');



    var tot_pcs=row.find('.po_stone_pcs').val();



    var failed_pcs=row.find('.po_stone_rejected_pcs').val();



    if(parseFloat(tot_pcs)<parseFloat(failed_pcs))



    {



        row.find('.po_stone_rejected_pcs').val('');



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Pieces."});



    }



    calculate_stone_accepted_details();



});



$(document).on('keyup','.po_stone_rejected_wt',function(e){



    var row = $(this).closest('tr');



    var gross_wt=row.find('.po_stone_wt').val();



    var failed_wt=row.find('.po_stone_rejected_wt').val();



    if(parseFloat(gross_wt)<parseFloat(failed_wt))



    {



        row.find('.po_stone_rejected_wt').val(0);



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Weight."});



    }



    calculate_stone_accepted_details();



});



function calculate_stone_accepted_details()



{







    $('#qc_issue_stone_details > tbody tr').each(function(bidx, brow){



        curRow = $(this);







        var total_po_stone_pcs=0;



        var total_po_stone_wt=0;



        var total_rejected_pcs=0;



        var total_rejected_gwt=0;



        var accepted_wt=0;











        total_issue_pcs=parseFloat(isNaN(curRow.find('.po_stone_pcs').val()) || curRow.find('.po_stone_pcs')=='' ? 0 :curRow.find('.po_stone_pcs').val());



        total_issue_gwt=parseFloat(isNaN(curRow.find('.po_stone_wt').val()) || curRow.find('.po_stone_wt')=='' ? 0 :curRow.find('.po_stone_wt').val());







        total_rejected_pcs=parseFloat(isNaN(curRow.find('.po_stone_rejected_pcs').val()) || curRow.find('.po_stone_rejected_pcs')=='' ? 0 :curRow.find('.po_stone_rejected_pcs').val());



        total_rejected_gwt=parseFloat(isNaN(curRow.find('.po_stone_rejected_wt').val()) || curRow.find('.po_stone_rejected_wt')=='' ? 0 :curRow.find('.po_stone_rejected_wt').val());







        accepted_wt=parseFloat(parseFloat(total_issue_gwt)-parseFloat(total_rejected_gwt)).toFixed(3);







        curRow.find('.po_stone_accepted_pcs').val(parseFloat(parseFloat(total_issue_pcs)-parseFloat(total_rejected_pcs)).toFixed(3));



        curRow.find('.po_stone_accepted_wt').val(accepted_wt);











    });



}



$('#cus_stoneModal  #update_qc_receipt_stone_details').on('click', function(){



    var stone_details=[];



    var activeRow=$('#custom_active_id').val();



    var failed_gwt = $('#'+activeRow).find('.failed_gwt').val();



    var stone_wt = 0;



      $("#qc_issue_stone_details tbody tr").each(function(index, value){



      var curRow = $(this);



              $.each(uom_details,function(key,item){



                         if(item.uom_id==curRow.find('.po_stone_uom').val())



                         {



                             if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                             {



                                 stone_wt+=parseFloat(parseFloat(curRow.find('.po_stone_rejected_wt').val())/parseFloat(item.divided_by_value));



                             }else{







                                 stone_wt+=parseFloat(curRow.find('.po_stone_rejected_wt').val());



                             }



                         }



        		});



              stone_details.push({



                        'ret_qc_issue_stn_id'       : curRow.find('.ret_qc_issue_stn_id').val(),



                        'stone_name'                : curRow.find('.stone_name').val(),



    		            'stone_pcs'                 : curRow.find('.po_stone_pcs').val(),



    		            'stone_wt'                  : curRow.find('.po_stone_wt').val(),



    		            'po_stone_rejected_pcs'     : curRow.find('.po_stone_rejected_pcs').val(),



    		            'po_stone_rejected_wt'      : curRow.find('.po_stone_rejected_wt').val(),



    		            'po_stone_accepted_pcs'     : curRow.find('.po_stone_accepted_pcs').val(),



    		            'po_stone_accepted_wt'      : curRow.find('.po_stone_accepted_wt').val(),



    		            'po_stone_uom'              : curRow.find('.po_stone_uom').val(),







    		});



      });



      if(parseFloat(failed_gwt)<parseFloat(stone_wt))



      {



          $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Entered Stone Weight is Granter Than The Gross weight.."});



      }



      else



      {



          $('#cus_stoneModal').modal('toggle');



          $('#'+activeRow).find('.stone_details').val(JSON.stringify(stone_details));



          console.log(stone_details);



          if(ctrl_page[2]=='hm_receipt')



          {



              calculate_halmarking_receipt_row_details();



          }else



          {



              $('#'+activeRow).find('.failed_lwt').val(parseFloat(stone_wt).toFixed(3));



              qcAccepted_items();



          }



      }











});



$(document).on('keyup','.failed_pcs',function(e){



    var row = $(this).closest('tr');



    var tot_pcs=row.find('.no_of_pcs').val();



    var failed_pcs=row.find('.failed_pcs').val();



    if(parseFloat(tot_pcs)<parseFloat(failed_pcs))



    {



        row.find('.failed_pcs').val(0);



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Pieces."});



    }



    qcAccepted_items();



});



$(document).on('keyup','.failed_gwt',function(e){



    var row = $(this).closest('tr');



    var gross_wt=row.find('.gross_wt').val();



    var failed_gwt=row.find('.failed_gwt').val();



    if(parseFloat(gross_wt)<parseFloat(failed_gwt))



    {



        row.find('.failed_gwt').val(0);



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Weight."});



    }



    qcAccepted_items();



});



$(document).on('keyup','.failed_lwt',function(e){



    var row = $(this).closest('tr');



    var less_wt=row.find('.less_wt').val();



    var failed_lwt=row.find('.failed_lwt').val();



    if(parseFloat(less_wt)<parseFloat(failed_lwt))



    {



        row.find('.failed_lwt').val(0);



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Weight."});



    }



    qcAccepted_items();



});



function qcAccepted_items()



{



    $('#item_detail > tbody tr').each(function(idx, row){



         curRow = $(this);







         var total_pcs      = (isNaN(curRow.find('.no_of_pcs').val()) || curRow.find('.no_of_pcs').val()=='' ? 0 :curRow.find('.no_of_pcs').val());



         var total_gross_wt = (isNaN(curRow.find('.gross_wt').val()) || curRow.find('.gross_wt').val()=='' ? 0 :curRow.find('.gross_wt').val());



         var total_less_wt  = (isNaN(curRow.find('.less_wt').val()) || curRow.find('.less_wt').val()=='' ? 0 :curRow.find('.less_wt').val());



         var total_nwt      = (isNaN(curRow.find('.less_wt').val()) || curRow.find('.net_wt').val()=='' ? 0 :curRow.find('.net_wt').val());







         var rejected_pcs   = (isNaN(curRow.find('.failed_pcs').val()) || curRow.find('.failed_pcs').val()=='' ? 0 :curRow.find('.failed_pcs').val());



         var rejected_gwt   = (isNaN(curRow.find('.failed_gwt').val()) || curRow.find('.failed_gwt').val()=='' ? 0 :curRow.find('.failed_gwt').val());



         var rejected_lwt   = (isNaN(curRow.find('.failed_lwt').val()) || curRow.find('.failed_lwt').val()=='' ? 0 :curRow.find('.failed_lwt').val());







         var qc_accepted_pcs = parseFloat(parseFloat(total_pcs)-parseFloat(rejected_pcs)).toFixed(2);



         var qc_accepted_gwt = parseFloat(parseFloat(total_gross_wt)-parseFloat(rejected_gwt)).toFixed(3);



         var qc_accepted_lwt = parseFloat(parseFloat(total_less_wt)-parseFloat(rejected_lwt)).toFixed(3);



         var qc_accepted_nwt = parseFloat(parseFloat(qc_accepted_gwt)-parseFloat(qc_accepted_lwt)).toFixed(3);







         curRow.find('.qc_acc_pcs').val(qc_accepted_pcs);



         curRow.find('.qc_acc_gwt').val(qc_accepted_gwt);



         curRow.find('.qc_acc_lwt').val(qc_accepted_lwt);



         curRow.find('.qc_acc_nwt').val(qc_accepted_nwt);



         curRow.find('.failed_nwt').val(parseFloat(parseFloat(rejected_gwt)-parseFloat(rejected_lwt)).toFixed(3));



    });



}



function validate_qc_receipt_details()



{



    var row_validate = true;



	$('#item_detail > tbody  > tr').each(function(index, tr) {



		if($(this).find('.failed_pcs').val()>0)



		{



		    if($(this).find('.failed_gwt').val()==0 || $(this).find('.failed_gwt').val()==''){



		        row_validate = false;



		    }



		}



	});



	return row_validate;



}



$('#update_qc_status').on('click',function(){



        if($('#select_ref_no').val()=='' || $('#select_ref_no').val()==null && ctrl_page[2]!='qc_receipt_edit')



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select PO Ref No"});



        }



        else if($('#item_detail > tbody > tr').length==0)



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found.."});



        }



        else if(!validate_qc_receipt_details())



        {



             $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Fill The Required Fields.."});



        }



        else



        {



            $("div.overlay").css("display", "block");



            $('#update_qc_status').prop('disabled',true);



            var form_data=$('#qc_entry_form').serialize();



        	$('#pay_submit').prop('disabled',true);



        	var url=base_url+ "index.php/admin_ret_purchase/update_qc_status?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours();



            $.ajax({



                url:url,



                data: form_data,



                type:"POST",



                dataType:"JSON",



                success:function(data){



        			if(data.status)



        			{



        			    $("div.overlay").css("display", "none");



        			    window.location.href= base_url+'index.php/admin_ret_purchase/qc_issue_receipt/list';



        			}







                },



                error:function(error)



                {



                    $("div.overlay").css("display", "none");



                }



            });



        }



});



function update_qc_status(req_data)



{



    $("div.overlay").css("display", "block");



    my_Date = new Date();



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/update_qc_status?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data:  {'req_data':req_data,'po_id':$('#select_po_ref_no').val()},



        type:"POST",



        async:false,



        dataType:"JSON",



        success:function(data){



            if(data.status)



            {



                 $("div.overlay").css("display", "none");



                $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                location.reload(false);



            }else



            {



                 $("div.overlay").css("display", "none");



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



            }



            $('#set_green_tag').prop('disabled',false);











        },



        error:function(error)



        {



            console.log(error);



            $("div.overlay").css("display", "none");



        }



    });



}



//Purchase Entry



//Other Charges



function get_ActivePurity()



{



    $("div.overlay").css("display", "block");



    $.ajax({



	type: 'GET',



	url: base_url+'index.php/admin_ret_catalog/ajax_getPurity',



	dataType:'json',



	success:function(data){



	        purityDetails=data;



	    	$("div.overlay").css("display", "none");



		}



	});



}



$(".add_other_metals").on('click',function(){



    open_other_metal_modal();



});



function open_other_metal_modal()



{



    $('#other_metalmodal').modal('show');



    $('#other_metalmodal .modal-body').find('#other_metal_table tbody').empty();



    if(modalOthermetal.length>0)



    {



        $.each(modalOthermetal, function(key,item){



            if(item)



            {



                create_new_empty_other_metal_item(item);



            }



        })



    }



    else



    {



        create_new_empty_other_metal_item();



    }



}



$(".add_other_charges").on('click',function(){



    open_other_charges_modal();



});



$(document).on('click', '#table_charges tbody tr .create_charge_item_details, .add_charges', function(){



    if(validate_charges_row()){



		create_new_empty_other_charges_item();



	}else{



		alert("Please fill required charge fields");



	}



});



$('#cus_chargeModal  #update_charge_details').on('click', function(){



	if(validate_charges_row())



    {



		var charge_details=[];



		var charge_value=0;







		var charge_value_with_tax = 0;



		modalChargeDetail = []; // Reset Old Value of charge modal



		$('#cus_chargeModal .modal-body #table_charges> tbody  > tr').each(function(index, tr) {



			charge_value += parseFloat($(this).find('.chargesValue').val());







			var char_tax        = 0;



			var char_tax_value  = 0;



			var selected_charge = $(this).find('.chargesType').val();



			$.each(charges_details, function (ckey, citem) {



			    if(parseInt(selected_charge) == parseInt(citem.id_charge)){







			        char_tax= parseFloat(citem.charge_tax);







			    }







        	});







			var char_with_tax = parseFloat(parseFloat($(this).find('.chargesValue').val()) * ((100 + char_tax) / 100)).toFixed(2);







			char_tax_value     = parseFloat(parseFloat($(this).find('.chargesValue').val()) * ((char_tax) / 100)).toFixed(2);







			charge_value_with_tax += parseFloat(char_with_tax);







			charge_details.push({



						'charge_value'       : $(this).find('.chargesValue').val(),



						'charge_id'          : $(this).find('.chargesType').val(),







						'calc_type'          : $(this).find('.calc_type').val(),



						//'name_charge'        : $(this).find('.chargesType :selected').text(),







						'char_with_tax'      : char_with_tax,







						'charge_tax'         :  char_tax,







						'charge_tax_value'   :  char_tax_value,



						});



		});



		modalChargeDetail = charge_details;



		console.log(modalChargeDetail);



		// Update charge Summary



        $("#other_charges_amount").val(parseFloat(charge_value_with_tax).toFixed(2));



		$("#other_charges_details").val(JSON.stringify(charge_details));







        $('#cus_chargeModal .modal-body').find('#table_charges tbody').empty();



        $('#cus_chargeModal').modal('hide');







        if(ctrl_page[1]=='grnentry')



        {



            calculate_grn_final_cost();



        }



        else



        {



             calculate_purchase_item_cost();







            calculate_FinalCost();







            calculate_purchase_return_item_cost();



        }















    }



    else



    {



    	alert('Please Fill The Required charge Details');



    }



});



function open_other_charges_modal(){



    $('#cus_chargeModal').modal('show');







         create_new_empty_other_charges_item($('#other_charges_details').val());



}



/*function create_new_empty_other_metal_item()



{







    var trHtml='';



    var metal='<option value="">Select Metal</option>';



    var purity='<option value="">Select Purity</option>';



    $.each(category_lists, function (mkey, mitem) {



	    metal += "<option value='"+mitem.id_ret_category+"'>"+mitem.name+"</option>";



	});



	$.each(purityDetails, function (k, p) {



		purity += "<option value='"+p.id_purity+"'>"+p.purity+"</option>";



	});











   if(ctrl_page[1]=='purchase' && ctrl_page[2]=='purchase_add')



   {



       trHtml+='<tr>'



          +'<td><select class="form-control select_metal">'+metal+'</td>'



          +'<td><select class="form-control select_purity">'+purity+'</td>'



          +'<td><input type="number" class="form-control pcs"></td>'



          +'<td><input type="number" class="form-control gwt"></td>'



          +'<td ><input type="number" class="form-control wastage_perc" value="0"><input type="hidden" class="wast_wt" value="0"></td>'



          +'<td ><select class="form-control calc_type"><option value="">Mc Type</option><option value="1" selected>Per Gram</option><option value="2">Per Piece</option></select></td>'



          +'<td ><input type="number" class="form-control making_charge" value="0"><input type="hidden" class="mc_value" value="0"></td>'



          +'<td><input type="number" class="form-control rate_per_gram"></td>'



          +'<td><input type="number" class="form-control amount"></td>'



           +'<td><a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



          +'</tr>';



   }



   else



   {



       trHtml+='<tr>'



          +'<td><select class="form-control select_metal">'+metal+'</td>'



          +'<td><select class="form-control select_purity">'+purity+'</td>'



          +'<td><input type="number" class="form-control pcs"></td>'



          +'<td><input type="number" class="form-control gwt"></td>'



          +'<td style="display:none;"><input type="number" class="form-control wastage_perc" value="0"><input type="hidden" class="wast_wt" value="0"></td>'



          +'<td style="display:none;"><select class="form-control calc_type"><option value="">Mc Type</option><option value="1" selected>Per Gram</option><option value="2">Per Piece</option></select></td>'



          +'<td style="display:none;"><input type="number" class="form-control making_charge" value="0"><input type="hidden" class="mc_value" value="0"></td>'



          +'<td><input type="number" class="form-control rate_per_gram"></td>'



          +'<td><input type="number" class="form-control amount"></td>'



           +'<td><a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



          +'</tr>';



   }







     $('#other_metal_table tbody').append(trHtml);



}*/



function create_new_empty_other_metal_item(other_metal_data=[])



{







    //var trHtml='';



    var metal='<option value="">Select Metal</option>';



    var purity='<option value="">Select Purity</option>';







    $.each(category_lists, function (mkey, mitem)



    {



        metal += "<option value='"+mitem.id_ret_category+"' "+(other_metal_data ? (mitem.id_ret_category == other_metal_data.id_metal ? 'selected' : '') : '')+">"+mitem.name+"</option>";



	});







    $.each(purityDetails, function (k, p)



    {



        purity += "<option value='"+p.id_purity+"' "+(other_metal_data ? (p.id_purity == other_metal_data.id_purity ? 'selected' : '') : '')+">"+p.purity+"</option>";



	});



    var othr_mt_pcs = (other_metal_data ? (other_metal_data.pcs == undefined ? '':other_metal_data.pcs) : '');



	var othr_mt_gwt = (other_metal_data ? (other_metal_data.gwt == undefined ? '':other_metal_data.gwt) : '');



	var othr_mt_rate = (other_metal_data ? (other_metal_data.rate_per_gram == undefined ? 0:other_metal_data.rate_per_gram): 0);



	var othr_mt_amt = (other_metal_data ? (other_metal_data.amount == undefined ? 0:other_metal_data.amount) : 0);



    var othr_mt_wast = (other_metal_data ? (other_metal_data.wastage_perc==undefined ? 0: other_metal_data.wastage_perc):0);



    var othr_mt_mc = (other_metal_data ? (other_metal_data.making_charge==undefined ? 0: other_metal_data.making_charge):0);







    var row_cls = $('#other_metal_table tbody tr').length;



        row = '<tr id="'+$('#other_metal_table tbody tr').length+'" class="st_'+$('#other_metal_table tbody tr').length+'">'







          +'<td><select class="form-control select_metal">'+metal+'</td>'



          +'<td><select class="form-control select_purity">'+purity+'</td>'



          +'<td><input type="number" class="form-control pcs" value="'+othr_mt_pcs+'"></td>'



          +'<td><input type="number" class="form-control gwt" value="'+othr_mt_gwt+'"></td>'



          +'<td ><input type="number" class="form-control wastage_perc" value="'+othr_mt_wast+'"><input type="hidden" class="wast_wt" value="0"></td>'



          +'<td ><select class="form-control calc_type"><option value="">Mc Type</option><option value="1" selected>Per Gram</option><option value="2">Per Piece</option></select></td>'



          +'<td ><input type="number" class="form-control making_charge" value="'+othr_mt_mc+'"><input type="hidden" class="mc_value" value="0"></td>'



          +'<td><input type="number" class="form-control rate_per_gram" value="'+othr_mt_rate+'"></td>'



          +'<td><input type="number" class="form-control amount" value="'+othr_mt_amt+'"></td>'



           +'<td><a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



          +'</tr>';







          $('#other_metalmodal .modal-body').find('#other_metal_table tbody').append(row);



        //$('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody .st_'+row_cls+ '.show_in_lwt').focus();







        $("#other_metalmodal").on('shown.bs.modal', function(){



        });







    $('#custom_active_id').val("st_"+row_cls);











}



function create_new_empty_other_charges_item(selData = [])



{



    //$('#table_charges tbody').empty();



    console.log(selData);



	let charges_validated = validate_charges_row();



    let row_cls_len = $('#table_charges tbody tr').length;



	if(charges_validated)



    {



        if(selData!='' && selData!='[]')



        {



            var charges = JSON.parse(selData);



            console.log(charges);



            let options = '';



            $(charges).each(function(key,val)



            {



                $(charges_list).each(function(idx, charges){



                    options += "<option value='"+charges.id_charge+"' "+(charges ? (charges.id_charge == val.charge_id ? 'selected' : '') : '')+">"+charges.name_charge+"</option>";







                });



                let row_cls = $('#table_charges tbody tr').length;



                let _row_last = $('#table_charges tbody tr:last');







                let sno = (_row_last.length > 0 ? parseInt(_row_last.find('.sno').text()) : 0)+1;







                let new_row = "<tr class='ch_"+row_cls+"'><td class='sno'>"+sno+"</td><td><select class='form-control chargesType'><option value=''>--Select--</option>"+options+"</select></td><td><select class='form-control calc_type'><option value='1' "+(val.calc_type==1 ? "selected" :'')+" >Per Item</option><option value='2' "+(val.calc_type==2 ? "selected" :'')+" >Per Piece</option></select></td><td><input type='text' value='"+(charges ? (val.charge_value == undefined ? 0 : val.charge_value) : '')+"' class='form-control chargesValue' /></td><td class='chargeModal_buttons'></td></tr>";







                $('#cus_chargeModal .modal-body').find('#table_charges tbody').append(new_row);







                $('#cus_chargeModal .modal-body').find('#table_charges tbody ch_'+row_cls+ '.chargesType').focus();



            });



        }



        else



        {



            let options = '';



            console.log(charges_list);



            $(charges_list).each(function(idx, charges){



                options += "<option value='"+charges.id_charge+"' "+(selData ? (charges.id_charge == selData.charge_id ? 'selected' : '') : '')+">"+charges.name_charge+"</option>";



            });



            let row_cls = $('#table_charges tbody tr').length;



            let _row_last = $('#table_charges tbody tr:last');



            let sno = (_row_last.length > 0 ? parseInt(_row_last.find('.sno').text()) : 0)+1;



            let new_row = "<tr class='ch_"+row_cls+"'><td class='sno'>"+sno+"</td><td><select class='form-control chargesType'><option value=''>--Select--</option>"+options+"</select></td><td><select class='form-control calc_type'><option value='1'>Per Item</option><option value='2'>Per Piece</option></select></td><td><input type='text' value='"+(selData ? (selData.charge_value == undefined ? 0 : selData.charge_value) : '')+"' class='form-control chargesValue' /></td><td class='chargeModal_buttons'></td></tr>";



            $('#cus_chargeModal .modal-body').find('#table_charges tbody').append(new_row);



            $('#cus_chargeModal .modal-body').find('#table_charges tbody ch_'+row_cls+ '.chargesType').focus();



        }

        



		addChargeModal_buttons();



		$("#cus_chargeModal").on('shown.bs.modal', function(){



            $(this).find('.chargesType').focus();



        });



	}



}



$('#cus_chargeModal  #close_charge_details').on('click', function(){



    $('#cus_chargeModal .modal-body').find('#table_charges tbody').empty();



});



function remove_charge(obj)



{



	$(obj).closest('tr').remove();



	addChargeModal_buttons();



}



function addChargeModal_buttons()



{



	let charge_rows = $("#table_charges tbody");



	$(charge_rows).find('.create_charge_item_details').remove();



	$(charge_rows).find('.remove_charge_item_details').remove();



	$(charge_rows).find(".chargeModal_buttons:last").prepend('<button type="button" class="btn btn-success btn-xs create_charge_item_details"><i class="fa fa-plus"></i></button>');



	$(charge_rows).find(".chargeModal_buttons").append('<button type="button" class="btn btn-danger btn-xs remove_charge_item_details" onclick="remove_charge(this)"><i class="fa fa-trash"></i></button>');



}



function validate_charges_row() {



	let row_validated = true;



	let charges_row = $("#table_charges tbody tr");



	$(charges_row).each(function(idx, row){



		let rowChargeType = $('.row').find('.chargesType').val();



		let rowChargesValue = $('.row').find('.chargesValue').val();



		if(!(rowChargeType > 0) || !(rowChargesValue > 0)) {



			$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please fill the previous row charges!"});



			row_validated = false;



			return false;



		}



	});



	return row_validated;



}



$('#create_other_metal_item_details').on('click',function(){



    if(validate_other_metal_row())



    {



        create_new_empty_other_metal_item();



    }else



    {



        $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>Please Fill The Required charge Details"});



    }



});



$('#other_metalmodal  #update_other_metal_details').on('click', function(){



	if(validate_other_metal_row())



    {



        modalOthermetal = [];   // Reset Old Value of other metal modal



    	var metal_details=[];



    	var tot_amount=0;



    	var tot_weight=0;



    	var tot_wast_wt=0;



    	var tot_mc_value=0;



    	$('#other_metalmodal .modal-body #other_metal_table> tbody  > tr').each(function(index, tr) {



    		tot_amount+=parseFloat($(this).find('.amount').val());



    		tot_weight+=parseFloat($(this).find('.gwt').val());



    		tot_wast_wt+=parseFloat($(this).find('.wast_wt').val());



    		tot_mc_value+=parseFloat($(this).find('.mc_value').val());



    		metal_details.push({



    		            'id_metal'      : $(this).find('.select_metal').val(),



    		            'id_purity'     : $(this).find('.select_purity').val(),



    		            'pcs'           : $(this).find('.pcs').val(),



    		            'gwt'           : $(this).find('.gwt').val(),



    		            'wastage_perc'  : $(this).find('.wastage_perc').val(),



    		            'calc_type'     : $(this).find('.calc_type').val(),



    		            'making_charge' : $(this).find('.making_charge').val(),



    		            'rate_per_gram' : $(this).find('.rate_per_gram').val(),



    		            'amount'        : $(this).find('.amount').val(),



    		            'wast_wt'       : $(this).find('.wast_wt').val(),



    		            'mc_value'      : $(this).find('.mc_value').val(),



    		            });



    	});



    	modalOthermetal = metal_details;



    	$('#other_metal_details').val(JSON.stringify(metal_details));



    	$('#other_metal_amount').val(tot_amount);



    	$('#other_metal_wt').val(tot_weight);



    	$('#other_metal_wast_wt').val(tot_wast_wt);



    	$('#other_metal_mc_amount').val(tot_mc_value);



        $('#other_metalmodal').modal('hide');



        calculate_purchase_item_cost();



    }



    else



    {



        $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>Please Fill The Required Details"});



    }



});



function validate_other_metal_row()



{



    var row_validate = true;



	$('#other_metal_table > tbody  > tr').each(function(index, tr) {



		if($(this).find('.select_metal').val() == "" || $(this).find('.select_purity').val() == "" || $(this).find('.pcs').val() == "" || $(this).find('.gwt').val() == "" || $(this).find('.rate_per_gram').val() == ""){



			row_validate = false;



		}



	});



	return row_validate;



}



$(document).on('change','.calc_type',function(){



    calculate_other_metal_amount();



});



$(document).on('keyup','.rate_per_gram,.gwt,.wastage_perc,.making_charge',function(){



    calculate_other_metal_amount();



});



function calculate_other_metal_amount()



{



    var tot_pcs=0;



    var tot_gwt=0;



    var tot_amount=0;



    $('#other_metal_table > tbody  > tr').each(function(index, tr) {



        row = $(this);



        var piece           = (isNaN(row.find('.pcs').val()) || row.find('.pcs').val()=='' ? 0:row.find('.pcs').val());



        var gross_wt        = (isNaN(row.find('.gwt').val()) || row.find('.gwt').val()=='' ? 0:row.find('.gwt').val());



        var wastage_perc    = (isNaN(row.find('.wastage_perc').val()) || row.find('.wastage_perc').val()=='' ? 0:row.find('.wastage_perc').val());



        var rate_per_gram   = (isNaN(row.find('.rate_per_gram').val()) || row.find('.rate_per_gram').val()=='' ? 0:row.find('.rate_per_gram').val());



        var calc_type       = (isNaN(row.find('.calc_type').val()) || row.find('.calc_type').val()=='' ? 0:row.find('.calc_type').val());



        var wast_wt         = parseFloat((gross_wt*wastage_perc)/100);



        var mc_type         = (row.find('.calc_type').val()=='' ? 0:row.find('.calc_type').val());



        var making_charge   = (row.find('.making_charge').val()=='' ? 0 : row.find('.making_charge').val());



        var mc_value        = (mc_type==1 ? parseFloat(gross_wt*making_charge) : (mc_type==2 ? parseFloat(making_charge*piece) :0));



        var total_amount    = parseFloat(parseFloat(rate_per_gram)*parseFloat(parseFloat(gross_wt)+parseFloat(wast_wt))+parseFloat(mc_value));



        row.find('.amount').val(parseFloat(total_amount).toFixed(2));



        row.find('.wast_wt').val(parseFloat(wast_wt).toFixed(3));



        row.find('.mc_value').val(parseFloat(mc_value).toFixed(3));







        tot_pcs+=parseFloat(piece);



        tot_gwt+=parseFloat(gross_wt);



        tot_amount+=parseFloat(total_amount);







        console.log('wast_wt:'+wast_wt);



        console.log('total_amount:'+total_amount);



        console.log('mc_value:'+mc_value);







    });







    $('.total_pcs').html(parseFloat(tot_pcs));



    $('.total_wt').html(parseFloat(tot_gwt).toFixed(3));



    $('.total_amount').html(parseFloat(tot_amount).toFixed(2));



}



$(document).on('change',".chargesType",function(){



   var row = $(this).closest('tr');



   var charge_type=this.value;



   $(charges_list).each(function(idx, charges){



        if(charges.id_charge == charge_type)



        {



            row.find('.chargesValue').val(charges.value_charge);



        }



	});



});



/*$(document).on('change',".stones_type",function(){



   var row = $(this).closest('tr');



   var stone_type=this.value;



   row.find('.stone_id').html('');



   	var stones_list = "<option value=''>-Select Stone-</option>";



   $.each(stones, function (pkey, pitem) {



        if(pitem.stone_type==stone_type)



        {



            stones_list += "<option value='"+pitem.stone_id+"'>"+pitem.stone_name+"</option>";



        }



	});



	 row.find('.stone_id').append(stones_list);



    if(ctrl_page[1]=='purchase' && ctrl_page[2]=='purchase_add')



    {



        set_karigar_wise_stones(row);



    }



});*/



$(document).on('change',".stones_type",function(){



   var row = $(this).closest('tr');



   var stone_type=this.value;



   if(stone_type == 1)



   {



        row.find('.quality_id').val('');



        row.find('.quality_id').prop('disabled', false);



   }



   else



   {



        row.find('.quality_id').val('');



        row.find('.quality_id').prop('disabled', true);



   }



   row.find('.stone_id').html('');



   var stones_list = "<option value=''>-Select Stone-</option>";



   $.each(stones, function (pkey, pitem)



   {



        if(pitem.stone_type==stone_type)



        {



            stones_list += "<option value='"+pitem.stone_id+"'>"+pitem.stone_name+"</option>";



        }



	});



	row.find('.stone_id').append(stones_list);



    if(ctrl_page[1]=='purchase' && ctrl_page[2]=='purchase_add')



    {



        set_karigar_wise_stones(row);



    }



});



$(document).on('change',".stone_id",function(){



    var row = $(this).closest('tr');



    if(ctrl_page[1]=='purchase' && ctrl_page[2]=='purchase_add')



    {



        if($('#supplier_bill_entry_calc').val()==1)



        {



            setQualityCode(row);



        }



        set_karigar_wise_stones(row);



    }



});



function setQualityCode(curRow)



{



    curRow.find('.quality_id option').remove();



    if($('#select_karigar').val()!='' && $('#select_karigar').val()!=null)



    {



        var quality_list = "<option value=''>-Select Quality-</option>";



        var finalArr =  karigar_stone_details.filter(item=>item.id_karigar == $('#select_karigar').val());



        function removeDup(arr)



        {



            let result = arr;



            keys = ['quality_id'],



            filtered = result.filter(



                (s => o =>



                    (k => !s.has(k) && s.add(k))



                    (keys.map(k => o[k]).join('|'))



                )



                (new Set)



            );



            return filtered;



        }



        let karigarApprovedStone = removeDup(finalArr);



        $.each(karigarApprovedStone,function(key,items)



        {







           if(items.id_karigar==$('#select_karigar').val() && curRow.find('.stones_type').val()==items.stone_type && curRow.find('.stone_id').val()==items.stone_id)



            {



                $.each(quality_code, function (pkey, pitem)



                {



                    if(pitem.quality_id==items.quality_id)



                    {



                        quality_list += "<option value='"+pitem.quality_id+"'>"+pitem.code+"</option>";



                    }



                });







            }



            else



            {



                curRow.find('.stone_cut').html('');



                curRow.find('.stone_color').html('');



                curRow.find('.stone_clarity').html('');



                curRow.find('.stone_shape').html('');



            }



        });



        curRow.find('.quality_id').append(quality_list);



    }



}



function set_karigar_wise_stones(curRow)

{

    curRow.find('.stone_rate').val(0);

    if($('#select_karigar').val()!='' && $('#select_karigar').val()!=null)

    {

        $.each(karigar_stone_details,function(key,items)

        {

            if(items.id_karigar==$('#select_karigar').val() && curRow.find('.stones_type').val()==items.stone_type && curRow.find('.stone_id').val()==items.stone_id)

            {

                curRow.find('.stone_rate').val(items.rate_per_gram);

                curRow.find('.stone_uom_id').val(items.uom_id);



                console.log('Stone_det',items);

                if(curRow.find('.stones_type').val() == 1 && (curRow.find('.quality_id').val()==items.quality_id))

                {

                    var stone_wt =parseFloat(curRow.find('.stone_wt').val()) ;

                    var stone_pcs = parseInt(curRow.find('.stone_pcs ').val());

                    var stone_centwt = parseFloat(parseFloat((stone_wt)/(stone_pcs))*100).toFixed(3);

                    console.log('stone_centwt',stone_centwt);

                    console.log('from_cent',items.from_wt);

                    console.log('to_cent',items.to_wt);

                    if(stone_centwt >= parseFloat(items.from_wt) && stone_centwt <= parseFloat(items.to_wt))

                    {

                        curRow.find('.stone_rate').val(items.rate_per_gram);

                        curRow.find('.stone_uom_id ').val(items.uom_id);

                        if(items.stone_cal_type==1)

                        {

                            curRow.find('#stone_cal_type1').attr('checked',true);

                        }

                        else

                        {

                            curRow.find('#stone_cal_type2').attr('checked',true);

                        }

                    }



                }

            }

        });

    }

}



/*function set_karigar_wise_stones(curRow)



{



    curRow.find('.stone_rate').val(0);



    if($('#select_karigar').val()!='' && $('#select_karigar').val()!=null)



    {



        $.each(karigar_stone_details,function(key,items)



        {



            if(items.id_karigar==$('#select_karigar').val() && curRow.find('.stones_type').val()==items.stone_type && curRow.find('.stone_id').val()==items.stone_id)



            {



                console.log(items);



                curRow.find('.stone_rate').val(items.rate_per_gram);



                //curRow.find('.stone_cal_type').val(items.stone_cal_type);



                curRow.find('.stone_uom_id ').val(items.uom_id);



                console.log((items.stone_cal_type==1));



                if(items.stone_cal_type==1)



                {



                    curRow.find('#stone_cal_type1').attr('checked',true);



                }



                else



                {



                    curRow.find('#stone_cal_type2').attr('checked',true);



                }



            }



        });



    }



}



*/



function create_new_stone_row()



{







    var supplier_bill_entry_calc = $('#supplier_bill_entry_calc').val();







	var stones_list = "<option value=''>-Select Stone-</option>";



	var stones_type = "<option value=''>-Stone Type-</option>";



	var uom_list = "<option value=''>-UOM-</option>";



	var quality_list = "<option value=''>-Quality-</option>";







    var clarity="";



    var color ="";



    var cut ="";



    var shape ="";



	$.each(stones, function (pkey, pitem) {



		stones_list += "<option value='"+pitem.stone_id+"'>"+pitem.stone_name+"</option>";



	});



	$.each(stone_types, function (pkey, pitem) {



		stones_type += "<option value='"+pitem.id_stone_type+"'>"+pitem.stone_type+"</option>";



	});



	$.each(uom_details, function (pkey, pitem) {



		uom_list += "<option value='"+pitem.uom_id+"'>"+pitem.uom_name+"</option>";



	});







	$.each(quality_code, function (pkey, pitem) {



		quality_list += "<option value='"+pitem.quality_id+"'>"+pitem.code+"</option>";



	});







	var length=(($('#cus_stoneModal tbody tr').length)+1);







	var row='';



        row += '<tr>'



            +'<td><input class="show_in_lwt" type="checkbox" name="est_stones_item[show_in_lwt][]" value="1" checked ></td>'



            //+'<td><select class="show_in_lwt form-control" name="est_stones_item[show_in_lwt][]" style="width:100px;"><option value="">-Select-</option><option value=1>Yes</option><option value=0>No</option></select></td>'



        	+'<td><select class="stones_type form-control" name="est_stones_item[stones_type][]">'+stones_type+'</select></td>'



			+'<td><select class="stone_id form-control" name="est_stones_item[stone_id][]"></select></td>'



			+'<td><select class="quality_id form-control" name="est_stones_item[quality_id][]" disabled >'+quality_list+'</select></td>'



			+'<td><input type="number" class="stone_pcs form-control" name="est_stones_item[stone_pcs][]" value="" style="width: 100%;"/></td>'



			+'<td><div class="input-group"><input class="stone_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="" style="width:100%;"/><span class="input-group-btn" style="width: 70px;"><select class="stone_uom_id form-control" name="est_stones_item[uom_id][]">'+uom_list+'</select></span></div></td>'



			+'<td><div class="form-group"><input class="stone_cal_type" id="stone_cal_type1" type="radio" name="est_stones_item[cal_type]['+length+']" value="1" checked="true">Wt&nbsp;<input type="radio" id="stone_cal_type2" name="est_stones_item[cal_type]['+length+']" class="stone_cal_type" value="2">Pcs</div></td>'



		    +'<td><span class="stone_cut">'+cut+'</span></td>'



			+'<td><span class="stone_color">'+color+'</span></td>'



			+'<td><span class="stone_clarity">'+clarity+'</span></td>'



			+'<td><span class="stone_shape">'+shape+'</span></td>'



			+'<td><input type="number" class="stone_rate form-control" name="est_stones_item[stone_rate][]" value="" '+(supplier_bill_entry_calc==1 ? 'disabled' :'')+' style="width:100%;"/></td>'



			+'<td><input type="number" class="stone_price form-control" name="est_stones_item[stone_price][]" value="" disabled  style="width:100%;" /></td>'



			+'<td><button type="button" class="btn btn-success btn-xs create_stone_item_details"><i class="fa fa-plus"></i></button><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-xs btn-del"><i class="fa fa-trash"></i></a></td></tr>';



	$('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').append(row);

    $('#estimation_stone_cus_item_details > tbody').find('.stones_type,.stone_id,.quality_id').select2();

    $('#estimation_stone_cus_item_details > tbody').find('.stones_type').select2({

        placeholder: "Stone Type",

        allowClear: true

    });

    $('#estimation_stone_cus_item_details > tbody').find('.stone_id').select2({

        placeholder: "Select Stone",

        allowClear: true

    });

    $('#estimation_stone_cus_item_details > tbody').find('.quality_id').select2({

        placeholder: "Quality",

        allowClear: true

    });



}



function get_stones(stone_type=""){



    stones=[];



	$.ajax({



	 	type: 'POST',



	 	url : base_url + 'index.php/admin_ret_tagging/getStoneItems',



	 	dataType : 'json',



	 	data:{'stone_type':stone_type},



	 	success  : function(data){



		 	stones = data;



		 	console.log("stones",stones);



	 	}



	});



}



function get_stone_types(){



	$.ajax({



	 	type: 'GET',



	 	url : base_url + 'index.php/admin_ret_tagging/getStoneTypes',



	 	dataType : 'json',



	 	success  : function(data){



		 	stone_types = data;



	 	}



	});



}



function get_ActiveUOM(){



	$.ajax({



	 	type: 'GET',



	 	url : base_url + 'index.php/admin_ret_tagging/get_ActiveUOM',



	 	dataType : 'json',



	 	success  : function(data){



		 	uom_details = data;



	 	}



	});



}



$(".add_po_lwt").on('click',function(){



	 openStoneModal();



});



function openStoneModal(){



    $('#cus_stoneModal').modal('show');



    $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').empty();



    if(modalStoneDetail.length > 0){



        $.each(modalStoneDetail, function (key, item) {



	        if(item)



            {



                if($('#aganist_supplier_issue').val()==1)



                {



                    Create_New_Empty_looseDiamonds_stone_row(item);



                }



                else



                {



                    create_new_empty_stone_item(item);



                }



	        }



        })



    }else{



        if($('#aganist_supplier_issue').val()==1)



        {



            Create_looseDiamonds_stone_row();



        }



        else



        {



            create_new_empty_stone_item();



        }



    }



}



function create_new_empty_stone_item(stn_data=[])



{



    console.log(stn_data);



    /*if(stn_data)



    {



        $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').empty();



    }*/



    var supplier_bill_entry_calc = $('#supplier_bill_entry_calc').val();







	var stones_list = "<option value=''> -Select Stone- </option>";



	var stones_type = "<option value=''>-Stone Type-</option>";



	var uom_list = "<option value=''>-UOM-</option>";



	var quality_list = "<option value=''>-Quality-</option>";



    var disable_quality = (stn_data ? (stn_data.stones_type == 1 ? '': 'disabled') : 'disabled');







    var clarity="";



    var color ="";



    var cut ="";



    var shape ="";







	$.each(stones, function (pkey, pitem) {



		stones_list += "<option value='"+pitem.stone_id+"' "+(stn_data ? (pitem.stone_id == stn_data.stone_id ? 'selected' : '') : '')+">"+pitem.stone_name+"</option>";



	});



	$.each(uom_details, function (pkey, pitem) {



		uom_list += "<option value='"+pitem.uom_id+"' "+(stn_data ? (pitem.uom_id == stn_data.stone_uom_id ? 'selected' : '') : '')+">"+pitem.uom_name+"</option>";



	});



	$.each(stone_types, function (pkey, pitem) {



		stones_type += "<option value='"+pitem.id_stone_type+"' "+(stn_data ? (pitem.id_stone_type == stn_data.stones_type ? 'selected' : '') : '')+">"+pitem.stone_type+"</option>";



	});







	/*$.each(quality_code, function (pkey, pitem) {



    	quality_list += "<option value='"+pitem.quality_id+"' "+(stn_data ? (pitem.quality_id == stn_data.stone_quality_id ? 'selected' : '') : '')+" >"+pitem.code+"</option>";



    });*/







    $.each(quality_code, function (pkey, pitem) {



        quality_list += "<option value='"+pitem.quality_id+"' "+(stn_data ? (pitem.quality_id == stn_data.stone_quality_id ? 'selected' : '') : '')+" >"+pitem.code+"</option>";



        if(pitem.quality_id == stn_data.stone_quality_id)



        {



            clarity=pitem.clarity;



            color=pitem.color;



            cut=pitem.cut;



            shape=pitem.shape;



        }



    });



	var show_in_lwt = (stn_data ? stn_data.show_in_lwt : 1);



	var stone_pcs = (stn_data ? (stn_data.stone_pcs == undefined ? '':stn_data.stone_pcs) : '');



	var stone_wt = (stn_data ? (stn_data.stone_wt == undefined ? '':stn_data.stone_wt) : '');



	var rate = (stn_data ? (stn_data.stone_rate == undefined ? 0:stn_data.stone_rate): 0);



	var price = (stn_data ? (stn_data.stone_price == undefined ? 0:stn_data.stone_price) : 0);



	var cal_type = (stn_data ? (stn_data.stone_cal_type == undefined ? 1:stn_data.stone_cal_type) : 1);







	var row_cls = $('#estimation_stone_cus_item_details tbody tr').length;



    row = '<tr id="'+$('#estimation_stone_cus_item_details tbody tr').length+'" class="st_'+$('#estimation_stone_cus_item_details tbody tr').length+'">'



        +'<td><input class="show_in_lwt" type="checkbox" name="est_stones_item[show_in_lwt][]" value="'+(show_in_lwt==1 || show_in_lwt == undefined? 1 : 0)+'" '+(show_in_lwt==1 || show_in_lwt == undefined ? 'checked' :'')+' ></td>'



        //+'<td><select class="show_in_lwt form-control" name="est_stones_item[show_in_lwt][]" style="width:100px;"><option value="">-Select-</option><option value=1 '+(show_in_lwt==1 ? 'selected' :'')+'>Yes</option><option value=0 '+(show_in_lwt==0 ? 'selected' :'')+'>No</option></select></td>'



        +'<td><select class="stones_type form-control" name="est_stones_item[stones_type][]" style="width:100px;">'+stones_type+'</select></td>'



        +'<td><select class="stone_id form-control" name="est_stones_item[stone_id][]" style="width:100px;">'+stones_list+'</select><input type="hidden" class="stone_type" value=""></td>'



        +'<td><select class="quality_id form-control" name="est_stones_item[quality_id][]" '+disable_quality+' style="width:100px;">'+quality_list+'</select></td>'



        +'<td><input type="number" class="stone_pcs form-control" name="est_stones_item[stone_pcs][]" value="'+stone_pcs+'" style="width: 70px;"/></td>'



        +'<td><div class="input-group"><input class="stone_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="'+stone_wt+'" style="width:70px;"/><span class="input-group-btn" style="width: 70px;"><select class="stone_uom_id form-control" name="est_stones_item[uom_id][]" style="width: 70px;">'+uom_list+'</select></span></div></td>'



        +'<td><div class="form-group"><input class="stone_cal_type" id="stone_cal_type1" type="radio" name="est_stones_item[cal_type]['+parseFloat(row_cls+1)+']" value="1" '+(cal_type == 1 ? 'checked' : '')+'>Wt&nbsp;<input type="radio" name="est_stones_item[cal_type]['+parseFloat(row_cls+1)+']" class="stone_cal_type" id="stone_cal_type2" value="2" '+(cal_type == 2 ? 'checked' : '')+'>Pcs</div></td>'



        +'<td><span class="stone_cut">'+cut+'</span></td>'



        +'<td><span class="stone_color">'+color+'</span></td>'



        +'<td><span class="stone_clarity">'+clarity+'</span></td>'



        +'<td><span class="stone_shape">'+shape+'</span></td>'



        +'<td><input type="number" class="stone_rate form-control" name="est_stones_item[stone_rate][]" value="'+rate+'" '+(supplier_bill_entry_calc==1 ? 'disabled' :'')+' style="width: 100px;" /></td>'



        +'<td><input type="number" class="stone_price form-control" name="est_stones_item[stone_price][]" value="'+price+'" disabled style="width: 100px;" /></td>'



        +'<td><button type="button" class="btn btn-success btn-xs create_stone_item_details"><i class="fa fa-plus"></i></button><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-xs btn-del"><i class="fa fa-trash"></i></a></td></tr>';



    $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').append(row);



	//$('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody .st_'+row_cls+ '.show_in_lwt').focus();



	$("#cus_stoneModal").on('shown.bs.modal', function(){



    });



	$('#custom_active_id').val("st_"+row_cls);

    $('#estimation_stone_cus_item_details > tbody').find('.stones_type,.stone_id,.quality_id').select2();

        $('#estimation_stone_cus_item_details > tbody').find('.stones_type').select2({

            placeholder: "Stone Type",

            allowClear: true

        });

        $('#estimation_stone_cus_item_details > tbody').find('.stone_id').select2({

            placeholder: "Select Stone",

            allowClear: true

        });

        $('#estimation_stone_cus_item_details > tbody').find('.quality_id').select2({

            placeholder: "Quality",

            allowClear: true

        });



}



$(document).on('change','.quality_id',function(){



    curRow = $(this).closest('tr');



    var stone_quality_id = curRow.find('.quality_id').val();



    $.each(quality_code, function (pkey, pitem) {



        if(pitem.quality_id == stone_quality_id)



        {



             curRow.find('.stone_clarity').html(pitem.clarity);



             curRow.find('.stone_color').html(pitem.color);



             curRow.find('.stone_cut').html(pitem.cut);



             curRow.find('.stone_shape').html(pitem.shape);



        }



    });



});



function validateStoneCusItemDetailRow(){



	var row_validate = true;



	$('#cus_stoneModal .modal-body #estimation_stone_cus_item_details> tbody  > tr').each(function(index, tr) {



		if($(this).find('.stone_id').val() == "" || $(this).find('.stone_pcs').val() == "" || $(this).find('.stone_wt').val() == "" || $(this).find('.stone_rate').val() == "" || $(this).find('.stone_price').val() == "" || $(this).find('.stone_uom_id').val() == "" ){



			row_validate = false;



		}



	});



	return row_validate;



}



$(document).on('input',".stone_rate",function()



{



    calculate_stone_amount();



});



$(document).on('input','.stone_pcs',function()

{

    var row = $(this).closest('tr');

    if(ctrl_page[1]=='qc_issue_receipt' || ctrl_page[1]=='halmarking_issue_receipt')

    {

        var act_stone_pcs  = row.find('.act_stone_pcs').val();

        if(parseFloat(this.value) > parseFloat(act_stone_pcs))

        {

            row.find('.stone_pcs').val(act_stone_pcs);

			$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br> Entered Stone pcs must not greater than Actual stone pcs"});

        }

        else

        {

            row.find('.stone_pcs').val(this.value);

        }

    }

    if(ctrl_page[2]=='purchase_add')

    {

        set_karigar_wise_stones(row);

    }



    calculate_stone_amount();



});



$(document).on('change','.stone_wt',function()



{



    var row = $(this).closest('tr');



    if(ctrl_page[1]=='qc_issue_receipt' || ctrl_page[1]=='halmarking_issue_receipt')



    {



        var act_stone_wt  = row.find('.act_stone_wgt').val();



        if(parseFloat(this.value) > parseFloat(act_stone_wt))



        {



            row.find('.stone_wt').val(parseFloat(act_stone_wt).toFixed(3));



			$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br> Entered Stone wgt must not greater than Actual stone wgt"});



        }



        else



        {



            row.find('.stone_wt').val(this.value);



        }



    }



    if(ctrl_page[2]=='purchase_add')



    {



        set_karigar_wise_stones(row);



    }



    calculate_stone_amount();



});



$(document).on('change','.stone_uom_id',function()



{



    calculate_stone_amount();



});



$(document).on('#pur_return_stone_item_details tbody input',".stone_pcs,.stone_wt,.stone_rate",function(){



    calculate_return_stone_amount();



});



$(document).on('change',".stone_cal_type",function(){



     $('#estimation_stone_cus_item_details > tbody tr').each(function(idx, row){



        curRow = $(this);



        if(curRow.find('input[type=radio]:checked').val() == 1){



            // curRow.find('.stone_wt').attr('readonly', false);



            // curRow.find('.stone_uom_id').attr('disabled', false);



        }else{



            // curRow.find('.stone_wt').val(0);



            // curRow.find('.stone_wt').attr('readonly', true);



            //  curRow.find('.stone_uom_id').attr('disabled', true);



        }



     });



    calculate_stone_amount();



});



function calculate_stone_amount()



{



     $('#estimation_stone_cus_item_details > tbody tr').each(function(idx, row){



         curRow = $(this);



         var stone_amt=0;



         var stone_pcs  = (isNaN(curRow.find('.stone_pcs').val()) || curRow.find('.stone_pcs').val() == '')  ? 0 : curRow.find('.stone_pcs').val();



         var stone_wt  = (isNaN(curRow.find('.stone_wt').val()) || curRow.find('.stone_wt').val() == '')  ? 0 : curRow.find('.stone_wt').val();



         var stone_rate  = (isNaN(curRow.find('.stone_rate').val()) || curRow.find('.stone_rate').val() == '')  ? 0 : curRow.find('.stone_rate').val();



         //stone_amt = parseFloat(parseFloat(stone_wt)*parseFloat(stone_rate)).toFixed(2);







         if(curRow.find('input[type=radio]:checked').val() == 1){



            stone_amt = parseFloat(parseFloat(stone_wt)*parseFloat(stone_rate)).toFixed(2);



         }else{



           stone_amt = parseFloat(parseInt(stone_pcs)*parseFloat(stone_rate)).toFixed(2);



         }







         curRow.find('.stone_price').val(stone_amt);



     });



     calculate_total_stone_amount();



}



function calculate_total_stone_amount(){



    var stone_pcs   = 0;



    var stone_wt    = 0;



    var stone_price     = 0;



    $('#estimation_stone_cus_item_details > tbody tr').each(function(idx, row){



        curRow = $(this);



        stone_pcs+= parseFloat((isNaN(curRow.find('.stone_pcs').val()) || curRow.find('.stone_pcs').val() == '')  ? 0 : curRow.find('.stone_pcs').val());



        if(curRow.find('.stone_uom_id').val()==6) // for Diamnond Stones



        {



            stone_wt +=parseFloat((isNaN(curRow.find('.stone_wt').val()) || curRow.find('.stone_wt').val() == '')  ? 0 : curRow.find('.stone_wt').val() / 5);



        }



        else



        {



            stone_wt +=parseFloat((isNaN(curRow.find('.stone_wt').val()) || curRow.find('.stone_wt').val() == '')  ? 0 : curRow.find('.stone_wt').val());



        }



        stone_price  +=parseFloat((isNaN(curRow.find('.stone_price ').val()) || curRow.find('.stone_price ').val() == '')  ? 0 : curRow.find('.stone_price ').val());



    });



    $('.stn_tot_pcs').html(parseFloat(stone_pcs));



    $('.stn_tot_weight').html(parseFloat(stone_wt).toFixed(3));



    $('.stn_tot_amount').html(parseFloat(stone_price ).toFixed(3));



}



function remove_stone_row(curRow)



{

    curRow.remove();

    if(ctrl_page[2]=='purchase_add'){

        calculate_stone_amount();

    }else if(ctrl_page[1]=='lot_generate'){

        total_stone_amount();

    }

}



function calculate_return_stone_amount()



{



     $('#pur_return_stone_item_details > tbody tr').each(function(idx, row){



         curRow = $(this);



         var stone_amt=0;



         var stone_pcs  = (isNaN(curRow.find('.stone_pcs').val()) || curRow.find('.stone_pcs').val() == '')  ? 0 : curRow.find('.stone_pcs').val();



         var stone_wt  = (isNaN(curRow.find('.stone_wt').val()) || curRow.find('.stone_wt').val() == '')  ? 0 : curRow.find('.stone_wt').val();



         var stone_rate  = (isNaN(curRow.find('.stone_rate').val()) || curRow.find('.stone_rate').val() == '')  ? 0 : curRow.find('.stone_rate').val();



         //stone_amt = parseFloat(parseFloat(stone_wt)*parseFloat(stone_rate)).toFixed(2);







         if(curRow.find('input[type=radio]:checked').val() == 1){



            stone_amt = parseFloat(parseFloat(stone_wt)*parseFloat(stone_rate)).toFixed(2);



         }else{



           stone_amt = parseFloat(parseInt(stone_pcs)*parseFloat(stone_rate)).toFixed(2);



         }







         curRow.find('.stone_price').val(stone_amt);



     });



}



$('#cus_stoneModal .modal-body #create_stone_item_details').on('click', function(){



if(validateStoneCusItemDetailRow()){



			create_new_empty_stone_entry_row();



		}else{



			alert("Please fill required fields");



		}



});



function create_new_empty_stone_entry_row()



{



    var row = "";



	var stones_list = "<option value=''>-Select Stone-</option>";



	var stones_type = "<option value=''>-Stone Type-</option>";



	var uom_list = "<option value=''>-Stone UOM-</option>";



    var quality_list = "<option value=''>-Quality-</option>";



    var disable_quality =  'disabled';



    var clarity="";



    var color ="";



    var cut ="";



    var shape ="";



	$.each(stones, function (pkey, pitem) {



		stones_list += "<option value='"+pitem.stone_id+"'>"+pitem.stone_name+"</option>";



	});







	$.each(stone_types, function (pkey, pitem) {



		stones_type += "<option value='"+pitem.id_stone_type+"'>"+pitem.stone_type+"</option>";



	});







	$.each(uom_details, function (pkey, pitem) {



		var selected = pitem.is_default == 1 ? "selected='selected'" : "";



		uom_list += "<option value='"+pitem.uom_id+"' "+selected+">"+pitem.uom_name+"</option>";



	});



    $.each(quality_code, function (pkey, pitem) {



        quality_list += "<option value='"+pitem.quality_id+"'>"+pitem.code+"</option>";



    });



	var rowId = $('#estimation_stone_cus_item_details tbody tr').length;



	var active_row = new Date().getTime();



        row += '<tr id="'+active_row+'">'



        	+'<td><input class="show_in_lwt" type="checkbox"name="est_stones_item[show_in_lwt][]" value="1" checked></td>'



        	+'<td><select class="stones_type form-control" name="est_stones_item[stones_type][]">'+stones_type+'</select></td>'



			+'<td><select class="stone_id form-control" name="est_stones_item[stone_id][]"></select></td>'



            +'<td><select class="quality_id form-control" name="est_stones_item[quality_id][]" '+disable_quality+' style="width:80px;">'+quality_list+'</select></td>'



			+'<td><input type="number" class="stone_pcs form-control" name="est_stones_item[stone_pcs][]" value="" style="width: 100%;"/></td>'



			+'<td><div class="input-group"><input class="stone_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="" style="width:100%;"/><span class="input-group-btn" style="width: 70px;"><select class="stone_uom_id form-control" name="est_stones_item[uom_id][]">'+uom_list+'</select></span></div></td>'



			+'<td><div class="form-group"><input class="stone_cal_type" type="radio" name="est_stones_item[cal_type]['+rowId+']" value="1" checked="true"> By Wt&nbsp;<input type="radio" name="est_stones_item[cal_type]['+rowId+']" class="stone_cal_type" value="2">By Pcs</div></td>'



            +'<td><span class="stone_cut">'+cut+'</span></td>'



            +'<td><span class="stone_color">'+color+'</span></td>'



            +'<td><span class="stone_clarity">'+clarity+'</span></td>'



            +'<td><span class="stone_shape">'+shape+'</span></td>'



			+'<td><input type="number" class="stone_rate form-control" name="est_stones_item[stone_rate][]" value=""  style="width:100%;"/></td>'



			+'<td><input type="number" class="stone_price form-control" name="est_stones_item[stone_price][]" value=""  style="width:100%;"/></td>'



			+'<td><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td></tr>';



	$('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').append(row);



}



$('#cus_stoneModal  #update_return_stn_details').on('click', function(){



	if(validateStoneCusItemDetailRow())



	{



    	var stone_details       =[];



    	var stone_price         =0;



    	var stone_wt            =0;



    	var certification_price =0;



    	var stone_wt            = 0;



        var less_wt            = 0;



    	var catRow              =$('#custom_active_id').val();



    	if(ctrl_page[1] != 'qc_issue_receipt')



    	{



    	    var gross_wt            =$('#'+catRow).find('.gross_wt').val();



    	}else if(ctrl_page[1] == 'karigarmetalissue')



        {



            var gross_wt            =$('#'+catRow).find('.issue_weight').val();



        }else{



    	    var gross_wt            =$('#'+catRow).find('.qc_issue_gross_wt').val();



    	}







    	$('#cus_stoneModal .modal-body #estimation_stone_cus_item_details > tbody  > tr').each(function(index, tr) {



    	    var curRow = $(this);



    		stone_price+=parseFloat(curRow.find('.stone_price').val());



    		var uom_id = curRow.find('.stone_uom_id').val();







        		$.each(uom_details,function(key,item){







                         if(item.uom_id==uom_id)



                         {



                             if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                             {



                                 stone_wt+=parseFloat(parseFloat(curRow.find('.stone_wt').val())/parseFloat(item.divided_by_value));



                                 if(curRow.find('.show_in_lwt').val()== 1){

                                    less_wt+=parseFloat(parseFloat(curRow.find('.stone_wt').val())/parseFloat(item.divided_by_value));

                                 }



                             }else{



                                if(curRow.find('.show_in_lwt').val()== 1){

                                    less_wt+=parseFloat(curRow.find('.stone_wt').val());

                                 }



                                 stone_wt+=parseFloat(curRow.find('.stone_wt').val());



                             }







                         }



        		});











        		stone_details.push({



        		            'show_in_lwt'       : curRow.find('.show_in_lwt').val(),



        		            'stone_id'          : curRow.find('.stone_id').val(),



        		            'stones_type'       : curRow.find('.stones_type').val(),



        		            'stone_pcs'         : curRow.find('.stone_pcs').val(),



        		            'stone_wt'          : curRow.find('.stone_wt').val(),



        		            'stone_cal_type'    : curRow.find("input[type='radio'][class='stone_cal_type']:checked").val(),



        		            'stone_price'       : curRow.find('.stone_price').val(),



        		            'stone_rate'        : curRow.find('.stone_rate').val(),



        		            'stone_type'        : curRow.find('.stone_type').val(),



        		            'stone_uom_id'      : curRow.find('.stone_uom_id').val(),



                            'po_st_id'           : curRow.find('.po_st_id').val()



        		});



    	});



    	if(parseFloat(gross_wt)<parseFloat(stone_wt))



    	{



    	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Entered Weight is Grater Than The Gross Wt."});



    	}



    	else



    	{



            $('#cus_stoneModal').modal('toggle');



            $('#'+catRow).find('.ret_add_stone_wt').val(parseFloat(stone_price).toFixed(2));



            $('#'+catRow).find('.stone_details').val(JSON.stringify(stone_details));



            var row = $('.'+catRow).closest('tr');



            $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').empty();







            if(ctrl_page[1] == 'purchasereturn' && ctrl_page[2] == 'add')



            {



               calculate_purchase_return_item_cost();



            }



            if(ctrl_page[1] == 'qc_issue_receipt')



            {



               $('#'+catRow).find('.add_less_wt').val(parseFloat(stone_wt).toFixed(3));



               $('#'+catRow).find('.qc_issue_less_wt').val(parseFloat(stone_wt).toFixed(3));



               calculate_qu_issue_row_details();



            }



            if(ctrl_page[1] == 'karigarmetalissue')



            {

    

                $('#'+catRow).find('.issue_less_wt').val(parseFloat(less_wt).toFixed(3));



                calculateRepairMetalIssuePureWt();

            }



        }







    }



    else



    {



    	$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Fill The Required Fields.."});



    }



});



$('#cus_stoneModal  #update_stone_details').on('click', function(){



	if(validateStoneCusItemDetailRow())



    {



    	var stone_details=[];



    	var stone_price=0;



    	var certification_price=0;



    	var tag_less_wgt = 0;



    	var tot_stone_wt  			= 0;



    	modalStoneDetail = []; // Reset Old Value of stone modal



    	var tot_gwt = $('#tot_gwt').val();



    	$('#cus_stoneModal .modal-body #estimation_stone_cus_item_details> tbody  > tr').each(function(index, tr) {



    		stone_price+=parseFloat($(this).find('.stone_price').val());







    		stone_details.push({



    		            'show_in_lwt'       : $(this).find('.show_in_lwt').val(),



    		            'stone_id'          : $(this).find('.stone_id').val(),



    		            'stones_type'       : $(this).find('.stones_type').val(),



    		            'stone_pcs'         : $(this).find('.stone_pcs').val(),



    		            'stone_wt'          : $(this).find('.stone_wt').val(),



    		            'stone_cal_type'    : $(this).find("input[type='radio'][class='stone_cal_type']:checked").val(),



    		            'stone_price'       : $(this).find('.stone_price').val(),



    		            'stone_rate'        : $(this).find('.stone_rate').val(),



    		            'stone_type'        : $(this).find('.stone_type').val(),



    		            'stone_uom_id'      : $(this).find('.stone_uom_id').val(),



    		            'stone_name'        : $(this).find('.stone_id :selected').text(),



    		            'stone_quality_id'  : $(this).find('.quality_id').val(),



                        'issue_met_id'      : $(this).find('.issue_met_id').val(),



                        'product_name'      : $(this).find('.pro_name').val(),



    		});



    	});



    	modalStoneDetail = stone_details;















            if(stone_details.length>0)



            {



                 $.each(stone_details, function (pkey, pitem) {



                     $.each(uom_details,function(key,item){



                         var stone_wt = 0;



                         if(item.uom_id==pitem.stone_uom_id)



                         {







                             if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                             {



                                 stone_wt=parseFloat(parseFloat(pitem.stone_wt)/parseFloat(item.divided_by_value));



                             }else{



                                 stone_wt=pitem.stone_wt;



                             }



                             tot_stone_wt+=parseFloat(stone_wt);



                            if(parseInt(pitem.show_in_lwt) == 1){



                                tag_less_wgt+=parseFloat(stone_wt);



                        	}



                         }



                     });











                 });



            }





        if(ctrl_page[1]=='metal_issue_receipt'){



            curRow_stn.find('.stone_details').val(JSON.stringify(modalStoneDetail));



            curRow_stn.find('.receipt_lwt').val(parseFloat(tag_less_wgt).toFixed(3));



            gross_wt = isNaN(curRow_stn.find('.receipt_gwt').val()) ? 0 : curRow_stn.find('.receipt_gwt').val();



            //   curRow_stn.find('.receipt_nwt').val(parseFloat(tag_less_wgt).toFixed(3));

            net_wt =  gross_wt - tag_less_wgt;



            //curRow_stn.find('.receipt_nwt').val(parseFloat(gross_wt - tag_less_wgt).toFixed(3));



            if(net_wt < 0){



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>You Have Entered More Than The Gross Weight.."});



            }else{

 

            calculateMetalRes_row();



            $('#cus_stoneModal').modal('hide');



            }







        }

    	else if(parseFloat(tot_gwt)<parseFloat(tot_stone_wt))



    	{



    	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>You Have Entered More Than The Gross Weight.."});



    	}else{



    	    $("#tot_lwt").val(parseFloat(tag_less_wgt).toFixed(3));



        	$("#stone_price").val(parseFloat(stone_price).toFixed(2));



        	$("#stone_details").val(JSON.stringify(stone_details));



        	calculate_purchase_item_cost();



            $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').empty();



            $('#cus_stoneModal').modal('hide');



            $('#tot_wastage_perc').focus();



    	}











    }



    else



    {



    	alert('Please Fill The Required Details');



    }



});



//Other Charges



//Quality Control Details



function get_qc_issue_purchase_orders(status)



{



    $(".overlay").css('display','block');



	$.ajax({



		type: 'GET',



		url: base_url+'index.php/admin_ret_purchase/qc_issue_receipt/purchase_issue',



		dataType:'json',



		success:function(data){



            var po_id =  $('#select_po_ref_no').val();



            po_itemdetails=data;



            $.each(data, function (key, item) {



                $('#select_po_ref_no').append(



                $("<option></option>")



                .attr("value", item.po_id)



                .text(item.po_ref_no)



                );



            });







            $("#select_po_ref_no").select2({



                placeholder: "Select PO Ref No",



                allowClear: true



            });







            $("#select_po_ref_no").select2("val",(po_id!='' && po_id>0?po_id:''));



            $(".overlay").css("display", "none");



		}



	});



}



function get_qc_receipt_purchase_orders()



{



    $(".overlay").css('display','block');



	$.ajax({



		type: 'GET',



		url: base_url+'index.php/admin_ret_purchase/qc_issue_receipt/purchase_receipt',



		dataType:'json',



		success:function(data){



            var po_id =  $('#select_ref_no').val();



            po_itemdetails=data;



            $.each(data, function (key, item) {



                $('#select_ref_no').append(



                $("<option></option>")



                .attr("value", item.qc_process_id)



                .text(item.ref_no)



                );



            });







            $("#select_ref_no").select2({



                placeholder: "Select PO Ref No",



                allowClear: true



            });







            $("#select_ref_no").select2("val",(po_id!='' && po_id>0?po_id:''));



            $(".overlay").css("display", "none");



		}



	});



}



$('#select_po_ref_no').on('change',function(){



   var po_id = this.value;



   if(this.value!='')



   {



       if(ctrl_page[1]=='qc_issue_receipt' && ctrl_page[2]=='add')



       {



           set_qc_issue_preview_detaails(this.value);



       }



       else if(ctrl_page[1]=='qc_issue_receipt' && ctrl_page[2]=='qc_entry')



       {



           $('#po_item_search').trigger('click');



       }



       else if(ctrl_page[1]=='halmarking_issue_receipt' && ctrl_page[2]=='add')



       {



           set_purchase_order_item_detaails(this.value);



       }



       else if(ctrl_page[1] == 'purchasereturn' && ctrl_page[2] == 'add')



       {



           get_qc_rejected_details_by_poid(this.value);



       }



       else if(ctrl_page[1] == 'rate_fixing' && (ctrl_page[2] == 'add'))



       {



           set_po_rate_fix_details(this.value);



       }



       else if(ctrl_page[1] == 'lot_generate' && ctrl_page[2] == 'add')



       {



           set_lot_generate_items(this.value);



       }



       else if(ctrl_page[1] == 'supplier_rate_cut' && ctrl_page[2] == 'add')



       {



            reset_supplier_rate_cut_form();



            set_rate_cut_details();



       }



   }



});



function set_rate_cut_details()



{



    var po_id = $('#select_po_ref_no').val();



    var convert_to = $("input[name='supplier_rate_cut[convert_to]']:checked").val(); //1-Bill,2-Receipt



    $.each(approval_ratefix_po_detail,function(key,val){



        if(val.po_id==po_id && val.fin_year_code == $('#pur_fin_year_select').val())



        {



            $('#wt_balance').val(parseFloat(Math.abs(val.item_pure_wt)).toFixed(3));



            $('#amt_balance').val(parseFloat(Math.abs(val.total_amount)).toFixed(3));



            if(val.item_pure_wt < 0){



                $('#wt_balance_type').val(1);



                $('.weight_bln_type').html("(Cr)");



            }else{



                $('#wt_balance_type').val(2);



                $('.weight_bln_type').html("(Dr)");



            }



        }



    });



    calculation_supplier_rate_cut();



}



$('#select_karigar').on('change',function(){



	if(this.value!='')



    {



		if(ctrl_page[1] == 'purchasereturn' && ctrl_page[2] == 'add')



		{







		     insertedcatdetails=[];



             purchasereturnitemlist = [];



             returntaggeditemlist = [];



             nontagreturnitemlist = [];







		    $('#select_po_ref_no').prop('disabled',false);



		    $('#tag_number').prop('disabled',false);



		    $('#old_tag_number').prop('disabled',false);



		    $('#select_product').prop('disabled',false);



		    $('#tag_history_search').prop('disabled',false);



		    $('#return_item_detail > tbody').empty();



		    $('#item_detail > tbody').empty();



		    get_karigar_details(this.value);



            get_tds_percent(this.value);





		    returnitemlist = [];



		    //updatereturncategory();



		    get_return_item_po_ref_nos();



		    get_purchase_return_total();



		    calculate_purchase_return_item_cost();



            //get_qc_rejected_details_by_supid(this.value);



		}



		else if(ctrl_page[2]=='order_delivery')



		{



		    get_karigar_pending_orders();



		}



		else if(ctrl_page[2]=='purchase_add')



		{



		    if($("input[type='radio'][name='order[purchase_type]']:checked").val() == 1){



		        get_karigar_pending_orders();



		    }



		    get_karigar_details(this.value);



            get_tds_percent(this.value);





		    if($('#supplier_bill_entry_calc').val()==1){ // MC And V.A From Supplier Master



		        $('#mc_value').prop('disabled', true);



                $('#purchase_touch').prop('disabled', true);



                $('#tot_wastage_perc').prop('disabled', true);



                $('#mc_type').prop('disabled', true);



                $('#karigar_calc_type').prop('disabled', true);



		        set_karigar_wise_charges(this.value);



                get_karigar_wise_wastage();



                get_karigar_wise_stones();



		    }else{



                $('#mc_value').prop('disabled', false);



                $('#purchase_touch').prop('disabled', false);



                $('#tot_wastage_perc').prop('disabled', false);



                $('#mc_type').prop('disabled', false);



                $('#karigar_calc_type').prop('disabled', false);



		    }







		}else if(ctrl_page[1] == 'supplier_po_payment' && ctrl_page[2] == 'add')



		{



           get_supplier_pay_details(this.value);



		}



		else if(ctrl_page[1] == 'rate_fixing' && (ctrl_page[2] == 'add' || ctrl_page[2] == 'edit'))



		{



		    get_rate_fixing_po_no();



		}else if(ctrl_page[1] == 'karigarmetalissue' && ctrl_page[2] == 'add')



		{



		    get_supplier_pay_details(this.value);



		}else if(ctrl_page[1] == 'supplier_rate_cut' && ctrl_page[2] == 'add')



		{



		    var src_type = $("input[name='supplier_rate_cut[rate_cut_type]']:checked").val();



		    var is_opening_blc = $("input[name='supplier_rate_cut[is_opening_blc]']:checked").val();



            reset_supplier_rate_cut_form();



            if(is_opening_blc==0){



                get_approval_rate_fixing_po_no();



            }else{



                opening_balance_ratefixing();



            }



		}



		else if(ctrl_page[1] == 'rate_fixing' && ctrl_page[2] == 'approval_rate_fixing_add'  )



		{



		    get_approvl_ratefix_po();



		}



	}



});



function get_karigar_details(karId){



     $(".overlay").css('display','block');



    	my_Date = new Date();



		$.ajax({



    		url:base_url+ "index.php/admin_ret_purchase/get_karigar_details?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



            data: {'karId': karId},



            type:"POST",



            dataType:"JSON",



            success:function(data)



            {



                if(ctrl_page[1]=='purchasereturn')



                {



                         $('#ret_karigar_calc_type').val(data.karigar_calc_type);



                }



                else



                {



                    karigar_details = data;



                    console.log("karigar_details", karigar_details);



                    $("#tcs_percent").val(data.tcs_tax);



                    $("#tds_percent").val(data.tds_tax);



                    $("#supplier_country").val(data.id_country);



                    $("#supplier_state").val(data.id_state);



                    if(ctrl_page[2]=='purchase_add')



                    {



                        $('#karigar_calc_type').val(data.karigar_calc_type);



                    }







                }







             	$(".overlay").css("display", "none");



            },



            error:function(error)



            {



            }



    	});



}



function get_ActiveEmployee()



{



    $('#emp_select option').remove();



		my_Date = new Date();



		$.ajax({



		url:base_url+ "index.php/admin_ret_estimation/get_employee?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data: {'id_branch':''},



        type:"POST",



        dataType:"JSON",



        success:function(data)



        {



           var id_employee=$('#emp_select').val();



           $.each(data, function (key, item) {



                	 	$("#emp_select").append(



                	 	$("<option></option>")



                	 	.attr("value", item.id_employee)



                	 	.text(item.emp_name)



                	 	);



                 	});



             	$("#emp_select").select2({



            	 	placeholder: "Select Employee",



            	 	allowClear: true



             	});



         	    $("#emp_select").select2("val",(id_employee!='' && id_employee>0?id_employee:''));



         	    $(".overlay").css("display", "none");



        },



        error:function(error)



        {



        }



    	});



}



function set_qc_issue_preview_detaails(po_id)



{



    $(".overlay").css("display", "block");







        my_Date = new Date();



		$.ajax({



		url:base_url+ "index.php/admin_ret_purchase/qc_issue_receipt/qc_item_details?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data: {'po_id':po_id,'fin_year':$('#pur_fin_year_select').val()},



        type:"POST",



        dataType:"JSON",



        success:function(data)



        {



                $('#item_detail tbody').empty();



                var rowExists=false;



                var trHtml='';



                $.each(data,function(key,items){



                    $('#item_detail > tbody tr').each(function(bidx, brow){



                        curRow = $(this);



                        if(curRow.find('.po_item_id').val()==items.po_item_id)



                        {



                            rowExists=true;



                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                        }



                    });



                    if(!rowExists)



                    {



                        var other_metal_weight = 0;



                        $.each(items.other_metal_details,function(k,val)

                        {

                            other_metal_weight+=parseFloat(val.po_other_mt_wt);

                        })



                        var stone_details = [];



                        var stone_pcs = 0;



                        var stone_wt = 0;



                        $.each(items.stone_details,function(k,stnval){



                            stone_pcs+=parseFloat(stnval.po_stone_pcs);



                            $.each(uom_details,function(key,item){



                                     if(item.uom_id==stnval.po_stone_uom && stnval.is_apply_in_lwt==1)



                                     {



                                         if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                                         {



                                             stone_wt+=parseFloat(parseFloat(stnval.po_stone_wt)/parseFloat(item.divided_by_value));



                                         }else{







                                             stone_wt+=parseFloat(stnval.po_stone_wt);



                                         }



                                     }



                    		});



                            stone_details.push({



                                'po_st_id'          : stnval.po_st_id,



                                'show_in_lwt'       : stnval.is_apply_in_lwt,



            		            'stones_type'       : stnval.stone_type,



            		            'stone_uom_id'      : stnval.po_stone_uom,



            		            'stone_id'          : stnval.po_stone_id,



            		            'stone_pcs'         : stnval.po_stone_pcs,



            		            'stone_wt'          : stnval.po_stone_wt,



            		            'stone_cal_type'    : stnval.po_stone_calc_based_on,



            		            'stone_price'       : stnval.po_stone_amount,



            		            'stone_rate'        : stnval.po_stone_rate,



                                'stone_quality_id'  : stnval.po_quality_id,



                                'bal_act_stone_pcs' : 0,







                                'bal_act_stone_wt'  : 0,



                            });



                        });



                        var id =  parseFloat($('#item_detail > tbody > tr').length+1);



                        trHtml='<tr id="'+id+'">'



                        +'<td><input type="checkbox" class="qc_item_select" name="qc_item_select[]" value="1" checked/><input type="hidden" class="po_item_id" name="po_item_id[]" value="'+items.po_item_id+'" />'+items.po_ref_no+'</td>'



                        +'<td>'+items.karigar_name+'</td>'



                        +'<td>'+items.product_name+'</td>'



                        +'<td>'+items.design_name+'</td>'



                        +'<td>'+items.sub_design_name+'</td>'



                        +'<td><input type="number" class="form-control qc_issue_pcs" value="'+items.no_of_pcs+'"><input type="hidden" class="act_pcs" value="'+items.no_of_pcs+'">Avail Pcs :'+items.no_of_pcs+'</td>'



                        +'<td><input type="number" class="form-control qc_issue_gross_wt" value="'+items.gross_wt+'"><input type="hidden" class="act_gwt" value="'+items.gross_wt+'">'+items.gross_wt+'</td>'



                        /*+'<td><input type="number" class="form-control qc_issue_less_wt" value="'+items.less_wt+'">'+items.less_wt+'</td>'*/



                        +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_less_wt" value="'+ parseFloat(stone_wt).toFixed(3) +'" onClick="create_new_empty_qc_issue_stone_item($(this).closest(\'tr\'));"  type="number" name="item[less_wt][]" step="any" readonly /><span class="input-group-addon input-sm add_tag_lwt" onClick="create_new_empty_qc_issue_stone_item($(this).closest(\'tr\'));">+</span></div><input type="hidden" class="stone_details" value=\''+JSON.stringify(stone_details)+'\'><input type="hidden" class="qc_issue_less_wt" value="'+ parseFloat(stone_wt).toFixed(3) +'"></div></td>'



                        +'<td><input type="number" class="form-control qc_issue_net_wt" value="'+items.net_wt+'" disabled><input type="hidden" class="act_nwt" value="'+items.net_wt+'"><input type="hidden" class="othr_mt_wt" value="'+parseFloat(other_metal_weight).toFixed(3)+'">'+items.net_wt+'</td>'



                        +'<td><a href="#" onClick="remove_qc_item($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



                        +'</tr>';



                        if($('#item_detail > tbody  > tr').length>0)



                        {



                            $('#item_detail > tbody > tr:first').before(trHtml);



                        }else{



                            $('#item_detail tbody').append(trHtml);



                        }



                    }



                });











                calculate_qu_issue_row_details();



                //$('#select_po_ref_no').val("");



         	    $(".overlay").css("display", "none");



        },



        error:function(error)



        {



        }



    	});











    $(".overlay").css("display", "none");



}



$('#cus_stoneModal  #update_issue_stn_details').on('click', function(){



	if(validateStoneCusItemDetailRow())



	{



    	var stone_details       =[];



    	var stone_price         =0;



    	var stone_wt            =0;



    	var certification_price =0;



    	var stone_wt            = 0;



    	var catRow              =$('#custom_active_id').val();



        var tot_lwt             = 0;



    	if(ctrl_page[1] != 'qc_issue_receipt')



    	{



    	    var gross_wt            =$('#'+catRow).find('.gross_wt').val();



    	}



        else



        {



    	    var gross_wt            =$('#'+catRow).find('.qc_issue_gross_wt').val();



    	}







    	$('#cus_stoneModal .modal-body #estimation_stone_cus_item_details > tbody  > tr').each(function(index, tr)



        {



    	    var curRow = $(this);



    		stone_price+=parseFloat(curRow.find('.stone_price').val());



            stone_details.push({



                'show_in_lwt'       : curRow.find('.show_in_lwt').val(),



                'po_st_id'          : curRow.find('.po_st_id').val(),



                'stone_id'          : curRow.find('.stone_id').val(),



                'stones_type'       : curRow.find('.stones_type').val(),



                'stone_pcs'         : curRow.find('.stone_pcs').val(),



                'stone_wt'          : curRow.find('.stone_wt').val(),



                'stone_cal_type'    : curRow.find("input[type='radio'][class='stone_cal_type']:checked").val(),



                'stone_price'       : curRow.find('.stone_price').val(),



                'stone_rate'        : curRow.find('.stone_rate').val(),



                'stone_type'        : curRow.find('.stone_type').val(),



                'stone_uom_id'      : curRow.find('.stone_uom_id').val()



            });



    	});



        console.log('stone_details',stone_details);



        if(stone_details.length>0)



        {



            $.each(stone_details, function (pkey, pitem) {



                $.each(uom_details,function(key,item){







                    if(item.uom_id==pitem.stone_uom_id)



                    {



                        if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                        {



                            stone_wt=parseFloat(parseFloat(pitem.stone_wt)/parseFloat(item.divided_by_value));



                        }else



                        {



                            stone_wt=parseFloat(pitem.stone_wt);



                        }



                        if(parseInt(pitem.show_in_lwt)==1)



                        {



                            tot_lwt +=parseFloat(stone_wt);



                        }



                    }



                });



            });



        }







    	if(parseFloat(gross_wt)<parseFloat(stone_wt))



    	{



    	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Entered Weight is Grater Than The Gross Wt."});



    	}



    	else



    	{



            $('#cus_stoneModal').modal('toggle');



            $('#'+catRow).find('.ret_add_stone_wt').val(parseFloat(stone_price).toFixed(2));



            $('#'+catRow).find('.stone_details').val(JSON.stringify(stone_details));



            var row = $('.'+catRow).closest('tr');



            $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').empty();







            if(ctrl_page[1] == 'purchasereturn' && ctrl_page[2] == 'add')



            {



               calculate_purchase_return_item_cost();



            }



            if(ctrl_page[1] == 'qc_issue_receipt' && ctrl_page[2] == 'add')



            {



               $('#'+catRow).find('.add_less_wt').val(parseFloat(tot_lwt).toFixed(3));



               $('#'+catRow).find('.qc_issue_less_wt').val(parseFloat(tot_lwt).toFixed(3));



               calculate_qu_issue_row_details();



            }



        }







    }



    else



    {



    	$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Fill The Required Fields.."});



    }



});



function create_new_empty_qc_issue_stone_item(curRow,id)



{







    $('#estimation_stone_cus_item_details tbody').empty();



	if(curRow!=undefined)



	{



		$('#custom_active_id').val(curRow.closest('tr').attr('id'));



	}



	var row = "";



		var catRow=$('#custom_active_id').val();







		console.log(catRow);



		var row_st_details=$('#'+catRow).find('.stone_details').val();



		if(row_st_details !='' && row_st_details != '[]' && curRow != undefined)



		{



			var stone_details   = JSON.parse(row_st_details);



			console.log(stone_details);



			$.each(stone_details, function (pkey, pitem) {



	 			var stones_list='';



	 			var stones_type_list='';



	 			var uom_list='';



	 			var html='';



                var quality_list ='';



                var disable_quality = (pitem.stones_type == 1 ? '': 'disabled');



                var clarity="";



                var color ="";



                var cut ="";



                var shape ="";



	 			var cal_type = pitem.stone_cal_type;



				$.each(stones, function (pkey, item)



				{



					var selected = "";



					if(item.stone_id == pitem.stone_id)



					{



						selected = "selected='selected'";



					}



					stones_list += "<option value='"+item.stone_id+"' "+selected+">"+item.stone_name+"</option>";



				});











				$.each(stone_types, function (pkey, item) {



				    var st_type_selected = "";



				    if(item.id_stone_type == pitem.stones_type)



					{



						st_type_selected = "selected='selected'";



					}



				    stones_type_list += "<option value='"+item.id_stone_type+"' "+st_type_selected+">"+item.stone_type+"</option>";



    			});







    			$.each(uom_details, function (pkey, item) {



    			     var uom_selected = "";



    			    if(item.uom_id == pitem.stone_uom_id)



					{



						uom_selected = "selected='selected'";



					}



    				uom_list += "<option value='"+item.uom_id+"' "+uom_selected+">"+item.uom_name+"</option>";



    			});



                $.each(quality_code, function (pkey, item) {



                    quality_list += "<option value='"+pitem.stone_quality_id+"' "+(item.quality_id == pitem.stone_quality_id ? 'selected' : '') +" >"+item.code+"</option>";



                    if(item.quality_id == pitem.stone_quality_id)



                    {



                        clarity=item.clarity;



                        color=item.color;



                        cut=item.cut;



                        shape=item.shape;



                    }



                });



                var act_stone_pcs = (parseInt(pitem.bal_act_stone_pcs) > 0 ? parseInt(pitem.bal_act_stone_pcs) : parseInt(pitem.stone_pcs));



                var act_stone_wt  = (parseFloat(pitem.bal_act_stone_wt) > 0 ? parseFloat(pitem.bal_act_stone_wt).toFixed(3) : parseFloat(pitem.stone_wt).toFixed(3));







				row += '<tr>'



                	+'<td><input type="hidden" class="po_st_id" value="'+pitem.po_st_id+'"><input class="show_in_lwt" type="checkbox" name="est_stones_item[show_in_lwt][]" value="'+(pitem.show_in_lwt==1 ? 1:0)+'" '+(pitem.show_in_lwt==1 ? 'checked' :'' )+' disabled></td>'



                	+'<td><select class="stones_type form-control" name="est_stones_item[stones_type][]"  disabled style="width:80px;">'+stones_type_list+'</select></td>'



					+'<td><select class="stone_id form-control" name="est_stones_item[stone_id][]"  disabled style="width:80px;">'+stones_list+'</select></td>'



                    +'<td><select class="quality_id form-control" name="est_stones_item[quality_id][]" disabled style="width:80px;">'+quality_list+'</select></td>'



					+'<td><input type="number" class="stone_pcs form-control" name="est_stones_item[stone_pcs][]"  value="'+pitem['stone_pcs']+'" style="width: 70px;" /><input type="hidden" class="act_stone_pcs" value="'+act_stone_pcs+'"></td>'



					+'<td><div class="input-group"><input class="stone_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="'+pitem['stone_wt']+'" style="width:70px;" /><input type="hidden" class="act_stone_wgt" value="'+act_stone_wt+'"><span class="input-group-btn" style="width: 70px;"><select class="stone_uom_id form-control" name="est_stones_item[uom_id][]"  style="width: 70px;">'+uom_list+'</select></span></div></td>'



					+'<td><div class="form-group"><input class="stone_cal_type" type="radio" name="est_stones_item[cal_type]['+pkey+']" value="1" '+(cal_type == 1 ? 'checked' : '')+'> By Wt&nbsp;<input type="radio"  name="est_stones_item[cal_type]['+pkey+']" '+(cal_type == 2 ? 'checked' : '')+' class="stone_cal_type" value="2">By Pcs</div></td>'



                    +'<td><span class="stone_cut">'+cut+'</span></td>'



                    +'<td><span class="stone_color">'+color+'</span></td>'



                    +'<td><span class="stone_clarity">'+clarity+'</span></td>'



                    +'<td><span class="stone_shape">'+shape+'</span></td>'



					+'<td><input type="number" class="stone_rate form-control" name="est_stones_item[stone_rate][]" value="'+pitem['stone_rate']+'"  style="width:80px;" disabled /></td>'



					+'<td><input type="number" class="stone_price form-control" name="est_stones_item[stone_price][]" value="'+pitem['stone_price']+'"  style="width:80px;" disabled /></td>'



					+'<td><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td></tr>';



			});







		}



	$('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').append(row);



	$('#cus_stoneModal').modal('show');







}



function remove_qc_item(curRow)



{



    curRow.remove();



    calculate_qu_issue_row_details();



}



$(document).on('change',".qc_item_select",function(){



    if($(this).is(":checked"))



    {



        $(this).closest('tr').find('.qc_item_select').val(1);



    }else{



        $(this).closest('tr').find('.qc_item_select').val(0);



    }



    if(ctrl_page[1]=='qc_issue_receipt' && ctrl_page[2]=='add')



    {



        calculate_qu_issue_row_details();



    }



});



$(document).on('change',".qc_issue_pcs",function(){



    var curRow = $(this).closest('tr');



    var act_pcs = parseFloat(isNaN(curRow.find('.act_pcs').val()) || curRow.find('.act_pcs')=='' ? 0 :curRow.find('.act_pcs').val());



    var qc_issue_pcs = parseFloat(isNaN(curRow.find('.qc_issue_pcs').val()) || curRow.find('.qc_issue_pcs')=='' ? 0 :curRow.find('.qc_issue_pcs').val());



    if(parseFloat(qc_issue_pcs)>parseFloat(act_pcs))



    {



        $(this).closest('tr').find('.qc_issue_pcs').focus();



		$(this).closest('tr').find('.qc_issue_pcs').val(act_pcs);



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>You Have Entered More than the Available Pcs.."});



    }



});



$(document).on('change',".qc_issue_gross_wt",function(){



    var curRow = $(this).closest('tr');



    var act_gwt = parseFloat(isNaN(curRow.find('.act_gwt').val()) || curRow.find('.act_gwt')=='' ? 0 :curRow.find('.act_gwt').val());



    var qc_issue_less_wt = parseFloat(isNaN(curRow.find('.qc_issue_less_wt').val()) || curRow.find('.qc_issue_less_wt')=='' ? 0 :curRow.find('.qc_issue_less_wt').val());



    var qc_issue_gross_wt = parseFloat(isNaN(curRow.find('.qc_issue_gross_wt').val()) || curRow.find('.qc_issue_gross_wt')=='' ? 0 :curRow.find('.qc_issue_gross_wt').val());



    if(parseFloat(qc_issue_gross_wt)>parseFloat(act_gwt))



    {



        $(this).closest('tr').find('.qc_issue_gross_wt').focus();



		$(this).closest('tr').find('.qc_issue_gross_wt').val(parseFloat(act_gwt).toFixed(3));



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</brYou Have Entered More than the Available Gross weight.."});



    }



    else if(parseFloat(qc_issue_gross_wt)<parseFloat(qc_issue_less_wt))



    {



        $(this).closest('tr').find('.qc_issue_gross_wt').focus();



		$(this).closest('tr').find('.qc_issue_gross_wt').val(parseFloat(act_gwt).toFixed(3));



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</brYou Have Entered More than the Available Gross weight.."});



    }



    else{



        var net_wt = parseFloat(qc_issue_gross_wt)-parseFloat(qc_issue_less_wt);



        $(this).closest('tr').find('.qc_issue_net_wt').val(parseFloat(net_wt).toFixed(3));



    }



    calculate_qu_issue_row_details();



});



function calculate_qu_issue_row_details()



{



    var total_pcs=0;



    var total_gwt=0;



    var total_lwt=0;



    var total_nwt=0;



    $('#item_detail > tbody tr').each(function(bidx, brow){



        curRow = $(this);



        if(curRow.find('.qc_item_select').val()==1)



        {



                var qc_issue_gross_wt = parseFloat(isNaN(curRow.find('.qc_issue_gross_wt').val()) || curRow.find('.qc_issue_gross_wt')=='' ? 0 :curRow.find('.qc_issue_gross_wt').val());



                var qc_issue_lwt = parseFloat(isNaN(curRow.find('.qc_issue_less_wt').val()) || curRow.find('.qc_issue_less_wt')=='' ? 0 :curRow.find('.qc_issue_less_wt').val());



                var qc_other_mt_wt =  parseFloat(isNaN(curRow.find('.othr_mt_wt').val()) || curRow.find('.othr_mt_wt')=='' ? 0 :curRow.find('.othr_mt_wt').val());



                var net_wt = parseFloat(parseFloat(qc_issue_gross_wt)-parseFloat(qc_issue_lwt)-parseFloat(qc_other_mt_wt)).toFixed(3);







                if(parseFloat(qc_issue_gross_wt)<parseFloat(qc_issue_lwt))



                {



                    $(this).closest('tr').find('.qc_issue_gross_wt').focus();



            		$(this).closest('tr').find('.qc_issue_gross_wt').val(parseFloat(act_gwt).toFixed(3));



            		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</brYou Have Entered More than the Available Gross weight.."});



                }else



                {



                    curRow.find('.qc_issue_net_wt').val(net_wt);



                    total_pcs+=parseFloat(isNaN(curRow.find('.qc_issue_pcs').val()) || curRow.find('.qc_issue_pcs')=='' ? 0 :curRow.find('.qc_issue_pcs').val());



                    total_gwt+=parseFloat(isNaN(curRow.find('.qc_issue_gross_wt').val()) || curRow.find('.qc_issue_gross_wt')=='' ? 0 :curRow.find('.qc_issue_gross_wt').val());



                    total_lwt+=parseFloat(isNaN(curRow.find('.qc_issue_less_wt').val()) || curRow.find('.qc_issue_less_wt')=='' ? 0 :curRow.find('.qc_issue_less_wt').val());



                    total_nwt+=parseFloat(isNaN(curRow.find('.qc_issue_net_wt').val()) || curRow.find('.qc_issue_net_wt').val()=='' ? 0 :curRow.find('.qc_issue_net_wt').val());



                }











        }







    });



    $('.total_pcs').html(parseFloat(total_pcs));



    $('.total_gwt').html(parseFloat(total_gwt).toFixed(3));



    $('.total_lwt').html(parseFloat(total_lwt).toFixed(3));



    $('.total_nwt').html(parseFloat(total_nwt).toFixed(3));



}



$('#qc_issue_submit').on('click',function(){



    $("div.overlay").css("display", "block");



    if($('#emp_select').val()=='' || $('#emp_select').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Employee."});



        $("div.overlay").css("display", "none");



    }



    else if($('#item_detail > tbody >tr').length==0)



    {



         $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found."});



         $("div.overlay").css("display", "none");



    }



    else



    {



        $('#qc_issue_submit').prop('disabled',true);



        var req_data=[];



          var selected = [];



            var approve=false;



            $("#item_detail tbody tr").each(function(index, value)



            {



                if($(value).find(".qc_item_select").val()==1)



                {



                    transData = {



                    'po_item_id'        : $(value).find(".po_item_id").val(),



                    'qc_issue_pcs'      : $(value).find(".qc_issue_pcs").val(),



                    'qc_issue_gross_wt' : $(value).find(".qc_issue_gross_wt").val(),



                    'qc_issue_less_wt'  : $(value).find(".qc_issue_less_wt").val(),



                    'qc_issue_net_wt'   : $(value).find(".qc_issue_net_wt").val(),



                    'stone_details'     : $(value).find(".stone_details").val(),



                    }



                    selected.push(transData);



                }







            });



            req_data = selected;



            if(selected.length > 0)



            {



                update_qc_issue(req_data);



            }



            else{



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records to Update.."});



                $("div.overlay").css("display", "none");



            }



    }



});



function update_qc_issue(req_data)



{



    my_Date = new Date();



    $("div.overlay").css("display", "block");







    if($('#qc_process_id').val()!='')



    {



        var url = base_url+ "index.php/admin_ret_purchase/qc_issue_update?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours();



    }



    else



    {



        var url = base_url+ "index.php/admin_ret_purchase/update_qc_issue?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours();



    }







    $.ajax({



        url:url,



        data:  {'req_data':req_data,'id_employee':$('#emp_select').val(),'total_pcs':$('.total_pcs').html(),'total_gwt':$('.total_gwt').html(),'total_lwt':$('.total_lwt').html(),'total_nwt':$('.total_nwt').html(),'qc_process_id':$('#qc_process_id').val()},



        type:"POST",



        async:false,



        success:function(data)



        {



                $('#update_qc_status').prop('disabled',false);



                window.location.href= base_url+'index.php/admin_ret_purchase/qc_issue_receipt/list';



                $("div.overlay").css("display", "none");



        },



        error:function(error)



        {



            $("div.overlay").css("display", "none");



        }



    });



}



$('#search_qc_issue_details').on('click',function(){



    get_qc_issue_details();



});



function get_qc_issue_details()



{



    var company_name = $('#company_name').val();



	var report_name = "QC ISSUE/RECEIPT LIST";



	var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"



		+ "<span>" + report_print('','','','','') + "</span>";







    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



	 url:base_url+ "index.php/admin_ret_purchase/qc_issue_receipt/ajax?nocache=" + my_Date.getUTCSeconds(),



	 dataType:"JSON",



	 data:{'from_date':$('#rpt_from_date').html(),'to_date':$('#rpt_to_date').html()},



	 type:"POST",



	 success:function(data){



	 	var list=data.list;



        var access = data.access;



		var oTable = $('#item_list').DataTable();



		oTable.clear().draw();



		if (list!= null && list.length > 0)



		{



			oTable = $('#item_list').dataTable({



            "bDestroy": true,



            "bInfo": true,



            "bFilter": true,



            "bSort": true,



            "order": [[ 0, "desc" ]],



            "dom": 'lBfrtip',



        	"buttons": [



					{



						extend: 'print',



						footer: true,



						title: '',



						messageTop: title,



						customize: function (win) {



							$(win.document.body).find('table')



								.addClass('compact');



							$(win.document.body).find('table')



								.addClass('compact')



								.css('font-size', '10px')



								.css('font-family', 'sans-serif');



						},



						exportOptions: {



							columns: ':visible',



							stripHtml: false



						}



					},



					{



						extend: 'excel',



						footer: true,



						title: 'QC ISSUE/RECEIPT LIST',



					}



				],



        	"columnDefs": [



					{



						targets: [4,5, 6, 7, 8, 9, 10],



						className: 'dt-body-right'



					},







				],



            "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



            "aaData": list,



            "aoColumns": [



                { "mDataProp": "qc_process_id" },



                { "mDataProp": "ref_no" },



                { "mDataProp": "issue_date" },



                { "mDataProp": "po_ref_no" },



                { "mDataProp": "karigar" },



                { "mDataProp": "empname" },



                {



    				"mDataProp": function (row, type, val, meta) {



    					return money_format_india(row.issue_pcs);



    				}



    			},



    			{



    				"mDataProp": function (row, type, val, meta) {



    					return money_format_india(row.issue_gross_wt);



    				}



    			},



    			{



    				"mDataProp": function (row, type, val, meta) {



    					return money_format_india(row.issue_less_wt);



    				}



    			},



    			{



    				"mDataProp": function (row, type, val, meta) {



    					return money_format_india(row.issue_net_wt);



    				}



    			},



    			{



    				"mDataProp": function (row, type, val, meta) {



    					return money_format_india(row.recd_gross_wt);



    				}



    			},



    			{



    				"mDataProp": function (row, type, val, meta) {



    					return money_format_india(row.recd_lwt);



    				}



    			},



    			{



    				"mDataProp": function (row, type, val, meta) {



    					return money_format_india(row.recd_nwt);



    				}



    			},



    			{



					"mDataProp": null,



					"sClass": "control center",



					"sDefaultContent": '<span class="drill-val"><i class="fa fa-chevron-circle-down text-teal"></i></span>'



				},



                {



                    "mDataProp": function ( row, type, val, meta )



                    {



                        id=row.qc_process_id;



                        edit_target=(access.edit=='0'?"":"#confirm-edit");



                        edit_url=(base_url+'index.php/admin_ret_purchase/qc_issue_receipt/qc_issue_edit/'+id);



                        edit_receipt_url = (base_url+'index.php/admin_ret_purchase/qc_issue_receipt/qc_receipt_edit/'+id);



                        action_content=(row.status==0 && access.edit == 1 ? '<a href="'+edit_url+'" class="btn btn-info btn-edit" data-id='+id+' title="QC Issue Edit"><i class="fa fa-edit"></i></a>' :(row.is_lot_created==0 &&access.edit == 1 ? '<a href="'+edit_receipt_url+'" class="btn btn-primary btn-edit" data-id='+id+' title="QC Receipt Edit"><i class="fa fa-edit"></i></a>':""))+(access.delete == 1 ? '<button class="btn btn-warning" onclick="delete_reason('+id+')"><i class="fa fa-close" ></i></button>':'');



                        return action_content;



                    }



                }







              ],



            "footerCallback": function( row, data, start, end, display )



			{



				if(data.length>0){



					var api = this.api(), data;



					for( var i=0; i<=data.length-1;i++){



						var intVal = function ( i ) {



							return typeof i === 'string' ?



							i.replace(/[\$,]/g, '')*1 :



							typeof i === 'number' ?



							i : 0;



						};







						$(api.column(0).footer() ).html('Total');



						issue_pcs = api



						.column(6)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(6).footer()).html(money_format_india(parseFloat(issue_pcs).toFixed(2)));







						issue_gwt = api



						.column(7)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(7).footer()).html(money_format_india(parseFloat(issue_gwt).toFixed(3)));







						issue_lwt = api



						.column(8)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(8).footer()).html(money_format_india(parseFloat(issue_lwt).toFixed(3)));







						issue_nwt = api



						.column(9)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(9).footer()).html(money_format_india(parseFloat(issue_nwt).toFixed(3)));







						recd_gwt = api



						.column(10)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(10).footer()).html(money_format_india(parseFloat(recd_gwt).toFixed(3)));







						recd_lwt = api



						.column(11)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(11).footer()).html(money_format_india(parseFloat(recd_lwt).toFixed(3)));







						recd_nwt = api



						.column(12)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(12).footer()).html(money_format_india(parseFloat(recd_nwt).toFixed(3)));







				}



				}else{



					 var api = this.api(), data;



					 $(api.column(11).footer()).html('');



					 $(api.column(12).footer()).html('');



					 $(api.column(6).footer()).html('');



					 $(api.column(7).footer()).html('');



					 $(api.column(8).footer()).html('');



					 $(api.column(9).footer()).html('');



					 $(api.column(10).footer()).html('');



				}



			}



            });



            var anOpen = [];



			$(document).on('click', "#item_list .control", function () {



				var nTr = this.parentNode;



				var i = $.inArray(nTr, anOpen);



				if (i === -1) {



					$('.drill-val', this).html('<i class="fa fa-chevron-circle-up text-teal"></i>');



					oTable.fnOpen(nTr, fnFormatRowQcissueDetails(oTable, nTr), 'details');



					anOpen.push(nTr);



				}



				else {



					$('.drill-val', this).html('<i class="fa fa-chevron-circle-down text-teal"></i>');



					oTable.fnClose(nTr);



					anOpen.splice(i, 1);



				}



			});







		}



		$("div.overlay").css("display", "none");



	  },



	  error:function(error)



	  {



		 $("div.overlay").css("display", "none");



	  }



  });



}



function fnFormatRowQcissueDetails(oTable, nTr) {



	var oData = oTable.fnGetData(nTr);



	var rowDetail = '';



	var prodTable =



		'<div class="innerDetails">' +



		'<table class="table table-responsive table-bordered text-center table-sm">' +



		'<tr class="bg-teal">' +



		'<th>S.No</th>' +



		'<th>PO NO</th>' +



		'<th>Product</th>' +



		'<th>Design</th>' +



		'<th>Sub Design</th>' +



		'<th style="text-align:right;">Pcs </th>' +



		'<th style="text-align:right;">G.wt </th>' +



		'<th style="text-align:right;">N.wt </th>' +



		'</tr>';



	var item_details = oData.item_details;



	$.each(item_details, function (idx, val) {



		prodTable +=



			'<tr class="prod_det_btn">' +



			'<td>' + parseFloat(idx + 1) + '</td>' +



			'<td>' + val.po_ref_no + '</td>' +



			'<td>' + val.product_name + '</td>' +



			'<td>' + val.design_name + '</td>' +



			'<td>' + val.sub_design_name + '</td>' +



			'<td style="text-align:right;">' + money_format_india(val.passed_pcs) + '</td>' +



			'<td style="text-align:right;">' + money_format_india(val.passed_gwt) + '</td>' +



			'<td style="text-align:right;">' + money_format_india(val.passed_nwt) + '</td>' +



			'</tr>';



	});



	rowDetail = prodTable + '</table></div>';



	return rowDetail;



}



//Halmarking Issue / Receipt



function get_pending_halmarking_items(status)



{



    $(".overlay").css('display','block');



	$.ajax({



		type: 'GET',



		url: base_url+'index.php/admin_ret_purchase/halmarking_issue_receipt/get_pending_halmarking_items',



		dataType:'json',



		success:function(data){



            var po_id =  $('#select_po_ref_no').val();



            po_itemdetails=data;



            $.each(data, function (key, item) {



                $('#select_po_ref_no').append(



                $("<option></option>")



                .attr("value", item.po_id)



                .text(item.po_ref_no)



                );



            });







            $("#select_po_ref_no").select2({



                placeholder: "Select PO Ref No",



                allowClear: true



            });







            $("#select_po_ref_no").select2("val",(po_id!='' && po_id>0?po_id:''));



            $(".overlay").css("display", "none");



		}



	});



}



function set_purchase_order_item_detaails(po_id)



{



    $('#item_detail tbody').empty();



    $(".overlay").css("display", "block");







    $.each(po_itemdetails,function(key,val){



       if(val.po_id==po_id)



       {



           var rowExists=false;



           var trHtml='';



			$.each(val.item_details,function(key,items){



			        $('#item_detail > tbody tr').each(function(bidx, brow){



                    curRow = $(this);



                        if(curRow.find('.po_item_id').val()==items.po_item_id)



    					{



    					    rowExists=true;



    					    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



    					}



                   });



               if(!rowExists)



                {

                    var stone_wt = 0;

                    var stone_pcs = 0;

                    var stone_details = [];



                    

                    $.each(items.stone_details,function(k,stnval)



                    {



                        stone_pcs+=parseFloat(stnval.qc_passed_pcs);



                        $.each(uom_details,function(key,item){



                            if(item.uom_id==stnval.po_stone_uom && stnval.is_apply_in_lwt==1)



                            {



                                if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                                {



                                    stone_wt+=parseFloat(parseFloat(stnval.stone_wt)/parseFloat(item.divided_by_value));



                                }else{







                                    stone_wt+=parseFloat(stnval.stone_wt);



                                }



                            }



                        });



                        stone_details.push({



                            'po_st_id'          : stnval.po_st_id,



                            'show_in_lwt'       : stnval.is_apply_in_lwt,



                            'stones_type'       : stnval.stone_type,



                            'stone_uom_id'      : stnval.po_stone_uom,



                            'stone_id'          : stnval.po_stone_id,



                            'stone_pcs'         : stnval.stone_pcs,



                            'stone_wt'          : stnval.stone_wt,



                            'stone_cal_type'    : stnval.po_stone_calc_based_on,



                            'stone_price'       : stnval.po_stone_amount,



                            'stone_rate'        : stnval.po_stone_rate,



                            'stone_quality_id'  : stnval.po_quality_id,



                            'bal_act_stone_pcs' : 0,



                            'bal_act_stone_wt'  : 0,



                        });



                    });

                    var id =  parseFloat($('#item_detail > tbody > tr').length+1);



    				trHtml='<tr id="'+id+'">'



                    +'<td><input type="checkbox" class="po_item_id" name="po_item_id[]" value="'+items.po_item_id+'" checked/><input type="hidden" class="po_id" name="po_id[]" value="'+val.po_id+'" /><input type="hidden" class="id_qc_issue_details" name="id_qc_issue_details[]" value="'+items.id_qc_issue_details+'">'+items.po_ref_no+'</td>'



                    +'<td>'+items.karigar_name+'</td>'



                    +'<td>'+items.product_name+'</td>'



                    +'<td>'+items.design_name+'</td>'



                    +'<td>'+items.sub_design_name+'</td>'



                    +'<td><input type="number" class="form-control no_of_pcs" value="'+items.no_of_pcs+'"><input type="hidden" class="act_qc_pcs" value="'+items.no_of_pcs+'">Avail Pcs :'+items.no_of_pcs+'</td>'



                    //+'<td><input type="hidden" class="no_of_pcs" value="'+items.no_of_pcs+'">'+items.no_of_pcs+'</td>'



                    +'<td><input type="number" class="form-control gross_wt" value="'+items.gross_wt+'"><input type="hidden" class="act_qc_gwt" value="'+items.gross_wt+'">'+items.gross_wt+'</td>'



                    //+'<td><input type="hidden" class="gross_wt" value="'+items.gross_wt+'">'+items.gross_wt+'</td>'



                    +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_less_wt" value="'+ parseFloat(stone_wt).toFixed(3) +'" onClick="create_new_empty_hm_issue_stone_item($(this).closest(\'tr\'));"  type="number" name="item[less_wt][]" step="any" readonly /><span class="input-group-addon input-sm add_tag_lwt" onClick="create_new_empty_hm_issue_stone_item($(this).closest(\'tr\'));">+</span></div><input type="hidden" class="stone_details" value=\''+JSON.stringify(stone_details)+'\'><input type="hidden" class="less_wt" value="'+ parseFloat(stone_wt).toFixed(3) +'"></div></td>'





                    //+'<td><input type="hidden" class="less_wt" value="'+items.less_wt+'">'+items.less_wt+'</td>'



                    +'<td><input type="number" class="form-control net_wt" value="'+items.net_wt+'" disabled><input type="hidden" class="act_qc_nwt" value="'+items.net_wt+'">'+items.net_wt+'</td>'



                    //+'<td><input type="hidden" class="net_wt" value="'+items.net_wt+'">'+items.net_wt+'</td>'



                    +'<td><a href="#" onClick="remove_hm_item($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



                    +'</tr>';



			    }



			});



            if($('#item_detail > tbody  > tr').length>0)



        	{



        	    $('#item_detail > tbody > tr:first').before(trHtml);



        	}else{



        	    $('#item_detail tbody').append(trHtml);



        	}



        	calculate_halmarking_issue_row_details();



        	$('#select_po_ref_no').val("");







       }



    });



    $(".overlay").css("display", "none");



}



function calculate_halmarking_issue_row_details()



{



    var total_pcs=0;



    var total_gwt=0;



    var total_lwt=0;



    var total_nwt=0;



    $('#item_detail > tbody tr').each(function(bidx, brow){



        curRow = $(this);



        total_pcs+=parseFloat(isNaN(curRow.find('.no_of_pcs').val()) || curRow.find('.no_of_pcs')=='' ? 0 :curRow.find('.no_of_pcs').val());



        total_gwt+=parseFloat(isNaN(curRow.find('.gross_wt').val()) || curRow.find('.gross_wt')=='' ? 0 :curRow.find('.gross_wt').val());



        total_lwt+=parseFloat(isNaN(curRow.find('.less_wt').val()) || curRow.find('.less_wt')=='' ? 0 :curRow.find('.less_wt').val());



        total_nwt+=parseFloat(isNaN(curRow.find('.net_wt').val()) || curRow.find('.net_wt')=='' ? 0 :curRow.find('.net_wt').val());



    });



    $('.total_pcs').html(parseFloat(total_pcs));



    $('.total_gwt').html(parseFloat(total_gwt).toFixed(3));



    $('.total_lwt').html(parseFloat(total_lwt).toFixed(3));



    $('.total_nwt').html(parseFloat(total_nwt).toFixed(3));



}



$('#halmarking_issue').on('click',function(){



    if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Karigar."});



    }



    else



    {



        $('#halmarking_issue').prop('disabled',true);



        var req_data=[];



         if($("input[name='po_item_id[]']:checked").val())



         {



            var selected = [];



            var approve=false;



            $("#item_detail tbody tr").each(function(index, value)



            {



                if($(value).find("input[name='po_item_id[]']:checked").is(":checked"))



                {



                    transData = {



                    'po_item_id'   : $(value).find(".po_item_id").val(),



                    'po_id'        : $(value).find(".po_id").val(),



                    "hm_issue_pcs" : $(value).find(".no_of_pcs").val(),



                    "hm_issue_gwt" : $(value).find(".gross_wt").val(),



                    "hm_issue_nwt" : $(value).find(".net_wt").val(),



                    "hm_issue_lwt" : $(value).find(".less_wt").val(),



                    "id_qc_issue_details" : $(value).find(".id_qc_issue_details").val(),



                    'stone_details'     : $(value).find(".stone_details").val(),





                    }



                    selected.push(transData);



                }



            });



            req_data = selected;



            update_halmarking_issue(req_data);



         }else



         {



             $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select The Any One Items."});



         }



    }



});



function update_halmarking_issue(req_data)



{



    my_Date = new Date();



    $("div.overlay").css("display", "block");



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/update_halmarking_issue?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data:  {'req_data':req_data,'id_karigar':$('#select_karigar').val(),'total_pcs':$('.total_pcs').html(),'total_gwt':$('.total_gwt').html(),'total_lwt':$('.total_lwt').html(),'total_nwt':$('.total_nwt').html()},



        type:"POST",



        async:false,



        dataType:'json',



        success:function(data){



                if(data.status)



                {



                    $('#halmarking_issue').prop('disabled',false);



                    window.location.href= base_url+'index.php/admin_ret_purchase/halmarking_issue_receipt/list';



                    $("div.overlay").css("display", "none");



                }else



                {



                    $('#halmarking_issue').prop('disabled',false);



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                }







        },



        error:function(error)



        {



        $("div.overlay").css("display", "none");



        }



    });



}



function get_halmarking_issue_details()



{



    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



	 url:base_url+ "index.php/admin_ret_purchase/halmarking_issue_receipt/ajax?nocache=" + my_Date.getUTCSeconds(),



	 dataType:"JSON",



	 type:"POST",



	 success:function(data){



	 	var list=data.list;



		var oTable = $('#item_list').DataTable();



		oTable.clear().draw();



		if (list!= null && list.length > 0)



		{



			oTable = $('#item_list').dataTable({



            "bDestroy": true,



            "bInfo": true,



            "bFilter": true,



            "bSort": true,



            "order": [[ 0, "desc" ]],



            "dom": 'lBfrtip',



            "buttons" : ['excel','print'],



            "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



            "aaData": list,



            "aoColumns": [



                { "mDataProp": "hm_ref_no" },



                { "mDataProp": "issue_date" },



                { "mDataProp": "karigar_name" },



                { "mDataProp": "hm_process_pcs" },



                { "mDataProp": "hm_process_gwt" },



                { "mDataProp": "hm_process_lwt" },



                { "mDataProp": "hm_process_nwt" },



                { "mDataProp": "total_hm_charges" },



                { "mDataProp": function ( row, type, val, meta ){



                return '<span class="badge bg-'+(row.status==1 ? 'red' :'green')+'">'+row.hm_status+'</span>';



                },



                },



              ]



            });







		}



		$("div.overlay").css("display", "none");



	  },



	  error:function(error)



	  {



		 $("div.overlay").css("display", "none");



	  }



  });



}



function get_halmarking_issue_orders()



{



     $(".overlay").css('display','block');



	$.ajax({



		type: 'GET',



		url: base_url+'index.php/admin_ret_purchase/halmarking_issue_receipt/get_halmarking_issue_orders',



		dataType:'json',



		success:function(data){



            var po_id =  $('#select_hm_ref_no').val();



            hm_itemdetails=data;



            $.each(data, function (key, item) {



                $('#select_hm_ref_no').append(



                $("<option></option>")



                .attr("value", item.hm_process_id)



                .text(item.hm_ref_no)



                );



            });







            $("#select_hm_ref_no").select2({



                placeholder: "Select HM Ref No",



                allowClear: true



            });







            $("#select_hm_ref_no").select2("val",(po_id!='' && po_id>0?po_id:''));



            $(".overlay").css("display", "none");



		}



	});



}



$('#select_hm_ref_no').on('change',function(){



    if(this.value!='')



    {



         if(ctrl_page[2]=='hm_receipt')



        {



            set_halmarking_issue_details();



        }



    }







});



function set_halmarking_issue_details()



{



    $('#item_detail > tbody').empty();



    var trHtml='';



    $.each(hm_itemdetails,function(key,val){



        if(val.hm_process_id==$('#select_hm_ref_no').val())



        {



            $.each(val.item_details,function(key,items){



                let stone_details=JSON.stringify(items.stone_details);



                var id = parseFloat($('#item_detail > tbody tr').length+1);



                    trHtml+='<tr id='+id+' class="'+items.po_item_id+'">'



                        +'<td><input type="hidden" class="po_item_id" value="'+items.po_item_id+'"><input type="hidden" class="hm_receipt_id" value="'+items.hm_receipt_id+'">'+items.hm_receipt_id+'</td>'



                        +'<td>'+items.product_name+'</td>'



                        +'<td>'+items.design_name+'</td>'



                        +'<td>'+items.sub_design_name+'</td>'



                        +'<td><input type="hidden" class="hm_issue_pcs" value="'+items.pcs+'">'+items.pcs+'</td>'



                        +'<td><input type="hidden" class="hm_issue_gwt" value="'+items.gross_wt+'">'+items.gross_wt+'</td>'



                        +'<td><input type="hidden" class="hm_issue_lwt" value="'+items.less_wt+'">'+items.less_wt+'</td>'



                        +'<td><input type="hidden" class="hm_issue_nwt" value="'+items.net_wt+'">'+items.net_wt+'</td>'



                        +'<td><input type="number" name="order_items[hm_rejected_pcs][]" class="form-control hm_rejected_pcs" value="0" style="width: 80px;"></td>'



        	            +'<td><input type="number" name="order_items[hm_rejected_gwt][]" class="form-control hm_rejected_gwt" value="0" style="width: 80px;"></td>'



			            // +'<td><input type="hidden" class="stone_details" name="order_items[stone_details][]" value='+stone_details+'>'+((items.stone_details).length>0 ? '<a href="#" onClick="create_new_empty_po_stone_items($(this).closest(\'tr\'));" class="btn btn-success  btn-sm"><i class="fa fa-plus"></i></a>' : '-')+'</td>'



                        +'<td><div class="form-group" style="width: 100px;"><div class="input-group "><input class="form-control custom-inp failed_lwt" name="order_items[failed_lwt][]" value="" onClick="create_new_empty_po_stone_items($(this).closest(\'tr\'));"  type="number" name="item[less_wt][]" step="any" readonly /><span class="input-group-addon input-sm add_tag_lwt" onClick="create_new_empty_po_stone_items($(this).closest(\'tr\'));">+</span></div><input type="hidden" name="order_items[stone_details][]" class="stone_details" value=\''+(stone_details)+'\' ><input type="hidden" class="hm_rejected_lwt" value=""></div></td>'



        	            +'<td><input type="number" name="order_items[hm_rejected_nwt][]" class="form-control hm_rejected_nwt" value="0" readonly style="width: 80px;"></td>'



    			        +'<td><input type="number" name="order_items[hm_received_pcs][]" class="form-control hm_received_pcs" value="'+items.pcs+'"  style="width: 80px;" readonly></td>'



    			        +'<td><input type="number" name="order_items[hm_received_gwt][]" class="form-control hm_received_gwt" value="'+items.gross_wt+'"  style="width: 80px;" readonly></td>'



    			        +'<td><input type="number" name="order_items[hm_received_lwt][]" class="form-control hm_received_lwt" value="'+items.less_wt+'"  style="width: 80px;" readonly></td>'



    			        +'<td><input type="number" name="order_items[hm_received_nwt][]" class="form-control hm_received_nwt" value="'+items.net_wt+'"  style="width: 80px;" readonly></td>'



    			        +'<td><input type="number" name="order_items[hm_charges][]" class="form-control hm_charges" value="0" style="width: 80px;"></td>'



    			        +'<td><input type="number" name="order_items[hm_total_amount][]" class="form-control total_amount" value="0" style="width: 80px;" readonly></td>'



                    '</tr>';



            });



        }



    });



    if($('#item_detail > tbody  > tr').length>0)



	{



	    $('#item_detail > tbody > tr:first').before(trHtml);



	}else{



	    $('#item_detail tbody').append(trHtml);



	}



	calculate_halmarking_receipt_row_details();



}



$(document).on('keyup','.hm_rejected_pcs',function(e){



    var row = $(this).closest('tr');



    var tot_pcs=row.find('.hm_issue_pcs').val();



    var failed_pcs=row.find('.hm_rejected_pcs').val();



    if(parseFloat(tot_pcs)<parseFloat(failed_pcs))



    {



        row.find('.hm_rejected_pcs').val('');



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Pieces."});



    }



    calculate_halmarking_receipt_row_details();



});



$(document).on('keyup','.hm_rejected_gwt',function(e){



    var row = $(this).closest('tr');



    var gross_wt=row.find('.hm_issue_gwt').val();



    var failed_wt=row.find('.hm_rejected_gwt').val();



    if(parseFloat(gross_wt)<parseFloat(failed_wt))



    {



        row.find('.hm_rejected_gwt').val(0);



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Weight."});



    }



    calculate_halmarking_receipt_row_details();



});



$(document).on('keyup','.hm_charges',function(e){



    calculate_halmarking_receipt_row_details();



});



function calculate_halmarking_receipt_row_details()



{



    var total_issue_pcs=0;



    var total_issue_gwt=0;



    var total_issue_lwt=0;



    var total_issue_nwt=0;







    var total_rejected_pcs=0;



    var total_rejected_gwt=0;



    var total_rejected_lwt=0;



    var total_rejected_nwt=0;







    $('#item_detail > tbody tr').each(function(bidx, brow){



        curRow = $(this);







        var stone_Details  = JSON.parse(curRow.find('.stone_details').val());



        var rejected_stn_wt =0;



         $.each(stone_Details,function(k,stn){



            rejected_stn_wt+=parseFloat(stn.po_stone_rejected_wt);



         });







        var hm_charges=parseFloat(isNaN(curRow.find('.hm_charges').val()) || curRow.find('.hm_charges')=='' ? 0 :curRow.find('.hm_charges').val());















        total_issue_pcs=parseFloat(isNaN(curRow.find('.hm_issue_pcs').val()) || curRow.find('.hm_issue_pcs')=='' ? 0 :curRow.find('.hm_issue_pcs').val());



        total_issue_gwt=parseFloat(isNaN(curRow.find('.hm_issue_gwt').val()) || curRow.find('.hm_issue_gwt')=='' ? 0 :curRow.find('.hm_issue_gwt').val());



        total_issue_lwt=parseFloat(isNaN(curRow.find('.hm_issue_lwt').val()) || curRow.find('.hm_issue_lwt')=='' ? 0 :curRow.find('.hm_issue_lwt').val());



        total_issue_nwt=parseFloat(isNaN(curRow.find('.hm_issue_nwt').val()) || curRow.find('.hm_issue_nwt')=='' ? 0 :curRow.find('.hm_issue_nwt').val());







        total_rejected_pcs=parseFloat(isNaN(curRow.find('.hm_rejected_pcs').val()) || curRow.find('.hm_rejected_pcs')=='' ? 0 :curRow.find('.hm_rejected_pcs').val());



        total_rejected_gwt=parseFloat(isNaN(curRow.find('.hm_rejected_gwt').val()) || curRow.find('.hm_rejected_gwt')=='' ? 0 :curRow.find('.hm_rejected_gwt').val());



        total_rejected_lwt=parseFloat(isNaN(curRow.find('.hm_rejected_lwt').val()) || curRow.find('.hm_rejected_lwt')=='' ? 0 :curRow.find('.hm_rejected_lwt').val());



        total_rejected_nwt=parseFloat(isNaN(curRow.find('.hm_rejected_nwt').val()) || curRow.find('.hm_rejected_nwt')=='' ? 0 :curRow.find('.hm_rejected_nwt').val());







        var hm_accepted_pcs=parseFloat(total_issue_pcs)-parseFloat(total_rejected_pcs);







        curRow.find('.hm_received_pcs').val(hm_accepted_pcs);



        curRow.find('.hm_received_gwt').val(parseFloat(total_issue_gwt)-parseFloat(total_rejected_gwt));



        curRow.find('.hm_received_lwt').val(parseFloat(total_issue_lwt)-parseFloat(rejected_stn_wt));



        curRow.find('.hm_received_nwt').val(parseFloat(curRow.find('.hm_received_gwt').val())-parseFloat(curRow.find('.hm_received_lwt').val()));











        curRow.find('.total_amount').val(parseFloat(parseFloat(hm_accepted_pcs)*parseFloat(hm_charges)).toFixed(2));







        console.log('hm_charges:'+hm_charges);







    });



   /* $('.hm_received_pcs').val(parseFloat(total_issue_pcs)-parseFloat(total_rejected_pcs));



    $('.hm_received_gwt').val(parseFloat(parseFloat(total_issue_gwt)-parseFloat(total_rejected_gwt)).toFixed(3));



    $('.hm_received_lwt').val(parseFloat(parseFloat(total_issue_lwt)-parseFloat(total_rejected_lwt)).toFixed(3));



    $('.hm_received_nwt').val(parseFloat(parseFloat(total_rejected_nwt)-parseFloat(total_rejected_nwt)).toFixed(3));*/



}



$('#hm_receipt_submit').on('click',function(){



    if($('#select_hm_ref_no').val=='')



    {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Ref No."});



    }



    else



    {



        $('#hm_receipt_submit').prop('disabled',true);



        var req_data=[];



        var selected = [];



        var approve=false;



        $("#item_detail tbody tr").each(function(index, value)



        {







                transData = {



                'po_item_id'        : $(value).find(".po_item_id").val(),



                'hm_receipt_id'     : $(value).find(".hm_receipt_id").val(),



                'hm_rejected_pcs'   : $(value).find(".hm_rejected_pcs").val(),



                'hm_rejected_gwt'   : $(value).find(".hm_rejected_gwt").val(),



                'hm_rejected_lwt'   : $(value).find(".hm_rejected_lwt").val(),



                'hm_rejected_nwt'   : $(value).find(".hm_rejected_nwt").val(),



                'halmarking_charges': $(value).find(".total_amount").val(),



                'hm_received_pcs'   : $(value).find(".hm_received_pcs").val(),



                'hm_received_gwt'   : $(value).find(".hm_received_gwt").val(),



                'hm_received_lwt'   : $(value).find(".hm_received_lwt").val(),



                'hm_received_nwt'   : $(value).find(".hm_received_nwt").val(),



                'stone_details'     : $(value).find(".stone_details").val(),



                }



                selected.push(transData);



        });



        req_data = selected;



        update_halmarking_receipt(req_data);



    }



});



function update_halmarking_receipt(req_data)



{



    my_Date = new Date();



    $("div.overlay").css("display", "block");



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/update_halmarking_receipt?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data:  {'req_data':req_data,'hm_process_id':$('#select_hm_ref_no').val(), 'hm_vendor_ref_id' : $('#hm_vendor_ref_id').val()},



        type:"POST",



        async:false,



        dataType:'json',



        success:function(data){



                if(data.status)



                {



                    $('#hm_receipt_submit').prop('disabled',false);



                    window.location.href= base_url+'index.php/admin_ret_purchase/halmarking_issue_receipt/list';



                    $("div.overlay").css("display", "none");



                }else



                {



                    $('#hm_receipt_submit').prop('disabled',false);



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                }







        },



        error:function(error)



        {



        $("div.overlay").css("display", "none");



        }



    });



}



//Halmarking Issue / Receipt



//PO Payment



$('#search_po_items').on('click',function(){



    if($('#po_ref_no').val()=='')



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter THE PO Ref No"});



    }else



    {



        get_purchase_order_items();



    }



});



function get_purchase_order_items()



{



    $('#item_details tbody').empty();



    $('#pay_history tbody').empty();



    my_Date = new Date();



    $("div.overlay").css("display", "block");



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/purchase_payment/purchase_payment_details?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data: {'po_ref_no':$('#po_ref_no').val()},



        type:"POST",



        async:false,



        dataType:'json',



        success:function(data){



               var item_details=data.item_details;



               if(item_details.length==0)



               {



                   $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found."});



                   $("div.overlay").css("display", "none");



               }



               else



               {



                    var total_payable_amount = item_details[0].total_payable_amt;



                    var pay_history_details = data.pay_history;



                    var tot_cash_amt=data.pay_details['tot_pay_amt'];



                    var tot_pay_wt=data.pay_details['tot_pay_wt'];



                    $('#karigar_name').html(item_details[0].karigar_name);



                    $('#mobile_no').html(item_details[0].mobile);







                   var trHtml='';



                   var historyHtml = '';







                   $.each(item_details,function(key,items){



                       if(items.mc_type==1)



                       {



                           var mc_value=parseFloat(parseFloat(items.mc_value)*parseFloat(items.total_gwt));



                       }else



                       {



                           var mc_value=parseFloat(parseFloat(items.mc_value)*parseFloat(items.total_pcs));



                       }



                       trHtml+='<tr>'



                                 +'<td>'+items.category_name+'</td>'



                                 +'<td>'+items.product_name+'</td>'



                                 +'<td>'+items.design_name+'</td>'



                                 +'<td>'+items.sub_design_name+'</td>'



                                 +'<td>'+items.total_pcs+'</td>'



                                 +'<td>'+items.total_gwt+'</td>'



                                 +'<td>'+items.total_lwt+'</td>'



                                 +'<td>'+items.total_nwt+'</td>'



                                 +'<td>'+items.item_wastage+'</td>'



                                 +'<td>'+parseFloat(mc_value).toFixed(2)+'</td>'



                                 +'<td>'+items.item_pure_wt+'</td>'



                               +'</tr>';







                        if(items.rate_fixing_det.length>0)



                        {



                            var total_amount=0;



                            var total_taxable_amount=0;



                            var total_tax_amount=0;



                            trHtml+='<tr style="font-weight:bold;">'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td>#</td>'



                                 +'<td>Rate Fixed Date</td>'



                                 +'<td>Description</td>'



                                 +'<td>Amount/Weight</td>'



                                 +'<td>Rate Per Gram</td>'



                                 +'<td>Taxable Amount</td>'



                                 +'<td>Tax Amount</td>'



                                 +'<td>Total Amount</td>'



                               +'</tr>';







                              $.each(items.rate_fixing_det,function(k,val){



                                total_amount+=parseFloat(val.total_amount);



                                total_tax_amount+=parseFloat(val.total_tax_amount);



                                total_taxable_amount+=parseFloat(val.total_amount-val.total_tax_amount);



                                  trHtml+='<tr>'



                                         +'<td></td>'



                                         +'<td></td>'



                                         +'<td></td>'



                                         +'<td>'+parseFloat(k+1)+'</td>'



                                         +'<td>'+val.rate_fix_created_on+'</td>'



                                         +'<td>'+(val.rate_fix_type==2 ? 'MC & Stone & Other ' :'Metal')+'</td>'



                                         +'<td>'+(val.rate_fix_type==1 ? val.rate_fix_wt : val.rate_fix_amt)+'</td>'



                                         +'<td>'+val.rate_fix_rate+'</td>'



                                         +'<td>'+parseFloat(val.total_amount-val.total_tax_amount).toFixed(2)+'</td>'



                                         +'<td>'+parseFloat(val.total_tax_amount).toFixed(2)+'</td>'



                                         +'<td>'+parseFloat(val.total_amount).toFixed(2)+'</td>'



                                       +'</tr>';



                              });







                              trHtml+='<tr style="font-weight:bold;">'



                                 +'<td>TOTAL</td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td>'+parseFloat(total_taxable_amount).toFixed(2)+'</td>'



                                 +'<td>'+parseFloat(total_tax_amount).toFixed(2)+'</td>'



                                 +'<td>'+parseFloat(total_amount).toFixed(2)+'</td>'



                               +'</tr>';







                        }







                   });







                   $.each(pay_history_details, function(key, items){



                       historyHtml+='<tr>'



                                 +'<td>'+items.pay_refno+'</td>'



                                 +'<td>'+items.pay_date+'</td>'



                                 +'<td>'+items.tot_cash_pay+'</td>'



                               +'</tr>';



                   });



                    $('.payable_amt').html(parseFloat(total_payable_amount).toFixed(2));



                    $('.paid_amt').html(parseFloat(tot_cash_amt).toFixed(2));



                    $('.paid_wt').html(parseFloat(tot_pay_wt).toFixed(2));



                    $('.balance_amt').html(parseFloat(total_payable_amount-tot_cash_amt).toFixed(2));



                    $('#item_details tbody').append(trHtml);







                    $('#pay_history tbody').append(historyHtml);











                    $("div.overlay").css("display", "none");



               }



        },



        error:function(error)



        {



        $("div.overlay").css("display", "none");



        }



    });



}



/*function get_purchase_order_items()



{



    $('#item_details tbody').empty();



    my_Date = new Date();



    $("div.overlay").css("display", "block");



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/purchase_payment/purchase_payment_details?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data: {'po_ref_no':$('#po_ref_no').val()},



        type:"POST",



        async:false,



        dataType:'json',



        success:function(data){



            var item_details=data.item_details;



            var pay_history_details=data.pay_history;



            var tot_cash_amt=data.pay_details['tot_pay_amt'];



            var tot_pay_wt=data.pay_details['tot_pay_wt'];



               if(item_details.length==0)



               {



                   $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found."});



               }



               else



               {



                   var trHtml='';



                   var total_mc_value=0;



                   var total_pur_wt=0;



                   $.each(item_details,function(key,items){



                       total_pur_wt+=parseFloat(items.item_pure_wt);



                       if(items.mc_type==1)



                       {



                           var mc_value=parseFloat(parseFloat(items.mc_value)*parseFloat(items.total_gwt));



                       }else



                       {



                           var mc_value=parseFloat(parseFloat(items.mc_value)*parseFloat(items.total_pcs));



                       }



                       trHtml+='<tr style="font-weight:bold;">'



                                 +'<td>'+items.category_name+'</td>'



                                 +'<td>'+items.product_name+'</td>'



                                 +'<td>'+items.design_name+'</td>'



                                 +'<td>'+items.sub_design_name+'</td>'



                                 +'<td>'+items.total_pcs+'</td>'



                                 +'<td>'+items.total_gwt+'</td>'



                                 +'<td>'+items.total_lwt+'</td>'



                                 +'<td>'+items.total_nwt+'</td>'



                                 +'<td>'+items.item_wastage+'</td>'



                                 +'<td>'+parseFloat(mc_value).toFixed(2)+'</td>'



                                 +'<td>'+items.item_pure_wt+'</td>'



                               +'</tr>';



                    total_mc_value+=parseFloat(mc_value);







                        if(items.rate_fixing_det.length>0)



                        {



                            trHtml+='<tr style="font-weight:bold;">'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td>#</td>'



                                 +'<td>Description</td>'



                                 +'<td>Amount/Weight</td>'



                                 +'<td>Rate Per Gram</td>'



                                 +'<td>Taxable Amount</td>'



                                 +'<td>Tax Amount</td>'



                                 +'<td>Total Amount</td>'



                                 +'<td>Paid Amount</td>'



                                 +'<td>Balance Amount</td>'



                               +'</tr>';







                              $.each(items.rate_fixing_det,function(k,val){







                                  trHtml+='<tr>'



                                         +'<td></td>'



                                         +'<td></td>'



                                         +'<td>'+val.rate_fix_id+'</td>'



                                         +'<td>'+(val.rate_fix_type==2 ? 'MC & Stone & Other ' :'Metal')+'</td>'



                                         +'<td>'+(val.rate_fix_type==1 ? val.rate_fix_wt : val.rate_fix_amt)+'</td>'



                                         +'<td>'+val.rate_fix_rate+'</td>'



                                         +'<td>'+parseFloat(val.total_amount-val.total_tax_amount).toFixed(2)+'</td>'



                                         +'<td>'+parseFloat(val.total_tax_amount).toFixed(2)+'</td>'



                                         +'<td>'+parseFloat(val.total_amount).toFixed(2)+'</td>'



                                         +'<td></td>'



                                        +'<td></td>'



                                       +'</tr>';



                              });



                        }







                   });



                   trHtml+='<tr style="font-weight:bold;">'



                                 +'<td>TOTAL</td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td></td>'



                                 +'<td>'+parseFloat(total_mc_value).toFixed(2)+'</td>'



                                 +'<td>'+parseFloat(total_pur_wt).toFixed(3)+'</td>'



                               +'</tr>';



                    $('.payable_amt').html(parseFloat(total_mc_value).toFixed(2));



                    $('.payable_weight').html(parseFloat(total_pur_wt).toFixed(2));



                    $('.paid_amt').html(parseFloat(tot_cash_amt).toFixed(2));



                    $('.paid_wt').html(parseFloat(tot_pay_wt).toFixed(2));



                    $('.balance_amt').html(parseFloat(total_mc_value-tot_cash_amt).toFixed(2));



                    $('.balance_wt').html(parseFloat(total_pur_wt-tot_pay_wt).toFixed(2));







                    $('#item_details tbody').append(trHtml);











                    $("div.overlay").css("display", "none");



               }



        },



        error:function(error)



        {



        $("div.overlay").css("display", "none");



        }



    });



}



*/



$(document).on('change','.wt_pay_type',function(e){



    var row = $(this).closest('tr');



    var received_weight=row.find('.received_weight').val();



    if($('.wt_pay_type:checked').val()==1)



    {



        row.find('.rate_per_gram').prop('readonly',true);



        row.find('.rate_per_gram').val(0);



    }else{



        row.find('.rate_per_gram').prop('readonly',false);



    }



    calculate_weight_payment(row);



});



function calculate_weight_payment(curRow)



{



    var received_weight=curRow.find('.received_weight').val();



    var rate_per_gram=curRow.find('.rate_per_gram').val();



    if($('.wt_pay_type:checked').val()==2)



    {



        curRow.find('.total_payment_wt').val(parseFloat(received_weight)*parseFloat(rate_per_gram));



    }else



    {



         curRow.find('.total_payment_wt').val(parseFloat(received_weight).toFixed(3));



    }



}



$(document).on('keyup','.received_weight,.rate_per_gram',function(e){



    var row = $(this).closest('tr');



    var balance_wt=row.find('.balance_wt').html();



    var received_weight=row.find('.received_weight').val();



    if(parseFloat(balance_wt)<parseFloat(received_weight))



    {



        row.find('.received_weight').val(0);



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Weight"});



    }



    else



    {



        calculate_weight_payment(row);



    }



});



$(document).on('change','.received_amount',function(e){



    updatePayableAmt();



    calculate_received_amount();



});



function updatePayableAmt(){



    var totalreceivedAmt = $(".received_amount").val();



    var totalassignedAmt = $(".received_amount").val();



    var assignrow = 1;



    var isAdvance = true;







     $('#po_pay_details tbody').find('tr').each(function () {



        var row = $(this);



        if (row.find('input[type="checkbox"]').is(':checked')) {



            isAdvance = false;



            /*pototalcost     += parseFloat(row.find('.item_cost').html());



            popaidcost      += parseFloat(row.find('.paidamt').html());



            popayablecost   += parseFloat(row.find('.balanceamt').html());



            row.find('.curpayable').val(parseFloat(row.find('.balanceamt').html()));*/



            if(totalassignedAmt >=  parseFloat(row.find('.balanceamt').html())){



                 row.find('.curpayable').val(parseFloat(row.find('.balanceamt').html()).toFixed(2));



                 totalassignedAmt -= parseFloat(row.find('.curpayable').val());



            }else if(assignrow == 0){



                 row.find('.curpayable').val(0);



                 row.find('input[type="checkbox"]').prop('checked', false);



            }else{



                parseFloat(row.find('.curpayable').val(parseFloat(totalassignedAmt).toFixed(2)));



                assignrow = 0;



                totalassignedAmt -= parseFloat(row.find('.curpayable').val());



            }



        }



    });







    $('.selectedpayable').html(totalreceivedAmt);



}



function calculate_received_amount(){



    var row = $(this).closest('tr');



    var balance_amt=row.find('.balance_amt').html();



    var received_amount=row.find('.received_amount').val();



    if(parseFloat(balance_amt)<parseFloat(received_amount))



    {



        row.find('.received_amount').val(0);



        row.find('.total_payment_amount').val(0);



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Amount"});



    }



    else



    {



        row.find('.total_payment_amount').val(parseFloat(received_amount).toFixed(3));



    }



    calculatePaymentCost();



    updatePayableAmt();



}



$('#po_pay_submit').on('click',function(){



    var allow_submit=true;



    var tot_pay_amount=0;



    var tot_pay_weight=0;



    var bill_type = 2;



    $('#po_pay_details tbody').find('tr').each(function () {



        var row = $(this);



        if (row.find('input[type="checkbox"]').is(':checked')) {



           bill_type = 1;



        }



    });







    $('#bill_type').val(bill_type);







    $('#total_summary_details > tbody tr').each(function(bidx, brow){



        curRow = $(this);



        tot_pay_amount+=(isNaN($('.received_amount').val()) || $('.received_amount').val()=='' ? 0:$('.received_amount').val());



    });







    if(tot_pay_amount==0)



    {



        allow_submit=false;



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter The Payment Amount"});



    }



    else



    {



        allow_submit = true;



    }







    if($('#net_banking_pay_details').val() == '' && $('#sales_details').val() == '' && $('#chit_details').val() == ''){



        allow_submit=false;



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please fill payment method details"});



    }







    if(allow_submit)



    {



        my_Date = new Date();



        $("div.overlay").css("display", "block");



    	var form_data = $('#bill_pay').serialize();



    	$('#pay_submit').prop('disabled',true);



    	var url=base_url+ "index.php/admin_ret_purchase/supplier_po_payment/save?nocache=" + my_Date.getUTCSeconds();



        $.ajax({



            url:url,



            data: form_data,



            type:"POST",



            dataType:"JSON",



            success:function(data){



    			if(data.status)



    			{



    			    $("div.overlay").css("display", "none");



    			    window.location.reload();



    				//window.open( base_url+'index.php/admin_ret_billing/billing_invoice/'+data['id'],'_blank');



    			}



    			else



    			{



    			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



    			    $("div.overlay").css("display", "none");



    			}







            },



            error:function(error)



            {



            $("div.overlay").css("display", "none");



            }



        });



    }







});



$('#pay_submit').on('click',function(){







    var allow_submit=true;



    var tot_pay_amount=0;



    var tot_pay_weight=0;



    var bill_type = $("input[name='billing[bill_type]']:checked").val();











    if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Kaigar"});



        allow_submit=false;



    }



    else if($('.receive_amount').val()=='')



    {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter Received Amount"});



            allow_submit=false;



    }



    else



    {



        allow_submit=true;



    }



    if(allow_submit)



    {



        my_Date = new Date();



        if(ctrl_page[2]=='add')



        {



    	    var url=base_url+ "index.php/admin_ret_purchase/supplier_po_payment/save?nocache=" + my_Date.getUTCSeconds();



        }



        else if(ctrl_page[2]=='edit')



        {



            var url=base_url+ "index.php/admin_ret_purchase/supplier_po_payment/update?nocache=" + my_Date.getUTCSeconds();



        }











        $("div.overlay").css("display", "block");



    	var form_data=$('#bill_pay').serialize();



    	$('#pay_submit').prop('disabled',true);



        $.ajax({



            url:url,



            data: form_data,



            type:"POST",



            dataType:"JSON",



            success:function(data){



    			if(data.status)



    			{



    			    $("div.overlay").css("display", "none");



    			    if(ctrl_page[2]=='add')



                     {



                            $("div.overlay").css("display", "none");



                            location.href=base_url+'index.php/admin_ret_purchase/supplier_po_payment/list';



                            //window.open( base_url+'index.php/admin_ret_billing/billing_invoice/'+data['id'],'_blank');



                      }



                     else if(ctrl_page[2]=='edit')



                     {



                         $("div.overlay").css("display", "none");



                        location.href=base_url+'index.php/admin_ret_purchase/supplier_po_payment/list';



                     }



    			}



    			else



    			{



    			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



    			    $("div.overlay").css("display", "none");



    			}







            },



            error:function(error)



            {



            $("div.overlay").css("display", "none");



            }



        });



    }



});



function get_bank_details(){



	$.ajax({



	 	type: 'GET',



	 	url : base_url + 'index.php/admin_ret_billing/get_bank_acc_details',



	 	dataType : 'json',



	 	success  : function(data){



		 	bank_details = data;



	 	}



	});



}



function get_purchase_order_payment_list(from_date, to_date)



{



    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



	 url:base_url+ "index.php/admin_ret_purchase/supplier_po_payment/ajax?nocache=" + my_Date.getUTCSeconds(),



	 dataType:"JSON",



	 data:{'from_date': from_date, 'to_date': to_date},



	 type:"POST",



	 success:function(data){



	 	var list=data.list;



	 	var access=data.access;



		var oTable = $('#payment_list').DataTable();



		oTable.clear().draw();



		if (list!= null && list.length > 0)



		{



			oTable = $('#payment_list').dataTable({



            "bDestroy": true,



            "bInfo": true,



            "bFilter": true,



            "bSort": true,



            "order": [[ 0, "desc" ]],



            "dom": 'lBfrtip',



            "buttons" : ['excel','print'],



            "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



            "aaData": list,



            "aoColumns": [



                { "mDataProp": "pay_id" },



                { "mDataProp": "pay_date" },



                { "mDataProp": "pay_refno" },



                { "mDataProp": "karigar_name" },



                { "mDataProp": "pay_amt" },



                { "mDataProp": "bill_type" },



                { "mDataProp": "status" },







                { "mDataProp": function ( row, type, val, meta ) {



                    id=row.pay_id;



                    edit_target=(access.edit=='0'?"":"#confirm-edit");



                    print_url = (base_url+'index.php/admin_ret_purchase/supplier_po_payment/paymentacknolodgement/'+id);



                    edit_url=(access.edit=='1' ? '<a href="'+base_url+'index.php/admin_ret_purchase/supplier_po_payment/edit/'+id+'" class="btn btn-primary btn-edit"><i class="fa fa-edit" ></i></a>' :'');



                    delete_url=(access.delete=='1' ? '<button onclick="confirm_bill_cancel('+id+')" class="btn btn-danger"> <i class="fa fa-close" ></i></button>' :'');

                    



                    action_content=(row.pay_status==1  ? edit_url +'<a href="'+print_url+'" target="_blank" class="btn btn-info btn-print" data-toggle="tooltip" title="Payment Copy"><i class="fa fa-print" ></i></a>'+delete_url :'-');



                    return action_content;



                }



                }







              ]



            });







		}



		$("div.overlay").css("display", "none");



	  },



	  error:function(error)



	  {



		 $("div.overlay").css("display", "none");



	  }



  });



}



function confirm_bill_cancel(pay_id)



{



	$('#pay_id').val(pay_id);



	$('#confirm-billcancell').modal('show');



}



$('#payment_cancel_remark').on('keypress',function(){



	if(this.value.length>6)



	{



		$('#payment_cancel').prop('disabled',false);



	}else{



		$('#payment_cancel').prop('disabled',true);



	}



});



$('#payment_cancel').on('click',function(){



    $('#payment_cancel').prop('disabled',true);



	my_Date = new Date();



	$.ajax({



		type: 'POST',



		url:base_url+ "index.php/admin_ret_purchase/supplier_po_payment/cancel_pay_entry?nocache=" + my_Date.getUTCSeconds(),



		dataType:'json',



		data:{'cancel_reason':$('#payment_cancel_remark').val(),'pay_id':$('#pay_id').val()},



		success:function(data){



		    window.location.reload();



		}



	});



});



function get_supplier_popay_edit(id)



{







        my_Date = new Date();



	    $.ajax({



		url: base_url+'index.php/admin_ret_purchase/supplier_po_payment/po_pay_details/'+id+'?nocache=' + my_Date.getUTCSeconds(),



        dataType: "json",



        type: 'POST',



		success:function(data)



        {







            $('#select_karigar').attr("disabled",true);







            $("input[name='billing[bill_type]']:radio").attr("disabled",true);







            $('#pay_id').val(data[0].pay_id);







            $('#id_karigar').val(data[0].pay_sup_id);



            $('.balance_amount').val(data[0].balance_amount);



            $('.receive_amount').val(data[0].pay_amt);



            $('#tot_net_banking_amt').html(data[0].pay_amt);



            $('#remark').val(data[0].pay_narration);



            if(data[0].bill_type==1)



            {



                $('#bill_type_sales').attr('checked',true);



            }



            else



            {



                $('#bill_type_advance').attr('checked',true);



            }



            var list = data[0].po_payment_details;



            for(i=0; i<list.length; i++)



            {



                var bank_list = '';



                console.log('bank',bank_details);



                $.each(bank_details, function (pkey, item)



                {



                    var selected = "";



                    if(list[i].id_bank==item.id_bank)



                    {



                        selected = "selected='selected'";



                    }



                    bank_list += "<option value='"+item.id_bank+"' "+selected+">"+item.acc_number+"</option>";



                });



                var row = "";



                row += '<tr>'



                            +'<td style="width:15%"><select class="form-control nb_type"><option value="RTGS"'+(list[i].pay_mode=='RTGS'?'selected':'')+'>RTGS</option><option value="NEFT"'+(list[i].pay_mode=='NEFT'?'selected':'')+'>NEFT</option></select></td>'







                            +'<td style="width:20%"><select class="form-control id_bank" name="nb_details[id_bank][]" >'+bank_list+'</select></td> '







                            +'<td><input class="form-control  datemask date nb_date" data-date-format="yyyy-mm-dd" name="nb_details[nb_date][]" type="text" placeholder="NB Date" value="'+list[i].payment_date+'" /></td>'







                            +'<td><input type="number" class="form-control pay_amount" type="number" value="'+list[i].payment_amount+'"/></td>'







                            +'<td><input class="form-control ref_no" type="text" value="'+list[i].ref_no+'"/></td>'







                            +'<td><a href="#" onClick="remove_net_banking_row($(this).closest(\'tr\'));" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



                        +'</tr>';



                $('#net_banking_details tbody').append(row);



                $('#net_banking_details > tbody').find('tr:last td:eq(0) .pay_amount').focus();



                var date = new Date();



                var today = new Date(date.getFullYear(), date.getMonth(), date.getDate());



                $('.nb_date').datepicker({ dateFormat: 'yyyy-mm-dd',endDate:today });



            }



            get_ActiveKaigar();



            $('#save_net_banking').trigger('click');



		}



	});



}



function get_purchase_orderno(searchTxt){



	my_Date = new Date();



	$.ajax({



        url: base_url+'index.php/admin_ret_purchase/getOrderNosBySearch/?nocache=' + my_Date.getUTCSeconds(),



        dataType: "json",



        method: "POST",



        data: {'searchTxt': searchTxt, 'supplierId' : $('#select_karigar').val()},



        success: function (data) {



			$( "#purchase_order_no" ).autocomplete(



			{



				source: data,



				select: function(e, i)



				{



					e.preventDefault();



					$("#purchase_order_no").val(i.item.label);



					$("#purchaseorderno").val(i.item.value);



					getPurchaseOrderProductDetails(i.item.value);



				},



				change: function (event, ui) {



					if (ui.item === null) {



						$(this).val('');



						$('#purchase_order_no').val('');



						$("#design_id").val("");



					}



			    },



				response: function(e, i) {



		            // ui.content is the array that's about to be sent to the response callback.



		            if(searchTxt != ""){



						if (i.content.length === 0) {







						}else{







						}



					}else{







					}



		        },



				 minLength: 2,



			});



        }



     });



}



function getPurchaseOrderProductDetails(orderId)



{



	my_Date = new Date();



	$.ajax({



        url: base_url + 'index.php/admin_ret_tagging/admin_ret_purchase/?nocache=' + my_Date.getUTCSeconds(),



        dataType: "json",



        method: "POST",



        data: { 'designId': designId },



        success: function ( data ) {



			tag_design_stones = data;



			/* console.log(data);



			var html = '';



			$.each(data, function(key, item){



				html += '<tr><td><input type="hidden" name="tagstone[stone_id][]" value="'+item.stone_id+'" />'+item.stone_name+'</td><td><div class="input-group"> <input class="form-control" type="number" step="any" name="tagstone[pcs][]" value="'+item.stone_pcs+'" required /></div></td><td><div class="input-group"><input type="number" class="form-control" step="any" name="tagstone[weight][]" value="" required /></div></td><td><input type="hidden" name="tagstone[uom_id][]" value="'+item.uom_id+'" />'+item.uom_short_code+'</td><td><div class="input-group"> <input class="form-control" type="number" step="any" name="tagstone[amount][]" value="" required /></div></td></tr>';



			});



			$('#tagging_stone_details tbody').append(html); */



        }



     });



}



//PO Payment



//rate fixing



function get_approvl_ratefix_po()



{



    $("#select_approval_ref_no option").remove();



	$.ajax({



	type: 'POST',



	data:{'id_karigar':$('#select_karigar').val()},



	url: base_url+'index.php/admin_ret_purchase/get_approvl_ratefix_po',



	dataType:'json',



	success:function(data){



	    approval_ratefix_details = data;



	    var id=$('#select_approval_ref_no').val();



		$.each(data, function (key, item) {



		    $("#select_approval_ref_no").append(



		    $("<option></option>")



		    .attr("value", item.id_supplier_rate_cut)



		    .text(item.ref_no)



		    );



		});



		$("#select_approval_ref_no").select2(



		{



			placeholder:"Select PO Ref",



			closeOnSelect: true



		});







		if($("#select_approval_ref_no").length)



		{



		    $("#select_approval_ref_no").select2("val",(id!='' && id>0?id:''));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



$('#select_approval_ref_no').on('change',function(){



    if(this.value!='')



    {



        set_approval_po_rate_fix_details();



    }



});



function get_rate_fixing_po_no()



{



    $("#select_po_ref_no option").remove();



	$.ajax({



	type: 'POST',



	data:{'id_karigar':$('#select_karigar').val()},



	url: base_url+'index.php/admin_ret_purchase/get_rate_fixing_po_no',



	dataType:'json',



	success:function(data){



	    ratefix_po_detail = data;



	    var id=$('#rate_fix_po_item_id').val();



		$.each(data, function (key, item) {



		    $("#select_po_ref_no").append(



		    $("<option></option>")



		    .attr("value", item.po_id)



		    .text(item.po_ref_no)



		    );



		});



		$("#select_po_ref_no").select2(



		{



			placeholder:"Select PO Ref",



			closeOnSelect: true



		});







		if($("#select_po_ref_no").length)



		{



		    $("#select_po_ref_no").select2("val",(id!='' && id>0?id:''));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



$('#rate_fix_item_search').on('click',function(){



    if($('#po_ref_no').val()=='')



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Purchase Order Ref No."});



    }else



    {



        get_rate_fixing_item_search();



    }



});



/*function set_po_rate_fix_details()



{



    $('#item_details tbody').empty();



    $("div.overlay").css("display", "block");



    var trHtml='';



    $.each(ratefix_po_detail,function(key,items){



        if(items.po_id == $('#select_po_ref_no').val())



        {



            var balance_wt = parseFloat(items.tot_purchase_wt)-parseFloat(items.total_fixed_wt)-parseFloat(items.ret_pure_wt);



            trHtml+='<tr>'



            +'<td><input type="hidden" class="form-control po_item_id" name="rate_fixing_items[po_item_id][]" value="'+items.po_id+'">'+items.po_ref_no+'</td>'



            +'<td>'+items.podate+'</td>'



            +'<td>'+items.tot_purchase_wt+'</td>'



            +'<td>'+items.total_fixed_wt+'</td>'



            +'<td>'+items.ret_pure_wt+'</td>'



            +'<td><input type="hidden" class="form-control balance_wt" value="'+balance_wt+'">'+parseFloat(balance_wt).toFixed(3)+'</td>'



            +'<td><input type="number" class="form-control fix_weight" name="rate_fixing_items[fix_weight][]"></td>'



            +'<td><input type="number" class="form-control rate_fix_rate" name="rate_fixing_items[rate_per_gram][]"></td>'



            +'<td><input type="number" class="form-control payable_amt" name="rate_fixing_items[payable_amt][]" readonly></td>'



            +'</tr>';



        }



    });



    $('#item_details tbody').append(trHtml);



    $("div.overlay").css("display", "none");



}*/



function set_po_rate_fix_details() {



    $('#item_details tbody').empty();



    $("div.overlay").css("display", "block");



    var trHtml = '';



    $.each(ratefix_po_detail, function (key, items) {



        if (items.po_id == $('#select_po_ref_no').val() && items.fin_year_code == $('#pur_fin_year_select').val()) {



            var balance_wt = parseFloat(items.tot_purchase_wt)-parseFloat(items.total_fixed_wt)-parseFloat(items.ret_pure_wt);



            trHtml += '<tr>'



                + '<td><input type="hidden" class="form-control po_item_id" name="rate_fixing_items[po_item_id][]" value="' + items.po_id + '">' + items.po_ref_no + '</td>'



                + '<td>' + items.podate + '</td>'



                + '<td>' + items.tot_purchase_wt + '</td>'



                + '<td>' + items.total_fixed_wt + '</td>'



                +'<td>'+items.ret_pure_wt+'</td>'



                + '<td><input type="hidden" class="form-control balance_wt" value="' + balance_wt + '">' + parseFloat(balance_wt).toFixed(3) + '</td>'



                + '<td><input type="number" class="form-control fix_weight" name="rate_fixing_items[fix_weight][]"></td>'



                + '<td><input type="number" class="form-control rate_fix_rate" name="rate_fixing_items[rate_per_gram][]"><input type="hidden" class="form-control tax_percentage" name="rate_fixing_items[tax_percentage][]"></td>'



                +'<td><input type="number" class="form-control taxable_amount" name="rate_fixing_items[taxable_amount][]" readonly></td>'



                +'<td><input type="number" class="form-control tax_amt" name="rate_fixing_items[tax_amt][]" readonly></td>'



                + '<td><input type="number" class="form-control payable_amt" name="rate_fixing_items[payable_amt][]"><input type="hidden" class="form-control taxable_amount" name="rate_fixing_items[taxable_amount][]"><input type="hidden" class="form-control cgst" name="rate_fixing_items[cgst][]"><input type="hidden" class="form-control sgst" name="rate_fixing_items[sgst][]"><input type="hidden" class="form-control igst" name="rate_fixing_items[igst][]"></td>'



                + '</tr>';



        }



    });



    $('#item_details tbody').append(trHtml);



    $("div.overlay").css("display", "none");



    calculation_rate_fixed();



}



function set_approval_po_rate_fix_details() {



    $('#item_details tbody').empty();



    $("div.overlay").css("display", "block");



    var trHtml = '';



    $.each(approval_ratefix_details, function (key, items) {



        if (items.id_supplier_rate_cut == $('#select_approval_ref_no').val()) {



            var balance_wt = parseFloat(items.blc_wt).toFixed(3);



            trHtml += '<tr>'



                + '<td><input type="hidden" class="form-control po_item_id" name="rate_fixing_items[po_item_id][]" value="' + items.po_id + '"><input type="hidden" class="form-control id_supplier_rate_cut" name="rate_fixing_items[id_supplier_rate_cut][]" value="' + items.id_supplier_rate_cut + '">' + items.ref_no + '</td>'



                + '<td>' + items.dateadd + '</td>'



                + '<td>' + items.pure_wieght + '</td>'



                + '<td>' + items.rate_fix_wt + '</td>'



                +'<td></td>'



                + '<td><input type="hidden" class="form-control balance_wt" value="' + balance_wt + '">' + parseFloat(balance_wt).toFixed(3) + '</td>'



                + '<td><input type="number" class="form-control fix_weight" name="rate_fixing_items[fix_weight][]"></td>'



                + '<td><input type="number" class="form-control rate_fix_rate" name="rate_fixing_items[rate_per_gram][]"></td>'



                +'<td><input type="number" class="form-control taxable_amount" name="rate_fixing_items[taxable_amount][]" readonly></td>'



                +'<td><input type="number" class="form-control tax_amt" name="rate_fixing_items[tax_amt][]" readonly></td>'



                + '<td><input type="number" class="form-control payable_amt" name="rate_fixing_items[payable_amt][]"><input type="hidden" class="form-control tax_percentage" name="rate_fixing_items[tax_percentage][]"><input type="hidden" class="form-control cgst" name="rate_fixing_items[cgst][]"><input type="hidden" class="form-control sgst" name="rate_fixing_items[sgst][]"><input type="hidden" class="form-control igst" name="rate_fixing_items[igst][]"></td>'



                + '</tr>';



        }



    });



    $('#item_details tbody').append(trHtml);



    $("div.overlay").css("display", "none");



}



$(document).on('keyup', '.payable_amt', function (e) {



    var row = $(this).closest('tr');



    calculate_rate_fixing_items_payment(row);



});



$(document).on('keyup','.fix_weight',function(e)

{

    var row = $(this).closest('tr');



    var balance_wt = row.find('.balance_wt').val();



    var fix_weight = row.find('.fix_weight').val();



    if (parseFloat(balance_wt) < parseFloat(fix_weight)) {



        row.find('.fix_weight').val('');



        $.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>Enter The Valid Weight" });



    }



    else {



        calculate_rate_fixing_items_payment(row);



        calculation_rate_fixed();



    }





});



$(document).on('keyup','.rate_fix_rate',function(e)



{



    var row = $(this).closest('tr');



    calculate_rate_fixing_total_paymnet(row);



    calculation_rate_fixed();



});





function calculation_rate_fixed() {



    // $('#supplier_rate_cut_submit').prop('disabled',false);



    var igst_cost = 0;



    var sgst_cost = 0;



    var cgst_cost = 0;



    var cmp_country = $('#cmp_country').val();



    var cmp_state = $('#cmp_state').val();



    var tax_percentage = 3;



    var taxable_amount = ($('.taxable_amount').val()!='' ? $('.taxable_amount').val():0);



    var supplier_country = '';



    var supplier_state = '';







    $.each(karigar_details,function(key,val){



        if(val.id_karigar == $('#select_karigar').val())



        {



            supplier_country=val.id_country;



            supplier_state=val.id_state;



        }



    });



            /*var amt_without_gst = (parseFloat(total_amount)*100)/(100+parseFloat(3));



            var total_tax_rate = parseFloat(parseFloat(total_amount) - parseFloat(amt_without_gst)).toFixed(2);*/



        //   var total_tax_rate = parseFloat(calculate_inclusiveGST(total_amount,3)).toFixed(2);



        var total_tax_rate = parseFloat(parseFloat(taxable_amount)*(parseFloat(tax_percentage)/100));



        var total_payable_amt = parseFloat(parseFloat(taxable_amount) + parseFloat(total_tax_rate));





       if(cmp_country==supplier_country)



       {



            if(cmp_state==supplier_state)



            {



                sgst_cost = parseFloat(total_tax_rate/2).toFixed(2);



                cgst_cost = parseFloat(total_tax_rate/2).toFixed(2);



            }

            else{



                igst_cost =  parseFloat(total_tax_rate).toFixed(2);



            }



       }else{



           igst_cost =  parseFloat(total_tax_rate).toFixed(2);



       }





    $('.tax_percentage').val(tax_percentage);



    $('.tax_amt').val(parseFloat(total_tax_rate).toFixed(2));



    $('.payable_amt').val(parseFloat(total_payable_amt).toFixed(2));



    $('.sgst').val(sgst_cost);



    $('.cgst').val(cgst_cost);



    $('.igst').val(igst_cost);



}



function calculate_rate_fixing_total_paymnet(curRow)



{



    var fix_weight = (isNaN(curRow.find('.fix_weight').val()) || curRow.find('.fix_weight').val() == '' ? 0 : curRow.find('.fix_weight').val());



    var rate_fix = (isNaN(curRow.find('.rate_fix_rate').val()) || curRow.find('.rate_fix_rate').val() == '' ? 0 : curRow.find('.rate_fix_rate').val());





    curRow.find('.taxable_amount').val(parseFloat(parseFloat(rate_fix) * parseFloat(fix_weight)).toFixed(2));



}



function calculate_rate_fixing_items_payment(curRow) {



    var fix_weight = (isNaN(curRow.find('.fix_weight').val()) || curRow.find('.fix_weight').val() == '' ? 0 : curRow.find('.fix_weight').val());





    var payable_amt = (isNaN(curRow.find('.payable_amt').val()) || curRow.find('.payable_amt').val() == '' ? 0 : curRow.find('.payable_amt').val());





    var amt_without_gst = (parseFloat(payable_amt)*100)/(100+parseFloat(3));





    var total_tax_rate = parseFloat(parseFloat(amt_without_gst)*(parseFloat(3)/100));





    curRow.find('.tax_amt').val(parseFloat(total_tax_rate).toFixed(2));



    curRow.find('.taxable_amount').val(parseFloat(amt_without_gst).toFixed(2));





    curRow.find('.rate_fix_rate').val(parseFloat(parseFloat(curRow.find('.taxable_amount').val()) / parseFloat(fix_weight)).toFixed(2));



}

function get_rate_fixing_item_search()



{



    $('#item_details tbody').empty();



    my_Date = new Date();



    $("div.overlay").css("display", "block");



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/rate_fixing/rate_fixing_items?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data:  {'po_ref_no':$('#po_ref_no').val()},



        type:"POST",



        async:false,



        dataType:'json',



        success:function(data){



                if(data.length)



                {



                    var trHtml='';



                    $.each(data,function(key,items){



                        trHtml+='<tr>'



                                +'<td><input type="hidden" class="form-control po_item_id" name="rate_fixing_items[po_item_id][]" value="'+items.po_item_id+'">'+items.category_name+'</td>'



                                +'<td>'+items.product_name+'</td>'



                                +'<td>'+items.design_name+'</td>'



                                +'<td>'+items.sub_design_name+'</td>'



                                +'<td>'+items.purity+'</td>'



                                +'<td>'+items.item_wastage+'</td>'



                                +'<td>'+items.item_pure_wt+'</td>'



                                +'<td><input type="hidden" class="form-control balance_wt" value="'+items.balance_wt+'">'+items.balance_wt+'</td>'



                                +'<td><input type="number" class="form-control fix_weight" name="rate_fixing_items[fix_weight][]"></td>'



                                +'<td><input type="number" class="form-control rate_fix_rate" name="rate_fixing_items[rate_per_gram][]"></td>'



                                +'<td><input type="number" class="form-control payable_amt" name="rate_fixing_items[payable_amt][]" readonly></td>'



                                +'</tr>';



                    });



                     $('#item_details tbody').append(trHtml);



                    $("div.overlay").css("display", "none");



                }else



                {



                    $("div.overlay").css("display", "none");



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found.."});



                    $('#po_ref_no').val('');



                    $('#po_ref_no').focus();



                }







        },



        error:function(error)



        {



        $("div.overlay").css("display", "none");



        }



    });



}



/*$(document).on('keyup','.fix_weight,.rate_fix_rate',function(e){



    var row = $(this).closest('tr');



    var balance_wt=row.find('.balance_wt').val();



    var fix_weight=row.find('.fix_weight').val();



    if(parseFloat(balance_wt)<parseFloat(fix_weight))



    {



        row.find('.fix_weight').val('');



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Weight"});



    }



    else



    {



        calculate_rate_fixing_items_payment(row);



    }



});



function calculate_rate_fixing_items_payment(curRow)



{



    var fix_weight=(isNaN(curRow.find('.fix_weight').val()) || curRow.find('.fix_weight').val()=='' ? 0 :curRow.find('.fix_weight').val() );



    var rate_per_gram=(isNaN(curRow.find('.rate_fix_rate').val()) || curRow.find('.rate_fix_rate').val()=='' ? 0 :curRow.find('.rate_fix_rate').val() );



    curRow.find('.payable_amt').val(parseFloat(parseFloat(fix_weight)*parseFloat(rate_per_gram)).toFixed(2));



}*/



$('#rate_fix_submit').on('click',function(){



    var allow_submit=true;



    if($('#item_details > tbody tr').length == 0)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found.."});



        $("div.overlay").css("display", "none");



    }



    else



    {



        $('#item_details > tbody tr').each(function(bidx, brow){



             curRow = $(this);



             if(curRow.find('.fix_weight').val()=='' || curRow.find('.fix_weight').val()==0 || curRow.find('.rate_fix_rate').val()=='' || curRow.find('.rate_fix_rate').val()==0)



             {



                 allow_submit=false;



             }



        });



         if(allow_submit)



         {



               $("div.overlay").css("display", "block");



            	var form_data=$('#rate_fixing_form').serialize();



            	$('#rate_fix_submit').prop('disabled',true);



            	my_Date = new Date();



            	var url=base_url+ "index.php/admin_ret_purchase/rate_fixing/save?nocache=" + my_Date.getUTCSeconds();



                $.ajax({



                    url:url,



                    data: form_data,



                    type:"POST",



                    dataType:"JSON",



                    success:function(data){



            			if(data.status)



            			{



            			    $("div.overlay").css("display", "none");



            			    window.location.reload();



            			}



            			else



            			{



            			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



            			    $("div.overlay").css("display", "none");



            			}







                    },



                    error:function(error)



                    {



                    $("div.overlay").css("display", "none");



                    }



                });



        }



        else



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please File The Required Fields.."});



            $("div.overlay").css("display", "none");



        }



    }







});



//Net Banking



$('#net_bank_modal').on('click',function(){



    $('#netbanking_modal').modal('show');



    if($('#net_banking_details > tbody > tr').length==0)



    {



         create_new_empty_net_banking_row();



    }



});



$('#create_net_banking_row').on('click', function(){



	if(validateNetBankingDetailRow())



	{



		create_new_empty_net_banking_row();



	}



	else



	{



	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please File The Required Fields.."});



	}



});



function validateNetBankingDetailRow(){



	var row_validate = true;



	$('#netbanking_modal .modal-body #net_banking_details > tbody  > tr').each(function(index, tr) {



		if($(this).find('.pay_amount').val() == "" || $(this).find('.ref_no').val() == "" || $(this).find('.id_bank').val() == "" || $(this).find('.nb_date').val() == ""){



			row_validate = false;



		}



	});



	return row_validate;



}



function create_new_empty_net_banking_row()



{



	var row = "";



	var bank_list = '';



	$.each(bank_details, function (pkey, item)



	{



		bank_list += "<option value='"+item.id_bank+"'>"+item.acc_number+"</option>";



	});







	row += '<tr>'



	            +'<td><select class="form-control nb_type"><option value="RTGS">RTGS</option><option value="NEFT">NEFT</option></select></td>'



	            +'<td><select class="form-control id_bank" name="nb_details[id_bank][]" >'+bank_list+'</select></td> '



	            +'<td><input class="form-control  datemask date nb_date" data-date-format="yyyy-mm-dd" name="nb_details[nb_date][]" type="text" placeholder="NB Date" /></td>'



    	        +'<td><input type="number" class="form-control pay_amount" type="number"/></td>'



    	        +'<td><input class="form-control ref_no" type="text"/></td>'



    	        +'<td><a href="#" onClick="remove_net_banking_row($(this).closest(\'tr\'));" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



	        +'</tr>';



	$('#net_banking_details tbody').append(row);



	$('#net_banking_details > tbody').find('tr:last td:eq(0) .pay_amount').focus();



	var date = new Date();



    var today = new Date(date.getFullYear(), date.getMonth(), date.getDate());



    $('.nb_date').datepicker({ dateFormat: 'yyyy-mm-dd',endDate:today });



}



function remove_net_banking_row(curRow)



{



	curRow.remove();



}



$('#save_net_banking').on('click',function(){



    if(validateNetBankingDetailRow())



    {



        net_banking_details=[];



       var total_amount=0;



        $('#netbanking_modal .modal-body #net_banking_details > tbody  > tr').each(function(index, tr) {



    		if($(this).find('.pay_amount').val() != ""){



        		total_amount+=parseFloat($(this).find('.pay_amount').val());



        		net_banking_details.push({



        		    'pay_amount':$(this).find('.pay_amount').val(),



        		    'nb_type':$(this).find('.nb_type').val(),



        		    'ref_no':$(this).find('.ref_no').val(),



        		    'id_bank':$(this).find('.id_bank').val(),



        		    'nb_date':$(this).find('.nb_date').val(),



        		});



    		}



    	});







    	$('#payment_modes > tbody >tr').each(function(bidx, brow){



    				bill_chit_row = $(this);



    				bill_chit_row.find('#tot_net_banking_amt').html(parseFloat(total_amount).toFixed(2));



    				bill_chit_row.find('#net_banking_pay_details').val(net_banking_details.length>0 ? JSON.stringify(net_banking_details):'');



    			});







    	$('#netbanking_modal').modal('toggle');



    	if(ctrl_page[1]=='supplier_rate_cut')



    	{



    	    calculate_supplier_rate_cut_payment_cost();



    	}



    	else{



    	    calculatePaymentCost();



    	}



    }



    else



	{



	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please File The Required Fields.."});



	}







});



//Net Banking





//Chque starts





$('#cheque_modal').on('click',function(){



    $('#cheque-detail-modal').modal('show');



    if($('#chq_details > tbody > tr').length==0)



    {



        create_new_empty_chqpay_row();



    }



});



$('#new_chq').on('click', function () {



	$("#chqPayAlert span").remove();







	if (validateChqDetailRow()) {





		create_new_empty_chqpay_row();



	} else {



		$("#chqPayAlert").append("<span>Please fill all fields in current row.</span>");



		$('#chqPayAlert span').delay(20000).fadeOut(500);



	}



});



function validateChqDetailRow() {



	var row_validate = true;



	$('#chq_details > tbody  > tr').each(function (index, tr) {



		if ($(this).find('.bank_name').val() == "" || $(this).find('.bank_branch').val() == "" || $(this).find('.cheque_no').val() == "" || $(this).find('.payment_amount').val() == "") {



			row_validate = false;



		}



	});



	return row_validate;



}



function create_new_empty_chqpay_row() {



	var row = "";



	var bank_list = '';



	$.each(bank_details, function (pkey, item) {



		bank_list += "<option value='" + item.id_bank + "'>" + item.acc_number + "</option>";



	});



	row += '<tr>'



        + '<td><input id="cheque_datetime" data-date-format="dd-mm-yyyy" class="cheque_date" name="cheque_details[cheque_date][]" type="text"  placeholder="Cheque Date" /></td>'



        + ' <td><input name="cheque_details[bank_name][]" type="text"  class="bank_name"></td>'



        + '<td><input name="cheque_details[bank_branch][]" type="text" class="bank_branch"></td>'



        +'<td><input type="number" step="any" class="cheque_no" name="cheque_details[cheque_no][]"/></td>'



        +' <td><input type="text" step="any" class="bank_IFSC" name="cheque_details[bank_IFSC][]"/></td>'



        +' <td><input type="number" step="any" class="payment_amount" name="cheque_details[payment_amount][]"/></td>'



		+ '<td><a href="#" onClick="removeChq_row($(this).closest(\'tr\'));" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



		+ '</tr>';







	$('#chq_details tbody').append(row);



	$('.cheque_date').datepicker({ dateFormat: 'yyyy-mm-dd', })



}



$(document).on('keyup', '.payment_amount', function (e) {



	if (e.which === 13) {



		e.preventDefault();



		if (validateChqDetailRow()) {



			create_new_empty_chqpay_row();



		} else {



			alert("Please fill required fields");



		}



	}



	calculate_chq_Amount();



});



function removeChq_row(curRow) {



	curRow.remove();



	calculate_chq_Amount();



}



function calculate_chq_Amount() {



	var total_amount = 0;



	var chq_amount = 0;



	chq_payment = [];



	$('#cheque-detail-modal .modal-body #chq_details > tbody  > tr').each(function (index, tr) {



		if ($(this).find('.payment_amount').val() != "") {



			chq_amount += parseFloat($(this).find('.payment_amount').val());



			//chq_payment.push({'cheque_date':$(this).find('.cheque_date').val(),'cheque_no':$(this).find('.cheque_no').val(),'bank_branch':$(this).find('.bank_branch').val(),'bank_name':$(this).find('.bank_name').val(),'payment_amount':$(this).find('.payment_amount').val()});



		}



	});



	$('.chq_total_amount').html(parseFloat(chq_amount).toFixed(2));



	$('#chq_billed_cash').val(parseFloat(chq_amount).toFixed(2));



}



$('#add_newchq').on('click', function () {



	if (validateChqDetailRow()) {



		$('#cheque-detail-modal .modal-body #chq_details > tbody  > tr').each(function (index, tr) {



			if ($(this).find('.payment_amount').val() != "") {



				chq_payment.push({ 'cheque_date': $(this).find('.cheque_deposit_date').val(), 'cheque_no': $(this).find('.cheque_no').val(), 'id_bank': $(this).find('.id_bank').val(), 'bank_branch': $(this).find('.bank_branch').val(), 'bank_name': $(this).find('.bank_name').val(), 'payment_amount': $(this).find('.payment_amount').val() });



			}



		});



		$('#payment_modes > tbody >tr').each(function (bidx, brow) {



			bill_card_pay_row = $(this);



			bill_card_pay_row.find('.CHQ').html($('.chq_total_amount').html());



			bill_card_pay_row.find('#chq_payment').val(chq_payment.length > 0 ? JSON.stringify(chq_payment) : '');



		});



		$('#cheque-detail-modal').modal('toggle');



		calculatePaymentCost();



	} else {



		alert("Please fill required fields");



	}



});





$(document).on('focus', '.cheque_date', function (e) {

    var row = $(this).closest('tr');

    row.find('.cheque_date').datepicker({

        format: 'dd-mm-yyyy'

    });

});



$('#save_issue_chq').on('click', function () {



	var chq_payment = [];



	if (validateChqDetailRow()) {



		$('#cheque-detail-modal .modal-body #chq_details > tbody  > tr').each(function (index, tr) {



			if ($(this).find('.payment_amount').val() != "") {



				chq_payment.push({ 'cheque_date': $(this).find('.cheque_date').val(), 'cheque_no': $(this).find('.cheque_no').val(), 'id_bank': $(this).find('.id_bank').val(), 'bank_branch': $(this).find('.bank_branch').val(), 'bank_name': $(this).find('.bank_name').val(), 'payment_amount': $(this).find('.payment_amount').val() });



			}

		});



		$('#payment_modes > tbody >tr').each(function (bidx, brow) {



			bill_card_pay_row = $(this);



			bill_card_pay_row.find('#cheque_payment').html($('.chq_total_amount').html());



			bill_card_pay_row.find('#chq_payment').val(chq_payment.length > 0 ? JSON.stringify(chq_payment) : '');



		});



		$('#cheque-detail-modal').modal('toggle');



        calculatePaymentCost();



	} else {



		alert("Please fill required fields");



	}



});

//Cheque ends



//Sales Details



$('#create_sales_details_row').on('click', function(){



	if(validateSalesDetailRow())



	{



		create_new_empty_sales_details_row();



	}



	else



	{



	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please File The Required Fields.."});



	}



});



function validateSalesDetailRow(){



	var row_validate = true;



	$('#sales_adjustment_add .modal-body #bill_details > tbody  > tr').each(function(index, tr) {



		if($(this).find('.bill_id').val() == ""){



			row_validate = false;



		}



	});



	return row_validate;



}



function create_new_empty_sales_details_row()



{



	var row = "";



	row += '<tr>'



    	        +'<td><input type="text" class="form-control bill_no"/><input type="hidden" class="form-control bill_id"/></td>'



    	        +'<td><input type="number" class="form-control payment_amount" type="text" readonly/></td>'



    	        +'<td><a href="#" onClick="remove_sales_details_row($(this).closest(\'tr\'));" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



	        +'</tr>';



	$('#bill_details tbody').append(row);



	$('#bill_details > tbody').find('tr:last td:eq(0) .pay_amount').focus();



}



function remove_sales_details_row(curRow)



{



	curRow.remove();



}



$('#save_sales_details').on('click',function(){



   sales_details=[];



   var total_amount=0;



    $('#sales_adjustment_add .modal-body #bill_details > tbody  > tr').each(function(index, tr) {



		if($(this).find('.payment_amount').val() != ""){



    		total_amount+=parseFloat($(this).find('.payment_amount').val());



    		sales_details.push({'pay_amount':$(this).find('.payment_amount').val(),'bill_id':$(this).find('.bill_id').val()});



		}



	});



	$('#payment_modes > tbody >tr').each(function(bidx, brow){



				bill_chit_row = $(this);



				bill_chit_row.find('#tot_sales_amt').html(total_amount);



				bill_chit_row.find('#sales_details').val(sales_details.length>0 ? JSON.stringify(sales_details):'');



			});







	$('#sales_adjustment_add').modal('toggle');



	calculatePaymentCost();



});



$(document).on('keyup','.bill_no', function(e){



		var row = $(this).closest('tr');



		var bill_no = row.find(".bill_no").val();



		getSearchAcc(bill_no, row);



});



function getSearchAcc(searchTxt, curRow){



	my_Date = new Date();



	var bill_cus_id=$('#bill_cus_id').val();



	$.ajax({



        url: base_url+'index.php/admin_ret_purchase/get_bill_details/?nocache=' + my_Date.getUTCSeconds(),



        dataType: "json",



        method: "POST",



        data: {'searchTxt': searchTxt,'bill_cus_id':bill_cus_id},



        success: function (data) {



        	$.each(data, function(key, item){



				$('#bill_details > tbody tr').each(function(idx, row){



					if(item != undefined){



						if($(this).find('.bill_id').val() == item.value){



							data.splice(key, 1);



						}



					}



				});



			});



			$( ".bill_no" ).autocomplete(



			{



			    appendTo: "#sales_adjustment_add",



				source: data,



				select: function(e, i)



				{



					e.preventDefault();







					curRow.find(".bill_no").val(i.item.label);



					curRow.find(".bill_id").val(i.item.value);



					curRow.find(".payment_amount").val(i.item.tot_bill_amount);



				},



				change: function (event, ui) {



					if (ui.item === null) {



						$(this).val('');



						curRow.find('.bill_no').val('');



						curRow.find(".bill_id").val("");



						curRow.find(".payment_amount").val("");



					}



			    },



				response: function(e, i) {



		            // ui.content is the array that's about to be sent to the response callback.



		            if(searchTxt != ""){



						if (i.content.length === 0) {



						    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter The Valid Bill No.."});



						}



					}else{



					}



		        },



				 minLength: 1,



			});



        }



     });



}



//Sales Details



//Advance adj



$('#advance_adj').on('click',function(){



    if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select The Supplier.."});



    }



    else



    {



        get_supplier_advance_details();



    }







});



function get_supplier_advance_details()



{



    my_Date = new Date();



	var id_karigar=$('#select_karigar').val();



	$.ajax({



        url: base_url+'index.php/admin_ret_purchase/supplier_po_payment/supplier_advance_details/?nocache=' + my_Date.getUTCSeconds(),



        dataType: "json",



        method: "POST",



        data: {'id_karigar': id_karigar},



        success: function (data) {



            if(data.amount > 0)



            {



                $('.total_amount').val(data.amount);



                $('.id_wallet').val(data.id_wallet);



                $('.adjusted_amount').val(data.amount);



                $('#advance_adjustment_add').modal('toggle');



            }



            else



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Your Wallet Amount is 0.."});



            }



        }



     });



}



$(document).on('keyup', ".adjusted_amount", function(e) {



    var curRow     = $(this).parent().closest('tr');



    var total_amount = curRow.find('.total_amount').val();



    var adjusted_amount = curRow.find('.adjusted_amount').val();



    if(parseFloat(adjusted_amount)>parseFloat(total_amount))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Adjusted Amount is Grater Than the Receipt Amount"});



        curRow.find('.adjusted_amount').val(0);



    }



});



$('#save_adv_adj_details').on('click',function(){



   advance_details=[];



   var adjusted_amount=0;



    $('#advance_adjustment_add .modal-body #advance_adj_details > tbody  > tr').each(function(index, tr) {



		if($(this).find('.adjusted_amount').val() != ""){



    		adjusted_amount+=parseFloat($(this).find('.adjusted_amount').val());



    		advance_details.push({'adjusted_amount':$(this).find('.adjusted_amount').val(),'id_wallet':$(this).find('.id_wallet').val()});



		}



	});



	$('#payment_modes > tbody >tr').each(function(bidx, brow){



				bill_chit_row = $(this);



				bill_chit_row.find('#total_adv_adj').html(parseFloat(adjusted_amount).toFixed(2));



				bill_chit_row.find('#adv_details').val(advance_details.length>0 ? JSON.stringify(advance_details):'');



			});







	$('#advance_adjustment_add').modal('toggle');



	calculatePaymentCost();



});



//Advance adj



function calculatePaymentCost()



{







    var bal_amount             =0;



    var total_amount           =0;



	var receive_amount         =($('.receive_amount').val()!='' ? $('.receive_amount').val():0);



	var cash_amount            = ($('.cash_amount').val()!='' ? $('.cash_amount').val():0);



	var net_banking_pay        =($('#tot_net_banking_amt').html()!='' ? $('#tot_net_banking_amt').html():0);



	var tot_sales_amt          =($('#tot_sales_amt').html()!='' ? $('#tot_sales_amt').html():0);



	var total_adv_adj          =($('#total_adv_adj').html()!='' ? $('#total_adv_adj').html():0);



    var cheque_amount_pay        =($('#cheque_payment').html()!='' ? $('#cheque_payment').html():0);





	if(receive_amount>0)



	{



	    $('#pay_submit').prop('disabled',false);



		total_amount=parseFloat(parseFloat(net_banking_pay)+parseFloat(cheque_amount_pay)+parseFloat(tot_sales_amt)+parseFloat(total_adv_adj)+parseFloat(cash_amount)).toFixed(2);



		bal_amount = parseFloat(parseFloat(receive_amount)-parseFloat(total_amount)).toFixed(2);



		if(bal_amount==0)



		{



		    $('#pay_submit').prop('disabled',false);



		}else



		{



		    $('#pay_submit').prop('disabled',true);



		}



	}



	else



	{



	    $('#pay_submit').prop('disabled',true);



	}



	console.log('bal_amount:'+bal_amount);



	console.log('receive_amount:'+receive_amount);



	$('#total_pay_amount').html(total_amount);



	$('#bal_amount').html(bal_amount);



}



//rate fixing



//purchase return



$("input[name='stock_type']:radio").on('change',function(){



    insertedcatdetails=[];



    nontagreturnitemlist=[];



    returntaggeditemlist=[];



    purchasereturnitemlist=[];



    updatereturncategory();



    showPurchaseReturnpreview();







});



$('#purchase_return_search').click(function (event) {



    get_returned_po_details();



});



function get_po_ref_nos()



{



    $.ajax({



    type: 'POST',



    url: base_url+'index.php/admin_ret_purchase/getpurchase_po_list',



    dataType:'json',



    success:function(data){



        var id=$('#select_po_ref_no').val();



        $.each(data, function (key, item) {



            $("#select_po_ref_no").append(



            $("<option></option>")



            .attr("value", item.value)



            .text(item.label)



            );



        });



        $("#select_po_ref_no").select2(



        {



            placeholder:"Select PO Ref",



            closeOnSelect: true



        });







        if($("#select_po_ref_no").length)



        {



            $("#select_po_ref_no").select2("val",(id!='' && id>0?id:''));



        }



            $(".overlay").css("display", "none");



        }



    });



}



function get_returned_po_details()



{



	$("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



	 url:base_url+ "index.php/admin_ret_purchase/purchasereturn/ajax?nocache=" + my_Date.getUTCSeconds(),



	 dataType:"JSON",



	 type:"POST",



     data:{'po_ref_no':$('#select_po_ref_no').val(),'from_date':$('#rpt_payments1').text(),'to_date':$('#rpt_payments2').text(),'karigar':$('#select_karigar').val(),'purchase':$('#purchase_type').val(),'transcation_type':$('#transcation_type').val()},



	 success:function(data){



	 	var list=data.list;



	 	var access=data.access;



        var profile = data.profile;



        var currentDate = new Date();



        var formattedCurrentDate =

        currentDate.getDate().toString().padStart(2, '0') + '-' +

        (currentDate.getMonth() + 1).toString().padStart(2, '0') + '-' +

        currentDate.getFullYear();





		var oTable = $('#pur_return_list').DataTable();



		oTable.clear().draw();



		if (list!= null && list.length > 0)



		{



			oTable = $('#pur_return_list').dataTable({



            "bDestroy": true,



            "bInfo": true,



            "bFilter": true,



            "bSort": true,



            "order": [[ 0, "desc" ]],



            "dom": 'lBfrtip',



            "buttons" : ['excel','print'],



            "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



            "aaData": list,



            "aoColumns": [



                { "mDataProp": "pur_return_id" },



                { "mDataProp": "karigar_name" },



				{ "mDataProp": "pur_ret_ref_no" },



                { "mDataProp": "date_add" },



                { "mDataProp": "ret_pcs" },



                { "mDataProp": "ret_wt" },



                { "mDataProp": "purchase_type" },



                { "mDataProp": "transcation_type" },



                { "mDataProp": "po_ref_no"},



                { "mDataProp": "pur_ret_status" },



                { "mDataProp": "reason" },



                { "mDataProp": function ( row, type, val, meta ) {



                    id=row.pur_return_id;



                    edit_target=(access.edit=='0'?"":"#confirm-edit");



                    print_url=base_url+'index.php/admin_ret_purchase/return_receipt_acknowladgement/'+id+'/'+1;



                    detailed_print_url=base_url+'index.php/admin_ret_purchase/return_receipt_acknowladgement/'+id+'/'+2;



                    action_content='<a href="'+print_url+'" target="_blank" class="btn btn-info btn-print" data-toggle="tooltip" title="Return Receipt"><i class="fa fa-print" ></i></a><a href="'+detailed_print_url+'" target="_blank" class="btn btn-primary btn-print" data-toggle="tooltip" title="Detailed Print"><i class="fa fa-print" ></i></a>'+((row.date_add ==  formattedCurrentDate || profile.previous_bill_cancel == 1) && row.bill_status==1 && access.delete == '1' ? '<button class="btn btn-warning" onclick="confirm_return_cancel('+id+','+row.tag_issue_from+','+row.nontag_issue_from+')"><i class="fa fa-close" ></i></button>' :'');



                    return action_content;



                }



                }



              ]



            });







		}



		$("div.overlay").css("display", "none");



	  },



	  error:function(error)



	  {



		 $("div.overlay").css("display", "none");



	  }



  });



}



function confirm_return_cancel(pur_return_id,tag_issue_from,nontag_issue_from)



{



	$('#pur_return_id').val(pur_return_id);



    $('#tag_issue_from').val(tag_issue_from);



    $('#nontag_issue_from').val(nontag_issue_from);



	$('#confirm-delete').modal('show');



}



$('#ret_cancel_remark').on('keypress',function(){



	if(this.value.length>6)



	{



		$('#ret_cancel').prop('disabled',false);



	}else{



		$('#ret_cancel').prop('disabled',true);



	}



});



$('#ret_cancel').on('click',function(){



    $('#ret_cancel').prop('disabled',true);



	my_Date = new Date();



	$.ajax({



		type: 'POST',



		url:base_url+ "index.php/admin_ret_purchase/purchasereturn/cancel_ret_entry?nocache=" + my_Date.getUTCSeconds(),



		dataType:'json',



		data:{'cancel_reason':$('#ret_cancel_remark').val(),'pur_return_id':$('#pur_return_id').val(),'tag_issue_from':$('#tag_issue_from').val(),'nontag_issue_from':$('#nontag_issue_from').val()},



		success:function(data){



		    window.location.reload();



		}



	});



});



function get_return_item_po_ref_nos()



{



    var purchase_type = $("input[name='purchase_type']:checked").val();



    $("#select_po_ref_no option").remove();



	$.ajax({



	type: 'POST',



	data:{'id_karigar':$('#select_karigar').val(),'purchase_type':purchase_type},



	url: base_url+'index.php/admin_ret_purchase/getreturn_po_list',



	dataType:'json',



	success:function(data){



	    var id=$('#select_po_ref_no').val();



		$.each(data, function (key, item) {



		    $("#select_po_ref_no").append(



		    $("<option></option>")



		    .attr("value", item.value)



		    .text(item.label)



		    );



		});



		$("#select_po_ref_no").select2(



		{



			placeholder:"Select PO Ref",



			closeOnSelect: true



		});







		if($("#select_po_ref_no").length)



		{



		    $("#select_po_ref_no").select2("val",(id!='' && id>0?id:''));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



$("#tag_number,#old_tag_number").keypress(function(e) {



    if(e.which == 13)



    {



        if($('#old_tag_number').val()!='' || $('#tag_number').val()!='' )



        {



            var old_tag_number=$('#old_tag_number').val().replaceAll(' ','');



            get_tag_scan_details($("#tag_number").val(),old_tag_number);



        }



        else



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter The Tag No.."});



        }







    }



});



$('#tag_history_search').on('click',function()

{

    if(ctrl_page[1]=='karigarmetalissue')

    {

        var old_tag_number=$('#old_tag_code').val().replaceAll(' ','');

        var issue_from = $("input[name='issue[issue_from]']:checked").val(); // 1 -> Tag , 2 ->Nontag

        var tag_issue_from = $("input[name='issue[tag_issue_from]']:checked").val(); // 1->Availble Stock , 2 ->Sales Return , 3 ->Partly Sales

        var nontag_issue_from = $("input[name='issue[nontag_issue_from]']:checked").val(); // 2 -> Nontag Sales return , 3 - > Non tag Other Issue



        if(issue_from==1)

        {

            if(tag_issue_from==1)

            {

                getAvailableTagDetails($("#tag_code").val(),old_tag_number);

            }else if(tag_issue_from==2)

            {

                if($("#bt_number").val()!=''){

                    get_sales_return_tags();

                }else{

                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Plase Enter The BT Code"});

                }

            }else if(tag_issue_from==3)

            {

                if($("#bt_number").val()!=''){

                    get_partly_sold_tags();

                }else{

                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Plase Enter The BT Code"});

                }



            }else if(tag_issue_from==4)

            {

                if($("#bt_number").val()!=''){

                    get_HO_otherissue_tags();



                }else{

                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Plase Enter The BT Code"});

                }

            }



        }

        else

        {

            if(nontag_issue_from==2)

            {

                if($("#bt_number").val()!='')

                {

                    getNontagSalesReturn();

                }else{

                    $.toaster({priority:'danger',title:'Warning!',message:''+"</br>Please Enter The BT Code"});

                }

            }

            else if(nontag_issue_from==3)

            {

                if($('#bt_number').val()!='')

                {

                    getNontagOtherIssue();

                }else

                {

                    $.toaster({priority:'danger',title:'Warning!',message:''+"</br>Please Enter The BT Code"});

                }

            }

        }



    }



    else if(ctrl_page[1]=='purchasereturn')

    {



        var tag_issue_from = $("input[name='tag_issue_from']:checked").val(); // 1->Availble Stock , 2 ->Sales Return , 3 ->Partly Sales



            if(tag_issue_from==1)

            {

                if($('#old_tag_number').val()!='' || $('#tag_number').val()!='' )

                {

                    var old_tag_number=$('#old_tag_number').val().replaceAll(' ','');

                    get_tag_scan_details($("#tag_number").val(),old_tag_number);

                }

                else

                {

                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter The Tag No.."});

                }

            }



            else if(tag_issue_from==2) // Sales Return

            {

                get_retagging_details(1);

            }

            else if(tag_issue_from==3) // Partly Sales

            {

                get_partlySaleDetails();

            }

            else if(tag_issue_from==4)  // H.O Other Issue

            {

                if($('#bt_number').val()!='')

                {

                    get_retagging_details(2);



                }else

                {

                    $.toaster({priority:'danger',title:'Warning!',message:''+"</br>Please Enter The BT Code"});

                }

            }





    }



});



$('#nontag_search').on('click',function()

{

    if(ctrl_page[1]=='purchasereturn')

    {

        var nontag_issue_from = $("input[name='nontag_issue_from']:checked").val(); // 2- > Nontag Sales Return , 3 -> Nontag Other Issue



        if(nontag_issue_from==2)

        {

            get_nontag_sales_retrun();

        }

        else if(nontag_issue_from==3)

        {

            get_nontag_other_issue();

        }

    }



});



function get_sales_return_tags()

{

    $("div.overlay").css("display", "block");

	my_Date = new Date();

    $.ajax({

		url: base_url+"index.php/admin_ret_tagging/retagging/ajax?nocache=" + my_Date.getUTCSeconds(),

		type:"POST",

		data:{'report_type':1,'id_branch':1,'bt_number':$("#bt_number").val()},

		dataType: 'json',

		cache:false,

		success:function(data)

        {

            if(data!=null && data.length>0)

            {

                var trHtml='';

                $.each(data, function(key,item)

                {

                    var rowExists=false;

                    $('#metal_details > tbody tr').each(function(bidx, brow)

                    {

                        curRow = $(this);

                        if(curRow.find('.tag_id').val()==item.tag_id)

                        {

                            rowExists=true;

                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});

                            $("div.overlay").css("display", "none");

                        }

                    });



                    var uom_list = "<option value=''>-UOM-</option>";

                    $.each(uom_details, function (pkey, pitem)

                    {

                        var uom_selected ="";

                        if(pitem.uom_id==item.uom)

                        {

                            uom_selected = "selected='selected'";

                        }

                        uom_list += "<option value='"+pitem.uom_id+"' "+uom_selected+">"+pitem.uom_name+"</option>";

                    });



                    var purity = "<option value='"+item.id_purity+"'>"+item.purity+"</option>";

                    var purewt = 0;

                    if(!rowExists)

                    {

                        trHtml='<tr>'



                            +'<td style="width:100px;"><input type="checkbox" class="id_kar_issue" name="metal_details[id_kar_issue][]" value="">' +item.tag_code+ '<input type="hidden" class="tag_id" name="metal_details[tag_id][]" value="'+item.tag_id+'"></td>'



                            +'<td>'+item.tag_date+'</td>'



                            +'<td>'+item.supplier_name+'</td>'



                            +'<td style="width:100px;"><input type="hidden" class="metal" name="metal_details[metal][]" value="'+item.id_metal+'"><input type="hidden" class="category" name="metal_details[category][]" value="'+item.cat_id+'">'+item.catname+'<input type="hidden" class="issue_against" name="metal_details[issue_against][]" value="'+$("input[type='radio'][name='issue[issue_aganist]']:checked").val()+'"><input type="hidden" class="issue_against_po" name="metal_details[issue_against_po][]" value="'+$("input[type='radio'][name='issue[issue_against_po]']:checked").val()+'"><input type="hidden" class="po_item_id" name="metal_details[po_item_id][]" value=""></td>'



                            +'<td style="width:100px;"><input type="hidden" class="id_section" name="metal_details[id_section][]" value="'+item.id_section+'">'+item.section+'</td>'



                            +'<td style="width:100px;"><input type="hidden" class="product" name="metal_details[id_product][]" value="'+item.product_id+'"><input type="hidden" class="design" name="metal_details[id_design][]" value="'+item.design_id+'"><input type="hidden" class="id_sub_design" name="metal_details[id_sub_design][]" value="'+item.id_sub_design+'">'+item.product_name+'</td>'



                            +'<td><select class="form-control" id="select_purity" style="width:100px;">'+purity+'</select></td>'



                            +'<td><div class="input-group"><span><input type="number" class="issue_pcs form-control" style="width:100px;"name="metal_details[pcs][]" value="'+item.piece+'" readonly><input type="hidden" class="available_pcs form-control" name="" value="'+item.piece+'"></span><span>&nbsp; of &nbsp;'+item.piece+'<br/></span></div></td>'



                            +'<td><div class="input-group"><span><input class="issue_weight form-control" type="number" name="metal_details[weight][]" value="'+item.gross_wt+'" style="width:80px;" /><input type="hidden" class="available_weight" name="" value="'+item.gross_wt+'"><select class="uom_id form-control" name="metal_details[uom_id][]" style="width: 80px;">'+uom_list+'</select></span><span>&nbsp; of &nbsp;'+ item.gross_wt +'<br/></span></div></td>'



                            +'<td><input type="number" class="pur_weight form-control" id="pur_weight" name="metal_details[pur_weight][]" value="'+purewt+'" style="width:80px;" readonly></td>'



                            +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



                        +'</tr>';



                        if($('#metal_details > tbody  > tr').length>0)

                        {

                            $('#metal_details > tbody > tr:first').before(trHtml);

                        }else{

                            $('#metal_details tbody').append(trHtml);

                        }



                        $('#metal_details > tbody').find('#select_purity').select2();



                        $('#metal_details > tbody').find('#select_purity').select2({



                            placeholder: "Purity",



                            allowClear: true



                        });



                        $("div.overlay").css("display", "none");

                    }

                });

            }

            else

            {



			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});



				$("div.overlay").css("display", "none");



			}



            calculateMetalIssuePureWt();

            calculateMetalIssueTotal();

        }

    });





}



function get_partly_sold_tags()

{

    $("div.overlay").css("display", "block");

	my_Date = new Date();

    $.ajax({

		url: base_url+"index.php/admin_ret_tagging/retagging/partly_sale?nocache=" + my_Date.getUTCSeconds(),

		type:"POST",

		data:{'report_type':1,'id_branch':1,'bt_number':$("#bt_number").val()},

		dataType: 'json',

		cache:false,

		success:function(data)

        {

            if(data!=null && data.length>0)

            {

                var trHtml='';

                $.each(data, function(key,item)

                {

                    var rowExists=false;

                    $('#metal_details > tbody tr').each(function(bidx, brow)

                    {

                        curRow = $(this);

                        if(curRow.find('.tag_id').val()==item.tag_id)

                        {

                            rowExists=true;

                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});

                            $("div.overlay").css("display", "none");

                        }

                    });



                    var uom_list = "<option value=''>-UOM-</option>";

                    $.each(uom_details, function (pkey, pitem)

                    {

                        var uom_selected ="";

                        if(pitem.uom_id==item.uom)

                        {

                            uom_selected = "selected='selected'";

                        }

                        uom_list += "<option value='"+pitem.uom_id+"' "+uom_selected+">"+pitem.uom_name+"</option>";

                    });



                    var purity = "<option value='"+item.id_purity+"'>"+item.purity+"</option>";

                    var purewt = 0;

                    if(!rowExists)

                    {

                        trHtml='<tr>'



                            +'<td style="width:100px;"><input type="checkbox" class="id_kar_issue" name="metal_details[id_kar_issue][]" value="">' +item.tag_code+ '<input type="hidden" class="tag_id" name="metal_details[tag_id][]" value="'+item.tag_id+'"></td>'



                            +'<td>'+item.tag_date+'</td>'



                            +'<td>'+item.supplier_name+'</td>'



                            +'<td style="width:100px;"><input type="hidden" class="metal" name="metal_details[metal][]" value="'+item.id_metal+'"><input type="hidden" class="category" name="metal_details[category][]" value="'+item.cat_id+'">'+item.catname+'<input type="hidden" class="issue_against" name="metal_details[issue_against][]" value="'+$("input[type='radio'][name='issue[issue_aganist]']:checked").val()+'"><input type="hidden" class="issue_against_po" name="metal_details[issue_against_po][]" value="'+$("input[type='radio'][name='issue[issue_against_po]']:checked").val()+'"><input type="hidden" class="po_item_id" name="metal_details[po_item_id][]" value=""></td>'



                            +'<td style="width:100px;"><input type="hidden" class="id_section" name="metal_details[id_section][]" value="'+item.id_section+'">'+item.section+'</td>'



                            +'<td style="width:100px;"><input type="hidden" class="product" name="metal_details[id_product][]" value="'+item.product_id+'"><input type="hidden" class="design" name="metal_details[id_design][]" value="'+item.design_id+'"><input type="hidden" class="id_sub_design" name="metal_details[id_sub_design][]" value="'+item.id_sub_design+'">'+item.product_name+'</td>'



                            +'<td><select class="form-control" id="select_purity"  style="width:100px;">'+purity+'</select></td>'



                            +'<td><div class="input-group"><span><input type="number" class="issue_pcs form-control" style="width:100px;"name="metal_details[pcs][]" value="'+item.blc_pcs+'" readonly><input type="hidden" class="available_pcs form-control" name="" value="'+item.blc_pcs+'"></span><span>&nbsp; of &nbsp;'+item.blc_pcs+'<br/></span></div></td>'



                            +'<td><div class="input-group"><span><input class="issue_weight form-control" type="number" name="metal_details[weight][]" value="'+item.blc_gwt+'" style="width:80px;" /><input type="hidden" class="available_weight" name="" value="'+item.blc_gwt+'"><select class="uom_id form-control" name="metal_details[uom_id][]" style="width: 80px;">'+uom_list+'</select></span><span>&nbsp; of &nbsp;'+ item.blc_gwt +'<br/></span></div></td>'



                            +'<td><input type="number" class="pur_weight form-control" id="pur_weight" name="metal_details[pur_weight][]" value="'+purewt+'" style="width:80px;" readonly></td>'



                            +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



                        +'</tr>';



                        if($('#metal_details > tbody  > tr').length>0)

                        {

                            $('#metal_details > tbody > tr:first').before(trHtml);

                        }else{

                            $('#metal_details tbody').append(trHtml);

                        }



                        $('#metal_details > tbody').find('#select_purity').select2();



                        $('#metal_details > tbody').find('#select_purity').select2({



                            placeholder: "Purity",



                            allowClear: true



                        });



                        $("div.overlay").css("display", "none");

                    }

                });

                calculateMetalIssuePureWt();

                calculateMetalIssueTotal();

            }

            else

            {



			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});



				$("div.overlay").css("display", "none");



			}

        }

    });





}



function get_HO_otherissue_tags()

{

    $("div.overlay").css("display", "block");

	my_Date = new Date();

    $.ajax({

		url: base_url+"index.php/admin_ret_tagging/retagging/ajax?nocache=" + my_Date.getUTCSeconds(),

		type:"POST",

		data:{'report_type':2,'id_branch':1,'bt_number':$("#bt_number").val()},

		dataType: 'json',

		cache:false,

		success:function(data)

        {

            if(data!=null && data.length>0)

            {

                var trHtml='';

                $.each(data, function(key,item)

                {

                    var rowExists=false;

                    $('#metal_details > tbody tr').each(function(bidx, brow)

                    {

                        curRow = $(this);

                        if(curRow.find('.tag_id').val()==item.tag_id)

                        {

                            rowExists=true;

                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});

                            $("div.overlay").css("display", "none");

                        }

                    });



                    var uom_list = "<option value=''>-UOM-</option>";

                    $.each(uom_details, function (pkey, pitem)

                    {

                        var uom_selected ="";

                        if(pitem.uom_id==item.uom)

                        {

                            uom_selected = "selected='selected'";

                        }

                        uom_list += "<option value='"+pitem.uom_id+"' "+uom_selected+">"+pitem.uom_name+"</option>";

                    });



                    var purity = "<option value='"+item.id_purity+"'>"+item.purity+"</option>";

                    var purewt = 0;

                    if(!rowExists)

                    {

                        trHtml='<tr>'



                            +'<td style="width:100px;"><input type="checkbox" class="id_kar_issue" name="metal_details[id_kar_issue][]" value="">' +item.tag_code+ '<input type="hidden" class="tag_id" name="metal_details[tag_id][]" value="'+item.tag_id+'"></td>'



                            +'<td>'+item.tag_date+'</td>'



                            +'<td>'+item.supplier_name+'</td>'



                            +'<td style="width:100px;"><input type="hidden" class="metal" name="metal_details[metal][]" value="'+item.id_metal+'"><input type="hidden" class="category" name="metal_details[category][]" value="'+item.cat_id+'">'+item.catname+'<input type="hidden" class="issue_against" name="metal_details[issue_against][]" value="'+$("input[type='radio'][name='issue[issue_aganist]']:checked").val()+'"><input type="hidden" class="issue_against_po" name="metal_details[issue_against_po][]" value="'+$("input[type='radio'][name='issue[issue_against_po]']:checked").val()+'"><input type="hidden" class="po_item_id" name="metal_details[po_item_id][]" value=""></td>'



                            +'<td style="width:100px;"><input type="hidden" class="id_section" name="metal_details[id_section][]" value="'+item.id_section+'">'+item.section+'</td>'



                            +'<td style="width:100px;"><input type="hidden" class="product" name="metal_details[id_product][]" value="'+item.product_id+'"><input type="hidden" class="design" name="metal_details[id_design][]" value="'+item.design_id+'"><input type="hidden" class="id_sub_design" name="metal_details[id_sub_design][]" value="'+item.id_sub_design+'">'+item.product_name+'</td>'



                            +'<td><select class="form-control" id="select_purity" style="width:100px;">'+purity+'</select></td>'



                            +'<td><div class="input-group"><span><input type="number" class="issue_pcs form-control" style="width:100px;"name="metal_details[pcs][]" value="'+item.piece+'" readonly><input type="hidden" class="available_pcs form-control" name="" value="'+item.piece+'"></span><span>&nbsp; of &nbsp;'+item.piece+'<br/></span></div></td>'



                            +'<td><div class="input-group"><span><input class="issue_weight form-control" type="number" name="metal_details[weight][]" value="'+item.gross_wt+'" style="width:80px;" /><input type="hidden" class="available_weight" name="" value="'+item.gross_wt+'"><select class="uom_id form-control" name="metal_details[uom_id][]" style="width: 80px;">'+uom_list+'</select></span><span>&nbsp; of &nbsp;'+ item.gross_wt +'<br/></span></div></td>'



                            +'<td><input type="number" class="pur_weight form-control" id="pur_weight" name="metal_details[pur_weight][]" value="'+purewt+'" style="width:80px;" readonly></td>'



                            +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



                        +'</tr>';



                        if($('#metal_details > tbody  > tr').length>0)

                        {

                            $('#metal_details > tbody > tr:first').before(trHtml);

                        }else{

                            $('#metal_details tbody').append(trHtml);

                        }



                        $('#metal_details > tbody').find('#select_purity').select2();



                        $('#metal_details > tbody').find('#select_purity').select2({



                            placeholder: "Purity",



                            allowClear: true



                        });



                        $("div.overlay").css("display", "none");

                    }

                });

            }

            else

            {



			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});



				$("div.overlay").css("display", "none");



			}



            calculateMetalIssuePureWt();

            calculateMetalIssueTotal();

        }

    });

}



function getNontagSalesReturn()

{

    $("div.overlay").css("display","block");

    my_Date = new Date();

    $.ajax({

        url: base_url+"index.php/admin_ret_tagging/retagging/non_tag_details?nocache=" + my_Date.getUTCSeconds(),

		type:"POST",

		data:{'id_branch':$("#select_branch").val(),'bt_number':$("#bt_number").val()},

		dataType: 'json',

		cache:false,

		success:function(data)

        {

            console.log(data);

            if(data!=null && data.length>0)

            {

                var trHtml = '';

                $.each(data,function(key,item)

                {

                    var rowExists = false;

                    $('#metal_details > tbody tr').each(function(bidx, brow)

                    {

                        curRow = $(this);

                        if(curRow.find('.bill_det_id').val()==item.bill_det_id)

                        {

                            rowExists=true;

                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});

                            $("div.overlay").css("display", "none");

                        }

                    });



                    var uom_list = "<option value=''>-UOM-</option>";

                    $.each(uom_details, function (pkey, pitem)

                    {

                        var uom_selected ="";

                        if(pitem.uom_id==item.uom)

                        {

                            uom_selected = "selected='selected'";

                        }

                        uom_list += "<option value='"+pitem.uom_id+"' "+uom_selected+">"+pitem.uom_name+"</option>";

                    });

                    var purity = "<option value='"+item.id_purity+"'>"+item.purity+"</option>";

                    var purewt = 0;

                    if(!rowExists)

                    {

                        trHtml='<tr>'



                            +'<td style="width:100px;"><input type="checkbox" class="id_kar_issue" name="metal_details[id_kar_issue][]" value="">' +item.branch_trans_code+ '<input type="hidden" class="bill_det_id" name="metal_details[bill_det_id][]" value="'+item.bill_det_id+'"></td>'



                            +'<td>'+item.bill_date+'</td>'



                            +'<td></td>'



                            +'<td style="width:100px;"><input type="hidden" class="metal" name="metal_details[metal][]" value="'+item.id_metal+'"><input type="hidden" class="category" name="metal_details[category][]" value="'+item.cat_id+'">'+item.catname+'<input type="hidden" class="issue_against" name="metal_details[issue_against][]" value="'+$("input[type='radio'][name='issue[issue_aganist]']:checked").val()+'"><input type="hidden" class="issue_against_po" name="metal_details[issue_against_po][]" value="'+$("input[type='radio'][name='issue[issue_against_po]']:checked").val()+'"><input type="hidden" class="po_item_id" name="metal_details[po_item_id][]" value=""></td>'



                            +'<td style="width:100px;"><input type="hidden" class="id_section" name="metal_details[id_section][]" value="'+item.id_section+'">'+item.section+'</td>'



                            +'<td style="width:100px;"><input type="hidden" class="product" name="metal_details[id_product][]" value="'+item.product_id+'"><input type="hidden" class="design" name="metal_details[id_design][]" value="'+item.design_id+'"><input type="hidden" class="id_sub_design" name="metal_details[id_sub_design][]" value="'+item.id_sub_design+'">'+item.product_name+'</td>'



                            +'<td><select class="form-control" id="select_purity"  style="width:100px;">'+purity+'</select></td>'



                            +'<td><div class="input-group"><span><input type="number" class="issue_pcs form-control" style="width:100px;"name="metal_details[pcs][]" value="'+item.piece+'" readonly><input type="hidden" class="available_pcs form-control" name="" value="'+item.piece+'"></span><span>&nbsp; of &nbsp;'+item.piece+'<br/></span></div></td>'



                            +'<td><div class="input-group"><span><input class="issue_weight form-control" type="number" name="metal_details[weight][]" value="'+item.gross_wt+'" style="width:80px;" /><input type="hidden" class="available_weight" name="" value="'+item.gross_wt+'"><select class="uom_id form-control" name="metal_details[uom_id][]" style="width: 80px;">'+uom_list+'</select></span><span>&nbsp; of &nbsp;'+ item.gross_wt +'<br/></span></div></td>'



                            +'<td><input type="number" class="pur_weight form-control" id="pur_weight" name="metal_details[pur_weight][]" value="'+purewt+'" style="width:80px;" readonly></td>'



                            +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



                        +'</tr>';

                        if($('#metal_details > tbody  > tr').length>0)

                        {

                            $('#metal_details > tbody > tr:first').before(trHtml);

                        }else{

                            $('#metal_details tbody').append(trHtml);

                        }



                        $('#metal_details > tbody').find('#select_purity').select2();

                        $('#metal_details > tbody').find('#select_purity').select2({

                            placeholder: "Purity",

                            allowClear: true

                        });

                        $("div.overlay").css("display", "none");

                    }

                });

                calculateMetalIssuePureWt();

                calculateMetalIssueTotal();

            }

            else

            {

			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});

				$("div.overlay").css("display", "none");

			}

        }

    });



}





function getNontagOtherIssue()

{

    $("div.overlay").css("display","block");

    my_Date = new Date();

    $.ajax({

        url: base_url+"index.php/admin_ret_tagging/retagging/non_tag_other_issue?nocache=" + my_Date.getUTCSeconds(),

		type:"POST",

		data:{'id_branch':1,'bt_number':$("#bt_number").val()},

		dataType: 'json',

		cache:false,

		success:function(data)

        {

            console.log(data);

            if(data!=null && data.length>0)

            {

                var trHtml = '';

                $.each(data,function(key,item)

                {

                    var rowExists = false;

                    $('#metal_details > tbody tr').each(function(bidx, brow)

                    {

                        curRow = $(this);

                        if(curRow.find('.branch_trans_id').val()==item.nontag_transfer_id)

                        {

                            rowExists=true;

                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});

                            $("div.overlay").css("display", "none");

                        }

                    });



                    var uom_list = "<option value=''>-UOM-</option>";

                    $.each(uom_details, function (pkey, pitem)

                    {

                        var uom_selected ="";

                        if(pitem.uom_id==item.uom)

                        {

                            uom_selected = "selected='selected'";

                        }

                        uom_list += "<option value='"+pitem.uom_id+"' "+uom_selected+">"+pitem.uom_name+"</option>";

                    });

                    var purity = "<option value=''>-Purity-</option>";

                    $.each(purityDetails,function(key,val)

                    {

                        purity += "<option value='"+val.id_purity+"'>"+val.purity+"</option>"

                    })

                    var purewt = 0;

                    if(!rowExists)

                    {

                        trHtml='<tr>'



                            +'<td style="width:100px;"><input type="checkbox" class="id_kar_issue" name="metal_details[id_kar_issue][]" value="">' +item.branch_trans_code+ '<input type="hidden" class="branch_trans_id" name="metal_details[branch_trans_id][]" value="'+item.nontag_transfer_id+'"></td>'



                            +'<td>'+item.bt_date+'</td>'



                            +'<td></td>'



                            +'<td style="width:100px;"><input type="hidden" class="metal" name="metal_details[metal][]" value="'+item.id_metal+'"><input type="hidden" class="category" name="metal_details[category][]" value="'+item.cat_id+'">'+item.catname+'<input type="hidden" class="issue_against" name="metal_details[issue_against][]" value="'+$("input[type='radio'][name='issue[issue_aganist]']:checked").val()+'"><input type="hidden" class="issue_against_po" name="metal_details[issue_against_po][]" value="'+$("input[type='radio'][name='issue[issue_against_po]']:checked").val()+'"><input type="hidden" class="po_item_id" name="metal_details[po_item_id][]" value=""></td>'



                            +'<td style="width:100px;"><input type="hidden" class="id_section" name="metal_details[id_section][]" value="'+item.id_section+'">'+item.section+'</td>'



                            +'<td style="width:100px;"><input type="hidden" class="product" name="metal_details[id_product][]" value="'+item.product_id+'"><input type="hidden" class="design" name="metal_details[id_design][]" value="'+item.design_id+'"><input type="hidden" class="id_sub_design" name="metal_details[id_sub_design][]" value="'+item.id_sub_design+'">'+item.product_name+'</td>'



                            +'<td><select class="form-control" id="select_purity"  style="width:100px;">'+purity+'</select></td>'



                            +'<td><div class="input-group"><span><input type="number" class="issue_pcs form-control" style="width:100px;"name="metal_details[pcs][]" value="'+item.pieces+'" readonly><input type="hidden" class="available_pcs form-control" name="" value="'+item.pieces+'"></span><span>&nbsp; of &nbsp;'+item.pieces+'<br/></span></div></td>'



                            +'<td><div class="input-group"><span><input class="issue_weight form-control" type="number" name="metal_details[weight][]" value="'+item.gross_wt+'" style="width:80px;" /><input type="hidden" class="available_weight" name="" value="'+item.gross_wt+'"><select class="uom_id form-control" name="metal_details[uom_id][]" style="width: 80px;">'+uom_list+'</select></span><span>&nbsp; of &nbsp;'+ item.gross_wt +'<br/></span></div></td>'



                            +'<td><input type="number" class="pur_weight form-control" id="pur_weight" name="metal_details[pur_weight][]" value="'+purewt+'" style="width:80px;" readonly></td>'



                            +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



                        +'</tr>';

                        if($('#metal_details > tbody  > tr').length>0)

                        {

                            $('#metal_details > tbody > tr:first').before(trHtml);

                        }else{

                            $('#metal_details tbody').append(trHtml);

                        }



                        $('#metal_details > tbody').find('#select_purity').select2();

                        $('#metal_details > tbody').find('#select_purity').select2({

                            placeholder: "Purity",

                            allowClear: true

                        });

                        $("div.overlay").css("display", "none");

                    }

                });

                calculateMetalIssuePureWt();

                calculateMetalIssueTotal();

            }

            else

            {

			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});

				$("div.overlay").css("display", "none");

			}

        }

    });



}





function get_retagging_details(report_type)

{

    $("div.overlay").css("display", "block");

	my_Date = new Date();

	$.ajax({



		url: base_url+"index.php/admin_ret_tagging/retagging/ajax?nocache=" + my_Date.getUTCSeconds(),



		type:"POST",



		data:{'report_type':report_type,'id_branch':1,'bt_number':$("#bt_number").val()},



		dataType: 'json',



		cache:false,



		success:function(data)

        {

            console.log(data);



            if(data!=null && data.length>0)

            {

                var rowExists=false;

                var trHtml='';

                $.each(data,function(key,items)

                {

                    var stock_type = $("input[name='stock_type']:checked").val();

                    $.each(insertedcatdetails,function(key,val)

                    {

                        if(val.tag_id==items.tag_id)

                        {

                            rowExists=true;

                        }

                    });

                    if(!rowExists)

                    {

                        var allow_create = true;

                        /*if(stock_type==1)

                        {

                            if(items.tag_type==0 || items.is_approval_stock_converted==1)

                            {

                                allow_create = false;

                                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Stock Type.."});

                            }

                        }

                        else if(stock_type==0)

                        {

                            if(items.tag_type==1 && items.is_approval_stock_converted==0)

                            {

                                allow_create = false;

                                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Stock Type.."});

                            }

                        }*/

                        if(allow_create)

                        {



                            var other_metal_details = [];

                            var stone_details = [];



                            insertedcatdetails.push({



                                'tax_type':items.tax_type,

                                'cat_id':items.cat_id,

                                'piece':items.piece,

                                'catname':items.catname,

                                'gross_wt':items.gross_wt,

                                'tgrp_id':items.tgrp_id,

                                'stone_details':((items.stone_details).length > 0 ? JSON.stringify(items.stone_details):''),'other_metal_details':(other_metal_details.length > 0 ? JSON.stringify(other_metal_details):''),'tag_id':items.tag_id,

                                'net_wt':items.net_wt,

                                'less_wt':items.less_wt,

                                'po_item_id':'',

                                'pro_id':items.product_id,

                                'des_id':items.design_id,

                                'id_sub_design':items.id_sub_design,

                                'pro_name':items.product_name,

                                'des_name':items.design_name,

                                'subDes_name':items.sub_design_name,

                                'va_per':0,

                                'mc_value':0,

                                'mc_type':1,

                                'ret_item_type':2,

                                'tag_code':items.tag_code,

                                'calculation_based_on':items.calculation_based_on,

                                'bill_det_id':'',

                                'branch_trans_id':''

                            });



                        }





                    }

                    else



                    {



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                    }



                })

                updatereturncategory();



				$("div.overlay").css("display", "none");



            }

            else

            {



			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});



				$("div.overlay").css("display", "none");



			}

        }

    });

}













function get_partlySaleDetails()

{

    $("div.overlay").css("display", "block");

	my_Date = new Date();

	$.ajax({



		url: base_url+"index.php/admin_ret_tagging/retagging/partly_sale?nocache=" + my_Date.getUTCSeconds(),



		type:"POST",



		data:{'id_branch':1,'bt_number':$("#bt_number").val()},



		dataType: 'json',



		cache:false,



		success:function(data)

        {

            console.log(data);



            if(data!=null && data.length>0)

            {

                var rowExists=false;

                var trHtml='';

                $.each(data,function(key,items)

                {

                    var stock_type = $("input[name='stock_type']:checked").val();

                    $.each(insertedcatdetails,function(key,val)

                    {

                        if(val.tag_id==items.tag_id)

                        {

                            rowExists=true;



                        }

                    });

                    if(!rowExists)

                    {

                        var allow_create = true;

                        /*if(stock_type==1)

                        {

                            if(items.tag_type==0 || items.is_approval_stock_converted==1)

                            {

                                allow_create = false;

                                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Stock Type.."});

                            }

                        }

                        else if(stock_type==0)

                        {

                            if(items.tag_type==1 && items.is_approval_stock_converted==0)

                            {

                                allow_create = false;

                                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Stock Type.."});

                            }

                        }*/

                        if(allow_create)

                        {



                            var other_metal_details = [];

                            var stone_details = [];



                            insertedcatdetails.push({

                                'tax_type':items.tax_type,

                                'cat_id':items.cat_id,

                                'piece':items.blc_pcs,

                                'catname':items.catname,

                                'gross_wt':items.blc_gwt,

                                'tgrp_id':items.tgrp_id,

                                'stone_details':((items.stone_details).length > 0 ? JSON.stringify(items.stone_details):''),'other_metal_details':(other_metal_details.length > 0 ? JSON.stringify(other_metal_details):''),'tag_id':items.tag_id,

                                'net_wt':items.blc_nwt,

                                'po_item_id':'',

                                'pro_id':items.pro_id,

                                'des_id':items.des_id,

                                'id_sub_design':items.id_sub_design,

                                'pro_name':items.product_name,

                                'des_name':items.design_name,

                                'subDes_name':items.sub_design_name,

                                'va_per':0,

                                'mc_value':0,

                                'mc_type':1,

                                'ret_item_type':2,

                                'tag_code':items.tag_code,

                                'calculation_based_on':items.calculation_based_on,

                                'bill_det_id':'',

                                'branch_trans_id':''

                            });



                        }





                    }

                    else



                    {



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                    }



                })

                updatereturncategory();



				$("div.overlay").css("display", "none");



            }

            else

            {



			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});



				$("div.overlay").css("display", "none");



			}

        }

    });

}





function get_nontag_sales_retrun()

{

    $("div.overlay").css("display", "block");

    my_Date = new Date();

	$.ajax({

        url: base_url+"index.php/admin_ret_tagging/retagging/non_tag_details?nocache=" + my_Date.getUTCSeconds(),

		type:"POST",

		data:{'id_branch':1,'bt_number':$("#nt_bt_number").val()},

		dataType: 'json',

		cache:false,

		success:function(data)

        {

            console.log(data);

            if(data!=null && data.length>0)

            {

                var rowExists=false;

                var trHtml='';

                $.each(data,function(key,items)

                {

                    $.each(insertedcatdetails,function(key,val)

                    {

                        if(val.bill_det_id == items.bill_det_id)

                        {

                            rowExists = true;

                        }

                    });



                    if(!rowExists)

                    {

                        var other_metal_details = [];

                        var stone_details = [];



                        insertedcatdetails.push({

                                'bill_det_id':items.bill_det_id,

                                'tax_type':items.tax_type,

                                'cat_id':items.cat_id,

                                'piece':items.piece,

                                'catname':items.catname,

                                'gross_wt':items.gross_wt,

                                'tgrp_id':items.tgrp_id,

                                'stone_details':stone_details,

                                'other_metal_details':other_metal_details,

                                'tag_id':'',

                                'net_wt':items.net_wt,

                                'less_wt':0,

                                'po_item_id':'',

                                'pro_id':items.product_id,

                                'des_id':items.design_id,

                                'id_sub_design':items.id_sub_design,

                                'pro_name':items.product_name,

                                'des_name':items.design_name,

                                'subDes_name':items.sub_design_name,

                                'va_per':0,

                                'mc_value':0,

                                'mc_type':1,

                                'ret_item_type':2,

                                'tag_code':'',

                                'calculation_based_on':items.calculation_based_on,

                                'branch_trans_id':''

                        });

                    }

                    else

                    {



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                    }

                })

                updatereturncategory();

                $("div.overlay").css("display", "none");

            }

            else

            {

			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});

				$("div.overlay").css("display", "none");

			}

        }

    });

}









function get_nontag_other_issue()

{

    $("div.overlay").css("display", "block");

    my_Date = new Date();

	$.ajax({

        url: base_url+"index.php/admin_ret_tagging/retagging/non_tag_other_issue?nocache=" + my_Date.getUTCSeconds(),

		type:"POST",

		data:{'id_branch':1,'bt_number':$("#nt_bt_number").val()},

		dataType: 'json',

		cache:false,

		success:function(data)

        {

            console.log(data);

            if(data!=null && data.length>0)

            {

                var rowExists=false;

                var trHtml='';

                $.each(data,function(key,items)

                {

                    $.each(insertedcatdetails,function(key,val)

                    {

                        if(val.branch_trans_id == items.nontag_transfer_id)

                        {

                            rowExists = true;

                        }

                    });



                    if(!rowExists)

                    {

                        var other_metal_details = [];

                        var stone_details = [];



                        insertedcatdetails.push({

                                'branch_trans_id':items.nontag_transfer_id,

                                'tax_type':items.tax_type,

                                'cat_id':items.cat_id,

                                'piece':items.pieces,

                                'catname':items.catname,

                                'gross_wt':items.gross_wt,

                                'tgrp_id':items.tgrp_id,

                                'stone_details':stone_details,

                                'other_metal_details':other_metal_details,

                                'tag_id':'',

                                'net_wt':items.net_wt,

                                'less_wt':0,

                                'po_item_id':'',

                                'pro_id':items.product_id,

                                'des_id':items.design_id,

                                'id_sub_design':items.id_sub_design,

                                'pro_name':items.product_name,

                                'des_name':items.design_name,

                                'subDes_name':items.sub_design_name,

                                'va_per':0,

                                'mc_value':0,

                                'mc_type':1,

                                'ret_item_type':2,

                                'tag_code':'',

                                'calculation_based_on':items.calculation_based_on,

                                'bill_det_id':''

                        });

                    }

                    else

                    {



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                    }

                })

                updatereturncategory();

                $("div.overlay").css("display", "none");

            }

            else

            {

			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});

				$("div.overlay").css("display", "none");

			}

        }

    });

}













function get_tag_scan_details_old(tag_id,old_tag_id)



{



	$("div.overlay").css("display", "block");



   var my_Date = new Date();



	$.ajax({



        url:base_url+ "index.php/admin_ret_reports/tag_history/ajax?nocache=" + my_Date.getUTCSeconds(),



        dataType: "json",



        method: "POST",



        data: {'tag_id': tag_id,'old_tag_id': old_tag_id},



        success: function (data) {



			if(data.list.length>0)



			{



			       var rowExists=false;



				    var trHtml='';



			        $.each(data.list, function(key,items){



			            if(items.karigar_id==$('#select_karigar').val())



			            {



			                var stock_type = $("input[name='stock_type']:checked").val();







			                $.each(returntaggeditemlist,function(key,val){



								if(val.tag_id==items.tag_id)



								{



									rowExists=true;



									$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



								}



						   });



    					   if(!rowExists)



    					   {



    					       var allow_create = true;



    					       /*if(stock_type==1)



    					       {



    					           if(items.tag_type==0 || items.is_approval_stock_converted==1)



    					           {



    					               allow_create = false;



    					               $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Stock Type.."});



    					           }



    					       }



    					       else if(stock_type==0)



    					       {



    					           if(items.tag_type==1 && items.is_approval_stock_converted==0)



    					           {



    					               allow_create = false;



    					               $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Stock Type.."});



    					           }



    					       }*/











    			                if(allow_create)



    			                {



    			                       if(data.list[0].tagging_status==0)



            					       {



            					           items = data.list[0];



            					           var other_metal_details = [];



            					            var tag_other_itm_grs_weight = 0;



            					            $.each(items.other_metal_details,function(k,stn){



            					               tag_other_itm_grs_weight+=parseFloat(stn.tag_other_itm_grs_weight);



            					               other_metal_details.push({



                                		            'id_metal'      : stn.tag_other_itm_metal_id,



                                		            'id_purity'     : stn.tag_other_itm_pur_id,



                                		            'pcs'           : stn.tag_other_itm_pcs,



                                		            'gwt'           : stn.tag_other_itm_grs_weight,



                                		            'wastage_perc'  : stn.tag_other_itm_wastage,



                                		            'making_charge' : stn.tag_other_itm_metal_id,



                                		            'rate_per_gram' : stn.tag_other_itm_rate,



                                		            'amount'        : stn.tag_other_itm_amount,



                                		            });



            					           });







            					           returntaggeditemlist.push({'cat_id':data.list[0].cat_id,'tag_id':data.list[0].tag_id,'piece':data.list[0].piece,'gross_wt':data.list[0].gross_wt,'net_wt':data.list[0].net_wt,'catname':data.list[0].catname,'tgrp_id':data.list[0].tgrp_id,'other_metal_details':other_metal_details});







            					           var stone_wt = 0;







            					           $.each(items.stone_details,function(k,stn){



            					               if(stn.stone_type==1)



            					               {



            					                   stone_wt+=parseFloat(stn.stone_wt/5);



            					               }



            					               else



            					               {



            					                   stone_wt+=parseFloat(stn.stone_wt);



            					               }



            					           });







            					            if(insertedcatdetails.length > 0)



                                            {



                                                var category_exists = false;



                                                $.each(insertedcatdetails,function(k,val){



                                                    if(val.cat_id == data.list[0].cat_id)



                                                    {



                                                        category_exists = true;



                                                    }



                                                });







                                                if(category_exists)



                                                {



                                                        $.each(insertedcatdetails,function(key,val){



                                                            if(val.cat_id == data.list[0].cat_id)



                                                            {



                                                                    insertedcatdetails[key].piece = parseFloat(insertedcatdetails[key].piece)+parseFloat(items.piece);



                                                                    insertedcatdetails[key].gross_wt = parseFloat(parseFloat(insertedcatdetails[key].gross_wt)+parseFloat(items.gross_wt)).toFixed(3);



                                                                    insertedcatdetails[key].less_wt = parseFloat(parseFloat(insertedcatdetails[key].less_wt)+parseFloat(stone_wt)).toFixed(3);



                                                                    insertedcatdetails[key].other_metal_weight = parseFloat(parseFloat(insertedcatdetails[key].other_metal_weight)+parseFloat(tag_other_itm_grs_weight)).toFixed(3);



                                                                    if(stone_wt > 0)



                                                                    {



                                                                       var stn_details = JSON.parse(insertedcatdetails[key].stone_details);



                                                                       $.each(data.list[0].stone_details,function(k,stnval){



                                                                           stn_details.push({



                                                                            'show_in_lwt'       : stnval.show_in_lwt,



                                                        		            'stones_type'       : stnval.stones_type,



                                                        		            'stone_uom_id'      : stnval.stone_uom_id,



                                                        		            'stone_id'          : stnval.stone_id,



                                                        		            'stone_pcs'         : stnval.stone_pcs,



                                                        		            'stone_wt'          : stnval.stone_wt,



                                                        		            'stone_cal_type'    : stnval.stone_cal_type,



                                                        		            'stone_price'       : stnval.stone_price,



                                                        		            'stone_type'        : stnval.stone_type,



                                                        		            'stone_rate'        : stnval.stone_rate



                                                        		            });



                                                                       });



                                                                       insertedcatdetails[key].stone_details = JSON.stringify(stn_details);



                                                                    }







                                                                    if(tag_other_itm_grs_weight > 0)



                                                                    {



                                                                           var tag_other_metal_details = JSON.parse(insertedcatdetails[key].other_metal_details);



                                                                           $.each(items.other_metal_details,function(k,stnval){



                                                                               tag_other_metal_details.push({



                                                                                    'id_metal'      : stnval.tag_other_itm_metal_id,



                                                                		            'id_purity'     : stnval.tag_other_itm_pur_id,



                                                                		            'pcs'           : stnval.tag_other_itm_pcs,



                                                                		            'gwt'           : stnval.tag_other_itm_grs_weight,



                                                                		            'wastage_perc'  : stnval.tag_other_itm_wastage,



                                                                		            'making_charge' : stnval.tag_other_itm_metal_id,



                                                                		            'rate_per_gram' : stnval.tag_other_itm_rate,



                                                                		            'amount'        : stnval.tag_other_itm_amount,



                                                            		            });



                                                                           });



                                                                           insertedcatdetails[key].other_metal_details = JSON.stringify(tag_other_metal_details);



                                                                    }



                                                                }



                                                        });



                                                }



                                                else



                                                {



                                                    insertedcatdetails.push({'cat_id':items.cat_id,'piece':items.piece,'catname':items.catname,'gross_wt':items.gross_wt,'tgrp_id':items.tgrp_id,'less_wt':stone_wt,'other_metal_weight':tag_other_itm_grs_weight,'stone_details':(data.list[0].stone_details.length > 0 ? JSON.stringify(data.list[0].stone_details):''),'other_metal_details':(other_metal_details.length > 0 ? JSON.stringify(other_metal_details):'')});



                                                }







                                            }



                                            else



                                            {



                                                insertedcatdetails.push({'cat_id':items.cat_id,'piece':items.piece,'catname':items.catname,'gross_wt':items.gross_wt,'tgrp_id':items.tgrp_id,'less_wt':stone_wt,'other_metal_weight':tag_other_itm_grs_weight,'stone_details':((data.list[0].stone_details).length > 0 ? JSON.stringify(data.list[0].stone_details):''),'other_metal_details':(other_metal_details.length > 0 ? JSON.stringify(other_metal_details):'')});



                                            }



            					       }



            					        else



            					       {



            					           $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Tag Not Availabe."});



            					       }



    			                }



    						}



			            }



			            else



			            {



			                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Supplier.."});



			            }



					});



					updatereturncategory();



					$("div.overlay").css("display", "none");







			}else{



			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});



				$("div.overlay").css("display", "none");



			}



			$('#tag_number').val('');



			$('#old_tag_number').val('');



        }



     });



}



function get_tag_scan_details(tag_id,old_tag_id)



{



    $("div.overlay").css("display", "block");



    var my_Date = new Date();



    $.ajax({



        url:base_url+ "index.php/admin_ret_reports/tag_history/ajax?nocache=" + my_Date.getUTCSeconds(),



        dataType: "json",



        method: "POST",



        data: {'tag_id': tag_id,'old_tag_id': old_tag_id},



        success: function (data)



        {



            if(data.list.length>0)



			{



                var rowExists=false;



				var trHtml='';



                $.each(data.list, function(key,items)



                {



                    if(items.karigar_id==$('#select_karigar').val() || $('#select_karigar').val()==0)



			        {



                        var stock_type = $("input[name='stock_type']:checked").val();



                        $.each(returntaggeditemlist,function(key,val)



                        {



                            if(val.tag_id==items.tag_id)



                            {



                                rowExists=true;



                                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                            }



                        });



                        if(!rowExists)



                        {



                            var allow_create = true;



                           /* if(stock_type==1)



                            {



                                if(items.tag_type==0 || items.is_approval_stock_converted==1)



                                {



                                    allow_create = false;



                                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Stock Type.."});



                                }



                            }



                            else if(stock_type==0)



                            {



                                if(items.tag_type==1 && items.is_approval_stock_converted==0)



                                {



                                    allow_create = false;



                                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Stock Type.."});



                                }



                            }*/



                            if(allow_create)



                            {



                                if(data.list[0].tagging_status==0)



                                {



                                    items = data.list[0];



                                    var other_metal_details = [];



                                    var stone_details = [];







                                    returntaggeditemlist.push({



                                                    'tax_type':data.list[0].tax_type,



                                                    'tag_code' : data.list[0].tag_code,



                                                    'cat_id':data.list[0].cat_id,



                                                    'tag_id':data.list[0].tag_id,



                                                    'piece':data.list[0].piece,



                                                    'gross_wt':data.list[0].gross_wt,



                                                    'net_wt':data.list[0].net_wt,



                                                    'catname':data.list[0].catname,



                                                    'tgrp_id':data.list[0].tgrp_id,



                                                    'other_metal_details':other_metal_details,



                                                    'stone_details':stone_details,



                                                    'po_item_id':'',



                                                    'pro_name':data.list[0].product_name,



                                                    'des_name':data.list[0].design_name,



                                                    'subDes_name':data.list[0].sub_design_name,



                                                    'pro_id':data.list[0].pro_id,



                                                    'des_id':data.list[0].des_id,



                                                    'id_sub_design':data.list[0].id_sub_design,



                                                    'va_per':0,



                                                    'mc_value':0,



                                                    'mc_type':1,



                                                    'ret_item_type':2,



                                                    'calculation_based_on' : data.list[0].calculation_based_on,



                                                    'bill_det_id':''



                                        });



                                    if(insertedcatdetails.length > 0)



                                    {



                                        insertedcatdetails.push({'tax_type':data.list[0].tax_type,'cat_id':data.list[0].cat_id,'tag_id':data.list[0].tag_id,'piece':data.list[0].piece,'gross_wt':data.list[0].gross_wt,'net_wt':data.list[0].net_wt,'catname':data.list[0].catname,'tgrp_id':data.list[0].tgrp_id,'other_metal_details':other_metal_details,'stone_details':((data.list[0].stone_details).length > 0 ? JSON.stringify(data.list[0].stone_details):''),'po_item_id':'','pro_name':data.list[0].product_name,'des_name':data.list[0].design_name,'subDes_name':data.list[0].sub_design_name,



                                        'pro_id':data.list[0].pro_id,'des_id':data.list[0].des_id,'id_sub_design':data.list[0].id_sub_design,



                                        'va_per':0,'mc_value':0,'mc_type':1,'ret_item_type':2,'tag_code':data.list[0].tag_code,'calculation_based_on' : data.list[0].calculation_based_on, 'bill_det_id':''});



                                    }



                                    else



                                    {



                                        insertedcatdetails.push({'tax_type':items.tax_type,'cat_id':items.cat_id,'piece':items.piece,'catname':items.catname,'gross_wt':items.gross_wt,'tgrp_id':items.tgrp_id,'stone_details':((data.list[0].stone_details).length > 0 ? JSON.stringify(data.list[0].stone_details):''),'other_metal_details':(other_metal_details.length > 0 ? JSON.stringify(other_metal_details):''),'tag_id':items.tag_id,'net_wt':items.net_wt,'po_item_id':'','pro_id':items.pro_id,'des_id':items.des_id,'id_sub_design':items.id_sub_design,'pro_name':items.product_name,'des_name':items.design_name,'subDes_name':items.sub_design_name,'va_per':0,'mc_value':0,'mc_type':1,'ret_item_type':2,'tag_code':items.tag_code,'calculation_based_on' : items.calculation_based_on,'bill_det_id':''});



                                    }



                                }



                                else



                                {



                                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Tag Not Availabe."});



                                }



                            }



                        }



                    }



                    else



                    {



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Supplier.."});



                    }



                });



                updatereturncategory();



				$("div.overlay").css("display", "none");



            }



            else



            {



			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});



				$("div.overlay").css("display", "none");



			}



			$('#tag_number').val('');



			$('#old_tag_number').val('');



        }



    });



}



function updatereturncategory()



{



    $('#return_item_detail > tbody').empty();



    var tag_issue_from = $("input[name='tag_issue_from']:checked").val();



    var nontag_issue_from = $("input[name='nontag_issue_from']:checked").val();



    var cattrHtml ='';



    var purreturnpcs    = 0;



    var purreturnweight = 0;



    var ret_kar_calc_type = $('ret_karigar_calc_type').val();







    console.log(nontagreturnitemlist);



    console.log(returntaggeditemlist);



    console.log(purchasereturnitemlist);



    console.log(insertedcatdetails);



    $.each(insertedcatdetails, function(key,items)



    {



        var less_wt = (items.hasOwnProperty("less_wt") ? items.less_wt :0);



        var other_metal_weight = (items.hasOwnProperty("other_metal_weight") ? items.other_metal_weight :0);



        var net_wt = parseFloat(parseFloat(items.gross_wt)-parseFloat(less_wt)-parseFloat(other_metal_weight)).toFixed(3);



        console.log(items.gross_wt);



        cattrHtml+='<tr id="'+key+'">'







        +'<td><input type="hidden" class="return_item_tax_type" value="'+items.tax_type+'" /><input type="hidden" class="return_item_tax_percent" value="" /><input type="hidden" class="return_item_tax_id" value="'+items.tax_group+'" /><input type="hidden" class="return_item_tax_percent" value="" /><input type="hidden" class="return_item_tax_cgst_value" value="" /><input type="hidden" class="return_item_tax_sgst_value" value="" /><input type="hidden" class="return_item_tax_igst_value" value="" /><input type="hidden" class="return_item_tax_value" value="" /><input type="checkbox" class="return_item_cat_id" name="return_item_cat[catid][]" value="'+items.cat_id+'" checked /><input type="hidden" class="po_item_id"  value="'+items.po_item_id+'"><input type="hidden" class="tag_id"  value="'+items.tag_id+'"><input type="hidden" class="ret_item_type"  value="'+items.ret_item_type+'"><input type="hidden" class="calculation_based_on" value="'+items.calculation_based_on+'"><input type="hidden" class="bill_det_id" value="'+items.bill_det_id+'"><input type="hidden" class="branch_trans_id" value="'+items.branch_trans_id+'"><input type="hidden" class="ref_pur_ret_itm_id" value="'+(items.pur_ret_itm_id!=undefined ? items.pur_ret_itm_id :'')+'"><input type="hidden" class="return_item_id_section" name="return_item_section[id_section][]" value="'+items.id_section+'"></td>'



        +'<td class="tag_code">'+items.tag_code+'</td>'



        +'<td class="purreturncat">'+items.catname+'</td>'



        +'<td class="purreturnpro">'+items.pro_name+'<input type="hidden" class="return_item_pro_id" name="return_item_pro[pro_id][]" value="'+items.pro_id+'"></td>'



        +'<td class="purreturndes">'+items.des_name+'<input type="hidden" class="return_item_des_id" name="return_item_des[des_id][]" value="'+items.des_id+'"></td>'



        +'<td class="purreturnsubdes">'+items.subDes_name+'<input type="hidden" class="return_item_subdes_id" name="return_item_subdes[subdes_id][]" value="'+items.id_sub_design+'"></td>'







        +'<td><input type="number" class="form-control custom-inp purreturnpcs" name="item[pcs][]" value="'+ parseInt(items.piece) +'" style="width:100px;" step="any" '+(tag_issue_from!=1 || nontag_issue_from!=1 ? "" : 'readonly')+'><input type="hidden" class="act_purreturnpcs" value="'+parseInt(items.piece)+'"></td>'







        +'<td><input type="number" class="form-control custom-inp purreturnweight" name="item[gross_wt][]" value="'+ parseFloat(items.gross_wt).toFixed(3) +'" style="width:100px;" step="any" '+(tag_issue_from!=1 || nontag_issue_from!=1 ? "" : 'readonly')+' ><input type="hidden" class="act_purret_wt" value = "'+parseFloat(items.gross_wt).toFixed(3)+'"></td>'







        +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_less_wt" value="'+ parseFloat(items.less_wt).toFixed(3) +'" onClick="create_new_empty_est_cus_stone_item($(this).closest(\'tr\'));"  type="number" name="item[less_wt][]" step="any" readonly style="width:100px;"/><span class="input-group-addon input-sm add_tag_lwt" onClick="create_new_empty_est_cus_stone_item($(this).closest(\'tr\'));">+</span></div></div></td>'







        +'<td><input type="number" class="form-control custom-inp net_wt" name="item[net_wt][]" value="'+net_wt+'" style="width:100px;" step="any" readonly><input type="hidden" class="stone_details" name="item[stone_details][]"value=\''+(items.stone_details!='' ? items.stone_details:'')+'\' ><input type="hidden" class="other_metal_details" name="item[other_metal_details][]" value='+(items.other_metal_details!='' ? items.other_metal_details :'')+' ></td>'



        +'<td><input type="number" class="form-control custom-inp purreturnwastper" name="item[wast_per][]" value="'+ parseFloat(items.va_per).toFixed(2) +'" style="width:100px;" step="any"></td>'



        +'<td><input type="number" class="form-control custom-inp purreturnwastwgt" name="item[wast_wt][]" value="" style="width:100px;" step="any" readonly></td>'



        +'<td><select class="form-control custom-inp purreturnmctype"  name="item[mc_type][]" style="width:100px;"><option value="1" '+(items.mc_type==1 ? 'selected':'')+'>Gram</option><option value="2" '+(items.mc_type==2 ? 'selected' :'')+'>Piece</option></select></td>'



        +'<td><input type="number" class="form-control custom-inp purreturnmc" name="item[mc][]" value="'+ parseFloat(items.mc_value).toFixed(2) +'" style="width:100px;" step="any" ></td>'



        +'<td><input type="number" class="form-control custom-inp purreturntouch" name="item[touch][]" value="'+ parseFloat(items.pur_touch).toFixed(2) +'" style="width:100px;" step="any" ></td>'







        +'<td><select class="form-control custom-inp purret_calc_type" name="item[purret_calc_type][]" style="width:150px;" ><option value="1" '+(ret_kar_calc_type==1 ? 'selected':'')+'>Weight x Rate</option><option value="2" '+(ret_kar_calc_type==2 ? 'selected' :'')+'>Purchase Touch</option><option value="3" '+(ret_kar_calc_type==3 ? 'selected':'')+'>Weight x Wastage %</option></select></td>'







        +'<td><input type="number" class="form-control custom-inp purreturnpure" name="item[pure][]" value="" style="width:100px;" step="any" readonly></td>'







        +'<td><div class="input-group"><input class="purreturnrate form-control" type="number" name="return_item_cat[price][]" value="" style="width:100px;"><span class="input-group-btn" ></span></div></td>'



        +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_other_metal_wt" value="'+parseFloat(items.tag_other_itm_grs_weight).toFixed(3)+'" onClick="create_new_empty_other_metal_row($(this).closest(\'tr\'));"  type="number" step="any" style="width:100px;" readonly/><span class="input-group-addon input-sm add_other_metal_wt" onClick="create_new_empty_other_metal_row($(this).closest(\'tr\'));">+</span></div></div></td>'







        +'<td><div class="form-group"><div class="input-group"><input class="form-control custom-inp add_other_charges_amt" step="any" style="width:100px;" onClick="create_new_empty_other_charges_row($(this).closest(\'tr\'));" readonly/><input type="hidden"  id="other_charges_details" class="other_charges_details" name="item[other_charges_details]" /><span class="input-group-addon input-sm add_other_charges_amt" onClick="create_new_empty_other_charges_row($(this).closest(\'tr\'));">+</span></div></div></td>'







        // +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_other_metal_wt" value="'+parseFloat(items.tag_other_itm_grs_weight).toFixed(3)+'" onClick="create_new_empty_other_metal_row($(this).closest(\'tr\'));"  type="number" step="any" style="width:100px;" readonly/><span class="input-group-addon input-sm add_other_metal_wt" onClick="create_new_empty_other_metal_row($(this).closest(\'tr\'));">+</span></div></div></td>'







        +'<td><input type="number" class="form-control custom-inp returnitemcost" style="width:100px;" step="any" readonly><input type="hidden" class="form-control custom-inp itemcaltype" style="width:100px;" step="any" value="1"></td>'







        +'<td><input type="number" class="purreturntax form-control" value="" name="return_item_cat[tax][]" readonly style="width:100px;"/></td>'



        +'<td><input type="number" class="purreturnamount form-control" value="" name="return_item_cat[amount][]" readonly style="width:100px;"/></td>'







        +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_pur_ret_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'







    +'</tr>';



    });



    $('#return_item_detail tbody').append(cattrHtml);



    $('#issue_weight').val("");



    $('#issue_pcs').val("");



    $('.available_weight').html('');



    $('.available_pcs').html('');



    $('#select_product').select2("val","");



    $('#select_design').select2("val","");



    $('#select_sub_design').select2("val","");



    $('#select_po_ref_no').select2("val","");



    $('#bt_number').val('');



    calculate_purchase_return_final_cost();



    get_purchase_return_total();



}



function get_qc_rejected_details_by_poid_06_03_2023(poid)



{



	$("div.overlay").css("display", "block");



	$.ajax({



		type: 'POST',



		url: base_url+'index.php/admin_ret_purchase/get_qc_faild_items_by_poid',



		dataType:'json',



		data: {'porefid' : poid},



		success:function(data){



			if(data.purchaseaitems.length)



                {



                    var rowExists=false;



                    var catrowExists=false;



				    var trHtml='';



				    var cattrHtml='';



					$.each(data.purchaseaitems, function(key,items){



							$.each(purchasereturnitemlist,function(key,val){



								if(val.po_item_id==items.po_item_id)



								{



									rowExists=true;



									$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



								}



						   });











					   if(!rowExists)



					   {



						    purchasereturnitemlist.push({'cat_id':items.cat_id,'po_item_id':items.po_item_id,'piece':items.qcfaildpcs,'gross_wt':items.qcfaildwt,'net_wt':items.qcfaildwt,'catname':items.catname,'tgrp_id':items.tgrp_id});



                            if(insertedcatdetails.length > 0)



                            {



                                $.each(insertedcatdetails,function(key,val){



                                    if(val.cat_id == items.cat_id)



                                    {



                                        insertedcatdetails[key].piece = parseFloat(insertedcatdetails[key].piece)+parseFloat(items.qcfaildpcs);



                                        insertedcatdetails[key].gross_wt = parseFloat(parseFloat(insertedcatdetails[key].gross_wt)+parseFloat(items.qcfaildwt)).toFixed(3);



                                    }else



                                    {



                                        insertedcatdetails.push({'cat_id':items.cat_id,'piece':items.qcfaildpcs,'catname':items.catname,'gross_wt':items.qcfaildwt,'tgrp_id':items.tgrp_id,'stone_details':'','other_metal_details':''});



                                    }



                                });



                            }



                            else



                            {



                                insertedcatdetails.push({'cat_id':items.cat_id,'piece':items.qcfaildpcs,'catname':items.catname,'gross_wt':items.qcfaildwt,'tgrp_id':items.tgrp_id,'stone_details':'','other_metal_details':''});



                            }











					   }



					});











                    $("div.overlay").css("display", "none");



                }else



                {



                    $("div.overlay").css("display", "none");



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found.."});



                    $('#po_ref_no').val('');



                    $('#po_ref_no').focus();



                }



                updatereturncategory();



                get_purchase_return_total();



		}



	});



}



function get_qc_rejected_details_by_poid(poid)



{



    var purchase_type = $("input[name='purchase_type']:checked").val();



    var purret_receipt_type = $("input[name='purret_receipt_type']:checked").val();  // 0-> Po No, 1-> Tag, 2->Nontag





    $("div.overlay").css("display", "block");



    $.ajax({



		type: 'POST',



		url: base_url+'index.php/admin_ret_purchase/get_qc_faild_items_by_poid',



		dataType:'json',



		data: {'porefid' : poid,'purchase_type':purchase_type,'fin_year':$('#pur_fin_year_select').val()},



		success:function(data)



        {



            console.log(data);



            if(data.purchaseaitems.length)



            {



                var rowExists=false;



                var catrowExists=false;



                var trHtml='';







                $.each(data.purchaseaitems, function(key,items)



                {



                    var cattrHtml='';



                    $('#return_item_detail > tbody tr').each(function(bidx, brow){



                        curRow = $(this);



                        if(curRow.find('.id_qc_issue_details').val()==items.id_qc_issue_details)



                        {



                            rowExists=true;



                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                        }



                    });



                    if(!rowExists)



                    {



                        var stone_details = [];



                        var tot_lwt = 0;



                        $.each(items.stone_details,function(k,val){



                            if(val.is_apply_in_lwt==1)



                            {



                                $.each(uom_details,function(key,item){



                                     if(item.uom_id==val.stone_uom_id)



                                     {



                                         if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                                         {



                                             tot_lwt+=parseFloat(parseFloat(val.qc_rejected_wt)/parseFloat(item.divided_by_value));



                                         }else{



                                             tot_lwt+=parseFloat(val.qc_rejected_wt);



                                         }



                                     }



                    		    });



                            }







                            stone_details.push({



            		            'show_in_lwt'       : val.is_apply_in_lwt,



            		            'stone_id'          : val.stone_id,



            		            'stones_type'       : val.stone_type,



            		            'stone_pcs'         : val.qc_rejected_pcs,



            		            'stone_wt'          : val.qc_rejected_wt,



            		            'stone_cal_type'    : val.po_stone_calc_based_on,



            		            'stone_price'       : (val.po_stone_calc_based_on==1 ? parseFloat(parseFloat(val.qc_rejected_wt)*parseFloat(val.po_stone_rate)).toFixed(2) :parseFloat(parseFloat(val.qc_rejected_pcs)*parseFloat(val.po_stone_rate)).toFixed(2)),



            		            'stone_rate'        : val.po_stone_rate,



            		            'stone_type'        : val.stone_type,



            		            'stone_uom_id'      : val.uom_id,



                                'quality_id'        : val.po_quality_id,



                                'po_st_id'          : val.po_st_id,



                    		});



                        });







                        var tble_length = parseFloat($('#return_item_detail > tbody > tr').length+1);



                        cattrHtml='<tr id="'+tble_length+'">'







                            +'<td><input type="hidden" class="calculation_based_on" value="'+items.calculation_based_on+'" /><input type="hidden" class="pure_wt_calc_type" value="'+items.pure_wt_calc_type+'" /><input type="hidden" class="return_item_tax_type" value="'+items.tax_type+'" /><input type="hidden" class="return_item_tax_percent" value="" /><input type="hidden" class="return_item_tax_id" value="'+items.tax_group+'" /><input type="hidden" class="return_item_tax_percent" value="" /><input type="hidden" class="return_item_tax_cgst_value" value="" /><input type="hidden" class="return_item_tax_sgst_value" value="" /><input type="hidden" class="return_item_tax_igst_value" value="" /><input type="hidden" class="return_item_tax_value" value="" /><input type="checkbox" class="return_item_cat_id" name="return_item_cat[catid][]" value="'+items.cat_id+'" checked /><input type="hidden" class="id_qc_issue_details"  value="'+items.id_qc_issue_details+'"><input type="hidden" class="po_item_id"  value="'+items.po_item_id+'"><input type="hidden" class="tag_id"  value=""><input type="hidden" class="ret_item_type"  value="1"><input type="hidden" class="calculation_based_on" value="'+items.calculation_based_on+'"></td>'



                            +'<td class="tag_code"></td>'



                            +'<td class="purreturncat">'+items.catname+'</td>'







                            +'<td class="purreturnpro">'+items.product_name+'<input type="hidden" class="return_item_pro_id" name="return_item_pro[pro_id][]" value="'+items.pro_id+'"><input type="hidden" class="purchase_mode"  value="'+items.purchase_mode+'"></td>'







                            +'<td class="purreturndes">'+items.design_name+'<input type="hidden" class="return_item_des_id" name="return_item_des[des_id][]" value="'+items.des_id+'"></td>'







                            +'<td class="purreturnsubdes">'+items.sub_design_name+'<input type="hidden" class="return_item_subdes_id" name="return_item_subdes[subdes_id][]" value="'+items.id_sub_design+'"></td>'







                            +'<td><input type="number" class="form-control custom-inp purreturnpcs" name="item[pcs][]" value="'+ parseInt(items.qcfaildpcs) +'" style="width:100px;" step="any" '+(purret_receipt_type==0 ? '' : 'readonly')+'><input type="hidden" class="act_purreturnpcs" value="'+parseInt(items.qcfaildpcs)+'"></td>'







                            +'<td><input type="number" class="form-control custom-inp purreturnweight" name="item[gross_wt][]" value="'+ parseFloat(items.qcfaildwt).toFixed(3) +'" style="width:100px;" step="any" '+(purret_receipt_type==0 ? '' : 'readonly')+'><input type="hidden" class="act_purret_wt" value = "'+parseFloat(items.qcfaildwt).toFixed(3)+'"></td>'







                            +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_less_wt" value="0" onClick="create_new_empty_est_cus_stone_item($(this).closest(\'tr\'));"  type="number" name="item[less_wt][]" value="'+parseFloat(tot_lwt).toFixed(3)+'" step="any" readonly style="width:100px;"/><span class="input-group-addon input-sm add_tag_lwt" onClick="create_new_empty_est_cus_stone_item($(this).closest(\'tr\'));">+</span></div></div></td>'







                            +'<td><input type="number" class="form-control custom-inp net_wt" name="item[net_wt][]" value="" style="width:100px;" step="any" readonly><input type="hidden" class="stone_details" name="item[stone_details][]" value='+JSON.stringify(stone_details)+'  ><input type="hidden" class="other_metal_details" name="item[other_metal_details][]" ></td>'







                            +'<td><input type="number" class="form-control custom-inp purreturnwastper" name="item[wast_per][]" value="'+ parseFloat(items.wast_per).toFixed(2) +'" style="width:100px;" step="any"></td>'







                            +'<td><input type="number" class="form-control custom-inp purreturnwastwgt" name="item[wast_wt][]" value="" style="width:100px;" step="any" readonly></td>'







                            +'<td><select class="form-control custom-inp purreturnmctype"  name="item[mc_type][]" style="width:100px;"><option value="1" '+(items.mc_type==1 ? 'selected':'')+'>Gram</option><option value="2" '+(items.mc_type==2 ? 'selected' :'')+'>Piece</option></select></td>'







                            +'<td><input type="number" class="form-control custom-inp purreturnmc" name="item[mc][]" value="'+ parseFloat(items.mc_value).toFixed(2) +'" style="width:100px;" step="any" ></td>'







                            +'<td><input type="number" class="form-control custom-inp purreturntouch" name="item[touch][]" value="'+ parseFloat(items.pur_touch).toFixed(2) +'" style="width:100px;" step="any" ></td>'







                            +'<td><select class="form-control custom-inp purret_calc_type" name="item[purret_calc_type][]" style="width:150px;" disabled><option value="1" '+(items.pure_wt_calc_type==1 ? 'selected' :'')+' >Weight x Rate</option><option value="2"  '+(items.pure_wt_calc_type==2 ? 'selected' :'')+'>Purchase Touch</option><option value="3" '+(items.pure_wt_calc_type==3 ? 'selected' :'')+' >Weight x Wastage %</option></select></td>'







                            +'<td><input type="number" class="form-control custom-inp purreturnpure" name="item[pure][]" value="" style="width:100px;" step="any" readonly></td>'







                            +'<td><div class="input-group"><input class="purreturnrate form-control" type="number" name="return_item_cat[price][]" value="" style="width:100px;"><span class="input-group-btn" ></span></div></td>'







                            +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_other_metal_wt" value="" onClick="create_new_empty_other_metal_row($(this).closest(\'tr\'));"  type="number" step="any" style="width:100px;" readonly /><span class="input-group-addon input-sm add_other_metal_wt" onClick="create_new_empty_other_metal_row($(this).closest(\'tr\'));">+</span></div></div></td>'







                            +'<td><div class="form-group"><div class="input-group"><input class="form-control custom-inp add_other_charges_amt" step="any" style="width:100px;" onClick="create_new_empty_other_charges_row($(this).closest(\'tr\'));" readonly/><input type="hidden"  id="other_charges_details" class="other_charges_details" name="item[other_charges_details]" /><span class="input-group-addon input-sm add_other_charges_amt" onClick="create_new_empty_other_charges_row($(this).closest(\'tr\'));">+</span></div></div></td>'







                            +'<td><input type="number" class="form-control custom-inp returnitemcost" style="width:100px;" step="any" readonly><input type="hidden" class="form-control custom-inp itemcaltype" style="width:100px;" step="any" value="1"></td>'







                            +'<td><input type="number" class="purreturntax form-control" value="" name="return_item_cat[tax][]" readonly style="width:100px;"/></td>'







                            +'<td><input type="number" class="purreturnamount form-control" value="" name="return_item_cat[amount][]" readonly style="width:100px;"/></td>'







                            +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_pur_ret_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'







                        +'</tr>';







                        $('#return_item_detail > tbody ').append(cattrHtml);



                    }



                });







                $("div.overlay").css("display", "none");



            }



            else



            {



                $("div.overlay").css("display", "none");



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found.."});



                $('#po_ref_no').val('');



                $('#po_ref_no').focus();



            }



            calculate_purchase_return_item_cost();



        }



    });







}



function get_qc_rejected_details_by_supid(supid)



{



	$("div.overlay").css("display", "block");



	$.ajax({



		type: 'POST',



		url: base_url+'index.php/admin_ret_purchase/get_qc_faild_items_by_supid',



		dataType:'json',



		data: {'supid' : supid},



		success:function(data){



			if(data.purchaseaitems.length)



                {



                    var rowExists=false;



				    var trHtml='';



				    returnitemlist = [];



				    $('#item_detail > tbody').empty();



					$.each(data.purchaseaitems, function(key,items){



							$('#item_detail > tbody tr').each(function(bidx, brow){



							curRow = $(this);



								if(curRow.find('.po_item_id').val()==items.po_item_id)



								{



									rowExists=true;



									$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



								}



						   });



					   if(!rowExists)



					   {



						    returnitemlist.push(data.purchaseaitems);



							trHtml+='<tr>'



							+'<td><input type="checkbox" class="po_item_id" name="po_item_id[]" value="'+items.po_item_id+'" checked/><input type="hidden" class="tag_id" name="tag_id[]" value="" /><input type="hidden" class="po_id" name="po_id[]" value="'+items.po_item_id+'" /><input type="hidden" class="po_kar_id" name="return_po_kar_id[]" value="'+items.karigar_id+'" /><input type="hidden" class="po_cat_id" name="return_po_cat_id[]" value="'+items.cat_id+'" />'+items.po_ref_no+'</td>'



							+'<td>'+items.karigar+'</td>'



							+'<td>'+items.product_name+'</td>'



							+'<td>'+items.design_name+'</td>'



							+'<td>'+items.sub_design_name+'</td>'



							+'<td>'+items.purchasedpcs+'</td>'



							+'<td>'+items.purchasedwt+'</td>'



							+'<td><input type="hidden" class="qcfaildpcs"  value="'+items.qcfaildpcs+'" />'+items.qcfaildpcs+'</td>'



							+'<td><input type="hidden" class="qcfaildwt"   value="'+items.qcfaildwt+'" />'+items.qcfaildwt+'</td>'



							+'<td></td>'



							+'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_pur_ret_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



							+'</tr>';



						}



					});



					if($('#item_detail > tbody  > tr').length>0)



					{



						$('#item_detail > tbody > tr:first').before(trHtml);



					}else{



						$('#item_detail tbody').append(trHtml);



					}



					get_purchase_return_total();



					updatereturncategory();



                    $("div.overlay").css("display", "none");



                }else



                {



                    $("div.overlay").css("display", "none");



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found.."});



                    $('#po_ref_no').val('');



                    $('#po_ref_no').focus();



                }



		}



	});



}



function get_purchase_return_total()



{



    var total_pcs=0;



    var total_wt=0;



    var add_less_wt=0;



    var net_wt=0;



    var return_omwt=0;



    var return_pure = 0;



    var return_amount = 0;



    $("#return_item_detail tbody tr").each(function(index, value){



        console.log(($(value).find('input[type="checkbox"]').is(':checked')));



        if ($(value).find('input[type="checkbox"]').is(':checked'))



        {



            total_pcs+=parseFloat($(value).find(".purreturnpcs").val());



            total_wt+=parseFloat($(value).find(".purreturnweight").val());



            add_less_wt+=parseFloat(isNaN($(value).find(".add_less_wt").val()) || $(value).find(".add_less_wt").val()=='' ? 0:$(value).find(".add_less_wt").val());



            net_wt+=parseFloat(isNaN($(value).find(".net_wt").val()) || $(value).find(".net_wt").val()=='' ? 0 :$(value).find(".net_wt").val());



            return_omwt+=parseFloat(isNaN($(value).find(".add_other_metal_wt").val()) || $(value).find(".add_other_metal_wt").val()=='' ? 0 :$(value).find(".add_other_metal_wt").val());



            return_pure+=parseFloat(isNaN($(value).find(".purreturnpure").val()) || $(value).find(".purreturnpure").val()=='' ? 0 :$(value).find(".purreturnpure").val());



            return_amount+=parseFloat(isNaN($(value).find(".purreturnamount ").val()) || $(value).find(".purreturnamount ").val()=='' ? 0 :$(value).find(".purreturnamount ").val());





        }



    });



    $('.return_pcs').html(total_pcs);



    $('.return_gwt').html(parseFloat(total_wt).toFixed(3));



    $('.return_lwt').html(parseFloat(add_less_wt).toFixed(3));



    $('.return_nwt').html(parseFloat(net_wt).toFixed(3));



    $('.return_omwt').html(parseFloat(return_omwt).toFixed(3));



    $('.return_pure').html(parseFloat(return_pure).toFixed(3));



    $('.return_amount').html(parseFloat(return_amount).toFixed(3));





}



function remove_pur_ret_row(curRow)



{



    var cat_id = curRow.find('.return_item_cat_id').val();



    $.each(nontagreturnitemlist,function(k,nt_val){



        if(nt_val.cat_id == cat_id)



        {



            nontagreturnitemlist.splice(k, 1);



        }



    });







    $.each(returntaggeditemlist,function(k,nt_val){



        if(nt_val.cat_id == cat_id)



        {



            returntaggeditemlist.splice(k, 1);



        }



    });







    $.each(purchasereturnitemlist,function(k,nt_val){



        if(nt_val.cat_id == cat_id)



        {



            purchasereturnitemlist.splice(k, 1);



        }



    });







    $.each(insertedcatdetails,function(k,nt_val){



        if(nt_val.cat_id == cat_id)



        {



            insertedcatdetails.splice(k, 1);



        }



    });







    console.log(nontagreturnitemlist);



    console.log(returntaggeditemlist);



    curRow.remove();



    calculate_purchase_return_item_cost();



    get_purchase_return_total();



}



/*$('#return_po_items_submit').on('click',function(){



    var allowsubmit = true;



    var approve = false;



    if($('#select_karigar').val()=='' || $('#select_karigar').val()== null){



        allowsubmit = false;



    }



    if(!allowsubmit)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please select karigar."});



        return;



    }



    $('#return_item_detail > tbody tr').each(function(idx, row){



         curRow = $(this);



         if(curRow.find('.purreturnrate').val() == "" || curRow.find('.purreturnamount').val() == ""){



             allowsubmit = false;



         }



    });



    if($('.return_total_cost').val() == "" || $('.return_total_cost').val() == 0){



        allowsubmit = false;



    }







    if(!allowsubmit)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please fill required fields."});



    }



    else



    {







    	transCatData = [];



    	$("#return_item_detail tbody tr").each(function(index, value){



    		if($(value).find("input[name='return_item_cat[catid][]']:checked").val() != undefined){



    				transCatData.push({



    					'cat_item_id'       : $(value).find("input[name='return_item_cat[catid][]']:checked").val(),



    					'cat_id'            : $(value).find(".return_item_cat_id").val(),



    					'cat_pcs'           : $(value).find(".purreturnpcs").val(),



    					'cat_gwt'           : $(value).find(".purreturnweight").val(),



    					'cat_lwt'           : $(value).find(".add_less_wt").val(),



    					'cat_nwt'           : $(value).find(".net_wt").val(),



    					'pur_ret_rate'      : $(value).find(".purreturnrate").val(),



    					'purreturncaltype'  : $(value).find(".purreturncaltype").val(),



    					'ret_item_cost'     : $(value).find(".purreturnamount").val(),



    					'ret_tax_value'     : $(value).find(".return_item_tax_percent").val(),



    					'ret_tax_rate'      : $(value).find(".return_item_tax_value").val(),



    					'ret_cgst_value'    : $(value).find(".return_item_tax_cgst_value").val(),



    					'ret_sgst_value'    : $(value).find(".return_item_tax_sgst_value").val(),



    					'ret_igst_value'    : $(value).find(".return_item_tax_igst_value").val(),



    					'stone_details'     : $(value).find(".stone_details").val(),



    					'other_metal_details'     : $(value).find(".other_metal_details").val(),



    				});



    			approve = true;



    		}



    	});



        if(transCatData.length == 0)



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please select any one items."});



        }



        else



        {



            $("div.overlay").css("display", "block");



            $('#return_po_items_submit').prop('disabled',true);



    		$.ajax({



    			type: 'POST',



    			url: base_url+'index.php/admin_ret_purchase/updateporeturnitems',



    			dataType:'json',



    			data: {



    			        "returncatitems"        : transCatData,



    			        "nontagreturnitemlist"  : nontagreturnitemlist,



    			        "returntaggeditemlist"  : returntaggeditemlist,



    			        "purchasereturnitemlist": purchasereturnitemlist,



    			        'id_karigar'            : $('#select_karigar').val(),



    			        'cmp_country'           : $('#cmp_country').val(),



    			        'cmp_state'             : $('#cmp_state').val(),



    			        'supplier_country'      : $('#cmp_state').val(),



    			        'supplier_state'        : $('#supplier_state').val(),



    			        'returnreason'          : $('input[name="returnreason"]:checked').val(),



    			        'stock_type'            : $('input[name="stock_type"]:checked').val(),



    			        'narration'             : $('#returnnarration').val(),



    			        'other_charges_details' : $('#other_charges_details').val(),



    			        'returnamount'          : $('.return_total_cost').val(),



    			        'returnroundoff'        : $('.return_round_off').val(),



    			        'return_discount'       : $('.return_discount').val(),



    			        'tds_percent'           : $('.tds_percent').val(),



    			        'tds_tax_value'         : $('.tds_tax_value').val(),



    			        'tcs_percent'           : $('.tcs_percent').val(),



    			        'tcs_tax_value'         : $('.tcs_tax_value').val(),



    			        'other_metal_details'   : $('.other_metal_details').val(),



    			        'charges_tds_percent'   : $('.charges_tds_percent').val(),



    			        'other_charges_tds_tax_value'   : $('.other_charges_tds_tax_value').val(),



    			        'other_stone_details'   : $('.stone_details').val(),



    			        'other_charges'         : parseFloat(parseFloat($('#other_charges_taxable_amount').val())+parseFloat($('.other_charges_tax').val())).toFixed(2),



    			        'return_item_type'      : return_item_type



    			},



    			success:function(data){



    				if(data.success){



    					$.toaster({ priority : 'success', title : 'Success!', message : ''+data.message});



    					window.open( base_url+'index.php/admin_ret_purchase/return_receipt_acknowladgement/'+data.return_id,'_blank');



    					window.location.href= base_url+'index.php/admin_ret_purchase/purchasereturn/list';



    				}else



                    {



                        $("div.overlay").css("display", "none");



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+data.message});







                    }



    			}



    		});







        }



    }











});*/





$('#purret_to_karigar').on('change',function(){

   if(this.value!=''){

       get_karigar_bill();

   }

});



function get_karigar_bill(){

    my_Date = new Date();

	$.ajax({

		url: base_url+'index.php/admin_ret_purchase/get_supplier_sale/?nocache=' + my_Date.getUTCSeconds(),

		dataType: "json",

		method: "POST",

		data:{'id_karigar':$('#purret_to_karigar').val()},

		success: function ( data ) {

            supplier_sales_details = data;



            var id = $('#sales_return_bill_no').val();

             $.each(data, function (key, item) {

                $("#sales_return_bill_no").append(

                $("<option></option>")

                .attr("value", item.pur_return_id)

                .text(item.pur_ret_ref_no)

                );

            });

            $("#sales_return_bill_no").select2(

            {

                placeholder:"Select Bill No",

                closeOnSelect: true

            });

            if($("#sales_return_bill_no").length)

            {

                $("#sales_return_bill_no").select2("val",(id!='' && id>0? id:(id!='' && id!=undefined ? id :'')));

            }



            $(".overlay").css("display", "none");



		}

	 });

}



$('#sales_return_bill_no').on('change',function(){

    if($('#sales_return_bill_no').val()!=''){

        $.each(supplier_sales_details,function(key,val){

            if(val.pur_return_id==$('#sales_return_bill_no').val())

            {

                $.each(val.item_details,function(key,itemval){

                    if(itemval.stone_details.length > 0){

                        itemval['stone_details'] = JSON.stringify(itemval.stone_details);

                    }

                    if(itemval.other_metal_details.length > 0){

                        itemval['other_metal_details'] = JSON.stringify(itemval.other_metal_details);

                    }

                    insertedcatdetails.push(itemval);

                });

            }

        });

        if(insertedcatdetails.length > 0){

            updatereturncategory();

        }

    }



});



$('#return_po_items_submit').on('click',function()



{



    var allowsubmit = true;



    var approve = false;



    if($('#purret_to_karigar').val()=='' || $('#purret_to_karigar').val()== null){



        allowsubmit = false;



    }



    if(!allowsubmit)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please select karigar."});



        $('#purret_to_karigar').focus();



        return;



    }



    /*$('#return_item_detail > tbody tr').each(function(idx, row){



         curRow = $(this);



         if(curRow.find('.purreturnrate').val() == "" || curRow.find('.purreturnamount').val() == ""){



             allowsubmit = false;



         }



    });



    if($('.return_total_cost').val() == "" || $('.return_total_cost').val() == 0){



        allowsubmit = false;



    }*/







    if(!allowsubmit)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please fill required fields."});



    }



    else



    {







    	transCatData = [];



        $("#return_item_detail tbody tr").each(function(index, value){



    		if($(value).find("input[name='return_item_cat[catid][]']:checked").val() != undefined){



    				transCatData.push({



    					'cat_item_id'       : $(value).find("input[name='return_item_cat[catid][]']:checked").val(),



    					'cat_id'            : $(value).find(".return_item_cat_id").val(),



    					'ref_pur_ret_itm_id': $(value).find(".ref_pur_ret_itm_id").val(),



                        'id_section'        : $(value).find('.return_item_id_section').val(),



                        'pro_id'            : $(value).find(".return_item_pro_id").val(),



                        'des_id'            : $(value).find(".return_item_des_id").val(),



                        'id_sub_design'     : $(value).find(".return_item_subdes_id").val(),



                        'po_item_id'        : $(value).find(".po_item_id").val(),



                        'tag_id'            : $(value).find(".tag_id").val(),



                        'bill_det_id'       : $(value).find(".bill_det_id").val(),



                        'branch_trans_id'   : $(value).find(".branch_trans_id").val(),



    					'purretpcs'         : $(value).find(".purreturnpcs").val(),



    					'purretgwt'         : $(value).find(".purreturnweight").val(),



    					'purretlwt'         : $(value).find(".add_less_wt").val(),



    					'purretnwt'         : $(value).find(".net_wt").val(),



    					'pur_ret_rate'      : $(value).find(".purreturnrate").val(),



    					'purreturncaltype'  : $(value).find(".purreturncaltype").val(),



    					'ret_item_cost'     : $(value).find(".purreturnamount").val(),



    					'ret_tax_value'     : $(value).find(".return_item_tax_percent").val(),



    					'ret_tax_rate'      : $(value).find(".return_item_tax_value").val(),



    					'ret_cgst_value'    : $(value).find(".return_item_tax_cgst_value").val(),



    					'ret_sgst_value'    : $(value).find(".return_item_tax_sgst_value").val(),



    					'ret_igst_value'    : $(value).find(".return_item_tax_igst_value").val(),



    					'stone_details'     : $(value).find(".stone_details").val(),



    					'other_metal_details': $(value).find(".other_metal_details").val(),



                        'purreturnwastper'   : $(value).find(".purreturnwastper").val(),



                        'purreturnwastwgt'   : $(value).find(".purreturnwastwgt").val(),



                        'purreturnmctype'    : $(value).find(".purreturnmctype").val(),



                        'purreturnmc'        : $(value).find(".purreturnmc").val(),



                        'purreturntouch'     : $(value).find(".purreturntouch").val(),



                        'purreturnpure'             : $(value).find(".purreturnpure").val(),



                        'ret_item_type'             : $(value).find(".ret_item_type").val(),



                        'other_charges_details'     : $(value).find(".other_charges_details").val(),



                        'return_item_tax_id'        : $(value).find(".return_item_tax_id").val(),



                        'return_item_tax_type'      : $(value).find(".return_item_tax_type").val(),



                        'return_item_tax_percent'   : $(value).find(".return_item_tax_percent").val(),



                        'total_cgst_cost'           : $(value).find(".return_item_tax_cgst_value").val(),



                        'total_sgst_cost'           : $(value).find(".return_item_tax_sgst_value").val(),



                        'total_igst_cost'           : $(value).find(".return_item_tax_igst_value").val(),



                        'total_total_tax'           : $(value).find(".return_item_tax_value").val(),



                        'calculation_based_on'      : $(value).find(".calculation_based_on").val(),



                        'pure_wt_calc_type'         : $(value).find(".pure_wt_calc_type").val(),



                        'purreturnrate'            : $(value).find(".purreturnrate").val(),



                        'id_qc_issue_details'      : $(value).find(".id_qc_issue_details").val(),



    				});



    			approve = true;



    		}



    	});



        if(transCatData.length == 0)



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please select any one items."});



        }



        else



        {



            $("div.overlay").css("display", "block");



            $('#return_po_items_submit').prop('disabled',true);



    		$.ajax({



    			type: 'POST',



    			url: base_url+'index.php/admin_ret_purchase/returnpoitems',



    			dataType:'json',



    			data: {



    			        "returnpuritems"        : transCatData,



    			        'id_karigar'            : $('#purret_to_karigar').val(),



    			        'cmp_country'           : $('#cmp_country').val(),



    			        'cmp_state'             : $('#cmp_state').val(),



    			        'supplier_country'      : $('#cmp_state').val(),



    			        'supplier_state'        : $('#supplier_state').val(),



                        'pur_ret_convert_to'    : $('input[name="pur_return_convert_to"]:checked').val(),



                        'tag_issue_from'        : $('input[name="tag_issue_from"]:checked').val(),



                        'nontag_issue_from'     : $('input[name="nontag_issue_from"]:checked').val(),



    			        'returnreason'          : $('input[name="returnreason"]:checked').val(),



    			        'stock_type'            : $('input[name="stock_type"]:checked').val(),



                        'purchase_type'         : $('input[name="purchase_type"]:checked').val(),



    			        'narration'             : $('#returnnarration').val(),



    			        'other_charges_details' : $('#other_charges_details').val(),



    			        'returnamount'          : $('.return_total_cost').val(),



    			        'returnroundoff'        : $('.return_round_off').val(),



    			        'return_discount'       : $('.return_discount').val(),



    			        'tds_percent'           : $('.tds_percent').val(),



    			        'tds_tax_value'         : $('.tds_tax_value').val(),



    			        'tcs_percent'           : $('.tcs_percent').val(),



    			        'tcs_tax_value'         : $('.tcs_tax_value').val(),



    			        'other_metal_details'   : $('.other_metal_details').val(),



    			        'charges_tds_percent'   : $('.charges_tds_percent').val(),



    			        'other_charges_tds_tax_value'   : $('.other_charges_tds_tax_value').val(),



    			        'other_stone_details'   : $('.stone_details').val(),



    			        'other_charges'         : parseFloat(parseFloat($('#other_charges_taxable_amount').val())+parseFloat($('.other_charges_tax').val())).toFixed(2),



    			},



    			success:function(data){



    				if(data.success){



    					$.toaster({ priority : 'success', title : 'Success!', message : ''+data.message});



    					window.open( base_url+'index.php/admin_ret_purchase/return_receipt_acknowladgement/'+data.return_id,'_blank');



    					window.location.href= base_url+'index.php/admin_ret_purchase/purchasereturn/list';



    				}else



                    {



                        $("div.overlay").css("display", "none");



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+data.message});







                    }



    			}



    		});







        }



    }



});



$(document).on('change','.purreturnwastper,.purreturnmctype,.purreturnmc,.purreturntouch,.purret_calc_type',function()

{



    var row     = $(this).parent().closest('tr');



    calculate_purchase_return_item_cost();



})



//purchase return end here



$('#add_image').on('click',function(){



    $('#imageModal_new').modal('show');



});



$("#update_img_new").on('click', function() {



    var final_file = [];



    var retrive_file = [];



    let image_details = localStorage.getItem('img_details');



    console.log(image_details);



    localStorage.removeItem('img_details');



    $('#order_iamges').val(image_details);



    $('#imageModal_new').modal('toggle');



});



//Order Description



$('#add_order_des').on('click',function(){



    var order_des= CKEDITOR.instances.order_des.getData();



    if(order_des=='')



    {



         $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter The Description"});



    }



    else



    {



        my_Date = new Date();



        $("div.overlay").css("display", "block");



        $.ajax({



            url:base_url+ "index.php/admin_ret_purchase/order_description/save?nocache=" + my_Date.getUTCSeconds(),



            dataType:"JSON",



            data:{'order_des':order_des},



            type:"POST",



            success:function(data){



                if(data.status)



                {



                    $("div.overlay").css("display", "none");



                    $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                    window.location.reload();



                }else



                {



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                }







            },



            error:function(error)



            {



                $("div.overlay").css("display", "none");



            }



        });



    }



});



function get_order_description()



{



       $("div.overlay").css("display", "block");



    	my_Date = new Date();



    	$.ajax({



    	 url:base_url+ "index.php/admin_ret_purchase/order_description/ajax?nocache=" + my_Date.getUTCSeconds(),



    	 dataType:"JSON",



    	 type:"POST",



    	 success:function(data){



    	 	var list=data.list;



    	 	var access=data.access;



    		var oTable = $('#des_list').DataTable();



    		oTable.clear().draw();



    		if (list!= null && list.length > 0)



    		{



    			oTable = $('#des_list').dataTable({



                "bDestroy": true,



                "bInfo": true,



                "bFilter": true,



                "bSort": true,



                "order": [[ 0, "desc" ]],



                "dom": 'lBfrtip',



                "buttons" : ['excel','print'],



                "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



                "aaData": list,



                "aoColumns": [







                { "mDataProp": "id_order_des" },



                { "mDataProp": "description" },



                { "mDataProp": function ( row, type, val, meta ) {



                    id=row.id_order_des;



                    edit_target=(access.edit=='0'?"":"#confirm-edit");

				



                    let delete_action_url = (access.delete == '1') 

                    ? base_url + 'index.php/admin_ret_purchase/order_description/delete/' + id 

                    : '';



                // Create the delete button HTML with the URL embedded

                    delete_url = (access.delete == '1') 

                    ? `<a href="#" class="btn btn-danger btn-del" data-href="${delete_action_url}" data-toggle="modal" data-target="#confirm-delete" title="Delete">

                        <i class="fa fa-trash"></i>

                    </a>` 

                    : '';



                    // delete_url=(access.delete=='1'  ? base_url+'index.php/admin_ret_purchase/order_description/delete/'+id : '' );



                    delete_confirm= (access.delete=='1' ?'#confirm-delete':'');



                    action_content= (access.edit ==1  ? '<a href="#" class="btn btn-primary btn-edit" id="edit" role="button" data-toggle="modal" data-id='+id+'  data-target='+edit_target+'><i class="fa fa-edit" ></i></a>':'') +delete_url;



                    return action_content;



                }



                }



                ]



                });







    		}



    		$("div.overlay").css("display", "none");



    	  },



    	  error:function(error)



    	  {



    		 $("div.overlay").css("display", "none");



    	  }



      });



}



$(document).on('click', "#des_list a.btn-edit", function(e) {



	e.preventDefault();



	id=$(this).data('id');



    get_description(id);



    $("#edit-id").val(id);



});



function get_description(id)



{



   my_Date = new Date();



	$.ajax({



		type:"GET",



		url: base_url+"index.php/admin_ret_purchase/order_description/edit/"+id+"?nocache=" + my_Date.getUTCSeconds(),



		cache:false,



		dataType:"JSON",



		success:function(data){



			$('#ed_rder_des').val(data.description);



			if($('#ed_rder_des').length > 0)



             {



             	CKEDITOR.replace('ed_rder_des');



             }



			// console.log(wt);



		}



	});



}



$('#update_order_des').on('click',function(){



    var order_des= CKEDITOR.instances.ed_rder_des.getData();



    if(order_des=='')



    {



         $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter The Description"});



    }



    else



    {



        my_Date = new Date();



        $("div.overlay").css("display", "block");



        $.ajax({



            url:base_url+ "index.php/admin_ret_purchase/order_description/update?nocache=" + my_Date.getUTCSeconds(),



            dataType:"JSON",



            data:{'order_des':order_des,'id_order_des':$("#edit-id").val()},



            type:"POST",



            success:function(data){



                if(data.status)



                {



                    $("div.overlay").css("display", "none");



                    $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                    window.location.reload();



                }else



                {



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                }







            },



            error:function(error)



            {



                $("div.overlay").css("display", "none");



            }



        });



    }



});







//Order Description



//Karigar Metal Issue



$("input[name='issue[issue_aganist]']:radio").on('change',function(){



    if(this.value==1)



    {



        $('#select_po_no').prop('disabled',false);



        if($('#select_karigar').val()!='' && $('#select_karigar').val()!=null)



        {



            get_karigar_pending_orders();



        }



    }else



    {



        $('#select_po_no').prop('disabled',true);



    }



});



$('#add_metal_issue').on('click',function(){



    if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Karigar"});



    }



    else if($('#select_category').val()=='' || $('#select_category').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Category"});



    }else if($('#select_product').val()=='' || $('#select_product').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Product"});



    }



    else if($('#select_design').val()=='' || $('#select_design').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Design"});



    }



    else if($('#select_sub_design').val()=='' || $('#select_sub_design').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Sub Design"});



    }



    else if($('#select_purity').val()=='' || $(select_purity).val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter Purity"});



    }



   else if($('#issue_pcs').val()=='' || $('#issue_pcs').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter Pcs"});



    }



    else if($('#issue_weight').val()=='' || $('#issue_weight').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter Weight"});



    }



    else if($('#pur_weight').val()=='' || $('#pur_weight').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter Pure Weight"});



    }



    else



    {



        create_metal_issue_row();



    }







});



$('#issue_weight,#purchase_touch').on('keyup',function(){



    var issue_pcs = (isNaN($('#issue_pcs').val()) || $('#issue_pcs').val()=='' ? 0:$('#issue_pcs').val());



    var tot_weight = (isNaN($('#issue_weight').val()) || $('#issue_weight').val()=='' ? 0:$('#issue_weight').val());



    var purity     = (isNaN($('#select_purity').val()) || $('#select_purity').val()=='' ? 0:$('#select_purity option:selected').text());



    var purewt = parseFloat((parseFloat(tot_weight) * (parseFloat(purity))) / 100).toFixed(3);







    $('#pur_weight').val(purewt);



});



$('#issue_pcs').on('change',function(){





    if(ctrl_page[1]=='purchasereturn')

    {

        if(parseInt($('#issue_pcs').val()) > parseInt($('.available_pcs').html()))

        {

            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Available Pieces is "+$('.available_pcs').html()});

            $('#issue_pcs').val('');

            $('#issue_pcs').focus();

        }



    }

    else

    {

        $.each(available_metal_stock,function(key,items){



            if($("input[type='radio'][name='issue[issue_aganist]']:checked").val()==1)



            {



                $.each(available_metal_stock,function(key,items){



                    if($('#select_product').val()==items.id_product && $('#select_design').val()==items.design && $('#select_sub_design').val()==items.id_sub_design && $('#select_section').val()==items.id_section)



                    {



                        if(parseFloat(items.no_of_piece)<$('#issue_pcs').val())



                        {



                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Available Pieces is "+items.no_of_piece});



                            $('#issue_pcs').val('');



                            $('#issue_pcs').focus();



                        }



                    }



                });



            }



            if($("input[type='radio'][name='issue[issue_against_po]']:checked").val()==1)



            {



                if(parseInt($('#issue_pcs').val()) > parseInt($('.available_pcs').html()))



                {



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Available Pieces is "+$('.available_pcs').html()});



                    $('#issue_pcs').val('');



                    $('#issue_pcs').focus();



                }



            }



        });

    }







});



$('#issue_weight').on('change',function()



{



    if(ctrl_page[1]=='purchasereturn')

    {

        if(parseFloat($('#issue_weight').val()) > parseFloat($('.available_weight').html()))

        {

            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Available Weight is "+$('.available_weight').html()});

            $('#issue_weight').val('');

            $('#issue_weight').focus();

        }

    }

    else

    {





        if($("input[type='radio'][name='issue[issue_aganist]']:checked").val()==1)



        {



            $.each(available_metal_stock,function(key,items)



            {



                if($('#select_product').val()==items.id_product && $('#select_design').val()==items.design && $('#select_sub_design').val()==items.id_sub_design && $('#select_section').val()==items.id_section)



                {



                    if(parseFloat(items.net_wt)<$('#issue_weight').val())



                    {



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Available Weight is "+items.gross_wt});



                        $('#issue_weight').val('');



                        $('#issue_weight').focus();



                    }



                }



            });



        }



        if($("input[type='radio'][name='issue[issue_against_po]']:checked").val()==1)



        {



            if(parseInt($('#issue_weight').val()) > parseInt($('.available_weight').html()))



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Available Pieces is "+$('.available_weight').html()});



                $('#issue_weight').val('');



                $('#issue_weight').focus();



            }



        }

    }

});



function reset_matal_issue_form()



{



    $('#select_category').select2("val","");



    $('#select_product').select2("val","");



    $('#select_purity').select2("val","");



    $('#issue_weight').val("");



    $('#issue_pcs').val("");



    $('#pur_weight').val("");



}



function create_metal_issue_row()



{



    var trHtml='';



        trHtml+='<tr>'



                 +'<td><input type="hidden" class="metal" name="metal_details[metal][]" value="'+$('#select_metal').val()+'"><input type="hidden" class="category" name="metal_details[category][]" value="'+$('#select_category').val()+'">'+$('#select_category option:selected').text()+'</td>'



                 +'<td><input type="hidden" class="id_section" name="metal_details[id_section][]" value="'+$('#select_section').val()+'">'+$('#select_section option:selected').text()+'</td>'



                 +'<td><input type="hidden" class="product" name="metal_details[id_product][]" value="'+$('#select_product').val()+'"><input type="hidden" class="design" name="metal_details[id_design][]" value="'+$('#select_design').val()+'"><input type="hidden" class="id_sub_design" name="metal_details[id_sub_design][]" value="'+$('#select_sub_design').val()+'">'+$('#select_product option:selected').text()+'</td>'



                 +'<td><input type="hidden" class="purity" name="metal_details[purity][]" value="'+$('#select_purity').val()+'">'+$('#select_purity option:selected').text()+'</td>'



                 +'<td><input type="hidden" class="issue_pcs" name="metal_details[pcs][]" value="'+$('#issue_pcs').val()+'">'+$('#issue_pcs').val()+'</td>'



                 +'<td><input type="hidden" class="weight" name="metal_details[weight][]" value="'+$('#issue_weight').val()+'">'+$('#issue_weight').val()+'</td>'



                 +'<td><input type="hidden" class="pur_weight" name="metal_details[pur_weight][]" value="'+$('#pur_weight').val()+'">'+$('#pur_weight').val()+'</td>'



                 +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



        +'</tr>';



        if($('#metal_details > tbody  > tr').length>0)



        {



            $('#metal_details > tbody > tr:first').before(trHtml);



        }else{



            $('#metal_details tbody').append(trHtml);



        }



    reset_matal_issue_form();



}



$('#submit_metal_issue').on('click',function()



{



    var karigarMetalIssueList = [];



    if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Karigar"});



    }



    else if($('#metal_details >tbody tr').length>0)



    {



        $('#metal_details tbody tr').each(function (index,value)



        {



            var row=$(this).closest('tr');



            if(row.find("input[name='metal_details[id_kar_issue][]']:checked").is(":checked"))



            {



                if(validateMetalIssueRow())



                {



                    karigarMetalIssueList.push({



                        "po_item_id"      :row.find('.po_item_id').val(),



                        "metal"           :row.find('.metal').val(),



                        "category"        :row.find('.category').val(),



                        "purity"          :row.find('#select_purity').val(),



                        "id_product"      :row.find('.product').val(),



                        "id_design"       :row.find('.design').val(),



                        "id_sub_design"   :row.find('.id_sub_design').val(),



                        "pcs"             :row.find('.issue_pcs').val(),



                        "weight"          :row.find('.issue_weight').val(),



                        "pur_weight"      :row.find('.pur_weight').val(),



                        "id_section"      :row.find('.id_section').val(),



                        "uom_id"          :row.find('.uom_id').val(),



                        "tag_id"          :row.find('.tag_id').val(),



                        "bill_det_id"     :row.find('.bill_det_id').val(),



                        "branch_trans_id" :row.find('.branch_trans_id').val(),



                        "is_repair_item" :row.find('.is_repair_item').val(),



                        "calc_type" :row.find('.purchase_calc_type').val(),



                        "issue_va" :row.find('.issue_va').val(),



                        "mc_type" :row.find('.mc_type').val(),



                        "mc" :row.find('.issue_mc').val(),



                        "issue_touch" :row.find('.issue_touch').val(),



                        "stone_details" :row.find('.stone_details').val(),



                        "issue_less_wt" :row.find('.issue_less_wt').val(),



                        "issue_net_wt" :row.find('.issue_net_wt').val(),



                        

                    });



                }



                else



                {



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Required Fields"});



                }



            }



        });



        }



        else



        {



            $('#submit_metal_issue').prop('disabled',false);



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records to Update"});



        }



    if(karigarMetalIssueList.length>0)



	{



		console.log(karigarMetalIssueList);



		karigarMetalIssueSave(karigarMetalIssueList);



	}



	else



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please select Any Id to proceed..'});



	}



});



function remove_row(curRow)



{



    curRow.remove();



    if(ctrl_page[1] == 'metal_issue_receipt'){

        calculateMetalIssue();

    }







}



function get_karigar_metal_issue_list()



{



    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



	 url:base_url+ "index.php/admin_ret_purchase/karigarmetalissue/ajax?nocache=" + my_Date.getUTCSeconds(),



	 dataType:"JSON",



	 type:"POST",



	 success:function(data){



	 	var list=data.list;



        var profile = data.profile;



        var access= data.access;



        var currentDate = new Date();



       var formattedCurrentDate = currentDate.getDate().toString().padStart(2, '0') + '-' +

            (currentDate.getMonth() + 1).toString().padStart(2, '0') + '-' +

            currentDate.getFullYear();



		var oTable = $('#stock_issue_list').DataTable();



		oTable.clear().draw();



		if (list!= null && list.length > 0)



		{



			oTable = $('#stock_issue_list').dataTable({



            "bDestroy": true,



            "bInfo": true,



            "bFilter": true,



            "bSort": true,



            "order": [[ 0, "desc" ]],



            "dom": 'lBfrtip',



            "buttons" : ['excel','print'],



            "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



            "aaData": list,



            "aoColumns": [



                { "mDataProp": "met_issue_id" },



                { "mDataProp": "issue_date" },



                { "mDataProp": "met_issue_ref_id" },



                { "mDataProp": "karigar_name" },



                { "mDataProp": "metal_wt" },



                { "mDataProp": "issue_metal_pur_wt" },



                { "mDataProp": "po_ref_no" },



                { "mDataProp": "pur_no" },



                { "mDataProp": "bill_status" },



                { "mDataProp": "tag_issue" },



                { "mDataProp": "remark" },



                { "mDataProp": function ( row, type, val, meta ) {



                    	 id= row.met_issue_id;



                    	 print_url=base_url+'index.php/admin_ret_purchase/karigarmetalissue_acknowladgement/'+id;



                    	 action_content='<a href="'+print_url+'" target="_blank" class="btn btn-info btn-print" data-toggle="tooltip" title="Metal Issue Acknowladgement"><i class="fa fa-print" ></i></a>'+( (row.issue_date ==  formattedCurrentDate || profile.previous_bill_cancel == 1)&& row.bill_status=='Success'  && access.delete == '1'  ?'<button class="btn btn-warning" onclick="confirm_issue_cancel('+id+')"><i class="fa fa-close" ></i></button>':''+'');



                        //  console.log(row.issue_date ==  formattedCurrentDate);



                         return action_content;



                	}



                }



              ]



            });







		}



		$("div.overlay").css("display", "none");



	  },



	  error:function(error)



	  {



		 $("div.overlay").css("display", "none");



	  }



  });



}



function confirm_issue_cancel(met_issue_id){



    $('#metal_issue_id').val(met_issue_id);



	$('#confirm-billcancell').modal('show');



}



$('#metal_issue_cancel_remark').on('keypress',function(){



	if(this.value.length>6)



	{



		$('#cancell_delete').prop('disabled',false);



	}else{



		$('#cancell_delete').prop('disabled',true);



	}



});



$('#cancell_delete').on('click',function(){



	my_Date = new Date();



	$.ajax({



		type: 'POST',



		url:base_url+ "index.php/admin_ret_purchase/karigarmetalissue/metalissue_cancel?nocache=" + my_Date.getUTCSeconds(),



		dataType:'json',



		data:{'remarks':$('#metal_issue_cancel_remark').val(),'metal_issue_id':$('#metal_issue_id').val()},



		success:function(data){



		    if(data.status)



		    {



		        $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



		        window.location.reload();



		    }else



		    {



		        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



		        window.location.reload();



		    }







		}



	});



});



function get_available_metal_stock_details()



{



    my_Date = new Date();



    $("div.overlay").css("display", "block");



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/karigarmetalissue/available_stock_details?nocache=" + my_Date.getUTCSeconds(),



        dataType:"JSON",



        type:"POST",



        data:{'id_product':$('#select_product').val()},



        success:function(data){



            available_metal_stock=data;



            //set_availabe_purity();



            $("div.overlay").css("display", "none");



        },



        error:function(error)



        {



            $("div.overlay").css("display", "none");



        }



    });



}



$('#issue_from').on('change',function(){



    set_available_stock_details();



    set_availabe_purity();



});



function set_available_stock_details()



{



    var trHtml='';



    $('#available_stock_details > tbody').empty();



    $.each(available_metal_stock,function(key,items){



        if($('#select_product').val()==items.id_product)



        {



            trHtml+='<tr>'



                    +'<td>'+items.product_name+'</td>'



                    +'<td>'+items.gross_wt+'</td>'



                    +'<td>'+items.net_wt+'</td>'



                +'</tr>';



       }







    });



    $('#available_stock_details > tbody').append(trHtml);



}



function set_availabe_purity()



{



       $("#purity option").remove();



       $('.available_pcs').html(0);

       $('.available_weight').html(0);

       $.each(available_metal_stock,function (key, item){



           if($('#select_product').val()==item.id_product && $('#select_design').val()==item.design && $('#select_sub_design').val()==item.id_sub_design && $('#select_section').val()==item.id_section )



           {



               if(item.net_wt>0)



               {



                   $('.available_pcs').html(item.no_of_piece);



                   $('.available_weight').html(item.net_wt);



               }



               else



               {



                   $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Stock Not Available.."});



               }



           }



    	});



}



function get_Activesections()



{



    $('#select_section option').remove();



    var id_branch = $('#id_branch').val();



	$.ajax({



        url: base_url + 'index.php/admin_ret_catalog/get_sectionBranchwise',



        data: ({ 'id_branch':id_branch}),



        dataType: "JSON",



        type: "POST",



        success: function (data) {







        section_details =data;



	    var id=$('#select_section').val();



		$.each(data, function (key, item) {



		    $("#select_section").append(



		    $("<option></option>")



            .attr("value",item.id_section)



            .text(item.section_name)



		    );



		});



		$("#select_section").select2(



		{



			placeholder:"Select Section",



			closeOnSelect: true



		});







		if($("#select_section").length)



		{



            $("#select_section").select2("val",(id!='' && id>0?id:''));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



//Karigar Metal Issue



//Purchase return start here



function create_new_empty_est_cus_stone_item(curRow,id)



{







    $('#estimation_stone_cus_item_details tbody').empty();



	if(curRow!=undefined)



	{



		$('#custom_active_id').val(curRow.closest('tr').attr('id'));



	}



	var row = "";



		var catRow=$('#custom_active_id').val();







		console.log(catRow);



		var row_st_details=$('#'+catRow).find('.stone_details').val();



		if(row_st_details !='' && row_st_details != '[]' && curRow != undefined)



		{



			var stone_details   = JSON.parse(row_st_details);



			console.log(stone_details);



			$.each(stone_details, function (pkey, pitem) {



	 			var stones_list='';



	 			var stones_type_list='';



	 			var uom_list='';



                var quality_list ='';



                var disable_quality = (pitem.stones_type == 1 ? '': 'disabled');



                var clarity="";



                var color ="";



                var cut ="";



                var shape ="";



	 			var html='';



	 			var cal_type = pitem.stone_cal_type;



				$.each(stones, function (pkey, item)



				{



					var selected = "";



					if(item.stone_id == pitem.stone_id)



					{



						selected = "selected='selected'";



					}



					stones_list += "<option value='"+item.stone_id+"' "+selected+">"+item.stone_name+"</option>";



				});











				$.each(stone_types, function (pkey, item) {



				    var st_type_selected = "";



				    if(item.id_stone_type == pitem.stones_type)



					{



						st_type_selected = "selected='selected'";



					}



				    stones_type_list += "<option value='"+item.id_stone_type+"' "+st_type_selected+">"+item.stone_type+"</option>";



    			});







    			$.each(uom_details, function (pkey, item) {



    			     var uom_selected = "";



    			    if(item.uom_id == pitem.stone_uom_id)



					{



						uom_selected = "selected='selected'";



					}



    				uom_list += "<option value='"+item.uom_id+"' "+uom_selected+">"+item.uom_name+"</option>";



    			});



                $.each(quality_code, function (pkey, item) {



                    quality_list += "<option value='"+pitem.stone_quality_id+"' "+(item.quality_id == pitem.stone_quality_id ? 'selected' : '') +" >"+item.code+"</option>";



                    if(item.quality_id == pitem.stone_quality_id)



                    {



                        clarity=item.clarity;



                        color=item.color;



                        cut=item.cut;



                        shape=item.shape;



                    }



                });











				row += '<tr>'



                	+'<td><input class="show_in_lwt" type="checkbox" name="est_stones_item[show_in_lwt][]" value="'+(pitem.show_in_lwt==1 ? 1:0)+'" '+(pitem.show_in_lwt==1 ? 'checked' :'' )+' ><input type="hidden" class="po_st_id" value="'+pitem['po_st_id']+'"></td>'



                	+'<td><select class="stones_type form-control" name="est_stones_item[stones_type][]"  style="width:80px;">'+stones_type_list+'</select></td>'



					+'<td><select class="stone_id form-control" name="est_stones_item[stone_id][]"  style="width:80px;">'+stones_list+'</select></td>'



                    +'<td><select class="quality_id form-control" name="est_stones_item[quality_id][]" '+disable_quality+' style="width:80px;">'+quality_list+'</select></td>'



					+'<td><input type="number" class="stone_pcs form-control" name="est_stones_item[stone_pcs][]"  value="'+pitem['stone_pcs']+'" style="width: 70px;"/></td>'



					+'<td><div class="input-group"><input class="stone_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="'+pitem['stone_wt']+'" style="width:70px;"/><span class="input-group-btn" style="width: 70px;"><select class="stone_uom_id form-control" name="est_stones_item[uom_id][]" style="width: 70px;" >'+uom_list+'</select></span></div></td>'



					+'<td><div class="form-group"><input class="stone_cal_type" type="radio" name="est_stones_item[cal_type]['+pkey+']" value="1" '+(cal_type == 1 ? 'checked' : '')+'> By Wt&nbsp;<input type="radio"  name="est_stones_item[cal_type]['+pkey+']" '+(cal_type == 2 ? 'checked' : '')+' class="stone_cal_type" value="2">By Pcs</div></td>'



                    +'<td><span class="stone_cut">'+cut+'</span></td>'



                    +'<td><span class="stone_color">'+color+'</span></td>'



                    +'<td><span class="stone_clarity">'+clarity+'</span></td>'



                    +'<td><span class="stone_shape">'+shape+'</span></td>'



					+'<td><input type="number" class="stone_rate form-control" name="est_stones_item[stone_rate][]" value="'+pitem['stone_rate']+'"  style="width:80px;"/></td>'



					+'<td><input type="number" class="stone_price form-control" name="est_stones_item[stone_price][]" value="'+pitem['stone_price']+'"  style="width:80px;" /></td>'



					+'<td><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td></tr>';



			});







		}



		else



		{







    			var stones_list = "<option value=''>-Select Stone-</option>";



    			var stones_type = "<option value=''>-Stone Type-</option>";



    			var uom_list = "<option value=''>-Stone UOM-</option>";



                var quality_list = "<option value=''>-Quality-</option>";



                var disable_quality =  'disabled';



                var clarity="";



                var color ="";



                var cut ="";



                var shape ="";



    			$.each(stones, function (pkey, pitem) {



    				stones_list += "<option value='"+pitem.stone_id+"'>"+pitem.stone_name+"</option>";



    			});







    			$.each(stone_types, function (pkey, pitem) {



    				stones_type += "<option value='"+pitem.id_stone_type+"'>"+pitem.stone_type+"</option>";



    			});







    			$.each(uom_details, function (pkey, pitem) {



    				var selected = pitem.is_default == 1 ? "selected='selected'" : "";



    				uom_list += "<option value='"+pitem.uom_id+"' "+selected+">"+pitem.uom_name+"</option>";



    			});



                $.each(quality_code, function (pkey, pitem) {



                    quality_list += "<option value='"+pitem.quality_id+"'>"+pitem.code+"</option>";



                });



    			var rowId = $('#estimation_stone_cus_item_details tbody tr').length;



    			var active_row = new Date().getTime();



                    row += '<tr id="'+active_row+'">'



                    	+'<td><input class="show_in_lwt" type="checkbox"name="est_stones_item[show_in_lwt][]" value="1" checked></td>'



                    	+'<td><select class="stones_type form-control" name="est_stones_item[stones_type][]" style="width:80px;">'+stones_type+'</select></td>'



    					+'<td><select class="stone_id form-control" name="est_stones_item[stone_id][]" style="width:80px;"></select></td>'



                        +'<td><select class="quality_id form-control" name="est_stones_item[quality_id][]" '+disable_quality+' style="width:80px;">'+quality_list+'</select></td>'



    					+'<td><input type="number" class="stone_pcs form-control" name="est_stones_item[stone_pcs][]" value="" style="width: 70px;"/></td>'



    					+'<td><div class="input-group"><input class="stone_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="" style="width:70px;"/><span class="input-group-btn" style="width: 70px;"><select class="stone_uom_id form-control" name="est_stones_item[uom_id][]" style="width: 70px;">'+uom_list+'</select></span></div></td>'



    					+'<td><div class="form-group"><input class="stone_cal_type" type="radio" name="est_stones_item[cal_type]['+rowId+']" value="1" checked="true"> By Wt&nbsp;<input type="radio" name="est_stones_item[cal_type]['+rowId+']" class="stone_cal_type" value="2">By Pcs</div></td>'



                        +'<td><span class="stone_cut">'+cut+'</span></td>'



			            +'<td><span class="stone_color">'+color+'</span></td>'



			            +'<td><span class="stone_clarity">'+clarity+'</span></td>'



			            +'<td><span class="stone_shape">'+shape+'</span></td>'



    					+'<td><input type="number" class="stone_rate form-control" name="est_stones_item[stone_rate][]" value=""  style="width:80px;"/></td>'



    					+'<td><input type="number" class="stone_price form-control" name="est_stones_item[stone_price][]" value=""  style="width:80px;" /></td>'



    					+'<td><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td></tr>';



		}



	$('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').append(row);



	$('#cus_stoneModal').modal('show');







}



function create_new_empty_other_metal_row(curRow)



{







    $('#other_metal_table tbody').empty();



	if(curRow!=undefined)



	{



		$('#custom_active_id').val(curRow.closest('tr').attr('id'));



	}



	var catRow=$('#custom_active_id').val();



	var other_metal_details=$('#'+catRow).find('.other_metal_details').val();



	if(other_metal_details !='' && other_metal_details != '[]' && other_metal_details != undefined)



	{



	    var trHtml='';



	    var metal_details   = JSON.parse(other_metal_details);



		$.each(metal_details, function (pkey, pitem) {



		    var metal='<option value="">Select Metal</option>';



            var purity='<option value="">Select Purity</option>';



            $.each(category_lists, function (mkey, mitem) {



                var selected = "";



    				if(mitem.id_ret_category == pitem.id_metal)



    				{



    					selected = "selected='selected'";



    				}



            		metal += "<option value='"+mitem.id_ret_category+"' "+selected+">"+mitem.name+"</option>";



        	});







        	$.each(purityDetails, function (k, p) {



        	    var selected = "";



				if(p.id_purity == pitem.id_purity)



				{



					selected = "selected='selected'";



				}



        		purity += "<option value='"+p.id_purity+"' "+selected+" >"+p.purity+"</option>";



        	});







            trHtml+='<tr>'



                  +'<td><select class="form-control select_metal">'+metal+'</td>'



                  +'<td><select class="form-control select_purity">'+purity+'</td>'



                  +'<td><input type="number" class="form-control pcs" value="'+pitem.pcs+'"></td>'



                  +'<td><input type="number" class="form-control gwt" value="'+pitem.gwt+'"></td>'



                  +'<td ><input type="number" class="form-control wastage_perc" value="'+pitem.wastage_perc+'" ><input type="hidden" class="wast_wt"></td>'



                  +'<td><select class="form-control calc_type"><option value="">Mc Type</option><option value="1" selected>Per Gram</option><option value="2">Per Piece</option></select></td>'



                  +'<td><input type="number" class="form-control making_charge" value="'+pitem.mc_value+'"><input type="hidden" class="mc_value" value="'+pitem.mc_value+'" ></td>'



                  +'<td><input type="number" class="form-control rate_per_gram" value="'+pitem.rate_per_gram+'" ></td>'



                  +'<td><input type="number" class="form-control amount" value="'+pitem.amount+'" ></td>'



                   +'<td><a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



                  +'</tr>';



		});



		$('#other_metal_table tbody').append(trHtml);



	}



	else



	{



	    var trHtml='';



        var metal='<option value="">Select Metal</option>';



        var purity='<option value="">Select Purity</option>';



        $.each(category_lists, function (mkey, mitem) {



    	    metal += "<option value='"+mitem.id_ret_category+"'>"+mitem.name+"</option>";



    	});







    	$.each(purityDetails, function (k, p) {



    		purity += "<option value='"+p.id_purity+"'>"+p.purity+"</option>";



    	});







        trHtml+='<tr>'



              +'<td><select class="form-control select_metal">'+metal+'</td>'



              +'<td><select class="form-control select_purity">'+purity+'</td>'



              +'<td><input type="number" class="form-control pcs"></td>'



              +'<td><input type="number" class="form-control gwt"></td>'



              +'<td><input type="number" class="form-control wastage_perc" value="0"><input type="hidden" class="wast_wt" value="0"></td>'



              +'<td><select class="form-control calc_type"><option value="">Mc Type</option><option value="1" selected>Per Gram</option><option value="2">Per Piece</option></select></td>'



              +'<td><input type="number" class="form-control making_charge" value="0"><input type="hidden" class="mc_value" value="0"></td>'



              +'<td><input type="number" class="form-control rate_per_gram"></td>'



              +'<td><input type="number" class="form-control amount" ></td>'



               +'<td><a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



              +'</tr>';



         $('#other_metal_table tbody').append(trHtml);



	}



	$('#other_metalmodal').modal('show');







}



function get_taxgroup_items(){



	my_Date = new Date();



	$.ajax({



		url: base_url+'index.php/admin_ret_billing/getAllTaxgroupItems/?nocache=' + my_Date.getUTCSeconds(),



		dataType: "json",



		method: "GET",



		success: function ( data ) {



			tax_details = data;



			console.log("tax_details", tax_details);



		}



	 });



}



$(document).on('change', '.purreturnweight', function(event)

{

    var row     = $(this).parent().closest('tr');

    var act_purret_wt = row.find('.act_purret_wt').val();

    if(this.value > parseFloat(act_purret_wt))

    {

        row.find('.purreturnweight').val(act_purret_wt);

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Entered Wt greater than Actual Wt"});

    }



    calculate_purchase_return_item_cost();



});



$(document).on('change','.purreturnpcs',function(event)

{

    var row     = $(this).parent().closest('tr');

    var act_purreturnpcs = row.find('.act_purreturnpcs').val();

    if(this.value > parseInt(act_purreturnpcs))

    {

        row.find('.purreturnpcs').val(act_purreturnpcs);

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Entered Pcs greater than Actual Pcs"});

    }



    calculate_purchase_return_item_cost();

})



$(document).on('keyup','.purreturnrate',function(event)

{



    calculate_purchase_return_item_cost();



})



$(document).on('keyup','.purreturnrate',function(){



    curRow.find('.itemcaltype').val(1);



    calculate_purchase_return_item_cost();



});



$(document).on('keyup','.purreturnrate',function(){



    curRow.find('.itemcaltype').val(1);



});



$(document).on('keyup','.returnitemcost',function(){



    curRow = $(this).parent().closest('tr');



    curRow.find('.itemcaltype').val(2);



    calculate_returnItem_details(curRow);



});



$(document).on('change', '.purreturncaltype, .returnitemcost,.return_discount', function(event) {



    var row     = $(this).parent().closest('tr');



    //calculate_returnItem_details(row);



    calculate_purchase_return_item_cost();



});



$('#set_non_tag_stock_list').on('click',function(){



    if($('#select_section').val() == null || $('#select_section').val() == '')

    {

        $.toaster({priority: 'danger', title: 'Warning!' , message: ''+"</br>Select Section"});

    }



    else if($('#select_product').val() == null || $('#select_product').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Product"});



	}



	else if($('#select_design').val() == null || $('#select_design').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Design"});



	}



	else if($('#select_sub_design').val() == null || $('#select_sub_design').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Sub Design"});



	}



	else



	{



	    set_non_tag_item_list();



	}



});



function set_non_tag_item_list_06_03_2023()



{



    var nonTagProdExists=false;







    var cat_id = $('#select_product option:selected').attr('data-cat_id');



    var categoryname = $('#select_product option:selected').attr('data-categoryname');



    var tgrp_id = $('#select_product option:selected').attr('data-tgrp_id');



    if(nontagreturnitemlist.length > 0)



    {



        $.each(nontagreturnitemlist,function(k,ntval){



            if(ntval.cat_id == cat_id)



            {



                nontagreturnitemlist[k].piece = parseFloat(parseFloat(nontagreturnitemlist[k].piece)+parseFloat($('#issue_pcs').val())).toFixed(3);



                nontagreturnitemlist[k].gross_wt =parseFloat(parseFloat(nontagreturnitemlist[k].gross_wt)+parseFloat($('#issue_weight').val())).toFixed(3);



                nontagreturnitemlist[k].less_wt = 0;



            }else



            {



                nontagreturnitemlist.push({'tgrp_id':tgrp_id,'cat_id':cat_id,'id_product':$('#select_product').val(),'id_design':$('#select_design').val(),'id_sub_design':$('#select_sub_design').val(),'piece':$('#issue_pcs').val(),'gross_wt':$('#issue_weight').val(),'less_wt':0,'net_wt':$('#issue_weight').val(),'catname':categoryname});



            }



        });



    }



    else



    {



        nontagreturnitemlist.push({'tgrp_id':tgrp_id,'cat_id':cat_id,'id_product':$('#select_product').val(),'id_design':$('#select_design').val(),'id_sub_design':$('#select_sub_design').val(),'piece':$('#issue_pcs').val(),'gross_wt':$('#issue_weight').val(),'less_wt':0,'net_wt':$('#issue_weight').val(),'catname':categoryname});



    }







    if(nontagreturnitemlist.length > 0)



    {



        if(insertedcatdetails.length > 0)



        {



            var category_exists = false;



            $.each(nontagreturnitemlist,function(items,ntval){



                $.each(insertedcatdetails,function(k,val){



                    if(val.cat_id == ntval.cat_id)



                    {



                        category_exists = true;



                    }



                });



                if(!category_exists)



                {



                    insertedcatdetails.push({'cat_id':ntval.cat_id,'piece':ntval.piece,'catname':ntval.catname,'gross_wt':ntval.gross_wt,'tgrp_id':ntval.tgrp_id,'less_wt':0,'other_metal_weight':0,'stone_details':'','other_metal_details':''});



                }else



                {



                    $.each(insertedcatdetails,function(k,val){



                        if(val.cat_id == cat_id)



                        {



                            insertedcatdetails[k].piece = parseFloat(parseFloat(insertedcatdetails[k].piece)+parseFloat($('#issue_pcs').val())).toFixed(3);



                            insertedcatdetails[k].gross_wt =parseFloat(parseFloat(insertedcatdetails[k].gross_wt)+parseFloat($('#issue_weight').val())).toFixed(3);



                            insertedcatdetails[k].less_wt = 0;



                        }



                    });







                }



            });



        }



        else



        {



            $.each(nontagreturnitemlist,function(key,items){



                insertedcatdetails.push({'cat_id':items.cat_id,'piece':$('#issue_pcs').val(),'catname':items.catname,'gross_wt':$('#issue_weight').val(),'tgrp_id':items.tgrp_id,'less_wt':0,'other_metal_weight':0,'stone_details':'','other_metal_details':''});



            });



        }



    }







    updatereturncategory();



}



function set_non_tag_item_list()



{



    var cat_id = $('#select_product option:selected').attr('data-cat_id');



    var categoryname = $('#select_product option:selected').attr('data-categoryname');



    var tgrp_id = $('#select_product option:selected').attr('data-tgrp_id');



    var id_section  = $('#select_section option:selected').val();



    var pro_id = $('#select_product option:selected').val();



    var pro_name = $('#select_product option:selected').text();



    var des_id = $('#select_design option:selected').val();



    var des_name = $('#select_design option:selected').text();



    var id_sub_design = $('#select_sub_design option:selected').val();



    var sub_des_name = $('#select_sub_design option:selected').text();



    var tax_type = $('#select_product option:selected').attr('data-data-tax_type');



    if(nontagreturnitemlist.length > 0)



    {



        $.each(nontagreturnitemlist,function(k,ntval)



        {



            nontagreturnitemlist.push({'tax_type':tax_type,'tgrp_id':tgrp_id,'cat_id':cat_id,'id_section':id_section,'pro_id':pro_id,'des_id':des_id,'id_sub_design':id_sub_design,'piece':$('#issue_pcs').val(),'gross_wt':$('#issue_weight').val(),'less_wt':0,'net_wt':$('#issue_weight').val(),'catname':categoryname,'pro_name':pro_name,'des_name':des_name,'subDes_name':sub_des_name,'other_metal_weight':0,'stone_details':'','other_metal_details':'','po_item_id':'','va_per':0,'pur_touch':0,'mc_type':1,'mc_value':0,'tag_id':'','ret_item_type':3,'tag_code':'','bill_det_id':'','branch_trans_id':''});



        });



    }



    else



    {



        nontagreturnitemlist.push({'tax_type':tax_type,'tgrp_id':tgrp_id,'cat_id':cat_id,'id_section':id_section,'pro_id':pro_id,'des_id':des_id,'id_sub_design':id_sub_design,'piece':$('#issue_pcs').val(),'gross_wt':$('#issue_weight').val(),'less_wt':0,'net_wt':$('#issue_weight').val(),'catname':categoryname,'pro_name':pro_name,'des_name':des_name,'subDes_name':sub_des_name,'other_metal_weight':0,'stone_details':'','other_metal_details':'','po_item_id':'','va_per':0,'pur_touch':0,'mc_type':1,'mc_value':0,'tag_id':'','ret_item_type':3,'tag_code':'','bill_det_id':'','branch_trans_id':''});



    }



    if(nontagreturnitemlist.length > 0)



    {



        if(insertedcatdetails.length > 0)



        {



            var category_exists = false;



            $.each(nontagreturnitemlist,function(items,ntval)



            {



                $.each(insertedcatdetails,function(k,val)



                {



                    if(val.cat_id == ntval.cat_id)



                    {



                        category_exists = true;



                    }



                });



            });







                if(!category_exists)



                {



                    insertedcatdetails.push({'tax_type':tax_type,'tgrp_id':tgrp_id,'cat_id':cat_id,'id_section':id_section,'pro_id':pro_id,'des_id':des_id,'id_sub_design':id_sub_design,'piece':$('#issue_pcs').val(),'gross_wt':$('#issue_weight').val(),'less_wt':0,'net_wt':$('#issue_weight').val(),'catname':categoryname,'pro_name':pro_name,'des_name':des_name,'subDes_name':sub_des_name,'other_metal_weight':0,'stone_details':'','other_metal_details':'','po_item_id':'','va_per':0,'pur_touch':0,'mc_type':1,'mc_value':0,'tag_id':'','ret_item_type':3,'tag_code':'','bill_det_id':'','branch_trans_id':''});



                }



                else



                {



                    insertedcatdetails.push({'tax_type':tax_type,'tgrp_id':tgrp_id,'cat_id':cat_id,'id_section':id_section,'pro_id':pro_id,'des_id':des_id,'id_sub_design':id_sub_design,'piece':$('#issue_pcs').val(),'gross_wt':$('#issue_weight').val(),'less_wt':0,'net_wt':$('#issue_weight').val(),'catname':categoryname,'pro_name':pro_name,'des_name':des_name,'subDes_name':sub_des_name,'other_metal_weight':0,'stone_details':'','other_metal_details':'','po_item_id':'','va_per':0,'pur_touch':0,'mc_type':1,'mc_value':0,'tag_id':'','ret_item_type':3,'tag_code':'','bill_det_id':'','branch_trans_id':''});







                }







        }



        else



        {



            $.each(nontagreturnitemlist,function(key,items)



            {



                insertedcatdetails.push({'cat_id':items.cat_id,'piece':$('#issue_pcs').val(),'catname':items.catname,'gross_wt':$('#issue_weight').val(),'tgrp_id':items.tgrp_id,'less_wt':0,'other_metal_weight':0,'stone_details':'','other_metal_details':'','id_section':id_section,'pro_id':pro_id,'des_id':des_id,'id_sub_design':id_sub_design,'pro_name':pro_name,'des_name':des_name,'subDes_name':sub_des_name,'po_item_id':'','va_per':0,'pur_touch':0,'mc_type':1,'mc_value':0,'tag_id':'','ret_item_type':3,'tag_code':'','bill_det_id':'','branch_trans_id':''});



            });



        }



    }



    updatereturncategory();



}



function calculate_returnItem_details(row){







    var retWeight   = $(row).find('.net_wt').val();



    var retRate     = 0;



    //var retRate     = isNaN(parseFloat($(row).find('.purreturnrate').val())) ? 0 : parseFloat($(row).find('.purreturnrate').val());



    var calType     = $(row).find('.purreturncaltype').val();



    var pcs         = isNaN(parseInt($(row).find('.purreturnpcs').val())) ? 0 : $(row).find('.purreturnpcs').val();



    var stoneAmount = isNaN(parseFloat($(row).find('.ret_add_stone_wt').val())) ? 0 : parseFloat($(row).find('.ret_add_stone_wt').val());



    var otherMetalAmount = isNaN(parseFloat($(row).find('.ret_add_other_metal_wt').val())) ? 0 : parseFloat($(row).find('.ret_add_other_metal_wt').val());



    var retTotal    = 0;



    var retItemRowCost = 0;



    if(calType == 1){



        var retcost = isNaN(parseFloat($(row).find('.returnitemcost').val())) ? 0 : parseFloat($(row).find('.returnitemcost').val());



        retRate     = parseFloat(parseFloat(retcost) / parseFloat(retWeight)).toFixed(2);



        retTotal    = retcost;



    }else{



        var retcost = isNaN(parseFloat($(row).find('.returnitemcost').val())) ? 0 : parseFloat($(row).find('.returnitemcost').val());



        retRate     = parseFloat(parseFloat(retcost) / parseFloat(pcs)).toFixed(2);



        retTotal    = retcost;



    }



    $(row).find('.purreturnrate').val(retRate);



    retItemRowCost = parseFloat(retTotal) + parseFloat(stoneAmount) + parseFloat(otherMetalAmount);



    //$(row).find('.returnitemcost').val(isNaN(retItemRowCost) ? 0 : retItemRowCost.toFixed(2));







     var tax_details     = calculate_base_value_tax(parseFloat(retItemRowCost), parseInt($(row).find('.return_item_tax_id').val()));



     var item_tax_amt    = tax_details['totaltax'];



     var tax_percentage  = tax_details['tax_percentage'];



    $(row).find('.purreturnamount').val(parseFloat(parseFloat(retItemRowCost) + parseFloat(item_tax_amt)).toFixed(2));











    //calculate_purchase_return_final_cost();



}



$("input[name='purchase_type']:radio").on('change',function(){



    $('.return_type').css("display","block");

    $('.pur_return_receipt_type').css("display","block");

    $('.purretPo').css("display","block");

    $('.sales_return_type').css("display","none");



    $('#select_po_ref_no').prop('disabled',true);



    $('#return_item_detail > tbody').empty();

    if(this.value==1){

        $('.return_type').css("display","none");

        $('#select_po_ref_no').prop('disabled',false);

    }if(this.value==2){

        $('.pur_return_receipt_type').css("display","none");

        $('.purretPo').css("display","none");

        $('.sales_return_type').css("display","block");

    }



    get_return_item_po_ref_nos();





});



$("input[name='pur_return_convert_to']:radio").on('change',function()

{

    calculate_purchase_return_item_cost();

})



function calculate_purchase_return_item_cost()



{



    var supplier_country = '';



    var supplier_state = '';



    var cmp_country = $('#cmp_country').val();



    var cmp_state = $('#cmp_state').val();



    var supplier_country = $('#supplier_country').val();



    var supplier_state = $('#supplier_state').val();



    $('#return_item_detail > tbody tr').each(function(idx, row){



        curRow                      = $(this);



        var purchase_type           = $("input[name='purchase_type']:checked").val(); //0- Return,1-Sales Bill



        var item_cost               = 0;



        var rate_per_gram           = (isNaN(curRow.find('.purreturnrate').val()) || curRow.find('.purreturnrate').val()=='' ? 0:curRow.find('.purreturnrate').val());



        var tot_pcs                 = (isNaN(curRow.find('.purreturnpcs').val()) || curRow.find('.purreturnpcs').val()=='' ? 0:curRow.find('.purreturnpcs').val());



        var tot_gwt                 = (isNaN(curRow.find('.purreturnweight').val()) || curRow.find('.purreturnweight').val()=='' ? 0:curRow.find('.purreturnweight').val());



        var tot_lwt                 = 0;



        var wastage_per             = (isNaN(curRow.find('.purreturnwastper').val()) || curRow.find('.purreturnwastper').val()=='' ? 0:curRow.find('.purreturnwastper').val());



        var mc_value                = (isNaN(curRow.find('.purreturnmc').val()) || curRow.find('.purreturnmc').val()=='' ? 0:curRow.find('.purreturnmc').val());



        var mc_type                 = curRow.find('.purreturnmctype').val();



        var id_product              = curRow.find('.return_item_pro_id').val();



        var other_metal_amount      = 0;



        var other_metal_wt          = (isNaN(curRow.find('.add_other_metal_wt').val()) || curRow.find('.add_other_metal_wt').val()=='' ? 0:curRow.find('.add_other_metal_wt').val());



        var other_metal_wast_wt     = 0;



        var other_metal_mc_amount   = 0;



        var stone_price             = 0;



        var calculation_based_on    = (isNaN(curRow.find('.calculation_based_on').val()) || curRow.find('.calculation_based_on').val()=='' ? 0:curRow.find('.calculation_based_on').val());



        var order_div_gwt           = 0;



        var karigar_type            = $('#purret_to_karigar option:selected').attr('data-karigartpe');



        var ratecaltype             = (curRow.find('.purchase_mode').val()!='' ? curRow.find('.purchase_mode').val():curRow.find('.purchase_mode').val()); //2-Flexible,1-Fixed



        var purity                  = (isNaN(curRow.find('.purreturntouch').val()) || curRow.find('.purreturntouch').val()=='' ? 0:curRow.find('.purreturntouch').val());



        var tax_type                = ''; //1-Inclusive,2-Exclusive



        var karigar_calc_type       = curRow.find('.purret_calc_type').val();



        var other_charges_amount = 0;



        var pur_ret_convert_to =  $("input[name='pur_return_convert_to']:checked").val(); // 1- Supplier, 2-Manufaucturers, 3 -Approval Ledger, 4 -Stone Supplier, 5 -Diamond Supplier







        var other_charges_details = [];



        if(curRow.find('.other_charges_details').val()!='')



        {



            other_charges_details = JSON.parse(curRow.find('.other_charges_details').val());



            console.log(other_charges_details);



            $.each(other_charges_details,function(k,val){



            var char_tax = 0;



            var charge_tax_value = 0;



            var item_charges_amount = 0;



                $.each(charges_details, function (ckey, citem) {



    			    if(parseInt(val.charge_id) == parseInt(citem.id_charge)){



    			        char_tax= parseFloat(citem.charge_tax);



    			        }



    			    });



                if(val.calc_type==1)



                {



                    item_charges_amount=parseFloat(val.charge_value);



                }else if(val.calc_type==2)



                {



                    item_charges_amount=(parseFloat(val.charge_value)*tot_pcs);



                }



                if(char_tax > 0){



                    charge_tax_value  = (parseFloat(item_charges_amount)*parseFloat(char_tax)/100).toFixed(2);



                }



               item_charges_amount = parseFloat(parseFloat(item_charges_amount)+parseFloat(charge_tax_value)).toFixed(2);



               other_charges_amount+=parseFloat(item_charges_amount);



               other_charges_details[k].total_charge_value = parseFloat(item_charges_amount).toFixed(2);



               other_charges_details[k].tax_percentage = parseFloat(char_tax).toFixed(2);



               other_charges_details[k].charge_tax_value = parseFloat(charge_tax_value).toFixed(2);



               other_charges_details[k].charge_value = parseFloat(val.charge_value).toFixed(2);



               other_charges_details[k].calc_type = val.calc_type;



               other_charges_details[k].charge_id = val.charge_id;



            });



            curRow.find('.other_charges_details').val(JSON.stringify(other_charges_details));



            curRow.find('.add_other_charges_amt').val(parseFloat(other_charges_amount).toFixed(2));



        }







        var stone_details = [];



        if(curRow.find('.stone_details').val()!=''){



            stone_details = JSON.parse(curRow.find('.stone_details').val());



            $.each(stone_details,function(key,val){



                if(val.show_in_lwt==1){



                    $.each(uom_details,function(key,item){



                         if(item.uom_id==val.stone_uom_id)



                         {



                             if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                             {



                                 tot_lwt+=parseFloat(parseFloat(val.stone_wt)/parseFloat(item.divided_by_value));



                             }else{



                                 tot_lwt+=parseFloat(val.stone_wt);



                             }



                         }



        		    });



                }







                stone_price+=parseFloat(val.stone_price);



            });



            curRow.find('.add_less_wt').val(parseFloat(tot_lwt).toFixed(3));



        }











        var net_wt                  = parseFloat(tot_gwt)-parseFloat(other_metal_wt)-parseFloat(tot_lwt); //Removing Other Metal Weight and Stone Weight







        curRow.find('.net_wt').val(parseFloat(net_wt).toFixed(3));















        /*



        0 - MC & V.A on Gross Weight



        1 - MC & V.A on Net Weight



        2 - MC On Gross & V.A on Net Weight



        */

        if(calculation_based_on==0)



        {



            var wast_wt                 = parseFloat((tot_gwt*wastage_per)/100).toFixed(3);



            var total_mc_value          = (mc_type==1 ? parseFloat(parseFloat(mc_value)*parseFloat(tot_gwt)).toFixed(2) :parseFloat(parseFloat(mc_value)*parseFloat(tot_pcs)).toFixed(2));







        }



        else if(calculation_based_on==1)



        {



            var wast_wt                 = parseFloat((net_wt*wastage_per)/100).toFixed(3);



            var total_mc_value          = (mc_type==1 ? parseFloat(parseFloat(mc_value)*parseFloat(net_wt)).toFixed(2) :parseFloat(parseFloat(mc_value)*parseFloat(tot_pcs)).toFixed(2));



        }



        else if(calculation_based_on==2)



        {



            var total_mc_value          = (mc_type==1 ? parseFloat(parseFloat(mc_value)*parseFloat(tot_gwt)).toFixed(2) :parseFloat(parseFloat(mc_value)*parseFloat(tot_pcs)).toFixed(2));



            var wast_wt                 = parseFloat((net_wt*wastage_per)/100).toFixed(3);



        }



        var total_weight            = parseFloat(wast_wt)+parseFloat(net_wt);



        if(karigar_calc_type==1)



        {



            var purewt = format(parseFloat((parseFloat(net_wt) * (parseFloat(purity) + parseFloat(wastage_per))) / 100)).replace(/,/g, '');



        }else if(karigar_calc_type==2) //Net weight * touch



        {



            var purewt = parseFloat((parseFloat(net_wt) * (parseFloat(purity)/100)));



        }



        else if(karigar_calc_type==3) // ((net wt * 3%)*92%)



        {



            var touch_weight       = parseFloat((parseFloat(net_wt)*parseFloat(purity)/100)).toFixed(3);



            var wastage_touch      = parseFloat(parseFloat(touch_weight)*(parseFloat(wastage_per))/100);



            var purewt             = parseFloat(parseFloat(touch_weight)+parseFloat(wastage_touch)).toFixed(3);



        }







        if(purchase_type==0) //1-Purchase return



        {







            /*if(ratecaltype==2)



            {



                item_cost   = parseFloat((parseFloat(purewt)*parseFloat(rate_per_gram))+parseFloat(total_mc_value)+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(stone_price)).toFixed(2);



            }else



            {



                item_cost   = parseFloat((parseFloat(tot_pcs)*parseFloat(rate_per_gram))+parseFloat(total_mc_value)+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(stone_price)).toFixed(2);



            }*/



            var total_wt = parseFloat(parseFloat(parseFloat(net_wt)*parseFloat(wastage_per)/100)).toFixed(3);





            item_cost   = parseFloat((parseFloat(parseFloat(purewt))*parseFloat(rate_per_gram))+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(total_mc_value)+parseFloat(stone_price)).toFixed(2);







            console.log('item_cost:'+item_cost);







            var tax_group = '';



            var total_tax_rate = 0;



            var igst_cost = 0;



            var sgst_cost = 0;



            var cgst_cost = 0;



            if(curRow.find('.po_item_id').val()!='')



            {



                var tax_group = curRow.find('.return_item_tax_id').val();



                var tax_type  = curRow.find('.return_item_tax_type').val();



            }else



            {



                $.each(product_list,function(key,val){



                    if(val.pro_id == id_product)



                    {



                        tax_group = val.tax_group_id;



                        tax_type = val.tax_type;



                    }



                });



            }







            if((tax_group!='' && tax_group!=0) && (pur_ret_convert_to!=3))



            {





                if(pur_ret_convert_to==2)  // for Manufacture karigar

                {

                    tax_group = 10 ;  // --> tgrp_id for 5% Gst.

                }





                if(tax_type==1) // Inclusive of Tax



                {



                    tax_details = calculate_inclusiveGST(item_cost,tax_group);



                    console.log(tax_details);



                    var total_tax_rate = tax_details['totaltax'];



                    var tax_percentage = tax_details['tax_percentage'];



                    if(cmp_country=='' || cmp_state=='')



            		{



            		    cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		    sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		}



            		else



            		{



            		    if(total_tax_rate > 0)



            		    {



            		        if(cmp_country==supplier_country)



                		    {



                		        if(cmp_state==supplier_state)



                		        {



                		            sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		            cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		        }else



                		        {



                		            igst_cost = total_tax_rate;



                		        }



                		    }else



                		    {



                		        sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		        cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		    }



            		    }



            		}



                }else



                {



                    var tax_details     = calculate_base_value_tax(item_cost, tax_group);



                    var total_tax_rate  = tax_details['totaltax'];



                    var tax_percentage  = tax_details['tax_percentage'];



                    item_cost           = parseFloat(parseFloat(item_cost)+parseFloat(total_tax_rate)).toFixed(2);



                    if(cmp_country=='' || cmp_state=='')



            		{



            		    cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		    sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



            		}



            		else



            		{



            		    if(total_tax_rate > 0)



            		    {



            		        if(cmp_country==supplier_country)



                		    {



                		        if(cmp_state==supplier_state)



                		        {



                		            sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		            cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		        }else



                		        {



                		            igst_cost = total_tax_rate;



                		        }



                		    }else



                		    {



                		        sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		        cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		    }



            		    }



            		}



                }



                curRow.find('.return_item_tax_cgst_value').val(parseFloat(cgst_cost).toFixed(2));



                curRow.find('.return_item_tax_sgst_value').val(parseFloat(sgst_cost).toFixed(2));



                curRow.find('.return_item_tax_igst_value').val(parseFloat(igst_cost).toFixed(2));



                curRow.find('.return_item_tax_value').val(parseFloat(total_tax_rate).toFixed(2));



                curRow.find('.return_item_tax_percent').val(parseFloat(tax_percentage).toFixed(2));



                curRow.find('.return_item_tax_type').val(tax_type);



                curRow.find('.purreturntax').val(parseFloat(tax_percentage).toFixed(2));



            }

            else

            {

                curRow.find('.return_item_tax_cgst_value').val(parseFloat(cgst_cost).toFixed(2));



                curRow.find('.return_item_tax_sgst_value').val(parseFloat(sgst_cost).toFixed(2));



                curRow.find('.return_item_tax_igst_value').val(parseFloat(igst_cost).toFixed(2));



                curRow.find('.return_item_tax_value').val(parseFloat(total_tax_rate).toFixed(2));



                curRow.find('.return_item_tax_percent').val(parseFloat(tax_percentage).toFixed(2));



                curRow.find('.return_item_tax_type').val(tax_type);



                curRow.find('.purreturntax').val(parseFloat(tax_percentage).toFixed(2));

            }











        }



        else



        {



            /*



            1.For Job Work Receipt No GST.



            1.For B2B Karigar  - Need to calculate GST For MC and Stone Value.



            */



            var mc_and_stone_charges = parseFloat(total_mc_value)+parseFloat(stone_price);  //Need to Calculate GST For MC and Stone..



            if(karigar_type == 1 && mc_and_stone_charges>0)



            {



                $.each(product_list,function(key,val){



                    if(val.pro_id == id_product)



                    {



                        tax_group = val.job_work_receipt_tgrp_id;



                        tax_type = val.purchase_tax_type;



                    }



                });



                if(tax_group!='' && pur_ret_convert_to!=3)



                {



                    if(pur_ret_convert_to==2)  // for Manufacture karigar

                    {

                        tax_group = 10 ;  // --> tgrp_id for 5% Gst.

                    }



                    if(tax_type==1) // Inclusive of Tax



                    {



                        tax_details = calculate_inclusiveGST(mc_and_stone_charges,tax_group);



                        console.log(tax_details);



                        var total_tax_rate = tax_details['totaltax'];



                        var tax_percentage = tax_details['tax_percentage'];



                        if(cmp_country=='' || cmp_state=='')



                		{



                		    cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		    sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		}



                		else



                		{



                		    if(total_tax_rate > 0)



                		    {



                		        if(cmp_country==supplier_country)



                    		    {



                    		        if(cmp_state==supplier_state)



                    		        {



                    		            sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                    		            cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                    		        }else



                    		        {



                    		            igst_cost = total_tax_rate;



                    		        }



                    		    }else



                    		    {



                    		        sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                    		        cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                    		    }



                		    }



                		}



                    }else



                    {



                        var tax_details     = calculate_base_value_tax(mc_and_stone_charges, tax_group);



                        var total_tax_rate  = tax_details['totaltax'];



                        var tax_percentage  = tax_details['tax_percentage'];



                        mc_and_stone_charges           = parseFloat(parseFloat(mc_and_stone_charges)+parseFloat(total_tax_rate)).toFixed(2);



                        if(cmp_country=='' || cmp_state=='')



                		{



                		    cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		    sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                		}



                		else



                		{



                		    if(total_tax_rate > 0)



                		    {



                		        if(cmp_country==supplier_country)



                    		    {



                    		        if(cmp_state==supplier_state)



                    		        {



                    		            sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                    		            cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                    		        }else



                    		        {



                    		            igst_cost = total_tax_rate;



                    		        }



                    		    }else



                    		    {



                    		        sgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                    		        cgst_cost = parseFloat(parseFloat(total_tax_rate)/2).toFixed(2);



                    		    }



                		    }



                		}



                    }



                    curRow.find('.return_item_tax_cgst_value').val(parseFloat(cgst_cost).toFixed(2));



                    curRow.find('.return_item_tax_sgst_value').val(parseFloat(sgst_cost).toFixed(2));



                    curRow.find('.return_item_tax_igst_value').val(parseFloat(igst_cost).toFixed(2));



                    curRow.find('.return_item_tax_value').val(parseFloat(total_tax_rate).toFixed(2));



                    curRow.find('.purreturntax').val(parseFloat(tax_percentage).toFixed(2));



                    curRow.find('.return_item_tax_percent').val(parseFloat(tax_percentage).toFixed(2));



                    curRow.find('.return_item_tax_type').val(tax_type);



                }

                else

                {

                    curRow.find('.return_item_tax_cgst_value').val(parseFloat(cgst_cost).toFixed(2));



                    curRow.find('.return_item_tax_sgst_value').val(parseFloat(sgst_cost).toFixed(2));



                    curRow.find('.return_item_tax_igst_value').val(parseFloat(igst_cost).toFixed(2));



                    curRow.find('.return_item_tax_value').val(parseFloat(total_tax_rate).toFixed(2));



                    curRow.find('.purreturntax').val(parseFloat(tax_percentage).toFixed(2));



                    curRow.find('.return_item_tax_percent').val(parseFloat(tax_percentage).toFixed(2));



                    curRow.find('.return_item_tax_type').val(tax_type);

                }



            }



            var total_wt = parseFloat(parseFloat(parseFloat(net_wt)*parseFloat(wastage_per)/100)).toFixed(3);



            if(ratecaltype==2)



            {



                item_cost   = parseFloat((parseFloat(parseFloat(purewt)+parseFloat(total_wt))*parseFloat(rate_per_gram))+parseFloat(other_metal_amount) + parseFloat(other_charges_amount)+parseFloat(mc_and_stone_charges)).toFixed(2);



            }else



            {



                item_cost   = parseFloat((parseFloat(parseFloat(tot_pcs)+parseFloat(total_wt))*parseFloat(rate_per_gram))).toFixed(2);



            }







        }



        curRow.find('.purreturnwastwgt').val(wast_wt);



        curRow.find('.purreturnpure').val(parseFloat(purewt).toFixed(3));



        curRow.find('.purreturnamount ').val(parseFloat(item_cost).toFixed(2));



        curRow.find('.return_item_tax_sgst_value').val(parseFloat(sgst_cost).toFixed(2));



        curRow.find('.returnitemcost').val(parseFloat(parseFloat(item_cost)-parseFloat(total_tax_rate)).toFixed(2));



    });



    get_purchase_return_total();



    calculate_purchase_return_summary_cost();



}



function calculate_purchase_return_final_cost(){



     var total_item_cost    = 0;



     var total_bill_amount  = 0;



     var other_charges_amount = 0;



     var total_taxable_amt = 0;







    var cmp_country         = $('#cmp_country').val();



    var cmp_state           = $('#cmp_state').val();











     $('#return_item_detail > tbody tr').each(function(idx, row){



        curRow = $(this);



        var supplier_country    = '';



        var supplier_state      = '';



        var item_igst           = 0;



        var item_sgst           = 0;



        var item_cgst           = 0;



        var stoneAmount         = 0;



        var stone_wt            = 0;



        var othermetalwt        = 0;



        var otherMetalAmount    = 0;



        var stone_details           = curRow.find('.stone_details').val();



        var other_metal_details     = curRow.find('.other_metal_details').val();



        var purreturnweight         = curRow.find('.purreturnweight').val();



        var kar_calc_type           = $('#ret_karigar_calc_type').val();



        var purity                  = (isNaN(curRow.find('.purreturntouch').val()) || curRow.find('.purreturntouch').val()=='' ? 0:curRow.find('.purreturntouch').val());



        var wastage                 = (isNaN(curRow.find('.purreturnwastper').val()) || curRow.find('.purreturnwastper').val()=='' ? 0:curRow.find('.purreturnwastper').val());



        var mc_value                = (isNaN(curRow.find('.purreturnmc').val()) || curRow.find('.purreturnmc').val()=='' ? 0:curRow.find('.purreturnmc').val());



        var mc_type                 = curRow.find('.purreturnmctype').val();



        var kar_calc_type           = $('#ret_karigar_calc_type').val();



        var other_charges_amount    = 0;



        var other_charges_details   = curRow.find('.other_charges_details').val();



        var tax_type                = curRow.find('.pur_tax_type').val();



        var tax_grp_id              = curRow.find('.return_item_tax_id').val();



        var tot_pcs                 = isNaN(parseInt(curRow.find('.purreturnpcs').val())) ? 0 : curRow.find('.purreturnpcs').val();





        var pur_ret_convert_to =  $("input[name='pur_return_convert_to']:checked").val(); // 1- Supplier, 2-Manufaucturers, 3 -Approval Ledger, 4 -Stone Supplier, 5 -Diamond Supplier







        $.each(karigar_details,function(k,val){



            if(val.id_karigar == curRow.find('.return_item_kar_id').val())



            {



                supplier_country=val.id_country;



                supplier_state=val.id_state;







            }



        });



        $('#supplier_country').val(supplier_country);



        $('#supplier_state').val(supplier_state);



        if(stone_details!='' && stone_details!=undefined && stone_details.length>0)



        {



            stone_details = JSON.parse(stone_details);



            $.each(stone_details,function(k,val){



                stoneAmount+=parseFloat(val.stone_price);



                if(val.stone_type==1)



                {



                    stone_wt+=parseFloat(val.stone_wt/5);



                }else



                {



                    stone_wt+=parseFloat(val.stone_wt);



                }



            });



        }







        if(other_metal_details!=''  && other_metal_details!=undefined)



        {



            other_metal_details = JSON.parse(other_metal_details);



            $.each(other_metal_details,function(k,val){



                otherMetalAmount+=parseFloat(val.amount);



                othermetalwt+=parseFloat(val.gwt);



            });



        }







        if(other_charges_details!='' && other_charges_details!=undefined)



        {



            other_charges_details = JSON.parse(other_charges_details);



            $.each(other_charges_details,function(k,val)



            {



                var tax_percentage      = val.tax_percentage;



                var charge_tax_value    = 0;



                var item_charges_amount = 0;



                var cgst_cost           = 0;



                var sgst_cost           = 0;



                var igst_cost           = 0;



                if(val.calc_type==1) // Per Item



                {



                    item_charges_amount=parseFloat(val.charge_value);



                }else if(val.calc_type==2) // Per pcs



                {



                    item_charges_amount=parseFloat(parseFloat(val.charge_value)*parseFloat(tot_pcs));



                }



                if(tax_percentage > 0){ // Calculating Tax







                    charge_tax_value  = (parseFloat(item_charges_amount)*parseFloat(tax_percentage)/100).toFixed(2);



                    console.log('charge_tax_value:'+charge_tax_value);



                    item_charges_amount  = parseFloat(parseFloat(item_charges_amount)+parseFloat(charge_tax_value)).toFixed(2);



                    if(cmp_country==supplier_country)



                    {



                        if(cmp_state==supplier_state)



                        {



                            sgst_cost = parseFloat(parseFloat(charge_tax_value)/2).toFixed(2);



                            cgst_cost = parseFloat(parseFloat(charge_tax_value)/2).toFixed(2);



                        }else



                        {



                            igst_cost = charge_tax_value;



                        }



                    }else



                    {



                        cgst_cost = parseFloat(parseFloat(charge_tax_value)/2).toFixed(2);



                        sgst_cost = parseFloat(parseFloat(charge_tax_value)/2).toFixed(2);



                    }



                }



                other_charges_details[k].total_charge_value = parseFloat(item_charges_amount).toFixed(2);



                other_charges_details[k].tax_percentage     = parseFloat(tax_percentage).toFixed(2);



                other_charges_details[k].item_total_tax     = parseFloat(charge_tax_value).toFixed(2);



                other_charges_details[k].cgst_cost          = parseFloat(cgst_cost).toFixed(2);



                other_charges_details[k].sgst_cost          = parseFloat(sgst_cost).toFixed(2);



                other_charges_details[k].igst_cost          = parseFloat(igst_cost).toFixed(2);



                other_charges_amount+=parseFloat(item_charges_amount);







            });



            $('#other_charges_details').val(JSON.stringify(other_charges_details));



            console.log('other_charges_amount:'+other_charges_amount);



        }







        var less_wt = parseFloat(parseFloat(stone_wt)+parseFloat(othermetalwt)).toFixed(3);



        var net_wt =  parseFloat(parseFloat(purreturnweight)-parseFloat(less_wt)).toFixed(3);







        var retWeight   = net_wt;



        var pcs         = isNaN(parseInt(curRow.find('.purreturnpcs').val())) ? 0 : curRow.find('.purreturnpcs').val();



        var retRate     = 0;



        var itemCost    = 0;



        var retItemRowCost = 0;



        var calType     = curRow.find('.purreturncaltype').val();



        var wast_wt    = parseFloat((purreturnweight*wastage)/100).toFixed(3);



        curRow.find('.purreturnwastwgt').val(wast_wt);







        if(mc_type==1)



        {



            mc_value = parseFloat(net_wt * mc_value);



        }



        else



        {



            mc_value = parseFloat(curRow.find('.purreturnpcs').val() * mc_value);



        }



        if(kar_calc_type==1)



        {



            var purewt = format(parseFloat((parseFloat(net_wt) * (parseFloat(purity) + parseFloat(wastage))) / 100)).replace(/,/g, '');



        }



        else if(kar_calc_type==2) //Net weight * touch



        {



            var purewt = parseFloat((parseFloat(net_wt) * (parseFloat(purity)/100)));



        }



        else if(kar_calc_type==3) // ((net wt * 3%)*92%)



        {



            var touch_weight       = parseFloat((parseFloat(net_wt)*parseFloat(purity)/100)).toFixed(3);



            var wastage_touch      = parseFloat(parseFloat(touch_weight)*(parseFloat(wastage))/100);



            var purewt             =parseFloat(parseFloat(touch_weight)+parseFloat(wastage_touch)).toFixed(3);



        }







        curRow.find('.purreturnpure').val(parseFloat(purewt).toFixed(3));











        if(curRow.find('.itemcaltype').val() == 1)



        {



            retRate     = isNaN(parseFloat(curRow.find('.purreturnrate').val())) ? 0 : parseFloat(curRow.find('.purreturnrate').val());







            retTotal    = parseFloat(purewt) * parseFloat(retRate);







        }



        else



        {



            itemCost    = isNaN(parseFloat(curRow.find('.returnitemcost').val())) ? 0 : parseFloat(curRow.find('.returnitemcost').val());



            if(calType == 1){



                retRate     = parseFloat(parseFloat(parseFloat(itemCost)/parseFloat(retWeight))).toFixed(2)



                curRow.find('.purreturnrate').val(retRate);



            }else{



                retRate     = parseFloat(parseFloat(parseFloat(itemCost)/parseFloat(pcs))).toFixed(2)



                curRow.find('.purreturnrate').val(retRate);



            }



            retTotal    = itemCost;



        }







        retItemRowCost =  parseFloat(mc_value) + parseFloat(retTotal) + parseFloat(stoneAmount) + parseFloat(otherMetalAmount)+parseFloat(other_charges_amount);















       if(tax_grp_id!='' && pur_ret_convert_to!=3)



        {



            if(pur_ret_convert_to==2)  // for Manufacture karigar

            {

                tax_grp_id = 10 ;  // --> tgrp_id for 5% Gst.

            }



            if(tax_type==1) // Inclusive of Tax



            {



                var tax_details     = calculate_inclusiveGST(parseFloat(retItemRowCost),tax_grp_id);



                var item_tax_amt    = tax_details['totaltax'];



                var tax_percentage  = tax_details['tax_percentage'];







                if(cmp_country=='' || cmp_state=='')



                {



                    item_sgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                    item_cgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                }



                else



                {



                    if(item_tax_amt > 0)



                    {



                        if(cmp_country==supplier_country)



                        {



                            if(cmp_state==supplier_state)



                            {



                                item_sgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                                item_cgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                            }else



                            {



                                item_igst = item_tax_amt;



                            }



                        }else



                        {



                            item_sgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                            item_cgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                        }



                    }







                }



            }



            else



            {



                var tax_details     = calculate_base_value_tax(parseFloat(retItemRowCost),tax_grp_id);



                var item_tax_amt    = tax_details['totaltax'];



                var tax_percentage  = tax_details['tax_percentage'];



                $.each(karigar_details,function(k,val){



                    if(val.id_karigar == curRow.find('.return_item_kar_id').val())



                    {



                        supplier_country=val.id_country;



                        supplier_state=val.id_state;







                    }



                });



                $('#supplier_country').val(supplier_country);



                $('#supplier_state').val(supplier_state);



                if(cmp_country=='' || cmp_state=='')



                {



                    item_sgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                    item_cgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                }



                else



                {



                    if(item_tax_amt > 0)



                    {



                        if(cmp_country==supplier_country)



                        {



                            if(cmp_state==supplier_state)



                            {



                                item_sgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                                item_cgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                            }else



                            {



                                item_igst = item_tax_amt;



                            }



                        }else



                        {



                            item_sgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                            item_cgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



                        }



                    }







                }



            }



        }







        console.log('kar_calc_type:'+kar_calc_type);



        console.log('purewt:'+purewt);



		console.log('less_wt:'+less_wt);



        console.log('net_wt:'+net_wt);



        console.log('othermetalwt:'+othermetalwt);



        console.log('stone_wt:'+stone_wt);



        console.log('otherMetalAmount:'+otherMetalAmount);



        console.log('stoneAmount:'+stoneAmount);



        console.log('taxableamount:'+retItemRowCost);







        curRow.find('.add_less_wt').val(parseFloat(less_wt).toFixed(3));



        curRow.find('.add_other_metal_wt').val(parseFloat(othermetalwt).toFixed(3));



        curRow.find('.net_wt').val(parseFloat(net_wt).toFixed(3));



        curRow.find('.return_item_tax_value').val(item_tax_amt);



        curRow.find('.return_item_tax_igst_value').val(item_igst);



        curRow.find('.return_item_tax_sgst_value').val(item_sgst);



        curRow.find('.return_item_tax_cgst_value').val(item_cgst);



        curRow.find('.return_item_tax_percent').val(tax_percentage);



        curRow.find('.purreturntax ').val(parseFloat(item_tax_amt).toFixed(2));



        curRow.find('.add_other_charges_amt ').val(parseFloat(other_charges_amount).toFixed(2));



        total_taxable_amt  += (parseFloat(retItemRowCost));



        total_item_cost  += (parseFloat(retItemRowCost) + parseFloat(item_tax_amt));







        curRow.find('.returnitemcost').val(parseFloat(retItemRowCost).toFixed(2));



        curRow.find('.purreturnamount').val(parseFloat(parseFloat(retItemRowCost) + parseFloat(item_tax_amt)).toFixed(2));







    });







    //other_charges_amount       = (isNaN($('#other_charges_amount').val()) || $('#other_charges_amount').val()=='' ? 0:$('#other_charges_amount').val());



    total_bill_amount          = parseFloat(parseFloat(total_item_cost) + parseFloat(other_charges_amount)).toFixed(2);



    round_of_val               = total_bill_amount;



    tot_cost 			        = parseFloat(Math.round(total_bill_amount));



    round_of_amt               = parseFloat(tot_cost-round_of_val).toFixed(2);



    console.log(round_of_amt);



    $('.return_round_off').val(round_of_amt<0.50 ? round_of_amt : round_of_amt);



    $('.return_total_cost').val(parseFloat(tot_cost).toFixed(2));



    $('.total_summary_payable_amt').val(parseFloat(total_taxable_amt).toFixed(2));







    calculate_purchase_return_summary_cost();



}



function calculate_purchase_return_summary_cost()



{



     var total_item_cost = 0;



     var total_bill_amount = 0;



     var total_taxable_amount = 0;



     var total_cgst_amount = 0;



     var total_sgst_amount = 0;



     var total_igst_amount = 0;







    var tcsval = 0;



    var tdsval = 0;



    var other_charges_tdsval = 0;







     $.each(karigar_details,function(k,val){



        if(val.id_karigar == $('#select_karigar').val())



        {



            supplier_country=val.id_country;



            supplier_state=val.id_state;



            $('#tcs_percent').val(val.tcs_tax);



            $('#tds_percent').val(val.tds_tax);



        }



    });







    var tcspercent =(isNaN($('#tcs_percent').val()) || $('#tcs_percent').val()=='' ? 0:$('#tcs_percent').val());



    var tdspercent =(isNaN($('#tds_percent').val()) || $('#tds_percent').val()=='' ? 0:$('#tds_percent').val());



    var charges_tds_percent =(isNaN($('#charges_tds_percent').val()) || $('#charges_tds_percent').val()=='' ? 0:$('#charges_tds_percent').val());







    var other_charges_details = $('#other_charges_details').val();



    var charges_details       = [];



    if(other_charges_details!='' && other_charges_details!=undefined)



    {



        var charges_details = JSON.parse($('#other_charges_details').val());



    }







    var total_charges_taxable_amount    = 0;



    var total_charges_tax_amount        = 0;



    var total_charges_amount            = 0;



    if(charges_details.length > 0)



    {



        $.each(charges_details,function(k,val){



           total_charges_amount+=parseFloat(val.char_with_tax);



           total_charges_taxable_amount+=parseFloat(val.charge_value);



           total_charges_tax_amount+=parseFloat(val.charge_tax_value);



        });



    }







     $('#return_item_detail > tbody tr').each(function(idx, row){



         curRow = $(this);



         total_item_cost    += parseFloat(curRow.find('.purreturnamount').val());



         total_cgst_amount  += parseFloat(curRow.find('.return_item_tax_cgst_value').val());



         total_sgst_amount  += parseFloat(curRow.find('.return_item_tax_sgst_value').val());



         total_igst_amount  += parseFloat(curRow.find('.return_item_tax_igst_value').val());



         total_taxable_amount  += parseFloat((curRow.find('.purreturnamount').val())-(curRow.find('.return_item_tax_value').val()));



     });











     var tot_discount           = (isNaN($('.grn_discount').val()) || $('.grn_discount').val()=='' ? 0:$('.grn_discount').val());



     var other_charges_amount   = (isNaN($('#other_charges_amount').val()) || $('#other_charges_amount').val()=='' ? 0:$('#other_charges_amount').val());



     $('.total_summary_taxable_amt').val(parseFloat(total_taxable_amount).toFixed(2));



     $('.total_summary_cgst_amount').val(parseFloat(total_cgst_amount).toFixed(2));



     $('.total_summary_sgst_amount').val(parseFloat(total_sgst_amount).toFixed(2));



     $('.total_summary_igst_amount').val(parseFloat(total_igst_amount).toFixed(2));







     //$('#other_charges_taxable_amount').val(parseFloat(total_charges_taxable_amount).toFixed(2));



     //$('#other_charges_tax').val(parseFloat(total_charges_tax_amount).toFixed(2));











     if(total_charges_tax_amount > 0)



    {



        var cmp_country         = $('#cmp_country').val();



        var cmp_state           = $('#cmp_state').val();



        var supplier_country    = $('#supplier_country').val();



        var supplier_state      = $('#supplier_state').val();



        var other_charges_igst = 0;



        var other_charges_sgst = 0;



        var other_charges_cgst = 0;



        if(cmp_country==supplier_country)



	    {



	        if(cmp_state==supplier_state)



	        {



	            other_charges_cgst = parseFloat(parseFloat(total_charges_tax_amount)/2).toFixed(2);



	            other_charges_sgst = parseFloat(parseFloat(total_charges_tax_amount)/2).toFixed(2);



	        }else



	        {



	            other_charges_igst = total_charges_tax_amount;



	        }



	    }else



	    {



	        other_charges_cgst = parseFloat(parseFloat(total_charges_tax_amount)/2).toFixed(2);



	        other_charges_sgst = parseFloat(parseFloat(total_charges_tax_amount)/2).toFixed(2);



	    }



	    $('.other_charges_cgst').html(parseFloat(other_charges_cgst).toFixed(2));



        $('.other_charges_sgst').html(parseFloat(other_charges_sgst).toFixed(2));



        $('.other_charges_igst').html(parseFloat(other_charges_igst).toFixed(2));



    }











    if(tdspercent > 0){



        tdsval = parseFloat(parseFloat(total_taxable_amount) * (tdspercent / 100)).toFixed(2);



    }



    $("#tds_tax_value").val(tdsval);











    if(tcspercent > 0){



        tcsval = parseFloat(parseFloat(total_item_cost) * (tcspercent / 100)).toFixed(2);



    }



    $("#tcs_tax_value").val(tcsval);







    if(charges_tds_percent > 0)



    {



        other_charges_tdsval = parseFloat(parseFloat(total_charges_taxable_amount) * (charges_tds_percent / 100)).toFixed(2);



    }



    $("#other_charges_tds_tax_value").val(other_charges_tdsval);



     calculate_purchase_return_payment_cost();



     showPurchaseReturnpreview();



}



$(document).on('click', '#table_charges tbody tr .create_charge_item_details, .add_pur_charges', function(){



    if(validate_charges_row()){



		add_new_empty_other_charges_row();



	}else{



		alert("Please fill required charge fields");



	}



});



function create_new_empty_other_charges_row(curRow)



{



    $('#table_charges tbody').empty();



    if(curRow!=undefined)



	{



		$('#custom_active_id').val(curRow.closest('tr').attr('id'));



	}



    var row = "";



    var catRow=$('#custom_active_id').val();



    var other_charge_details=$('#'+catRow).find('.other_charges_details').val();



    if(other_charge_details!='' && other_charge_details !='[]' && other_charge_details!=undefined)



    {



        var cus_charges_details=JSON.parse(other_charge_details);



        $.each(cus_charges_details, function (pkey, pitem)



        {



            let options = '';







            let row_cls = $('#table_charges tbody tr').length;



            let _row_last = $('#table_charges tbody tr:last');



            let sno = (_row_last.length > 0 ? parseInt(_row_last.find('.sno').text()) : 0)+1;







            console.log(charges_list);



            $(charges_list).each(function(idx, charges){



                options += "<option value='"+charges.id_charge+"' "+(charges.id_charge == pitem.charge_id ? 'selected' : '')+">"+charges.name_charge+"</option>";



            });



            row+='<tr class="ch_'+row_cls+'"><td><select class="form-control chargesType"><option value="">--Select--</option>'+options+'</select></td><td><select class="form-control calc_type"><option value="1" '+(pitem.calc_type==1 ? "selected" :'')+' >Per Item</option><option value="2" '+(pitem.calc_type==2 ? "selected" :'')+' >Per Piece</option></select></td><td><input type="text" value="'+((pitem.charge_value == undefined ? 0 : pitem.charge_value))+'" class="form-control chargesValue" /></td><td><a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td></tr>';



        })



    }



    else



    {



        add_new_empty_other_charges_row();



    }



    $('#pur_chargeModal .modal-body').find('#table_charges tbody').append(row);



    $('#pur_chargeModal').modal('show');



}



function add_new_empty_other_charges_row()



{



    var row = "";



    let options = '';



    let row_cls = $('#table_charges tbody tr').length;



    let _row_last = $('#table_charges tbody tr:last');



    let sno = (_row_last.length > 0 ? parseInt(_row_last.find('.sno').text()) : 0)+1;



    console.log(charges_list);



    $(charges_list).each(function(idx, charges){



        options += "<option value='"+charges.id_charge+"'>"+charges.name_charge+"</option>";



    });



    row+='<tr class="ch_'+row_cls+'"><td><select class="form-control chargesType"><option value="">--Select--</option>'+options+'</select></td><td><select class="form-control calc_type"><option value="1">Per Item</option><option value="2">Per Piece</option></select></td><td><input type="text" value="" class="form-control chargesValue" /></td><td><a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td></tr>';



    $('#pur_chargeModal .modal-body').find('#table_charges tbody').append(row);



}



$('#pur_chargeModal  #update_pur_charge_details').on('click', function(){



	if(validate_charges_row())



    {



		var charge_details=[];



		var charge_value=0;







		var charge_value_with_tax = 0;



        var catRow   =$('#custom_active_id').val();



		modalChargeDetail = []; // Reset Old Value of charge modal



		$('#pur_chargeModal .modal-body #table_charges> tbody  > tr').each(function(index, tr) {



			charge_value += parseFloat($(this).find('.chargesValue').val());







			var char_tax        = 0;



			var char_tax_value  = 0;



			var selected_charge = $(this).find('.chargesType').val();



			$.each(charges_details, function (ckey, citem) {



			    if(parseInt(selected_charge) == parseInt(citem.id_charge)){







			        char_tax= parseFloat(citem.charge_tax);







			    }







        	});







			var char_with_tax = parseFloat(parseFloat($(this).find('.chargesValue').val()) * ((100 + char_tax) / 100)).toFixed(2);







			char_tax_value     = parseFloat(parseFloat($(this).find('.chargesValue').val()) * ((char_tax) / 100)).toFixed(2);







			charge_value_with_tax += parseFloat(char_with_tax);







			charge_details.push({



						'charge_value'       : $(this).find('.chargesValue').val(),



						'charge_id'          : $(this).find('.chargesType').val(),



						'calc_type'          : $(this).find('.calc_type').val(),



						'tax_percentage'     : char_tax,



						'item_total_tax'     : 0,



						'cgst_cost'          : 0,



						'sgst_cost'          : 0,



						'igst_cost'          : 0,



						'total_charge_value' : 0,



						});



		});



		modalChargeDetail = charge_details;



		console.log(modalChargeDetail);



		// Update charge Summary



        //$("#other_charges_amount").val(parseFloat(charge_value_with_tax).toFixed(2));



		$('#'+catRow).find("#other_charges_details").val(JSON.stringify(charge_details));



        $('#'+catRow).find('.add_other_charges_amt').val(parseFloat(charge_value_with_tax).toFixed(2));



        $('#pur_chargeModal .modal-body').find('#table_charges tbody').empty();



        $('#pur_chargeModal').modal('hide');







        if(ctrl_page[1] == 'purchasereturn' && ctrl_page[2] == 'add')



        {



            //calculate_returnItem_details($('#'+catRow));



            calculate_purchase_return_item_cost();



        }







    }



    else



    {



    	alert('Please Fill The Required charge Details');



    }



});



function calculate_purchase_return_payment_cost()



{



    var total_summary_taxable_amt       = (isNaN($('.total_summary_taxable_amt').val()) || $('.total_summary_taxable_amt').val()=='' ? 0:$('.total_summary_taxable_amt').val());



    var tds_tax_value                   = (isNaN($('.tds_tax_value').val()) || $('.tds_tax_value').val()=='' ? 0:$('.tds_tax_value').val());



    var total_summary_cgst_amount       = (isNaN($('.total_summary_cgst_amount').val()) || $('.total_summary_cgst_amount').val()=='' ? 0:$('.total_summary_cgst_amount').val());



    var total_summary_sgst_amount       = (isNaN($('.total_summary_sgst_amount').val()) || $('.total_summary_sgst_amount').val()=='' ? 0:$('.total_summary_sgst_amount').val());



    var total_summary_igst_amount       = (isNaN($('.total_summary_igst_amount').val()) || $('.total_summary_igst_amount').val()=='' ? 0:$('.total_summary_igst_amount').val());



    var tcs_tax_value                   = (isNaN($('.tcs_tax_value').val()) || $('.tcs_tax_value').val()=='' ? 0:$('.tcs_tax_value').val());



    var other_charges_tds_tax_value     = (isNaN($('.other_charges_tds_tax_value').val()) || $('.other_charges_tds_tax_value').val()=='' ? 0:$('.other_charges_tds_tax_value').val());



    var other_charges_taxable_amount    = (isNaN($('#other_charges_taxable_amount').val()) || $('#other_charges_taxable_amount').val()=='' ? 0:$('#other_charges_taxable_amount').val());



    var other_charges_tax               = (isNaN($('#other_charges_tax').val()) || $('#other_charges_tax').val()=='' ? 0:$('#other_charges_tax').val());



    var grn_discount                    = (isNaN($('.return_discount').val()) || $('.return_discount').val()=='' ? 0:$('.return_discount').val());



    var final_cost = parseFloat(parseFloat(total_summary_taxable_amt)-parseFloat(tds_tax_value)+parseFloat(total_summary_cgst_amount)+parseFloat(total_summary_sgst_amount)+parseFloat(total_summary_igst_amount)+parseFloat(tcs_tax_value)+parseFloat(other_charges_taxable_amount)-parseFloat(other_charges_tds_tax_value)+parseFloat(other_charges_tax)-parseFloat(grn_discount)).toFixed(2)



    console.log('final_cost:'+final_cost);







     round_of_val               = final_cost;



     tot_cost 			        = parseFloat(Math.round(final_cost));



	 round_of_amt               = parseFloat(tot_cost-round_of_val).toFixed(2);



	 $('.return_round_off').val(round_of_amt<0.50 ? (round_of_amt < 0 ? (round_of_amt*-1) :round_of_amt) : (round_of_amt < 0 ? (round_of_amt*-1) :round_of_amt));



	 $('.round_off_symbol').val(round_of_amt<0 ? 0 : 1);







     $('.return_total_cost').val(parseFloat(tot_cost).toFixed(2));







}



$(document).on('change', '.return_round_off,.round_off_symbol', function (){



    var final_cost  = $('.return_total_cost').val();



    var return_round_off                   = (isNaN($('.return_round_off').val()) || $('.return_round_off').val()=='' ? 0:$('.return_round_off').val());



    var round_off_symbol                = $('.round_off_symbol').val();



    if(return_round_off > 0)



    {



        if(round_off_symbol==1) // Add to Final cost



        {



            final_cost = parseFloat(final_cost)+parseFloat(return_round_off);



        }else



        {



            final_cost = parseFloat(final_cost)-parseFloat(return_round_off);



        }



        $('.return_total_cost').val(parseFloat(final_cost).toFixed(2));



    }else



    {



        calculate_purchase_return_payment_cost();



    }



});



/*Purchase Return Summary*/



function showPurchaseReturnpreview()



{



    var html = "";



    var length  =$('#return_item_detail tbody tr').length;



    if(length > 0){



        $('#return_item_details_preview tbody').empty();



        $('#return_item_detail > tbody tr').each(function(idx, row){



             curRow = $(this);



             console.log( curRow);



             if(curRow.find('.return_item_cat_id').val() != "")



             {



                var ratepergrm = isNaN(parseFloat(curRow.find('.purreturnrate').val())) ? 0 : parseFloat(curRow.find('.purreturnrate').val());



                var itemcost    = isNaN(parseFloat(curRow.find('.purreturnamount').val())) ? 0 : parseFloat(curRow.find('.purreturnamount').val());



                html+='<tr><td>'+curRow.find('.purreturncat').html()+'</td><td>'+parseInt(curRow.find('.purreturnpcs').val())+'</td><td>'+parseFloat(curRow.find('.purreturnweight').val())+'</td><td>'+ratepergrm+'</td><td>'+itemcost+'</td></tr>';



                if(curRow.find('.stone_details').val() != "" && curRow.find('.stone_details').val() !=undefined){



                    var st_details = JSON.parse(curRow.find('.stone_details').val());



                    if(st_details.length>0)



                    {



                         $.each(st_details, function (pkey, pitem) {



                             var stonename = "";



                             $.each(stones, function(skey, sval){



                                if(pitem.stone_id == sval.stone_id){



                                    stonename = sval.stone_name;



                                }



                             });



                             html+='<tr><td>'+stonename+'</td><td>'+parseInt(pitem.stone_pcs)+'</td><td>'+parseFloat(pitem.stone_wt)+'</td><td>'+parseFloat(pitem.stone_rate)+'</td><td>'+parseFloat(pitem.stone_price)+'</td></tr>';



                         });



                    }



                }







                if(curRow.find('.other_metal_details').val() != "" && curRow.find('.other_metal_details').val() !=undefined ){



                    var om_details = JSON.parse(curRow.find('.other_metal_details').val());



                    if(om_details.length>0)



                    {



                         $.each(om_details, function (pkey, pitem) {



                             var catname = "";



                             $.each(category_lists, function(skey, sval){



                                if(pitem.id_metal == sval.id_ret_category){



                                    catname = sval.name;



                                }



                             });



                             html+='<tr><td>'+catname+'</td><td>'+parseInt(pitem.pcs)+'</td><td>'+parseFloat(pitem.gwt)+'</td><td>'+parseFloat(pitem.rate_per_gram)+'</td><td>'+parseFloat(pitem.amount)+'</td></tr>';



                         });



                    }



                }







             }



        });



         $('#return_item_details_preview tbody').append(html);



    }else{



         $('#return_item_details_preview tbody').empty();



    }



}



function calculate_base_value_tax(taxcallrate, taxgroup){



	var totaltax = 0;



	console.log(tax_details);







	var return_details=[];



	var tax_percentage = 0;



	$.each(tax_details, function(idx, taxitem){



		if(taxitem.tgi_tgrpcode == taxgroup){



		    console.log(taxitem);



			if(taxitem.tgi_calculation == 1){



			    tax_percentage = taxitem.tax_percentage;



				if(taxitem.tgi_type == 1){



					totaltax += parseFloat(taxcallrate)	* (parseFloat(taxitem.tax_percentage)/100);



				}else{



					totaltax -= parseFloat(taxcallrate)	* (parseFloat(taxitem.tax_percentage)/100);



				}



			}



		}



	});







	return_details['totaltax'] = parseFloat(totaltax).toFixed(2);



	return_details['tax_percentage'] = tax_percentage;



	return return_details;



}



function get_non_tag_category(){



    $("div.overlay").css("display", "block");



    $('#select_product option').remove();



    $.ajax({



	type: 'POST',



	url: base_url+'index.php/admin_ret_catalog/get_NonTagProducts',



	dataType:'json',



	success:function(data){



	    non_tag_category = data;







        $.each(data, function (key, item) {



            $('#select_product').append(



            $("<option></option>")



            .attr("value", item.pro_id)



            .text(item.product_name)



            .attr("data-cat_id", item.cat_id)



            .attr("data-categoryname", item.categoryname)



            .attr("data-tgrp_id", item.tgrp_id)



            .attr("data-tax_type",item.tax_type)



            );



    	});



        	$('#select_product').select2({



        	    placeholder: "Select Product",



        	    allowClear: true



        	});











	        if($('#select_product').length)



	        {



	            $('#select_product').select2("val",'');



	        }



	        $("div.overlay").css("display", "none");



		}



	});



}



$('#other_metalmodal  #update_return_other_metal_details').on('click', function(){



	if(validate_other_metal_row())



    {



    	var metal_details=[];



    	var tot_amount=0;



    	var tot_weight=0;



    	var tot_wast_wt=0;



    	var tot_mc_value=0;



    	var catRow              =$('#custom_active_id').val();



    	var gross_wt            =($('#'+catRow).find('.gross_wt').val()!='' ? $('#'+catRow).find('.gross_wt').val():0);



    	var less_wt             =($('#'+catRow).find('.add_less_wt').val()!='' ?$('#'+catRow).find('.add_less_wt').val() :0);



    	$('#other_metalmodal .modal-body #other_metal_table> tbody  > tr').each(function(index, tr) {



    		tot_amount+=parseFloat($(this).find('.amount').val());



    		tot_weight+=parseFloat($(this).find('.gwt').val());



    		tot_wast_wt+=parseFloat($(this).find('.wast_wt').val());



    		tot_mc_value+=parseFloat($(this).find('.mc_value').val());



    		metal_details.push({



    		            'id_metal'      : $(this).find('.select_metal').val(),



    		            'id_purity'     : $(this).find('.select_purity').val(),



    		            'pcs'           : $(this).find('.pcs').val(),



    		            'gwt'           : $(this).find('.gwt').val(),



    		            'wastage_perc'  : $(this).find('.wastage_perc').val(),



    		            'calc_type'     : $(this).find('.calc_type').val(),



    		            'making_charge' : $(this).find('.making_charge').val(),



    		            'rate_per_gram' : $(this).find('.rate_per_gram').val(),



    		            'amount'        : $(this).find('.amount').val(),



    		            'wast_wt'       : $(this).find('.wast_wt').val(),



    		            'mc_value'      : $(this).find('.mc_value').val(),



    		            });



    	});



    	if(parseFloat(parseFloat(gross_wt)+parseFloat(less_wt)) < parseFloat(tot_weight))



    	{



    	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Entered Weight is Grater Than The Gross Wt."});



    	}else



    	{



    	    $('#'+catRow).find('.ret_add_other_metal_wt').val(parseFloat(tot_amount).toFixed(2));



    	    $('#'+catRow).find('.add_other_metal_wt').val(parseFloat(tot_weight).toFixed(3));



    	    $('#'+catRow).find('.other_metal_details').val(JSON.stringify(metal_details));



            $('#other_metalmodal').modal('hide');







           if(ctrl_page[1] == 'purchasereturn' && ctrl_page[2] == 'add')



           {



               //calculate_returnItem_details($('#'+catRow));



               calculate_purchase_return_item_cost();



           }







    	}



    }



    else



    {



        $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>Please Fill The Required Details"});



    }



});



//Purchase reutn end here



//GRN Entry



$("input[name='order[grn_type]']:radio").on('change',function(){



    $('.item_details').css("display","block");



    $('#grn_item_details >tbody').empty();



    var grntype = this.value;



    if(this.value == 3)



    {



        $('.item_details').css("display","none");







    }else{



        $('#grn_item_details > tbody tr').each(function(idx, row){



            curRow = $(this);



            if(grntype == 1){



                curRow.find('.wastage').val(0);



                curRow.find('.wastage').prop("readonly",true);



            }else{



                curRow.find('.wastage').prop("readonly",false);



            }



        });



    }



});



function get_cat_details()



{







    $.ajax({



	type: 'GET',



	url: base_url+'index.php/admin_ret_catalog/category/active_category',



	dataType:'json',



	success:function(data){



	        categoryDet=data;



	        console.log(categoryDet);



		}



	});



}



$('#add_item_details').on('click',function(){



        if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please select the karigar.."});



        }



        else if($('.referenceno').val()=='' || $('.referenceno').val()==null)



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please enter the reference no.."});



        }



        else if($('.referencedate').val()=='' || $('.referencedate').val()==null)



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select the Reference Date.."});



        }



    	else



    	{



    	    if(validateGrnItemDetailRow())



    	    {



    	        create_new_empty_grn_entry_row();



                showgrnentrypreview();



    	    }



    	    else



        	{



        	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Fill The Required Fields.."});



        	}



    	}



});



function validateGrnItemDetailRow()



{



    var curgrntype = $("input[name='order[grn_type]']:checked").val();



    var validate = true;



	$('#grn_item_details > tbody  > tr').each(function(index, tr) {



		if($(this).find('.category_select').val() == "" || $(this).find('.pcs').val() == ""   ){



			validate = false;



		}







		if(curgrntype==1 && ($(this).find('.rate_per_gram').val() == "" || $(this).find('.rate_per_gram').val() == 0 || $(this).find('.item_cost').val() == "" || $(this).find('.item_cost').val() == 0))



		{



		    validate = false;



		}



		if($(this).find('.ratecaltype').val()==1)



		{



		    if($(this).find('.gross_wt').val() == ""  || $(this).find('.net_wt').val() == "" )



		    {



		        validate = false;



		    }



		}



	});



	return validate;



}



function showgrnentrypreview()



{



    var html = "";



    var length  =$('#grn_item_details tbody tr').length;



    if(length > 0){



        $('#item_details_preview tbody').empty();



        $('#grn_item_details > tbody tr').each(function(idx, row){



             curRow = $(this);



             if(curRow.find('.category_select').val() != ""){



                var ratepergrm = isNaN(parseFloat(curRow.find('.rate_per_gram').val())) ? 0 : parseFloat(curRow.find('.rate_per_gram').val());



                var itemcost    = isNaN(parseFloat(curRow.find('.itemcost').val())) ? 0 : parseFloat(curRow.find('.itemcost').val());



                html+='<tr><td>'+curRow.find(".category_select option:selected" ).text()+'</td><td>'+parseInt(curRow.find('.pcs').val())+'</td><td>'+parseFloat(curRow.find('.net_wt').val())+'</td><td>'+ratepergrm+'</td><td>'+itemcost+'</td></tr>';



                if(curRow.find('.stone_details').val() != ""){



                    var st_details = JSON.parse(curRow.find('.stone_details').val());



                    if(st_details.length>0)



                    {



                         $.each(st_details, function (pkey, pitem) {



                             var stonename = "";



                             $.each(stones, function(skey, sval){



                                if(pitem.stone_id == sval.stone_id){



                                    stonename = sval.stone_name;



                                }



                             });



                             html+='<tr><td>'+stonename+'</td><td>'+parseInt(pitem.stone_pcs)+'</td><td>'+parseFloat(pitem.stone_wt)+'</td><td>'+parseFloat(pitem.stone_rate)+'</td><td>'+parseFloat(pitem.stone_price)+'</td></tr>';



                         });



                    }



                }



                if(curRow.find('.other_metal_details').val() != ""){



                    var om_details = JSON.parse(curRow.find('.other_metal_details').val());



                    if(om_details.length>0)



                    {



                         $.each(om_details, function (pkey, pitem) {



                             var catname = "";



                             $.each(category_lists, function(skey, sval){



                                if(pitem.id_metal == sval.id_ret_category){



                                    catname = sval.name;



                                }



                             });



                             html+='<tr><td>'+catname+'</td><td>'+parseInt(pitem.pcs)+'</td><td>'+parseFloat(pitem.gwt)+'</td><td>'+parseFloat(pitem.rate_per_gram)+'</td><td>'+parseFloat(pitem.amount)+'</td></tr>';



                         });



                    }



                }



             }



        });



         $('#item_details_preview tbody').append(html);



    }



}



function create_new_empty_grn_entry_row()



{



    var curgrntype = $("input[name='order[grn_type]']:checked").val();



    if(curgrntype == 1){



        var readtype = "readonly";



    }else if(curgrntype == 2){



        var readtype = "";



    }



    var html = "";



    var length  =$('#grn_item_details tbody tr').length+1;



    var category='<option value="">Select Category</option>';



    $.each(categoryDet, function (mkey, mitem) {



		category += "<option value='"+mitem.id_ret_category+"'>"+mitem.name+"</option>";



	});







    html+='<tr id="'+length+'">'



            +'<td><select class="form-control category_select" name="item[category][]" value="" style="width:100px;">'+category+'</td>'



            +'<td><input type="number" class="form-control custom-inp pcs" name="item[pcs][]" style="width:100px;" step="any" ></td>'



            +'<td><input type="number" class="form-control custom-inp gross_wt" name="item[gross_wt][]" style="width:100px;" step="any" ></td>'



            +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_less_wt" onClick="create_new_empty_est_cus_stone_item($(this).closest(\'tr\'));"  type="number" name="item[less_wt][]" step="any" readonly style="width:100px;"/><span class="input-group-addon input-sm add_tag_lwt" onClick="create_new_empty_est_cus_stone_item($(this).closest(\'tr\'));">+</span></div></div></td>'



            +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_other_metal_wt" onClick="create_new_empty_other_metal_row($(this).closest(\'tr\'));"  type="number" step="any" style="width:100px;" readonly/><span class="input-group-addon input-sm add_other_metal_wt" onClick="create_new_empty_other_metal_row($(this).closest(\'tr\'));">+</span></div></div></td>'



            +'<td><input type="number" class="form-control custom-inp net_wt" name="item[net_wt][]" style="width:100px;" step="any" readonly><input type="hidden" class="stone_details" name="item[stone_details][]"/><input type="hidden" class="other_metal_details" name="item[other_metal_details][]"/></td>'



            +'<td><input type="number" class="form-control custom-inp wastage" name="item[wastage][]" style="width:100px;" step="any" '+readtype +'></td>'



            +'<td class="input-group"><input type="number" class="form-control custom-inp rate_per_gram" name="item[rate_per_gram][]" style="width:100px;" step="any"><span class="input-group-btn" style="width: 70px;"><select class="ratecaltype form-control" name="item[rate_type][]" style="width:100px;"><option value="1" selected="selected">Grm</option><option value="2">Pcs</option></select></span></td>'



            +'<td><input type="number" class="form-control custom-inp itemcost" style="width:100px;" step="any" ><input type="hidden" class="form-control custom-inp itemcaltype" style="width:100px;" step="any" value= 1 ></td>'



            +'<td><span class="taxable_amt"></span></td>'



            +'<td><input type="hidden" name="item[item_total_tax][]" class="item_total_tax"><input type="hidden" name="item[item_cgst][]" class="item_cgst"><input type="hidden" name="item[item_sgst][]" class="item_sgst"><input type="hidden" name="item[item_igst][]" class="item_igst"><input type="hidden" name="item[tax_percentage][]" class="tax_percentage"><span class="item_tax_amt"></span></td>'



            +'<td><input type="number" class="form-control custom-inp item_cost" name="item[item_cost][]" style="width:100px;" step="any" readonly ></td>'



            +'<td><a href="#" onClick="remove_grn_item_row($(this).closest(\'tr\'));" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



           +'</tr>';



   $('#grn_item_details tbody').append(html);



   $('#grn_item_details > tbody').find('.category_select').select2();



}



$(document).on('keyup','.add_less_wt',function()



{



    var row = $(this).closest('tr');



    if((ctrl_page[1]=='grnentry' && ctrl_page[2]=='add') || ctrl_page[1]=='purchasereturn')



    {



        create_new_empty_est_cus_stone_item(row);



    }



    else if(ctrl_page[1]=='qc_issue_receipt')



    {



        create_new_empty_qc_issue_stone_item(row);



    }





});



$(document).on('keyup','.pcs,.gross_wt,.rate_per_gram,.item_cost,.wastage',function(){



    calculate_grnItem_details();



});



$(document).on('keyup','.rate_per_gram',function(){



    curRow = $(this).parent().closest('tr');



    curRow.find('.itemcaltype').val(1);



});



$(document).on('keyup','.itemcost',function(){



    curRow = $(this).parent().closest('tr');



    curRow.find('.itemcaltype').val(2);



    calculate_grnItemcost_details(curRow);



});



$(document).on('keyup', '.stone_price', function() {



    curRow = $(this).parent().closest('tr');



    var gross_wt            = (curRow.find('.stone_wt').val()=='' ? 0 :curRow.find('.stone_wt').val());



    var item_pcs            = (curRow.find('.stone_pcs').val() == '' ? 0 : curRow.find('.stone_pcs').val());



    var ratecaltype         = (curRow.find('input[type=radio]:checked').val() == '' ? 1 : curRow.find('input[type=radio]:checked').val());



    var itemcost            = isNaN(curRow.find('.stone_price').val()) ? 0 : curRow.find('.stone_price').val();







    if(itemcost > 0){



        if(ratecaltype == 1){ // cal based on net wt



            curRow.find('.stone_rate').val(parseFloat(parseFloat(parseFloat(itemcost)/parseFloat(gross_wt))).toFixed(2));



        }else{ // cal based on pcs



            curRow.find('.stone_rate').val(parseFloat(parseFloat(itemcost) / parseFloat(item_pcs)).toFixed(2));







        }



    }



});



$(document).on('keyup', '.amount', function() {



    curRow = $(this).parent().closest('tr');



    var gross_wt            = (curRow.find('.gwt').val()=='' ? 0 :curRow.find('.gwt').val());



    var item_pcs            = (curRow.find('.pcs').val() == '' ? 0 : curRow.find('.pcs').val());



    var ratecaltype         = 1; //(curRow.find('input[type=radio]:checked').val() == '' ? 1 : curRow.find('input[type=radio]:checked').val());



    var itemcost            = isNaN(curRow.find('.amount').val()) ? 0 : curRow.find('.amount').val();







    if(itemcost > 0){



        if(ratecaltype == 1){ // cal based on net wt



            curRow.find('.rate_per_gram').val(parseFloat(parseFloat(parseFloat(itemcost)/parseFloat(gross_wt))).toFixed(2));



        }else{ // cal based on pcs



            curRow.find('.rate_per_gram').val(parseFloat(parseFloat(itemcost) / parseFloat(item_pcs)).toFixed(2));







        }



    }



});



$(document).on('change', '.ratecaltype, .itemcost', function(event) {



    calculate_grnItem_details();



});



$(document).on('keydown','.itemcost',function(e){



   if (e.which == 9)



      calculate_grnItem_details();



});



function calculate_grnItemcost_details(curRow)



{



    var tot_stone_wt        = 0;



    var gross_wt            = (curRow.find('.gross_wt').val()=='' ? 0 :curRow.find('.gross_wt').val());



    var stone_details       = curRow.find('.stone_details').val();



    var other_metal_details = curRow.find('.other_metal_details').val();



    var item_pcs            = (curRow.find('.pcs').val() == '' ? 0 : curRow.find('.pcs').val());



    var ratecaltype        = (curRow.find('.ratecaltype').val() == '' ? 1 : curRow.find('.ratecaltype').val());



    var itemcost            = isNaN(curRow.find('.itemcost').val()) ? 0 : curRow.find('.itemcost').val();



    var stone_price         = 0;



    var other_metal_price   = 0;



    var other_metal_weight  = 0;







    wastage             = isNaN(curRow.find('.wastage').val())  ? 0 : curRow.find('.wastage').val();







     if(stone_details!='')



        {



            var st_details = JSON.parse(stone_details);



            if(st_details.length>0)



            {



                 $.each(st_details, function (pkey, pitem) {



                     $.each(uom_details,function(key,item){



                         if(item.uom_id==pitem.stone_uom_id)



                         {



                             if(pitem.show_in_lwt==1)



                             {



                                 if((item.uom_short_code=='CT') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                                 {



                                     stone_wt=parseFloat(parseFloat(pitem.stone_wt)/parseFloat(item.divided_by_value));



                                 }else{



                                     stone_wt=pitem.stone_wt;



                                 }



                                 tot_stone_wt+=parseFloat(stone_wt);



                             }







                             stone_price+=parseFloat(pitem.stone_price);



                         }



                     });











                 });



            }



        }







        if(other_metal_details!='')



        {



            var other_met_details = JSON.parse(other_metal_details);



            if(other_met_details.length > 0)



            {



                $.each(other_met_details, function (pkey, pitem) {



                    other_metal_price+=parseFloat(pitem.amount);



                    other_metal_weight+=parseFloat(pitem.gwt);



                });



            }



        }



        var less_wt         =  tot_stone_wt;



        net_wt              =  parseFloat(parseFloat(gross_wt) - parseFloat(less_wt)- parseFloat(other_metal_weight)).toFixed(3);



        var wastage             = isNaN(parseFloat(curRow.find('.wastage').val()))  ? 0 : parseFloat(curRow.find('.wastage').val()).toFixed(3);



        if(ratecaltype == 1){ // cal based on net wt



            //curRow.find('.rate_per_gram').val(parseInt(parseFloat(parseFloat(itemcost)/parseFloat(net_wt)) * 100) / 100);



            curRow.find('.rate_per_gram').val(parseFloat(parseFloat(parseFloat(itemcost)/(parseFloat(net_wt) + parseFloat(wastage)))).toFixed(2));







        }else{ // cal based on pcs



            //curRow.find('.rate_per_gram').val(parseInt(parseFloat(itemcost) / parseFloat(item_pcs) * 100) / 100 );



            curRow.find('.rate_per_gram').val(parseFloat(parseFloat(itemcost) / parseFloat(item_pcs)).toFixed(2));



        }



    //calculate_grnItem_details();



}



function calculate_grnItem_details()



{



    var grn_type            = $("input[name='order[grn_type]']:checked").val();



    var cmp_country         = $('#cmp_country').val();



    var cmp_state           = $('#cmp_state').val();



    var supplier_country    = '';



    var supplier_state      = '';



    var tcspercent          = 0;



    var tdspercent          = 0;



    console.log(karigar_details);



    $.each(karigar_details,function(k,val){



        if(val.id_karigar == $('#select_karigar').val())



        {



            supplier_country=val.id_country;



            supplier_state=val.id_state;



            var tcs_percent = $('#tcs_percent').val();



            var tds_percent = $('#tds_percent').val();



            if(tcs_percent=='')



            {



                $('#tcs_percent').val(val.tcs_tax);



            }



            if(tds_percent=='')



            {



                $('#tds_percent').val(val.tds_tax);



            }



        }



    });



    $('#supplier_country').val(supplier_country);



    $('#supplier_state').val(supplier_state);



    $('#grn_item_details > tbody tr').each(function(idx, row){



        curRow = $(this);



        var tot_stone_wt        = 0;



        var gross_wt            = (curRow.find('.gross_wt').val()=='' ? 0 :curRow.find('.gross_wt').val());



        var stone_details       = curRow.find('.stone_details').val();



        var other_metal_details = curRow.find('.other_metal_details').val();



        var net_wt              = 0;



        var taxable_amt         = 0;



        var item_cost           = 0;



        var stone_price         = 0;



        var other_metal_price   = 0;



        var other_metal_weight  = 0;



        var item_tax_amt        = 0;



        var tax_percentage      = 0;



        var wastage             = 0;







        var rate_per_gram       = (curRow.find('.rate_per_gram').val()=='' ? 0 :curRow.find('.rate_per_gram').val());



        var ratecaltype         = (curRow.find('.ratecaltype').val() == '' ? 1 : curRow.find('.ratecaltype').val());



        var item_pcs            = (curRow.find('.pcs').val() == '' ? 0 : curRow.find('.pcs').val());



        var tax_group_id        = '';



        var item_igst           = 0;



        var item_sgst           = 0;



        var item_cgst           = 0;



        if(stone_details!='')



        {



            var st_details = JSON.parse(stone_details);



            if(st_details.length>0)



            {



                 $.each(st_details, function (pkey, pitem) {



                     $.each(uom_details,function(key,item){



                         if(item.uom_id==pitem.stone_uom_id)



                         {



                             if(pitem.show_in_lwt==1)



                             {



                                 if((item.uom_short_code=='CT') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                                 {



                                     stone_wt=parseFloat(parseFloat(pitem.stone_wt)/parseFloat(item.divided_by_value));



                                 }else{



                                     stone_wt=pitem.stone_wt;



                                 }



                                 tot_stone_wt+=parseFloat(stone_wt);



                             }







                             stone_price+=parseFloat(pitem.stone_price);



                         }



                     });











                 });



            }



        }







        if(other_metal_details!='')



        {



            var other_met_details = JSON.parse(other_metal_details);



            if(other_met_details.length > 0)



            {



                $.each(other_met_details, function (pkey, pitem) {



                    other_metal_price+=parseFloat(pitem.amount);



                    other_metal_weight+=parseFloat(pitem.gwt);



                });



            }



        }







        $.each(categoryDet, function (mkey, mitem) {



            if(mitem.id_ret_category==curRow.find('.category_select').val())



            {



                tax_group_id=mitem.tgrp_id;



            }



        });







        var less_wt         =  tot_stone_wt;



        wastage             = isNaN(parseFloat(curRow.find('.wastage').val()))  ? 0 : parseFloat(curRow.find('.wastage').val()).toFixed(3);



        net_wt              =  parseFloat(parseFloat(gross_wt) - parseFloat(less_wt)- parseFloat(other_metal_weight)).toFixed(3);



        if(ratecaltype == 1){



            if(curRow.find('.itemcaltype').val() == 1){



                var calnet_wt         = parseFloat(net_wt) + parseFloat(wastage);



                curRow.find('.itemcost').val(parseFloat(parseFloat((parseFloat(calnet_wt))*parseFloat(rate_per_gram))).toFixed(2));



                taxable_amt           =  parseFloat(parseFloat(parseFloat(calnet_wt)*parseFloat(rate_per_gram))+parseFloat(stone_price)+parseFloat(other_metal_price)).toFixed(2);



            }else{



                taxable_amt           =  parseFloat(parseFloat(curRow.find('.itemcost').val())+parseFloat(stone_price)+parseFloat(other_metal_price)).toFixed(2);



            }







        }else{



            if(curRow.find('.itemcaltype').val() == 1){



                curRow.find('.itemcost').val(parseFloat(parseFloat(item_pcs)*parseFloat(rate_per_gram)).toFixed(2));



                taxable_amt           =  parseFloat(parseFloat(parseFloat(item_pcs)*parseFloat(rate_per_gram))+parseFloat(stone_price)+parseFloat(other_metal_price)).toFixed(2);



            }else{



                taxable_amt           =  parseFloat(parseFloat(curRow.find('.itemcost').val())+parseFloat(stone_price)+parseFloat(other_metal_price)).toFixed(2);



            }







        }



        var tax_details     = calculate_base_value_tax(taxable_amt, tax_group_id)







        if(grn_type==1) // No tax Need for Receipts



        {



            item_tax_amt    =  tax_details['totaltax'];



            tax_percentage  =  tax_details['tax_percentage'];



        }







		var item_cost       =  parseFloat(parseFloat(taxable_amt)+parseFloat(item_tax_amt)).toFixed(2);







		if(cmp_country=='' || cmp_state=='')



		{



		    item_sgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



		    item_cgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



		}



		else



		{



		    if(item_tax_amt > 0)



		    {



		        if(cmp_country==supplier_country)



    		    {



    		        if(cmp_state==supplier_state)



    		        {



    		            item_sgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



    		            item_cgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



    		        }else



    		        {



    		            item_igst = item_tax_amt;



    		        }



    		    }else



    		    {



    		        item_sgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



    		        item_cgst = parseFloat(parseFloat(item_tax_amt)/2).toFixed(2);



    		    }



		    }







		}







		curRow.find('.add_less_wt').val(parseFloat(tot_stone_wt).toFixed(3));



		curRow.find('.net_wt').val(parseFloat(net_wt).toFixed(3));



		curRow.find('.item_cost').val(parseFloat(item_cost).toFixed(2));



		curRow.find('.taxable_amt').html(parseFloat(taxable_amt).toFixed(2));



		curRow.find('.item_tax_amt').html(parseFloat(item_tax_amt).toFixed(2));



		curRow.find('.item_total_tax').val(parseFloat(item_tax_amt).toFixed(2));



		curRow.find('.item_cgst').val(parseFloat(item_cgst).toFixed(2));



		curRow.find('.item_sgst').val(parseFloat(item_sgst).toFixed(2));



		curRow.find('.item_igst').val(parseFloat(item_igst).toFixed(2));



		curRow.find('.tax_percentage').val(parseFloat(tax_percentage).toFixed(2));







        console.log('gross_wt:'+gross_wt);



        console.log('net_wt:'+net_wt);



        console.log('less_wt:'+less_wt);



        console.log('stone_price:'+stone_price);



        console.log('other_metal_price:'+other_metal_price);



    });







    calculate_grn_final_cost();



}



$(document).on('keyup', '.grn_discount', function (){



    calculate_grn_payment_cost();



});



$(document).on('change', '.grn_round_off', function (){



    var final_cost  = $('.grn_total_cost').val();



    var grn_round_off                   = (isNaN($('.grn_round_off').val()) || $('.grn_round_off').val()=='' ? 0:$('.grn_round_off').val());



    var round_off_symbol                = $('.round_off_symbol').val();







    if(grn_round_off > 0)



    {



        if(round_off_symbol==1) // Add to Final cost



        {



            final_cost = parseFloat(final_cost)+parseFloat(grn_round_off);



        }else



        {



            final_cost = parseFloat(final_cost)-parseFloat(grn_round_off);



        }



        $('.grn_total_cost').val(parseFloat(final_cost).toFixed(2));



    }else



    {



        calculate_grn_payment_cost();



    }



});



function calculate_grn_final_cost()



{



     var total_item_cost = 0;



     var total_bill_amount = 0;



     var total_taxable_amount = 0;



     var total_cgst_amount = 0;



     var total_sgst_amount = 0;



     var total_igst_amount = 0;







    var cmp_country         = $('#cmp_country').val();



    var cmp_state           = $('#cmp_state').val();



    var supplier_country    = $('#supplier_country').val();



    var supplier_state      = $('#supplier_state').val();







    var tcsval = 0;



    var tdsval = 0;



    var other_charges_tdsval = 0;



    var tcspercent =(isNaN($('#tcs_percent').val()) || $('#tcs_percent').val()=='' ? 0:$('#tcs_percent').val());



    var tdspercent =(isNaN($('#tds_percent').val()) || $('#tds_percent').val()=='' ? 0:$('#tds_percent').val());



    var charges_tds_percent =(isNaN($('#charges_tds_percent').val()) || $('#charges_tds_percent').val()=='' ? 0:$('#charges_tds_percent').val());







    var other_charges_details = $('#other_charges_details').val();



    var charges_details       = [];



    if(other_charges_details!='')



    {



        var charges_details = JSON.parse($('#other_charges_details').val());



    }







    var total_charges_taxable_amount    = 0;



    var total_charges_tax_amount        = 0;



    var total_charges_amount            = 0;



    if(charges_details.length > 0)



    {



        $.each(charges_details,function(k,val){



           total_charges_amount+=parseFloat(val.char_with_tax);



           total_charges_taxable_amount+=parseFloat(val.charge_value);



           total_charges_tax_amount+=parseFloat(val.charge_tax_value);



        });



    }







     $('#grn_item_details > tbody tr').each(function(idx, row){



         curRow = $(this);



         total_item_cost    += parseFloat(curRow.find('.item_cost').val());



         total_cgst_amount  += parseFloat(curRow.find('.item_cgst').val());



         total_sgst_amount  += parseFloat(curRow.find('.item_sgst').val());



         total_igst_amount  += parseFloat(curRow.find('.item_igst').val());



         total_taxable_amount  += parseFloat((curRow.find('.item_cost').val())-(curRow.find('.item_total_tax').val()));



     });







     var tot_discount           = (isNaN($('.grn_discount').val()) || $('.grn_discount').val()=='' ? 0:$('.grn_discount').val());



     var other_charges_amount   = (isNaN($('#other_charges_amount').val()) || $('#other_charges_amount').val()=='' ? 0:$('#other_charges_amount').val());



     $('.total_summary_taxable_amt').val(parseFloat(total_taxable_amount).toFixed(2));



     $('.total_summary_cgst_amount').val(parseFloat(total_cgst_amount).toFixed(2));



     $('.total_summary_sgst_amount').val(parseFloat(total_sgst_amount).toFixed(2));



     $('.total_summary_igst_amount').val(parseFloat(total_igst_amount).toFixed(2));







     $('#other_charges_taxable_amount').val(parseFloat(total_charges_taxable_amount).toFixed(2));



     $('#other_charges_tax').val(parseFloat(total_charges_tax_amount).toFixed(2));







    if(total_charges_tax_amount > 0)



    {



        var other_charges_igst = 0;



        var other_charges_sgst = 0;



        var other_charges_cgst = 0;



        if(cmp_country==supplier_country)



	    {



	        if(cmp_state==supplier_state)



	        {



	            other_charges_cgst = parseFloat(parseFloat(total_charges_tax_amount)/2).toFixed(2);



	            other_charges_sgst = parseFloat(parseFloat(total_charges_tax_amount)/2).toFixed(2);



	        }else



	        {



	            other_charges_igst = total_charges_tax_amount;



	        }



	    }else



	    {



	        other_charges_cgst = parseFloat(parseFloat(total_charges_tax_amount)/2).toFixed(2);



	        other_charges_sgst = parseFloat(parseFloat(total_charges_tax_amount)/2).toFixed(2);



	    }



	    $('.other_charges_cgst').html(parseFloat(other_charges_cgst).toFixed(2));



        $('.other_charges_sgst').html(parseFloat(other_charges_sgst).toFixed(2));



        $('.other_charges_igst').html(parseFloat(other_charges_igst).toFixed(2));



    }























    if(tdspercent > 0){



        tdsval = parseFloat(parseFloat(total_taxable_amount) * (tdspercent / 100)).toFixed(2);



    }



    console.log('tdsval:'+tdsval);



    $("#item_tds_tax_value").val(tdsval);







    if(tcspercent > 0){



        tcsval = parseFloat(parseFloat(total_item_cost) * (tcspercent / 100)).toFixed(2);



    }



    $("#item_tcs_tax_value").val(tcsval);







    if(charges_tds_percent > 0)



    {



        other_charges_tdsval = parseFloat(parseFloat(total_charges_taxable_amount) * (charges_tds_percent / 100)).toFixed(2);



    }



    $("#other_charges_tds_tax_value").val(other_charges_tdsval);



     calculate_grn_payment_cost();







}



function calculate_grn_payment_cost()



{



    var total_summary_taxable_amt       = (isNaN($('.total_summary_taxable_amt').val()) || $('.total_summary_taxable_amt').val()=='' ? 0:$('.total_summary_taxable_amt').val());



    var tds_tax_value                   = (isNaN($('.item_tds_tax_value').val()) || $('.item_tds_tax_value').val()=='' ? 0:$('.item_tds_tax_value').val());



    var total_summary_cgst_amount       = (isNaN($('.total_summary_cgst_amount').val()) || $('.total_summary_cgst_amount').val()=='' ? 0:$('.total_summary_cgst_amount').val());



    var total_summary_sgst_amount       = (isNaN($('.total_summary_sgst_amount').val()) || $('.total_summary_sgst_amount').val()=='' ? 0:$('.total_summary_sgst_amount').val());



    var total_summary_igst_amount       = (isNaN($('.total_summary_igst_amount').val()) || $('.total_summary_igst_amount').val()=='' ? 0:$('.total_summary_igst_amount').val());



    var tcs_tax_value                   = (isNaN($('.item_tcs_tax_value').val()) || $('.item_tcs_tax_value').val()=='' ? 0:$('.item_tcs_tax_value').val());



    var other_charges_tds_tax_value     = (isNaN($('.other_charges_tds_tax_value').val()) || $('.other_charges_tds_tax_value').val()=='' ? 0:$('.other_charges_tds_tax_value').val());



    var other_charges_taxable_amount    = (isNaN($('#other_charges_taxable_amount').val()) || $('#other_charges_taxable_amount').val()=='' ? 0:$('#other_charges_taxable_amount').val());



    var other_charges_tax               = (isNaN($('#other_charges_tax').val()) || $('#other_charges_tax').val()=='' ? 0:$('#other_charges_tax').val());



    var grn_discount                    = (isNaN($('.grn_discount').val()) || $('.grn_discount').val()=='' ? 0:$('.grn_discount').val());



    var final_cost                      = parseFloat(parseFloat(total_summary_taxable_amt)-parseFloat(tds_tax_value)+parseFloat(total_summary_cgst_amount)+parseFloat(total_summary_sgst_amount)+parseFloat(total_summary_igst_amount)+parseFloat(tcs_tax_value)+parseFloat(other_charges_taxable_amount)-parseFloat(other_charges_tds_tax_value)+parseFloat(other_charges_tax)-parseFloat(grn_discount)).toFixed(2)











     round_of_val               = final_cost;



     tot_cost 			        = parseFloat(Math.round(final_cost));



	 round_of_amt               = parseFloat(tot_cost-round_of_val).toFixed(2);



	 $('.grn_round_off').val(round_of_amt<0.50 ? (round_of_amt < 0 ? (round_of_amt*-1) :round_of_amt) : (round_of_amt < 0 ? (round_of_amt*-1) :round_of_amt));



	 $('.round_off_symbol').val(round_of_amt<0 ? 0 : 1);







     $('.grn_total_cost').val(parseFloat(tot_cost).toFixed(2));



     console.log('total_summary_taxable_amt:'+total_summary_taxable_amt);



     console.log('tds_tax_value:'+tds_tax_value);



     console.log('total_summary_cgst_amount:'+total_summary_cgst_amount);



     console.log('total_summary_sgst_amount:'+total_summary_sgst_amount);



     console.log('total_summary_igst_amount:'+total_summary_igst_amount);



     console.log('tcs_tax_value:'+tcs_tax_value);



     console.log('other_charges_tds_tax_value:'+other_charges_tds_tax_value);



     console.log('other_charges_taxable_amount:'+other_charges_taxable_amount);



     console.log('other_charges_tax:'+other_charges_tax);



     console.log('grn_discount:'+grn_discount);



     console.log();



     showgrnentrypreview();



}



function remove_grn_item_row(curRow)

{

    curRow.remove();

    calculate_grnItem_details();

}



$(document).on('change','.show_in_lwt',function(){



   if($(this).is(":checked"))



   {



       $(this).closest('tr').find('.show_in_lwt').val(1);



   }



   else



   {



       $(this).closest('tr').find('.show_in_lwt').val(0);



   }



});



$('#cus_stoneModal  #update_grn_stn_details').on('click', function(){



	if(validateStoneCusItemDetailRow())



	{



    	var stone_details       =[];



    	var stone_price         =0;



    	var tot_stone_wt   = 0;

        

    	var certification_price =0;



    	var catRow              =$('#custom_active_id').val();



    	var gross_wt            =$('#'+catRow).find('.gross_wt').val();



    	$('#cus_stoneModal .modal-body #estimation_stone_cus_item_details > tbody  > tr').each(function(index, tr) {



    		stone_price+=parseFloat($(this).find('.stone_price').val());



    		/*$.each(uom_details,function(key,item){



                if($(this).find('.stone_id').val()==item.uom_id)



                {



                     if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                     {



                         stone_wt+=parseFloat(parseFloat($(this).find('.stone_wt').val())/parseFloat(item.divided_by_value));



                     }else{



                         stone_wt+=parseFloat($(this).find('.stone_wt').val());



                     }



                }



            });*/



        		stone_details.push({



        		            'show_in_lwt'       : $(this).find('.show_in_lwt').val(),



        		            'stone_id'          : $(this).find('.stone_id').val(),



        		            'stones_type'       : $(this).find('.stones_type').val(),



        		            'stone_pcs'         : $(this).find('.stone_pcs').val(),



        		            'stone_wt'          : $(this).find('.stone_wt').val(),



        		            'stone_cal_type'    : $(this).find('input[type=radio]:checked').val(),



        		            'stone_price'       : $(this).find('.stone_price').val(),



        		            'stone_rate'        : $(this).find('.stone_rate').val(),



        		            'stone_type'        : $(this).find('.stone_type').val(),



        		            'stone_uom_id'      : $(this).find('.stone_uom_id').val(),



                            'stone_quality_id'  : $(this).find('.quality_id').val(),



        		});



    	});



        if(stone_details.length>0)

        {

            $.each(stone_details, function (pkey, pitem) 

            {

                $.each(uom_details,function(key,item)

                {

                    var stone_wt=0;

                    if(item.uom_id==pitem.stone_uom_id)

                    {

                        if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram

                        {

                            stone_wt=parseFloat(parseFloat(pitem.stone_wt)/parseFloat(item.divided_by_value));



                        }else{



                            stone_wt=pitem.stone_wt;



                        }



                        tot_stone_wt+=parseFloat(stone_wt);

                    }



                });



            });

        }



    	if(parseFloat(gross_wt)<parseFloat(tot_stone_wt))



    	{



    	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Entered Weight is Grater Than The Gross Wt."});



    	}



    	else



    	{



            $('#cus_stoneModal').modal('toggle');



            $('#'+catRow).find('.stone_details').val(JSON.stringify(stone_details));



            var row = $('.'+catRow).closest('tr');



            $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').empty();



    	}



    }



    else



    {



    	$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Fill The Required Fields.."});



    }



    calculate_grnItem_details();



});



function validate_grn_entry_form()



{



        var grn_type = $("input[name='order[grn_type]']:checked").val();



        var form_validate = true;



        if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select The Karigar.."});



            form_validate = false;



        }



        else if(($('.referenceno').val()=='' || $('.referenceno').val()==null) )



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enter The Invoice No.."});



            form_validate = false;



        }



        else if(($('.referencedate').val()=='' || $('.referencedate').val()==null) )



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select The Ref Date.."});



            form_validate = false;



        }



        else if((grn_type==1 || grn_type==2) && ($('#grn_item_details > tbody tr').length==0))



        {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found.."});



                form_validate = false;



        }



        else if((grn_type==3) && ($('#other_charges_taxable_amount').val()==0 || $('#other_charges_taxable_amount').val()==''))



        {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records Found.."});



                form_validate = false;



        }



        else if(!validateGrnItemDetailRow())



        {



             $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Fill The Required Fields.."});



             form_validate = false;



        }







        return form_validate;



}



$('#submit_grn_entry').on('click',function(){







    if(validate_grn_entry_form())



    {



        $('#submit_grn_entry').prop('disabled',true);



        $("div.overlay").css("display", "block");





        var form_data = $('#grn_entry_form').serializeArray();

        var tag_img = $('#tag_img').attr("data-img");



        //var form_data=$('#grn_entry_form').serialize();



        /*var dataObject = {};



        // Add form_data to the object

        form_data.forEach(function(item) {

            dataObject[item.name] = item.value;

        });

        



        // Add tag_img to the object

        dataObject['tag_img'] = tag_img;*/



        if($('#grn_id').val()!='')



    	{



    	    var url=base_url+ "index.php/admin_ret_purchase/grnentry/update?nocache=" + my_Date.getUTCSeconds();



    	}else



    	{



            var url=base_url+ "index.php/admin_ret_purchase/grnentry/save?nocache=" + my_Date.getUTCSeconds();



    	}



    	my_Date = new Date();



        $.ajax({



            url:url,



            data: form_data,



            type:"POST",



            dataType:"JSON",



            success:function(data){



    			if(data.status)



    			{



    			    $("div.overlay").css("display", "none");



    			}



    		    window.location.href= base_url+'index.php/admin_ret_purchase/grnentry/list';



            },



            error:function(error)



            {



                $("div.overlay").css("display", "none");



            }



        });



    }











});



function get_grn_entry_list(from_date,to_date)



{



    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



			 url:base_url+ "index.php/admin_ret_purchase/grnentry?nocache=" + my_Date.getUTCSeconds(),



			 dataType:"JSON",



			 type:"POST",



			 data:{'from_date': from_date, 'to_date': to_date},



			 success:function(data){



			 	var list=data.list;



			 	var profile=data.profile;



			 	var access=data.access;





                 var currentDate = new Date();



                 var formattedCurrentDate =

                   currentDate.getDate().toString().padStart(2, '0') + '-' +

                   (currentDate.getMonth() + 1).toString().padStart(2, '0') + '-' +

                   currentDate.getFullYear();



				var oTable = $('#grn_list').DataTable();



				oTable.clear().draw();



				if (list!= null && list.length > 0)



				{



					oTable = $('#grn_list').dataTable({



                    "bDestroy": true,



                    "bInfo": true,



                    "bFilter": true,



                    "bSort": true,



                    "order": [[ 0, "desc" ]],



                    "dom": 'lBfrtip',



                    "buttons" : ['excel','print'],



                    "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



                    "aaData": list,



                    "aoColumns": [



                    { "mDataProp": "grn_id" },



                    { "mDataProp": "grn_ref_no" },



                    {

                        "mDataProp": function (row, type, val, meta) {



                            if(row.image_details[0]!='' && row.image_details[0]!=null){



                                var img_src=base_url+'assets/img/grn_entry/'+row.image_details[0].image;



                            }

                             else

                            {

                                 var img_src = base_url+'assets/img/no_image.png';



                            }

                            // var image = "<img  class='img_src' id='img_prev' src="+img_src+"  width='35' height='35' onClick=tag_imgprev($(this).closest('tr')) ></img>"

                            var image =  '<img src='+img_src+' width="50" height="55"><br><a  class="btn btn-secondary order_img"  id="edit" data-toggle="modal" data-id='+row.grn_id+'><i class="fa fa-eye" ></i></a>'



                            return  image;

                        }

                    },





                    { "mDataProp": "grn_date" },



                    { "mDataProp": "karigar_name" },



                    { "mDataProp": "mobile" },



                    { "mDataProp": "grn_supplier_ref_no" },



                    { "mDataProp": "grn_ref_date" },



                    { "mDataProp": "grn_purchase_amt" },



                    { "mDataProp": "billstatus" },



                    { "mDataProp": function ( row, type, val, meta ) {



                    id= row.grn_id;



                    print_url=base_url+'index.php/admin_ret_purchase/grn_invoice/'+id;



                    edit_url=(access.edit=='1' && (row.grn_bill_status==1 && row.is_approved == 0) ? '<a href="'+base_url+'index.php/admin_ret_purchase/grnentry/edit/'+id+'" class="btn btn-primary btn-edit"><i class="fa fa-edit" ></i></a>' : '' );





                    delete_url=(access.delete=='1' && (row.grn_bill_status==1 && row.is_approved == 0) ? '<button class="btn btn-warning" onclick="confirm_delete('+id+')"><i class="fa fa-close" ></i></button>' :'');





                    billcancel_url=(access.edit=='1' ? base_url+'index.php/admin_ret_billing/billing/cancell/'+id : '#' );



                    action_content=edit_url+''+'<a href="'+print_url+'" target="_blank" class="btn btn-info btn-print" data-toggle="tooltip" title="Vendor acknowledgement "><i class="fa fa-print" ></i></a>'+delete_url;



                    console.log(row.grn_date == formattedCurrentDate);



                    return action_content;



                    }



                    },







                    ]



                    });







				}



				$("div.overlay").css("display", "none");



			  },



			  error:function(error)



			  {



				 $("div.overlay").css("display", "none");



			  }



	      });



}



$('#rate_fix_approve').on('click', function () {



	if ($("input[name='rate_fix_id[]']:checked").val()) {



		$('#rate_fix_approve').prop('disabled', true);



		var selected = [];



		$("#payment_list tbody tr").each(function (index, value) {



			if ($(value).find("input[name='rate_fix_id[]']:checked").is(":checked")) {



				transData = {



					'rate_fix_id': $(value).find(".rate_fix_id").val(),



				}



                // alert(transData);



				selected.push(transData);



			}



		})



		req_data = selected;



		update_ratefix_approval(req_data);



	}



	else {



		$.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>" + 'Please Select Any one..' });



		$('#rate_fix_approve').prop('disabled', false);



	}



});



function update_ratefix_approval(req_data){



$.ajax({



    type: 'POST',



    data: {'req_data': req_data},



    url: base_url + "index.php/admin_ret_purchase/update_ratefix_approval",



    dataType: 'JSON',



    success: function(data){



        if (data.status) {



			$.toaster({ priority: 'success', title: 'Warning!', message: '' + "</br>" + data.message });



		} else {



			$.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>" + data.message });



		}



		location.reload();



		$("div.overlay").css("display", "none");



	},



	error: function (error) {



		console.log(error);



		$("div.overlay").css("display", "none");



	}



    });



}



function get_rate_fix_entry_list()



{



    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



			 url:base_url+ "index.php/admin_ret_purchase/rate_fixing?nocache=" + my_Date.getUTCSeconds(),



			 dataType:"JSON",



			 type:"POST",



			 data:{'from_date': $('#rf_date1').html(), 'to_date': $('#rf_date2').html()},



			 success:function(data){



			 	var list = data.list;



			 	var access = data.access;



				var oTable = $('#payment_list').DataTable();



				oTable.clear().draw();



				if (list!= null && list.length > 0)



				{



					oTable = $('#payment_list').dataTable({



                    "bDestroy": true,



                    "bInfo": true,



                    "bFilter": true,



                    "bSort": true,



                    "order": [[ 0, "desc" ]],



                    "dom": 'lBfrtip',



                    "buttons" : ['excel','print'],



                    "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



                    "aaData": list,



                    "aoColumns": [



                    {



                        "mDataProp": function (row, type, val, meta) {



                            if(row.is_approved==true || row.bill_status==2)





                            {



                                chekbox =  row.rate_fix_id;



                            }



                            else



                            {



                                chekbox = '<input type="checkbox" class="rate_fix_id" name="rate_fix_id[]" value="'+ row.rate_fix_id +'" />' +'&nbsp;'+ row.rate_fix_id;



                            }



                            return chekbox;



                        }



                    },



                    { "mDataProp": "po_ref_no" },



                    { "mDataProp": "karigar" },



                    { "mDataProp": "rate_fix_wt" },



                    { "mDataProp": "rate_fix_rate" },



                    { "mDataProp": "total_amount" },



                    { "mDataProp": "approve_status" },



                    { "mDataProp": "billed_status" },





                    { "mDataProp": function ( row, type, val, meta ) {



                        id= row.rate_fix_id;



                        action_content='<a href="'+base_url+'index.php/admin_ret_purchase/rate_fixing/job_receipt/'+id+'" target="_blank" class="btn btn-info btn-print" data-toggle="tooltip" title="" data-original-title="Customer Copy"><i class="fa fa-print"></i></a>'+(row.is_approved==0 && row.bill_status==1 && access.delete =='1' ? '<button class="btn btn-warning" onclick="confirm_ratefix_cancel('+id+')"><i class="fa fa-close" ></i></button>' :'')+'';



                        return action_content;



                        }



                    }



                    ]



                    });







				}



				$("div.overlay").css("display", "none");



			  },



			  error:function(error)



			  {



				 $("div.overlay").css("display", "none");



			  }



	      });



}



function get_approval_rate_fix_entry_list()



{



    $("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



			 url:base_url+ "index.php/admin_ret_purchase/rate_fixing/approval_rate_fix_list?nocache=" + my_Date.getUTCSeconds(),



			 dataType:"JSON",



			 type:"POST",



			 data:{'from_date': $('#rf_date1').html(), 'to_date': $('#rf_date2').html()},



			 success:function(data){



			 	var list = data.list;



			 	var access = data.access;



				var oTable = $('#payment_list').DataTable();



				oTable.clear().draw();



				if (list!= null && list.length > 0)



				{



					oTable = $('#payment_list').dataTable({



                    "bDestroy": true,



                    "bInfo": true,



                    "bFilter": true,



                    "bSort": true,



                    "order": [[ 0, "desc" ]],



                    "dom": 'lBfrtip',



                    "buttons" : ['excel','print'],



                    "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },



                    "aaData": list,



                    "aoColumns": [



                    {



                        "mDataProp": function (row, type, val, meta) {



                            if(row.is_approved==true)



                            {



                                chekbox =  row.rate_fix_id;



                            }



                            else



                            {



                                chekbox = '<input type="checkbox" class="rate_fix_id" name="rate_fix_id[]" value="'+ row.rate_fix_id +'" />' +'&nbsp;'+ row.rate_fix_id;



                            }



                            return chekbox;



                        }



                    },



                    { "mDataProp": "po_ref_no" },



                    { "mDataProp": "karigar" },



                    { "mDataProp": "rate_fix_wt" },



                    { "mDataProp": "rate_fix_rate" },



                    { "mDataProp": "total_amount" },



                    { "mDataProp": "approve_status" },



                    { "mDataProp": function ( row, type, val, meta ) {



                        id= row.rate_fix_id;



                        action_content='<a href="'+base_url+'index.php/admin_ret_purchase/rate_fixing/job_receipt/'+id+'" target="_blank" class="btn btn-info btn-print" data-toggle="tooltip" title="" data-original-title="Customer Copy"><i class="fa fa-print"></i></a>'+(row.is_approved==0 && row.bill_status==1 && access.delete =='1' ? '<button class="btn btn-warning" onclick="confirm_ratefix_cancel('+id+')"><i class="fa fa-close" ></i></button>' :'')+'';



                        return action_content;



                        }



                    }



                    ]



                    });







				}



				$("div.overlay").css("display", "none");



			  },



			  error:function(error)



			  {



				 $("div.overlay").css("display", "none");



			  }



	      });



}



function confirm_ratefix_cancel(ratefix_id)



{



	$('#ratefix_id').val(ratefix_id);



	$('#confirm-billcancell').modal('show');



}



$('#ratefix_cancel_remark').on('keypress',function(){



	if(this.value.length>6)



	{



		$('#ratefix_cancel').prop('disabled',false);



	}else{



		$('#ratefix_cancel').prop('disabled',true);



	}



});



$('#ratefix_cancel').on('click',function(){



    $('#ratefix_cancel').prop('disabled',true);



	my_Date = new Date();



	$.ajax({



		type: 'POST',



		url:base_url+ "index.php/admin_ret_purchase/rate_fixing/cancel?nocache=" + my_Date.getUTCSeconds(),



		dataType:'json',



		data:{'cancel_reason':$('#ratefix_cancel_remark').val(),'ratefix_id':$('#ratefix_id').val()},



		success:function(data){



		    window.location.reload();



		}



	});



});



function confirm_delete(bill_id,bill_cancel_otp)



{



	$('#grn_id').val(bill_id);



	$('#confirm-delete').modal('show');



}



$('#cancel_remark').on('keypress',function(){



	if(this.value.length>6)



	{



		$('#grn_cancel').prop('disabled',false);



	}else{



		$('#grn_cancel').prop('disabled',true);



	}



});



$('#grn_cancel').on('click',function(){



    $('#grn_cancel').prop('disabled',true);



	my_Date = new Date();



	$.ajax({



		type: 'POST',



		url:base_url+ "index.php/admin_ret_purchase/grnentry/cancel_grn_entry?nocache=" + my_Date.getUTCSeconds(),



		dataType:'json',



		data:{'cancel_reason':$('#cancel_remark').val(),'grn_id':$('#grn_id').val()},



		success:function(data){



		    window.location.reload();



		}



	});



});



$('#other_metalmodal  #update_grn_other_metal_details').on('click', function(){



	if(validate_other_metal_row())



    {



    	var metal_details=[];



    	var tot_amount=0;



    	var tot_weight=0;



    	var tot_wast_wt=0;



    	var tot_mc_value=0;



    	var catRow              =$('#custom_active_id').val();



    	var gross_wt            =($('#'+catRow).find('.gross_wt').val()!='' ? $('#'+catRow).find('.gross_wt').val():0);



    	var less_wt             =($('#'+catRow).find('.add_less_wt').val()!='' ?$('#'+catRow).find('.add_less_wt').val() :0);



    	$('#other_metalmodal .modal-body #other_metal_table> tbody  > tr').each(function(index, tr) {



    		tot_amount+=parseFloat($(this).find('.amount').val());



    		tot_weight+=parseFloat($(this).find('.gwt').val());



    		tot_wast_wt+=parseFloat($(this).find('.wast_wt').val());



    		tot_mc_value+=parseFloat($(this).find('.mc_value').val());



    		metal_details.push({



    		            'id_metal'      : $(this).find('.select_metal').val(),



    		            'id_purity'     : $(this).find('.select_purity').val(),



    		            'pcs'           : $(this).find('.pcs').val(),



    		            'gwt'           : $(this).find('.gwt').val(),



    		            'wastage_perc'  : $(this).find('.wastage_perc').val(),



    		            'calc_type'     : $(this).find('.calc_type').val(),



    		            'making_charge' : $(this).find('.making_charge').val(),



    		            'rate_per_gram' : $(this).find('.rate_per_gram').val(),



    		            'amount'        : $(this).find('.amount').val(),



    		            'wast_wt'       : $(this).find('.wast_wt').val(),



    		            'mc_value'      : $(this).find('.mc_value').val(),



    		            });



    	});



    	if(parseFloat(parseFloat(gross_wt)+parseFloat(less_wt)) < parseFloat(tot_weight))



    	{



    	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Entered Weight is Grater Than The Gross Wt."});



    	}else



    	{







    	    $('#'+catRow).find('.add_other_metal_wt').val(parseFloat(tot_weight).toFixed(3));



    	    $('#'+catRow).find('.other_metal_details').val(JSON.stringify(metal_details));



            $('#other_metalmodal').modal('hide');



            calculate_grnItem_details();



    	}



    }



    else



    {



        $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>Please Fill The Required Details"});



    }



});



function getActive_quality_code()



{



    $('#uom option').remove();



    $('#ed_uom option').remove();



    $.ajax({



    type: 'GET',



    url: base_url+'index.php/admin_ret_catalog/get_quality_code',



    dataType:'json',



    success:function(data)



        {



			quality_code =data;

            var id = $('#select_quality').val();

            $.each(data, function (key, item) {

                $("#select_quality").append(

                $("<option></option>")

                .attr("value", item.quality_id)

                .text(item.code)

                );

            });

            $("#select_quality").select2(

            {

                placeholder:"Select Quality",

                closeOnSelect: true

            });

            if($("#select_quality").length)

            {

                $("#select_quality").select2("val",(id!='' && id>0? id:(id!='' && id!=undefined ? id :'')));

            }



            $(".overlay").css("display", "none");



        }



    });



}



function get_ActiveGRNS(){







	$.ajax({



	type: 'POST',



	url: base_url+'index.php/admin_ret_purchase/purchase/active_grns',



	dataType:'json',



	data:{'po_id':(ctrl_page[3]!='' && ctrl_page[3]!=undefined ? ctrl_page[3] :'')},



	success:function(data){



	    activeGRNS = data;



	    var id=$('#select_grn').val();



	    var id_grn= $('#id_grn').val();



		$.each(data, function (key, item) {



		    $("#select_grn").append(



		    $("<option></option>")



		    .attr("value", item.grn_id)



		    .text(item.grn_ref_no)



		    );



		});



		$("#select_grn").select2(



		{



			placeholder:"Select GRN",



			closeOnSelect: true



		});



		if($("#select_grn").length)



		{



		    $("#select_grn").select2("val",(id!='' && id>0? id:(id_grn!='' && id_grn!=undefined ? id_grn :'')));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



$('#select_grn').on('change',function(){



   var currentgrn = this.value;



   $("#select_karigar").prop("disabled", false);



   $('#grn_item_details_preview > tbdoy').empty();



   var trHtml = '';



   if(currentgrn != '')



   {



       $("div.overlay").css("display", "block");



       var url  = base_url+ "index.php/admin_ret_purchase/purchase/grncatdetailsbygrnid?nocache=" + my_Date.getUTCSeconds();



    	my_Date = new Date();



        $.ajax({



            url:url,



            data: {"grnId" : currentgrn,"cat_type":$("input[type='radio'][name='order[po_type]']:checked").val()},



            type:"POST",



            dataType:"JSON",



            success:function(data){







                $.each(activeGRNS, function (gkey, gitem) {



                    if(parseInt(gitem.grn_id) === parseInt(currentgrn)){



                        $("#select_karigar").select2("val", gitem.grn_karigar_id);



                        $("#select_karigar").prop("disabled", true);



                        $("#id_karigar").val(gitem.grn_karigar_id);



                        $(".po_irnno").val(gitem.grn_irnno != null ? gitem.grn_irnno : "");



                        $(".ewaybillno").val(gitem.grn_ewaybillno);



                        $(".po_ref_no").val(gitem.grn_supplier_ref_no);



                        $(".po_ref_date").val(gitem.grn_ref_date != null ? gitem.grn_ref_date : "");



                        $('#despatch_through').select2("val",gitem.grn_despatch_through);



                        var tds_purchase_limit =  $('#tds_purchase_limit').val();



                        var item_cost =  $('#opening_balance').val();



                        var total_balance_amount = item_cost;



                        if(tds_purchase_limit >= total_balance_amount)

                         {

                         $('#bal_tds_percent').val(gitem.grn_pay_tds_percent);

                         }

                        else

                        {

                        $('#bal_tds_percent').val(0);

                        }



                        // $('#po_tds_percent').val(gitem.grn_pay_tds_percent);



                        $('#po_tcs_percent').val(gitem.grn_tcs_percent);



                        $('#other_charges_taxable_amount').val(parseFloat(gitem.charges_amount).toFixed(2));



                        $('#charges_tds_percent').val(gitem.grn_other_charges_tds_percent);



                        $('#other_charges_tax').val(gitem.charges_tax);



                        $('#po_discount').val(gitem.grn_discount);



                        if(gitem.grn_type==2)



                        {



                            $('#approval_stock_yes').prop('checked',true);



                            $('#is_rate_fixed_no').prop('checked',true);



                        }



                        else



                        {



                            $('#approval_stock_no').prop('checked',true);



                            $('#is_rate_fixed_yes').prop('checked',true);



                        }







                        console.log(data);



                        $('#grn_item_details_preview > tbody').empty();



                        $.each(data,function(key,val){



                            trHtml+='<tr>'



                                +'<td>'+val.catname+'</td>'



                                +'<td class="grn_pcs">'+val.no_of_pcs+'</td>'



                                +'<td class="grn_gwt">'+val.gross_wt+'</td>'



                                +'<td class="grn_lwt">'+val.grn_less_wt+'</td>'



                                +'<td class="grn_nwt">'+val.grn_net_wt+'</td>'



                                +'<td class="grn_diawt">'+val.dia_wt+'</td>'



                                +'<td class="grn_rate">'+val.rate_per_grm+'</td>'



                                +'<td class="grn_amt">'+val.item_cost+'</td>'



                                +'</tr>';



                        });







                    }



                });



                console.log(trHtml);



                if(ctrl_page[2]=='purchase_add' && ctrl_page[3]==undefined)

                {

                    if (data.length > 0) {

                    let grn_tds_percent = data[0].grn_tds_percent;

                    $(".po_tds_percent").val(parseFloat(grn_tds_percent).toFixed(2));

                    } else {

                        $(".po_tds_percent").val(0);

                    }

                }



                $('#select_category option').remove();



                $('#grn_item_details_preview > tbody').append(trHtml);



                $.each(data, function (key, item) {







                    $("#select_category").append(



            		    $("<option></option>")



            		    .attr("value", item.cat_id)



            		    .attr("data-cattype", item.cat_type)



            		    .text(item.catname)



        		    );



                });



            	$('#select_category').select2({



            	    placeholder: "Category",



            	    allowClear: true



            	});



            	 $("#select_category").select2("val","");



    			$("div.overlay").css("display", "none");



    		    grncatdetails = data;



            },



            error:function(error)



            {



                $("div.overlay").css("display", "none");



            }



        });



   }



});





function Edit_ItemDetails(curRow)



{



    curRow.remove();







        $('#select_po_no').select2("val",curRow.find('.po_order_no').val());



        $('#select_category').select2("val", curRow.find('.id_category').val());



        $('#select_purity').select2("val", curRow.find('.id_purity').val());



        $('#select_product').select2("val", curRow.find('.id_product').val());



        $('#select_design').select2("val", curRow.find('.id_design').val());



        $('#select_sub_design').select2("val", curRow.find('.id_sub_design').val());



        $('#purchase_mode').val(curRow.find('.ratecaltype').val());







        $('#id_purity').val(curRow.find('.id_purity').val());



        $('#pro_id').val(curRow.find('.id_product').val());



        $('#design_id').val(curRow.find('.id_design').val());



        $('#sub_design_id').val(curRow.find('.id_sub_design').val());



        $('#tot_pcs').val(curRow.find('.tot_pcs').val());







        $('#tot_gwt').val(curRow.find('.tot_gwt').val());



        $('#tot_lwt').val(curRow.find('.tot_lwt').val());



        $('#tot_nwt').val(curRow.find('.tot_nwt').val());



        $('#tot_purewt').val(curRow.find('.tot_purewt').val());







        $('#stone_details').val(curRow.find('.stone_details').val());



        $('#stone_price').val(curRow.find('.stone_price').val());







        $('#mc_type').val(curRow.find('.mc_type').val());







        $('#mc_value').val(curRow.find('.mc_value').val());



        $('#tot_wastage_perc').val(curRow.find('.tot_wastage_perc').val());



        $('#other_metal_amount').val(curRow.find('.other_metal_amt').val());



        $('#other_metal_details').val(curRow.find('.other_metal_details').val());



        $('#other_charges_details').val(curRow.find('.other_chrg_details').val());







        $('#rate_per_gram').val(curRow.find('.rate_per_gram').val());



        $('#total_payable_amt').val(curRow.find('.item_cost').val());



        $('#po_item_id').val(curRow.find('.po_item_id').val());



        $('#item_remarks').val(curRow.find('.item_remarks').val());



        $('#purchase_touch').val(curRow.find('.purchase_touch').val());



        $('#karigar_calc_type').val(curRow.find('.pur_calc_type').val());



        $('#item_remarks').val(curRow.find('.item_remarks').val());



    	modalStoneDetail = ($('#stone_details').val()!='' ? JSON.parse($('#stone_details').val()) : '');



        modalOthermetal = ($('#other_metal_details').val()!='' ? JSON.parse($('#other_metal_details').val()) : '');



        modalChargeDetail = ($('#other_charges_details').val()!='' ? JSON.parse($('#other_charges_details').val()) : '');



        if($('#supplier_bill_entry_calc').val()==1)

        {

            set_karigar_wise_wastage();

        }





        calculate_purchase_order_item_total();



        setTimeout(function(){calculate_purchase_item_cost()},3000);



}



//GRN Entry



//supplier edit



$('#edit_karigar').on('click',function(){



    if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select Supplier"});



    }



    else



    {



        $('#confirm-edit').modal('show');



         $.ajax({



            type: "POST",



            url: base_url + "index.php/admin_ret_purchase/get_karigar_details",



            dataType: "JSON",



            data: {"karId": $('#select_karigar').val()},



            success: function(data){



                            $('#id_karigar').val(data.id_karigar);



                            $('#kar_first_name').val(data.karigar_name);



                            $('#kar_pan_no').val(data.pan_no);



                            $('#gst_no').val(data.gst_number);



                            $('#address1').val(data.address1);



                            $('#address2').val(data.address2);



                            $('#address3').val(data.address3);



                            $('#pin_code_add').val(data.pincode);



                            $('#ed_id_city').val(data.id_city);



                            $('#ed_id_state').val(data.id_state);



                            $('#id_country').val(data.id_country);



                            get_country();



            }



        });



    }











});



$('#country').on('change',function(){



    $('#id_country').val(this.value);



    if(this.value!='')



    {



        get_state(this.value);



    }







});



$('#ed_state').on('change',function(){



    $('#ed_id_state').val(this.value);



    if(this.value!='')



    {



        get_city(this.value);



    }



});



$('#ed_city').on('change',function(){



    if(this.value!='')



    {



        $('#ed_id_city').val(this.value);



    }



});



$("#update_kardetails").on('click',function(){







	if($('#kar_first_name').val() == null || $('#kar_first_name').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter Karigar Name"});



	}



	else if($('#kar_pan_no').val() == null || $('#kar_pan_no').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter PAN no"});



	}



	else if($('#country').val() == null || $('#country').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Country"});



	}



	else if($('#ed_state').val() == null || $('#ed_state').val() == '')



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select State"});



	}



	else if(($('#ed_city').val() == null || $('#ed_city').val() == '') && (order_for==1))



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select City"});



	}



	else if(($('#address1').val() == 0 || $('#address1').val() == '') )



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter Address 1"});



	}



    else if(($('#address2').val() == 0 || $('#address2').val() == '') )



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter Address 2 "});



	}



    else if(($('#address3').val() == 0 || $('#address3').val() == '') )



	{



		$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter Address 3"});



	}



	else if(($('#pin_code_add').val() == null || $('#pin_code_add').val() == ''))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter PINCODE"});



    }



    else if(($('#gst_no').val() == null || $('#gst_no').val() == ''))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Enter GST no"});



    }



	else



	{



	    update_karigar();



        $('#confirm-edit').modal('hide');



	}



});



function update_karigar(){



   var id_karigar = $('#id_karigar').val();



   var first_name =  $('#kar_first_name').val();



   var pan_no =  $('#kar_pan_no').val();



   var gst_no =  $('#gst_no').val();



   var address1 =  $('#address1').val();



   var address2 =  $('#address2').val();



   var address3 =  $('#address3').val();



   var pin_code_add =  $('#pin_code_add').val();



   var id_city =  $('#ed_id_city').val();



   var id_state =  $('#ed_id_state').val();



   var id_country =  $('#id_country').val();



   $.ajax({



       type: "POST",



       dataType: "JSON",



       data: {"id_karigar":id_karigar,"first_name":first_name ,"pan_no":pan_no , "gst_no":gst_no ,"address1":address1,"address2" :address2 ,"address3" :address3,"pin_code_add":pin_code_add,"id_city":id_city,



       "id_state": id_state,"id_country" :id_country},



       url: base_url + "index.php/admin_ret_purchase/update_karigar",



       success: function(data){



               $.toaster({ priority : data.priority, title : data.title, message : ''+"</br>"+data.msg});



               $("div.overlay").css("display", "none");



   }



   })



}



function get_country()



{



    $('#country option').remove();



    $.ajax({



        type: 'GET',



        url:  base_url+'index.php/settings/company/getcountry',



        dataType: 'json',



        success: function(country) {







            $.each(country, function (key, country)



            {







                $('#country').append(



                $("<option></option>")



                .attr("value", country.id)



                .text(country.name)



                );







            });



            var id_country=$('#id_country').val();



            var ed_id_country=$('#ed_id_country').val();







           $("#country").select2({



            placeholder: "Enter Country",



            allowClear: true



            });



            if($("#country").length)



            {



                $("#country").select2("val",(id_country!='' ? id_country:''));



            }



        },



        error:function(error)



        {







         }



    });



}



function get_state(id)



{



    $('#ed_state option').remove();



    $.ajax({



        type: 'POST',



        data:{'id_country':id },



        url:  base_url+'index.php/settings/company/getstate',



        dataType: 'json',



        success: function(state) {



            console.log($('#ed_id_state').val());







        $.each(state, function (key, state) {







            $('#state,#ed_state').append(



            $("<option></option>")



            .attr("value", state.id)



            .text(state.name)



            );



        });



         var id_state=$('#id_state').val();







         var ed_id_state=$('#ed_id_state').val();



         $("#state,#ed_state").select2({



            placeholder: "Enter State",



            allowClear: true



        });







        if($("#state").length)



        {



            $("#state").select2("val",(id_state!='' ? id_state:''));



        }







        if($("#ed_state").length)



        {



            $("#ed_state").select2("val",(ed_id_state!=null && ed_id_state>0 ? ed_id_state:''));



        }







        },



        error:function(error)



        {



        }



    });



}



function get_city(id)



{



    $('#city option').remove();



    $('#ed_city option').remove();



    $.ajax({



        type: 'POST',



        data:{'id_state':id },



        url:  base_url+'index.php/settings/company/getcity',



        dataType: 'json',



        success: function(city) {



        var id_city=$('#id_city').val();



        var ed_id_city=$('#ed_id_city').val();



        $.each(city, function (key, city) {



            $('#city,#ed_city').append(



            $("<option></option>")



            .attr("value", city.id)



            .text(city.name)



            );



        });







        $('#city,#ed_city').select2({



			placeholder: "Enter city",



			allowClear: true



		});







		if($("#city").length)



		{



		    $("#city").select2("val", (id_city!=null? id_city :''));



		}







		if($("#ed_city").length)



		{



		    $("#ed_city").select2("val",(ed_id_city!=null && ed_id_city>0 ? ed_id_city:''));



		}







        },



        error:function(error)



        {







        }



    });



}



$('#kar_pan_no').on('change',function(){



    if($("#kar_pan_no").val() != ""){



        var regexp = /^[a-zA-Z]{5}\d{4}[a-zA-Z]{1}$/;



        if(!regexp.test($("#kar_pan_no").val()))



        {



             $("#kar_pan_no").val("");



             $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Enter valid PAN No..'});



             $("#kar_pan_no").focus();



        }



    }else{







        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Enter valid PAN No..'});



    }



});



$('#pin_code_add').on('blur',function(){



    if(this.value.length==6)



    {



        $('#pin_code_add').val(this.value);



    }



    else{



         $.toaster({priority : 'danger',title:'warning!',message:''+"</br>"+'Please enter Valid Number..'});



         $('#pin_code_add').val('');



         $('#pin_code_add').focus();



    }



 });



 $('#gst_no').on('change',function(){



    var reggst = /^([0][1-9]|[1-2][0-9]|[3][0-7])([a-zA-Z]{5}[0-9]{4}[a-zA-Z]{1}[1-9a-zA-Z]{1}[zZ]{1}[0-9])+$/;



    if(!reggst.test($('#gst_no').val()))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Enter the Valid GST No..'});



        $('#gst_no').val('');



        return false;



    }



});



//supplier edit



//approval stock tag



$('#approval_bill_search').click(function(event) {



	get_approval_stock_tag_list();



});



function get_approval_stock_tag_list()



{



	my_Date = new Date();



	$("div.overlay").css("display", "block");



	$.ajax({



		 url:base_url+"index.php/admin_ret_purchase/approvalstock_tag/ajax?nocache=" + my_Date.getUTCSeconds(),



		 dataType:"JSON",



		 data:{'dt_range' :$("#dt_range").val(),'bill_no':$('#filter_bill_no').val(),'order_status':$('#order_status').val()},



		 type:"POST",



		 success:function(data){



			console.log("List", data);



   			set_approval_stock_tag_list(data);



   			$("div.overlay").css("display", "none");



		  },



		  error:function(error)



		  {



			 $("div.overlay").css("display", "none");



		  }



	});



}



function set_approval_stock_tag_list(data)



{



    $("div.overlay").css("display", "none");



    var billing = data.list;



    var access = data.access;



    var profile = data.profile;



    var oTable = $('#approval_billing_list').DataTable();



    $("#total_billing").text(billing.length);







    oTable.clear().draw();



    if (billing!= null && billing.length > 0)



    {



        oTable = $('#approval_billing_list').dataTable({



        "bDestroy": true,



        "bInfo": true,



        "bFilter": true,



        "bSort": true,



        "order": [[ 0, "desc" ]],



        "dom": 'lBfrtip',



        "buttons": [



					 {



					   extend: 'print',



					   footer: true,



					   title: "Billing",



					   customize: function ( win ) {



							$(win.document.body).find( 'table' )



								.addClass( 'compact' )



								.css( 'font-size', 'inherit' );



						},



					 },



					 {



						extend:'excel',



						footer: true,



					    title: "Approval Bills",



					  }



					 ],



		"aaData": billing,



        "aoColumns": [



            { "mDataProp": function ( row, type, val, meta ) {



                if(row.order_status==3)



                {



                    return row.tag_code;



                }



                else if(row.order_status==5)



                {



                    if(row.is_approval_stock_converted==0)



                    {



                        return '<input type="checkbox" class="approval_tags"  name="approva[tag_id][]" value="'+row.tag_id+'" /><input type="hidden"  class="id_karigar"  value="'+row.po_karigar_id+'" />' + row.tag_code;



                    }else{



                        return row.tag_code;



                    }



                }



                else



                {



                    if(row.tag_status==0){



                    return '<input type="checkbox" class="approval_tags"  name="approva[tag_id][]" value="'+row.tag_id+'" /><input type="hidden"  class="id_karigar"  value="'+row.po_karigar_id+'" />' + row.tag_code;



                    }else{



                        return row.tag_code;



                    }



                }







            }},



            { "mDataProp": "po_ref_no" },



            { "mDataProp": "podate" },



            { "mDataProp": "current_branchname" },



            { "mDataProp": "gross_wt" },



            { "mDataProp": "net_wt" },



            { "mDataProp": function ( row, type, val, meta ) {



                return row.suppliername;



            }},







            { "mDataProp": "order_no" },



            { "mDataProp": "statusmessage" },



            { "mDataProp": "converted_date" },



        ]



        });



    }



}



function get_order_status()



{



    my_Date = new Date();



	$.ajax({



		type: 'GET',



		url: base_url+'index.php/admin_ret_reports/order_status/order_status?nocache='+my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



		dataType:'json',



		success:function(data){



			var id =  $("#order_status").val();



		   $.each(data,function (key, item) {



		       if(item.id_order_msg==3 || item.id_order_msg==5 || item.id_order_msg==0)



		       {



                    $('#order_status').append(



                    $("<option></option>")



                    .attr("value", item.id_order_msg)



                    .text(item.order_status)



                    );



		       }



			});



			$('#order_status').select2("val",0);



		}



	});



}



$('#order_status').on('change',function(){



    $('.create_order').css("display","none");



    $('.update_order').css("display","none");



    if(this.value!='')



    {



        get_approval_stock_tag_list();



        if(this.value==0)



        {



            $('.create_order').css("display","block");



            $('.update_order').css("display","none");



        }



        else if(this.value==5)



        {



            $('.update_order').css("display","block");



        }



    }



});



$('#order_place').on('click',function(){



        if($("input[name='approva[tag_id][]']:checked").val())



         {



               $('#order_place').prop('disabled',true);



               $(".overlay").css("display", "block");



    			var selected_data = [];







    			var deleteids_arr = [];



    			$("#approval_billing_list tbody tr").each(function(index, value)



    			{



        			if($(value).find("input:checkbox[class=approval_tags]:checked").is(":checked"))



        			{



        			    if($(value).find(".approval_tags").val()!='' && $(value).find(".id_karigar").val()!='')



        			    {



        			         transData = {



                    			'tag_id'        : $(value).find(".approval_tags").val(),



                    			'id_karigar'    : $(value).find(".id_karigar").val(),



                			}



                			selected_data.push(transData);



        			    }



        			    else



        			    {



        			        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Supplier or Tag Not Found'});



        			    }



        			}



    			});



    			if(selected_data.length > 0)



    			{



    			    order_place(selected_data);



    			}



         }



         else



         {



             $('#order_place').prop('disabled',false);



             $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please Select Any One Item'});



         }







});



function order_place(req_data)



{



        my_Date = new Date();



        $(".overlay").css("display", "block");



        $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/order_place?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data:  {'req_data':req_data},



        type:"POST",



        dataType: "json",



        async:false,



        success:function(data){



        location.reload(true);



        $(".overlay").css("display", "none");



        },



        error:function(error)



        {



        console.log(error);



        $(".overlay").css("display", "none");



        }



        });



 }



$('#convert_to_normal_stock').on('click',function(){



        if($("input[name='approva[tag_id][]']:checked").val())



         {



               $('#convert_to_normal_stock').prop('disabled',true);



               $(".overlay").css("display", "block");



    			var selected_data = [];







    			var deleteids_arr = [];



    			$("#approval_billing_list tbody tr").each(function(index, value)



    			{



        			if($(value).find("input:checkbox[class=approval_tags]:checked").is(":checked"))



        			{



        			    if($(value).find(".approval_tags").val()!='' && $(value).find(".id_karigar").val()!='')



        			    {



        			         transData = {



                    			'tag_id'        : $(value).find(".approval_tags").val(),



                    			'id_karigar'    : $(value).find(".id_karigar").val(),



                			}



                			selected_data.push(transData);



        			    }



        			    else



        			    {



        			        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Supplier or Tag Not Found'});



        			    }



        			}



    			});



    			if(selected_data.length > 0)



    			{



    			    convert_to_normal_stock(selected_data);



    			}



         }



         else



         {



             $('#convert_to_normal_stock').prop('disabled',false);



             $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please Select Any One Item'});



         }







});



function convert_to_normal_stock(req_data)



{



        my_Date = new Date();



        $(".overlay").css("display", "block");



        $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/convert_to_normal_stock?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data:  {'req_data':req_data},



        type:"POST",



        dataType: "json",



        async:false,



        success:function(data){



        location.reload(true);



        $(".overlay").css("display", "none");



        },



        error:function(error)



        {



        console.log(error);



        $(".overlay").css("display", "none");



        }



        });



 }



//approval stock tag



function set_karigar_wise_charges($id_karigar)



{



    var charge_values=0;







    $.each(karigar_charges_details,function(key,items){







        console.log('id_karigar',$id_karigar);



        console.log('charges_id_karigar',items.id_karigar);



        if($id_karigar==items.id_karigar)



        {



            charge_values+=parseFloat(items.charge_value);



            console.log('charge_value',charge_values);



            $('#other_charges_taxable_amount').val(charge_values);



        }



    });



}



//Lot generate



function get_qc_receipt_po()



{



    $(".overlay").css('display','block');



	$.ajax({



		type: 'GET',



		url: base_url+'index.php/admin_ret_purchase/get_po_balance',



		dataType:'json',



		success:function(data){



            var po_id =  $('#select_po_ref_no').val();



            po_itemdetails=data;







            $.each(data, function (key, item) {



                $('#select_po_ref_no').append(



                $("<option></option>")



                .attr("value", item.po_id)



                .attr("data-ishallmarked", item.is_po_halmarked)



                .text(item.po_ref_no)



                );



            });







            $("#select_po_ref_no").select2({



                placeholder: "Select PO Ref No",



                allowClear: true



            });







            $("#select_po_ref_no").select2("val",(po_id!='' && po_id>0?po_id:''));



            $(".overlay").css("display", "none");



		}



	});



}



function set_lot_generate_items()



{



        $(".overlay").css("display", "block");



        my_Date = new Date();



		$.ajax({



		url:base_url+ "index.php/admin_ret_purchase/get_po_balance_details?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



        data: {'po_id':$('#select_po_ref_no').val(),'fin_year':$('#pur_fin_year_select').val(),'ishallmarked' :$('#select_po_ref_no option:selected').attr('data-ishallmarked')},



        type:"POST",   



        dataType:"JSON",



        success:function(data)



        {



                $('#item_detail tbody').empty();



                var rowExists=false;



                var trHtml='';



                $.each(data,function(key,items){



                    /*$('#item_detail > tbody tr').each(function(bidx, brow){



                        curRow = $(this);



                        if(curRow.find('.id_qc_issue_details').val()==items.id_qc_issue_details)



                        {



                            rowExists=true;



                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                        }



                    });*/







                    var select_section = "";



                    if(items.stktype==2){



                        $.each(section_details, function (key, sec_item) {



                            var selected_section = sec_item.id_section == items.id_section ? "selected" : "";



                            select_section += "<option value='" + sec_item.id_section + "' " + selected_section + ">" + sec_item.section_name + "</option>";



                        });



                    }



                    if(!rowExists)



                    {



                        var other_metal_weight = 0;



                        $.each(items.other_metal_details,function(k,val)

                        {

                            other_metal_weight+=parseFloat(val.po_other_mt_wt);

                        })





                        var id = parseFloat($('#item_detail > tbody  > tr').length+1)



                        trHtml='<tr class="'+id+'" id="'+id+'">'



                        +'<td><input type="checkbox" class="qc_item_select" name="items[qc_item_select][]" value="1" checked/><input type="hidden" class="po_item_id" name="items[po_item_id][]" value="'+items.po_item_id+'" /><input type="hidden" class="id_qc_issue_details" name="items[id_qc_issue_details][]" value="'+items.id_qc_issue_details+'" /><input type="hidden" class="cat_id" name="items[cat_id][]" value="'+items.cat_id+'" /><input type="hidden" class="id_purity" name="items[id_purity][]" value="'+items.id_purity+'" /><input type="hidden" class="stock_type" name="items[stock_type][]" value="'+items.stktype+'" />'+items.po_ref_no+'</td>'



                        +'<td>'+items.po_ref_no+'</td>'



                        +'<td>'+items.emp_name+'</td>'







                        + '<td><select class="id_section" name="items[id_section][]" value="" placeholder="Search Section" style="width:150px;" '+(items.stktype == 1? 'disabled' : '')+' >' + select_section + '</select></td>'



                        +'<td>'+items.product_name+'<input type="hidden" class="pro_id" name="items[pro_id][]" value="'+items.pro_id+'"/></td>'



                        +'<td>'+items.design_name+'<input type="hidden" class="id_design" name="items[id_design][]" value="'+items.po_item_des_id+'"/></td>'



                        +'<td>'+items.sub_design_name+'<input type="hidden" class="id_sub_design" name="items[id_sub_design][]" value="'+items.po_item_sub_des_id+'"/></td>'



                        +'<td><input type="number" class="form-control lot_pcs" name="items[pcs][]" value="'+items.pcs+'" style="width:100px;" /><input type="hidden" class="lot_act_pcs" value="'+items.pcs+'" /></td>'



                        +'<td><input type="number" class="form-control lot_gross_wt" name="gross_wt[]" value="'+items.gross_wt+'" style="width:100px;" /><input type="hidden" class="lot_act_gross_wt" value="'+items.gross_wt+'" /></td>'



                        /*+'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_less_wt" value="'+ parseFloat(items.less_wt).toFixed(3) +'" onClick="create_lgt_item($(this).closest(\'tr\'));"  type="number" step="any" readonly /><span class="input-group-addon input-sm add_tag_lwt" onClick="create_lgt_item($(this).closest(\'tr\'));">+</span></div><input type="hidden" class="stone_details" value=\''+JSON.stringify(items.stone_details)+'\'></div></td>'*/



                        +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_less_wt" value="'+parseFloat(items.less_wt).toFixed(3)+'" onClick="create_lgt_item($(this).closest(\'tr\'));"  type="number" step="any" style="width:100px;" readonly/><span class="input-group-addon input-sm add_lgt" onClick="create_lgt_item($(this).closest(\'tr\'));">+</span><input type="hidden" class="stone_details" name="items[stone_details][]" value=\''+JSON.stringify(items.stone_details)+'\' ></div></div></td>'



                        +'<td><input type="number" class="form-control lot_net_wt" name="items[net_wt][]" value="'+parseFloat((parseFloat(items.gross_wt)-parseFloat(items.less_wt)-parseFloat(other_metal_weight))).toFixed(3)+'" style="width:100px;" readonly/><input type="hidden" class="lot_act_net_wt" value="'+parseFloat((parseFloat(items.gross_wt)-parseFloat(items.less_wt)-parseFloat(other_metal_weight))).toFixed(3)+'" /></td>'



                        +'<td><a href="#" onClick="remove_qc_item($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



                        +'</tr>';





                    	$('#item_detail > tbody').find('.id_section').select2();



                    	$('#item_detail > tbody').find('.id_section').select2({



                    	    placeholder: "Select Section",



                    	    allowClear: true



                    	});



                        //$('#item_detail > tbody').find('.id_section').select2("val","");



                        if($('#item_detail > tbody  > tr').length>0)



                        {



                            $('#item_detail > tbody > tr:first').before(trHtml);



                        }else{



                            $('#item_detail tbody').append(trHtml);



                        }



                    }



                });











                calculate_qu_issue_row_details();



                //$('#select_po_ref_no').val("");



         	    $(".overlay").css("display", "none");



        },



        error:function(error)



        {



        }



    	});











    $(".overlay").css("display", "none");



}





$(document).on('keyup','.lot_pcs',function(){

    var curRow = $(this).closest('tr');

    var lot_pcs = curRow.find('.lot_pcs').val();

    var lot_act_pcs = curRow.find('.lot_act_pcs').val();

    if(parseFloat(lot_pcs)>parseFloat(lot_act_pcs)){

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please Enther the Valid Pcs..'});

         curRow.find('.lot_pcs').val(lot_act_pcs);

    }

    calculate_lot_generate_row();

});



$(document).on('keyup','.lot_gross_wt',function(){

    var curRow = $(this).closest('tr');

    var lot_gross_wt = curRow.find('.lot_gross_wt').val();

    var lot_act_gross_wt = curRow.find('.lot_act_gross_wt').val();

    if(parseFloat(lot_gross_wt)>parseFloat(lot_act_gross_wt)){

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please Enther the Valid Gross weight..'});

         curRow.find('.lot_gross_wt').val(lot_act_gross_wt);

    }

    calculate_lot_generate_row();

});



function calculate_lot_generate_row()

{

    $('#item_detail > tbody tr').each(function(idx, row){

        curRow  = $(this);

        var gross_wt = curRow.find('.lot_gross_wt').val();

        var lesswt = curRow.find('.add_less_wt').val();

        var net_wt = parseFloat(parseFloat(gross_wt)-parseFloat(lesswt)).toFixed(3);

        curRow.find('.lot_net_wt').val(net_wt);

    });

}



function create_lgt_item(curRow,id)



{



    $('#lgt_stoneModal').modal('show');



    $('#lgt_cus_item_details tbody').empty();



    if(curRow!=undefined)



    {



    $('#stone_active_id').val(curRow.closest('tr').attr('id'));



    }



    var trHtml = "";



    var catRow=$('#stone_active_id').val();



   //alert(catRow);



    var row_st_details=$('#'+catRow).find('.stone_details').val();



    if(row_st_details !='' && row_st_details != '[]' && curRow != undefined)



    {



    var stone_details   = JSON.parse(row_st_details);



    var stone_name = '';



    var stone_type = '';



    $.each(stone_details,function(key,val){



        $.each(stones,function(k,itm){

            if(val.po_stone_id==itm.stone_id)

            {

                stone_name = itm.stone_name;

            }

        });



        $.each(stone_types,function(k,itm){

            if(val.stone_type==itm.id_stone_type)

            {

                stone_type = itm.stone_type;

            }

        });

        var uom_list = '';

        $.each(uom_details, function (pkey, item) {

    	     var uom_selected = "";

    	    if(item.uom_id == val.uom_id)

    		{

    			uom_selected = "selected='selected'";

    		}

    		uom_list += "<option value='"+item.uom_id+"' "+uom_selected+">"+item.uom_name+"</option>";

    	});



        trHtml+='<tr>'



                    + '<td><input type="hidden" class="po_stone_calc_based_on" value="'+val.po_stone_calc_based_on+'" /><input type="hidden" class="po_stone_rate" value="'+val.po_stone_rate+'" /><input type="hidden" class="is_apply_in_lwt" value="'+val.is_apply_in_lwt+'" /><input type="hidden" class="stone_type" value="'+val.stone_type+'" />' + stone_type +'</td>'



                    + '<td><input type="hidden" class="po_stone_id" value="'+val.po_stone_id+'" /><input type="hidden" class="po_quality_id" value="'+val.po_quality_id+'" />' + stone_name + '</td>'



                    + '<td><input type="number" class="form-control qc_passed_stn_pcs" value="'+val.qc_passed_pcs+'" style="width:100px;" /><input type="hidden" class="act_blc_stn_pcs" value="'+val.act_blc_stn_pcs+'" /></td>'



                    +'<td><div class="input-group"><input class="qc_passed_stn_wt form-control" type="number" value="'+val.qc_passed_wt+'" style="width:70px;" /><input type="hidden" class="act_blc_stn_wt"  value="'+val.act_blc_stn_wt+'"><span class="input-group-btn" style="width: 70px;"><select class="uom_id form-control" style="width: 70px;">'+uom_list+'</select></span></div></td>'



                    +'<td><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td></tr>';



                +'</tr>';



    });







    $('#lgt_cus_item_details tbody').append(trHtml);



    total_stone_amount();



  }



}



$(document).on('keyup','.qc_passed_stn_pcs',function(){

    var curRow = $(this).closest('tr');

    var qc_passed_stn_pcs = curRow.find('.qc_passed_stn_pcs').val();

    var act_blc_stn_pcs = curRow.find('.act_blc_stn_pcs').val();

    if(parseFloat(qc_passed_stn_pcs)>parseFloat(act_blc_stn_pcs)){

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please Enther the Valid Pcs..'});

         curRow.find('.qc_passed_stn_pcs').val(act_blc_stn_pcs);

    }

    total_stone_amount();

});



$(document).on('keyup','.qc_passed_stn_wt',function(){

    var curRow = $(this).closest('tr');

    var qc_passed_stn_wt = curRow.find('.qc_passed_stn_wt').val();

    var act_blc_stn_wt = curRow.find('.act_blc_stn_wt').val();

    if(parseFloat(qc_passed_stn_wt)>parseFloat(act_blc_stn_wt)){

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please Enther the Valid weight..'});

         curRow.find('.qc_passed_stn_wt').val(act_blc_stn_wt);

    }

    total_stone_amount();

});



function total_stone_amount()

{

    var tot_pcs   = 0;

    var tot_wt    = 0;

    $('#lgt_cus_item_details > tbody tr').each(function(idx, row){

        curRow = $(this);

        tot_pcs+= parseFloat((isNaN(curRow.find('.qc_passed_stn_pcs').val()) || curRow.find('.qc_passed_stn_pcs').val() == '')  ? 0 : curRow.find('.qc_passed_stn_pcs').val());

        tot_wt +=parseFloat((isNaN(curRow.find('.qc_passed_stn_wt').val()) || curRow.find('.qc_passed_stn_wt').val() == '')  ? 0 : curRow.find('.qc_passed_stn_wt').val());

    });

    $('.ps_tot_pcs').html(parseFloat(tot_pcs));

    $('.ps_tot_wt').html(parseFloat(tot_wt).toFixed(3));

}



$('#lgt_stoneModal  #save_lot_stone_details').on('click', function(){



    	var stone_details=[];

    	var tot_stone_wt  = 0;



    	$('#lgt_stoneModal .modal-body #lgt_cus_item_details> tbody  > tr').each(function(index, tr) {

    	    if($(this).find('.is_apply_in_lwt').val()==1)

    	    {

    	        if($(this).find('.stone_type').val()==1)

                {

                    tot_stone_wt+=parseFloat($(this).find('.qc_passed_stn_wt').val()/5);

                }else{

                    tot_stone_wt+=parseFloat($(this).find('.qc_passed_stn_wt').val());

                }

    	    }



    		stone_details.push({

    		            'is_apply_in_lwt'           : $(this).find('.is_apply_in_lwt').val(),

    		            'stone_type'                : $(this).find('.stone_type').val(),

    		            'uom_id'                    : $(this).find('.uom_id').val(),

    		            'po_stone_rate'             : $(this).find('.po_stone_rate').val(),

    		            'po_stone_calc_based_on'    : $(this).find('.po_stone_calc_based_on').val(),

    		            'po_stone_id'               : $(this).find('.po_stone_id').val(),

    		            'po_quality_id'             : $(this).find('.po_quality_id').val(),

    		            'qc_passed_pcs'             : $(this).find('.qc_passed_stn_pcs').val(),

    		            'qc_passed_wt'              : $(this).find('.qc_passed_stn_wt').val(),

    		            'act_blc_stn_pcs'           : $(this).find('.act_blc_stn_pcs').val(),

    		            'act_blc_stn_wt'            : $(this).find('.act_blc_stn_wt').val(),

    		});

    	});

        var catRow=$('#stone_active_id').val();

    	var gross_wt = $('#'+catRow).find('.lot_gross_wt').val();



    	if(parseFloat(gross_wt)<parseFloat(tot_stone_wt))

    	{

    	    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>You Have Entered More Than The Gross Weight.."});

    	}else{



    	    $('#'+catRow).find('.stone_details').val(stone_details.length > 0 ? JSON.stringify(stone_details) : '');

	        $('#'+catRow).find('.add_less_wt').val(parseFloat(tot_stone_wt).toFixed(3));

            $('#lgt_stoneModal .modal-body').find('#lgt_cus_item_details tbody').empty();

            $('#lgt_stoneModal').modal('hide');

            calculate_lot_generate_row();

    	}

});



function validate_lot_generate_row()



{



    var row_validate = true;



    $("#item_detail tbody tr").each(function(index, value){



        if($(this).find('.stock_type').val()==2 && ($(this).find('.id_section').val()=='' || $(this).find('.id_section').val()==null))



        {



			$.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please Select The Section'});



			row_validate = false;



			return false;



		}

		if(parseFloat($(this).find('.lot_net_wt').val())>parseFloat($(this).find('.lot_gross_wt').val()))

		{

		    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Net weight is Grater then the Gross weight'});



			row_validate = false;



			return false;

		}



    });



    return row_validate;



}



$('#generate_lot').on('click',function(){



    if($("input[name='items[qc_item_select][]']:checked").val())



     {



          var row_valid = validate_lot_generate_row();



          if(row_valid)



          {



               $('#generate_lot').prop('disabled',true);



               $(".overlay").css("display", "block");



        			var selected_data = [];



        			$("#item_detail tbody tr").each(function(index, value)



        			{



            			if($(value).find("input:checkbox[class=qc_item_select]:checked").is(":checked"))



            			{



            			    if($(value).find(".qc_item_select").val()==1)



            			    {



            			         transData = {



                        			'po_item_id'            : $(value).find(".po_item_id").val(),



                        			'cat_id'                : $(value).find(".cat_id").val(),



                        			'id_purity'             : $(value).find(".id_purity").val(),



                        			'stock_type'            : $(value).find(".stock_type").val(),



                        			'id_section'            : $(value).find(".id_section").val(),



                        			'pro_id'                : $(value).find(".pro_id").val(),



                        			'id_design'             : $(value).find(".id_design").val(),



                        			'id_sub_design'         : $(value).find(".id_sub_design").val(),



                        			'pcs'                   : $(value).find(".lot_pcs").val(),



                        			'gross_wt'              : $(value).find(".lot_gross_wt").val(),



                        			'less_wt'               : $(value).find(".add_less_wt").val(),



                        			'net_wt'                : $(value).find(".lot_net_wt").val(),



                        			'stone_details'         : $(value).find(".stone_details").val(),



                    			}



                    			selected_data.push(transData);



            			    }



            			    else



            			    {



            			        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please Select The Item'});



            			    }



            			}



        			});



        			if(selected_data.length > 0)



        			{



        			    generate_lot(selected_data);



        			}



         }



     }



     else



     {



         $('#generate_lot').prop('disabled',false);



         $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please Select Any One Item'});



     }



});



function generate_lot(req_data)



{



        my_Date = new Date();



        $(".overlay").css("display", "block");



        $.ajax({



            url:base_url+ "index.php/admin_ret_purchase/generateLot?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



            data: {'req_data':req_data,'po_id':$('#select_po_ref_no').val(),'remark':$('#remark').val()},



            type:"POST",



            dataType: "json",



            async:false,



            success:function(data){



                if(data.status)



                {



                    $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                    location.href=base_url+'index.php/admin_ret_lot/lot_inward/list';



                }else{



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                }



                $(".overlay").css("display", "none");



            },



            error:function(error)



            {



                console.log(error);



                $(".overlay").css("display", "none");



            }



        });



}



//Lot generate



//Weight and Amount conversation



function get_approval_rate_fixing_po_no()



{



    $("#select_po_ref_no option").remove();



	$.ajax({



	type: 'POST',



	data:{'id_karigar':$('#select_karigar').val()},



	url: base_url+'index.php/admin_ret_purchase/get_approval_rate_fixing_po_no',



	dataType:'json',



	success:function(data){



	    approval_ratefix_po_detail = data;



	    var id=$('#select_po_ref_no').val();



		$.each(data, function (key, item) {



		    $("#select_po_ref_no").append(



		    $("<option></option>")



		    .attr("value", item.po_id)



		    .text(item.po_ref_no)



		    );



		});



		$("#select_po_ref_no").select2(



		{



			placeholder:"Select PO Ref",



			closeOnSelect: true



		});







		if($("#select_po_ref_no").length)



		{



		    $("#select_po_ref_no").select2("val",(id!='' && id>0?id:''));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



function opening_balance_ratefixing()



{



    $("#opening_ref_no option").remove();



	$.ajax({



	type: 'POST',



	data:{'id_karigar':$('#select_karigar').val()},



	url: base_url+'index.php/admin_ret_purchase/opening_balance_ratefixing',



	dataType:'json',



	success:function(data){



	    opening_approval_ratefix_detail = data;



	    var id=$('#opening_ref_no').val();



		$.each(data, function (key, item) {



		    $("#opening_ref_no").append(



		    $("<option></option>")



		    .attr("value", item.id_smith_company_op_balance)



		    .text(item.ref_no)



		    );



		});



		$("#opening_ref_no").select2(



		{



			placeholder:"Select Ref No",



			closeOnSelect: true



		});







		if($("#opening_ref_no").length)



		{



		    $("#opening_ref_no").select2("val",(id!='' && id>0?id:''));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



$('#opening_ref_no').on('change',function(){



    var id_smith_company_op_balance = this.value;



    if(this.value!='')



    {



        $.each(opening_approval_ratefix_detail,function(k,val){



            if(val.id_smith_company_op_balance==id_smith_company_op_balance)



            {



                $('#wt_balance').val(val.weight);



                $('#amt_balance').val(val.amount);



            }



        });



    }



});



$("input[name='supplier_rate_cut[convert_to]']:radio").on('change', function () {



    reset_supplier_rate_cut_form();



    $('#tax_percentage').val(3);



    $('.tax_perc').html('3%');



    if(this.value==2)



    {



        $('#tax_percentage').val(5);



        $('.tax_perc').html('5%');



    }



    if(this.value==3)



    {



        $('#tax_percentage').val(0.25);



        $('.tax_perc').html('0.25%');



    }



    if(this.value==4)



    {



        $('#tax_percentage').val(1.25);



        $('.tax_perc').html('1.25%');



    }



    set_rate_cut_details();



});



$("input[name='supplier_rate_cut[is_opening_blc]']:radio").on('change', function () {



    $('.po_select').css("display","none");



    $('.op_balance').css("display","none");



    if(this.value==2)



    {



        $('.po_select').css("display","block");



    }else{



        $('.op_balance').css("display","block");



    }



});



$("input[name='supplier_rate_cut[rate_cut_type]']:radio").on('change', function () {



    reset_supplier_rate_cut_form();



    $('.payment_details').css("display","none");



    $('.po_select').css("display","block");



    $('#select_po_ref_no').select2("val","");



    $('.rate_field').hide();



    $('.type1_wt').hide();



    $('.convert_to').css("display","block");



    $('.conversion_type').css("display","block");



    $('.gst_row').css("display","block");



    $('#tax_percentage').val('');



    $('.tax_perc').html('');



    if (this.value == 1) //Amount to Weight



    {



        $('.convert_to').css("display","none");



        $('.conversion_type').css("display","none");



        $('.payment_details').css("display","block");



        $('.gst_row').css("display","block");



        $('.type1_amt').show();



        $('.type2_wt').show();



        $('.type2_amt').show();



        $('.rate_field').show();



        if($('#select_karigar').val()!='' && $('#select_karigar').val()!=null)



        {



            //get_supplier_pay_details($('#select_karigar').val());



        }



    }



    else if (this.value == 2) { // Weight to Amount



        $('.type2_wt').show();



        $('.type2_amt').show();



        $('.type1_amt').show();



        $('.type1_wt').hide();



        $('.rate_field').show();



        $('.po_select').css("display","block");







    }



    set_rate_cut_details();



    $('.charges_amount').val('');



    $('.src_weight').val('');



    $('.src_rate').val('');



});



function reset_supplier_rate_cut_form() {



    $('#wt_balance').val('');



    $('#amt_balance').val('');



    $('.src_weight').val('');



    $('.src_rate').val('');



    $('.taxable_amt').val('');



    $('.tax_amount').val('');



    $('#charges_amount').val('');



}



$('#supplier_rate_cut_submit').on('click', function () {



    var src_type = $("input[name='supplier_rate_cut[rate_cut_type]']:checked").val();



    $('#supplier_rate_cut_submit').prop('disabled',true);



    if ($('#select_karigar').val() == null || $('#select_karigar').val() == '') {



        $.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>Select Karigar" });



        $('#supplier_rate_cut_submit').prop('disabled',false);



    }



   /* else if ($('#select_metal').val() == null || $('#select_metal').val() == '') {



        $.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>Select Category" });



        $('#supplier_rate_cut_submit').prop('disabled',false);



    }*/



   /*  else if (src_type == 1 && ($('.charges_amount').val() == null || $('.charges_amount').val() == '')) {



        $.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>Please Enter the Amount" });



        $('#supplier_rate_cut_submit').prop('disabled',false);



    } */



    else if ($('#total_bill_amount').val() == 0 || $('#total_bill_amount').val() =='') {



        $.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>Enter the Weight" });



        $('#supplier_rate_cut_submit').prop('disabled',false);



    }



    /* else if (src_type==2 && ($('.src_rate').val() == null || $('.src_rate').val() == '')) {



        $.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>Please Enter the Rate" });



        $('#supplier_rate_cut_submit').prop('disabled',false);



    } */



    else {



        set_supplier_rate_cut();



    }



});



$('.src_wt,.src_amt,.src_rate,.charges_amount,.src_weight,.charges_amt').on('keyup', function () {



    var src_type        = $("input[name='supplier_rate_cut[rate_cut_type]']:checked").val();



    var balance_wt      = parseFloat($('#wt_balance').val());



    var balance_wt_type = parseFloat($('#wt_balance_type').val());



    var balance_amt     = parseFloat($('#amt_balance').val());



    var charges_amount      = ($('.charges_amount').val()!='' ? $('.charges_amount').val() :0);



    var total_pay_amt   = parseFloat(charges_amount).toFixed(2);



    if ((parseFloat(total_pay_amt) > parseFloat(balance_amt))) {



        $.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>Entered More than Balance Amount" });



        $('.charges_amount').focus();



        $('.charges_amount').val('');



        $('#src_weight').val('');



    }



    else {



        calculation_supplier_rate_cut();



    }



    if (src_type == 2 && ($('.src_weight').val() > balance_wt && balance_wt_type == 2)) {



        $.toaster({ priority: 'danger', title: 'Warning!', message: '' + "</br>There is no sufficient balance weight" });



        $('.src_weight').focus();



        $('.src_weight').val('');



        $('#charges_amount').val('');



    } else {



        calculation_supplier_rate_cut();



    }



})



function calculation_supplier_rate_cut() {



    $('#supplier_rate_cut_submit').prop('disabled',false);



    var src_type = $("input[name='supplier_rate_cut[rate_cut_type]']:checked").val();//1-Normal Conversion , 2-Conver to bill



    var convert_to = $("input[name='supplier_rate_cut[convert_to]']:checked").val(); //1-Bill,2-Receipt



    var igst_cost = 0;



    var sgst_cost = 0;



    var cgst_cost = 0;







    var cmp_country = $('#cmp_country').val();



    var cmp_state = $('#cmp_state').val();



    var supplier_country = '';



    var supplier_state = '';







    $.each(karigar_details,function(key,val){



        if(val.id_karigar == $('#select_karigar').val())



        {



            supplier_country=val.id_country;



            supplier_state=val.id_state;



        }



    });







    if(convert_to==1)



    {



        var tax_percentage = 3;



    }



    else if(convert_to==2)



    {



        var tax_percentage = 5;



    }



    else if(convert_to==3)



    {



        var tax_percentage = 0.25;



    }



    else



    {



        var tax_percentage = 1.25;



    }



    if (src_type == 1) {



        var total_amount = parseFloat($('.charges_amount').val()).toFixed(2);







    }



    else if (src_type == 2) {



        var charges_amount      = ($('.charges_amount').val()!='' ? $('.charges_amount').val() :0);



        var src_weight          = ($('.src_weight').val()!='' ? $('.src_weight').val():0);



        var src_rate            = ($('.src_rate').val()!='' ? $('.src_rate').val():0)



        var taxable_amount          = parseFloat(parseFloat(src_weight) * parseFloat(src_rate)).toFixed(2);







        taxable_amount      = parseFloat(parseFloat(taxable_amount)+parseFloat(charges_amount)).toFixed(2);



        var tax_amount      = parseFloat(parseFloat(taxable_amount)*parseFloat(tax_percentage)/100).toFixed(2);



        var total_amount    = parseFloat(parseFloat(taxable_amount)+parseFloat(tax_amount)).toFixed(2);



       if(cmp_country==supplier_country)



       {



            if(cmp_state==supplier_state)



            {



                sgst_cost = parseFloat(tax_amount/2).toFixed(2);



                cgst_cost = parseFloat(tax_amount/2).toFixed(2);



            }



       }else{



           igst_cost = tax_amount;



       }



    }







    round_of_val        = total_amount;



    tot_cost 			= parseFloat(Math.round(total_amount)).toFixed(2);



	round_of_amt        = parseFloat(tot_cost-round_of_val).toFixed(2);







    $('#taxable_amt').val(taxable_amount);



    $('#tax_amount').val(tax_amount);



    $('#total_bill_amount').val(tot_cost);



    $('#tax_percentage').val(tax_percentage);



    $('#round_of_amt').val(round_of_amt);



    $('#sgst_cost').val(sgst_cost);



    $('#cgst_cost').val(cgst_cost);



    $('#igst_cost').val(igst_cost);



    $('.tax_perc').html(tax_percentage+'%');



    if(src_type==1)



    {



        calculate_supplier_rate_cut_payment_cost();



    }







}



function calculate_supplier_rate_cut_payment_cost()



{



    var bal_amount             =0;



    var total_amount           =0;



	var receive_amount         =($('.total_bill_amount ').val()!='' ? $('.total_bill_amount ').val():0);



	var cash_amount            = ($('.cash_amount').val()!='' ? $('.cash_amount').val():0);



	var net_banking_pay        =($('#tot_net_banking_amt').html()!='' ? $('#tot_net_banking_amt').html():0);



	if(receive_amount>0)



	{



	    $('#supplier_rate_cut_submit').prop('disabled',false);



		total_amount=parseFloat(parseFloat(net_banking_pay)+parseFloat(cash_amount)).toFixed(2);



		bal_amount = parseFloat(parseFloat(receive_amount)-parseFloat(total_amount)).toFixed(2);



		if(bal_amount==0)



		{



		    $('#supplier_rate_cut_submit').prop('disabled',false);



		}else



		{



		    $('#supplier_rate_cut_submit').prop('disabled',true);



		}



	}



	else



	{



	    $('#pay_submit').prop('disabled',true);



	}



	$('#bal_amount').html(bal_amount);



}



function set_supplier_rate_cut() {







    var form_data = $('#supplier_rate_cut').serialize();



    console.log(form_data);



    $.ajax({



        type: 'POST',



        url: base_url + "index.php/admin_ret_purchase/supplier_rate_cut/save",



        data: form_data,



        dataType: 'JSON',



        success: function (data) {



            console.log(data);



            if (data.status) {



                $("div.overlay").css("display", "none");



            } else {



                $("div.overlay").css("display", "none");



                //$('#supplier_rate_cut_submit').prop('disabled',false);



            }



            location.href = base_url + 'index.php/admin_ret_purchase/supplier_rate_cut/list';



        }



    })



}



function src_get_branchname() {



    $.ajax({



        type: 'POST',



        url: base_url + 'index.php/branch/branchname_list',



        dataType: 'json',



        success: function (data) {



            var id_branch = $('#id_branch').val();



            $.each(data.branch, function (key, item) {



                if (id_branch == '') {



                    if (item.is_ho == 1) {



                        $('#id_branch').val(item.id_branch);



                    }



                }



                $("#branch_select,.branch").append(



                    $("<option></option>")



                        .attr("value", item.id_branch)



                        .text(item.name)



                );





                if (item.is_ho == 1) {



                    $('#head_office').val(item.id_branch);



                }



            });



            $("#branch_select,.branch").select2({



                placeholder: "Select Branch",



                allowClear: true



            });



            if ($("#branch_select").length) {



                $("#branch_select").select2("val", $('#id_branch').val());



            }



            if ($(".branch").length) {



                $(".branch").select2("val", $('#head_office').val());



            }



        }



    });



}



$('#supplier_rate_cut_search').on('click', function () {



    get_supplier_ratecut_details();



});



function get_supplier_ratecut_details() {



    var company_name = $('#company_name').val();



    var from_date = $('#rpt_payments1').html();



    var to_date = $('#rpt_payments2').html();



    var branch_name = ($('#branch_name').val() != '' && $('#branch_name').val() != undefined ? $('#branch_name').val() : $("#branch_select option:selected").text());



    var report_name = "SUPPLIER RATE CUT REPORT";



    var optional = '';



    var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"



        + "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";



    $("div.overlay").css("display", "block");



    my_Date = new Date();



    $(".overlay").css("display", "block");



    $.ajax({



        type: "POST",



        url: base_url + "index.php/admin_ret_purchase/supplier_rate_cut/ajax",



        data: { 'id_branch': $('#src_branch_select').val(), 'from_date': $('#rpt_payments1').html(),'to_date': $('#rpt_payments2').html()},



        dataType: 'JSON',



        success: function (data) {



            var a = 1;



            var list = data.list;



            var access = data.access;



            var oTable = $('#src_list').DataTable();



            oTable.clear().draw();



            if (list != null && list.length > 0) {



                oTable = $('#src_list').dataTable({



                    "bDestroy": true,



                    "bInfo": true,



                    "bFilter": true,



                    "bSort": true,



                    "ordering": false,



                    "dom": 'lBfrtip',



                    "buttons": [



                        {



                            extend: 'print',



                            footer: true,



                            title: '',



                            messageTop: title,



                            customize: function (win) {



                                $(win.document.body).find('table')



                                    .addClass('compact')



                                    .css('font-size', '10px');



                            },



                        },



                        {



                            extend: 'excel',



                            footer: true,



                            title: 'SUPPLIER RATE CUT REPORT',



                        }



                    ],



                    "tableTools": { "buttons": [{ "sExtends": "xls", "oSelectorOpts": { page: 'current' } }, { "sExtends": "pdf", "oSelectorOpts": { page: 'current' } }] },



                    "aaData": list,



                    "aoColumns": [



                        {



                            "mDataProp": function (row, type, val, meta) {



                                return row.id_supplier_rate_cut;



                            }



                        },



                        { "mDataProp": "ref_no" },



                        { "mDataProp": "branch_name" },



                        { "mDataProp": "date_add" },



                        { "mDataProp": "firstname" },



                        { "mDataProp": "rate_cut_type" },



                        {



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.amount);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.rate_per_gram);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.weight);



            				}



            			},



                        { "mDataProp": function ( row, type, val, meta ) {



                            id=row.id_supplier_rate_cut;



                            print_url= '<a href="'+base_url+'index.php/admin_ret_purchase/supplier_rate_cut/job_receipt/'+id+'" target="_blank" class="btn btn-info btn-print" data-toggle="tooltip" title="" data-original-title="Customer Copy"><i class="fa fa-print"></i></a>';



                            action_content=print_url+''+(row.status==1 && access.delete == '1' ? '<button class="btn btn-warning" onclick="rate_conversion_cancel('+id+')"><i class="fa fa-close" ></i></button>' :'');



                            return action_content;



                        }



                        }



                    ]



                });



            }



            $("div.overlay").css("display", "none");



        }



    })



}



function rate_conversion_cancel(id_supplier_rate_cut)



{



	$('#id_supplier_rate_cut').val(id_supplier_rate_cut);



	$('#confirm_cancel').modal('show');



}



$('#conversion_cancel_remark').on('keypress',function(){



	if(this.value.length>6)



	{



		$('#rate_conversion_cancel').prop('disabled',false);



	}else{



		$('#rate_conversion_cancel').prop('disabled',true);



	}



});



$('#rate_conversion_cancel').on('click',function(){



    $('#rate_conversion_cancel').prop('disabled',true);



	my_Date = new Date();



	$.ajax({



		type: 'POST',



		url:base_url+ "index.php/admin_ret_purchase/supplier_rate_cut/cancel?nocache=" + my_Date.getUTCSeconds(),



		dataType:'json',



		data:{'cancel_reason':$('#conversion_cancel_remark').val(),'id_supplier_rate_cut':$('#id_supplier_rate_cut').val()},



		success:function(data){



		    window.location.reload();



		}



	});



});



//Weight and Amount conversation



//HO Valut Report



$('#valut_report_type').on('change',function(){



    $('.summary').css("display","none");



    $('.detailed').css("display","none");



    if(this.value==1){



        $('.summary').css("display","block");



    }else{



        $('.detailed').css("display","block");



    }



});



$('#valut_item_wise_search').on('click', function () {



    get_headoffice_valut_report();



});



function get_headoffice_valut_report_old()



{



	var company_name = $('#company_name').val();



	var from_date = $('#rpt_payments1').html();



	var to_date = $('#rpt_payments2').html();



	var branch_name = ''



	var report_name = "HO VALUT REPORT"



	var optional = '';



	var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"



		+ "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";



	$("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



		url: base_url + "index.php/admin_ret_purchase/headoffice_valut_report/ajax?nocache=" + my_Date.getUTCSeconds(),



		data: ({ 'from_date': $('#rpt_payments1').html(), 'to_date': $('#rpt_payments2').html(), 'id_karigar': $('#select_karigar').val(),'grn_type': $('#grn_type').val(),'valut_report_type': $('#valut_report_type').val()}),



		type: "POST",



		dataType: "JSON",



		cache: false,



		success: function (data) {



            console.log(data);



			$("div.overlay").css("display", "none");



			var tagged_details = data.list;



			$("#taggedstock_list > tbody > tr").remove();



			$('#taggedstock_list').dataTable().fnClearTable();



			$('#taggedstock_list').dataTable().fnDestroy();



			if (tagged_details != '') {



				var trHtml = '';



				var tot_inw_gwt = 0;



				var tot_inw_nwt = 0;



				var tot_inw_pcs = 0;



				var tot_inw_stn_wt = 0;







				var tot_pur_ret_pcs = 0;



				var tot_pur_ret_gwt = 0;



                var tot_pur_ret_nwt = 0;



                var tot_pur_ret_stn_wt = 0;







				var tot_lot_pcs = 0;



				var tot_lot_gwt = 0;



				var tot_lot_nwt = 0;



				var tot_lot_stn_wt = 0;







				var tot_tag_pcs = 0;



				var tot_tag_gwt = 0;



				var tot_tag_lwt = 0;



				var tot_tag_nwt = 0;



				var tot_tag_stn_wt = 0;







				var tot_blc_gwt = 0;



				var tot_blc_nwt = 0;



				var tot_blc_pcs = 0;



				var tot_blc_diawt = 0;







				$.each(tagged_details, function (key, tagged_details) {



					var inw_gwt = 0;



					var inw_nwt = 0;



					var inw_pcs = 0;



					var inw_stn_wt = 0;







					var pur_ret_pcs = 0;



					var pur_ret_gwt = 0;



					var pur_ret_nwt = 0;



					var pur_ret_stn_wt = 0;







					var lot_pcs = 0;



					var lot_gwt = 0;



					var lot_nwt = 0;



					var lot_stn_wt = 0;







					var tag_pcs = 0;



					var tag_gwt = 0;



					var tag_lwt = 0;



					var tag_nwt = 0;



					var tag_stn_wt = 0;







					var blc_gwt = 0;



					var blc_nwt = 0;



					var blc_pcs = 0;



					var blc_diawt = 0;







					$.each(tagged_details, function (key, val) {







						inw_gwt += parseFloat(val.inw_gwt);



						inw_nwt += parseFloat(val.inw_nwt);



						inw_pcs += parseFloat(val.inw_pcs);



						inw_stn_wt += parseFloat(val.inw_stn_wt);







						pur_ret_pcs += parseFloat(val.pur_ret_pcs);



						pur_ret_gwt += parseFloat(val.pur_ret_gwt);



						pur_ret_nwt += parseFloat(val.pur_ret_nwt);



						pur_ret_stn_wt += parseFloat(val.ret_stone_wt);







						lot_pcs += parseFloat(val.lot_pcs);



						lot_gwt += parseFloat(val.lot_gwt);



						lot_nwt += parseFloat(val.lot_nwt);



						lot_stn_wt += parseFloat(val.lot_stn_wt);







						tag_pcs += parseFloat(val.tag_pcs);



						tag_gwt += parseFloat(val.tag_gwt);



						tag_lwt += parseFloat(val.tag_lwt);



						tag_nwt += parseFloat(val.tag_nwt);



						tag_stn_wt += parseFloat(val.tag_stn_wt);







						tot_inw_gwt += parseFloat(val.inw_gwt);



						tot_inw_nwt += parseFloat(val.inw_nwt);



						tot_inw_pcs += parseFloat(val.inw_pcs);



						tot_inw_stn_wt += parseFloat(val.inw_stn_wt);







						tot_pur_ret_pcs += parseFloat(val.pur_ret_pcs);



						tot_pur_ret_gwt += parseFloat(val.pur_ret_gwt);



						tot_pur_ret_nwt += parseFloat(val.pur_ret_nwt);



						tot_pur_ret_stn_wt += parseFloat(val.ret_stone_wt);







						tot_lot_pcs += parseFloat(val.lot_pcs);



						tot_lot_gwt += parseFloat(val.lot_gwt);



						tot_lot_nwt += parseFloat(val.lot_nwt);



						tot_lot_stn_wt += parseFloat(val.lot_stn_wt);







						tot_tag_pcs += parseFloat(val.tag_pcs);



						tot_tag_gwt += parseFloat(val.tag_gwt);



						tot_tag_lwt += parseFloat(val.tag_lwt);



						tot_tag_nwt += parseFloat(val.tag_nwt);



						tot_tag_stn_wt += parseFloat(val.tag_stn_wt);











					    tot_blc_gwt += parseFloat(parseFloat(val.inw_gwt)-parseFloat(val.pur_ret_gwt)-parseFloat(val.lot_gwt));



						tot_blc_nwt += parseFloat(parseFloat(val.inw_nwt)-parseFloat(val.pur_ret_nwt)-parseFloat(val.lot_nwt));



						tot_blc_pcs += parseFloat(parseFloat(val.inw_pcs)-parseFloat(val.pur_ret_pcs)-parseFloat(val.lot_pcs));



					    tot_blc_diawt = parseFloat(parseFloat(val.inw_stn_wt)-parseFloat(val.ret_stone_wt)-parseFloat(val.lot_stn_wt));







                        blc_pcs+= parseFloat(parseFloat(val.inw_pcs)-parseFloat(val.pur_ret_pcs)-parseFloat(val.lot_pcs));



                        blc_gwt+= parseFloat(parseFloat(val.inw_gwt)-parseFloat(val.pur_ret_gwt)-parseFloat(val.lot_gwt));



                        blc_nwt+= parseFloat(parseFloat(val.inw_nwt)-parseFloat(val.pur_ret_nwt)-parseFloat(val.lot_nwt));



                        blc_diawt+= parseFloat(parseFloat(val.inw_stn_wt)-parseFloat(val.ret_stone_wt)-parseFloat(val.lot_stn_wt));















						trHtml += '<tr>'



							+ '<td>' + val.po_ref_no + '</td>'



							+ '<td>' + val.podate + '</td>'



							+ '<td>' + val.karigar_name + '</td>'



							+ '<td>' + val.product_name + '</td>'



							+ '<td>' + val.inw_pcs + '</td>'



							+ '<td>' + val.inw_gwt + '</td>'



							+ '<td>' + val.inw_nwt + '</td>'



							+ '<td>' + val.inw_stn_wt + '</td>'







							+ '<td>' + val.pur_ret_pcs + '</td>'



							+ '<td>' + val.pur_ret_gwt + '</td>'



							+ '<td>' + val.pur_ret_nwt + '</td>'



							+ '<td>' + val.ret_stone_wt + '</td>'







							+ '<td>' + val.lot_pcs + '</td>'



							+ '<td>' + val.lot_gwt + '</td>'



							+ '<td>' + val.lot_nwt + '</td>'



							+ '<td>' + val.lot_stn_wt + '</td>'







							+ '<td>' + val.tag_pcs + '</td>'



							+ '<td>' + val.tag_gwt + '</td>'



							+ '<td>' + val.tag_nwt + '</td>'



							+ '<td>' + val.tag_stn_wt + '</td>'







							+ '<td>' + parseFloat(parseFloat(val.inw_pcs)-parseFloat(val.pur_ret_pcs)-parseFloat(val.lot_pcs)).toFixed(0)+ '</td>'



							+ '<td>' + parseFloat(parseFloat(val.inw_gwt)-parseFloat(val.pur_ret_gwt)-parseFloat(val.lot_gwt)).toFixed(3)+ '</td>'



							+ '<td>' + parseFloat(parseFloat(val.inw_nwt)-parseFloat(val.pur_ret_nwt)-parseFloat(val.lot_nwt)).toFixed(3) + '</td>'



							+ '<td>' + parseFloat(parseFloat(val.inw_stn_wt)-parseFloat(val.ret_stone_wt)-parseFloat(val.lot_stn_wt)).toFixed(3) + '</td>'



							+ '</tr>';



					});



					trHtml += '<tr style="font-weight:bold; color:red">'



						+ '<td>SUB TOTAL</td>'



						+ '<td></td>'



						+ '<td></td>'



						+ '<td></td>'



						+ '<td>' + money_format_india(parseFloat(inw_pcs).toFixed(0)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(inw_gwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(inw_nwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(inw_stn_wt).toFixed(3)) + '</td>'







						+ '<td>' + money_format_india(parseFloat(pur_ret_pcs).toFixed(0)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(pur_ret_gwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(pur_ret_nwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(pur_ret_stn_wt).toFixed(3)) + '</td>'







						+ '<td>' + money_format_india(parseFloat(lot_pcs).toFixed(0)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(lot_gwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(lot_nwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(lot_stn_wt).toFixed(3)) + '</td>'







						+ '<td>' + money_format_india(parseFloat(tag_pcs).toFixed(0)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tag_gwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tag_nwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tag_stn_wt).toFixed(3)) + '</td>'







                        + '<td>' + money_format_india(parseFloat(blc_pcs).toFixed(0)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(blc_gwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(blc_nwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(blc_diawt).toFixed(3)) + '</td>'



						+ '</tr>';



				});







				trHtml += '<tr style="font-weight:bold; color: blue">'



					+ '<td>GRAND TOTAL</td>'



					+ '<td></td>'



					+ '<td></td>'



					+ '<td></td>'



					    + '<td>' + money_format_india(parseFloat(tot_inw_pcs).toFixed(0)) + '</td>'



					    + '<td>' +money_format_india(parseFloat(tot_inw_gwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_inw_nwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_inw_stn_wt).toFixed(3)) + '</td>'







						+ '<td>' + money_format_india(parseFloat(tot_pur_ret_pcs).toFixed(0)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_pur_ret_gwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_pur_ret_nwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_pur_ret_stn_wt).toFixed(3)) + '</td>'







						+ '<td>' + money_format_india(parseFloat(tot_lot_pcs).toFixed(0)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_lot_gwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_lot_nwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_lot_stn_wt).toFixed(3)) + '</td>'







						+ '<td>' + money_format_india(parseFloat(tot_tag_pcs).toFixed(0)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_tag_gwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_tag_nwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_tag_stn_wt).toFixed(3)) + '</td>'







                        + '<td>' + money_format_india(parseFloat(tot_blc_pcs).toFixed(0)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_blc_gwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_blc_nwt).toFixed(3)) + '</td>'



						+ '<td>' + money_format_india(parseFloat(tot_blc_diawt).toFixed(3)) + '</td>'







					// + '<td></td>'



					// + '<td></td>'



					// + '<td></td>'



					// + '<td></td>'



					+ '</tr>';



				$('#taggedstock_list > tbody').html(trHtml);



				// Check and initialise datatable



				if (!$.fn.DataTable.isDataTable('#taggedstock_list')) {



					oTable = $('#taggedstock_list').dataTable({



						"bSort": false,



						"bInfo": true,



						"scrollX": '100%',



						"dom": 'lBfrtip',



						"paging": false,



						"fixedHeader": true,



						"autoWidth": true,



						"columnDefs": [



							{



								targets: [4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21],



								className: 'dt-body-right'



							}



						],



						"buttons": [



							{



								extend: 'print',



								footer: true,



								title: '',



								messageTop: title,



								exportOptions: {



									columns: ':visible'



								},



								customize: function (win) {



									$(win.document.body).find('table')



										.addClass('compact')



										.css('font-size', '12px')



										.css('font-family', 'sans-serif');



								},



							},



						],



					});



				}



			}



		},



		error: function (error) {



			$("div.overlay").css("display", "none");



		}



	});



}



function get_headoffice_valut_report()



{







	$("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



		url: base_url + "index.php/admin_ret_purchase/headoffice_valut_report/ajax?nocache=" + my_Date.getUTCSeconds(),



		data: ({ 'from_date': $('#rpt_payments1').html(), 'to_date': $('#rpt_payments2').html(), 'id_karigar': $('#select_karigar').val(),'grn_type': $('#grn_type').val(),'id_metal': $('#select_metal').val(),'id_category': $('#select_category').val(),'po_ref_no': $('#select_po_ref_no').val(),'valut_report_type': $('#valut_report_type').val()}),



		type: "POST",



		dataType: "JSON",



		cache: false,



		success: function (data) {



		    var a = 1;



            var list = data.list;



            var val = data.summary;



            if($('#valut_report_type').val()==1)



            {



                set_summary_valut_report(list);



            }



		    else



		    {



		        set_detailed_valut_report(list);



		    }



		    $('.blc_pcs').html(money_format_india(val.blc_pcs));



		    $('.blc_gwt').html(money_format_india(parseFloat(val.blc_gwt).toFixed(3)));



		    $('.blc_nwt').html(money_format_india(parseFloat(val.blc_nwt).toFixed(3)));



		    $('.blc_diawt').html(money_format_india(parseFloat(val.blc_diawt).toFixed(3)));



		    $('.inw_pcs').html(money_format_india(parseFloat(val.inw_pcs).toFixed(0)));



		    $('.inw_gwt').html(money_format_india(parseFloat(val.inw_gwt).toFixed(3)));



		    $('.inw_nwt').html(money_format_india(parseFloat(val.inw_nwt).toFixed(3)));



		    $('.inw_diawt').html(money_format_india(parseFloat(val.inw_diawt).toFixed(3)));



		    $('.pur_ret_pcs').html(money_format_india(parseFloat(val.pur_ret_pcs).toFixed(0)));



		    $('.pur_ret_gwt').html(money_format_india(parseFloat(val.pur_ret_gwt).toFixed(3)));



		    $('.pur_ret_nwt').html(money_format_india(parseFloat(val.pur_ret_nwt).toFixed(3)));



		    $('.ret_diawt').html(money_format_india(parseFloat(val.ret_diawt).toFixed(3)));



		    $('.issue_pcs').html(money_format_india(parseFloat(val.issue_pcs).toFixed(0)));



		    $('.issue_gwt').html(money_format_india(parseFloat(val.issue_gwt).toFixed(3)));



		    $('.issue_nwt').html(money_format_india(parseFloat(val.issue_nwt).toFixed(3)));



		    $('.issue_diawt').html(money_format_india(parseFloat(val.issue_diawt).toFixed(3)));



		    $('.lot_pcs').html(money_format_india(parseFloat(val.lot_pcs).toFixed(0)));



		    $('.lot_gwt').html(money_format_india(parseFloat(val.lot_gwt).toFixed(3)));



		    $('.lot_nwt').html(money_format_india(parseFloat(val.lot_nwt).toFixed(3)));



		    $('.lot_diawt').html(money_format_india(parseFloat(val.lot_dia_wt).toFixed(3)));



		    $('.tag_pcs').html(money_format_india(parseFloat(val.tag_pcs).toFixed(0)));



		    $('.tag_gwt').html(money_format_india(parseFloat(val.tag_gwt).toFixed(3)));



		    $('.tag_nwt').html(money_format_india(parseFloat(val.tag_nwt).toFixed(3)));



		    $('.tag_diawt').html(money_format_india(parseFloat(val.tag_dia_wt).toFixed(3)));



		    $('.closing_pcs').html(money_format_india(parseFloat(val.closing_pcs).toFixed(0)));



		    $('.closing_gwt').html(money_format_india(parseFloat(val.closing_gwt).toFixed(3)));



		    $('.closing_nwt').html(money_format_india(parseFloat(val.closing_nwt).toFixed(3)));



		    $('.closing_diawt').html(money_format_india(parseFloat(val.closing_diawt).toFixed(3)));



            $("div.overlay").css("display", "none");



		},



		error: function (error) {



			$("div.overlay").css("display", "none");



		}



	});



}



function set_summary_valut_report(list)



{



    var company_name = $('#company_name').val();



	var from_date = $('#rpt_payments1').html();



	var to_date = $('#rpt_payments2').html();



	var branch_name = ''



	var report_name = "HO VALUT REPORT"



	var optional = '';



	var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"



		+ "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";







    var oTable = $('#taggedstock_list').DataTable();



    oTable.clear().draw();



    if (list != null && list.length > 0) {



        oTable = $('#taggedstock_list').dataTable({



            "bDestroy": true,



            "bInfo": true,



            "bFilter": true,



            "bSort": true,



            "ordering": false,



            "dom": 'lBfrtip',



            "columnDefs": [



					{



						targets: [3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],



						className: 'dt-body-right'



					}



				],



            "buttons": [



                {



                    extend: 'print',



                    footer: true,



                    title: '',



                    messageTop: title,



                    exportOptions: {



						columns: ':visible'



					},



                    customize: function (win) {



                        $(win.document.body).find('table')



                            .addClass('compact')



                            .css('font-size', '10px');



                    },



                },



                {



                    extend: 'excel',



                    footer: true,



                    exportOptions: {



						columns: ':visible'



					},



                    title: 'H.O Vault Report',



                },



                {



                    extend: 'colvis',



                    collectionLayout: 'fixed columns',



                    collectionTitle: 'Column visibility control'



                },



            ],



            "tableTools": { "buttons": [{ "sExtends": "xls", "oSelectorOpts": { page: 'current' } }, { "sExtends": "pdf", "oSelectorOpts": { page: 'current' } }] },



            "aaData": list,



            "aoColumns": [







                { "mDataProp": "po_ref_no" },



                { "mDataProp": "podate" },



                { "mDataProp": "karigar_name" },



                { "mDataProp": "blc_pcs" },



                { "mDataProp": "blc_gwt" },



                { "mDataProp": "blc_nwt" },



                { "mDataProp": "blc_diawt" },



                { "mDataProp": "inw_pcs" },



                { "mDataProp": "inw_gwt" },



                { "mDataProp": "inw_nwt" },



                { "mDataProp": "inw_diawt" },



                { "mDataProp": "pur_ret_pcs" },



                { "mDataProp": "pur_ret_gwt" },



                { "mDataProp": "pur_ret_nwt" },



                { "mDataProp": "ret_diawt" },







                { "mDataProp": "issue_pcs" },



                { "mDataProp": "issue_wt" },



                { "mDataProp": "issue_wt" },



                { "mDataProp": "issue_diawt" },



                { "mDataProp": "lot_pcs" },



                { "mDataProp": "lot_gwt" },



                { "mDataProp": "lot_nwt" },



                { "mDataProp": "lot_dia_wt" },



                { "mDataProp": "tag_pcs" },



                { "mDataProp": "tag_gwt" },



                { "mDataProp": "tag_nwt" },



                { "mDataProp": "tag_dia_wt" },



                { "mDataProp": "closing_pcs" },



                { "mDataProp": "closing_gwt" },



                { "mDataProp": "closing_nwt" },



                { "mDataProp": "closing_diawt" },



            ],



            "footerCallback": function( row, data, start, end, display )



			{



				if(data.length>0){



					var api = this.api(), data;



					for( var i=0; i<=data.length-1;i++){



						var intVal = function ( i ) {



							return typeof i === 'string' ?



							i.replace(/[\$,]/g, '')*1 :



							typeof i === 'number' ?



							i : 0;



						};







						$(api.column(0).footer() ).html('Total');







						blc_pcs = api



						.column(3)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(3).footer()).html(money_format_india(parseFloat(blc_pcs)));







						blc_gwt = api



						.column(4)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(4).footer()).html(money_format_india(parseFloat(blc_gwt).toFixed(3)));







						blc_nwt = api



						.column(5)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(5).footer()).html(money_format_india(parseFloat(blc_nwt).toFixed(3)));







						blc_diawt = api



						.column(6)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(6).footer()).html(money_format_india(parseFloat(blc_diawt).toFixed(3)));







						inw_pcs = api



						.column(7)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(7).footer()).html(money_format_india(parseFloat(inw_pcs).toFixed(0)));







						inw_gwt = api



						.column(8)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(8).footer()).html(money_format_india(parseFloat(inw_gwt).toFixed(3)));







						inw_nwt = api



						.column(9)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(9).footer()).html(money_format_india(parseFloat(inw_nwt).toFixed(3)));







						inw_diawt = api



						.column(10)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(10).footer()).html(money_format_india(parseFloat(inw_diawt).toFixed(3)));







						ret_pcs = api



						.column(11)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(11).footer()).html(money_format_india(parseFloat(ret_pcs).toFixed(0)));







						ret_gwt = api



						.column(12)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(12).footer()).html(money_format_india(parseFloat(ret_gwt).toFixed(3)));







						ret_nwt = api



						.column(13)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(13).footer()).html(money_format_india(parseFloat(ret_nwt).toFixed(3)));







						ret_diawt = api



						.column(14)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(14).footer()).html(money_format_india(parseFloat(ret_diawt).toFixed(3)));







						issue_pcs = api



						.column(15)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(15).footer()).html(money_format_india(parseFloat(issue_pcs).toFixed(0)));







						issue_gwt = api



						.column(16)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(16).footer()).html(money_format_india(parseFloat(issue_gwt).toFixed(3)));







						issue_nwt = api



						.column(17)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(17).footer()).html(money_format_india(parseFloat(issue_nwt).toFixed(3)));







						issue_diawt = api



						.column(18)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(18).footer()).html(money_format_india(parseFloat(issue_diawt).toFixed(3)));







						lot_pcs = api



						.column(19)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(19).footer()).html(money_format_india(parseFloat(lot_pcs).toFixed(0)));







						lot_gwt = api



						.column(20)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(20).footer()).html(money_format_india(parseFloat(lot_gwt).toFixed(3)));







						lot_nwt = api



						.column(21)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(21).footer()).html(money_format_india(parseFloat(lot_nwt).toFixed(3)));







						lot_diawt = api



						.column(22)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(22).footer()).html(money_format_india(parseFloat(lot_diawt).toFixed(3)));







						tag_pcs = api



						.column(23)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(23).footer()).html(money_format_india(parseFloat(tag_pcs).toFixed(0)));







						tag_gwt = api



						.column(24)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(24).footer()).html(money_format_india(parseFloat(tag_gwt).toFixed(3)));







						tag_nwt = api



						.column(25)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(25).footer()).html(money_format_india(parseFloat(tag_nwt).toFixed(3)));







						tagdia_wt = api



						.column(26)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(26).footer()).html(money_format_india(parseFloat(tagdia_wt).toFixed(3)));







						blc_pcs = api



						.column(27)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(27).footer()).html(money_format_india(parseFloat(blc_pcs).toFixed(0)));







						blc_gwt = api



						.column(28)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(28).footer()).html(money_format_india(parseFloat(blc_gwt).toFixed(3)));







						blc_nwt = api



						.column(29)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(29).footer()).html(money_format_india(parseFloat(blc_nwt).toFixed(3)));







						blc_diawt = api



						.column(30)



						.data()



						.reduce( function (a, b) {



							return intVal(a) + intVal(b);



						}, 0 );



						$(api.column(30).footer()).html(money_format_india(parseFloat(blc_diawt).toFixed(3)));







				}



				}else{



					 var api = this.api(), data;



					 $(api.column(8).footer()).html('');



					 $(api.column(9).footer()).html('');



					 $(api.column(10).footer()).html('');



				}



			}



        });



    }







}



function set_detailed_valut_report(data)



{







    var company_name = $('#company_name').val();



	var from_date = $('#rpt_payments1').html();



	var to_date = $('#rpt_payments2').html();



	var branch_name = ''



	var report_name = "HO VALUT REPORT"



	var optional = '';



	var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"



		+ "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";







	$("#taggedstock_detailed_list > tbody > tr").remove();



	$('#taggedstock_detailed_list').dataTable().fnClearTable();



	$('#taggedstock_detailed_list').dataTable().fnDestroy();



	var trHtml = '';



	var blc_pcs = 0;



	var blc_gwt = 0;



	var blc_nwt = 0;



	var blc_diawt = 0;



	var inw_pcs = 0;



	var inw_gwt = 0;



	var inw_nwt = 0;



	var inw_diawt = 0;



	var pur_ret_pcs = 0;



	var pur_ret_gwt = 0;



	var pur_ret_nwt = 0;



	var ret_diawt = 0;



	var issue_pcs = 0;



	var issue_wt = 0;



	var issue_wt = 0;



	var issue_diawt = 0;







    var lot_pcs = 0;



	var lot_gwt = 0;



	var tag_nwt = 0;



	var lot_dia_wt = 0;







	var tag_pcs = 0;



	var tag_gwt = 0;



	var tag_nwt = 0;



	var tag_diawt = 0;



	var closing_pcs = 0;



	var closing_gwt = 0;



	var closing_nwt = 0;



	var closing_diawt = 0;



	$.each(data,function(key,val){



	    var tag_no = '-';



	    var tag_pcs = '0';



	    var tag_gwt = '0';



	    var tag_nwt = '0';



	    var tag_diawt = '0';



	    blc_pcs+=parseFloat(val.blc_pcs);



	    blc_gwt+=parseFloat(val.blc_gwt);



	    blc_nwt+=parseFloat(val.blc_nwt);



	    blc_diawt+=parseFloat(val.blc_diawt);



	    inw_pcs+=parseFloat(val.inw_pcs);



	    inw_gwt+=parseFloat(val.inw_gwt);



	    inw_nwt+=parseFloat(val.inw_nwt);



	    inw_diawt+=parseFloat(val.inw_diawt);



	    pur_ret_pcs+=parseFloat(val.pur_ret_pcs);



	    pur_ret_gwt+=parseFloat(val.pur_ret_gwt);



	    pur_ret_nwt+=parseFloat(val.pur_ret_nwt);



	    ret_diawt+=parseFloat(val.ret_diawt);







	    issue_pcs+=parseFloat(val.issue_pcs);



	    issue_wt+=parseFloat(val.issue_wt);



	    issue_wt+=parseFloat(val.issue_wt);



	    issue_diawt+=parseFloat(val.issue_diawt);







	    lot_pcs+=parseFloat(val.lot_pcs);



	    lot_gwt+=parseFloat(val.lot_gwt);



	    tag_nwt+=parseFloat(val.tag_nwt);



	    lot_dia_wt+=parseFloat(val.lot_dia_wt);



	    tag_pcs+=parseFloat(val.tag_pcs);



	    tag_gwt+=parseFloat(val.tag_gwt);



	    tag_nwt+=parseFloat(val.tag_nwt);



	    tag_diawt+=parseFloat(val.tag_diawt);



	    closing_pcs+=parseFloat(val.closing_pcs);



	    closing_gwt+=parseFloat(val.closing_gwt);



	    closing_nwt+=parseFloat(val.closing_nwt);



	    closing_diawt+=parseFloat(val.closing_diawt);



	    if(val.tag_details.length >0)



	    if(val.tag_details!='' && val.tag_details!=null)



	    {



	        tag_no      = val.tag_details[0].tag_code;



	        tag_pcs     = val.tag_details[0].piece;



	        tag_gwt     = val.tag_details[0].gross_wt;



	        tag_nwt     = val.tag_details[0].net_wt;



	        tag_diawt   = val.tag_details[0].dia_wt;











	    }



	   trHtml += '<tr>'



			+ '<td>' + val.po_ref_no + '</td>'



			+ '<td>' + val.podate + '</td>'



			+ '<td>' + val.karigar_name + '</td>'



			+ '<td>' + money_format_india(val.blc_pcs) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.blc_gwt).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.blc_nwt).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.blc_diawt).toFixed(3)) + '</td>'







			+ '<td>' + money_format_india(parseFloat(val.inw_pcs).toFixed(0)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.inw_gwt).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.inw_nwt).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.inw_diawt).toFixed(3)) + '</td>'







			+ '<td>' + money_format_india(parseFloat(val.pur_ret_pcs)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.pur_ret_gwt).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.pur_ret_nwt).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.ret_diawt).toFixed(3)) + '</td>'







			+ '<td>' + money_format_india(parseFloat(val.issue_pcs)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.issue_wt).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.issue_wt).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.issue_diawt).toFixed(3)) + '</td>'







			+ '<td>' + money_format_india(parseFloat(val.lot_pcs).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.lot_gwt).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.lot_nwt).toFixed(3)) + '</td>'



			+ '<td>' + money_format_india(parseFloat(val.lot_dia_wt).toFixed(3)) + '</td>'



			+ '<td></td>'



			+ '<td>'+tag_no+'</td>'



			+ '<td>'+money_format_india(parseFloat(tag_pcs).toFixed(3))+'</td>'



			+ '<td>'+money_format_india(parseFloat(tag_gwt).toFixed(3))+'</td>'



			+ '<td>'+money_format_india(parseFloat(tag_nwt).toFixed(3))+'</td>'



			+ '<td>'+money_format_india(parseFloat(tag_diawt).toFixed(3))+'</td>'











			+ '<td>' +money_format_india(parseFloat(val.closing_pcs).toFixed(3))+ '</td>'



			+ '<td>' +money_format_india(parseFloat(val.closing_gwt).toFixed(3))+ '</td>'



			+ '<td>' +money_format_india(parseFloat(val.closing_nwt).toFixed(3))+ '</td>'



			+ '<td>' +money_format_india(parseFloat(val.closing_diawt).toFixed(3))+ '</td>'







			+ '</tr>';



			if(val.tag_details!='' && val.tag_details!=null)



			{



			    var tag_grand_tot_pcs = 0;



			    var tag_grand_tot_gwt = 0;



			    var tag_grand_tot_nwt = 0;



			    var tag_grand_tot_diawt = 0;



			    $.each(val.tag_details,function(tagkey,lot){



			        var tag_tot_pcs = 0;



    			    var tag_tot_gwt = 0;



    			    var tag_tot_nwt = 0;



    			    var tag_tot_diawt = 0;



			        $.each(lot,function(tagkey,tag_val){







        			        tag_tot_pcs+=parseFloat(tag_val.piece);



                            tag_tot_gwt+=parseFloat(tag_val.gross_wt);



                            tag_tot_nwt+=parseFloat(tag_val.net_wt);



                            tag_tot_diawt+=parseFloat(tag_val.dia_wt);







                            tag_grand_tot_pcs+=parseFloat(tag_val.piece);



                            tag_grand_tot_gwt+=parseFloat(tag_val.gross_wt);



                            tag_grand_tot_nwt+=parseFloat(tag_val.net_wt);



                            tag_grand_tot_diawt+=parseFloat(tag_val.dia_wt);







        	                    trHtml += '<tr>'



                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'







                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'







                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'







                    			+ '<td></td>'



                    		    + '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'







                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'







                    			+ '<td>'+tag_val.lot_no+'</td>'



                    			+ '<td>'+tag_val.tag_code+'</td>'



                    			+ '<td>'+tag_val.piece+'</td>'



                    			+ '<td>'+tag_val.gross_wt+'</td>'



                    			+ '<td>'+tag_val.net_wt+'</td>'



                    			+ '<td>'+tag_val.dia_wt+'</td>'











                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td></td>'







                    			+ '</tr>';



        	            });



	            trHtml += '<tr style="font-weight:bold;">'



            			+ '<td>SUB TOTAL</td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '<td></td>'



            		    + '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '<td></td>'



            			+ '<td>'+parseFloat(tag_tot_pcs).toFixed(0)+'</td>'



            			+ '<td>'+parseFloat(tag_tot_gwt).toFixed(3)+'</td>'



            			+ '<td>'+parseFloat(tag_tot_nwt).toFixed(3)+'</td>'



            			+ '<td>'+parseFloat(tag_tot_diawt).toFixed(3)+'</td>'















            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '</tr>';



			    });



			    trHtml += '<tr style="font-weight:bold;">'



            			+ '<td>TOTAL</td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '<td></td>'



            		    + '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '<td></td>'



            			+ '<td>'+parseFloat(tag_grand_tot_pcs).toFixed(0)+'</td>'



            			+ '<td>'+parseFloat(tag_grand_tot_gwt).toFixed(3)+'</td>'



            			+ '<td>'+parseFloat(tag_grand_tot_nwt).toFixed(3)+'</td>'



            			+ '<td>'+parseFloat(tag_grand_tot_diawt).toFixed(3)+'</td>'















            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'



            			+ '<td></td>'







            			+ '</tr>';



			}







	});



	trHtml += '<tr style="font-weight:bold;">'



            			        + '<td>GRAND TOTAL</td>'



                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td>' + money_format_india(blc_pcs) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(blc_gwt).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(blc_nwt).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(blc_diawt).toFixed(3)) + '</td>'







                    			+ '<td>' + money_format_india(parseFloat(inw_pcs).toFixed(0)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(inw_gwt).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(inw_nwt).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(inw_diawt).toFixed(3)) + '</td>'







                    			+ '<td>' + money_format_india(parseFloat(pur_ret_pcs)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(pur_ret_gwt).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(pur_ret_nwt).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(ret_diawt).toFixed(3)) + '</td>'







                    			+ '<td>' + money_format_india(parseFloat(issue_pcs)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(issue_wt).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(issue_wt).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(issue_diawt).toFixed(3)) + '</td>'







                    			+ '<td>' + money_format_india(parseFloat(lot_pcs).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(lot_gwt).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(lot_nwt).toFixed(3)) + '</td>'



                    			+ '<td>' + money_format_india(parseFloat(lot_dia_wt).toFixed(3)) + '</td>'







                    			+ '<td></td>'



                    			+ '<td></td>'



                    			+ '<td>'+money_format_india(parseFloat(tag_pcs).toFixed(3))+'</td>'



                    			+ '<td>'+money_format_india(parseFloat(tag_gwt).toFixed(3))+'</td>'



                    			+ '<td>'+money_format_india(parseFloat(tag_nwt).toFixed(3))+'</td>'



                    			+ '<td>'+money_format_india(parseFloat(tag_diawt).toFixed(3))+'</td>'







                    			+ '<td>' +money_format_india(parseFloat(closing_pcs).toFixed(3))+ '</td>'



                    			+ '<td>' +money_format_india(parseFloat(closing_gwt).toFixed(3))+ '</td>'



                    			+ '<td>' +money_format_india(parseFloat(closing_nwt).toFixed(3))+ '</td>'



                    			+ '<td>' +money_format_india(parseFloat(closing_diawt).toFixed(3))+ '</td>'



            			+ '</tr>';



	$('#taggedstock_detailed_list > tbody').html(trHtml);







	// Check and initialise datatable



	if (!$.fn.DataTable.isDataTable('#taggedstock_detailed_list')) {



		oTable = $('#taggedstock_detailed_list').dataTable({



			"bSort": false,



			"bInfo": true,



			"scrollX": '100%',



			"dom": 'lBfrtip',



			"paging": true,



			"fixedHeader": true,



			"autoWidth": true,



			"columnDefs": [



				{



					targets: [3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32],



					className: 'dt-body-right'



				}



			],



			"buttons": [



				{



					extend: 'print',



					footer: true,



					title: '',



					messageTop: title,



					exportOptions: {



						columns: ':visible'



					},



					customize: function (win) {



						$(win.document.body).find('table')



							.addClass('compact')



							.css('font-size', '12px')



							.css('font-family', 'sans-serif');



					},



				},



				{



                    extend: 'colvis',



                    collectionLayout: 'fixed columns',



                    collectionTitle: 'Column visibility control'



                },



			],



		});



	}



}



function get_qcissuedDetails()



{



    my_Date = new Date();



	$.ajax({



		url: base_url + "index.php/admin_ret_purchase/qc_issue_receipt/qcIssuedEdit",



		data: ({'id_qc_issue':ctrl_page[3]}),



		type: "POST",



		dataType: "JSON",



		cache: false,



		success: function (data)



        {



            $('#select_po_ref_no').select2("val",data[0].po_id);



            $('#select_po_ref_no').prop('disabled',true);



            $('#emp_select').select2("val",(data[0].id_emp));



            $('#qc_process_id').val(data[0].qc_process_id);



            $('#item_detail tbody').empty();



            var rowExists=false;



            var trHtml='';



            $.each(data,function(key,items)



            {



                $('#item_detail > tbody tr').each(function(bidx, brow){



                    curRow = $(this);



                    if(curRow.find('.po_item_id').val()==items.po_item_id)



                    {



                        rowExists=true;



                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                    }



                });



                if(!rowExists)



                {



                    var stone_details = [];



                    var stone_pcs = 0;



                    var stone_wt = 0;







                    $.each(items.stone_details,function(k,stnval)



                    {



                        stone_pcs+=parseFloat(stnval.po_stone_pcs);



                        $.each(uom_details,function(key,item){



                            if(item.uom_id==stnval.po_stone_uom && stnval.is_apply_in_lwt==1)



                            {



                                if(((item.uom_short_code).toLowerCase() =='ct') && (item.divided_by_value!=null && item.divided_by_value!='')) //For Carat Need to convert into gram



                                {



                                    stone_wt+=parseFloat(parseFloat(stnval.stone_wt)/parseFloat(item.divided_by_value));



                                }else{







                                    stone_wt+=parseFloat(stnval.stone_wt);



                                }



                            }



                        });



                        stone_details.push({



                            'po_st_id'          : stnval.po_st_id,



                            'show_in_lwt'       : stnval.is_apply_in_lwt,



                            'stones_type'       : stnval.stone_type,



                            'stone_uom_id'      : stnval.po_stone_uom,



                            'stone_id'          : stnval.po_stone_id,



                            'stone_pcs'         : stnval.stone_pcs,



                            'stone_wt'          : stnval.stone_wt,



                            'stone_cal_type'    : stnval.po_stone_calc_based_on,



                            'stone_price'       : stnval.po_stone_amount,



                            'stone_rate'        : stnval.po_stone_rate,



                            'stone_quality_id'  : stnval.po_quality_id,



                            'bal_act_stone_pcs' : stnval.bal_stn_pcs,



                            'bal_act_stone_wt'  : stnval.bal_stn_wt,



                        });



                    });



                    var blc_pcs_for_issue = 0;



                    var blc_gwt_for_issue = 0;



                    var blc_nwt_for_issue = 0;



                    $.each(items.blc_details,function(k,val)



                    {



                        blc_pcs_for_issue+=parseFloat(val.blc_qcissued_pcs);



                        blc_gwt_for_issue+=parseFloat(val.blc_qcissued_gwt);



                        blc_nwt_for_issue+=parseFloat(val.blc_qcissued_nwt);



                    })







                    var id =  parseFloat($('#item_detail > tbody > tr').length+1);



                    trHtml='<tr id="'+id+'">'



                        +'<td><input type="checkbox" class="qc_item_select" name="qc_item_select[]" value="1" checked/><input type="hidden" class="po_item_id" name="po_item_id[]" value="'+items.po_item_id+'" />'+items.po_ref_no+'</td>'







                        +'<td>'+items.karigar+'</td>'







                        +'<td>'+items.product_name+'</td>'







                        +'<td>'+items.design_name+'</td>'







                        +'<td>'+items.sub_design_name+'</td>'







                        +'<td><input type="number" class="form-control qc_issue_pcs" value="'+items.issue_pcs+'"><input type="hidden" class="act_pcs" value="'+blc_pcs_for_issue+'">Avail Pcs :'+blc_pcs_for_issue+'</td>'







                        +'<td><input type="number" class="form-control qc_issue_gross_wt" value="'+items.issue_gwt+'"><input type="hidden" class="act_gwt" value="'+blc_gwt_for_issue+'">'+blc_gwt_for_issue+'</td>'



                        /*+'<td><input type="number" class="form-control qc_issue_less_wt" value="'+items.less_wt+'">'+items.less_wt+'</td>'*/







                        +'<td><div class="form-group"><div class="input-group "><input class="form-control custom-inp add_less_wt" value="'+ parseFloat(stone_wt).toFixed(3) +'" onClick="create_new_empty_qc_issue_stone_item($(this).closest(\'tr\'));"  type="number" name="item[less_wt][]" step="any" readonly /><span class="input-group-addon input-sm add_tag_lwt" onClick="create_new_empty_qc_issue_stone_item($(this).closest(\'tr\'));">+</span></div><input type="hidden" class="stone_details" value='+JSON.stringify(stone_details)+'><input type="hidden" class="qc_issue_less_wt" value="'+ parseFloat(stone_wt).toFixed(3) +'"></div></td>'











                        +'<td><input type="number" class="form-control qc_issue_net_wt" value="'+items.issue_nwt+'" disabled><input type="hidden" class="act_nwt" value="'+blc_nwt_for_issue+'">'+blc_nwt_for_issue+'</td>'







                        +'<td><a href="#" onClick="remove_qc_item($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'







                    +'</tr>';



                    if($('#item_detail > tbody  > tr').length>0)



                    {



                        $('#item_detail > tbody > tr:first').before(trHtml);



                    }else{



                        $('#item_detail tbody').append(trHtml);



                    }







                }



            });



            calculate_qu_issue_row_details();



            $(".overlay").css("display", "none");



        },



        error:function(error)



        {



        }



    });







}



function get_qcReceiptDetails()



{



    my_Date = new Date();



	$.ajax({



		url: base_url + "index.php/admin_ret_purchase/qc_issue_receipt/qcReceiptEdit",



		data: ({'id_qc_issue':ctrl_page[3]}),



		type: "POST",



		dataType: "JSON",



		cache: false,



		success: function (data)



        {



            $('#select_ref_no').prop('disabled',true);



            if(data.length>0)



			{



                $.each(data,function(key,items)



                {



                    var rowExists=false;



                    var trHtml='';



                    $('#item_detail > tbody tr').each(function(bidx, brow){



                        curRow = $(this);



                        if(curRow.find('.po_item_id').val()==items.po_item_id)



                        {



                            rowExists=true;



                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});



                        }



                    });



                    if(!rowExists)



                    {



                       let stone_details=(items.stone_details);



                       var stone_wt = 0;



                       var id = parseFloat($('#item_detail > tbody tr').length+1);



			            trHtml='<tr id="'+id+'" class="'+items.id_qc_issue_details+'">'







                            +'<td><input type="hidden" class="id_qc_issue_details"  name="order_items[id_qc_issue_details][]" value="'+items.id_qc_issue_details+'"/><input type="hidden" name="order_items[no_of_pcs][]" class="no_of_pcs" value="'+items.issue_pcs+'"><input type="hidden" name="order_items[gross_wt][]" class="gross_wt" value="'+items.issue_gwt+'"><input type="hidden" name="order_items[net_wt][]" class="net_wt" value="'+items.issue_nwt+'"><input type="hidden" name="order_items[less_wt][]" class="less_wt" value="'+items.issue_lwt+'">'+items.po_item_id+'</td>'







                            +'<td>'+items.product_name+'</td>'







                            +'<td>'+items.design_name+'</td>'







                            +'<td>'+items.sub_design_name+'</td>'







                            +'<td>'+items.issue_pcs+'</td>'







                            +'<td>'+items.issue_gwt+'</td>'







                            +'<td>'+items.issue_lwt+'</td>'







                            +'<td>'+items.issue_nwt+'</td>'







                            +'<td><input type="number" name="order_items[failed_pcs][]" class="form-control failed_pcs" value="'+items.failed_pcs+'" style="width: 100px;"></td>'







                            +'<td><input type="number" name="order_items[failed_gwt][]" class="form-control failed_gwt" value="'+items.failed_gwt+'" style="width: 100px;"></td>'







                            +'<td><div class="form-group" style="width: 100px;"><div class="input-group "><input class="form-control custom-inp failed_lwt" name="order_items[failed_lwt][]" value="'+items.failed_lwt+'" onClick="create_new_empty_qc_receipt_stone_item($(this).closest(\'tr\'));"  type="number" name="item[less_wt][]" step="any" readonly /><span class="input-group-addon input-sm add_tag_lwt" onClick="create_new_empty_qc_receipt_stone_item($(this).closest(\'tr\'));">+</span></div><input type="hidden" name="order_items[stone_details][]" class="stone_details" value=\''+JSON.stringify(stone_details)+'\' ><input type="hidden" class="qc_issue_less_wt" value=""></div></td>'







                            +'<td><input type="number" name="order_items[failed_nwt][]" class="form-control failed_nwt" value="'+items.failed_nwt+'" style="width: 100px;" readonly></td>'







                            +'<td><input type="number" name="order_items[qc_acc_pcs][]" class="form-control qc_acc_pcs" value="'+items.passed_pcs



                            +'" readonly style="width: 100px;" ></td>'







                            +'<td><input type="number" name="order_items[qc_acc_gwt][]" class="form-control qc_acc_gwt" value="'+items.passed_gwt+'" readonly style="width: 100px;" ></td>'







                            +'<td><input type="number" name="order_items[qc_acc_lwt][]" class="form-control qc_acc_lwt" value="'+items.passed_lwt+'" readonly style="width: 100px;" ></td>'







                            +'<td><input type="number" name="order_items[qc_acc_nwt][]" class="form-control qc_acc_nwt" value="'+items.passed_nwt



                            +'" readonly style="width: 100px;" ></td>'







                        +'</tr>';



			            $('#item_detail tbody').append(trHtml);



                    }



                });



            }else



			{



			    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found."});



			}



			$("div.overlay").css("display", "none");



        },



        error:function(error)



        {



            $("div.overlay").css("display", "none");



        }



    });



}



//weight gain / loss report



$('#weight_gain_report_search').on('click',function(){



    get_weight_gain_loss_report();



});



function get_weight_gain_loss_report() {



    var company_name = $('#company_name').val();



	var from_date = $('#rpt_payments1').html();



	var to_date = $('#rpt_payments2').html();



	var branch_name = ''



	var report_name = "Weight Gain / Loss Report"



	var optional = '';



	var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"



		+ "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";



	$("div.overlay").css("display", "block");



	my_Date = new Date();



	$.ajax({



		url: base_url + "index.php/admin_ret_purchase/weight_gain_loss/ajax?nocache=" + my_Date.getUTCSeconds(),



		data: ({ 'from_date': $('#rpt_payments1').html(), 'to_date': $('#rpt_payments2').html(), 'id_karigar': $('#select_karigar').val(),'grn_type': $('#grn_type').val() }),



		type: "POST",



		dataType: "JSON",



		cache: false,



		success: function (data) {



		    var a = 1;



            var list = data.list;







            var val = data.summary;



            $('.blc_pcs').html(money_format_india(val.blc_pcs));



		    $('.blc_gwt').html(money_format_india(parseFloat(val.blc_gwt).toFixed(3)));



		    $('.blc_nwt').html(money_format_india(parseFloat(val.blc_nwt).toFixed(3)));



		    $('.blc_diawt').html(money_format_india(parseFloat(val.blc_diawt).toFixed(3)));







		    $('.lot_pcs').html(money_format_india(parseFloat(val.lot_pcs).toFixed(0)));



		    $('.lot_gwt').html(money_format_india(parseFloat(val.lot_gwt).toFixed(3)));



		    $('.lot_nwt').html(money_format_india(parseFloat(val.lot_nwt).toFixed(3)));



		    $('.lot_diawt').html(money_format_india(parseFloat(val.lot_dia_wt).toFixed(3)));



		    $('.tag_pcs').html(money_format_india(parseFloat(val.tag_pcs).toFixed(0)));



		    $('.tag_gwt').html(money_format_india(parseFloat(val.tag_gwt).toFixed(3)));



		    $('.tag_nwt').html(money_format_india(parseFloat(val.tag_nwt).toFixed(3)));



		    $('.tag_diawt').html(money_format_india(parseFloat(val.tag_dia_wt).toFixed(3)));



		    $('.closing_pcs').html(money_format_india(parseFloat(val.gl_pcs).toFixed(0)));



		    $('.closing_gwt').html(money_format_india(parseFloat(val.gl_gwt).toFixed(3)));



		    $('.closing_nwt').html(money_format_india(parseFloat(val.gl_nwt).toFixed(3)));



		    $('.closing_diawt').html(money_format_india(parseFloat(val.gl_diawt).toFixed(3)));







            var oTable = $('#weight_gain_loss_table').DataTable();



            oTable.clear().draw();



            if (list != null && list.length > 0) {



                oTable = $('#weight_gain_loss_table').dataTable({



                    "bDestroy": true,



                    "bInfo": true,



                    "bFilter": true,



                    "bSort": true,



                    "ordering": false,



                    "dom": 'lBfrtip',



                    "columnDefs": [



        				{



        					targets: [2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],



        					className: 'dt-body-right'



        				}



        			],



                    "buttons": [



                        {



                            extend: 'print',



                            footer: true,



                            title: '',



                            messageTop: title,



                            customize: function (win) {



                                $(win.document.body).find('table')



                                    .addClass('compact')



                                    .css('font-size', '10px');



                            },



                        },



                        {



                            extend: 'excel',



                            footer: true,



                            title: 'Weight Gain/Loss Report',



                        },



                        {



                            extend: 'colvis',



                            collectionLayout: 'fixed columns',



                            collectionTitle: 'Column visibility control'



                        },



                    ],



                    "tableTools": { "buttons": [{ "sExtends": "xls", "oSelectorOpts": { page: 'current' } }, { "sExtends": "pdf", "oSelectorOpts": { page: 'current' } }] },



                    "aaData": list,



                    "aoColumns": [







                        { "mDataProp": "lot_no" },



                        { "mDataProp": "lot_date" },



                        {



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.blc_pcs);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.blc_gwt);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.blc_nwt);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.blc_diawt);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.lot_pcs);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.lot_gwt);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.lot_nwt);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.lot_diawt);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.tag_pcs);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.tag_gwt);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.tag_nwt);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.tag_diawt);



            				}



            			},







                        {



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.gl_pcs);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.gl_gwt);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.gl_nwt);



            				}



            			},



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(parseFloat(row.gl_diawt).toFixed(3));



            				}



            			}



                    ],



                    "footerCallback": function( row, data, start, end, display )



        			{



        				if(data.length>0){



        					var api = this.api(), data;



        					for( var i=0; i<=data.length-1;i++){



        						var intVal = function ( i ) {



        							return typeof i === 'string' ?



        							i.replace(/[\$,]/g, '')*1 :



        							typeof i === 'number' ?



        							i : 0;



        						};







        						$(api.column(0).footer() ).html('Total');







        						op_pcs = api



        						.column(2)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(2).footer()).html(parseFloat(op_pcs));







        						op_gwt = api



        						.column(3)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(3).footer()).html(parseFloat(op_gwt).toFixed(3));







        						op_nwt = api



        						.column(4)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(4).footer()).html(parseFloat(op_nwt).toFixed(3));







        						op_diawt = api



        						.column(5)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(5).footer()).html(parseFloat(op_diawt).toFixed(3));







        						lot_pcs = api



        						.column(6)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(6).footer()).html(parseFloat(lot_pcs).toFixed(0));







        						lot_gwt = api



        						.column(7)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(7).footer()).html(parseFloat(lot_gwt).toFixed(3));







        						lot_nwt = api



        						.column(8)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(8).footer()).html(parseFloat(lot_nwt).toFixed(3));







        						lot_diawt = api



        						.column(9)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(9).footer()).html(parseFloat(lot_diawt).toFixed(3));







        						tag_pcs = api



        						.column(10)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(10).footer()).html(parseFloat(tag_pcs).toFixed(0));







        						tag_gwt = api



        						.column(11)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(11).footer()).html(parseFloat(tag_gwt).toFixed(3));







        						tag_nwt = api



        						.column(12)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(12).footer()).html(parseFloat(tag_nwt).toFixed(3));







        						tag_diawt = api



        						.column(13)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(13).footer()).html(parseFloat(tag_diawt).toFixed(3));







        						blc_pcs = api



        						.column(14)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(14).footer()).html(parseFloat(blc_pcs).toFixed(0));







        						blc_gwt = api



        						.column(15)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(15).footer()).html(parseFloat(blc_gwt).toFixed(3));







        						blc_nwt = api



        						.column(16)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(16).footer()).html(parseFloat(blc_nwt).toFixed(3));







        						blc_diawt = api



        						.column(17)



        						.data()



        						.reduce( function (a, b) {



        							return intVal(a) + intVal(b);



        						}, 0 );



        						$(api.column(17).footer()).html(parseFloat(blc_diawt).toFixed(3));







        				}



        				}else{



        					 var api = this.api(), data;







        				}



        			}



                });



            }



            $("div.overlay").css("display", "none");



		},



		error: function (error) {



			$("div.overlay").css("display", "none");



		}



	});



}



//weight gain / loss report



/*Karigar Metal Issue New Form*/



$('#select_supplier_po_no').on('change',function()



{



    if(this.value!='')



    {



        get_Available_SupplierPo();



    }



});





function open_hide_metal_issue_filter()

{

    $('#metal_details > tbody').empty();

    $('.mt_po_no').css("display","none");

    $('.issue_from').css("display","none");



    $('.tag_issue_from').css("display","none");

    $('.mt_tag_issue').css("display","none");

    $('.tag_search').css("display","none");

    $('.mt_bt_issue').css("display","none");



    $('.nontag_issue_from').css("display","none");



    var issue_against_po = $("input[type='radio'][name='issue[issue_against_po]']:checked").val(); //0-No,1-Against Supplier Bill entry

    var issue_from = $("input[type='radio'][name='issue[issue_from]']:checked").val();

    var tag_issue_from = $("input[type='radio'][name='issue[tag_issue_from]']:checked").val();

    var nontag_issue_from = $("input[type='radio'][name='issue[nontag_issue_from]']:checked").val();

    if(issue_against_po==1)

    {

        $('.mt_po_no').css("display","block");

        get_karigar_SupplierEntrys();

        $('#select_supplier_po_no').prop('disabled',false);

    }

    else

    {

        $('.issue_from').css("display","block");



        if(issue_from==1)

        {

            $('.tag_search').css("display","block");

            $('.tag_issue_from').css("display","block");

            if(tag_issue_from==1)

            {

                $('.tag_issue_from').css("display","block");

                $('.mt_tag_issue').css("display","block");

            }

            else if(tag_issue_from==2 || tag_issue_from==3 || tag_issue_from==4)

            {

                $('.mt_bt_issue').css("display","block");



            }

        }

        else if(issue_from==2)

        {

            $('.nontag_issue_from').css("display","block");

            if(nontag_issue_from==1)

            {

                Create_New_Karigar_Metal_Issue();

                $('.nontag_issue_from').css("display","block");

            }

            else if(nontag_issue_from==2 || nontag_issue_from==3)

            {

                $('.mt_bt_issue').css("display","block");

                $('.tag_search').css("display","block");

            }



        }

    }

    calculateMetalIssueTotal();

}







$("input[name='issue[issue_against_po]']:radio").on('change',function()

{

    open_hide_metal_issue_filter();

});



function get_Available_SupplierPo()



{



    my_Date = new Date();



	$.ajax({



		url: base_url + "index.php/admin_ret_purchase/get_Available_SupplierPo/ajax?nocache=" + my_Date.getUTCSeconds(),



		data: ({ 'po_id': $('#select_supplier_po_no').val(),'fin_year':$('#pur_fin_year_select').val()}),



		type: "POST",



		dataType: "JSON",



		cache: false,



		success: function (data)



        {



            available_po_metal_stock = data;



            if(data.length>0)



            {



                $('.available_pcs').html(data[0].no_of_pcs);



                $('.available_weight').html(data[0].net_wt);



            }



            else



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Stock Not Available.."});



            }



            Create_New_Karigar_Metal_Issue();



        }



    });



}



function Create_New_Karigar_Metal_Issue()



{



   var id_branch = $("#select_branch").val();



    $('#metal_details > tbody').empty();



    var is_against_opening = $("input[type='radio'][name='issue[is_against_opening]']:checked").val();



    if(is_against_opening==0){



         var stock_details = available_metal_stock;



    }else{



         var stock_details = available_metal_opening_stock;



    }



    if(($("input[type='radio'][name='issue[issue_against_po]']:checked").val()==0) || ($('#is_supplierbill_entry_req').val()==0)) // Not Against Supplier Po // Non Tag Items



    {



        $.each(stock_details,function (key, item)



        {



            if(id_branch == item.id_branch ) {



                var purity = "<option value=''>-Select Purity-</option>";



                $.each(item.purity, function (pkey, pitem) {



                    purity += "<option value='"+pitem.id_purity+"'>"+pitem.purity+"</option>";



                });



                var id_smith_company_op_balance = (item.id_smith_company_op_balance!=undefined ? item.id_smith_company_op_balance :'');



                var trHtml='';



                trHtml+='<tr>'



                    +'<td><input type="checkbox" class="id_kar_issue" name="metal_details[id_kar_issue][]" value=""></td>'



                    +'<td></td>'



                    +'<td>'+(item.karigar_name!='' && item.karigar_name!=undefined ? item.karigar_name :'')+'</td>'



                    +'<td><input type="hidden" class="metal" name="metal_details[metal][]" value="'+item.id_metal+'"><input type="hidden" class="category" name="metal_details[category][]" value="'+item.cat_id+'">'+item.category_name+'<input type="hidden" class="issue_against" name="metal_details[issue_against][]" value="'+$("input[type='radio'][name='issue[issue_aganist]']:checked").val()+'"><input type="hidden" class="issue_against_po" name="metal_details[issue_against_po][]" value="'+$("input[type='radio'][name='issue[issue_against_po]']:checked").val()+'"><input type="hidden" class="po_item_id" name="metal_details[po_item_id][]" value=""></td>'







                    +'<td><input type="hidden" class="id_smith_company_op_balance" name="metal_details[id_smith_company_op_balance][]" value="'+id_smith_company_op_balance+'"><input type="hidden" class="id_section" name="metal_details[id_section][]" value="'+item.id_section+'">'+item.section_name+'</td>'







                    +'<td><input type="hidden" class="product" name="metal_details[id_product][]" value="'+item.id_product+'"><input type="hidden" class="design" name="metal_details[id_design][]" value="'+item.design+'"><input type="hidden" class="id_sub_design" name="metal_details[id_sub_design][]" value="'+item.id_sub_design+'">'+item.product_name+'</td>'







                    +'<td><select class="form-control" id="select_purity"  style="width:100%;">'+purity+'</select></td>'







                    +'<td><span><input type="number" class="issue_pcs col-md-6" name="metal_details[pcs][]" value="'+item.no_of_piece+'"><input type="hidden" class="available_pcs col-md-6" name="" value="'+item.no_of_piece+'">of &nbsp;'+ item.no_of_piece +'<br/><span style="font-size:10px;color:red;" class="err"></span></span></td>'







                    +'<td><span><input type="number" class="issue_weight col-md-6" name="metal_details[weight][]" value="'+item.net_wt+'"><input type="hidden" class="available_weight col-md-6" name="" value="'+item.net_wt+'">of &nbsp;'+ item.net_wt +'<br/><span style="font-size:10px;color:red;" class="err"></span></span></td>'







                    +'<td><input type="number" class="pur_weight" id="pur_weight" name="metal_details[pur_weight][]" value=""></td>'







                    +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



                +'</tr>';







                if($('#metal_details > tbody  > tr').length>0)



                {



                    $('#metal_details > tbody > tr:first').before(trHtml);



                }else{



                    $('#metal_details tbody').append(trHtml);



                }



                $('#metal_details > tbody').find('#select_purity').select2();



                $('#metal_details > tbody').find('#select_purity').select2({



                    placeholder: "Purity",



                    allowClear: true



                });





            }



            });







    }



    else // Against Supplier Po No



    {



        console.log('available_po_metal_stock',available_po_metal_stock);



        $.each(available_po_metal_stock,function (key, item)



        {



            var uom_list = "<option value=''>-UOM-</option>";



            $.each(uom_details, function (pkey, pitem)



            {



                var uom_selected ="";



                if(item.uom == pitem.uom_id)



                {



                    uom_selected = "selected='selected'";



                }



                uom_list += "<option value='"+pitem.uom_id+"' "+uom_selected+">"+pitem.uom_name+"</option>";



            });



            var purity = "<option value=''>-Select Purity-</option>";



            $.each(item.purity, function (pkey, pitem)



            {



                var purity_selected ="";



                if(item.id_purity == pitem.id_purity)



                {



                    purity_selected = "selected='selected'";



                }



                purity += "<option value='"+pitem.id_purity+"' "+purity_selected+">"+pitem.purity+"</option>";



            });





            var purewt = 0;



            var trHtml='';



            trHtml+='<tr>'



                +'<td style="width:100px;"><input type="checkbox" class="id_kar_issue" name="metal_details[id_kar_issue][]" value="">'+item.po_ref_no+'</td>'





                +'<td>'+item.po_date+'</td>'





                +'<td>'+item.karigar+'</td>'







                +'<td style="width:100px;"><input type="hidden" class="metal" name="metal_details[metal][]" value="'+item.id_metal+'"><input type="hidden" class="category" name="metal_details[category][]" value="'+item.cat_id+'">'+item.category_name+'<input type="hidden" class="issue_against" name="metal_details[issue_against][]" value="'+$("input[type='radio'][name='issue[issue_aganist]']:checked").val()+'"><input type="hidden" class="issue_against_po" name="metal_details[issue_against_po][]" value="'+$("input[type='radio'][name='issue[issue_against_po]']:checked").val()+'"><input type="hidden" class="po_item_id" name="metal_details[po_item_id][]" value="'+item.po_item_id+'"></td>'







                +'<td style="width:100px;"><input type="hidden" class="id_section" name="metal_details[id_section][]" value="'+item.id_section+'">'+item.section_name+'</td>'







                +'<td style="width:100px;"><input type="hidden" class="product" name="metal_details[id_product][]" value="'+item.id_product+'"><input type="hidden" class="design" name="metal_details[id_design][]" value="'+item.design+'"><input type="hidden" class="id_sub_design" name="metal_details[id_sub_design][]" value="'+item.id_sub_design+'">'+item.product_name+'</td>'







                +'<td><select class="form-control" id="select_purity"  style="width:100px;">'+purity+'</select></td>'







                +'<td><div class="input-group"><span><input type="number" class="issue_pcs form-control" style="width:100px;"name="metal_details[pcs][]" value="'+item.no_of_piece+'"><input type="hidden" class="available_pcs form-control" name="" value="'+item.no_of_piece+'"></span><span>&nbsp; of &nbsp;'+ item.no_of_piece +'<br/></span></div></td>'



                +'<td><div class="input-group"><span><input class="issue_weight form-control" type="number" name="metal_details[weight][]" value="'+item.net_wt+'" style="width:80px;"/><input type="hidden" class="available_weight" name="" value="'+item.net_wt+'"><select class="uom_id form-control" name="metal_details[uom_id][]" style="width: 80px;">'+uom_list+'</select></span><span>&nbsp; of &nbsp;'+ item.net_wt +'<br/></span></div></td>'







                +'<td><input type="number" class="pur_weight form-control" id="pur_weight" name="metal_details[pur_weight][]" value="'+purewt+'" style="width:80px;"></td>'







                +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



            +'</tr>';







            if($('#metal_details > tbody  > tr').length>0)



            {



                $('#metal_details > tbody > tr:first').before(trHtml);



            }else{



                $('#metal_details tbody').append(trHtml);



            }



            $('#metal_details > tbody').find('#select_purity').select2();



            $('#metal_details > tbody').find('#select_purity').select2({



                placeholder: "Purity",



                allowClear: true



            });



        });



    }



    calculateMetalIssuePureWt();

    calculateMetalIssueTotal();







}



$(document).on('input',".issue_pcs", function()



{



    var row = $(this).closest('tr');



    blc = parseFloat(row.find('.available_pcs').val());



    if($(this).val() > blc)



    {



        row.find('.err').text('Invalid');



        row.find('.issue_pcs').val(blc);



    }



    else



    {



        row.find('.err').text('');



        calculateMetalIssuePureWt();



    }



    calculateMetalIssueTotal();



});



$(document).on('input',".issue_weight", function()



{



    var row = $(this).closest('tr');



    blc = parseFloat(row.find('.available_weight').val());



    if($(this).val() > blc)



    {



        row.find('.err').text('Invalid');



        row.find('.issue_weight').val(blc);



    }



    else



    {



        row.find('.err').text('');



        calculateMetalIssuePureWt();



    }



    calculateMetalIssueTotal();



});



$(document).on('change','#select_purity',function()

{

    if(ctrl_page[1]=='karigarmetalissue')

    {

        var row = $(this).closest('tr');

        row.find('#select_purity').val(this.value);



        calculateMetalIssuePureWt();

    }

})





function calculateMetalIssuePureWt()

{

    $("#metal_details > tbody  > tr").each(function ()

    {

        var row = $(this).closest('tr');

        console.log('purity',row.find('#select_purity').val());

        var issue_pcs = (isNaN(row.find('.issue_pcs').val()) || row.find('.issue_pc').val()=='' ? 0:row.find('.issue_pcs').val());

        var tot_weight = (isNaN(row.find('.issue_weight').val()) || row.find('.issue_weight').val()=='' ? 0:row.find('.issue_weight').val());

        var purity     = (isNaN(row.find('#select_purity').val()) || row.find('#select_purity').val()=='' ? 0:row.find('#select_purity option:selected').text());

        var purewt = parseFloat((parseFloat(tot_weight) * (parseFloat(purity))) / 100).toFixed(3);

        row.find('#pur_weight').val(purewt);

    });

}



function calculateMetalIssueTotal()



{



    var issue_tot_pcs = 0;



    var issue_tot_wt = 0;



    $("#metal_details > tbody  > tr").each(function ()



    {



        var row = $(this).closest('tr');



        issue_tot_pcs = issue_tot_pcs + (isNaN(row.find('.issue_pcs').val() ) ? 0 : parseFloat(row.find('.issue_pcs').val()));



        issue_tot_wt = issue_tot_wt + (isNaN( row.find('.issue_weight').val() ) ? 0 : parseFloat(row.find('.issue_weight').val()));



    });



    $(".issue_tot_pcs").html(issue_tot_pcs);



    $(".issue_tot_wt").html(parseFloat(issue_tot_wt).toFixed(3));



}



function karigarMetalIssueSave(approved_items)



{



    $("div.overlay").css("display", "block");



    var postData = {};



    var id_karigar = $('#select_karigar').val();



    var id_branch = $('#select_branch').val();



    var id_order = $('#select_po_no').val();



    var po_id = $('#select_supplier_po_no').val();



    var is_against_order = $("input[type='radio'][name='issue[issue_aganist]']:checked").val(); //1-Against Order,0-No



    var issue_against_po = $("input[type='radio'][name='issue[issue_against_po]']:checked").val(); //0-No,1-Against Supplier Bill entry



    var metal_issue_type =  $("input[type='radio'][name='issue[metal_issue_type]']:checked").val(); //1-Normal Issue,2-Approval Issue



    var issue_from = $("input[type='radio'][name='issue[issue_from]']:checked").val();



    var tag_issue_from = $("input[type='radio'][name='issue[tag_issue_from]']:checked").val();



    var nontag_issue_from = $("input[type='radio'][name='issue[nontag_issue_from]']:checked").val();



    var is_stock_repair_order = $("#is_stock_repair_order").val();



    var is_against_opening = $("input[type='radio'][name='issue[is_against_opening]']:checked").val();



    var remark = $('#remark').val();







    postData={'is_against_opening':is_against_opening,'id_branch':id_branch,'is_stock_repair_order':is_stock_repair_order,'issued_items':approved_items,'id_karigar':id_karigar,'id_order':id_order,'po_id':po_id,'is_against_order':is_against_order,'issue_against_po':issue_against_po,'remark':remark,'metal_issue_type':metal_issue_type,'issue_from':issue_from,'tag_issue_from':tag_issue_from,'nontag_issue_from':nontag_issue_from};



    var url=base_url+ "index.php/admin_ret_purchase/karigarmetalissue/save?nocache=" + my_Date.getUTCSeconds();



    $.ajax({



        url:url,



        data: postData,



        type:"POST",



        dataType:"JSON",



        success:function(data){



            if(data.status)



            {



                $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                window.location.href= base_url+'index.php/admin_ret_purchase/karigarmetalissue/list';



                window.open( base_url+'index.php/admin_ret_purchase/karigarmetalissue_acknowladgement/'+data.insId,'_blank');



                $("div.overlay").css("display", "none");



            }else



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                $("div.overlay").css("display", "none");



            }







        },



        error:function(error)



        {



            $("div.overlay").css("display", "none");



        }



    });



}



function validateMetalIssueRow(){



	var row_validate = true;



	$('#metal_details > tbody  > tr').each(function(index, tr) {



        if($(this).find("input[name='metal_details[id_kar_issue][]']:checked").is(":checked"))



        {



            if($(this).find('#select_purity').val() == "" || $(this).find('.uom_id ').val() == "")



            {



                row_validate = false;



            }



        }







	});



	return row_validate;



}



$("input[name='issue[issue_from]']:radio").on('change',function()

{

    open_hide_metal_issue_filter();

});





$("input[name='issue[tag_issue_from]']:radio").on('change',function()

{

    open_hide_metal_issue_filter();

});



$("input[name='issue[nontag_issue_from]']:radio").on('change',function()

{

    open_hide_metal_issue_filter();

})



function getAvailableTagDetails(tag_id,old_tag_id)

{

    $("div.overlay").css("display", "block");

    var my_Date = new Date();

    $.ajax({

        url:base_url+ "index.php/admin_ret_reports/tag_history/ajax?nocache=" + my_Date.getUTCSeconds(),

        dataType: "json",

        method: "POST",

        data: {'tag_id': tag_id,'old_tag_id': old_tag_id},

        success: function (data)

        {

            if(data.list.length>0)

			{

                var rowExists=false;

                var trHtml='';

                $.each(data.list, function(key,item)

                {



                    if(item.tagging_status==15) // Metal issued tag

                    {

                        rowExists=true;

                        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Issued.."});

                    }



                    $('#metal_details > tbody tr').each(function(bidx, brow)

                    {

                        curRow = $(this);

                        if(curRow.find('.tag_id').val()==item.tag_id)

                        {

                            rowExists=true;

                            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});

                        }

                    });



                    var uom_list = "<option value=''>-UOM-</option>";

                    $.each(uom_details, function (pkey, pitem)

                    {

                        var uom_selected ="";

                        if(pitem.uom_id==item.uom)

                        {

                            uom_selected = "selected='selected'";

                        }

                        uom_list += "<option value='"+pitem.uom_id+"' "+uom_selected+">"+pitem.uom_name+"</option>";

                    });



                    var purity = "<option value='"+item.id_purity+"'>"+item.purity+"</option>";

                    var purewt = 0;

                    if(!rowExists)

                    {

                        trHtml+='<tr>'



                            +'<td style="width:100px;"><input type="checkbox" class="id_kar_issue" name="metal_details[id_kar_issue][]" value="">' +item.tag_code+ '<input type="hidden" class="tag_id" name="metal_details[tag_id][]" value="'+item.tag_id+'"></td>'



                            +'<td>'+item.tag_date+'</td>'



                            +'<td>'+item.supplier_name+'</td>'



                            +'<td style="width:100px;"><input type="hidden" class="metal" name="metal_details[metal][]" value="'+item.id_metal+'"><input type="hidden" class="category" name="metal_details[category][]" value="'+item.cat_id+'">'+item.catname+'<input type="hidden" class="issue_against" name="metal_details[issue_against][]" value="'+$("input[type='radio'][name='issue[issue_aganist]']:checked").val()+'"><input type="hidden" class="issue_against_po" name="metal_details[issue_against_po][]" value="'+$("input[type='radio'][name='issue[issue_against_po]']:checked").val()+'"><input type="hidden" class="po_item_id" name="metal_details[po_item_id][]" value=""></td>'



                            +'<td style="width:100px;"><input type="hidden" class="id_section" name="metal_details[id_section][]" value="'+item.id_section+'">'+item.section+'</td>'



                            +'<td style="width:100px;"><input type="hidden" class="product" name="metal_details[id_product][]" value="'+item.pro_id+'"><input type="hidden" class="design" name="metal_details[id_design][]" value="'+item.des_id+'"><input type="hidden" class="id_sub_design" name="metal_details[id_sub_design][]" value="'+item.id_sub_design+'">'+item.product_name+'</td>'



                            +'<td><select class="form-control" id="select_purity"  style="width:100px;">'+purity+'</select></td>'



                            +'<td><div class="input-group"><span><input type="number" class="issue_pcs form-control" style="width:100px;"name="metal_details[pcs][]" value="'+item.piece+'" readonly><input type="hidden" class="available_pcs form-control" name="" value="'+item.piece+'"></span><span>&nbsp; of &nbsp;'+item.piece+'<br/></span></div></td>'



                            +'<td><div class="input-group"><span><input class="issue_weight form-control" type="number" name="metal_details[weight][]" value="'+item.weight+'" style="width:80px;" readonly/><input type="hidden" class="available_weight" name="" value="'+item.weight+'"><select class="uom_id form-control" name="metal_details[uom_id][]" style="width: 80px;">'+uom_list+'</select></span><span>&nbsp; of &nbsp;'+ item.weight +'<br/></span></div></td>'



                            +'<td><input type="number" class="pur_weight form-control" id="pur_weight" name="metal_details[pur_weight][]" value="'+purewt+'" style="width:80px;" readonly></td>'



                            +'<td><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



                        +'</tr>';



                        if($('#metal_details > tbody  > tr').length>0)

                        {

                            $('#metal_details > tbody > tr:first').before(trHtml);

                        }else{

                            $('#metal_details tbody').append(trHtml);

                        }



                        $('#metal_details > tbody').find('#select_purity').select2();



                        $('#metal_details > tbody').find('#select_purity').select2({



                            placeholder: "Purity",



                            allowClear: true



                        });



                        $("div.overlay").css("display", "none");

                    }

                });

            }

            else

            {

                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found.."});

				$("div.overlay").css("display", "none");

            }

            $("div.overlay").css("display", "none");

            $('#tag_code').val('');

			$('#old_tag_code').val('');



            calculateMetalIssuePureWt();

            calculateMetalIssueTotal();

        }

    });



}



/*Karigar Metal Issue New Form*/



/*Supplier Bill EntrY Loose Diamond*/



$('#aganist_supplier_issue').on('change',function()



{



    $('.metalissse_product').css('display','none');



    if(this.checked)



    {



        $('#select_issue_ref_no').prop('disabled',false);



        getKarigarIssueRefNo();



        $('#estimation_stone_cus_item_details > tbody').empty();



        $('.metalissse_product').css('display','block');



        $('#aganist_supplier_issue').val(1);



        $('.stn_add').css('display','block');



    }



    else



    {



        $('#select_issue_ref_no').prop('disabled',true);



        $('#select_issue_ref_no').select2('val','');



        $('#estimation_stone_cus_item_details > tbody').empty();



        create_new_empty_stone_item();



        $('#aganist_supplier_issue').val(0);



        $('.stn_add').css('display','none');



    }



})



function getKarigarIssueRefNo()



{



    $("div.overlay").css("display", "block");



    $('#select_issue_ref_no option').remove();



    $('#select_metalissueref_no option').remove();



    $.ajax({



    type: 'POST',



    url: base_url+'index.php/admin_ret_purchase/getKarigarIssueRefNo',



    data:{'id_karigar':$('#id_karigar').val()},



    dataType:'json',



    success:function(data){



        var id=$('#select_issue_ref_no').val();



        var mt_id = $('#select_metalissueref_no').val();



        $.each(data, function (key, item) {



            $("#select_issue_ref_no,#select_metalissueref_no").append(



            $("<option></option>")



            .attr("value", item.met_issue_id)



            .text(item.met_issue_ref_id)



            );



        });



        $("#select_issue_ref_no,#select_metalissueref_no").select2(



        {



            placeholder:"Select Issue Ref No",



            closeOnSelect: true



        });







        if($("#select_issue_ref_no").length)



        {



            $("#select_issue_ref_no").select2("val",(id!='' && id>0?id:''));



        }



        if($("#select_metalissueref_no").length)



        {



            $("#select_metalissueref_no").select2("val",(mt_id!='' && mt_id>0?mt_id:''));



        }



            $(".overlay").css("display", "none");



        }



    });



}



$('#select_issue_ref_no').on('change',function()



{



    if(this.value!='')



    {



        get_KarigarMetalIssue_LooseStones(this.value);



    }



});



function get_KarigarMetalIssue_LooseStones(metal_issue_id)



{



    $.ajax({



        type: 'POST',



        url: base_url+'index.php/admin_ret_purchase/getKarigarMetalIssueLooseStones',



        dataType:'json',



        data:{'metal_issue_id':metal_issue_id},



        success:function(data)



        {



            if(data.length>0)



            {



                $.each(data, function (key,item)



                {



                    if(item)



                    {



                        Create_looseDiamonds_stone_row(item);



                    }



                });







            }



        }



    });



}



$('#cus_stoneModal .modal-body #create_karigarissue_stone_item_details').on('click', function()



{



    if(validateStoneCusItemDetailRow())



    {



        Create_looseDiamonds_stone_row();



    }



    else



    {



        alert("Please fill required fields");



    }



});



function Create_looseDiamonds_stone_row(stone_data=[])



{



    console.log('stone_data',stone_data);



    console.log('len',$('#item_detail tbody tr').length);







    var supplier_bill_entry_calc = $('#supplier_bill_entry_calc').val();



    var stones_list = "<option value=''> -Select Stone- </option>";



    var stones_type = "<option value=''>-Stone Type-</option>";



    var uom_list = "<option value=''>-UOM-</option>";



    var quality_list = "<option value=''>-Quality-</option>";



    var disable_quality = (stone_data ? (stone_data.stones_type == 1 ? '': 'disabled') : 'disabled');







    var clarity="";



    var color ="";



    var cut ="";



    var shape ="";



    $.each(stones, function (pkey, pitem) {



        stones_list += "<option value='"+pitem.stone_id+"' "+(stone_data ? (pitem.stone_id == stone_data.stone_id ? 'selected' : '') : '')+">"+pitem.stone_name+"</option>";



    });



    $.each(uom_details, function (pkey, pitem) {



        uom_list += "<option value='"+pitem.uom_id+"' "+(stone_data ? (pitem.uom_id == stone_data.stone_uom_id ? 'selected' : '') : '')+">"+pitem.uom_name+"</option>";



    });



    $.each(stone_types, function (pkey, pitem) {



        stones_type += "<option value='"+pitem.id_stone_type+"' "+(stone_data ? (pitem.id_stone_type == stone_data.stones_type ? 'selected' : '') : '')+">"+pitem.stone_type+"</option>";



    });



    $.each(quality_code, function (pkey, pitem) {



        quality_list += "<option value='"+pitem.quality_id+"' "+(stone_data ? (pitem.quality_id == stone_data.stone_quality_id ? 'selected' : '') : '')+" >"+pitem.code+"</option>";



        if(pitem.quality_id == stone_data.stone_quality_id)



        {



            clarity=pitem.clarity;



            color=pitem.color;



            cut=pitem.cut;



            shape=pitem.shape;



        }



    });



    var show_in_lwt = (stone_data ? stone_data.show_in_lwt : 1);



    var stone_pcs = (stone_data ? (stone_data.stone_pcs == undefined ? '':stone_data.stone_pcs) : '');



    var stone_wt = (stone_data ? (stone_data.stone_wt == undefined ? '':stone_data.stone_wt) : '');



    var rate = (stone_data ? (stone_data.stone_rate == undefined ? 0:stone_data.stone_rate): 0);



    var price = (stone_data ? (stone_data.stone_price == undefined ? 0:stone_data.stone_price) : 0);



    var cal_type = (stone_data ? (stone_data.stone_cal_type == undefined ? 1:stone_data.stone_cal_type) : 1);



    var product_name = (stone_data ? (stone_data.product_name == undefined ? "" : stone_data.product_name):"");



    var issue_met_id = (stone_data ? (stone_data.issue_met_id == undefined ? "" : stone_data.issue_met_id) : "");







    var summary_stn_pcs = 0;



    var summary_stn_wt = 0;



    var summary_issue_pcs = 0;



    var summary_issue_wt = 0;



    if($('#item_detail tbody tr').length > 0)



    {



        $('#item_detail > tbody  > tr').each(function(index, tr)



        {



            var row = $(this);







            if(stone_data.issue_met_id == row.find('.issue_met_id').val()) // if issue pcs already in items table



            {



                summary_issue_pcs +=parseInt(row.find('.tot_pcs').val());



                summary_issue_wt  +=parseFloat(row.find('.tot_gwt').val()).toFixed(3);



            }







            if(row.find('.stone_details').val()!='') // if issue pcs already in stone detailsitems table



            {



                stone_details = JSON.parse(row.find('.stone_details').val());



                $.each(stone_details,function(key,val)



                {



                    console.log('stn_det',val);



                    if(val.issue_met_id == stone_data.issue_met_id)



                    {



                        summary_stn_pcs += parseInt(val.stone_pcs);



                        summary_stn_wt +=parseFloat(val.stone_wt);



                    }



                });



            }



        });



    }







    stone_pcs = parseInt(parseInt(stone_data.stone_pcs) - parseInt(summary_issue_pcs) - parseInt(summary_stn_pcs));



    stone_wt  = parseFloat(parseFloat(stone_data.stone_wt) - parseFloat(summary_issue_wt) - parseFloat(summary_stn_wt)).toFixed(3);







    var row_cls = $('#estimation_stone_cus_item_details tbody tr').length;



    row = '<tr id="'+$('#estimation_stone_cus_item_details tbody tr').length+'" class="st_'+$('#estimation_stone_cus_item_details tbody tr').length+'">'







        +'<td><input class="show_in_lwt" type="checkbox" name="est_stones_item[show_in_lwt][]" value="'+(show_in_lwt==1 || show_in_lwt == undefined? 1 : 0)+'" '+(show_in_lwt==1 || show_in_lwt == undefined ? 'checked' :'')+' ></td>'







        +'<td style="width:15px;">'+product_name+'<input type="hidden" name="est_stones_item[pro_name][]" class= "pro_name" value="'+product_name+'"><input type="hidden" name="est_stones_item[issue_met_id][]" class= "issue_met_id" value="'+issue_met_id+'"></td>'



        +'<td><select class="stones_type form-control" name="est_stones_item[stones_type][]" style="width:100px;">'+stones_type+'</select></td>'







        +'<td><select class="stone_id form-control" name="est_stones_item[stone_id][]" style="width:100px;">'+stones_list+'</select><input type="hidden" class="stone_type" value=""></td>'







        +'<td><select class="quality_id form-control" name="est_stones_item[quality_id][]" '+disable_quality+' style="width:100px;">'+quality_list+'</select></td>'







        +'<td><input type="number" class="stone_pcs form-control" name="est_stones_item[stone_pcs][]" value="'+stone_pcs+'" style="width: 70px;"/><input type="hidden" class="act_stone_pcs" value="'+stone_pcs+'"></td>'







        +'<td><div class="input-group"><input class="stone_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="'+stone_wt+'" style="width:80px;"/><span class="input-group-btn" ><select class="stone_uom_id form-control" name="est_stones_item[uom_id][]" style="width: 80px;">'+uom_list+'</select></span></div><input type="hidden" class="act_stone_wgt" value="'+stone_wt+'"></td>'







        +'<td><div class="form-group"><input class="stone_cal_type" id="stone_cal_type1" type="radio" name="est_stones_item[cal_type]['+parseFloat(row_cls+1)+']" value="1" '+(cal_type == 1 ? 'checked' : '')+'>Wt&nbsp;<input type="radio" name="est_stones_item[cal_type]['+parseFloat(row_cls+1)+']" class="stone_cal_type" id="stone_cal_type2" value="2" '+(cal_type == 2 ? 'checked' : '')+'>Pcs</div></td>'







        +'<td><span class="stone_cut">'+cut+'</span></td>'







        +'<td><span class="stone_color">'+color+'</span></td>'







        +'<td><span class="stone_clarity">'+clarity+'</span></td>'







        +'<td><span class="stone_shape">'+shape+'</span></td>'







        +'<td><input type="number" class="stone_rate form-control" name="est_stones_item[stone_rate][]" value="'+rate+'" style="width: 100px;" /></td>'







        +'<td><input type="number" class="stone_price form-control" name="est_stones_item[stone_price][]" value="'+price+'" style="width: 100px;" /></td>'







        +'<td><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-xs btn-del"><i class="fa fa-trash"></i></a></td></tr>';







        $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').append(row);



        //$('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody .st_'+row_cls+ '.show_in_lwt').focus();



        $("#cus_stoneModal").on('shown.bs.modal', function(){



        });



        $('#custom_active_id').val("st_"+row_cls);

        $('#estimation_stone_cus_item_details > tbody').find('.stones_type,.stone_id,.quality_id').select2();

        $('#estimation_stone_cus_item_details > tbody').find('.stones_type').select2({

            placeholder: "Stone Type",

            allowClear: true

        });

        $('#estimation_stone_cus_item_details > tbody').find('.stone_id').select2({

            placeholder: "Select Stone",

            allowClear: true

        });

        $('#estimation_stone_cus_item_details > tbody').find('.quality_id').select2({

            placeholder: "Quality",

            allowClear: true

        });



        calculate_total_stone_amount();



}



function Create_New_Empty_looseDiamonds_stone_row(stone_data=[])



{



    var supplier_bill_entry_calc = $('#supplier_bill_entry_calc').val();



    var stones_list = "<option value=''> -Select Stone- </option>";



    var stones_type = "<option value=''>-Stone Type-</option>";



    var uom_list = "<option value=''>-UOM-</option>";



    var quality_list = "<option value=''>-Quality-</option>";



    var disable_quality = (stone_data ? (stone_data.stones_type == 1 ? '': 'disabled') : 'disabled');







    var clarity="";



    var color ="";



    var cut ="";



    var shape ="";



    $.each(stones, function (pkey, pitem) {



        stones_list += "<option value='"+pitem.stone_id+"' "+(stone_data ? (pitem.stone_id == stone_data.stone_id ? 'selected' : '') : '')+">"+pitem.stone_name+"</option>";



    });



    $.each(uom_details, function (pkey, pitem) {



        uom_list += "<option value='"+pitem.uom_id+"' "+(stone_data ? (pitem.uom_id == stone_data.stone_uom_id ? 'selected' : '') : '')+">"+pitem.uom_name+"</option>";



    });



    $.each(stone_types, function (pkey, pitem) {



        stones_type += "<option value='"+pitem.id_stone_type+"' "+(stone_data ? (pitem.id_stone_type == stone_data.stones_type ? 'selected' : '') : '')+">"+pitem.stone_type+"</option>";



    });



    $.each(quality_code, function (pkey, pitem) {



        quality_list += "<option value='"+pitem.quality_id+"' "+(stone_data ? (pitem.quality_id == stone_data.stone_quality_id ? 'selected' : '') : '')+" >"+pitem.code+"</option>";



        if(pitem.quality_id == stone_data.stone_quality_id)



        {



            clarity=pitem.clarity;



            color=pitem.color;



            cut=pitem.cut;



            shape=pitem.shape;



        }



    });



    var show_in_lwt = (stone_data ? stone_data.show_in_lwt : 1);



    var stone_pcs = (stone_data ? (stone_data.stone_pcs == undefined ? '':stone_data.stone_pcs) : '');



    var stone_wt = (stone_data ? (stone_data.stone_wt == undefined ? '':stone_data.stone_wt) : '');



    var rate = (stone_data ? (stone_data.stone_rate == undefined ? 0:stone_data.stone_rate): 0);



    var price = (stone_data ? (stone_data.stone_price == undefined ? 0:stone_data.stone_price) : 0);



    var cal_type = (stone_data ? (stone_data.stone_cal_type == undefined ? 1:stone_data.stone_cal_type) : 1);



    var product_name = (stone_data ? (stone_data.product_name == undefined ? "" : stone_data.product_name):"");



    var issue_met_id = (stone_data ? (stone_data.issue_met_id == undefined ? "" : stone_data.issue_met_id) : "");







    var row_cls = $('#estimation_stone_cus_item_details tbody tr').length;



    row = '<tr id="'+$('#estimation_stone_cus_item_details tbody tr').length+'" class="st_'+$('#estimation_stone_cus_item_details tbody tr').length+'">'







        +'<td><input class="show_in_lwt" type="checkbox" name="est_stones_item[show_in_lwt][]" value="'+(show_in_lwt==1 || show_in_lwt == undefined? 1 : 0)+'" '+(show_in_lwt==1 || show_in_lwt == undefined ? 'checked' :'')+' ></td>'







        +'<td style="width:15px;">'+product_name+'<input type="hidden" name="est_stones_item[pro_name][]" class= "pro_name" value="'+product_name+'"><input type="hidden" name="est_stones_item[issue_met_id][]" class= "issue_met_id" value="'+issue_met_id+'"></td>'



        +'<td><select class="stones_type form-control" name="est_stones_item[stones_type][]" style="width:100px;">'+stones_type+'</select></td>'







        +'<td><select class="stone_id form-control" name="est_stones_item[stone_id][]" style="width:100px;">'+stones_list+'</select><input type="hidden" class="stone_type" value=""></td>'







        +'<td><select class="quality_id form-control" name="est_stones_item[quality_id][]" '+disable_quality+' style="width:100px;">'+quality_list+'</select></td>'







        +'<td><input type="number" class="stone_pcs form-control" name="est_stones_item[stone_pcs][]" value="'+stone_pcs+'" style="width: 80px;"/><input type="hidden" class="act_stone_pcs" value="'+stone_pcs+'"></td>'







        +'<td><div class="input-group"><input class="stone_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="'+stone_wt+'" style="width:80px;"/><span class="input-group-btn" ><select class="stone_uom_id form-control" name="est_stones_item[uom_id][]" style="width: 80px;">'+uom_list+'</select></span></div><input type="hidden" class="act_stone_wgt" value="'+stone_wt+'"></td>'







        +'<td><div class="form-group"><input class="stone_cal_type" id="stone_cal_type1" type="radio" name="est_stones_item[cal_type]['+parseFloat(row_cls+1)+']" value="1" '+(cal_type == 1 ? 'checked' : '')+'>Wt&nbsp;<input type="radio" name="est_stones_item[cal_type]['+parseFloat(row_cls+1)+']" class="stone_cal_type" id="stone_cal_type2" value="2" '+(cal_type == 2 ? 'checked' : '')+'>Pcs</div></td>'







        +'<td><span class="stone_cut">'+cut+'</span></td>'







        +'<td><span class="stone_color">'+color+'</span></td>'







        +'<td><span class="stone_clarity">'+clarity+'</span></td>'







        +'<td><span class="stone_shape">'+shape+'</span></td>'







        +'<td><input type="number" class="stone_rate form-control" name="est_stones_item[stone_rate][]" value="'+rate+'" style="width: 80px;" /></td>'







        +'<td><input type="number" class="stone_price form-control" name="est_stones_item[stone_price][]" value="'+price+'" style="width: 80px;" /></td>'







        +'<td><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-xs btn-del"><i class="fa fa-trash"></i></a></td></tr>';







        $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').append(row);



        //$('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody .st_'+row_cls+ '.show_in_lwt').focus();



        $("#cus_stoneModal").on('shown.bs.modal', function(){



        });



        $('#custom_active_id').val("st_"+row_cls);

        $('#estimation_stone_cus_item_details > tbody').find('.stones_type,.stone_id,.quality_id').select2();

        $('#estimation_stone_cus_item_details > tbody').find('.stones_type').select2({

            placeholder: "Stone Type",

            allowClear: true

        });

        $('#estimation_stone_cus_item_details > tbody').find('.stone_id').select2({

            placeholder: "Select Stone",

            allowClear: true

        });

        $('#estimation_stone_cus_item_details > tbody').find('.quality_id').select2({

            placeholder: "Quality",

            allowClear: true

        });



        calculate_total_stone_amount();



}



$("input[name='aganist_karigar_metal_issue']:radio").on('change',function()



{



    if(ctrl_page[1]=='purchase' && ctrl_page[2]=='purchase_add')



    {



       if(this.value==1)



       {



            $('#select_metalissueref_no').prop('disabled',false);



            $('.metalissueref').css('display','block');



            getKarigarIssueRefNo();



       }



       else



       {



            $('#select_metalissueref_no').prop('disabled',true);



            $('#select_metalissueref_no').select2('val','');



            $('.metalissueref').css('display','none');



        }



    }







});



$('#select_metalissueref_no').on('change',function()



{



    if(this.value!='')



    {



        $('#select_metalissueref_no').val(this.value);



    }



});



$('#metal_issue_search').on('click',function()



{



    var metal_issueRefno = $('#select_metalissueref_no').val();



    getMetalIssueDetails(metal_issueRefno);



})



function getMetalIssueDetails(metal_issue_id)



{



    $('#karigar_metal_issue_table > tbody').empty();



    $.ajax({



        type: 'POST',



        url: base_url+'index.php/admin_ret_purchase/getKarigarMetalIssueLooseStones',



        dataType:'json',



        data:{'metal_issue_id':metal_issue_id},



        success:function(data)



        {



            if(data.length>0)



            {



                $('#other_metal_issue_modal').modal('show');



                var uom_list = "<option value=''>-UOM-</option>";



                $.each(data, function (key,item)



                {



                    $.each(uom_details, function (pkey, pitem)



                    {



                        var uom_selected ="";



                        if(item.stone_uom_id == pitem.uom_id)



                        {



                            uom_selected = "selected='selected'";



                        }



                        uom_list += "<option value='"+pitem.uom_id+"'"+uom_selected+">"+pitem.uom_name+"</option>";



                    });



                    var issue_pcs = 0;



                    var issue_wt = 0;







                    var summary_stn_pcs = 0;



                    var summary_stn_wt = 0;







                    var summary_issue_pcs = 0;



                    var summary_issue_wt = 0;



                    if($('#item_detail tbody tr').length > 0)



                    {



                        $('#item_detail > tbody  > tr').each(function(index, tr)



                        {



                            var row = $(this);







                            if(item.issue_met_id == row.find('.issue_met_id').val()) // if issue pcs already in items table



                            {



                                summary_issue_pcs +=parseInt(row.find('.tot_pcs').val());



                                summary_issue_wt  +=parseFloat(row.find('.tot_gwt').val()).toFixed(3);



                            }







                            if(row.find('.stone_details').val()!='') // if issue pcs already in stone detailsitems table



                            {



                                stone_details = JSON.parse(row.find('.stone_details').val());



                                $.each(stone_details,function(key,val)



                                {



                                    console.log('stn_det',val);



                                    if(val.issue_met_id == item.issue_met_id)



                                    {



                                        summary_stn_pcs += parseInt(val.stone_pcs);



                                        summary_stn_wt +=parseFloat(val.stone_wt);



                                    }



                                });



                            }



                        });



                    }







                    issue_pcs = parseInt(parseInt(item.stone_pcs) - parseInt(summary_issue_pcs) - parseInt(summary_stn_pcs));



                    issue_wt  = parseFloat(parseFloat(item.stone_wt) - parseFloat(summary_issue_wt) - parseFloat(summary_stn_wt)).toFixed(3);







                    var row="";



                    row+='<tr id="detail'+key+'" class="'+key+'">'



                        +'<td>'+item.category+'<input type="hidden" class="cat_name" value="'+item.category+'"><input type="hidden" name="mt_iss[cat_id][]" class= "cat_id" value="'+item.cat_id+'"><input type="hidden" name="mt_iss[issue_met_id][]" class= "issue_met_id" value="'+item.issue_met_id+'"></td>'



                        +'<td>'+item.product_name+'<input type="hidden" class="product_name" value="'+item.product_name+'"><input type="hidden" name="mt_iss[id_product][]" class= "id_product" value="'+item.id_product+'"><input type="hidden" name="mt_iss[pur_mode][]" class= "pur_mode" value="'+item.purchase_mode+'"></td>'



                        +'<td>'+item.design_name+'<input type="hidden" class="design_name" value="'+item.design_name+'"><input type="hidden" name="mt_iss[id_design][]" class= "id_design" value="'+item.id_design+'"></td>'



                        +'<td>'+item.sub_design_name+'<input type="hidden" class="sub_design_name" value="'+item.sub_design_name+'"><input type="hidden" name="mt_iss[id_sub_design][]" class= "id_sub_design" value="'+item.id_sub_design+'"></td>'



                        +'<td>'+item.purity+'<input type="hidden" class="purity" value="'+item.purity+'"><input type="hidden" name="mt_iss[id_purity][]" class= "id_purity" value="'+item.id_purity+'"></td>'



                        +'<td><input type="number" class="act_iss_pcs form-control" name="mt_iss[iss_pcs][]" value="'+issue_pcs+'" style="width: 100px;" disabled/><input type="hidden" class="act_pcs" value="'+issue_pcs+'"></td>'



                        +'<td><input type="number" class="act_iss_wt form-control" name="mt_iss[iss_pcs][]" value="'+issue_wt+'" style="width: 100px;" disabled/><input type="hidden" class="act_wgt" value="'+issue_wt+'"></td>'



                        +'<td><input type="number" class="iss_pcs form-control" name="mt_iss[iss_pcs][]" value="'+issue_pcs+'" style="width: 100px;"/></td>'



                        +'<td><div class="input-group"><input class="iss_weight form-control" type="number" name="mt_iss[iss_weight][]" value="'+issue_wt+'" style="width:80px;"/><span class="input-group-btn" ><select class="uom_id form-control" name="mt_iss[uom_id][]" style="width: 80px;">'+uom_list+'</select></span></div></td>'



                        +'<td><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-xs btn-del"><i class="fa fa-trash"></i></a></td></tr>';







                    +'</tr>';



                    $('#karigar_metal_issue_table tbody ').append(row);



                });



                calculateTotalIssued();



            }



            else



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found."});



            }



        }



    });



}



$(document).on('change','.iss_pcs',function()



{



    var row = $(this).closest('tr');



    blc = parseFloat(row.find('.act_pcs').val());



    if($(this).val() > blc)



    {



        row.find('.iss_pcs').val(blc);



    }



    calculateTotalIssued();



})



$(document).on('change','.iss_weight',function()



{



    var row = $(this).closest('tr');



    blc = parseFloat(row.find('.act_wgt').val());



    if($(this).val() > blc)



    {



        row.find('.iss_weight').val(blc);



    }



    calculateTotalIssued();



});



function calculateTotalIssued()



{



    var tot_issued_pcs = 0;



    var tot_issued_weight = 0;



    $("#karigar_metal_issue_table > tbody  > tr").each(function ()



    {



        var row = $(this).closest('tr');



        tot_issued_pcs = tot_issued_pcs + (isNaN(row.find('.iss_pcs').val() ) ? 0 : parseFloat(row.find('.iss_pcs').val()));



        tot_issued_weight = tot_issued_weight + (isNaN( row.find('.iss_weight').val() ) ? 0 : parseFloat(row.find('.iss_weight').val()));



    });



    $(".tot_issued_pcs").html(tot_issued_pcs);



    $(".tot_issued_weight").html(parseFloat(tot_issued_weight).toFixed(3));



}



$('#other_metal_issue_modal  #update_karigar_metalissue_details').on('click', function()



{



    var itemsIssueList = [];



    if(validateKarigarMetailIssueDetailRow())



	{



        $('#karigar_metal_issue_table tbody tr').each(function (index,value)



        {



            var row = $(this);



            itemsIssueList.push({



                "issue_met_id"    :row.find('.issue_met_id').val(),



                "cat_id"          :row.find('.cat_id').val(),



                "id_product"      :row.find('.id_product').val(),



                "id_design"       :row.find('.id_design').val(),



                "id_sub_design"   :row.find('.id_sub_design').val(),



                "id_purity"       :row.find('.id_purity').val(),



                "act_iss_pcs"     :row.find('.act_iss_pcs').val(),



                "act_iss_wt"      :row.find('.act_iss_wt').val(),



                "pcs"             :row.find('.iss_pcs').val(),



                "weight"          :row.find('.iss_weight').val(),



                "uom_id"          :row.find('.uom_id').val(),



                "cat_name"        :row.find('.cat_name').val(),



                "product_name"    :row.find('.product_name').val(),



                "design_name"     :row.find('.design_name').val(),



                "sub_design_name" :row.find('.sub_design_name').val(),



                "purity"          :row.find('.purity').val(),



                "pur_mode"        :row.find('.pur_mode').val(),



            });



        });



        if(itemsIssueList.length>0)



        {



            set_po_order_item_preview(itemsIssueList);



            $('#other_metal_issue_modal').modal('toggle');



            $('#select_metalissueref_no').select2('val','');



            $('#karigar_metal_issue_table > tbody').empty();



        }



        else



        {



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Record Found."});



        }



    }



    else



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Fill All Required Fields..."});



    }



});



function validateKarigarMetailIssueDetailRow()



{



	var row_validate = true;



	$('#other_metal_issue_modal .modal-body #karigar_metal_issue_table> tbody  > tr').each(function(index, tr) {



		if($(this).find('.iss_pcs').val() == "" || $(this).find('.iss_pcs').val() == "" || $(this).find('.iss_weight').val() == "" || $(this).find('.iss_weight').val() == "" || $(this).find('.uom_id').val() == "" || $(this).find('.uom_id').val() == "" ){



			row_validate = false;



		}



	});



	return row_validate;



}



function edit_po_entry_row_metal_issue(curRow)



{



    $('#other_metal_issue_modal').modal('show');



    curRow.remove();



    var uom_list = "<option value=''>-UOM-</option>";



    $.each(uom_details, function (pkey, pitem)



    {



        var uom_selected ="";



        if(curRow.find('.gwt_uom').val() == pitem.uom_id)



        {



            uom_selected = "selected='selected'";



        }



        uom_list += "<option value='"+pitem.uom_id+"'"+uom_selected+">"+pitem.uom_name+"</option>";



    });



    var row="";



    row+='<tr id="detail'+$('#karigar_metal_issue_table tbody tr').length+'" class="'+$('#karigar_metal_issue_table tbody tr').length+'">'







        +'<td>'+curRow.find('.cat_name').val()+'<input type="hidden" class="cat_name" value="'+curRow.find('.cat_name').val()+'"><input type="hidden" name="mt_iss[cat_id][]" class= "cat_id" value="'+curRow.find('.id_category').val()+'"><input type="hidden" name="mt_iss[issue_met_id][]" class= "issue_met_id" value="'+curRow.find('.issue_met_id').val()+'"></td>'



        +'<td>'+curRow.find('.product_name').val()+'<input type="hidden" class="product_name" value="'+curRow.find('.product_name').val()+'"><input type="hidden" name="mt_iss[id_product][]" class= "id_product" value="'+curRow.find('.id_product').val()+'"><input type="hidden" name="mt_iss[pur_mode][]" class= "pur_mode" value="'+curRow.find('.po_purchase_mode').val()+'"></td>'



        +'<td>'+curRow.find('.design_name').val()+'<input type="hidden" class="design_name" value="'+curRow.find('.design_name').val()+'"><input type="hidden" name="mt_iss[id_design][]" class= "id_design" value="'+curRow.find('.id_design').val()+'"></td>'



        +'<td>'+curRow.find('.sub_design_name').val()+'<input type="hidden" class="sub_design_name" value="'+curRow.find('.sub_design_name').val()+'"><input type="hidden" name="mt_iss[id_sub_design][]" class= "id_sub_design" value="'+curRow.find('.id_sub_design').val()+'"></td>'



        +'<td>'+curRow.find('.purity').val()+'<input type="hidden" class="purity" value="'+curRow.find('.purity').val()+'"><input type="hidden" name="mt_iss[id_purity][]" class= "id_purity" value="'+curRow.find('.id_purity').val()+'"></td>'



        +'<td><input type="number" class="act_iss_pcs form-control" name="mt_iss[iss_pcs][]" value="'+curRow.find('.act_tot_pcs').val()+'" style="width: 100px;" disabled/><input type="hidden" class="act_pcs" value="'+curRow.find('.act_tot_pcs').val()+'"></td>'



        +'<td><input type="number" class="act_iss_wt form-control" name="mt_iss[iss_pcs][]" value="'+curRow.find('.act_tot_wt').val()+'" style="width: 100px;" disabled/><input type="hidden" class="act_wgt" value="'+curRow.find('.act_tot_wt').val()+'"></td>'



        +'<td><input type="number" class="iss_pcs form-control" name="mt_iss[iss_pcs][]" value="'+curRow.find('.tot_pcs').val()+'" style="width: 100px;"/></td>'



        +'<td><div class="input-group"><input class="iss_weight form-control" type="number" name="mt_iss[iss_weight][]" value="'+curRow.find('.tot_gwt').val()+'" style="width:80px;"/><span class="input-group-btn" ><select class="uom_id form-control" name="mt_iss[uom_id][]" style="width: 80px;">'+uom_list+'</select></span></div></td>'



        +'<td><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-xs btn-del"><i class="fa fa-trash"></i></a></td></tr>';







    +'</tr>';



    $('#karigar_metal_issue_table tbody ').append(row);







    calculateTotalIssued();



    calculate_purchase_order_item_total();



    calculate_purchase_item_cost();



}



/*Supplier Bill EntrY Loose Diamond*/



$("input[name='purret_receipt_type']:radio").on('change',function()



{



    insertedcatdetails=[];



    purchasereturnitemlist = [];



    returntaggeditemlist = [];



    nontagreturnitemlist = [];



    returnitemlist = [];



    $('#return_item_detail > tbody').empty();



    $('#item_detail > tbody').empty();



    get_purchase_return_total();



	calculate_purchase_return_item_cost();







    if(this.value==0) // Against Purchase Order



    {



        $('.purretTag').css('display','none');



        $('.purretNonTag').css('display','none');



        $('.purretPo').css('display','block');



    }



    else if(this.value==1) // Against Tag



    {



        $('.purretTag').css('display','block');



        $('.purretNonTag').css('display','none');



        $('.purretPo').css('display','none');



    }



    else // Against NonTag



    {



        $('.purretTag').css('display','none');



        $('.purretNonTag').css('display','block');



        $('.purretPo').css('display','none');



    }



});





$("input[name='tag_issue_from']:radio").on('change',function()

{

    insertedcatdetails=[];

    purchasereturnitemlist = [];

    returntaggeditemlist = [];

    nontagreturnitemlist = [];

    returnitemlist = [];

    $('#return_item_detail > tbody').empty();

    $('#item_detail > tbody').empty();

    get_purchase_return_total();

	calculate_purchase_return_item_cost();



    $('#tag_history_search').prop('disabled',true);



    if(this.value==1)

    {

        $('.branch_transfer_issue').css('display','none');

        $('.tag_issue').css('display','block');

    }

    else

    {

        $('.branch_transfer_issue').css('display','block');

        $('.tag_issue').css('display','none');

        $('#tag_history_search').prop('disabled',false);

    }



});



$("input[name='nontag_issue_from']:radio").on('change',function()

{

    insertedcatdetails = [];

    purchasereturnitemlist=[];

    returntaggeditemlist=[];

    nontagreturnitemlist = [];

    returnitemlist = [];

    $('#return_item_detail > tbody').empty();

    $('#item_detail > tbody').empty();

    get_purchase_return_total();

	calculate_purchase_return_item_cost();



    if(this.value==1)

    {

        $('.nt_issue').css('display','block');

        $('.branch_transfer_issue').css('display','none');

    }

    else

    {

        $('.nt_issue').css('display','none');

        $('.branch_transfer_issue').css('display','block');

        $('#tag_history_search').prop('disabled',false);

    }





})





/*Unfixing Report*/



$('#unfixing_search').on('click', function () {



	get_unfixing_details();



})



function get_unfixing_details() {



	my_Date = new Date();



	var company_name = $('#company_name').val();



	var branch_name = "";



	let from_date = "";



	let to_date = "";



	var report_name = "Approval Unfixing Report";



	var category = $('#category option:selected').html()!= ''&& $('#category option:selected').html()!= undefined?$('#category option:selected').html() +" - " : '' ;



	var karigar = $('#select_karigar option:selected').html()!= ''&& $('#select_karigar option:selected').html()!= undefined?$('#select_karigar option:selected').html() +" - " : '' ;



	var optional = category + karigar;



	var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"



		+ "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";



	$("div.overlay").css("display", "block");



	var oTable = $('#unfixing_list').DataTable();



	$.ajax({



		type: 'POST',



		url: base_url + 'index.php/admin_ret_purchase/approval_unfixing_report/ajax?nocache=' + my_Date.getUTCSeconds(),



		dataType: 'json',



		data: ({'id_karigar': $('#select_karigar').val() }),



		success: function (data) {



			$("div.overlay").css("display", "none");



			var list = data.list;



			$("#unfixing_list > tbody > tr").remove();



			$('#unfixing_list').dataTable().fnClearTable();



			$('#unfixing_list').dataTable().fnDestroy();



			if (list != '') {



				var trHTML = '';



				var tot_grs_wt = 0;



				var tot_net_wt = 0;



				var tot_stn_wt = 0;



				var tot_pure_wt = 0;



				var tot_taxable_amount = 0;



				var tot_stnamount = 0;



				var tot_grn_item_gst_rate = 0;



				var tot_grn_item_cost = 0;



				var tot_balance_weight = 0;



				var tot_fixed_weight = 0;







				$.each(list, function (key, unfixing_det) {



					var grs_wt = 0;



					var net_wt = 0;



					var stn_wt = 0;



					var pure_wt = 0;



					var taxable_amount = 0;



					var stnamount = 0;



					var grn_item_gst_rate = 0;



					var grn_item_cost = 0;



					var tot_purchase_wt = 0;



					var ratefixwt = 0;



					var balance_weight = 0;



					var unfixblcwt = 0;



					var dispunfixblcwt = 0;



					var totUnFixWt = 0;



					var pur_ret_pur_wt = 0;



					$.each(unfixing_det, function (key, val) {



						grs_wt += isNaN(parseFloat(val.gross_wt)) ? 0 : parseFloat(val.gross_wt);



						net_wt += isNaN(parseFloat(val.net_wt)) ? 0 : parseFloat(val.net_wt);



						stn_wt += isNaN(parseFloat(val.stone_wt)) ? 0 : parseFloat(val.stone_wt);



						pure_wt += isNaN(parseFloat(val.pure_wt)) ? 0 : parseFloat(val.pure_wt);



						taxable_amount += isNaN(parseFloat(val.taxable_amount)) ? 0 : parseFloat(val.taxable_amount);



						stnamount += isNaN(parseFloat(val.stnamount)) ? 0 : parseFloat(val.stnamount);



						grn_item_gst_rate += isNaN(parseFloat(val.grn_item_gst_rate)) ? 0 : parseFloat(val.grn_item_gst_rate);



						grn_item_cost += isNaN(parseFloat(val.grn_item_cost)) ? 0 : parseFloat(val.grn_item_cost);



						balance_weight = val.balance_weight;



						pur_ret_pur_wt = val.pur_ret_pur_wt;







						ratefixwt += parseFloat(val.ratefixwt);



						tot_fixed_weight += parseFloat(val.ratefixwt);



						tot_purchase_wt = val.tot_purchase_wt;



						unfixblcwt += parseFloat(val.ratefixwt);







						if(!isNaN(parseFloat(val.pure_wt))){



						    totUnFixWt = parseFloat(val.pure_wt);



						}



						dispunfixblcwt = totUnFixWt - parseFloat(unfixblcwt)-parseFloat(pur_ret_pur_wt);











						var grsWt = isNaN(parseFloat(val.gross_wt)) ? "" : money_format_india(parseFloat(val.gross_wt).toFixed(3));



						var netWt = isNaN(parseFloat(val.net_wt)) ? "" : money_format_india(parseFloat(val.net_wt).toFixed(3));



						var stWt = isNaN(parseFloat(val.stone_wt)) ? "" :  money_format_india(parseFloat(val.stone_wt).toFixed(3));



						var txAmt = isNaN(parseFloat(val.taxable_amount)) ? "" : money_format_india(parseFloat(val.taxable_amount).toFixed(2));



						var gstRate = isNaN(parseFloat(val.grn_item_gst_rate)) ? "" : money_format_india(parseFloat(val.grn_item_gst_rate).toFixed(2));



						var itmCost = isNaN(parseFloat(val.grn_item_cost)) ? "" : money_format_india(parseFloat(val.grn_item_cost).toFixed(2));



						var purWt = isNaN(parseFloat(val.pure_wt)) ? "" : money_format_india(parseFloat(val.pure_wt).toFixed(3));







						trHTML += '<tr>'



							+ '<td>' + val.grn_ref_no + '</td>'



							+ '<td>' + val.po_ref_no + '</td>'



							+ '<td>' + val.grndate + '</td>'



							+ '<td>' + val.category_name + '</td>'



							+ '<td>' + val.supplier_name + '</td>'



							+ '<td>' + grsWt + '</td>'



							+ '<td>' + netWt + '</td>'



							+ '<td>' + stWt + '</td>'



							+ '<td>' + txAmt + '</td>'



							+ '<td>' + gstRate + '</td>'



							+ '<td>' + itmCost + '</td>'



							+ '<td>' + purWt + '</td>'



							+ '<td>' + money_format_india(parseFloat(val.unfixrate).toFixed(2)) + '</td>'



							+ '<td>' + money_format_india(parseFloat(val.ratefixwt).toFixed(3)) + '</td>'



							+ '<td>'+ parseFloat(pur_ret_pur_wt).toFixed(3)+'</td>'



							+ '<td>'+ parseFloat(dispunfixblcwt).toFixed(3)+'</td>'



							+ '<td>' + money_format_india(parseFloat(val.fixrate).toFixed(2)) + '</td>'



							+ '<td>' + val.crdr + '</td>'



							+ '</tr>';



					});



					tot_balance_weight += parseFloat(dispunfixblcwt);



					tot_grs_wt += parseFloat(grs_wt);



					tot_net_wt += parseFloat(net_wt);



					tot_stn_wt += parseFloat(stn_wt);



					tot_pure_wt += parseFloat(pure_wt);



					tot_taxable_amount += parseFloat(taxable_amount);



					tot_stnamount += parseFloat(stnamount);



					tot_grn_item_gst_rate += parseFloat(grn_item_gst_rate);



					tot_grn_item_cost += parseFloat(grn_item_cost);



					trHTML += '<tr style="font-weight:bold; color:red">'



						+ '<td><strong>SUB TOTAL</strong></td>'



						+ '<td></td>'



						+ '<td></td>'



						+ '<td></td>'



						+ '<td></td>'



						+ '<td><strong>' + money_format_india(parseFloat(grs_wt).toFixed(3)) + '</strong></td>'



						+ '<td><strong>' + money_format_india(parseFloat(net_wt).toFixed(3)) + '</strong></td>'



						+ '<td><strong>' + money_format_india(parseFloat(stn_wt).toFixed(3)) + '</strong></td>'



						+ '<td><strong>' + money_format_india(parseFloat(taxable_amount).toFixed(2)) + '</strong></td>'



						+ '<td><strong>' + money_format_india(parseFloat(grn_item_gst_rate).toFixed(2)) + '</strong></td>'



						+ '<td><strong>' + money_format_india(parseFloat(grn_item_cost).toFixed(2)) + '</strong></td>'



						+ '<td><strong>' + money_format_india(parseFloat(pure_wt).toFixed(3)) + '</strong></td>'



					    + '<td></td>'



						+ '<td><strong>' + money_format_india(parseFloat(ratefixwt).toFixed(3)) + '</strong></td>'



						+ '<td></td>'



						+ '<td><strong>' + money_format_india(parseFloat(dispunfixblcwt).toFixed(3)) + '</strong></td>'



						+ '<td></td>'



						+ '<td></td>'



						+ '</tr>';



				});



				trHTML += '<tr style="font-weight:bold; color:blue">'



					+ '<td><strong>GRAND TOTAL</strong></td>'



					+ '<td></td>'



					+ '<td></td>'



					+ '<td></td>'



					+ '<td></td>'



					+ '<td><strong>' + money_format_india(parseFloat(tot_grs_wt).toFixed(3)) + '</strong></td>'



					+ '<td><strong>' + money_format_india(parseFloat(tot_net_wt).toFixed(3)) + '</strong></td>'



					+ '<td><strong>' + money_format_india(parseFloat(tot_stn_wt).toFixed(3)) + '</strong></td>'



					+ '<td><strong>' + money_format_india(parseFloat(tot_taxable_amount).toFixed(2)) + '</strong></td>'



					+ '<td><strong>' + money_format_india(parseFloat(tot_grn_item_gst_rate).toFixed(2)) + '</strong></td>'



					+ '<td><strong>' + money_format_india(parseFloat(tot_grn_item_cost).toFixed(2)) + '</strong></td>'



					+ '<td><strong>' + money_format_india(parseFloat(tot_pure_wt).toFixed(3)) + '</strong></td>'



					+ '<td></td>'



					+ '<td><strong>' + money_format_india(parseFloat(tot_fixed_weight).toFixed(3)) + '</strong></td>'



					+ '<td></td>'



					+ '<td><strong>' + money_format_india(parseFloat(tot_balance_weight).toFixed(3)) + '</strong></td>'



					+ '<td></td>'



					+ '<td></td>'



					+ '</tr>';



				$('#unfixing_list > tbody').html(trHTML);



				// Check and initialise datatable



				if (!$.fn.DataTable.isDataTable('#unfixing_list')) {



					oTable = $('#unfixing_list').dataTable({



						"bSort": false,



						"bInfo": true,



						"scrollX": '100%',



						"dom": 'lBfrtip',



						"paging": false,



						"fixedHeader": true,



						"autoWidth": true,



						"columnDefs": [



							{



								targets: [5, 6, 7, 8, 9, 10, 11,12, 13, 14],



								className: 'dt-body-right'



							}



						],



						"buttons": [



							{



								extend: 'print',



								footer: true,



								title: '',



								messageTop: title,



								exportOptions: {



									columns: ':visible',



									stripHtml: false



								},



								customize: function (win) {



									$(win.document.body).find('table')



										.addClass('compact')



										.css('font-size', '12px')



										.css('font-family', 'sans-serif');



								},



							},



							{



								extend: 'excel',



								footer: true,



								title: 'UNFIXING REPORT',



							},



							{



    							extend: 'colvis',







    							collectionLayout: 'fixed columns',







    							collectionTitle: 'Column visibility control'







    						},



						],



					});



				}



			}



		}



	});



}



/*Unfixing Report*/



/*Rate Fixed Reports*/



$('#rate_fixed_search').on('click', function () {



	get_rate_fixed_details();



});



function get_rate_fixed_details() {



	my_Date = new Date();



	var company_name = $('#company_name').val();



	var branch_name = "";



	let from_date = "";



	let to_date = "";



	var report_name = "Approval Rate Fixed Report";



	var optional = $('#select_karigar option:selected').html()!= ''&& $('#select_karigar option:selected').html()!= undefined?$('#select_karigar option:selected').html() +" - " : '' ;



	var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"



		+ "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";



	$("div.overlay").css("display", "block");



	var oTable = $('#rate_fixed_list').DataTable();



	$.ajax({



		type: 'POST',



		url: base_url + 'index.php/admin_ret_purchase/approval_rate_fixed/ajax?nocache=' + my_Date.getUTCSeconds(),



		dataType: 'json',



		data: ({ 'id_karigar': $('#select_karigar').val(), 'from_date': $('#rpt_from_date').html(), 'to_date': $('#rpt_to_date').html() }),



		success: function (data) {



			$("div.overlay").css("display", "none");



			var list = data.list;



			$("#rate_fixed_list > tbody > tr").remove();



			$('#rate_fixed_list').dataTable().fnClearTable();



			$('#rate_fixed_list').dataTable().fnDestroy();



			if (list != null && list != '') {



				var trHTML = '';



				var tot_pur_wt = 0;



				var tot_rate_fix_wt = 0;



				var tot_rateFix_rate = 0;



				var tot_total_amt = 0;



				var tot_grn_pur_amt = 0;



				$.each(list, function (key, fixed_details) {



					var pur_wt = 0;



					var rateFix_wt = 0;



					var rateFix_rate = 0;



					var tot_amt = 0;



					var grn_pur_amt = 0;



					var grn_purchase_amt = 0;



					var balance_amount = 0;



					$.each(fixed_details, function (key, val) {



						pur_wt += parseFloat(val.tot_purchase_wt);



						rateFix_wt += parseFloat(val.rate_fix_wt);



						rateFix_rate += parseFloat(val.rate_fix_rate);



						tot_amt += parseFloat(val.fixed_amount);



						grn_pur_amt = fixed_details[0].grn_purchase_amt;



						trHTML += '<tr>' +



							'<td>' + val.grn_ref_no + '</td>' +



							'<td>' + val.grn_purchase_amt + '</td>' +



							'<td>' + val.po_ref_no + '</td>' +



							'<td>' + val.grn_date + '</td>' +



							'<td>' + val.suppliername + '</td>' +



							'<td>' + val.ratefixeddate + '</td>' +



							'<td>' + parseFloat(val.rate_fix_wt).toFixed(3) + '</td>' +



							'<td>' + parseFloat(val.rate_fix_rate).toFixed(2) + '</td>' +



							'<td>' + money_format_india(parseFloat(val.fixed_amount).toFixed(2)) + '</td>' +



							'<td></td>' +



							'</tr>';



					});



					tot_pur_wt += parseFloat(pur_wt);



					tot_rate_fix_wt += parseFloat(rateFix_wt);



					tot_rateFix_rate += parseFloat(rateFix_rate);



					tot_total_amt += parseFloat(tot_amt);



					tot_grn_pur_amt += parseFloat(grn_pur_amt);



					trHTML += '<tr style="font-weight:bold; color:red">' +



						'<td><strong>SUB TOTAL</strong></td>' +



						'<td>' + money_format_india(parseFloat(grn_pur_amt).toFixed(2)) + '</td>' +



						'<td></td>' +



						'<td></td>' +



						'<td></td>' +



						'<td></td>' +



						'<td><strong>' + parseFloat(rateFix_wt).toFixed(3) + '</strong></td>' +



						'<td><strong></td>' +



						'<td><strong>' + money_format_india(parseFloat(tot_amt).toFixed(2)) + '</strong></td>' +



						'<td><strong>' + money_format_india(parseFloat(parseFloat(grn_pur_amt) - parseFloat(tot_amt)).toFixed(2)) + '</strong></td>' +



						'</tr>';



				});



				trHTML += '<tr style="font-weight:bold; color:blue">' +



					'<td><strong>GRAND TOTAL</strong></td>' +



					'<td></td>' +



					'<td></td>' +



					'<td></td>' +



					'<td></td>' +



					'<td></td>' +



					'<td><strong>' + money_format_india(parseFloat(tot_rate_fix_wt).toFixed(3)) + '</strong></td>' +



					'<td><strong></td>' +



					'<td><strong>' + money_format_india(parseFloat(tot_total_amt).toFixed(2)) + '</strong></td>' +



					'<td></td>' +



					'</tr>';



				$('#rate_fixed_list > tbody').html(trHTML);



				// Check and initialise datatable



				if (!$.fn.DataTable.isDataTable('#rate_fixed_list')) {



					oTable = $('#rate_fixed_list').dataTable({



						"bSort": false,



						"bDestroy": true,



						"bInfo": true,



						"scrollX": '100%',



						"paging": false,



						"dom": 'Bfrtip',



						"bAutoWidth": false,



						"responsive": true,



						"columnDefs": [



							{



								targets: [1, 6, 7, 8, 9],



								className: 'dt-body-right'



							}



						],



						"buttons": [



							{



								extend: 'print',



								footer: true,



								title: '',



								messageTop: title,



								customize: function (win) {



									$(win.document.body).find('table')



										.addClass('compact');



									$(win.document.body).find('table')



										.addClass('compact')



										.css('font-size', '10px')



										.css('font-family', 'sans-serif');



								},



								exportOptions: {



									columns: ':visible',



									stripHtml: false



								}



							},



							{



								extend: 'excel',



								footer: true,



								title: 'Rate Fixed Report',



							},



							{



    							extend: 'colvis',







    							collectionLayout: 'fixed columns',







    							collectionTitle: 'Column visibility control'







    						},



						],



					});



				}



			}



		},



		error: function (error) {



			$("div.overlay").css("display", "none");



		}



	});



}



/*Rate Fixed Reports*/



/*Smith Company Opening Balance*/



$("input[name='smth_cmpy_stk[stock_type]']:radio").on('change',function()



{



    if(this.value==1)



    {



        $('.smth_stock').css('display','none');



        $('.smth_stock_wt_type').css('display','none');



        $('.smth_stock_amt').css('display','none');



        $('.smith_type').css('display','none');



        $('.smth_stock_wt').css('display','block');



    }



    else



    {



        $('.smth_stock').css('display','block');



        $('.smth_stock_wt_type').css('display','block');



        $('.smith_type').css('display','block');



        $('.smth_stock_amt').css('display','block');



        $('.smth_stock_wt').css('display','block');



    }



    resetForm();



});



$("input[name='smth_cmpy_stk[smith_type]']:radio").on('change',function()



{



    $('.smth_stock_wt').css('display','none');



    $('.smth_stock_wt_type').css('display','none');



    $('.smth_stock_amt').css('display','none');



    $('#metal_balance').prop('checked',true);



    if(this.value==1)



    {



        $('.smth_stock_amt').css('display','block');



    }



    else if(this.value==2 || this.value==3)



    {



        $('.smth_stock_wt').css('display','block');



        $('.smth_stock_wt_type').css('display','block');



        $('.smth_stock_amt').css('display','block');



    }



    else



    {



        $('.smth_stock_wt').css('display','block');



        $('#ornament_balance').prop('checked',true);



    }



    resetForm()



});



function resetForm()



{



    $('#select_metal').select2('val',"");



    $('#select_category').select2('val',"");



    $('#select_product').select2('val',"");



    $('#select_karigar').select2('val',"");



    $('.op_pcs').val("");



    $('.op_wgt').val("");



    $('.op_amt').val("");



}



$("input[name='smth_cmpy_stk[bal_type]']:radio").on('change',function()



{



    resetForm();







});



$("input[name='smth_cmpy_stk[metal_type]']:radio").on('change',function()



{



    if($("input[type='radio'][name='smth_cmpy_stk[metal_type]']:checked").val()==2){



        $('.old_metal_category').css("display",'block');



        $('.category').css("display",'none');



     }else{



        $('.old_metal_category').css("display",'none');



        $('.category').css("display",'block');



     }







});



$('#smth_cmpy_bal_submit').on('click',function()



{







    if($('#select_karigar').val()=='' || $('#select_karigar').val()==null && $("input[name='smth_cmpy_stk[stock_type]']:checked").val()==2)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Karigar."});



    }



    else if($('#select_metal').val()=='' || $('#select_metal').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Metal."});



    }



    else if($('#select_category').val()=='' || $('#select_category').val()==null && $("input[type='radio'][name='smth_cmpy_stk[metal_type]']:checked").val() == 1)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Category."});



    }

    else if($('#oldcategory').val()=='' || $('#oldcategory').val()==null && $("input[type='radio'][name='smth_cmpy_stk[metal_type]']:checked").val() == 2)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Category."});



    }



    // else if($('#select_product').val()=='' || $('#select_product').val()==null)



    // {



    //     $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Product."});



    // }







    else



    {



        SmithCompanyOpBalanceSave();



    }



});



function SmithCompanyOpBalanceSave()



{



    var form_data=$('#smth_cmp_op_bal').serialize();



    my_Date = new Date();



    $.ajax({



        data:form_data,



        url:base_url+ "index.php/admin_ret_purchase/smith_cmpy_op_bal/save?nocache=" + my_Date.getUTCSeconds(),



        type:"POST",



        dataType:"JSON",



        cache: false,



        success:function(data)



        {



            console.log(data);



            if(data.status)



            {



                $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                window.location.href= base_url+'index.php/admin_ret_purchase/smith_cmpy_op_bal/list';



                $("div.overlay").css("display", "none");



            }else



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                $("div.overlay").css("display", "none");



            }



        }



    });



}



$('#smith_cmpy_op_bal_search').on('click', function () {



    get_smith_cmpy_op_bal_details();



});



function get_smith_cmpy_op_bal_details() {



    var company_name = $('#company_name').val();



    var from_date = $('#rpt_payments1').html();



    var to_date = $('#rpt_payments2').html();



    var branch_name = ($('#branch_name').val() != '' && $('#branch_name').val() != undefined ? $('#branch_name').val() : $("#branch_select option:selected").text());



    var report_name = "SMITH COMPANY OPENING BALANCE";



    var optional = '';



    var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"



        + "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";



    $("div.overlay").css("display", "block");



    my_Date = new Date();



    $(".overlay").css("display", "block");



    $.ajax({



        type: "POST",



        url: base_url + "index.php/admin_ret_purchase/smith_cmpy_op_bal/ajax",



        data: {'from_date': $('#rpt_payments1').html(),'to_date': $('#rpt_payments2').html()},



        dataType: 'JSON',



        success: function (data) {



            var a = 1;



            var list = data.list;



            var oTable = $('#smth_cmpy_po_list').DataTable();



            oTable.clear().draw();



            if (list != null && list.length > 0) {



                oTable = $('#smth_cmpy_po_list').dataTable({



                    "bDestroy": true,



                    "bInfo": true,



                    "bFilter": true,



                    "bSort": true,



                    "ordering": false,



                    "dom": 'lBfrtip',



                    "columnDefs": [



						{



							targets: [1,2,3,4,5,6,7],



							className: 'dt-body-left'



						},



						{



							targets: [8,10],



							className: 'dt-body-right'



						},



					],



                    "buttons": [



                        {



                            extend: 'print',



                            footer: true,



                            title: '',



                            messageTop: title,



                            customize: function (win) {



                                $(win.document.body).find('table')



                                    .addClass('compact')



                                    .css('font-size', '10px');



                            },



                        },



                        {



                            extend: 'excel',



                            footer: true,



                            title: 'SMITH COMPANY OPENING BALANCE',



                        }



                    ],



                    "tableTools": { "buttons": [{ "sExtends": "xls", "oSelectorOpts": { page: 'current' } }, { "sExtends": "pdf", "oSelectorOpts": { page: 'current' } }] },



                    "aaData": list,



                    "aoColumns": [



                        {



                            "mDataProp": function (row, type, val, meta) {



                                return row.id_smith_company_op_balance;



                            }



                        },



                        { "mDataProp": "ref_no" },



                        { "mDataProp": "stock_tye" },



                        { "mDataProp": "smith_type" },



                        { "mDataProp": "bal_type" },



                        { "mDataProp": "karigar" },



                        { "mDataProp": "metal" },



                        { "mDataProp": "category" },



                        { "mDataProp": "product_name" },



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.op_wgt)+'/'+row.uom_short_code;



            				}



            			},



                        {



            				"mDataProp": function (row, type, val, meta)



                            {



                                var weight_type ='';



            					if(row.weight_type==1)



                                {



                                    weight_type = 'Cr';



                                }



                                else if(row.weight_type==2)



                                {



                                    weight_type = 'Dr';



                                }



                                return weight_type;



            				}



            			},



                        {



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.op_amt);



            				}



            			},



                        {



            				"mDataProp": function (row, type, val, meta)



                            {



                                var amount_type ='';



            					if(row.amount_type==1)



                                {



                                    amount_type = 'Cr';



                                }



                                else if(row.amount_type==2)



                                {



                                    amount_type = 'Dr';



                                }



                                return amount_type;



            				}



            			},



                        { "mDataProp": "remarks" },



                    ]



                });



            }



            $("div.overlay").css("display", "none");



        }



    })



}



/*Smith Company Opening Balance*/



/*Non Tag Lot Generate*/



function get_NontagLotItemDetails()



{



    my_Date = new Date();



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/karigarmetalissue/available_stock_details",



        data:{'lot_no':$('#nontag_lot_no').val()},



        type:"POST",



        dataType:"JSON",



        success:function(data)



        {



            $('#nontag_lot_item_detail tbody').empty();



            var rowExists=false;



            var trHtml='';



            $.each(data,function(key,items)



            {



                var purity = "<option value=''>-Select Purity-</option>";



                $.each(items.purity, function (pkey, pitem) {



                    purity += "<option value='"+pitem.id_purity+"'>"+pitem.purity+"</option>";



                });



                var id = parseFloat($('#nontag_lot_item_detail > tbody  > tr').length+1)



                trHtml='<tr id="'+id+'">'



                    +'<td style="50px;"><input type="checkbox" class="nontag_items" name="items[nontag_items][]" value="0" /></td>'



                    +'<td>'+items.category_name+'<input type="hidden" class="cat_id" name="items[cat_id][]" value="'+items.cat_id+'"/></td>'







                    +'<td>'+items.section_name+'<input type="hidden" class="id_section" name="items[id_section][]" value="'+items.id_section+'"/></td>'



                    +'<td>'+items.product_name+'<input type="hidden" class="pro_id" name="items[pro_id][]" value="'+items.id_product+'"/><input type="hidden" class="id_design" name="items[id_design][]" value="'+items.design+'"/><input type="hidden" class="id_sub_design" name="items[id_sub_design][]" value="'+items.id_sub_design+'"/></td>'



                    +'<td><select class="form-control" id="select_purity"  style="width:100px;">'+purity+'</select></td>'







                    +'<td><div class="input-group"><span><input type="number" class="nontagpcs form-control" style="width:100px;"name="items[nontagpcs][]" value="'+items.no_of_piece+'"><input type="hidden" class="nontag_availpcs form-control" name="" value="'+items.no_of_piece+'"></span><span>&nbsp; of &nbsp;'+ items.no_of_piece +'<br/></span><span style="font-size:10px;color:red;" class="pcs_err"></span></div></td>'



                    +'<td><div class="input-group"><span><input class="nontag_grswt form-control" type="number" name="items[nontag_grswt][]" value="'+items.gross_wt+'" style="width:80px;"/><input type="hidden" class="nontag_available_grswt" name="" value="'+items.gross_wt+'"></span><span>&nbsp; of &nbsp;'+ items.gross_wt +'<br/></span><span style="font-size:10px;color:red;" class="grs_err"></span></div></td>'



                    +'<td><div class="input-group"><span><input class="nontag_netwt form-control" type="number" name="items[nontag_netwt][]" value="'+items.net_wt+'" style="width:80px;"/><input type="hidden" class="nontag_available_netwt" name="" value="'+items.net_wt+'"></span><span>&nbsp; of &nbsp;'+ items.net_wt +'<br/></span><span style="font-size:10px;color:red;" class="net_err"></span></div></td>'



                    +'<td><a href="#" onClick="remove_qc_item($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>'



                +'</tr>';



                if($('#nontag_lot_item_detail > tbody  > tr').length>0)



                {



                    $('#nontag_lot_item_detail > tbody > tr:first').before(trHtml);



                }else{



                    $('#nontag_lot_item_detail tbody').append(trHtml);



                }







                $('#nontag_lot_item_detail > tbody').find('#select_purity').select2();



                $('#nontag_lot_item_detail > tbody').find('#select_purity').select2({



                    placeholder: "Purity",



                    allowClear: true



                });







            });



        }



    })



    calculateNonTagLotTotal();



}



$(document).on('input',".nontagpcs", function()



{



    var row = $(this).closest('tr');



    blc = parseFloat(row.find('.nontag_availpcs').val());



    if($(this).val() > blc)



    {



        row.find('.nontagpcs').val(blc);



        row.find('.pcs_err').text('Invalid');



    }



    else



    {



        row.find('.pcs_err').text('');



        row.find('.nontagpcs').val($(this).val()) ;



    }



    calculateNonTagLotTotal();



});



$(document).on('input',".nontag_grswt", function()



{



    var row = $(this).closest('tr');



    blc = parseFloat(row.find('.nontag_available_grswt').val());



    if($(this).val() > blc)



    {



        row.find('.nontag_grswt').val(blc);



        row.find('.grs_err').text('Invalid');



    }



    else



    {



        row.find('.nontag_grswt').val($(this).val());



        row.find('.grs_err').text('');



    }



    calculateNonTagLotTotal();



});



$(document).on('input',".nontag_netwt", function()



{



    var row = $(this).closest('tr');



    blc = parseFloat(row.find('.nontag_available_netwt').val());



    grs_wt = parseFloat(row.find('.nontag_grswt').val());



    grs_wt_blc = parseFloat(row.find('.nontag_available_grswt').val());







    if($(this).val() > blc || ($(this).val() > grs_wt))



    {



        row.find('.nontag_netwt').val(blc);



        row.find('.nontag_grswt').val(grs_wt_blc);



        row.find('.net_err').text('Invalid');



    }



    else



    {



        row.find('.nontag_netwt').val($(this).val());



        row.find('.net_err').text('');



    }



    calculateNonTagLotTotal();



});



function calculateNonTagLotTotal()



{



    var tot_nt_pcs = 0;



    var tot_nt_grswt = 0;



    var tot_nt_netwt = 0;



    $("#nontag_lot_item_detail > tbody  > tr").each(function ()



    {



        var row = $(this).closest('tr');



        if(row.find("input[name='items[nontag_items][]']:checked").is(":checked"))



        {



            tot_nt_pcs = tot_nt_pcs + (isNaN(row.find('.nontagpcs').val() ) ? 0 : parseFloat(row.find('.nontagpcs').val()));



            tot_nt_grswt = tot_nt_grswt + (isNaN( row.find('.nontag_grswt').val() ) ? 0 : parseFloat(row.find('.nontag_grswt').val()));



            tot_nt_netwt = tot_nt_netwt + (isNaN( row.find('.nontag_netwt').val() ) ? 0 : parseFloat(row.find('.nontag_netwt').val()));



        }



    });



    $(".tot_nt_pcs").html(tot_nt_pcs);



    $(".tot_nt_grswt").html(parseFloat(tot_nt_grswt).toFixed(3));



    $(".tot_nt_netwt").html(parseFloat(tot_nt_netwt).toFixed(3));



}



$('#nontag_lot_save').on('click',function()



{



    var NonTagLotGenerateList = [];



    if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Karigar"});



    }



    else if($('#nontag_lot_item_detail >tbody tr').length>0)



    {



        $('#nontag_lot_item_detail tbody tr').each(function (index,value)



        {



            var row=$(this).closest('tr');



            if(row.find("input[name='items[nontag_items][]']:checked").is(":checked"))



            {



                if(ValidateNonTagLotGenerate())



                {



                    NonTagLotGenerateList.push({



                        "id_category"     : row.find('.cat_id').val(),



                        "id_section"      : row.find('.id_section').val(),



                        "id_purity"       : row.find('#select_purity').val(),



                        "id_product"      : row.find('.pro_id').val(),



                        "id_design"       : row.find('.id_design').val(),



                        "id_sub_design"   : row.find('.id_sub_design').val(),



                        "pcs"             : row.find('.nontagpcs').val(),



                        "grswt"           : row.find('.nontag_grswt').val(),



                        "netwt"           : row.find('.nontag_netwt').val(),



                    });



                }



                else



                {



                    $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Required Fields"});



                }



            }



        });



    }



    else



    {



        $('#nontag_lot_save').prop('disabled',false);



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records to Update"});



    }



    if(NonTagLotGenerateList.length>0)



    {



        NonTagItemsSave(NonTagLotGenerateList);



    }



    else



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+'Please select Any Id to proceed..'});



    }







});



function ValidateNonTagLotGenerate()



{



    var row_validate = true;



	$('#nontag_lot_item_detail > tbody  > tr').each(function(index, tr)



    {



        if($(this).find("input[name='items[nontag_items][]']:checked").is(":checked"))



        {



            if($(this).find('#select_purity').val() == "")



            {



                row_validate = false;



            }



        }



	});



    return row_validate;



}



function NonTagItemsSave(Nontag_list)



{



    $("div.overlay").css("display", "block");



    var postData = {};



    postData={'nontag_items':Nontag_list,'id_karigar':$('#select_karigar').val()};



    var url=base_url+ "index.php/admin_ret_purchase/nontag_lot_generate/save?nocache=" + my_Date.getUTCSeconds();



    $.ajax({



        url:url,



        data: postData,



        type:"POST",



        dataType:"JSON",



        success:function(data){



            if(data.status)



            {



                $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                window.location.href= base_url+'index.php/admin_ret_lot/lot_inward/list';



                $("div.overlay").css("display", "none");



            }else



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                $("div.overlay").css("display", "none");



            }







        },



        error:function(error)



        {



            $("div.overlay").css("display", "none");



        }



    });



}



/*Non Tag Lot Generate*/



/*Create Purchase order Images*/



$(document).on('click', "#purchase_details a.order_img", function(e)



{



    e.preventDefault();



    id=$(this).data('id');



    curRow = $(this).closest('tr');



    update_purchaseorder_image_upload(curRow,id)



});



function update_purchaseorder_image_upload(curRow,id)



{



	pre_img_resource=[];



	$('#active_row').val(curRow.closest('tr').attr('class'));



	$('#uploadArea_p_stn').empty();



	if(curRow!=undefined)



	{



		var preview = 'uploadArea_p_stn';



		var order_img=curRow.find('.order_images').val();



		console.log(order_img)



		if(order_img!='')



		{



			var img_details=JSON.parse(order_img);



			$.each(img_details,function(key,item)



            {



			    if(item)



			    {



                    pre_img_resource.push({'src':item.src,'name':item.name});



                    var div = document.createElement("div");



                    div.setAttribute('class','col-md-4');



                    div.setAttribute('id',+key);



                    param = {"key":key,"preview":preview,"stone_type":"order_images"};



                    div.innerHTML+= "<a onclick='remove_stn_img("+JSON.stringify(param)+")'><i class='fa fa-trash'></i>Delete</a><img class='thumbnail' src='" + item.src + "'" +



                    "style='width: 150px;height: 150px;'/>";



                    $('#'+preview).append(div);



			    }



			   $('#lot_img_upload').css('display','');



			});



		}



		$('#cus_i_increment').val(curRow.closest('tr').attr('class'));



	}



	$('#imageModal').modal('show');



}



$("#pur_order_images").on('change',function()



{



    if(this.value!='')



    {



        validateCertifImg(this.id);



    }



});



function validateCertifImg(type)



{



    if(type == 'pur_order_images')



    {



        preview = 'uploadArea_p_stn';



    }



    var files = event.target.files;



    var html_1="";



    for (var i = 0; i < files.length; i++)



    {



        var file = files[i];



        var fileName =file.name;



        var ext = fileName.substring(fileName.lastIndexOf('.') + 1);



        ext = ext.toLowerCase();



        if(ext != "jpg" && ext != "png" && ext != "jpeg")



        {



            alert("Upload JPG or PNG Images only");



            files[i] = "";



        }



        else



        {



            var reader = new FileReader();



            reader.onload = function (event)



            {



                if(type == 'pur_order_images')



                {



                    pre_img_resource.push({'src':event.target.result,'name':fileName});



                    pre_img_files.push(file);



                }



            }



            if (file)



            {



                reader.readAsDataURL(file);



            }



        }



    }



    setTimeout(function()



    {



        var resource = [];



        $('#'+preview+' div').remove();



        if(type == 'pur_order_images')



        {



            resource = pre_img_resource;



        }



        console.log(resource);



        $.each(resource,function(key,item)



        {



            if(item)



            {



                var div = document.createElement("div");



                div.setAttribute('class','col-md-4');



                div.setAttribute('id',+key);



                param = {"key":key,"preview":preview,"stone_type":type};



                div.innerHTML+= "<a onclick='remove_stn_img("+JSON.stringify(param)+")'><i class='fa fa-trash'></i>Delete</a><img class='thumbnail' src='" + item.src + "'" +



                "style='width: 150px;height: 150px;'/>";



                $('#'+preview).append(div);



            }



        $('#lot_img_upload').css('display','');



        });



    },1000);



    //pre_img_resource=[];



}



function remove_stn_img(param)



{



	$('#'+param.preview+' #'+param.key).remove();



    if(param.stone_type == 'pur_order_images')



    {



        pre_img_resource.splice(param.key,1);



    }



	var preview = 'uploadArea_p_stn';



	$('#'+preview+' div').remove();



    $.each(pre_img_resource,function(key,item)



    {



        if(item)



        {



            var div = document.createElement("div");



            div.setAttribute('class','col-md-4');



            div.setAttribute('id',+key);



            param = {"key":key,"preview":preview,"stone_type":"pur_order_images"};



            div.innerHTML+= "<a onclick='remove_stn_img("+JSON.stringify(param)+")'><i class='fa fa-trash'></i>Delete</a><img class='thumbnail' src='" + item.src + "'" +



            "style='width: 150px;height: 150px;'/>";



            $('#'+preview).append(div);



        }



        $('#lot_img_upload').css('display','');



    });



}



$('#imageModal  #update_pur_img').on('click', function()



{



    $('#imageModal').modal('toggle');



    var curRow=$("#active_row").val();



    $('.'+curRow).find('.order_images').val(JSON.stringify(pre_img_resource));



    var preview = $('.'+curRow).find('#purchase_order_images');



	$.each(pre_img_resource,function(key,item)



	{



        console.log('key',key);



        if(key==0)



        {



            preview.prop('src',item.src);



        }







	});



});



function show_purchase_stone_details(curRow,id)



{



	var row='';



	var row_st_details=curRow.find('.stone_details').val();



	console.log(row_st_details);



	if(row_st_details !='' && row_st_details != '[]' && curRow != undefined)



	{



		$('#estimation_stone_cus_item_details tbody').empty();



		var stone_details=JSON.parse(row_st_details);



		console.log(stone_details);



		$.each(stone_details,function(pkey,pitem){



			var stones_list='';



			var stones_type_list='';



			var uom_list='';



			var html='';



			var cal_type = pitem.stone_cal_type;



			$.each(stones,function(key,item){



				var selected = "";



				if(item.stone_id == pitem.stone_id)



				{



					selected = "selected='selected'";



				}



				stones_list += "<option value='"+item.stone_id+"' "+selected+">"+item.stone_name+"</option>";



			});



			$.each(stone_types, function (pkey, item) {



				var st_type_selected = "";



				if(item.id_stone_type == pitem.stones_type)



				{



					st_type_selected = "selected='selected'";



				}



				stones_type_list += "<option value='"+item.id_stone_type+"' "+st_type_selected+">"+item.stone_type+"</option>";



			});



			$.each(uom_details, function (pkey, item) {



				var uom_selected = "";



				if(item.uom_id == pitem.stone_uom_id)



				{



					uom_selected = "selected='selected'";



				}



				uom_list += "<option value='"+item.uom_id+"' "+uom_selected+">"+item.uom_name+"</option>";



			});



			let option_delete='<a href="#" onClick="$(this).closest(\'tr\').remove();" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a>';



			row += '<tr>'



				+'<td><input class="show_in_lwt" type="checkbox" name="est_stones_item[show_in_lwt][]"  value="'+(pitem.show_in_lwt==1 ? 1:0)+'" '+(pitem.show_in_lwt==1 ? 'checked' :'' )+' ></td>'



				+'<td><select class="stones_type form-control" name="est_stones_item[stones_type][]"  readonly>'+stones_type_list+'</select></td>'



				+'<td><select class="stone_id form-control" name="est_stones_item[stone_id][]"  readonly>'+stones_list+'</select></td>'



				+'<td><input type="number" class="stone_pcs form-control" name="est_stones_item[stone_pcs][]"  value="'+pitem['stone_pcs']+'" style="width: 100%;" readonly/></td>'



				+'<td><div class="input-group"><input class="stone_wt form-control" type="number"  name="est_stones_item[stone_wt][]" value="'+pitem['stone_wt']+'" style="width:100%;" readonly/><span class="input-group-btn" style="width: 70px;"><select class="stone_uom_id form-control" name="est_stones_item[stone_uom_id][]"  readonly>'+uom_list+'</select></span></div></td>'



				+'<td><div class="form-group"><input class="stone_cal_type" type="radio"  name="est_stones_item[cal_type]['+pkey+']" value="1" '+(cal_type == 1 ? 'checked' : '')+'> By Wt&nbsp;<input type="radio" name="est_stones_item[cal_type]['+pkey+']" '+(cal_type == 2 ? 'checked' : '')+' class="stone_cal_type" value="2">By Pcs</div></td>'



				+'<td><input type="number" class="stone_rate form-control" name="est_stones_item[stone_rate][]"  value="'+pitem['stone_rate']+'"  style="width:100%;" readonly/></td>'



				+'<td><input type="number" class="stone_price form-control" name="est_stones_item[stone_price][]" value="'+pitem['stone_price']+'"  style="width:100%;" readonly/></td>'



			});







		}







	    $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').append(row);



	    $('#cus_stoneModal').modal('show');



}



/*Non Tag Receipt*/



$('#nontag_receipt_search').on('click', function () {



    get_nontag_receiptedList();



});



function get_nontag_receiptedList() {



    var company_name = $('#company_name').val();



    var from_date = $('#rpt_payments1').html();



    var to_date = $('#rpt_payments2').html();



    var branch_name = ($('#branch_name').val() != '' && $('#branch_name').val() != undefined ? $('#branch_name').val() : $("#branch_select option:selected").text());



    var report_name = "Non Tag Receipt Details";



    var optional = '';



    var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"



        + "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";



    $("div.overlay").css("display", "block");



    my_Date = new Date();



    $(".overlay").css("display", "block");



    $.ajax({



        type: "POST",



        url: base_url + "index.php/admin_ret_purchase/nontag_receipt/ajax",



        data: {'from_date': $('#rpt_payments1').html(),'to_date': $('#rpt_payments2').html()},



        dataType: 'JSON',



        success: function (data) {



            var a = 1;



            var list = data.list;



            var oTable = $('#nontag_receipt_list').DataTable();



            oTable.clear().draw();



            if (list != null && list.length > 0) {



                oTable = $('#nontag_receipt_list').dataTable({



                    "bDestroy": true,



                    "bInfo": true,



                    "bFilter": true,



                    "bSort": true,



                    "ordering": false,



                    "dom": 'lBfrtip',



                    "columnDefs": [



                        {







                            targets: [0,1,2,8,9,10,11],



                            className: 'dt-body-right',



                            targets: [3,4,5,6,7],



                            className: 'dt-body-left'



                        },



                    ],



                    "buttons": [



                        {



                            extend: 'print',



                            footer: true,



                            title: '',



                            messageTop: title,



                            customize: function (win) {



                                $(win.document.body).find('table')



                                    .addClass('compact')



                                    .css('font-size', '10px');



                            },



                        },



                        {



                            extend: 'excel',



                            footer: true,



                            title: 'Non Tag Receipt Details',



                        }



                    ],



                    "tableTools": { "buttons": [{ "sExtends": "xls", "oSelectorOpts": { page: 'current' } }, { "sExtends": "pdf", "oSelectorOpts": { page: 'current' } }] },



                    "aaData": list,



                    "aoColumns": [



                        {



                            "mDataProp": function (row, type, val, meta) {



                                return row.id_nontag_receipt;



                            }



                        },



                        { "mDataProp": "nt_receipt_no" },



                        { "mDataProp": "lot_id" },



                        { "mDataProp": "branch_name" },



                        { "mDataProp": "section_name" },



                        { "mDataProp": "product_name" },



                        { "mDataProp": "design_name" },



                        { "mDataProp": "sub_design_name" },



            			{



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.pcs);



            				}



            			},



                        {



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.grs_wt);



            				}



            			},



                        {



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.less_wt);



            				}



            			},



                        {



            				"mDataProp": function (row, type, val, meta) {



            					return money_format_india(row.net_wt);



            				}



            			},



            			{ "mDataProp": "remark" },



                    ]



                });



            }



            $("div.overlay").css("display", "none");



        }



    })



}



function get_NontagLots()



{



	$.ajax({



	type: 'GET',



	url: base_url+'index.php/admin_ret_purchase/nontag_receipt/get_NontagLots',



	dataType:'json',



	success:function(data){



	    var id=$('#select_lot').val();



	    var id_lot= $('#select_lot').val();



		$.each(data, function (key, item) {



		    $("#select_lot").append(



		    $("<option></option>")



		    .attr("value", item.lot_no)



		    .text(item.lot_no)



		    );



		});



		$("#select_lot").select2(



		{



			placeholder:"Select Lot",



			closeOnSelect: true



		});







		if($("#select_lot").length)



		{



		    $("#select_lot").select2("val",(id!='' && id>0? id:(id_lot!='' && id_lot!=undefined ? id_lot :'')));



		}



		    $(".overlay").css("display", "none");



		}



	});



}



$('#select_lot').on('change',function()



{



    if(this.value!='')



    {



        get_lot_nontag_details();



    }







    resetNtReceiptForm();



});



function resetNtReceiptForm()



{



    $('.nt_pcs').val('');



    $('.nt_grswt').val('');



    $('.nt_lesswt').val('');



    $('.nt_netwt').val('');



    $('#act_nt_pcs').val('');



    $('#act_nt_grswt').val('');



    $('#act_nt_lesswt').val('');



    $('#act_nt_netwt').val('');



    $('.disp_lot_pcs').html('');



    $('.disp_lot_wt').html('');



    $('.disp_lot_nwt').html('');



    $('.disp_lot_ntag_pcs').html('');



    $('.disp_lot_ntag_wt').html('');



    $('.disp_lot_ntag_nwt').html('');



    $('.disp_lot_bal_pcs').html('');



    $('.disp_lot_bal_wt').html('');



    $('.disp_lot_bal_nwt').html('');



    $('#lt_metal').html('');



    $('#lt_category').html('');



    $('#lt_date').html('');



    $('#lt_karigar_name').html('');



    $('#product_sel').select2('val','');



    $('#design_sel').select2('val','');



    $('#sub_design_sel').select2('val','');



}



function get_lot_nontag_details()



{



    $('#product_sel option').remove();



    my_Date = new Date();



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/get_lot_nontag_details",



        data:{'lot_no':$('#select_lot').val()},



        type:"POST",



        dataType:"JSON",



        success:function(data)



        {



            nontag_list = data;







            var id_product=$('#product_sel').val();



            $.each(data, function (key, item)



            {



                $("#product_sel").append(



                $("<option></option>")



                .attr("value", item.id_product)



                .text(item.product_name)



                .attr("data-id_lot_inward_detail", item.id_lot_inward_detail)



                );



                $("#product_sel").select2("val",(id_product!='' && id_product>0?id_product:''));



            });



        }



    });



}



$('#product_sel').on('change',function()



{



    $('#design_sel option').remove();



    if(this.value!='')

    {



        var id_design=$('#design_sel').val();



        getNonTagLotItemDetails();



        get_ProductDesign()





    }



})



$('#design_sel').on('change',function()



{



    $('#sub_design_sel option').remove();



    if(this.value!='')



    {



        get_ActiveSubDesigns();







    }



})



/*$('#sub_design_sel').on('change',function()



{



    if(this.value!='')



    {



        getNonTagLotItemDetails();



    }







})*/



function getNonTagLotItemDetails()



{



    my_Date = new Date();



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/getNonTagLotItemDetails",



        data:{'lot_no':$('#select_lot').val(),'id_product':$('#product_sel').val(),'id_lot_inward_detail':$('#product_sel option:selected').attr('data-id_lot_inward_detail')},



        type:"POST",



        dataType:"JSON",



        success:function(data)



        {



            var nt_weight_per=$('#nontag_weight_per').val();



            console.log('nt_weight_per',nt_weight_per);



            if(data.length>0)



            {



                $.each(data, function (key, item)



                {



                    console.log('grs_wt',item.grs_wt);



                    if(nt_weight_per>0)



                    {



                        $('#actual_nt_grswt').val(parseFloat((((item.grs_wt*nt_weight_per)/100)+parseFloat(item.grs_wt))).toFixed(3));



                    }



                    else



                    {



                        $('#actual_nt_grswt').val(item.grs_wt);



                    }



                    $('.nt_pcs').val(item.pcs);



                    $('.nt_grswt').val(item.grs_wt);



                    $('.nt_lesswt').val(item.less_wt);



                    $('.nt_netwt').val(item.net_wt);



                    $('.disp_lot_bal_pcs').html(item.pcs);



                    $('.disp_lot_bal_wt').html(item.grs_wt);



                    $('.disp_lot_bal_nwt').html(item.net_wt);



                    if(item.lotdet.length>0)



                    {



                        $.each(item.lotdet, function (key, val)



                        {



                            $('.disp_lot_pcs').html(val.no_of_piece);



                            $('.disp_lot_wt').html(val.gross_wt);



                            $('.disp_lot_nwt').html(val.net_wt);



                        });



                    }



                    if(item.completedLot.length>0)



                    {



                        $.each(item.completedLot, function (key, val)



                        {



                            $('.disp_lot_ntag_pcs').html(val.nt_pcs);



                            $('.disp_lot_ntag_wt').html(val.nt_grswt);



                            $('.disp_lot_ntag_nwt').html(val.nt_net_wt);



                        });



                    }



                    $('#lt_metal').html(item.metal);



                    $('#lt_category').html(item.category);



                    $('#lt_date').html(item.po_date);



                    $('#lt_karigar_name').html(item.karigar);



                    $('#id_lot_inward_detail').val(item.id_lot_inward_detail);







                });



            }



            else



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>No Records to Update"});



                resetNtReceiptForm();



            }



        }



    });



}



$('.nt_grswt').on('change',function()



{



    var act_nt_grswt = $('#actual_nt_grswt').val();



    if(parseFloat(act_nt_grswt) < parseFloat(this.value))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Maximum Grs Wt value is "+act_nt_grswt+""});



        $('.nt_grswt').val(act_nt_grswt);



    }



    else



    {



        $('.nt_grswt').val(this.value);



        $('.nt_netwt').val(this.value);







    }



})



$('.nt_netwt').on('change',function()



{



    var nt_grswt = $('.nt_grswt').val();



    if(parseFloat(nt_grswt) < parseFloat(this.value))



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Entered Net Wt Greater Than Actual Grs Wt"});



        $('.nt_netwt').val(nt_grswt);



    }



    else



    {



        $('.nt_netwt').val(this.value);



        $('.nt_lesswt').val(parseFloat(nt_grswt - this.value).toFixed(3));



    }



})



$('#nt_receipt_submit').on('click',function()



{



    var allowSubmit = true;



    if($('#branch_select').val()=='' || $('#branch_select').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Branch"});



        allowSubmit=false;



    }



    else if($('#select_section').val()=='' ||  $('#select_section').val()==null)



    {



        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Section"});



        allowSubmit=false;



    }



    else if($('#product_sel').val()=='' ||  $('#product_sel').val()==null)



    {



        $.toaster({ priority : 'warning', title : '', message : ''+"</br>Select Product" });



        allowSubmit=false;



    }



    else if($('#design_sel').val()=='' ||  $('#design_sel').val()==null)



    {



        $.toaster({ priority : 'warning', title : '', message : ''+"</br>Select Design" });



        allowSubmit=false;



    }



    else if($('#sub_design_sel').val()=='' ||  $('#sub_design_sel').val()==null)



    {



        $.toaster({ priority : 'warning', title : '', message : ''+"</br>Select Sub Design" });



        allowSubmit=false;



    }



    if(allowSubmit)



    {



        SaveNtReceiptForm();



    }







})



function SaveNtReceiptForm()



{



    $("div.overlay").css("display", "block");



    var postData = $('#nt_receipt').serialize();



    var url=base_url+ "index.php/admin_ret_purchase/nontag_receipt/save?nocache=" + my_Date.getUTCSeconds();



    $.ajax({



        url:url,



        data: postData,



        type:"POST",



        dataType:"JSON",



        success:function(data){



            if(data.status)



            {



                $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                $("div.overlay").css("display", "none");



                window.location.href= base_url+'index.php/admin_ret_purchase/nontag_receipt/list';



            }else



            {



                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>"+data.message});



                $("div.overlay").css("display", "none");



            }







        },



        error:function(error)



        {



            $("div.overlay").css("display", "none");



        }



    });



}



function get_tds_percent(karid)

{



    $(".overlay").css('display','block');

    my_Date = new Date();

    $.ajax({

    type: 'POST',

    url:base_url+ "index.php/admin_ret_purchase/get_tds_percent?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),

    dataType:'json',

    data: {"id_karigar":karid},

    success:function(data)

        {

              tds_details = data.tds_details;



              $('#opening_balance').val(tds_details.balance);



              $('#fin_year_code').val(tds_details.fin_year_code);



              $('#tds_purchase_limit').val(data.settings);







            $(".overlay").css("display", "none");

        }

    });

}



/*Non Tag Receipt*/







$('#save_credit_entry').on('click',function(){

    if($('#trans_amount').val()=='' || $('#trans_amount').val()==0){

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Enther the Amount."});

    }

    else if($('#select_karigar').val()=='' || $('#select_karigar').val()==null)

    {

        $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Please Select the Karigar."});

    }else{

            my_Date = new Date();

            if($('#crdrid').val() == "")

            {

                var url = base_url+ "index.php/admin_ret_purchase/credit_debit_entry/save?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours();

            }

            else

            {

                var url = base_url+ "index.php/admin_ret_purchase/credit_debit_entry/update?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours();

            }

           $('#save_credit_entry').prop('disabled',true);

             var selectedValue = $('input[name="credit[accountto]"]:checked').val();

				$.ajax({

                url:url,

				type: 'POST',

				data:{'karigar':$('#select_karigar').val(),'accountto': selectedValue,'crdrid':$('#crdrid').val(),

                'transamount':$('#trans_amount').val(),'naration':$('#naration').val(),'transtype':$('#transtype').val()},

				dataType:'json',

				success:function(data){

    					if(data.status == true)

    					{

							$.toaster({ priority : 'success', title : 'Success!', message : ''+"</br> Credit Entry Saved SuccessFully..."});

							window.location.href = base_url + 'index.php/admin_ret_purchase/credit_debit_entry/list';

    					    $("div.overlay").css("display", "none");

    					}

    					else

    					{

							$.toaster({ priority : 'warning', title : 'Success!', message : ''+"</br> Unable to Credit Entry"});

    					    window.location.reload();

    					    $("div.overlay").css("display", "none");

    					}

    		        },

    		        error:function(error)

    		        {

    		            $("div.overlay").css("display", "none");

    		        }

    		    });

    }

});



$('#credit_debit_search').click(function (event) {



    set_credit_debit_table();



});



function set_credit_debit_table()



{





    var from_date = $('#rpt_payments1').html();

	var to_date = $('#rpt_payments2').html();

	var company_name = $('#company_name').val();

	var branch_name = ($('#branch_name').val() != '' && $('#branch_name').val() != undefined ? $('#branch_name').val() : $("#branch_select option:selected").text());

	var report_name = "CREDIT AND DEBIT ENTRY REPORT";

	var optional = '';

	var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"

		+ "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";





    my_Date = new Date();



    $.ajax({



		     url: base_url+"index.php/admin_ret_purchase/credit_debit_entry/ajax?nocache=" + my_Date.getUTCSeconds(),



             dataType:"JSON",



             type:"POST",



             data:{'from_date':$('#rpt_payments1').text(),'to_date':$('#rpt_payments2').text(),'transcation_type':$("#transcation_type").val(),'status_type':$("#status_type").val(),'trans_type':$("#trans_type").val()},



             success:function(data){



				 console.log(data);



                 var list    = data.list;



                 var access     = data.access;



                 $('#total_quality').text(list.length);



				 if(access.add == '0')



				{



					 $('#add_quality').attr('disabled','disabled');



				}





             var oTable = $('#trans_list').DataTable();



                 oTable.clear().draw();







                         if (list!= null && list.length > 0)



                            {



                            oTable = $('#trans_list').dataTable({



                                "bDestroy": true,



                                "bInfo": true,



                                "bFilter": true,



                                "order": [[ 0, "desc" ]],



                                "scrollX":'100%',



                                "bSort": true,



                                "order": [[ 0, "desc" ]],



                                "dom": 'lBfrtip',



                                "columnDefs": [



                                    {







                                        targets: [5],



                                        className: 'dt-body-right'



                                    },



                                ],



                                "buttons": [



                                    {

                                      extend: 'print',



                                      footer: true,



                                      title: '',



                                      messageTop: title,



                                          customize: function ( win ) {



                                       $(win.document.body).find( 'table' )



                                       .addClass( 'compact' )



                                       .css( 'font-size', '10px' );



                                       },



                                    },



                                    {

                                       extend:'excel',



                                       footer: true,



                                        title: 'Credit and Debit Entry Report',



                                     }



                                    ],



                                "aaData": list,



                                "aoColumns": [  { "mDataProp": "transbillno" },



                                                { "mDataProp": "transdate" },



												{ "mDataProp": "karigar" },



                                                 { "mDataProp": "accountto" },



												{ "mDataProp": "transtype" },



												{ "mDataProp": "amount" },



												{ "mDataProp": "naration" },



                                                { "mDataProp": "pay_status" },





												{ "mDataProp": function ( row, type, val, meta ) {



													id= row.crdrid;

                                                    let today = new Date();

                                                    let formattedDate = String(today.getDate()).padStart(2, '0') + "-" + 
                                                    String(today.getMonth() + 1).padStart(2, '0') + "-" + 
                                                    today.getFullYear();


                                                    print_url = (base_url+'index.php/admin_ret_purchase/credit_debit_entry/credit_debit_acknolodgement/'+id);



													// edit_url=(base_url+'index.php/admin_ret_purchase/credit_debit_entry/edit/'+id);



													// delete_confirm=(access.delete=='1' ?'#confirm-delete':'');



													// delete_url=(access.delete=='1' ? base_url+'index.php/admin_ret_purchase/credit_debit_entry/delete/'+id : '#' );



                                                    // <a href="#" class="btn btn-danger btn-del" data-href='+delete_url+' data-toggle="modal" data-target="#confirm-delete" ><i class="fa fa-trash"></i></a>



                                                    action_content = '<a href="' + print_url + '" target="_blank" class="btn btn-info btn-print" data-toggle="tooltip" title="Credit Debit Copy"><i class="fa fa-print"></i></a>' +



                                                    (row.crdr_status == 1 && access.delete == '1' && formattedDate == row.transdate ? '<button class="btn btn-warning" onclick="confirm_crdr_cancel(' + id + ')"><i class="fa fa-close"></i></button>' : '    ');



                                                    // action_content='<a href='+edit_url+' class="btn btn-primary btn-edit" id="edit" role="button" data-toggle="modal" data-id='+id+'><i class="fa fa-edit" ></i></a> '



													return action_content;



													}







                                                }

                                                ],



                                                "footerCallback": function( row, data, start, end, display )



                                                {



                                                    if(data.length>0){



                                                        var api = this.api(), data;



                                                        for( var i=0; i<=data.length-1;i++){



                                                            var intVal = function ( i ) {



                                                                return typeof i === 'string' ?



                                                                i.replace(/[\$,]/g, '')*1 :



                                                                typeof i === 'number' ?



                                                                i : 0;



                                                            };







                                                            $(api.column(0).footer() ).html('TOTAL');





                                                            amount = api



                                                            .column(5)



                                                            .data()



                                                            .reduce( function (a, b) {



                                                                return intVal(a) + intVal(b);



                                                            }, 0 );



                                                            $(api.column(5).footer()).html(parseFloat(amount).toFixed(2));







                                                    }



                                                    }else{



                                                         var api = this.api(), data;







                                                    }



                                                }



                                });



                            }



                      },



                      error:function(error)



                      {



                         $("div.overlay").css("display", "none");



                      }



                  });



}



function credit_edit_data() {

	$(".overlay").css('display', 'block');

	let crdrid = $("#crdrid").val();

	if (crdrid > 0) {

		my_Date = new Date();

		$.ajax({

			type: 'POST',

			url: base_url + 'index.php/admin_ret_purchase/credit_debit_entry/cd_edit/' + crdrid + '?nocache=' + my_Date.getUTCSeconds(),

			dataType: 'json',

			success: function (data) {

                console.log(data.credit);



					// $.each(data.credit,function (key, item) {



                        var select_karigar = "";



                        console.log(karigar_details);



                        $.each(karigar_details, function (key, sec_item) {



                            var selected = sec_item.id_karigar == data.credit.supid ? "selected" : "";



                            select_karigar += "<option value='" + sec_item.id_karigar + "' " + selected + ">" + sec_item.karigar + ' - ' + sec_item.code + "</option>";

                         });





                        console.log(select_karigar);



                        $('#select_karigar').html(select_karigar);



                        $('#select_karigar').val(data.credit.supid).trigger('change');



                        $('input[name="credit[accountto]"][value="' + data.credit.accountto + '"]').prop('checked', true);





                        var selectedValue = data.credit.transtype;



                        $('#transtype').val(selectedValue);



                        $('#trans_amount').val(data.credit.transamount);



                        $('#naration').val(data.credit.naration);







					// });

				}



			// }

		});

	}

	$(".overlay").css('display', 'none');

}







$("#select_branch").on("change",function (){







    var ho = $("#head_office").val();



    if(this.value){



        if(this.value == ho ){



            $(".branch_change").css("display","block");



            $(".against_pur_order").css("display","block");



            $('#metal_issue_type_normal').attr('checked', true);



            $('.issue_against_nontag').attr('checked', true);



            $(".issue_from").css("display","none");



        } else {







            $('#metal_issue_type_normal').attr('checked', true);



            $('.issue_against_nontag').attr('checked', true);



            $('#aganist_supllier_no').attr('checked', true);



            $('.issue_against_nontag').trigger("change");



            $(".nontag_issue_from").css("display","none");



            // $('#aganist_supllier_no').attr('checked', true);



            $(".nontag_issue_from").css("display","none");



            $(".branch_change").css("display","none");



            $(".against_pur_order").css("display","none");



        }

    }





});





function create_repair_order_details(data){

    var rowExists=false;

    var trHtml='';

    $('#metal_details tbody').html('');

    $.each(data, function(key,item)

    {

        var trHtml='';

        if(item.tagging_status==15) // Metal issued tag

        {

            rowExists=true;

            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Issued.."});

        }



        $('#metal_details > tbody tr').each(function(bidx, brow)

        {

            curRow = $(this);

            if(curRow.find('.tag_id').val()==item.tag_id)

            {

                rowExists=true;

                $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Item Already Exists.."});

            }

        });



        var uom_list = "<option value=''>-UOM-</option>";

        $.each(uom_details, function (pkey, pitem)

        {

            var uom_selected ="";

            item.uom = 1 //default for tagging

            if(pitem.uom_id==item.uom)

            {

                uom_selected = "selected='selected'";

            }

            uom_list += "<option value='"+pitem.uom_id+"' "+uom_selected+">"+pitem.uom_name+"</option>";

        });



        var purity = "<option value='"+item.id_purity+"'>"+item.purity+"</option>";

        var purewt = 0;

        id = new Date().valueOf();

        if(!rowExists)

        {

            trHtml+='<tr id="'+id+'">'



                +'<td style="width:100px;"><input type="checkbox" class="id_kar_issue" name="metal_details[id_kar_issue][]" value="">' +item.tag_code+ '<input type="hidden" class="tag_id" name="metal_details[tag_id][]" value="'+item.tag_id+'"></td>'



                +'<td>'+item.tag_date+'</td>'



                +'<td>'+item.supplier_name+'</td>'



                +'<td style="width:100px;"><input type="hidden" class="metal" name="metal_details[metal][]" value="'+item.id_metal+'"><input type="hidden" class="category" name="metal_details[category][]" value="'+item.cat_id+'">'+item.catname+'<input type="hidden" class="issue_against" name="metal_details[issue_against][]" value="'+$("input[type='radio'][name='issue[issue_aganist]']:checked").val()+'"><input type="hidden" class="issue_against_po" name="metal_details[issue_against_po][]" value="'+$("input[type='radio'][name='issue[issue_against_po]']:checked").val()+'"><input type="hidden" class="po_item_id" name="metal_details[po_item_id][]" value=""></td>'



                +'<td style="width:100px;"><input type="hidden" class="id_section" name="metal_details[id_section][]" value="'+item.id_section+'">'+item.section+'</td>'



                +'<td style="width:100px;"><input type="hidden" class="product" name="metal_details[id_product][]" value="'+item.pro_id+'"><input type="hidden" class="design" name="metal_details[id_design][]" value="'+item.des_id+'"><input type="hidden" class="id_sub_design" name="metal_details[id_sub_design][]" value="'+item.id_sub_design+'">'+item.product_name+'</td>'



                +'<td><select class="form-control" id="select_purity"  style="width:100px;">'+purity+'</select></td>'



                +'<td><div class="input-group"><span><input type="number" class="issue_pcs form-control" style="width:100px;"name="metal_details[pcs][]" value="'+item.piece+'" readonly><input type="hidden" class="available_pcs form-control" name="" value="'+item.piece+'"></span><span>&nbsp; of &nbsp;'+item.piece+'<br/></span></div></td>'



                +'<td><div class="input-group"><span><input class="issue_weight form-control" type="number" name="metal_details[weight][]" value="'+item.weight+'" style="width:80px;" readonly/><input type="hidden" class="available_weight" name="" value="'+item.weight+'"><select class="uom_id form-control" name="metal_details[uom_id][]" style="width: 80px;">'+uom_list+'</select></span><span>&nbsp; of &nbsp;'+ item.weight +'<br/></span></div></td>'



                +'<td><div><input type="number" readonly class="issue_net_wt form-control" style="width:100px;"name="metal_details[issue_net_wt][]" value="'+item.net_wt+'" ></div></td>'



                +'<td><div class="form-group"><div class="input-group"><input type="number" readonly class="issue_less_wt form-control" style="width:100px;"name="metal_details[issue_less_wt][]" value="'+item.less_wt+'" ><span class="input-group-addon input-sm add_tag_lwt" onClick="create_new_empty_est_cus_stone_item($(this).closest(\'tr\'));" >+</span></div></td>'



                +'<td><div><input type="number" class="issue_mc form-control" style="width:100px;"name="metal_details[mc][]" value="'+item.purchase_mc_value+'" ></div></td>'



                +'<td><input type="hidden" class="stone_details form-control" style="width:100px;"name="metal_details[stone_details][]" value=\''+JSON.stringify(item.stone_details)+'\' > <select class="mc_type form-control" name="metal_details[mc_type][]" style="width: 80px;"><option '+(item.purchase_mc_type == 1?"selected":"")+' value="1">PCS</option><option value="2" '+(item.purchase_mc_type == 2?"selected":"")+' >GRAM</option></select></td>'



                +'<td><div><input type="number" class="issue_va form-control" style="width:100px;"name="metal_details[issue_va][]" value="'+item.purchase_wastage+'" ></div></td>'



                +'<td><div><input type="number" readonly class="issue_va_wt form-control" style="width:100px;"name="metal_details[issue_va_wt][]" value="" ></div></td>'



                +'<td><div><input type="number" class="issue_touch form-control" style="width:100px;"name="metal_details[issue_touch][]" value="'+item.purchase_touch+'" ></div></td>'



                +'<td><select style="width:150px;" class="purchase_calc_type form-control" name="metal_details[calc_type][]" style="width: 80px;"><option value="1">Weight x Rate</option><option value="2">Purchase Touch</option><option value="3">Weight x Wastage %</option></select></td>'



                +'<td><input type="number" class="pur_weight form-control" id="pur_weight" name="metal_details[pur_weight][]" value="'+purewt+'" style="width:80px;" readonly></td>'



                +'<td><input type="hidden" class="is_repair_item" name="metal_details[is_repair_item][]" value="1"><input type="hidden" class="calculation_based_on" name="metal_details[calculation_based_on][]" value="'+item.calculation_based_on+'" ><a href="#" class="btn btn-danger btn-del btn-xs" style="padding:5px;" onClick="remove_row($(this).closest(\'tr\'));"><i class="fa fa-trash"></i></a></td>'



            +'</tr>';



            if($('#metal_details > tbody  > tr').length>0)

            {

                $('#metal_details > tbody > tr:first').before(trHtml);

            }else{

                $('#metal_details tbody').append(trHtml);

            }



            $('#metal_details > tbody').find('#select_purity').select2();



            $('#metal_details > tbody').find('#select_purity').select2({



                placeholder: "Purity",



                allowClear: true



            });



            $("div.overlay").css("display", "none");

        }

    });



    calculateMetalIssueTotal();



    calculateMetalIssuePureWt();



    calculateRepairMetalIssuePureWt();

}







//Grn Entry Images



//TAG IMAGE



function take_snapshot(type)



{

    //Snap Shots Disables



      $('#snap_shots').prop('disabled',true);



        if(type == 'pre_images'){



            preview = 'uploadArea_p_stn';



        }



        Webcam.snap( function(data_uri) {



           $(".image-tag").val(data_uri);



            pre_img_resource.push({'src':data_uri,'name':(Math.floor(100000 + Math.random() * 900000))+'jpg','is_default':"0"});



            pre_img_files.push(data_uri);



            alert("Your Webcam Images Take Snap Shot Successfullys.");



        } );



        if(pre_img_resource.length > 0)



        {



            $("#image_lot_list").css('display','block');



            $("#lot_images_count").text(pre_img_resource.length);



        }



        else



        {



            $("#image_lot_list").css('display','none');



            $("#lot_images_count").text('0');



        }



    setTimeout(function(){



        var resource = [];



        $('#'+preview+' div').remove();



        if(type == 'pre_images'){



            resource = pre_img_resource;



        }



        $.each(resource,function(key,item){



            if(item){



            var div = document.createElement("div");



            div.setAttribute('class','images');



            div.setAttribute('id',+key);



            param = {"key":key,"preview":preview,"stone_type":type};



            div.innerHTML+= "<span style='float:left;'><a onclick='remove_stn_img("+JSON.stringify(param)+")' style='cursor:pointer;color:inherit;' data-toggle='tooltip' data-placement='bottom' title='Delete This Images'>&nbsp;<i class='fa fa-trash'></i></a></span>&nbsp;&nbsp;<label style='display:none;'>Is Default</label><span><input type='hidden' class='tag_default_"+key+"'  value='0' onchange='default_stn_img("+JSON.stringify(param)+",event)' data-toggle='tooltip' data-placement='bottom' title='Click Here To Set Default Image' style='float:right;margin-right:20px;'></span><img class='thumbnail' src='" + item.src + "'" +"style='width: 100px;height: 100px;'/>";



            $('#'+preview).append(div);		   	}



            $('#lot_img_upload').css('display','');



        });



        $('#snap_shots').prop('disabled',false);



        var default_keyimage  = typeof



        localStorage.getItem("key") !=='undefined' ? localStorage.getItem("key"):'0';



        if(default_keyimage){



        $(".tag_default_"+default_keyimage).prop('checked', true);



         $(".tag_default_"+default_keyimage).val('1');



         localStorage.setItem("key",default_keyimage);



        }



        else



        {



        $(".tag_default_0").prop('checked', true);



        $(".tag_default_0").val('1');



        localStorage.setItem("key",'0');



    }



    },1000);



}



 function image_preview_validaion(type)



 {



     if(type == 'pre_images'){



        preview = 'uploadArea_p_stn';



    }



    if(pre_img_resource.length > 0)



        {



            $("#image_lot_list").css('display','block');



        }



        else



        {



            $("#image_lot_list").css('display','none');



        }



     setTimeout(function(){



        var resource = [];



        $('#'+preview+' div').remove();



        if(type == 'pre_images'){



            resource = pre_img_resource;



        }



        $.each(resource,function(key,item){



           if(item)



           {



               var div = document.createElement("div");



                div.setAttribute('class','images');



                div.setAttribute('id',+key);



                param = {"key":key,"preview":preview,"stone_type":type};



                div.innerHTML+= "<span style='float:left;'><a onclick='remove_stn_img("+JSON.stringify(param)+")' style='cursor:pointer;color:inherit;' data-toggle='tooltip' data-placement='bottom' title='Delete This Images'>&nbsp;<i class='fa fa-trash'></i></a></span>&nbsp;&nbsp;<label style='display:none;'>Is Default</label><span><input type='hidden' class='tag_default_"+key+"'  value='0' onchange='default_stn_img("+JSON.stringify(param)+",event)' data-toggle='tooltip' data-placement='bottom' title='Click Here To Set Default Image' style='float:right;margin-right:20px;'></span><img class='thumbnail' src='" + item.src + "'" +"style='width: 100px;height: 100px;'/>";



                $('#'+preview).append(div);



           }



        });



          var catRow              = $('#custom_active_id').val();



          var default_keyimage    = $('#tag_img_default').val();



           if(default_keyimage)



           {



             $(".tag_default_"+default_keyimage).prop('checked', true);



             $(".tag_default_"+default_keyimage).val('1');



             localStorage.setItem("key",default_keyimage);



           }



           else



           {



             $(".tag_default_0").prop('checked', true);



             $(".tag_default_0").val('1');



             localStorage.setItem("key",'0');



           }



    },100);



 }



function grn_update_image_upload(curRow,id)



{



    // Check Validations



    pre_img_resource   = [];



    pre_img_files      = [];



    if($('#tag_images').val() != '')



    {



        var pre_images    = JSON.parse($('#tag_images').val());



        pre_img_resource  = pre_images;





        image_preview_validaion('pre_images');



    }



    else



    {



        image_preview_validaion('pre_images');



    }



    $('#grn_imageModal').modal('show');





    localStorage.removeItem("key");



    $('#bulktag_images').trigger('click');



}





$("#pre_images").on('change',function(){



    validateCertifImg(this.id);



});



function validateCertifImg(type)



{



         if(type == 'pre_images'){



            preview = 'uploadArea_p_stn';



        }



        var files = event.target.files;



        var html_1="";



         for (var i = 0; i < files.length; i++)



         {



            var file = files[i];



            if(file.size> 1048576)



             {



                  alert('File size cannot be greater than 1 MB');



                  files[i] = "";



                  return false;



             }



             else



             {



                 var fileName =file.name;



                var ext = fileName.substring(fileName.lastIndexOf('.') + 1);



                ext = ext.toLowerCase();



                if(ext != "jpg" && ext != "png" && ext != "jpeg")



                {



                    alert("Upload JPG or PNG Images only");



                    files[i] = "";



                }



                else



                {



                    var reader = new FileReader();



                    reader.onload = function (event) {



                        if(type == 'pre_images'){



                            pre_img_resource.push({'src':event.target.result,'name':fileName});



                            pre_img_files.push(file);



                        }



                    }



                    if (file)



                    {



                        reader.readAsDataURL(file);



                    }



                    /*else



                    {



                        preview.prop('src','');



                    }*/



                }



             }



        }



        setTimeout(function(){



            var resource = [];



            $('#'+preview+' div').remove();



            if(type == 'pre_images'){



                resource = pre_img_resource;



            }



            $.each(resource,function(key,item){



               if(item)



               {



                       var div = document.createElement("div");



                    div.setAttribute('class','col-md-4');



                    div.setAttribute('id',+key);



                    param = {"key":key,"preview":preview,"stone_type":type};



                    //div.innerHTML+= "<a onclick='remove_stn_img('"+key+"','"+preview+"','"+type+"')'><i class='fa fa-trash'></i>Delete</a><img class='thumbnail' src='" + item.src + "'" +



                    div.innerHTML+= "<a onclick='remove_stn_img("+JSON.stringify(param)+")'><i class='fa fa-trash'></i>Delete</a><img class='thumbnail' src='" + item.src + "'" +



                    "style='width: 100px;height: 100px;'/>";



                    $('#'+preview).append(div);



               }



               $('#lot_img_upload').css('display','');



            });



        },1000);



}



function default_stn_img(param,event)



{



 var current_status       = event.target.checked;



 var parameter            = param.key;



 $('#uploadArea_p_stn div').each(function (index,value) {



    var image_class      = $(this).find('span input').attr('class');



     var image_class_key  = 'tag_default_'+parameter;



     if(image_class == image_class_key)



     {



         $("."+image_class).prop('checked', true);



         $("."+image_class).val('1');



          localStorage.setItem("key", parameter);



     }



     else{



        $("."+image_class).prop('checked', false);



        $("."+image_class).val('0');



    }



});



}



function remove_stn_img(param)



{



 var current_status   = $(".tag_default_"+param.key).is(':checked');



  $('#'+param.preview+' #'+param.key).remove();



  if(pre_img_resource.length == 1){



               pre_img_resource    =  [];



               $("#lot_images_count").text(pre_img_resource.length);



               if(ctrl_page[2] == 'edit'){



                   remove_img(file,'certificates','precious_st_certif',id,imgs);



               }



           }



else{



    if(param.stone_type == 'pre_images'){



        pre_img_resource.splice(param.key,1);



        $("#lot_images_count").text(pre_img_resource.length);



        if(ctrl_page[2] == 'edit'){



            remove_img(file,'certificates','precious_st_certif',id,imgs);



        }



    }



}



if(current_status  ==  true) {



    var image_class_first = $('#uploadArea_p_stn div').find('span input').attr('class');



    $("."+image_class_first).prop('checked', true);



    $("."+image_class_first).val('1');



    var image_class_key  = image_class_first.split('_');



    localStorage.setItem("key", image_class_key[2]);



}



}



$('#grn_imageModal  #grn_update_img').on('click', function(){



        var set_inddefault_keyimage   = typeof	 localStorage.getItem("key") !=='undefined' ? localStorage.getItem("key"):'0';



        $('#grn_imageModal').modal('toggle');



        var copyrow_validation       = $('#tag_img_copy').val();



        if(copyrow_validation == '1')	{



            $('#tag_img_copy').val('2');



        }



        $('#tag_img').attr("data-img",encodeURIComponent(JSON.stringify(pre_img_resource)));



        $('#tag_image').val(encodeURIComponent(JSON.stringify(pre_img_resource)));



        $('#tag_images').val((JSON.stringify(pre_img_resource)));



        $('#tag_img_url').val(encodeURIComponent(JSON.stringify(pre_img_resource)));



        $('#tag_img_default').val(set_inddefault_keyimage);



        var get_default_image  = pre_img_resource[set_inddefault_keyimage];



        if(Object.keys(get_default_image).length>0)	{



            if(get_default_image.src!=""){



                $('#tagging_set_images').attr("src",get_default_image.src);



            }



        }



        else{



            var type      =  base_url+'assets/img/no_image.png';



            $('#tagging_set_images').attr("src",type);



        }



});



function remove_tag_img(param)



{



     $('#'+param.key).remove();



    pre_img_resource.splice(param.key,1);



}



$('#bulktag_images').on('change',function()



{



   validateBulkTagImages();



});



function validateBulkTagImages()



{



   //$('#wast_img_preview').html('');



   var preview = $('#pre_images');



   var files   = event.target.files;



   for(var i=0;i<files.length;i++)



   {



       const compress = new Compress();



       const product_images = [files[i]];



       compress.compress(product_images, {



           size: 4, // the max size in MB, defaults to 2MB



           quality: 0.75, // the quality of the image, max is 1,



           maxWidth: 1920, // the max width of the output image, defaults to 1920px



           maxHeight: 1920, // the max height of the output image, defaults to 1920px



           resize: true // defaults to true, set false if you do not want to resize the image width and height



       }).then((results) => {



           const output = results[0];



           total_files.push(output);



           const file   = Compress.convertBase64ToFile(output.data, output.ext);



           if(output.endSizeInMb < 2)



           {



               pre_img_resource.push({"src":output.prefix +output.data,'name':output.alt,'is_default':"0"});



           }



           else



           {



                   alert('File size cannot be greater than 1 MB');



                   files[i] = "";



                   return false;



           }



       });



   }



   setTimeout(function(){



       var resource = [];



       resource     = pre_img_resource;



       image_preview_validaion('pre_images');



   },500);



}



//TAG IMAGE



function get_pur_edit_img() {

   $("div.overlay").css("display", "block");

   my_Date = new Date();



   $.ajax({

       url: base_url + "index.php/admin_ret_purchase/grnentry/pur_edit?nocache=" + my_Date.getUTCSeconds(),

       dataType: "JSON",

       data: { 'grn_id': $('#grn_id').val() },

       type: "POST",

       success: function (data) {

           console.log(data);



           $.each(data.grn_img, function (key, items) {

               var image = items.image;

               console.log(image);



               pre_img_resource.push({

                   'src': base_url + 'assets/img/grn_entry/' + image, // Adjust this path as needed

                   'name': items.image, // Assuming 'name' should contain the image file name

                   'is_default': "0"

               });

           });





           $('#tag_images').val((JSON.stringify(pre_img_resource)));







           $("div.overlay").css("display", "none");

       },

       error: function (error) {



           $("div.overlay").css("display", "none");



       }

   });

}

$("#imageModal_bulk_edit").on("hidden.bs.modal", function () {



    $('#order_images').empty();



});

$(document).on('click', "#grn_list a.order_img", function(e) {



    e.preventDefault();



    id=$(this).data('id');



    $("#edit-id").val(id);



    view_dup_tag_history_imgs(id);



});



function view_dup_tag_history_imgs(order_id_img1)



{



	 update_tag_img_id1 = order_id_img1;



	 data = [];



     var tag_codeimage1 =  base_url+'assets/img/grn_entry';



	 $('#imageModal_bulk_edit').modal('show');



     $(".overlay").css('display',"none");



	 $.ajax({



        data: ( {'grn_id':order_id_img1}),



			  url:base_url+ "index.php/admin_ret_purchase/get_img_by_grn_id?nocache=" + my_Date.getUTCSeconds()+''+my_Date.getUTCMinutes()+''+my_Date.getUTCHours(),



			  dataType:"JSON",



			  type:"POST",



			  success:function(data){



				  retrive_img = data;



				  for (i = 0; i < data.length; i++)



				  {



					img_src = data[i].image;



					var preview = $('#order_images');



					var img = tag_codeimage1 + '/' + img_src;



					if (img_src) {



                    div = document.createElement("div");



                    div.setAttribute('class', 'col-md-3 images');



                    div.setAttribute('id', 'order_img_edit_' + [i]);







					$('.images').css('margin-right','25px');



                    key = [i];



                    param = img_src;







                    div.innerHTML += "<div class='form-group'><div class='image-input image-input-outline' id='kt_image_'><div class='image-input-wrapper'><img class='thumbnail' src='" + img + "'" + "style='width: 300px;height: 250px;'/><a href="+img+" download="+img_src+"><i class='fa fa-download btn btn-success'>Download</i></div></div></a>";



                    preview.append(div);







                }



            }







			  },



			  error:function(error)



				{



					$("div.overlay").css("display", "none");



				}



		  });



}



//Grn Entry Images



// Retagging Report



$('#retagging_items_search').click(function (event) {

    get_retagging_list();

});







function get_retagging_list() {

	var from_date = $('#rpt_from_date').html();

	var to_date = $('#rpt_to_date').html();

	var company_name = $('#company_name').val();

	var branch_name = ($('#branch_name').val() != '' && $('#branch_name').val() != undefined ? $('#branch_name').val() : $("#branch_select option:selected").text());

	var report_name = "RETAGGING REPORT";

	var optional = '';

	var title = "<div style='text-align: center;'><b><span style='font-size:15pt;'>" + company_name + "</span></b><b><span style='font-size:12pt;'></span></b></br>"

		+ "<span>" + report_print(branch_name, report_name, from_date, to_date, optional) + "</span>";

	$("div.overlay").css("display", "block");

	my_Date = new Date();

	$.ajax({

		url: base_url + "index.php/admin_ret_purchase/retagging_report/ajax?nocache=" + my_Date.getUTCSeconds(),

		data: { 'from_date': $('#rpt_from_date').html(), 'to_date': $('#rpt_to_date').html(), 'receipt_type': $('#receipt_type').val(), 'karigar': $('#karigar').val(), 'id_category': $('#select_category').val(), 'id_metal': $('#select_metal').val(), 'report_type': $('#report_type').val(), 'id_branch': $('#branch_select').val(),'bt_code': $('#bt_code').val() },

		dataType: "JSON",

		type: "POST",

		success: function (data) {

                 var list    = data.list;

                 var access     = data.access;

                 var oTable = $('#retagging_item_list').DataTable();

                 oTable.clear().draw();

                if(list!= null && list.length > 0)

                {

                    oTable = $('#retagging_item_list').dataTable({

                    "bDestroy": true,

                    "bInfo": true,

                    "bFilter": true,

                    "order": [[ 0, "desc" ]],

                    "scrollX":'100%',

                    "bSort": true,

                    "order": [[ 0, "desc" ]],

                    "dom": 'lBfrtip',

                    "buttons": [

						{

							extend: 'print',

							footer: true,

							title: "",

							messageTop: title,

							customize: function (win) {

								$(win.document.body).find('table')

									.addClass('compact')

									.css('font-size', 'inherit');

							},

						},

						{

							extend: 'excel',

							footer: true,

							title: 'Retagging Report',

						}

                        ],

                    "columnDefs": [

    					{

    						targets: [3,4,5, 6, 7, 8, 9, 10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],

    						className: 'dt-body-right'

    					},

    				],

                    "tableTools": { "buttons": [ { "sExtends": "xls", "oSelectorOpts": { page: 'current' } },{ "sExtends": "pdf", "oSelectorOpts": { page: 'current' } } ] },

                    "aaData": list,

                    "aoColumns": [  { "mDataProp": "branch_trans_code" },

                                    { "mDataProp": "bt_date" },

                                    { "mDataProp": "branch_name" },

									{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.op_blc_gwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.op_blc_nwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.op_blc_diawt);

                        			}},

                                    {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.op_blc_grm_wt);

                        			}},

                                    {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.op_blc_ct_wt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.inw_gwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.inw_nwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.inw_diawt);

                        			}},

                                    {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.inw_grm_wt);

                        			}},

                                     {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.inw_ct_wt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.ret_gwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.ret_nwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.return_diawt);

                        			}},

                                    {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.ret_grm_wt);

                        			}},

                                     {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.ret_ct_wt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.issue_gwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.issue_nwt);

                        			}},

                                    {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.issue_diawt);

                        			}},

                                    {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.issue_grm_wt);

                        			}},

                                    {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.issue_ct_wt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.retag_gwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.retag_nwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.retag_diawt);

                        			}},

                                    {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.retag_grm_wt);

                        			}},

                                     {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.retag_ct_wt);

                        			}},

                                    {

                                        "mDataProp": function(row , type , val , meta) {

                                            return money_format_india(row.pkt_gwt);

                                    }},



                                    {

                                        "mDataProp": function(row , type , val , meta) {

                                            return money_format_india(row.pkt_nwt);

                                    }},



                                    {

                                        "mDataProp": function(row , type , val , meta) {

                                            return money_format_india(row.pkt_diawt);

                                    }},



                                    {

                                        "mDataProp": function(row , type , val , meta) {

                                            return money_format_india(row.pkt_grm_wt);

                                    }},



                                     {

                                        "mDataProp": function(row , type , val , meta) {

                                            return money_format_india(row.pkt_ct_wt);

                                    }},



                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.closing_gwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.closing_nwt);

                        			}},

                        			{

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.closing_diawt);

                        			}},



                                    {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.closing_grm_wt);

                        			}},



                                    {

                        				"mDataProp": function (row, type, val, meta) {

                        					return money_format_india(row.closing_ct_wt);

                        			}},





                                    ],



                                    "footerCallback": function( row, data, start, end, display )

                        			{

                        				if(data.length>0){

                        					var api = this.api(), data;

                        					for( var i=0; i<=data.length-1;i++){

                        						var intVal = function ( i ) {

                        							return typeof i === 'string' ?

                        							i.replace(/[\$,]/g, '')*1 :



                        							typeof i === 'number' ?



                        							i : 0;



                        						};



                        						$(api.column(0).footer() ).html('Total');



                        						op_gwt = api

                        						.column(3)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(3).footer()).html(money_format_india(parseFloat(op_gwt).toFixed(3)));



                        						op_nwt = api

                        						.column(4)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(4).footer()).html(money_format_india(parseFloat(op_nwt).toFixed(3)));



                        						op_diawt = api

                        						.column(5)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(5).footer()).html(money_format_india(parseFloat(op_diawt).toFixed(3)));



                                                op_grm_wt = api

                        						.column(6)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(6).footer()).html(money_format_india(parseFloat(op_grm_wt).toFixed(3)));



                                                op_ct_wt = api

                        						.column(7)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(7).footer()).html(money_format_india(parseFloat(op_ct_wt).toFixed(3)));





                        						inw_gwt = api

                        						.column(8)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(8).footer()).html(money_format_india(parseFloat(inw_gwt).toFixed(3)));



                        						inw_nwt = api

                        						.column(9)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(9).footer()).html(money_format_india(parseFloat(inw_nwt).toFixed(3)));



                        						inw_diawt = api

                        						.column(10)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(10).footer()).html(money_format_india(parseFloat(inw_diawt).toFixed(3)));



                                                inw_grm_wt = api

                        						.column(11)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(11).footer()).html(money_format_india(parseFloat(inw_grm_wt).toFixed(3)));



                                                inw_ct_wt = api

                        						.column(12)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(12).footer()).html(money_format_india(parseFloat(inw_ct_wt).toFixed(3)));



                        						ret_gwt = api

                        						.column(13)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(13).footer()).html(money_format_india(parseFloat(ret_gwt).toFixed(3)));



                        						ret_nwt = api

                        						.column(14)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(14).footer()).html(money_format_india(parseFloat(ret_nwt).toFixed(3)));



                        						ret_diawt = api

                        						.column(15)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(15).footer()).html(money_format_india(parseFloat(ret_diawt).toFixed(3)));



                                                ret_grm_wt = api

                        						.column(16)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(16).footer()).html(money_format_india(parseFloat(ret_grm_wt).toFixed(3)));



                                                ret_ct_wt = api

                        						.column(17)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(17).footer()).html(money_format_india(parseFloat(ret_ct_wt).toFixed(3)));



                        						issue_gwt = api

                        						.column(18)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(18).footer()).html(money_format_india(parseFloat(issue_gwt).toFixed(3)));



                        						issue_nwt = api

                        						.column(19)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(19).footer()).html(money_format_india(parseFloat(issue_nwt).toFixed(3)));



                                                issue_diawt = api

                        						.column(20)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(20).footer()).html(money_format_india(parseFloat(issue_diawt).toFixed(3)));



                                                issue_grm_wt = api

                        						.column(21)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(21).footer()).html(money_format_india(parseFloat(issue_grm_wt).toFixed(3)));



                                                issue_ct_wt = api

                        						.column(22)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(22).footer()).html(money_format_india(parseFloat(issue_ct_wt).toFixed(3)));



                        						lot_gwt = api

                        						.column(23)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(23).footer()).html(money_format_india(parseFloat(lot_gwt).toFixed(3)));



                        						lot_nwt = api

                        						.column(24)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(24).footer()).html(money_format_india(parseFloat(lot_nwt).toFixed(3)));



                        						lot_diawt = api

                        						.column(25)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(25).footer()).html(money_format_india(parseFloat(lot_diawt).toFixed(3)));



                                                lot_grm_wt = api

                        						.column(26)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(26).footer()).html(money_format_india(parseFloat(lot_grm_wt).toFixed(3)));



                                                lot_ct_wt = api

                        						.column(27)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(27).footer()).html(money_format_india(parseFloat(lot_ct_wt).toFixed(3)));



                                                pkt_gwt = api

                                                .column(28)

                                                .data()

                                                .reduce(function(a,b){

                                                    return intVal(a) + intVal(b);

                                                }, 0);

                        						$(api.column(28).footer()).html(money_format_india(parseFloat(pkt_gwt).toFixed(3)));



                                                pkt_nwt = api

                                                .column(29)

                                                .data()

                                                .reduce(function(a,b){

                                                    return intVal(a) + intVal(b);

                                                }, 0);

                        						$(api.column(29).footer()).html(money_format_india(parseFloat(pkt_gwt).toFixed(3)));





                                                pkt_diawt = api

                                                .column(30)

                                                .data()

                                                .reduce(function(a,b){

                                                    return intVal(a) + intVal(b);

                                                }, 0);

                        						$(api.column(30).footer()).html(money_format_india(parseFloat(pkt_gwt).toFixed(3)));





                                                pkt_grm_wt = api

                                                .column(31)

                                                .data()

                                                .reduce(function(a,b){

                                                    return intVal(a) + intVal(b);

                                                }, 0);

                        						$(api.column(31).footer()).html(money_format_india(parseFloat(pkt_grm_wt).toFixed(3)));



                                                pkt_ct_wt = api

                                                .column(32)

                                                .data()

                                                .reduce(function(a,b){

                                                    return intVal(a) + intVal(b);

                                                }, 0);

                        						$(api.column(32).footer()).html(money_format_india(parseFloat(pkt_ct_wt).toFixed(3)));





                        						cls_gwt = api

                        						.column(33)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(33).footer()).html(money_format_india(parseFloat(cls_gwt).toFixed(3)));



                        						cls_nwt = api

                        						.column(34)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(34).footer()).html(money_format_india(parseFloat(cls_nwt).toFixed(3)));



                        						cls_diawt = api

                        						.column(35)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(35).footer()).html(money_format_india(parseFloat(cls_diawt).toFixed(3)));



                                                cls_grm_wt = api

                        						.column(36)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(36).footer()).html(money_format_india(parseFloat(cls_grm_wt).toFixed(3)));





                                                cls_ct_wt = api

                        						.column(37)

                        						.data()

                        						.reduce( function (a, b) {

                        							return intVal(a) + intVal(b);

                        						}, 0 );

                        						$(api.column(37).footer()).html(money_format_india(parseFloat(cls_ct_wt).toFixed(3)));







                        				}



                        				}else{



                        					 var api = this.api(), data;







                        					 $(api.column(6).footer()).html('');



                        					 $(api.column(7).footer()).html('');



                        					 $(api.column(8).footer()).html('');



                        					 $(api.column(9).footer()).html('');



                        					 $(api.column(10).footer()).html('');



                                             $(api.column(11).footer()).html('');



                        					 $(api.column(12).footer()).html('');



                        				}



                        			}



                    });

                }

                	$("div.overlay").css("display", "none");

		},

		error: function (error) {

			$("div.overlay").css("display", "none");

		}

	});

}



//Grn entry images





$('.balance_amount').on('keyup', function () {



    if (ctrl_page[1] == 'supplier_po_payment') {

        var bal_amount = $('.balance_amount').val();

        $('.receive_amount').val(bal_amount);

        $('#total_pay_amount').val(bal_amount);

    }



});



function getMetalIssueRefNo()



{



    $("div.overlay").css("display", "block");



    $('#metal_issue_ref_no option').remove();



    $.ajax({



    type: 'POST',



    url: base_url+'index.php/admin_ret_purchase/metal_issue_receipt/getKarigarIssueRefNo',



    data:{'id_karigar':$('#id_karigar').val()},



    dataType:'json',



    success:function(data){







        $.each(data, function (key, item) {



            $("#metal_issue_ref_no").append(



            $("<option></option>")



            .attr("value", item.met_issue_id)



            .text(item.met_issue_ref_id+'-'+item.suppliername)



            );



        });



        $("#metal_issue_ref_no").select2(



        {



            placeholder:"Select Issue Ref No",



            closeOnSelect: true



        });







        if($("#metal_issue_ref_no").length)



        {



            $("#metal_issue_ref_no").select2("val",'');



        }







            $(".overlay").css("display", "none");



        }



    });



}







$("#metal_issue_ref_no").on('change',function(){



    if(this.value){



       get_metal_issue_details(this.value);



    }

});





function get_metal_issue_details()



{



    $("div.overlay").css("display", "block");



    $('#item_detail tbody tr').remove();



    $.ajax({



    type: 'POST',



    url: base_url+'index.php/admin_ret_purchase/metal_issue_receipt/get_metal_issue_details',



    data:{'met_issue_id':$('#metal_issue_ref_no').val()},



    dataType:'json',



    success:function(data){



         trHtml='';



        $.each(data.list, function (key, item) {



            trHtml+=`<tr>

            <td>`+(parseInt(key)+1) +`<input type="hidden" name="issue[`+key+`][issue_met_id]"  value="`+item.issue_met_id+`"><input type="hidden" name="issue[`+key+`][tag_id]"  value="`+item.tag_id+`"></td>

            <td>`+item.product_name+`<input type="hidden" name="issue[`+key+`][id_product]"  value="`+item.product_id+`"></td>

            <td>`+item.design_name+` <input type="hidden" name="issue[`+key+`][id_design]"  value="`+item.design_id+`"></td>

            <td>`+item.sub_design_name+` <input type="hidden" name="issue[`+key+`][id_sub_design]"  value="`+item.id_sub_design+`"></td>

            <td><span class="issued_pcs">`+item.piece+`</span></td>

             <td><span class="issued_gwt">`+item.gross_wt+`</span></td>

             <td><span class="issued_nwt">`+item.net_wt+`</span></td>

             <td><span class="issued_lwt">`+item.less_wt+`</span></td>

             <td><input class="form-control receipt_pcs" type="number" style="width: 100px;" name="issue[`+key+`][receipt_pcs]"  value="0"  ></td>

             <td><input class="form-control receipt_gwt" type="number" style="width: 100px;" name="issue[`+key+`][receipt_gwt]"  value="0"  ></td>

             <td><input class="form-control receipt_nwt" readonly type="number" style="width: 100px;" name="issue[`+key+`][receipt_nwt]"  value="0"  ></td>

             <td><div class="form-group" style="width: 100px;"><div class="input-group "><input class="form-control receipt_lwt" readonly type="number"  name="issue[`+key+`][receipt_lwt]"  value="0"  ><span class="input-group-addon input-sm add_metal_res_stn" >+</span></div><input type="hidden" name="issue[`+key+`][stone_details]" class="stone_details" value="[]"></div></div></td>

             <td><a href="#" onClick="remove_row($(this).closest(\'tr\'));" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td>

            </tr>`





        });



       // <td><input class="received_wt" type="text" name="issue[`+key+`][received_wt]"  value="`+data.received_wt+`" readonly ></td>

       // <td><input class="balance_wt" type="text" name="issue[`+key+`][balance_wt]"  value="0" readonly ></td>



        $('#item_detail tbody').html(trHtml);



        calculateMetalIssue();



            $(".overlay").css("display", "none");



        }



    });



}



function calculateMetalIssue(){



    

    receipt_pcs = 0 ;



    receipt_gwt = 0 ;



    receipt_nwt = 0 ;



    receipt_lwt = 0 ;



    $('#item_detail tbody tr').each(function (index,value) {



        curRow = $(this);



        receipt_pcs += isNaN(curRow.find('.receipt_pcs').val()) ? 0 : parseFloat(curRow.find('.receipt_pcs').val());



        receipt_gwt += isNaN(curRow.find('.receipt_gwt').val()) ? 0 : parseFloat(curRow.find('.receipt_gwt').val());



        receipt_nwt += isNaN(curRow.find('.receipt_nwt').val()) ? 0 : parseFloat(curRow.find('.receipt_nwt').val());



        receipt_lwt += isNaN(curRow.find('.receipt_lwt').val()) ? 0 : parseFloat(curRow.find('.receipt_lwt').val());





    });



    $('.total_lwt').html(parseFloat(receipt_lwt).toFixed(3));



    $('.total_nwt').html(parseFloat(receipt_nwt).toFixed(3));



    $('.total_gwt').html(parseFloat(receipt_gwt).toFixed(3));



    $('.total_pwt').html(parseFloat(receipt_pcs).toFixed(3));





}



$("#metal_update").on('click',function(){



    allowSubmit = true;



    $('#item_detail tbody tr').each(function (index,value) {



        curRow = $(this);



        receipt_wt = isNaN(curRow.find('.receipt_gwt').val()) ? 0 : curRow.find('.receipt_gwt').val();



        if(receipt_wt <= 0){



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid  Gross Weight"});



            curRow.find('.receipt_wt').focus();



            allowSubmit = false;

        }



        receipt_nwt = isNaN(curRow.find('.receipt_nwt').val()) ? 0 : curRow.find('.receipt_nwt').val();



        if(receipt_nwt <= 0){



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Invalid Net Weight"});



            curRow.find('.receipt_wt').focus();



            allowSubmit = false;

        }







    });



    var form_data=$('#metal_entry_form').serialize();





    if(allowSubmit){



        $.ajax({



            type: 'POST',



            url: base_url+'index.php/admin_ret_purchase/metal_issue_receipt/save',



            data:form_data,



            dataType:'json',



            success:function(data){



                   if(data.status){



                    $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});



                    window.location.reload();



                   }else{

                    $.toaster({ priority : 'success', title : 'Warning!', message : ''+"</br>"+data.message});

                   }



                }



            });



    }



})





//Credit/Debit entry cancel



function confirm_crdr_cancel(pay_id)



{



	$('#crdrid').val(pay_id);



	$('#confirm-creditcancell').modal('show');



}



$('#credit_cancel_remark').on('keypress',function(){



	if(this.value.length>6)



	{



		$('#crdr_cancel').prop('disabled',false);



	}else{



		$('#crdr_cancel').prop('disabled',true);



	}



});





$('#crdr_cancel').on('click',function(){



    $('#crdr_cancel').prop('disabled',true);



	my_Date = new Date();



	$.ajax({



		type: 'POST',



		url:base_url+ "index.php/admin_ret_purchase/credit_debit_entry/cancel_crdr_entry?nocache=" + my_Date.getUTCSeconds(),



		dataType:'json',



		data:{'cancel_reason':$('#credit_cancel_remark').val(),'crdrid':$('#crdrid').val()},



		success:function(data){



		    window.location.reload();



		}



	});



});

//Credit/Debit entry cancel



function get_oldmetalcategory() {

	$("div.overlay").css("display", "block");

	$("#category option").remove();

	$.ajax({

		type: 'POST',

		url: base_url + 'index.php/admin_ret_catalog/old_metal_cat/active_oldmetal',

		dataType: 'json',

		data: { 'id_metal': $('#metal').val() },

		success: function (data) {

			$("#oldcategory").append(

				$("<option></option>")

					.attr("value", 0)

					.text('All')

			);

			$.each(data, function (key, item) {

				$('#oldcategory').append(

					$("<option></option>")

						.attr("value", item.id_metal_type)

						.text(item.metal_type)

				);

			});

			$("#oldcategory").select2({

				placeholder: "Select Category",

				allowClear: true

			});

		}

	});

	$("div.overlay").css("display", "none");

}



function get_oldmetalcategory() {

	$("div.overlay").css("display", "block");

	$("#oldcategory option").remove();

	$.ajax({

		type: 'POST',

		url: base_url + 'index.php/admin_ret_catalog/old_metal_cat/active_oldmetal',

		dataType: 'json',

		data: { 'id_metal': $('#select_metal').val() },

		success: function (data) {

			// $("#oldcategory").append(

			// 	$("<option></option>")

			// 		.attr("value", 0)

			// 		.text('All')

			// );

			$.each(data, function (key, item) {

				$('#oldcategory').append(

					$("<option></option>")

						.attr("value", item.id_metal_type)

						.text(item.metal_type)

				);

			});

			$("#oldcategory").select2({

				placeholder: "Select Category",

				allowClear: true

			});

		}

	});

	$("div.overlay").css("display", "none");

}



$(document).on('click',".add_metal_res_stn",function(){



    $('#cus_stoneModal').modal('show');



    $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').empty();





    curRow = $(this).closest('tr');



    curRow_stn =$(this).closest('tr');

    stone_details = curRow.find('.stone_details').val()

    

    if(stone_details !='' && stone_details != '[]'){



        parse_stone_details = JSON.parse(stone_details);



        

        $('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').empty();

    

        if(parse_stone_details.length > 0){

    

            $.each(parse_stone_details, function (key, item) {

    

                if(item)

    

                {

                    create_new_empty_stone_item(item);



                }

            });



        }else{



            create_new_empty_stone_item();



        }



    }else{



        create_new_empty_stone_item();



    }

});







function calculateMetalRes_row(){



    

    receipt_pcs = 0 ;



    receipt_gwt = 0 ;



    receipt_nwt = 0 ;



    receipt_lwt = 0 ;



    $('#item_detail tbody tr').each(function (index,value) {



        curRow = $(this);



        receipt_gwt = 0 ;



        receipt_nwt = 0 ;



        receipt_gwt = isNaN(curRow.find('.receipt_gwt').val()) ? 0 : curRow.find('.receipt_gwt').val();



        receipt_lwt = isNaN(curRow.find('.receipt_lwt').val()) ? 0 : curRow.find('.receipt_lwt').val();



        curRow.find('.receipt_nwt').val(parseFloat(receipt_gwt-receipt_lwt).toFixed(3));





    });



    calculateMetalIssue();





}





$(document).on('change',".receipt_pcs",function(){



    calculateMetalRes_row();



});





$(document).on('change',".receipt_gwt",function(){



    calculateMetalRes_row();

    

});





function calculateRepairMetalIssuePureWt()

{

    $("#metal_details > tbody  > tr").each(function ()

    {

        var row = $(this).closest('tr');

        console.log('purity',row.find('#select_purity').val());

        var issue_pcs = (isNaN(row.find('.issue_pcs').val()) || row.find('.issue_pc').val()=='' ? 0:row.find('.issue_pcs').val());

        var tot_weight = (isNaN(row.find('.issue_weight').val()) || row.find('.issue_weight').val()=='' ? 0:row.find('.issue_weight').val());

        var karigar_calc_type = row.find('.purchase_calc_type').val();

        var net_wt = (isNaN(row.find('.issue_net_wt').val()) || row.find('.issue_net_wt').val()=='' ? 0:row.find('.issue_net_wt').val());

        var purity = (isNaN(row.find('.issue_touch').val()) || row.find('.issue_touch').val()=='' ? 0:row.find('.issue_touch').val());

        var wastage_per = (isNaN(row.find('.issue_va').val()) || row.find('.issue_va').val()=='' ? 0:row.find('.issue_va').val());

        var calculation_based_on = row.find('.calculation_based_on').val();

        var issue_less_wt  = (isNaN(row.find('.issue_less_wt').val()) || row.find('.issue_less_wt').val()=='' ? 0:row.find('.issue_less_wt').val());



        net_wt = tot_weight - issue_less_wt;



        row.find('.issue_net_wt').val(parseFloat(net_wt).toFixed(3))

        /*



        0 - MC & V.A on Gross Weight



        1 - MC & V.A on Net Weight



        2 - MC On Gross & V.A on Net Weight



        */

        if(calculation_based_on==0)



        {



            var wast_wt                 = parseFloat((tot_weight*wastage_per)/100).toFixed(3);



          //  var total_mc_value          = (mc_type==1 ? parseFloat(parseFloat(mc_value)*parseFloat(tot_weight)).toFixed(2) :parseFloat(parseFloat(mc_value)*parseFloat(tot_pcs)).toFixed(2));







        }



        else if(calculation_based_on==1)



        {



            var wast_wt                 = parseFloat((net_wt*wastage_per)/100).toFixed(3);



           // var total_mc_value          = (mc_type==1 ? parseFloat(parseFloat(mc_value)*parseFloat(net_wt)).toFixed(2) :parseFloat(parseFloat(mc_value)*parseFloat(tot_pcs)).toFixed(2));



        }



        else if(calculation_based_on==2)



        {



          //  var total_mc_value          = (mc_type==1 ? parseFloat(parseFloat(mc_value)*parseFloat(tot_gwt)).toFixed(2) :parseFloat(parseFloat(mc_value)*parseFloat(tot_pcs)).toFixed(2));



            var wast_wt                 = parseFloat((net_wt*wastage_per)/100).toFixed(3);



        }

        if(karigar_calc_type==1)

        {



            var purewt = format(parseFloat((parseFloat(net_wt) * (parseFloat(purity) + parseFloat(wastage_per))) / 100)).replace(/,/g, '');



        }else if(karigar_calc_type==2) //Net weight * touch



        {



            var purewt = parseFloat((parseFloat(net_wt) * (parseFloat(purity)/100)));



        }



        else if(karigar_calc_type==3) // ((net wt * 3%)*92%)



        {



            var touch_weight       = parseFloat((parseFloat(net_wt)*parseFloat(purity)/100)).toFixed(3);



            var wastage_touch      = parseFloat(parseFloat(touch_weight)*(parseFloat(wastage_per))/100);



            var purewt             = parseFloat(parseFloat(touch_weight)+parseFloat(wastage_touch)).toFixed(3);



        }



        row.find('.issue_va_wt').val(parseFloat(wast_wt).toFixed(3));



        row.find('#pur_weight').val(parseFloat(purewt).toFixed(3));

    });

}





$(document).on('change',".issue_touch,.issue_va_wt,.issue_va,.issue_mc,.purchase_calc_type",function(){



    calculateRepairMetalIssuePureWt();

    

});





$("input[name='issue[is_against_opening]']:radio").on('change',function()

{

    $('#aganist_supplier_yes').prop('checked',true);

    $('#select_supplier_po_no').attr('disabled',false);

    $('.against_pur_order').css('display','block');

    $('.against_opening').css('display','none');

    if(this.value==1)

    {

        $('#aganist_supllier_no').prop('checked',true);

        $('#select_supplier_po_no').attr('disabled',true);

        $('.against_pur_order').css('display','none');

        $('.against_opening').css('display','block');

    }

    Create_New_Karigar_Metal_Issue();

});



$('#search_kar_opening_det').on('click',function()

{

    if($('#karigar_select').val()!='' && $('#karigar_select').val()!=null)

    {

        get_available_metal_opening_stock_details();

    }

    else

    {

       $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>Select Karigar"});

    }

});



function get_available_metal_opening_stock_details()

{



    my_Date = new Date();



    $("div.overlay").css("display", "block");



    $.ajax({



        url:base_url+ "index.php/admin_ret_purchase/karigarmetalissue/available_metal_opening_stock_details?nocache=" + my_Date.getUTCSeconds(),



        dataType:"JSON",



        type:"POST",



        data:{'id_product':$('#select_product').val(),'id_karigar':$('#karigar_select').val()},



        success:function(data){



            available_metal_opening_stock=data;



             Create_New_Karigar_Metal_Issue();



            $("div.overlay").css("display", "none"); 



        },



        error:function(error)  



        {



            $("div.overlay").css("display", "none"); 



        }	 



    });



}



function delete_reason(id)



{



	$('#qc_id').val(id);



	$('#deleteReasonModal').modal('show');



}





function qc_cancel_reason(){

    my_Date = new Date();



	$.ajax({



		url: base_url+"index.php/admin_ret_catalog/ret_qc_cancel_reason/ajax?nocache=" + my_Date.getUTCSeconds(),



		type:"GET",



		dataType: 'json',



		cache:false,



		success:function(data){



            var reason = data.list





            $.each(reason, function (key, item) {



                $('#deleteReasonSelect').append(



                $("<option></option>")



                .attr("value", item.id_cancel)



                .text(item.cancel_reason)



                );



            });







	



		},



		 error:function(error)



		  {



			 $("div.overlay").css("display", "none");



		  }



	});

}



$('#deleteReasonSelect').change(function() {

    if ($(this).val() !== '') {

        $('#confirmDeleteBtn').prop('disabled', false);

    } else {

        $('#confirmDeleteBtn').prop('disabled', true);

    }

});

$('#confirmDeleteBtn').change(function() {

    $.ajax({



    	type: 'POST',



    	url: base_url+'index.php/admin_ret_purchase/qc_issue_receipt_cancel',



    	dataType:'json',



    	data:{'qc_issue_id':$('#qc_id').val(),'id_reason':$('#deleteReasonSelect').val()},



    	success:function(data){



            window.location.reload();



    		}



    	});

});



/*Hall marking*/



function remove_hm_item(curRow)

{

    curRow.remove();

    calculate_halmarking_issue_row_details();

}



$(document).on('change',".no_of_pcs",function(){



    if(ctrl_page[1]=='halmarking_issue_receipt')

    {

        var curRow = $(this).closest('tr');



        var act_qc_pcs = parseFloat(isNaN(curRow.find('.act_qc_pcs').val()) || curRow.find('.act_qc_pcs')=='' ? 0 :curRow.find('.act_qc_pcs').val());



        var no_of_pcs = parseFloat(isNaN(curRow.find('.no_of_pcs').val()) || curRow.find('.no_of_pcs')=='' ? 0 :curRow.find('.no_of_pcs').val());



        if(parseFloat(no_of_pcs)>parseFloat(act_qc_pcs))



        {



            $(this).closest('tr').find('.no_of_pcs').focus();



            $(this).closest('tr').find('.no_of_pcs').val(act_qc_pcs);



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</br>You Have Entered More than the Available Pcs.."});



        }



        calculate_halmarking_issue_row_details();

    }



});



$(document).on('change',".gross_wt",function(){



    if(ctrl_page[1]=='halmarking_issue_receipt')

    {



        var curRow = $(this).closest('tr');



        var act_qc_gwt = parseFloat(isNaN(curRow.find('.act_qc_gwt').val()) || curRow.find('.act_qc_gwt')=='' ? 0 :curRow.find('.act_qc_gwt').val());



        var less_wt = parseFloat(isNaN(curRow.find('.less_wt').val()) || curRow.find('.less_wt')=='' ? 0 :curRow.find('.less_wt').val());



        var gross_wt = parseFloat(isNaN(curRow.find('.gross_wt').val()) || curRow.find('.gross_wt')=='' ? 0 :curRow.find('.gross_wt').val());



        if(parseFloat(gross_wt)>parseFloat(act_qc_gwt))



        {



            $(this).closest('tr').find('.gross_wt').focus();



            $(this).closest('tr').find('.gross_wt').val(parseFloat(act_qc_gwt).toFixed(3));



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</brYou Have Entered More than the Available Gross weight.."});



        }



        else if(parseFloat(gross_wt)<parseFloat(less_wt))



        {



            $(this).closest('tr').find('.gross_wt').focus();



            $(this).closest('tr').find('.gross_wt').val(parseFloat(act_qc_gwt).toFixed(3));



            $.toaster({ priority : 'danger', title : 'Warning!', message : ''+"</brYou Have Entered More than the Available Gross weight.."});



        }



        else{



            var net_wt = parseFloat(gross_wt)-parseFloat(less_wt);



            $(this).closest('tr').find('.net_wt').val(parseFloat(net_wt).toFixed(3));



        }



        calculate_halmarking_issue_row_details();

    }



});



function create_new_empty_hm_issue_stone_item(curRow,id)

{

     $('#estimation_stone_cus_item_details tbody').empty();



	if(curRow!=undefined)



	{



		$('#custom_active_id').val(curRow.closest('tr').attr('id'));



	}



	var row = "";



		var catRow=$('#custom_active_id').val();







		console.log(catRow);



		var row_st_details=$('#'+catRow).find('.stone_details').val();



		if(row_st_details !='' && row_st_details != '[]' && curRow != undefined)



		{



			var stone_details   = JSON.parse(row_st_details);



			console.log(stone_details);



			$.each(stone_details, function (pkey, pitem) {



	 			var stones_list='';



	 			var stones_type_list='';



	 			var uom_list='';



	 			var html='';



                var quality_list ='';



                var disable_quality = (pitem.stones_type == 1 ? '': 'disabled');



                var clarity="";



                var color ="";



                var cut ="";



                var shape ="";



	 			var cal_type = pitem.stone_cal_type;



				$.each(stones, function (pkey, item)



				{



					var selected = "";



					if(item.stone_id == pitem.stone_id)



					{



						selected = "selected='selected'";



					}



					stones_list += "<option value='"+item.stone_id+"' "+selected+">"+item.stone_name+"</option>";



				});











				$.each(stone_types, function (pkey, item) {



				    var st_type_selected = "";



				    if(item.id_stone_type == pitem.stones_type)



					{



						st_type_selected = "selected='selected'";



					}



				    stones_type_list += "<option value='"+item.id_stone_type+"' "+st_type_selected+">"+item.stone_type+"</option>";



    			});







    			$.each(uom_details, function (pkey, item) {



    			     var uom_selected = "";



    			    if(item.uom_id == pitem.stone_uom_id)



					{



						uom_selected = "selected='selected'";



					}



    				uom_list += "<option value='"+item.uom_id+"' "+uom_selected+">"+item.uom_name+"</option>";



    			});



                $.each(quality_code, function (pkey, item) {



                    quality_list += "<option value='"+pitem.stone_quality_id+"' "+(item.quality_id == pitem.stone_quality_id ? 'selected' : '') +" >"+item.code+"</option>";



                    if(item.quality_id == pitem.stone_quality_id)



                    {



                        clarity=item.clarity;



                        color=item.color;



                        cut=item.cut;



                        shape=item.shape;



                    }



                });



                var act_stone_pcs = (parseInt(pitem.bal_act_stone_pcs) > 0 ? parseInt(pitem.bal_act_stone_pcs) : parseInt(pitem.stone_pcs));



                var act_stone_wt  = (parseFloat(pitem.bal_act_stone_wt) > 0 ? parseFloat(pitem.bal_act_stone_wt).toFixed(3) : parseFloat(pitem.stone_wt).toFixed(3));







				row += '<tr>'



                	+'<td><input type="hidden" class="po_st_id" value="'+pitem.po_st_id+'"><input class="show_in_lwt" type="checkbox" name="est_stones_item[show_in_lwt][]" value="'+(pitem.show_in_lwt==1 ? 1:0)+'" '+(pitem.show_in_lwt==1 ? 'checked' :'' )+' disabled></td>'



                	+'<td><select class="stones_type form-control" name="est_stones_item[stones_type][]"  disabled style="width:80px;">'+stones_type_list+'</select></td>'



					+'<td><select class="stone_id form-control" name="est_stones_item[stone_id][]"  disabled style="width:80px;">'+stones_list+'</select></td>'



                    +'<td><select class="quality_id form-control" name="est_stones_item[quality_id][]" disabled style="width:80px;">'+quality_list+'</select></td>'



					+'<td><input type="number" class="stone_pcs form-control" name="est_stones_item[stone_pcs][]"  value="'+pitem['stone_pcs']+'" style="width: 70px;" /><input type="hidden" class="act_stone_pcs" value="'+act_stone_pcs+'"></td>'



					+'<td><div class="input-group"><input class="stone_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="'+pitem['stone_wt']+'" style="width:70px;" /><input type="hidden" class="act_stone_wgt" value="'+act_stone_wt+'"><span class="input-group-btn" style="width: 70px;"><select class="stone_uom_id form-control" name="est_stones_item[uom_id][]"  style="width: 70px;">'+uom_list+'</select></span></div></td>'



					+'<td><div class="form-group"><input class="stone_cal_type" type="radio" name="est_stones_item[cal_type]['+pkey+']" value="1" '+(cal_type == 1 ? 'checked' : '')+'> By Wt&nbsp;<input type="radio"  name="est_stones_item[cal_type]['+pkey+']" '+(cal_type == 2 ? 'checked' : '')+' class="stone_cal_type" value="2">By Pcs</div></td>'



                    +'<td><span class="stone_cut">'+cut+'</span></td>'



                    +'<td><span class="stone_color">'+color+'</span></td>'



                    +'<td><span class="stone_clarity">'+clarity+'</span></td>'



                    +'<td><span class="stone_shape">'+shape+'</span></td>'



					+'<td><input type="number" class="stone_rate form-control" name="est_stones_item[stone_rate][]" value="'+pitem['stone_rate']+'"  style="width:80px;" disabled /></td>'



					+'<td><input type="number" class="stone_price form-control" name="est_stones_item[stone_price][]" value="'+pitem['stone_price']+'"  style="width:80px;" disabled /></td>'



					+'<td><a href="#" onClick="remove_stone_row($(this).closest(\'tr\').remove());" class="btn btn-danger btn-del"><i class="fa fa-trash"></i></a></td></tr>';



			});







		}



	$('#cus_stoneModal .modal-body').find('#estimation_stone_cus_item_details tbody').append(row);



	$('#cus_stoneModal').modal('show');



}





function create_new_empty_po_stone_items(curRow,id)



{







    $('#qc_issue_stone_details tbody').empty();



	if(curRow!=undefined)



	{



		$('#custom_active_id').val(curRow.closest('tr').attr('id'));



	}



	var row = "";



		var catRow=$('#custom_active_id').val();







		console.log(catRow);



		var row_st_details=$('#'+catRow).find('.stone_details').val();



		if(row_st_details !='' && row_st_details != '[]' && curRow != undefined)



		{



			var stone_details   = JSON.parse(row_st_details);



			console.log(stone_details);



			$.each(stone_details, function (pkey, pitem) {



	 		var accepted_pcs  = parseFloat(parseFloat(pitem['stone_pcs'])-parseFloat(pitem['po_stone_rejected_pcs'])).toFixed(3);



	 		var accepted_wt  = parseFloat(parseFloat(pitem['stone_wt']-pitem['po_stone_rejected_wt'])).toFixed(3);



				row += '<tr>'



                	+'<td><input type="hidden" class="ret_hm_issue_stn_id" value="'+pitem.ret_hm_issue_stn_id+'"><input type="hidden" class="po_stone_uom" value="'+pitem.po_stone_uom+'">'+pitem.ret_hm_issue_stn_id+'</td>'



                	+'<td><input type="hidden" class="stone_name" value="'+pitem.stone_name+'">'+pitem.stone_name+'</td>'



					+'<td><input type="number" class="po_stone_pcs form-control" name="est_stones_item[stone_pcs][]"  value="'+pitem['stone_pcs']+'" style="width: 100px;" readonly/></td>'



					+'<td><input class="stone_wt form-control po_stone_wt" type="number" name="est_stones_item[stone_wt][]" value="'+pitem['stone_wt']+'" style="width:100px;" readonly /></td>'



					+'<td><input type="number" class="po_stone_rejected_pcs form-control" name="est_stones_item[stone_pcs][]"  value="'+pitem['po_stone_rejected_pcs']+'" style="width: 100px;" /></td>'



					+'<td><input class="po_stone_rejected_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="'+pitem['po_stone_rejected_wt']+'" style="width:100px;"  /></td>'



					+'<td><input type="number" class="po_stone_accepted_pcs form-control" name="est_stones_item[stone_pcs][]"  value="'+accepted_pcs+'" style="width: 100px;" /></td>'



					+'<td><input class="po_stone_accepted_wt form-control" type="number" name="est_stones_item[stone_wt][]" value="'+accepted_wt+'" style="width:100px;"  /></td>'



					+'</tr>';



			});







		}



	$('#cus_stoneModal .modal-body').find('#hm_issue_stone_details tbody').append(row);



	$('#cus_stoneModal').modal('show');







}